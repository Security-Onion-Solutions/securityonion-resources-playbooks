name: ET WEB_SPECIFIC_APPS Savas Guestbook SQL Injection Attempt
id: 1206360
description: |
  Detects SQL injection attempts against Savas Guestbook application targeting the add2.php email parameter with UNION SELECT statements.
  May trigger on legitimate database queries containing UNION clauses or security testing activities.
type: detection
detection_id: 2004506
detection_category: ''
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete SQL injection payload in the add2.php request?
    context: Reveals the exact UNION SELECT statement and injection technique used.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.method
        - http.useragent
        - http.virtual_host
        - http.uri
        - http.status_code
  - question: Does this web server normally receive requests to add2.php?
    context: Determines if access to this Savas Guestbook endpoint is typical for this environment.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
  - question: What web application process handled this SQL injection attempt?
    context: Identifies the specific web server or application processing the malicious request.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
      detection:
        selection:
          community_id|expand: '%community_id%'
        filter:
          Image|exists: true
        condition: selection and filter
      fields:
        - hostname
        - User
        - Image
        - CommandLine
        - ProcessGuid
  - question: What other HTTP requests occurred from the same source IP?
    context: Identifies additional web application attacks or reconnaissance activities.
    range: +/-2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - http.method
        - http.uri
        - http.user_agent
        - http.status_code
  - question: Were there other SQL injection attempts against different web applications?
    context: Reveals broader SQL injection campaign targeting multiple applications.
    range: +/-6h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.uri|contains:
            - "UNION"
            - "SELECT"
            - "INSERT"
            - "DROP"
            - "DELETE"
        condition: selection
      fields:
        - http.method
        - http.uri
        - http.virtual_host
  - question: What database-related files were accessed after the injection attempt?
    context: Identifies potential database file access resulting from successful injection.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          file.name|contains:
            - ".db"
            - ".sql"
            - ".mdb"
            - ".sqlite"
        condition: selection
      fields:
        - file.path
        - file.name
        - Image
        - User
  - question: Did the web server establish any external database connections after this request?
    context: Detects potential data exfiltration through external database connections.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_port:
            - 3306  # MySQL
            - 5432  # PostgreSQL
            - 1433  # MSSQL
            - 1521  # Oracle
        filter:
          dst_ip|cidr:
            - "10.0.0.0/8"
            - "172.16.0.0/12"
            - "192.168.0.0/16"
        condition: selection and not filter
      fields:
        - dst_ip
        - dst_port
        - network.transport
  - question: Are other hosts receiving similar SQL injection attempts?
    context: Determines the scope of SQL injection attacks across the organization.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%public_ip%'
        condition: selection
      fields:
        - src_ip
        - rule.name
        - rule.category
  - question: What authentication attempts occurred around this SQL injection?
    context: Identifies potential credential harvesting or authentication bypass attempts.
    range: +/-1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.uri|contains:
            - "login"
            - "auth"
            - "signin"
            - "password"
        condition: selection
      fields:
        - http.method
        - http.uri
        - http.status_code
        - http.user_agent
  - question: Did any administrative or configuration files get accessed after the injection attempt?
    context: Reveals potential privilege escalation or system configuration access.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          file.name|contains:
            - "config"
            - "admin"
            - ".conf"
            - ".ini"
            - "passwd"
            - "shadow"
        condition: selection
      fields:
        - file.path
        - file.name
        - Image
        - User
  - question: What was the pattern of reconnaissance activity from this source?
    context: Identifies web application scanning or enumeration preceding the attack.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - http.method
        - http.uri
        - http.status_code
        - http.user_agent