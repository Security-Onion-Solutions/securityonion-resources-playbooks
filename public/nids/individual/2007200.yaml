name: ET WEB_SPECIFIC_APPS Ultimate Survey Pro SQL Injection Attempt
id: 1223007
description: |
  Detects SQL injection attempts against Ultimate Survey Pro application targeting the index.asp page with UNION SELECT statements.
  May trigger on legitimate database queries or security testing tools performing SQL injection scans.
type: detection
detection_id: 2007200
detection_category: ''
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete HTTP request containing the SQL injection attempt?
    context: Reveals the exact UNION SELECT payload and parameter manipulation.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.method
        - http.useragent
        - http.virtual_host
        - http.uri
        - http.status_code
  - question: Does this host normally access the Ultimate Survey Pro application?
    context: Determines if HTTP access to this web application is typical for the source.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
  - question: What web browser or tool submitted the SQL injection request?
    context: Identifies whether this originated from automated tools or manual testing.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.uri|contains: "index.asp"
          http.uri|contains: "cat="
        condition: selection
      fields:
        - http.user_agent
        - http.method
        - http.uri
  - question: What other SQL injection patterns were attempted from this source?
    context: Identifies additional SQL injection attempts targeting the same or different applications.
    range: +/-6h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.uri|contains:
            - "UNION"
            - "SELECT"
            - "INSERT"
            - "UPDATE"
            - "DELETE"
            - "DROP"
        condition: selection
      fields:
        - http.uri
        - http.virtual_host
        - dst_ip
  - question: What other web application vulnerabilities were tested from this source?
    context: Reveals broader web application attack patterns beyond SQL injection.
    range: +/-6h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.uri|contains:
            - "../"
            - "../../"
            - "<script"
            - "javascript:"
            - "eval("
            - "cmd.exe"
            - "/etc/passwd"
        condition: selection
      fields:
        - http.uri
        - http.virtual_host
        - dst_ip
  - question: Are other hosts targeting the same Ultimate Survey Pro application?
    context: Determines if multiple sources are attacking the vulnerable application.
    range: +/-24h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          http.uri|contains: "index.asp"
          http.uri|contains: "UNION"
        filter:
          src_ip|expand: '%src_ip%'
        condition: selection and not filter
      fields:
        - src_ip
        - http.uri
        - http.user_agent
  - question: What response codes did the web server return for these SQL injection attempts?
    context: Indicates whether the injection attempts were successful or blocked.
    range: +/-30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.uri|contains: "index.asp"
        condition: selection
      fields:
        - http.status_code
        - http.uri
        - http.response.body.length
  - question: Did the attacker attempt to access administrative or configuration files?
    context: Identifies attempts to access sensitive application files after SQL injection.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.uri|contains:
            - "admin"
            - "config"
            - "setup"
            - "install"
            - "backup"
            - ".sql"
            - ".bak"
        condition: selection
      fields:
        - http.uri
        - http.status_code
        - dst_ip
  - question: Are there related alerts involving this IP address across the organization?
    context: Identifies coordinated attacks or reconnaissance activities from the same source.
    range: +/-24h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          related_ip|expand: '%related_ip%'
        filter:
          document_id|expand: '%document_id%'
        condition: selection and not filter
      fields:
        - rule.name
        - rule.category
        - src_ip
        - dst_ip
  - question: What database-related processes were active on the web server during this attack?
    context: Identifies database activity that may indicate successful SQL injection exploitation.
    range: +/-30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - "sqlservr.exe"
            - "mysqld.exe"
            - "postgres.exe"
            - "oracle.exe"
            - "osql.exe"
            - "sqlcmd.exe"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User