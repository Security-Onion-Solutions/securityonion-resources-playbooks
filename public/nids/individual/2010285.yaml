name: ET WEB_SERVER SELECT SUBSTR/ING in URI Possible Blind SQL Injection Attempt
id: 1221056
description: |
  Detects HTTP requests with SELECT and SUBSTR statements in URI parameters, indicating potential blind SQL injection attempts.
  May trigger on legitimate database queries, security testing tools, or application debugging activities.
type: detection
detection_id: 2010285
detection_category: ''
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete HTTP request containing the SQL injection pattern?
    context: Reveals the full URI and parameters containing the SELECT/SUBSTR pattern.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.method
        - http.useragent
        - http.virtual_host
        - http.uri
        - http.status_code
  - question: Does this web server normally receive database queries in URI parameters?
    context: Determines if SQL-like parameters are typical for this application.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
  - question: What other HTTP requests with SQL keywords occurred from this source?
    context: Identifies systematic SQL injection testing patterns.
    range: +/-2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.uri|contains:
            - "SELECT"
            - "UNION"
            - "INSERT"
            - "UPDATE"
            - "DELETE"
            - "DROP"
            - "CREATE"
        condition: selection
      fields:
        - http.uri
        - http.method
        - http.user_agent
        - http.status_code
  - question: What other external connections occurred from this host after the SQL injection attempt?
    context: Identifies potential data exfiltration or additional attack infrastructure.
    range: +/-10m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        private:
          dst_ip|cidr:
            - '10.0.0.0/8'
            - '127.0.0.0/8'
            - '172.16.0.0/12'
            - '192.168.0.0/16'
            - '169.254.0.0/16'
        filter:
          dst_ip|expand: '%public_ip%'
        condition: selection and not (private or filter)
      fields:
        - dst_ip
        - dst_port
        - network.transport
        - connection.state_description
  - question: Are other hosts attempting similar SQL injection patterns against web servers?
    context: Determines if this is part of a coordinated attack campaign.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%public_ip%'
        condition: selection
      fields:
        - src_ip
        - rule.name
        - rule.category
  - question: What HTTP response codes were returned for requests containing SQL patterns?
    context: Indicates whether the injection attempts were successful or blocked.
    range: +/-1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.uri|contains:
            - "SELECT"
            - "SUBSTR"
        condition: selection
      fields:
        - http.status_code
        - http.uri
        - http.method
        - http.response.body.length
  - question: What user-agent patterns are associated with these SQL injection attempts?
    context: Identifies automated tools or specific attack frameworks being used.
    range: +/-2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.uri|contains:
            - "SELECT"
            - "UNION"
            - "INJECT"
        condition: selection
      fields:
        - http.user_agent
        - http.uri
        - http.method
  - question: Did any files get created on the web server during or after the SQL injection attempts?
    context: Assesses potential file upload or webshell deployment through SQL injection.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%private_ip%'
          file.name|endswith:
          - .exe
          - .dll
          - .bat
          - .cmd
          - .ps1
          - .vbs
          - .js
          - .scr
          - .com
          - .pif
        condition: selection
      fields:
        - file.path
        - file.name
        - Image
        - ProcessGuid
        - User
  - question: Are there patterns in the timing of SQL injection requests that suggest automated tools?
    context: Reveals systematic attack patterns and tool signatures.
    range: +/-4h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.uri|re|i: ".*SELECT.*SUBSTR.*"
        condition: selection
      fields:
        - http.uri
        - http.method
        - http.user_agent
        - http.request.body.length
  - question: What other web application attack patterns are present from this source IP?
    context: Identifies broader web application attack campaigns beyond SQL injection.
    range: +/-6h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        xss_pattern:
          http.uri|contains:
            - "<script"
            - "javascript:"
            - "onload="
            - "onerror="
        lfi_pattern:
          http.uri|contains:
            - "../"
            - "..%2F"
            - "/etc/passwd"
            - "boot.ini"
        condition: selection and (xss_pattern or lfi_pattern)
      fields:
        - http.uri
        - http.method
        - http.user_agent