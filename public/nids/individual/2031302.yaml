name: ET CURRENT_EVENTS Fireeye M.HackTool.SMB.Impacket-Obfuscation Service Names
id: 1217836
description: |
  Detects SMB traffic containing specific Windows License Key Activation strings associated with Impacket tool obfuscation.
  May trigger on legitimate Windows license activation processes or administrative tools using similar service names.
type: detection
detection_id: 2031302
detection_category: ''
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete SMB request containing the Windows License Key Activation string?
    context: Reveals the full SMB communication pattern and context of the suspicious service name.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
  - question: Does this host normally communicate via SMB with the destination system?
    context: Determines if SMB connections between these systems are part of normal operations.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
  - question: What process initiated the SMB connection containing the suspicious service name?
    context: Identifies the application or tool responsible for generating the Impacket-style traffic.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
      detection:
        selection:
          community_id|expand: '%community_id%'
        filter:
          Image|exists: true
        condition: selection and filter
      fields:
        - hostname
        - User
        - Image
        - CommandLine
        - ProcessGuid
  - question: What other SMB connections occurred from this host during the same timeframe?
    context: Identifies additional lateral movement attempts or administrative activity.
    range: +/-30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: [139, 445]
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection.state
        - network.bytes_sent
        - network.bytes_received
  - question: Are other hosts generating similar SMB traffic with Windows License activation strings?
    context: Determines scope of potential Impacket tool usage across the network.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%public_ip%'
        condition: selection
      fields:
        - src_ip
        - rule.name
        - rule.category
  - question: What files were accessed or created on the source host around this activity?
    context: Identifies tools or artifacts associated with the SMB reconnaissance.
    range: +/-30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%private_ip%'
          file.name|endswith:
          - .exe
          - .dll
          - .bat
          - .cmd
          - .ps1
          - .vbs
          - .js
          - .scr
          - .com
          - .pif
        condition: selection
      fields:
        - file.path
        - file.name
        - Image
        - ProcessGuid
        - User
  - question: Did any lateral movement occur from this host to other internal systems?
    context: Assesses whether this SMB activity is part of broader lateral movement.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%private_ip%'
          dst_port:
          - 445    # SMB
          - 139    # NetBIOS
          - 3389   # RDP
          - 5985   # WinRM HTTP
          - 5986   # WinRM HTTPS
          - 22     # SSH
          - 23     # Telnet
          - 135    # RPC
          - 5900   # VNC
        condition: selection
      fields:
        - src_ip
        - src_port
        - dst_ip
        - dst_port
        - network.transport
  - question: Were any services created or modified on systems contacted via SMB?
    context: Identifies potential service installation attempts using Impacket tools.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%private_ip%'
          CommandLine|contains:
          - "sc create"
          - "sc config"
          - "net use"
          - "psexec"
        condition: selection
      fields:
        - CommandLine
        - Image
        - ProcessGuid
        - User
        - ParentImage
  - question: What authentication activity occurred on the destination SMB systems?
    context: Reveals authentication attempts that may indicate credential attacks.
    range: +/-30m
    query: |
      aggregation: false
      logsource:
        category: authentication
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - user.name
        - event.outcome
        - winlog.event_id
        - winlog.logon_type
  - question: Are there related alerts involving the same source IP across the organization?
    context: Identifies coordinated activity or multiple detection points for the same threat.
    range: +/-24h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          related_ip|expand: '%related_ip%'
        filter:
          document_id|expand: '%document_id%'
        condition: selection and not filter
      fields:
        - rule.name
        - rule.category
        - src_ip
        - dst_ip