name: ET MOBILE_MALWARE Android Spy PREDATOR CnC Domain in DNS Lookup
id: 1207359
description: |
  Detects DNS lookups to aramexegypt.com domain associated with Intellexa PREDATOR mobile spyware command and control infrastructure.
  May trigger on legitimate DNS queries if the domain is repurposed or accessed for benign purposes.
type: detection
detection_id: 2046437
detection_category: ''
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete DNS query for the PREDATOR CnC domain?
    context: Reveals the exact DNS query pattern and response for the suspected mobile malware infrastructure.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.resolved_ip
  - question: Does this host normally query aramexegypt.com or similar domains?
    context: Determines if DNS queries to this domain represent a change from normal patterns.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          dns.query.name|expand: '%dns.query.name%'
        condition: selection
      fields:
        - dns.query.name
  - question: What DNS queries occurred before the PREDATOR domain lookup?
    context: Identifies DNS resolution patterns that may have preceded the CnC communication attempt.
    range: -5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.resolved_ip
  - question: What process initiated the DNS lookup for the PREDATOR domain?
    context: Identifies the application or service responsible for the suspicious DNS query.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
      detection:
        selection:
          community_id|expand: '%community_id%'
        filter:
          Image|exists: true
        condition: selection and filter
      fields:
        - hostname
        - User
        - Image
        - CommandLine
        - ProcessGuid
  - question: What other external connections occurred from this host?
    context: Identifies additional network communications that may be related to mobile malware activity.
    range: +/-10m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        private:
          dst_ip|cidr:
            - '10.0.0.0/8'
            - '127.0.0.0/8'
            - '172.16.0.0/12'
            - '192.168.0.0/16'
            - '169.254.0.0/16'
        filter:
          dst_ip|expand: '%public_ip%'
        condition: selection and not (private or filter)
      fields:
        - dst_ip
        - dst_port
        - network.transport
        - connection.state_description
  - question: Are other hosts in the network querying the same PREDATOR infrastructure?
    context: Determines the scope of potential PREDATOR malware infections across the organization.
    range: +/-24h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%public_ip%'
        filter:
          src_ip|expand: '%src_ip%'
        condition: selection and not filter
      fields:
        - src_ip
        - dst_port
        - network.transport
        - connection.state_description
  - question: What is the timing pattern of DNS queries to aramexegypt.com?
    context: Analyzes communication patterns that may indicate automated malware beaconing behavior.
    range: +/-6h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%related_ip%'
          dst_ip|expand: '%related_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - network.protocol
        - event.duration
        - client.ip_bytes
        - server.ip_bytes
        - connection.state_description
  - question: What files were created by processes making DNS queries to this domain?
    context: Identifies files that may have been created or modified by PREDATOR malware components.
    range: +/-1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          ProcessGuid|expand: '%ProcessGuid%'
        condition: selection
      fields:
        - file.path
        - file.name
        - Image
        - User
  - question: Are there related alerts involving PREDATOR indicators across the organization?
    context: Identifies coordinated mobile malware campaign activity or related security events.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%public_ip%'
        condition: selection
      fields:
        - src_ip
        - rule.name
        - rule.category
  - question: What IP addresses did aramexegypt.com resolve to during this timeframe?
    context: Documents the command and control infrastructure used by PREDATOR malware.
    range: +/-1h
    query: "aggregation: false\nlogsource:\n  category: network\n  service: dns\ndetection:\n  selection:\n    dns.query.name|contains: \"aramexegypt.com\"\n  condition: selection\nfields:\n  - dns.query.name\n  - dns.resolved_ip\n  - src_ip\n  \n"
  - question: Did any mobile device management or Android-related processes query this domain?
    context: Identifies mobile device connections that may indicate PREDATOR spyware installation.
    range: +/-30m
    query: "aggregation: false\nlogsource:\n  category: network\n  service: dns\ndetection:\n  selection:\n    dns.query.name|contains: \"aramexegypt.com\"\n  mobile_processes:\n    - \"android\"\n    - \"mobile\"\n    - \"adb\"\n    - \"fastboot\"\n  condition: selection\nfields:\n  - dns.query.name\n  - src_ip\n  - process.name\n  \n"
  - question: Are there other suspicious domains being queried by the same host?
    context: Reveals additional malware infrastructure or campaign-related domains.
    range: +/-6h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        suspicious_patterns:
          dns.query.name|contains:
            - "duckdns"
            - "ddns"
            - "no-ip"
            - "dynamic"
        filter:
          dns.query.name|contains: "aramexegypt.com"
        condition: selection and suspicious_patterns and not filter
      fields:
        - dns.query.name
        - dns.resolved_ip