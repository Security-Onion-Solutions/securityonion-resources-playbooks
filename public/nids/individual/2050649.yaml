name: ET MALWARE LIGHTWIRE Web Shell Activity Observed
id: 1241034
description: |
  Detects HTTP GET requests to specific Ivanti Connect Secure paths that indicate LIGHTWIRE web shell activity.
  May trigger on legitimate administrative access to Ivanti systems or security testing of these endpoints.
type: detection
detection_id: 2050649
detection_category: ''
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-31
questions:
  - question: What was the complete HTTP request to the Ivanti Connect Secure endpoint?
    context: Reveals the exact web shell command and parameters used in the LIGHTWIRE activity.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.method
        - http.useragent
        - http.virtual_host
        - http.uri
        - http.status_code
  - question: Does this host normally access Ivanti Connect Secure administrative interfaces?
    context: Determines if HTTP access to this Ivanti system represents normal administrative activity.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
  - question: What process initiated the connection to the Ivanti web shell endpoint?
    context: Identifies the application or tool making requests to the compromised Ivanti system.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
      detection:
        selection:
          community_id|expand: '%community_id%'
        filter:
          Image|exists: true
        condition: selection and filter
      fields:
        - hostname
        - User
        - Image
        - CommandLine
        - ProcessGuid
  - question: What DNS queries preceded this connection to the Ivanti system?
    context: Shows how the client resolved the Ivanti hostname before accessing the web shell.
    range: -5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.resolved_ip
  - question: What other external connections occurred from this host?
    context: Identifies additional network activity that may be related to the web shell session.
    range: +/-10m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        private:
          dst_ip|cidr:
            - '10.0.0.0/8'
            - '127.0.0.0/8'
            - '172.16.0.0/12'
            - '192.168.0.0/16'
            - '169.254.0.0/16'
        filter:
          dst_ip|expand: '%public_ip%'
        condition: selection and not (private or filter)
      fields:
        - dst_ip
        - dst_port
        - network.transport
        - connection.state_description
  - question: Are other hosts connecting to the same Ivanti infrastructure?
    context: Determines if multiple systems are accessing the compromised Ivanti Connect Secure instance.
    range: +/-24h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%public_ip%'
        filter:
          src_ip|expand: '%src_ip%'
        condition: selection and not filter
      fields:
        - src_ip
        - dst_port
        - network.transport
        - connection.state_description
  - question: What files were created on this host during the web shell activity timeframe?
    context: Identifies potential downloads or artifacts from the LIGHTWIRE web shell session.
    range: +/-1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%private_ip%'
          file.name|endswith:
          - .exe
          - .dll
          - .bat
          - .cmd
          - .ps1
          - .vbs
          - .js
          - .scr
          - .com
          - .pif
        condition: selection
      fields:
        - file.path
        - file.name
        - Image
        - ProcessGuid
        - User
  - question: Are there similar web shell requests across the organization?
    context: Reveals the scope of LIGHTWIRE activity and potential campaign targeting.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%public_ip%'
        condition: selection
      fields:
        - src_ip
        - rule.name
        - rule.category
  - question: Did any lateral movement occur from this host after the web shell activity?
    context: Assesses whether the web shell access led to internal network compromise.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%private_ip%'
          dst_port:
          - 445    # SMB
          - 139    # NetBIOS
          - 3389   # RDP
          - 5985   # WinRM HTTP
          - 5986   # WinRM HTTPS
          - 22     # SSH
          - 23     # Telnet
          - 135    # RPC
          - 5900   # VNC
        condition: selection
      fields:
        - src_ip
        - src_port
        - dst_ip
        - dst_port
        - network.transport
  - question: What is the pattern of requests to this Ivanti Connect Secure system?
    context: Analyzes the timing and frequency of web shell communications.
    range: +/-2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%related_ip%'
          dst_ip|expand: '%related_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - network.protocol
        - event.duration
        - client.ip_bytes
        - server.ip_bytes
        - connection.state_description
  - question: Were any administrative tools or remote access software executed?
    context: Identifies tools that may have been used to leverage the web shell access.
    range: +/-1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%private_ip%'
          Image|contains:
          - psexec.exe
          - mstsc.exe
          - TeamViewer.exe
          - anydesk.exe
          - rdp.exe
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid
  - question: What other Ivanti-related vulnerabilities are being exploited in this environment?
    context: Correlates with other Ivanti Connect Secure exploitation attempts.
    range: +/-24h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        ivanti_paths:
          http.uri|contains:
            - "/dana-na/"
            - "/dana/"
            - "/api/v1/"
            - "/compcheckresult.cgi"
            - "/welcome.cgi"
        condition: ivanti_paths
      fields:
        - src_ip
        - dst_ip
        - http.uri
        - http.method
        - http.user_agent