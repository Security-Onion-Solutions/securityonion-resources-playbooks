name: GPL NETBIOS SMB-DS DCERPC LSASS Direct Bind Attempt
id: 1227677
description: |
  Detects external connections attempting to bind directly to the LSASS service via DCERPC over SMB.
  May indicate reconnaissance or exploitation attempts targeting Windows authentication services, but could also represent legitimate domain operations or security scanning.
type: detection
detection_id: 2102526
detection_category: ''
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete SMB session that triggered this LSASS bind attempt?
    context: Reveals the full DCERPC binding request and SMB session details.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
  - question: Does this external host normally connect to SMB services in this network?
    context: Determines if SMB access from this source represents normal business operations.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
  - question: What Windows service or process accepted this DCERPC connection?
    context: Identifies the specific Windows component that processed the LSASS bind request.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
      detection:
        selection:
          community_id|expand: '%community_id%'
        filter:
          Image|exists: true
        condition: selection and filter
      fields:
        - hostname
        - User
        - Image
        - CommandLine
        - ProcessGuid
  - question: What other network activity occurred from this host during the same timeframe?
    context: Identifies additional reconnaissance or exploitation attempts beyond the LSASS binding.
    range: +/-10m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        private:
          dst_ip|cidr:
            - '10.0.0.0/8'
            - '127.0.0.0/8'
            - '172.16.0.0/12'
            - '192.168.0.0/16'
            - '169.254.0.0/16'
        filter:
          dst_ip|expand: '%public_ip%'
        condition: selection and not (private or filter)
      fields:
        - dst_ip
        - dst_port
        - network.transport
        - connection.state_description
  - question: Are other hosts in the network receiving similar DCERPC LSASS bind attempts?
    context: Determines if this represents targeted reconnaissance across multiple Windows systems.
    range: +/-24h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%public_ip%'
        filter:
          src_ip|expand: '%src_ip%'
        condition: selection and not filter
      fields:
        - src_ip
        - dst_port
        - network.transport
        - connection.state_description
  - question: What authentication-related events occurred on the target host?
    context: Identifies logon attempts or authentication failures that may be related to LSASS targeting.
    range: +/-30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - "lsass.exe"
            - "winlogon.exe"
            - "svchost.exe"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ParentImage
  - question: Were any registry modifications made to authentication or LSA settings?
    context: Detects potential persistence mechanisms or security setting changes following LSASS access.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%related_ip%'
          TargetObject|contains:
          - Run
          - RunOnce
          - Services
          - Startup
          - Winlogon
          - Explorer
          - Shell
          - AppInit_DLLs
          - Image File Execution Options
          - Class
          - ContextMenuHandlers
          - ShellExecuteHooks
        condition: selection
      fields:
        - User
        - Image
        - ProcessGuid
        - TargetObject
        - Details
  - question: Did any lateral movement occur from the target host after this connection?
    context: Identifies whether successful LSASS access led to credential theft and lateral movement.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%private_ip%'
          dst_port:
          - 445    # SMB
          - 139    # NetBIOS
          - 3389   # RDP
          - 5985   # WinRM HTTP
          - 5986   # WinRM HTTPS
          - 22     # SSH
          - 23     # Telnet
          - 135    # RPC
          - 5900   # VNC
        condition: selection
      fields:
        - src_ip
        - src_port
        - dst_ip
        - dst_port
        - network.transport
  - question: What files were accessed or created in Windows system directories?
    context: Reveals potential malware deployment or system file modifications following LSASS access.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          file.path|contains:
            - "\\Windows\\System32\\"
            - "\\Windows\\SysWOW64\\"
            - "\\Windows\\Temp\\"
        condition: selection
      fields:
        - file.path
        - file.name
        - Image
        - User
  - question: Are there related alerts involving the same external IP across the organization?
    context: Identifies broader campaign activity targeting Windows authentication services.
    range: +/-24h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          related_ip|expand: '%related_ip%'
        filter:
          document_id|expand: '%document_id%'
        condition: selection and not filter
      fields:
        - rule.name
        - rule.category
        - src_ip
        - dst_ip
  - question: What is the pattern of SMB and RPC connections from this external source?
    context: Analyzes the timing and frequency of Windows service targeting attempts.
    range: +/-2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port:
            - 135
            - 445
            - 139
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.protocol
        - connection.state