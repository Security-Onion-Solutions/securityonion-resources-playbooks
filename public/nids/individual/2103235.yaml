name: GPL NETBIOS Messenger message overflow attempt
id: 1248693
description: |
  Detects UDP traffic to port 135 with specific byte patterns that may indicate buffer overflow attempts against the Windows Messenger service.
  May trigger on legitimate RPC communications or network scanning tools probing Windows services.
type: detection
detection_id: 2103235
detection_category: ''
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete UDP payload sent to port 135?
    context: Reveals the exact byte patterns and potential overflow data in the RPC request.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
  - question: Does this host normally receive RPC traffic on port 135?
    context: Determines if Windows RPC communication to this destination is typical.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
  - question: What other network activity occurred from the source IP?
    context: Identifies additional scanning or exploitation attempts from the same source.
    range: +/-30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        filter:
          dst_ip|expand: '%dst_ip%'
          dst_port|expand: '%dst_port%'
        condition: selection and not filter
      fields:
        - dst_ip
        - dst_port
        - network.protocol
        - connection.state
  - question: Are other hosts receiving similar RPC traffic patterns?
    context: Determines scope of potential network scanning or targeted exploitation.
    range: +/-24h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%public_ip%'
        filter:
          src_ip|expand: '%src_ip%'
        condition: selection and not filter
      fields:
        - src_ip
        - dst_port
        - network.transport
        - connection.state_description
  - question: Did the Windows host show signs of RPC service disruption?
    context: Assesses whether the overflow attempt affected service availability.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 135
        condition: selection
      fields:
        - src_ip
        - connection.state
        - connection.state_description
  - question: Were any Windows services restarted after this RPC activity?
    context: Identifies potential service crashes caused by buffer overflow attempts.
    range: +1h
    query: "aggregation: false\nlogsource:\n  category: process_creation\ndetection:\n  selection:\n    host.ip|expand: '%dst_ip%'\n    Image|endswith: \n      - \"\\\\net.exe\"\n      - \"\\\\sc.exe\"\n      - \"\\\\services.exe\"\n  condition: selection\nfields:\n  - Image\n  - CommandLine\n  - User\n"
  - question: Did any suspicious processes start on the target Windows host?
    context: Identifies potential code execution resulting from successful RPC exploitation.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|endswith:
            - "\\cmd.exe"
            - "\\powershell.exe"
            - "\\rundll32.exe"
            - "\\regsvr32.exe"
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - User
  - question: Are there related alerts involving the same source IP?
    context: Reveals broader attack patterns or scanning campaigns targeting Windows services.
    range: +/-24h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          related_ip|expand: '%related_ip%'
        filter:
          document_id|expand: '%document_id%'
        condition: selection and not filter
      fields:
        - rule.name
        - rule.category
        - src_ip
        - dst_ip
  - question: What is the timing pattern of connections to port 135?
    context: Determines if this represents automated scanning or targeted exploitation.
    range: +/-2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%related_ip%'
          dst_ip|expand: '%related_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - network.protocol
        - event.duration
        - client.ip_bytes
        - server.ip_bytes
        - connection.state_description
  - question: Did the target host establish any outbound connections after the RPC attempt?
    context: Identifies potential backdoor installations or data exfiltration following exploitation.
    range: +/-10m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        private:
          dst_ip|cidr:
            - '10.0.0.0/8'
            - '127.0.0.0/8'
            - '172.16.0.0/12'
            - '192.168.0.0/16'
            - '169.254.0.0/16'
        filter:
          dst_ip|expand: '%public_ip%'
        condition: selection and not (private or filter)
      fields:
        - dst_ip
        - dst_port
        - network.transport
        - connection.state_description
