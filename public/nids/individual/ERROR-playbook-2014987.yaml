# VALIDATION ERRORS:
# YAML Syntax Errors:
#   - Invalid syntax at line 34, column 79: mapping values are not allowed here
#
# ORIGINAL PLAYBOOK CONTENT:
name: ET WEB_SERVER possible IBM Rational Directory Server (RDS) Help system href Cross Site Scripting Attempt
id: 22014987
description: |
  Detects Cross-Site Scripting (XSS) attempts against IBM Rational Directory Server Help system via malicious href parameters in deferredView.jsp.
  This vulnerability allows injection of JavaScript code that executes in victim browsers. May trigger on legitimate help content containing JavaScript references.
type: detection
detection_id: 2014987
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact JavaScript payload injected in the href parameter?
    context: Analyzing the XSS payload reveals the attacker's intent, such as credential theft, session hijacking, or malware delivery.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - url.path
        - url.query
        - http.request.body.content
        - http.request.headers.referer

  - question: What specific XSS technique was used in this attack attempt?
    context: Different XSS techniques (script tags, event handlers, javascript: URLs) indicate varying levels of sophistication and impact.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - url.query
        - http.request.body.content
        - http.response.status_code
        - http.response.body.content
        - network.bytes_received

  # Type 2: Triage Assessment
  - question: Is this legitimate JavaScript content in IBM RDS Help documentation?
    context: Help systems may contain legitimate JavaScript examples or references that could trigger false positives.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains: "/rds-help/"
        condition: selection
      fields:
        - src_ip
        - url.path
        - url.query
        - http.request.headers.user_agent
        - http.response.status_code

  - question: Does this access pattern match normal help system usage by authorized users?
    context: Legitimate help system usage typically follows predictable patterns and occurs during business hours by known users.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - network.bytes_sent
        - network.bytes_received
        - network.protocol

  # Type 3: Activity Context
  - question: What web activity preceded this XSS attack attempt?
    context: Understanding the attack vector helps determine if this was targeted social engineering or opportunistic exploitation.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - url.path
        - http.request.headers.referer
        - http.request.method
        - http.response.status_code

  - question: What user and browser were targeted by this XSS attempt?
    context: Identifying the target user and browser helps assess the potential impact and success of the XSS attack.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          process.name|contains:
            - "iexplore.exe"
            - "chrome.exe"
            - "firefox.exe"
            - "msedge.exe"
        condition: selection
      fields:
        - process.name
        - process.command_line
        - user.name
        - process.parent.name
        - process.pid

  - question: Were there scanning or enumeration activities targeting this RDS server?
    context: XSS attacks are often preceded by reconnaissance to identify vulnerable parameters and injection points.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.path
        - http.request.method
        - http.response.status_code
        - http.request.headers.user_agent

  # Type 4: Impact Assessment
  - question: Did the server reflect the malicious JavaScript back to the user's browser?
    context: Successful XSS attacks require the server to include the malicious script in its response, enabling code execution in the victim's browser.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - http.response.headers.content_type
        - network.bytes_received

  - question: Are there signs of successful JavaScript execution or data theft?
    context: Successful XSS attacks may result in session hijacking, credential theft, or additional malicious requests from the victim's browser.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - url.path
        - http.request.method
        - http.request.headers.cookie
        - network.bytes_sent

  # Type 5: Forensic Deep-Dive
  - question: What specific IBM RDS version is vulnerable to this XSS attack?
    context: Different RDS versions have varying XSS protections and filtering mechanisms that affect exploitation success.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains: "/rds-help/"
        condition: selection
      fields:
        - url.path
        - http.response.headers.server
        - http.response.status_code
        - src_ip
        - url.query

  - question: Are there other XSS vulnerabilities being exploited on this or related servers?
    context: Attackers often chain multiple XSS vulnerabilities or use this as part of a broader web application attack campaign.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: "XSS"
        condition: selection
      fields:
        - rule.name
        - src_ip
        - url.path
        - url.query
        - alert.severity

  - question: What is the sophistication level and likely source of this XSS attack?
    context: Analyzing attack patterns, payloads, and techniques helps identify whether this is automated scanning or targeted exploitation.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.query|contains:
            - "script"
            - "javascript"
            - "alert"
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - url.path
        - http.request.headers.user_agent
        - http.response.status_code

  # Type 6: Enterprise Correlation
  - question: Are other IBM RDS installations being targeted with similar XSS attacks?
    context: XSS campaigns often target multiple instances of the same vulnerable application across an organization.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          url.path|contains: "/rds-help/advanced/deferredView.jsp"
          url.query|contains:
            - "script"
            - "javascript"
            - "alert"
        condition: selection
      fields:
        - dst_ip
        - src_ip
        - url.query
        - http.response.status_code

  - question: Is this part of a coordinated web application security testing or attack campaign?
    context: Correlating with other web attacks helps identify whether this is penetration testing, vulnerability scanning, or malicious exploitation.
    range: +/-48h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - "web-application-attack"
            - "XSS"
            - "Cross_Site_Scripting"
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - url.domain
        - url.path
        - alert.severity