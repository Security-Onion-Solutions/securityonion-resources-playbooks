# VALIDATION ERRORS:
# Sigma Query Errors:
#   - Question 7: Invalid logsource category 'authentication'. Valid categories: alert, network, firewall, proxy, webserver, process_creation, file_event, network_connection, dns, registry_event...
#
# ORIGINAL PLAYBOOK CONTENT:
name: ET MALWARE Win32/Spy.Agent.OHT - AnunakAPT TCP Keep-Alive
id: 22020026
description: |
  Detects TCP keep-alive traffic associated with Win32/Spy.Agent.OHT malware used by AnunakAPT group.
  Unlikely to trigger on legitimate traffic due to specific 24-byte payload signature pattern.
type: detection
detection_id: 2020026
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the exact 24-byte keep-alive payload transmitted?
    context: The specific payload pattern confirms AnunakAPT malware variant and communication protocol.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - rule.name
        - src_ip
        - dst_ip
        - dst_port

  - question: Is this host authorized to maintain persistent connections to external servers?
    context: Keep-alive traffic indicates ongoing C2 communication which is unusual for most workstations.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          duration|gt: 300
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - duration_avg
        - connection_count

  - question: What process is maintaining this persistent C2 connection?
    context: Identifying the parent process reveals how the malware achieved execution and persistence.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - process.name
        - process.pid
        - process.command_line
        - process.parent.name

  - question: What other AnunakAPT indicators have been detected on this host?
    context: AnunakAPT is a sophisticated financial threat group with multiple malware components.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'Anunak'
            - 'Spy.Agent'
            - 'financial'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - dst_ip
        - timestamp

  - question: Has this malware attempted to access financial applications or data?
    context: AnunakAPT specifically targets financial institutions and payment processing systems.
    range: -6h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          process.command_line|contains:
            - 'bank'
            - 'payment'
            - 'financial'
            - 'pos'
            - 'card'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - user.name

  - question: What sensitive files have been accessed on this compromised system?
    context: Spy.Agent malware is designed to steal sensitive data including financial information.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.extension|contains:
            - .doc
            - .xls
            - .pdf
            - .txt
            - .csv
        condition: selection
      fields:
        - file.name
        - file.path
        - event.action
        - process.name

  - question: Are there signs of credential harvesting or keylogging activity?
    context: AnunakAPT malware includes credential theft capabilities for lateral movement.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: authentication
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          event.outcome: 'failure'
        condition: selection
      fields:
        - user.name
        - source.ip
        - logon.type
        - event.outcome

  - question: Has lateral movement occurred from this compromised financial system?
    context: AnunakAPT uses initial compromise to pivot and access high-value financial systems.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 135
            - 139
            - 445
            - 3389
            - 5985
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - process.name

  - question: What data exfiltration has occurred via the C2 channel?
    context: Keep-alive connections are often used to exfiltrate stolen financial data.
    range: -6h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          bytes_out|gt: 100000
        condition: selection
      fields:
        - bytes_out
        - duration
        - timestamp
        - dst_port

  - question: Are other financial systems showing AnunakAPT compromise indicators?
    context: AnunakAPT campaigns typically target multiple systems within financial organizations.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'Anunak'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: What C2 infrastructure is being used by this AnunakAPT campaign?
    context: Identifying C2 servers helps understand the scope and block ongoing communications.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'Spy.Agent.OHT'
        condition: selection
      fields:
        - dst_ip
        - dns.resolved_ip
        - dst_port