# VALIDATION ERRORS:
# Sigma Query Errors:
#   - Question 7: Invalid logsource category 'authentication'. Valid categories: alert, network, firewall, proxy, webserver, process_creation, file_event, network_connection, dns, registry_event...
#
# ORIGINAL PLAYBOOK CONTENT:
name: ET ATTACK_RESPONSE Microsoft CScript Banner Outbound
id: 22020085
description: |
  Detects Windows Script Host (CScript) banner in outbound traffic indicating script execution.
  May trigger on legitimate administrative scripts but unusual for outbound network communications.
type: detection
detection_id: 2020085
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete CScript banner and associated script output?
    context: The banner reveals Windows Script Host version and may include script execution results.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - rule.name
        - src_ip
        - dst_ip
        - dst_port

  - question: Is this system authorized to run scripts that communicate externally?
    context: CScript execution with network output suggests either legitimate automation or malicious script activity.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          process.name|contains:
            - 'cscript.exe'
            - 'wscript.exe'
        condition: selection
      fields:
        - process.command_line
        - user.name
        - process.parent.name

  - question: What script file was executed to generate this outbound banner?
    context: Identifying the script source helps determine if this is legitimate administration or malicious activity.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          process.name: 'cscript.exe'
        condition: selection
      fields:
        - process.command_line
        - process.parent.name
        - process.parent.command_line
        - user.name

  - question: What other suspicious script execution has occurred on this host?
    context: Malicious scripts often execute in sequences or as part of larger attack campaigns.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          process.name|contains:
            - 'powershell.exe'
            - 'cmd.exe'
            - 'wscript.exe'
            - 'mshta.exe'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - timestamp

  - question: Has this script execution resulted in file system changes?
    context: Scripts often download, create, or modify files as part of their execution.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          event.action|contains:
            - created
            - modified
        condition: selection
      fields:
        - file.name
        - file.path
        - file.extension
        - process.name

  - question: What network connections were established during script execution?
    context: Scripts may download additional payloads or communicate with C2 servers.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          process.name|contains:
            - 'cscript.exe'
            - 'wscript.exe'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - bytes_in

  - question: Are there signs of credential access or privilege escalation?
    context: Malicious scripts often attempt to harvest credentials or escalate privileges.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: authentication
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - user.name
        - event.outcome
        - logon.type
        - source.ip

  - question: What registry modifications occurred during script execution?
    context: Scripts may modify registry for persistence or to disable security features.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          process.name|contains:
            - 'cscript.exe'
            - 'wscript.exe'
        condition: selection
      fields:
        - registry.key
        - registry.value.name
        - registry.value.data
        - event.action

  - question: Has this script execution led to additional malware deployment?
    context: Scripts are commonly used as first-stage loaders for additional malicious payloads.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - malware
            - trojan
            - backdoor
        condition: selection
      fields:
        - rule.name
        - rule.category
        - dst_ip
        - timestamp

  - question: Are other systems showing similar script-based attack patterns?
    context: Script-based attacks often target multiple systems using similar techniques.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'CScript'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: What external infrastructure is being contacted by these scripts?
    context: Identifying script communication destinations helps understand attack infrastructure.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          process.name|contains:
            - 'cscript.exe'
            - 'wscript.exe'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out