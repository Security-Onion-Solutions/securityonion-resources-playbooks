# VALIDATION ERRORS:
# Sigma Query Errors:
#   - Question 10: Invalid logsource category 'authentication'. Valid categories: alert, network, firewall, proxy, webserver, process_creation, file_event, network_connection, dns, registry_event...
#
# ORIGINAL PLAYBOOK CONTENT:
name: ET WEB_SERVER Possible CVE-2015-1427 Elastic Search Sandbox Escape Remote Code Execution Attempt
id: 22020648
description: |
  Detects exploitation attempts targeting Elasticsearch CVE-2015-1427 vulnerability.
  This vulnerability allows remote code execution through Groovy script injection in search queries.
  Legitimate Elasticsearch usage should not contain Java reflection calls in search scripts.
type: detection
detection_id: 2020648
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete malicious Groovy script payload sent to Elasticsearch?
    context: Analyzing the full script reveals the attacker's intended commands and helps assess the exploitation attempt's sophistication.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.body.content
        - http.request.method
        - url.full
        - http.request.headers

  - question: Is this Elasticsearch server normally accessed by this source IP for legitimate queries?
    context: Distinguishing between authorized administrative access and external exploitation attempts is crucial for triage.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 9200
            - 9292
        condition: selection
      fields:
        - url.path
        - http.request.method
        - http.response.status_code
        - user_agent.original

  - question: What was the Elasticsearch server's response to this exploitation attempt?
    context: The response code and content indicate whether the exploit succeeded and what level of access was gained.
    range: -5m/+5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - http.response.headers
        - url.full

  - question: What other HTTP requests were made to this Elasticsearch server in the attack sequence?
    context: Attackers often perform reconnaissance and multiple exploitation attempts as part of a coordinated attack.
    range: -1h/+1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 9200
            - 9292
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.response.status_code
        - http.request.body.content

  - question: Are there signs of successful command execution on the Elasticsearch server?
    context: If the exploit succeeded, there should be evidence of process creation or system changes on the target server.
    range: -15m/+2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ParentImage
        - ProcessGuid

  - question: What network connections were established from the Elasticsearch server after the attack?
    context: Successful exploitation often leads to reverse shells or additional C2 communications from the compromised server.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - service
        - conn_state
        - orig_bytes

  - question: Were any files created or modified on the Elasticsearch server following the attack?
    context: Attackers often drop additional tools, create backdoors, or modify system files after gaining initial access.
    range: +24h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.hash.sha256
        - ProcessName
        - User

  - question: What is the geolocation and reputation of the attacking IP address?
    context: Understanding the source helps determine if this is targeted attack or opportunistic scanning.
    range: -24h/+24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - service
        - conn_state

  - question: Are there other Elasticsearch servers in the environment that were targeted?
    context: Attackers often target multiple instances of the same vulnerable service across an organization.
    range: -24h/+24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 9200
            - 9292
        condition: selection
      fields:
        - dst_ip
        - url.path
        - http.request.method
        - http.response.status_code

  - question: What authentication events occurred on the Elasticsearch server around the time of attack?
    context: Understanding access patterns helps determine if credentials were compromised or if the attack was unauthenticated.
    range: -2h/+2h
    query: |
      aggregation: false
      logsource:
        category: authentication
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - user.name
        - source.ip
        - event.outcome
        - logon.type

  - question: Are there similar CVE-2015-1427 exploitation attempts from other source IPs?
    context: Coordinated attacks or widespread scanning campaigns often involve multiple source addresses targeting the same vulnerability.
    range: -24h/+24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "CVE-2015-1427"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - http.request.body.content