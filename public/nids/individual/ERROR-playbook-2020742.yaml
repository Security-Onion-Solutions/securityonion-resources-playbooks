# VALIDATION ERRORS:
# Sigma Query Errors:
#   - Question 11: Invalid logsource category 'authentication'. Valid categories: alert, network, firewall, proxy, webserver, process_creation, file_event, network_connection, dns, registry_event...
#
# ORIGINAL PLAYBOOK CONTENT:
name: ET MALWARE Win32.Hyteod.acox Domain Generation Algorithm (DGA) Lookup NXDOMAIN Response
id: 22020742
description: |
  Detects Win32.Hyteod.acox malware using Domain Generation Algorithm (DGA) for C2 communication.
  This signature identifies DNS NXDOMAIN responses to algorithmically generated domains ending in .ru TLD.
  Legitimate applications should not generate random 50-character domain queries to .ru domains.
type: detection
detection_id: 2020742
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What were the specific algorithmically generated .ru domain names that triggered this DGA detection?
    context: Analyzing the DGA domains helps identify the malware variant and predict future C2 domains in the .ru TLD.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - dns.query.name
        - dns.response_code
        - dns.query.type_name
        - dns.flags.response

  - question: Is this host normally performing DNS queries to .ru domains for legitimate business purposes?
    context: Understanding normal .ru domain usage helps distinguish between legitimate traffic and malware DGA activity.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.query.name|contains: ".ru"
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.response_code
        - dns.query.type_name

  - question: What process on the infected system is generating these .ru DGA DNS queries?
    context: Identifying the malicious process helps understand the infection vector and enables targeted remediation.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ParentImage
        - ProcessGuid

  - question: What is the frequency and timing pattern of .ru DGA queries from this host?
    context: DGA algorithms typically generate queries in predictable patterns, helping confirm Hyteod malware behavior.
    range: -2h/+2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.response_code
        - dns.query.type_name
        - dns.resolved_ip

  - question: Have any of the .ru DGA domains successfully resolved to active C2 infrastructure?
    context: Successful DNS resolutions indicate active C2 infrastructure and potential for malware communication.
    range: -24h/+24h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.response_code: "NOERROR"
          dns.query.name|contains: ".ru"
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name
        - dns.flags.authoritative

  - question: Are there network connections to IPs that resolved from successful .ru DGA queries?
    context: Connections to resolved DGA domains indicate active C2 communication and potential data exfiltration.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - service
        - conn_state
        - orig_bytes
        - resp_bytes

  - question: What files were recently created or modified that might be associated with this Hyteod variant?
    context: Hyteod malware often drops additional components and creates persistence mechanisms on infected systems.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.hash.sha256
        - ProcessName
        - User

  - question: Are there other hosts showing similar .ru DGA behavior indicating a broader infection?
    context: Malware campaigns often involve multiple infected systems with coordinated DGA activity across different TLDs.
    range: -24h/+24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Hyteod"
        condition: selection
      fields:
        - src_ip
        - dns.query.name
        - rule.name
        - rule.category

  - question: What was the initial infection vector that led to this Hyteod .ru DGA activity?
    context: Understanding how the system was compromised helps prevent similar infections and identify attack patterns.
    range: -7d
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.response.status_code
        - user_agent.original

  - question: Are there registry modifications that indicate this Hyteod variant's persistence mechanisms?
    context: Hyteod malware typically creates registry entries for persistence and configuration storage.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessName
        - User

  - question: What authentication events occurred that might indicate credential harvesting capabilities?
    context: Hyteod variants often include credential stealing capabilities that could lead to lateral movement.
    range: -24h/+24h
    query: |
      aggregation: false
      logsource:
        category: authentication
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - user.name
        - source.ip
        - event.outcome
        - logon.type