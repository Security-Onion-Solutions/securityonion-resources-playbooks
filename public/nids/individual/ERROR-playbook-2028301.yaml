# VALIDATION ERRORS:
# YAML Syntax Errors:
#   - Invalid syntax at line 1, column 52: mapping values are not allowed here
#
# ORIGINAL PLAYBOOK CONTENT:
name: ET JA3 Hash - Metasploit http scanner (tested: 4.11.5 Kali)
id: 22028301
description: |
  Detects Metasploit HTTP scanner based on unique JA3 TLS fingerprint.
  JA3 hash 16f17c896273d1d098314a02e87dd4cb is specific to Metasploit HTTP scanning modules.
  May rarely trigger on other tools with identical TLS implementations but typically indicates penetration testing or attack activity.
type: detection
detection_id: 2028301
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete TLS handshake pattern that generated this JA3 hash?
    context: Understanding the TLS parameters reveals the specific Metasploit module and configuration being used.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - tls.version
        - tls.cipher_suites
        - tls.extensions
        - tls.elliptic_curves

  - question: What specific target services were being scanned?
    context: The destination ports and services reveal the scope and intent of the scanning activity.
    query: |
      aggregation: false
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - dst_port
        - tls.server.certificate.subject
        - tls.server.certificate.issuer
        - tls.server.certificate.serial_number

  # Type 2: Triage Assessment
  - question: Is this authorized penetration testing or security assessment?
    context: Metasploit usage may be legitimate if conducted by authorized security teams during scheduled assessments.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 80
            - 443
            - 8080
            - 8443
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - connection.state

  - question: Does the source IP belong to known security testing infrastructure?
    context: Legitimate penetration testing often originates from known security vendor IP ranges or designated testing networks.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - connection.protocol

  # Type 3: Activity Context
  - question: What system is running the Metasploit HTTP scanner?
    context: Identifying the source system helps determine if this is an internal security tool or external attack.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          process.name|contains:
            - 'msfconsole'
            - 'ruby'
            - 'metasploit'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - User

  - question: What other scanning or reconnaissance activity preceded this?
    context: HTTP scanning often follows initial network discovery and port scanning phases.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection.protocol
        - connection.state

  - question: Are there signs of systematic target enumeration?
    context: Understanding the scanning pattern helps assess whether this is targeted reconnaissance or broad discovery.
    range: +/-30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - tls.server.certificate.subject

  # Type 4: Impact Assessment
  - question: Were any vulnerabilities successfully identified or exploited?
    context: Successful exploitation following scanning indicates active compromise requiring immediate response.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - 'exploit'
            - 'shellcode'
            - 'trojan'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - dst_ip

  - question: What sensitive services or applications were targeted?
    context: Scanning of critical services indicates higher risk and potential business impact.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 443
            - 8443
            - 9443
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - tls.server.certificate.subject

  # Type 5: Forensic Deep-Dive
  - question: What specific Metasploit modules and payloads are being used?
    context: Different Metasploit modules have varying capabilities and indicate different attack objectives.
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          process.command_line|contains:
            - 'auxiliary/scanner'
            - 'exploit/'
            - 'payload/'
        condition: selection
      fields:
        - process.command_line
        - process.parent.command_line
        - User

  - question: Are there signs of post-exploitation activity or persistence?
    context: Successful exploitation may be followed by persistence mechanisms or lateral movement attempts.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          connection.state: 'established'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection.bytes_sent
        - connection.bytes_received

  # Type 6: Enterprise Correlation
  - question: Are other systems showing similar Metasploit scanning activity?
    context: Coordinated scanning across multiple systems may indicate a broader penetration testing engagement or attack campaign.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'Metasploit'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is this part of a multi-stage attack campaign across the network?
    context: Metasploit scanning often precedes exploitation attempts and lateral movement in advanced attacks.
    range: -48h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.category|contains:
            - 'exploit'
            - 'trojan'
            - 'policy-violation'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.category
        - rule.name