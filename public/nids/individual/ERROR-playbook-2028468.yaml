# VALIDATION ERRORS:
# YAML Syntax Errors:
#   - Invalid syntax at line 1, column 35: mapping values are not allowed here
#
# ORIGINAL PLAYBOOK CONTENT:
name: ET JA3 Hash - sqlmap (tested: v1.0.7.0 OS X)
id: 22028468
description: |
  Detects TLS connections with JA3 hash associated with sqlmap v1.0.7.0 on macOS.
  Legitimate when used by authorized security professionals for penetration testing.
  May indicate unauthorized SQL injection attacks targeting web application databases.
type: detection
detection_id: 2028468
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What is the TLS handshake signature for this macOS sqlmap instance?
    context: JA3 fingerprinting confirms specific sqlmap version and macOS TLS implementation.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - tls.client.ja3
        - tls.client.server_name
        - tls.version
        - src_ip
        - dst_ip
        - dst_port

  - question: Is this SQL injection testing part of authorized security assessment?
    context: Legitimate sqlmap usage should be coordinated with security teams and documented.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 80
            - 443
            - 3000
            - 8080
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - connection_state

  - question: What HTTP injection patterns are being used against the target?
    context: sqlmap v1.0.7.0 uses specific injection techniques and payload structures.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - http.request.body.content
        - user_agent.original

  - question: Are there successful database enumeration attempts?
    context: sqlmap performs systematic database structure discovery during injection testing.
    range: +/-30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.full|contains:
            - 'information_schema'
            - 'sys.tables'
            - 'mysql.user'
            - 'pg_tables'
        condition: selection
      fields:
        - url.path
        - url.query
        - http.response.status_code
        - http.response.body.content

  - question: What database management system is being targeted?
    context: Understanding target DBMS helps assess potential impact and data at risk.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|expand: '%dst_port%'
        condition: selection
      fields:
        - http.response.headers
        - http.response.status_code
        - url.path

  - question: Are there signs of data extraction or dumping activity?
    context: Successful SQL injection often leads to database content extraction.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - bytes_in
        - bytes_out
        - duration
        - connection_state

  - question: What macOS processes are associated with this sqlmap execution?
    context: Process analysis helps determine if sqlmap usage is authorized or malicious.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          Hostname|expand: '%src_ip%'
          CommandLine|contains:
            - 'python'
            - 'sqlmap'
            - '/usr/bin/python'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: Are there file artifacts from sqlmap database dumping?
    context: sqlmap creates output files containing extracted database information.
    range: +/-1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - '.csv'
            - '.sql'
            - 'dump'
            - 'sqlmap'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size
        - ProcessName

  - question: Has the target application shown error responses indicating injection success?
    context: Database errors in HTTP responses confirm successful SQL injection exploitation.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          src_ip|expand: '%dst_ip%'
          http.response.body.content|contains:
            - 'SQL syntax'
            - 'mysql_fetch'
            - 'ORA-'
            - 'Microsoft OLE DB'
        condition: selection
      fields:
        - http.response.body.content
        - http.response.status_code
        - url.path

  - question: Are there other penetration testing tools being used concurrently?
    context: Multiple security tools may indicate comprehensive authorized testing or coordinated attack.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'nmap'
            - 'burp'
            - 'nikto'
            - 'dirb'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - dst_port

  - question: Are multiple web applications being tested from this macOS system?
    context: Broad application testing may indicate systematic vulnerability assessment or attack campaign.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - url.path
        - http.request.method
        - user_agent.original