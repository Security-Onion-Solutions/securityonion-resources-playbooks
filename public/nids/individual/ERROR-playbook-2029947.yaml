# VALIDATION ERRORS:
# Sigma Query Errors:
#   - Question 9: Invalid logsource category 'authentication'. Valid categories: alert, network, firewall, proxy, webserver, process_creation, file_event, network_connection, dns, registry_event...
#
# ORIGINAL PLAYBOOK CONTENT:
name: ET WEB_SERVER Generic PHP Mailer Accessed on Internal Compromised Server
id: 22029947
description: |
  Detects access to W0rmVps PRIV8 MAILER web interface on internal servers.
  Indicates potential server compromise with webshell deployment for spam operations.
  No legitimate business use for this specific mailer interface.
type: detection
detection_id: 2029947
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What is the complete HTTP response containing the W0rmVps PRIV8 MAILER interface?
    context: Analyzing the full response reveals the mailer's capabilities and configuration options.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.response.body.content
        - http.response.status_code
        - url.full
        - http.request.method

  - question: Is there any legitimate administrative access to this server that could explain this activity?
    context: Determines if this represents unauthorized access or compromised legitimate access.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.request.method
        - user_agent.original

  - question: What HTTP requests preceded access to this mailer interface?
    context: Understanding the attack chain reveals how the attacker gained access to deploy the webshell.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.request.body.content
        - user_agent.original

  - question: What other web applications or paths were accessed on this compromised server?
    context: Identifies scope of compromise and additional malicious tools deployed.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - src_ip
        - http.request.method

  - question: Has the mailer interface been used to send spam emails?
    context: Determines if the compromised server is actively being used for malicious email operations.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 25
            - 587
            - 465
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.bytes
        - network.packets

  - question: What processes are running on the compromised web server?
    context: Identifies web server processes and potential additional malware or backdoors.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - user.name

  - question: Are there file modifications indicating webshell deployment on this server?
    context: Confirms compromise method and identifies malicious files for removal.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          file.extension|contains:
            - 'php'
            - 'asp'
            - 'jsp'
        condition: selection
      fields:
        - file.path
        - file.name
        - file.hash.md5
        - process.name

  - question: What network connections has this server established since compromise?
    context: Identifies command and control communications and data exfiltration attempts.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.protocol
        - network.bytes

  - question: Are there authentication failures or unusual login patterns on this server?
    context: Reveals brute force attacks or credential compromise leading to server access.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: authentication
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - user.name
        - source.ip
        - event.outcome
        - logon.type

  - question: Is this mailer interface accessible from other internal systems?
    context: Assesses lateral movement risk and determines containment requirements.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - url.path
        - user_agent.original

  - question: Are other internal servers showing similar mailer interface access patterns?
    context: Identifies campaign scope and additional compromised systems requiring investigation.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'PHP Mailer'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name