# VALIDATION ERRORS:
# Sigma Query Errors:
#   - Question 10: Invalid logsource category 'authentication'. Valid categories: alert, network, firewall, proxy, webserver, process_creation, file_event, network_connection, dns, registry_event...
#
# ORIGINAL PLAYBOOK CONTENT:
name: ET WEB_CLIENT Generic PHP Mailer Accessed on External Compromised Server
id: 22029948
description: |
  Detects access to SMTP Mailer interface on external servers from internal clients.
  May indicate legitimate email service access or connection to compromised external servers.
  Requires context analysis to determine malicious intent.
type: detection
detection_id: 2029948
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What is the complete SMTP Mailer interface response received by the client?
    context: Analyzing the interface reveals functionality and determines if this is legitimate email service or malicious mailer.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.response.body.content
        - http.response.status_code
        - url.full
        - http.request.method

  - question: Is this user authorized to access external email services or webmail interfaces?
    context: Determines if this represents legitimate business activity or policy violation.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 80
            - 443
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - user_agent.original

  - question: What HTTP requests did this client make to access the mailer interface?
    context: Understanding the access pattern reveals if this was direct navigation or redirect from malicious site.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.referer
        - user_agent.original

  - question: What is the reputation and categorization of the external server hosting this mailer?
    context: Determines if the external server is known malicious or legitimate email service provider.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          dns.resolved_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.question.name
        - dns.question.type

  - question: Has this client submitted any email content through the mailer interface?
    context: Identifies if the mailer is being actively used for email operations and potential data exfiltration.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.request.method: 'POST'
        condition: selection
      fields:
        - url.full
        - http.request.body.content
        - http.response.status_code

  - question: What process initiated this web request to the external mailer?
    context: Determines if request originated from browser, script, or malware on the client system.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          process.name|contains:
            - 'browser'
            - 'chrome'
            - 'firefox'
            - 'powershell'
            - 'cmd'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - user.name

  - question: Are there signs of malware or suspicious processes on the client system?
    context: Identifies if the client is compromised and being used for unauthorized email operations.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.hash.md5
        - user.name

  - question: What other external connections has this client established recently?
    context: Reveals broader compromise indicators and command and control communications.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.protocol
        - network.bytes

  - question: Has this client accessed other suspicious web applications or phishing sites?
    context: Determines if this is part of broader malicious web activity or isolated incident.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - 'WEB_CLIENT'
            - 'PHISHING'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - url.domain

  - question: Are there authentication events indicating compromised credentials on this client?
    context: Reveals if legitimate user credentials were compromised leading to unauthorized email access.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: authentication
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - user.name
        - event.outcome
        - logon.type
        - source.ip

  - question: Are other internal clients accessing similar external mailer interfaces?
    context: Identifies campaign scope and determines if this represents coordinated malicious activity.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'PHP Mailer'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - rule.name
        - url.domain