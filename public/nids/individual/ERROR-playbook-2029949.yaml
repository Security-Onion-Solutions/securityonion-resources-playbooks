# VALIDATION ERRORS:
# Sigma Query Errors:
#   - Question 8: Invalid logsource category 'authentication'. Valid categories: alert, network, firewall, proxy, webserver, process_creation, file_event, network_connection, dns, registry_event...
#
# ORIGINAL PLAYBOOK CONTENT:
name: ET WEB_SERVER Generic PHP Mailer Accessed on Internal Compromised Server
id: 22029949
description: |
  Detects access to SMTP Mailer interface on internal servers indicating compromise.
  Similar to W0rmVps mailer but with different interface branding.
  No legitimate business use for this specific mailer interface on internal servers.
type: detection
detection_id: 2029949
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What is the complete SMTP Mailer interface response from the internal server?
    context: Analyzing the full interface reveals mailer capabilities and configuration for spam operations.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.response.body.content
        - http.response.status_code
        - url.full
        - http.request.method

  - question: Is there any authorized administrative activity that could explain access to this interface?
    context: Rules out legitimate server administration or maintenance activities.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.request.method
        - user_agent.original
        - http.request.referrer

  - question: What attack vector was used to deploy this mailer on the internal server?
    context: Understanding compromise method helps identify vulnerabilities and prevent reoccurrence.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          http.request.method|contains:
            - 'POST'
            - 'PUT'
        condition: selection
      fields:
        - url.full
        - http.request.body.content
        - src_ip
        - user_agent.original

  - question: What other malicious files or tools were uploaded to this compromised server?
    context: Identifies full scope of compromise and additional threats requiring remediation.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          file.extension|contains:
            - 'php'
            - 'asp'
            - 'jsp'
        condition: selection
      fields:
        - file.path
        - file.name
        - file.hash.md5
        - process.name

  - question: Has the mailer been actively used to send spam or malicious emails?
    context: Determines operational impact and identifies potential victims of spam campaigns.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 25
            - 587
            - 465
            - 2525
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.bytes
        - network.packets

  - question: What processes are running on the compromised web server?
    context: Identifies web server processes and potential additional malware or persistence mechanisms.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - user.name

  - question: Are there signs of data exfiltration or command and control communications?
    context: Identifies broader compromise indicators beyond just spam operations.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.protocol
        - network.bytes

  - question: What authentication events preceded the server compromise?
    context: Reveals attack vectors such as brute force, credential stuffing, or stolen credentials.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: authentication
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - user.name
        - source.ip
        - event.outcome
        - logon.type

  - question: Can this mailer interface be accessed from other internal systems?
    context: Assesses lateral movement risk and determines network segmentation effectiveness.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - url.path
        - user_agent.original

  - question: Are there registry modifications indicating persistence mechanisms on this server?
    context: Identifies how attackers maintain access for continued malicious operations.
    range: +/-1h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - registry.path
        - registry.value
        - process.name

  - question: Are other internal servers showing similar mailer deployment patterns?
    context: Determines if this is isolated incident or part of broader infrastructure compromise.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'SMTP Mailer'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name