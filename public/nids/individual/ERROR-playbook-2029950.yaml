# VALIDATION ERRORS:
# Sigma Query Errors:
#   - Question 10: Invalid logsource category 'authentication'. Valid categories: alert, network, firewall, proxy, webserver, process_creation, file_event, network_connection, dns, registry_event...
#
# ORIGINAL PLAYBOOK CONTENT:
name: ET WEB_CLIENT Generic PHP Mailer Accessed on External Compromised Server
id: 22029950
description: |
  Detects access to Priv8 Mailer Inbox interface on external servers from internal clients.
  May indicate legitimate webmail access or connection to compromised external infrastructure.
  Requires analysis to distinguish between authorized and malicious activity.
type: detection
detection_id: 2029950
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What is the complete Priv8 Mailer Inbox interface received by the client?
    context: Analyzing the interface structure reveals functionality and helps determine legitimacy versus malicious use.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.response.body.content
        - http.response.status_code
        - url.full
        - http.request.method

  - question: Is this client authorized to access external webmail or email management interfaces?
    context: Determines if this activity violates organizational policy or represents legitimate business use.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 80
            - 443
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - user_agent.original

  - question: How did the client navigate to this external mailer interface?
    context: Understanding access path reveals if this was intentional navigation or redirect from malicious content.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.referer
        - user_agent.original

  - question: What is the reputation and hosting details of the external server?
    context: Determines if the server is legitimate email service provider or compromised infrastructure.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          dns.resolved_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.question.name
        - dns.question.type

  - question: Has the client interacted with the mailer functionality beyond viewing the interface?
    context: Identifies if the mailer is being actively used for email operations or data manipulation.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.request.method: 'POST'
        condition: selection
      fields:
        - url.full
        - http.request.body.content
        - http.response.status_code

  - question: What process on the client system initiated this web request?
    context: Determines if request came from legitimate browser use or automated/malicious process.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          process.name|contains:
            - 'browser'
            - 'chrome'
            - 'firefox'
            - 'powershell'
            - 'curl'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - user.name

  - question: Are there indicators of compromise on the client system?
    context: Identifies if the client is infected with malware that led to accessing this external mailer.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.hash.md5
        - user.name

  - question: What other external connections has this client established?
    context: Reveals broader network activity patterns that may indicate compromise or policy violations.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.protocol
        - network.bytes

  - question: Has this client accessed other suspicious or malicious web content?
    context: Determines if this is part of broader malicious web activity or isolated incident.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - 'WEB_CLIENT'
            - 'MALWARE'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - url.domain

  - question: Are there failed authentication attempts or credential compromise indicators?
    context: Reveals if legitimate user credentials were compromised leading to unauthorized access.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: authentication
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - user.name
        - event.outcome
        - logon.type
        - source.ip

  - question: Are other internal clients accessing similar external mailer interfaces?
    context: Identifies campaign scope and determines if this represents coordinated threat activity.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'Priv8 Mailer'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - url.domain