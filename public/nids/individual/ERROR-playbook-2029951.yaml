# VALIDATION ERRORS:
# Sigma Query Errors:
#   - Question 8: Invalid logsource category 'authentication'. Valid categories: alert, network, firewall, proxy, webserver, process_creation, file_event, network_connection, dns, registry_event...
#
# ORIGINAL PLAYBOOK CONTENT:
name: ET WEB_SERVER Generic PHP Mailer Accessed on Internal Compromised Server
id: 22029951
description: |
  Detects access to Priv8 Mailer Inbox interface on internal servers indicating compromise.
  This specific mailer interface has no legitimate business purpose on internal infrastructure.
  Represents successful webshell deployment for spam operations.
type: detection
detection_id: 2029951
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What is the complete Priv8 Mailer Inbox interface served by the internal server?
    context: Analyzing the full interface reveals mailer configuration and operational capabilities for spam campaigns.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.response.body.content
        - http.response.status_code
        - url.full
        - http.request.method

  - question: Is there any legitimate administrative reason for this interface to exist on this server?
    context: Rules out authorized email server administration or development activities.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.request.method
        - user_agent.original
        - http.request.referrer

  - question: What vulnerability or attack method was used to compromise this server?
    context: Understanding compromise vector helps identify security gaps and prevent similar attacks.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          http.request.method|contains:
            - 'POST'
            - 'PUT'
        condition: selection
      fields:
        - url.full
        - http.request.body.content
        - src_ip
        - user_agent.original

  - question: What malicious files were uploaded or modified during the server compromise?
    context: Identifies all components of the attack for complete remediation and forensic analysis.
    range: -3h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          file.extension|contains:
            - 'php'
            - 'asp'
            - 'jsp'
            - 'exe'
        condition: selection
      fields:
        - file.path
        - file.name
        - file.hash.md5
        - process.name

  - question: Has the mailer interface been used to conduct active spam operations?
    context: Determines operational impact and identifies potential victims requiring notification.
    range: +6h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 25
            - 587
            - 465
            - 2525
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.bytes
        - network.packets

  - question: What processes are currently running on the compromised server?
    context: Identifies web server processes, potential backdoors, and persistence mechanisms.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - user.name

  - question: Are there signs of data theft or command and control activity from this server?
    context: Identifies if compromise extends beyond spam operations to data exfiltration or botnet participation.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.protocol
        - network.bytes

  - question: What authentication events occurred before and during the compromise?
    context: Reveals attack vectors such as credential theft, brute force, or privilege escalation.
    range: -48h
    query: |
      aggregation: true
      logsource:
        category: authentication
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - user.name
        - source.ip
        - event.outcome
        - logon.type

  - question: Is the mailer interface accessible from other network segments or the internet?
    context: Assesses exposure risk and determines urgency of containment measures.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - url.path
        - user_agent.original

  - question: Are there system modifications indicating attacker persistence mechanisms?
    context: Identifies how attackers maintain access for continued operations after initial compromise.
    range: +/-2h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - registry.path
        - registry.value
        - process.name

  - question: Are other internal servers compromised with similar mailer interfaces?
    context: Determines campaign scope and identifies additional systems requiring immediate investigation.
    range: +/-6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'Priv8 Mailer'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name