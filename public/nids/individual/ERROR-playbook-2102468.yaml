# VALIDATION ERRORS:
# Sigma Query Errors:
#   - Question 10: Invalid logsource category 'authentication'. Valid categories: alert, network, firewall, proxy, webserver, process_creation, file_event, network_connection, dns, registry_event...
#
# ORIGINAL PLAYBOOK CONTENT:
name: GPL NETBIOS SMB-DS D$ Share Access
id: 22102468
description: |
  Detects access attempts to the administrative D$ share via SMB, which provides direct access to the D: drive.
  Administrative shares like D$ are high-value targets for attackers seeking system-level access.
  May trigger on legitimate administrative activities or backup operations accessing system drives.
type: detection
detection_id: 2102468
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact SMB command and share path accessed in this D$ share request?
    context: Understanding the specific SMB command structure reveals the nature and intent of the administrative share access.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - rule.name
        - smb.command
        - smb.share

  - question: What authentication context and user credentials were used for this D$ share access?
    context: Administrative share access requires elevated privileges, revealing the compromise level and attack progression.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - smb.auth.username
        - smb.auth.domain
        - smb.ntlmssp.user

  # Type 2: Triage Assessment
  - question: Is this D$ share access from a known administrative workstation or service account?
    context: Legitimate system administration often requires access to administrative shares for maintenance and monitoring.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 445
        condition: selection
      fields:
        - dst_ip
        - bytes_in
        - bytes_out
        - duration

  - question: Does this source IP have a pattern of legitimate administrative SMB activity?
    context: Regular administrative SMB connections help distinguish between authorized access and malicious lateral movement.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 445
        condition: selection
      fields:
        - dst_ip
        - connection_state
        - bytes_out

  # Type 3: Activity Context
  - question: What SMB session negotiation and authentication preceded this D$ share access?
    context: Understanding the SMB session establishment reveals whether this is part of legitimate administration or unauthorized access.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - connection_state
        - bytes_in
        - bytes_out
        - duration

  - question: What other administrative share access attempts occurred from this source around the same time?
    context: Multiple administrative share access attempts often indicate lateral movement or systematic network reconnaissance.
    range: -30m/+30m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "share access"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - smb.share

  # Type 4: Impact Assessment
  - question: What files or directories were accessed or modified through the D$ share connection?
    context: Successful D$ share access allows direct file system manipulation, indicating potential data access or system modification.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.mime_type

  - question: Are there signs of data exfiltration or file transfers following this D$ share access?
    context: Administrative share access is often used for data theft or malware deployment across network systems.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - connection_state

  # Type 5: Forensic Deep-Dive
  - question: What process activity on the target system corresponds to this D$ share access?
    context: SMB share access triggers specific system processes that reveal the nature and success of the access attempt.
    range: -15m/+15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: Are there any security log entries showing successful or failed authentication for administrative share access?
    context: Windows security logs provide detailed authentication context for SMB administrative share access attempts.
    range: -15m/+15m
    query: |
      aggregation: false
      logsource:
        category: authentication
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          logon.type|contains:
            - "3"
            - "network"
        condition: selection
      fields:
        - user.name
        - user.domain
        - logon.failure_reason

  # Type 6: Enterprise Correlation
  - question: Are other systems experiencing similar D$ or administrative share access attempts?
    context: Administrative share access is often part of broader lateral movement campaigns across enterprise networks.
    range: -1h/+1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "share access"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is there evidence of coordinated SMB-based lateral movement from this source across multiple systems?
    context: Multiple SMB connections to different systems indicate systematic network compromise and lateral movement activity.
    range: -2h/+2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains: "netbios"
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - alert.severity