# VALIDATION ERRORS:
# Sigma Query Errors:
#   - Question 9: Invalid logsource category 'authentication'. Valid categories: alert, network, firewall, proxy, webserver, process_creation, file_event, network_connection, dns, registry_event...
#
# ORIGINAL PLAYBOOK CONTENT:
name: GPL NETBIOS SMB-DS D$ Unicode Share Access
id: 22102469
description: |
  Detects Unicode-encoded access attempts to the administrative D$ share via SMB, indicating potential evasion techniques.
  Unicode encoding in SMB requests may be used to bypass basic string-based detection while accessing administrative shares.
  May trigger on legitimate administrative activities using Unicode-aware SMB clients or internationalized systems.
type: detection
detection_id: 2102469
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the Unicode-encoded SMB command structure and share path in this D$ access attempt?
    context: Understanding the Unicode encoding reveals potential evasion techniques and the sophistication of the access attempt.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - rule.name
        - smb.command
        - smb.share

  - question: What specific Unicode byte patterns and encoding were used in this SMB request?
    context: The Unicode encoding pattern reveals whether this is legitimate international support or deliberate obfuscation.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - smb.unicode
        - smb.flags
        - alert.signature

  # Type 2: Triage Assessment
  - question: Is this Unicode SMB access from a system known to use international character sets?
    context: Legitimate Unicode SMB usage is common in international environments or systems with non-English configurations.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 445
        condition: selection
      fields:
        - dst_ip
        - bytes_in
        - bytes_out
        - duration

  - question: Does this source consistently use Unicode encoding in SMB communications?
    context: Consistent Unicode usage indicates legitimate system configuration rather than evasion attempts.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "unicode"
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - alert.severity

  # Type 3: Activity Context
  - question: What SMB negotiation capabilities and flags were set during session establishment?
    context: SMB capability negotiation reveals whether Unicode support is part of normal protocol negotiation or deliberate manipulation.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - connection_state
        - bytes_in
        - bytes_out
        - duration

  - question: What other Unicode-encoded or obfuscated SMB activities occurred from this source?
    context: Multiple Unicode-encoded requests may indicate systematic evasion attempts or legitimate international system usage.
    range: -30m/+30m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "unicode"
            - "SMB"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - alert.severity

  # Type 4: Impact Assessment
  - question: Did the Unicode-encoded D$ share access result in successful file system access?
    context: Successful Unicode-based administrative share access indicates potential bypass of security controls.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.mime_type

  - question: Are there signs of data manipulation or exfiltration following this Unicode SMB access?
    context: Unicode encoding may be used to evade detection during data theft or malware deployment activities.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - connection_state

  # Type 5: Forensic Deep-Dive
  - question: What Windows authentication and access control events correspond to this Unicode SMB access?
    context: Security logs reveal whether Unicode encoding successfully bypassed authentication or authorization controls.
    range: -15m/+15m
    query: |
      aggregation: false
      logsource:
        category: authentication
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          logon.type: "3"
        condition: selection
      fields:
        - user.name
        - user.domain
        - logon.failure_reason

  - question: Are there any process execution events that indicate successful Unicode-based SMB exploitation?
    context: Successful administrative share access through Unicode encoding may trigger specific process execution patterns.
    range: -15m/+15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  # Type 6: Enterprise Correlation
  - question: Are other systems experiencing similar Unicode-encoded SMB administrative share access attempts?
    context: Unicode-based evasion techniques are often part of coordinated attacks across enterprise networks.
    range: -1h/+1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - "unicode"
            - "share access"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is there evidence of a broader campaign using Unicode encoding for SMB-based lateral movement?
    context: Coordinated use of Unicode encoding across multiple systems indicates sophisticated attack methodology.
    range: -2h/+2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "unicode"
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - alert.severity