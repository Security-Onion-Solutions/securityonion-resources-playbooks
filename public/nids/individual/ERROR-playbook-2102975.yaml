# VALIDATION ERRORS:
# YAML Syntax Errors:
#   - Invalid syntax at line 70, column 49: mapping values are not allowed here
#
# ORIGINAL PLAYBOOK CONTENT:
name: GPL NETBIOS SMB-DS D$ unicode andx share access
id: 22102975
description: |
  Detects attempts to access the D$ administrative share using Unicode encoding via SMB over port 445.
  D$ provides access to additional drives and is targeted for data discovery and lateral movement.
  Unicode encoding may indicate evasion attempts or specific exploitation frameworks.
type: detection
detection_id: 2102975
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the Unicode-encoded D$ share access request pattern?
    context: Understanding Unicode encoding structure reveals evasion techniques and potential tool signatures.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - payload_printable
        - alert.signature
        - packet_info.length

  - question: What SMB session context and authentication was established for D$ access?
    context: D$ access requires administrative privileges and reveals credential compromise methods.
    range: -10m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: "SMB"
          dst_port: 445
        condition: selection
      fields:
        - rule.name
        - alert.signature
        - timestamp

  # Type 2: Triage Assessment
  - question: Is this D$ access from a known data management or backup system?
    context: Legitimate D$ access typically originates from specific backup solutions or storage management tools.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 445
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - bytes_toclient

  - question: Does this system actually have a D: drive based on previous legitimate access?
    context: D$ access to non-existent drives may indicate automated scanning or reconnaissance tools.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - "D$"
            - "share"
        condition: selection
      fields:
        - src_ip
        - rule.name
        - timestamp

  # Type 3: Activity Context
  - question: What drive enumeration or share discovery preceded this D$ access?
    context: D$ access often follows systematic enumeration of all available administrative shares.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - "share"
            - "enumerate"
            - "C$"
        condition: selection
      fields:
        - rule.name
        - alert.signature
        - timestamp

  - question: What other administrative shares were accessed in this lateral movement sequence?
    context: Attackers typically access multiple shares to maximize data discovery and persistence options.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "ADMIN$"
            - "C$"
            - "D$"
            - "share"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - alert.severity

  # Type 4: Impact Assessment
  - question: Was the Unicode D$ access attempt successful based on connection patterns?
    context: Successful D$ access indicates potential exposure of additional data stores and applications.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - bytes_toclient
        - duration
        - conn_state

  - question: Are there signs of data discovery or file access through D$ share?
    context: D$ access often targets specific data repositories, databases, or application storage areas.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - "file"
            - "directory"
            - "database"
            - "data"
        condition: selection
      fields:
        - rule.name
        - alert.signature
        - alert.severity

  # Type 5: Forensic Deep-Dive
  - question: What specific data or applications reside on the D: drive being accessed?
    context: Understanding D: drive contents helps assess data exposure risk and attacker objectives.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - "SMB"
            - "file"
            - "read"
        condition: selection
      fields:
        - rule.name
        - payload_printable
        - alert.signature

  - question: Are there indicators of targeted data exfiltration or specific file searches?
    context: D$ access patterns reveal whether this is opportunistic scanning or targeted data theft.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.category|contains:
            - "policy-violation"
            - "data-loss"
            - "trojan-activity"
        condition: selection
      fields:
        - rule.name
        - src_ip
        - alert.signature

  # Type 6: Enterprise Correlation
  - question: Are other systems with D: drives being targeted by this source?
    context: Understanding campaign scope helps identify high-value data repositories under attack.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "D$"
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - alert.severity

  - question: Is this part of systematic administrative share enumeration across the enterprise?
    context: Coordinated share access indicates advanced persistent threat with comprehensive network mapping.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "share"
          dst_port: 445
        condition: selection
      fields:
        - dst_ip
        - rule.category
        - rule.name