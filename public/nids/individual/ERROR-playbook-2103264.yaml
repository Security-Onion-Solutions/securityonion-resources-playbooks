# VALIDATION ERRORS:
# Sigma Query Errors:
#   - Question 9: Invalid logsource category 'system'. Valid categories: alert, network, firewall, proxy, webserver, process_creation, file_event, network_connection, dns, registry_event...
#
# ORIGINAL PLAYBOOK CONTENT:
name: GPL NETBIOS SMB-DS IrotIsRunning Attempt (CVE-2002-1561)
id: 22103264
description: |
  Detects attempts to exploit CVE-2002-1561 through IrotIsRunning interface calls via SMB named pipes.
  This vulnerability in Microsoft's Distributed COM (DCOM) interface allows remote code execution through buffer overflow.
  May trigger on legitimate DCOM applications or distributed object management systems using IrotIsRunning calls.
type: detection
detection_id: 2103264
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact IrotIsRunning DCOM interface call structure and parameters?
    context: Understanding the DCOM call structure reveals exploitation intent and specific vulnerability targeting methods.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - rule.name
        - smb.command
        - dcom.interface

  - question: What named pipe path and DCOM endpoint were accessed in this IrotIsRunning attempt?
    context: The specific named pipe and DCOM endpoint reveal the target service and exploitation vector being used.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - smb.path
        - smb.share
        - dcom.endpoint

  # Type 2: Triage Assessment
  - question: Is this DCOM IrotIsRunning call from a known distributed application or management system?
    context: Legitimate distributed applications regularly use IrotIsRunning for object lifecycle management and monitoring.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 445
        condition: selection
      fields:
        - dst_ip
        - bytes_in
        - bytes_out
        - duration

  - question: Does this source IP have a history of legitimate DCOM or distributed object management activity?
    context: Regular DCOM usage patterns help distinguish between authorized distributed applications and exploitation attempts.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "DCOM"
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - alert.severity

  # Type 3: Activity Context
  - question: What DCOM session binding and authentication preceded this IrotIsRunning call?
    context: Understanding the DCOM session context reveals whether this is part of legitimate distributed computing or malicious exploitation.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - connection_state
        - bytes_in
        - bytes_out
        - duration

  - question: What other DCOM interface calls or SMB named pipe access occurred around the same time?
    context: Multiple DCOM calls often indicate systematic exploitation attempts or legitimate distributed application workflows.
    range: -30m/+30m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "DCOM"
            - "PIPE"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - alert.severity

  # Type 4: Impact Assessment
  - question: Did the target system respond with successful DCOM responses indicating potential compromise?
    context: Successful IrotIsRunning exploitation may result in specific DCOM response patterns or service behavior changes.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
          src_port: 445
        condition: selection
      fields:
        - bytes_in
        - bytes_out
        - connection_state
        - duration

  - question: Are there signs of DCOM service crashes or unusual process activity following this attempt?
    context: Buffer overflow exploitation often causes service instability or triggers defensive process execution.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  # Type 5: Forensic Deep-Dive
  - question: What Windows Event Log entries correspond to DCOM service activity during this timeframe?
    context: DCOM exploitation attempts generate specific Windows service and security log entries that reveal attack success.
    range: -15m/+15m
    query: |
      aggregation: false
      logsource:
        category: system
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          event.id|contains:
            - "10016"
            - "10028"
        condition: selection
      fields:
        - event.id
        - event.data
        - user.name

  - question: Are there any registry modifications or file system changes indicating successful DCOM exploitation?
    context: Successful buffer overflow through DCOM may result in system modifications for persistence or further exploitation.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.mime_type

  # Type 6: Enterprise Correlation
  - question: Are other systems experiencing similar IrotIsRunning or DCOM-based exploitation attempts?
    context: CVE-2002-1561 exploitation is often part of broader network scanning or worm-like propagation campaigns.
    range: -1h/+1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "IrotIsRunning"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is there evidence of coordinated DCOM vulnerability scanning across the enterprise network?
    context: Multiple DCOM-related alerts from the same source indicate systematic vulnerability assessment or attack campaign.
    range: -2h/+2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "DCOM"
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - alert.severity