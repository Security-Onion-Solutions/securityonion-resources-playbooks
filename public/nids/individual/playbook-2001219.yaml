name: ET SCAN Potential SSH Scan
id: 22001219
description: |
  Detects potential SSH brute force or scanning activity based on multiple connection attempts from single source.
  May trigger on legitimate SSH clients with connection issues or automated deployment tools.
type: detection
detection_id: 2001219
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What specific SSH connection attempts triggered this scanning alert?
    context: Understanding the connection pattern helps distinguish scanning from legitimate retry attempts.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - rule.name

  - question: How many SSH connection attempts were made and over what timeframe?
    context: Analyzing the frequency and timing pattern reveals scanning intensity and automation.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 22
          proto: tcp
        condition: selection
      fields:
        - dst_ip
        - conn_state
        - duration

  # Type 2: Triage Assessment
  - question: Is this source IP associated with legitimate SSH access for our organization?
    context: Determining if this is authorized remote access or potential threat activity.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 22
          conn_state: 'SF'
        condition: selection
      fields:
        - dst_ip
        - duration
        - service

  - question: Are there successful SSH connections from this source recently?
    context: Checking if this source has legitimate access or only failed connection attempts.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 22
          conn_state|contains:
            - 'SF'
            - 'S1'
        condition: selection
      fields:
        - dst_ip
        - conn_state
        - bytes_in
        - bytes_out

  # Type 3: Activity Context
  - question: What other ports or services has this source attempted to access?
    context: Understanding if this is targeted SSH scanning or broader network reconnaissance.
    range: +/-30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto
        - service
        - conn_state

  - question: What is the geographic origin and reputation of this scanning source?
    context: Assessing threat level based on source location and known malicious activity.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - geo.src_country
        - geo.src_city
        - geo.src_asn

  - question: Are multiple hosts being targeted by this SSH scanning activity?
    context: Determining the scope of the scanning campaign and potential targets.
    range: +/-30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 22
        condition: selection
      fields:
        - dst_ip
        - conn_state
        - flags

  # Type 4: Impact Assessment
  - question: Have any SSH brute force attempts been successful from this source?
    context: Determining if scanning has led to successful authentication or compromise.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 22
          duration|gt: 60
          bytes_in|gt: 1000
        condition: selection
      fields:
        - dst_ip
        - duration
        - bytes_in
        - bytes_out
        - conn_state

  - question: Are there signs of successful SSH sessions or command execution?
    context: Checking for post-authentication activity that indicates successful compromise.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          Image|contains:
            - 'ssh'
            - 'sshd'
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  # Type 5: Forensic Deep-Dive
  - question: What SSH authentication methods and usernames are being attempted?
    context: Understanding attack patterns and targeted accounts for defensive measures.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 22
        condition: selection
      fields:
        - dst_ip
        - conn_state
        - flags
        - duration

  - question: Are there patterns indicating automated scanning tools or manual attempts?
    context: Distinguishing between automated tools and human-driven attacks for threat assessment.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 22
        condition: selection
      fields:
        - duration
        - bytes_in
        - bytes_out
        - conn_state

  # Type 6: Enterprise Correlation
  - question: Are other external sources conducting SSH scanning against our infrastructure?
    context: Understanding the broader SSH attack landscape targeting the organization.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'SSH'
            - 'Scan'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: What other reconnaissance or scanning activities are occurring enterprise-wide?
    context: Determining if SSH scanning is part of broader reconnaissance campaign.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.category|contains:
            - 'attempted-recon'
            - 'scan'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - rule.category