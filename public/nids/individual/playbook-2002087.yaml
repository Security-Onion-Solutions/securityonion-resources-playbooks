name: ET INFO Inbound Frequent Emails - Possible Spambot Inbound
id: 22002087
description: |
  Detects external sources sending frequent emails to internal SMTP servers.
  This may indicate spambot activity, email bombing, or compromised external systems.
  Can trigger on legitimate bulk email services or high-volume business communications.
type: detection
detection_id: 2002087
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the specific SMTP command structure in these frequent inbound email attempts?
    context: Analyzing SMTP patterns reveals spam characteristics, malware signatures, or legitimate bulk email formats.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - app_proto
        - flow.pkts_toserver

  - question: What is the volume and rate of email connections from this external source?
    context: Understanding connection patterns helps distinguish between legitimate services and malicious activity.
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 25
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - flow.pkts_toserver

  # Type 2: Triage Assessment
  - question: Is this source a known legitimate email service provider or business partner?
    context: High-volume senders may include marketing services, notification systems, or partner organizations.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 25
            - 465
            - 587
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - conn_state

  - question: Are these emails being accepted or rejected by our SMTP server?
    context: Server response patterns help determine if this is successful spam delivery or blocked attempts.
    range: +15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
          src_port: 25
        condition: selection
      fields:
        - bytes_toclient
        - conn_state
        - duration

  # Type 3: Activity Context
  - question: What other network activity is this source conducting besides email delivery?
    context: Spambots often perform reconnaissance or attempt multiple service connections beyond SMTP.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - conn_state

  - question: Are there DNS queries or domain reputation issues associated with this email source?
    context: Malicious email sources often use suspicious domains or exhibit poor DNS hygiene.
    range: +/-30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          dns.resolved_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name

  - question: What is the geographic origin and infrastructure profile of this email source?
    context: Understanding sender infrastructure helps assess legitimacy and potential threat attribution.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - src_ip
        - geoip.country_name
        - geoip.asn
        - geoip.city_name

  # Type 4: Impact Assessment
  - question: How many internal email recipients are being targeted by this high-volume sender?
    context: Broad targeting indicates spam campaigns while specific targeting may suggest spear phishing.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 25
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - conn_state

  - question: Are there signs of successful email delivery leading to user interaction or compromise?
    context: Successful spam delivery may result in malware infections or credential theft attempts.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.category|contains:
            - 'MALWARE'
            - 'PHISHING'
            - 'TROJAN'
        condition: selection
      fields:
        - src_ip
        - rule.name
        - rule.category

  # Type 5: Forensic Deep-Dive
  - question: What spam or malware signatures match this email traffic pattern?
    context: Specific signatures help confirm malicious intent and guide appropriate response measures.
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - 'SPAM'
            - 'MALWARE'
            - 'PHISHING'
        condition: selection
      fields:
        - rule.name
        - rule.signature_id
        - rule.category

  - question: Are there known botnet or spam operation indicators associated with this source?
    context: Identifying botnet membership helps understand the scope and nature of the threat.
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'botnet'
            - 'spam'
            - 'C2'
        condition: selection
      fields:
        - rule.name
        - rule.signature_id

  # Type 6: Enterprise Correlation
  - question: Are multiple external sources conducting similar high-volume email campaigns against our infrastructure?
    context: Coordinated email campaigns indicate organized spam operations or targeted attacks.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.signature_id: 2002087
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - count

  - question: Is this email campaign part of broader targeting of our organization's communication systems?
    context: Email attacks often coincide with other communication channel targeting for comprehensive compromise.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.category|contains:
            - 'SPAM'
            - 'PHISHING'
            - 'MALWARE'
          dst_port|contains:
            - 25
            - 80
            - 443
            - 993
        condition: selection
      fields:
        - src_ip
        - dst_port
        - rule.name