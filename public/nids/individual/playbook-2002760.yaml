name: ET P2P GnucDNA UDP Ultrapeer Traffic
id: 22002760
description: |
  Detects GnucDNA P2P network ultrapeer communications via UDP.
  This indicates participation in Gnutella-based file sharing networks as a supernode or high-capacity peer.
  The threshold-based detection identifies persistent P2P activity over time.
type: detection
detection_id: 2002760
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the specific GnucDNA protocol pattern that triggered this ultrapeer detection?
    context: The exact protocol signature reveals the type of P2P role and network participation level.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - alert.signature
        - src_ip
        - dst_ip
        - src_port
        - dst_port

  - question: What P2P peers or nodes are being contacted in this GnucDNA network activity?
    context: Ultrapeer connections reveal the scope of P2P network participation and potential file sharing volume.
    range: -2h/+2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          proto: udp
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver
        - bytes_toclient
        - count

  # Type 2: Triage Assessment
  - question: Is P2P file sharing software authorized for operation on this network segment?
    context: Ultrapeer activity indicates advanced P2P participation, typically prohibited in corporate environments.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains:
            - 'P2P'
            - 'GnucDNA'
        condition: selection
      fields:
        - alert.signature
        - count

  - question: Does this system have legitimate reasons for high-volume UDP communications?
    context: Some business applications use UDP extensively, though the specific GnucDNA pattern is distinctive to P2P.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          proto: udp
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - count

  # Type 3: Activity Context
  - question: What other P2P applications or file sharing protocols are active on this system?
    context: Multiple P2P clients combined with ultrapeer activity suggests extensive file sharing operations.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains:
            - 'P2P'
            - 'BitTorrent'
            - 'Edonkey'
            - 'Kazaa'
        condition: selection
      fields:
        - alert.signature
        - count

  - question: What is the volume and frequency pattern of this GnucDNA ultrapeer activity?
    context: Ultrapeer nodes handle significant traffic volumes, indicating major bandwidth consumption and policy violations.
    range: -12h/+12h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains: 'GnucDNA'
        condition: selection
      fields:
        - dst_ip
        - count

  # Type 4: Impact Assessment
  - question: Is this ultrapeer P2P activity significantly impacting network bandwidth and performance?
    context: Ultrapeers handle routing for multiple P2P clients, potentially consuming massive bandwidth resources.
    range: -4h/+4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - proto
        - bytes_toserver
        - bytes_toclient

  - question: Are there signs of malware distribution through this P2P ultrapeer node?
    context: Ultrapeers often facilitate malware distribution by routing file requests across P2P networks.
    range: +6h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.mime_type|contains:
            - 'application/x-executable'
            - 'application/x-dosexec'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size

  # Type 5: Forensic Deep-Dive
  - question: What P2P client software is operating as a GnucDNA ultrapeer on this system?
    context: Identifying specific applications helps understand the sophistication and intent of P2P operations.
    range: -2h/+2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'limewire'
            - 'bearshare'
            - 'morpheus'
            - 'gnucleus'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ParentImage

  - question: What types of files are being shared or routed through this ultrapeer node?
    context: File types and sharing patterns help assess legal risks and copyright infringement potential.
    range: -6h/+6h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.mime_type
        - file.size

  # Type 6: Enterprise Correlation
  - question: How many systems across the organization are participating in GnucDNA or similar P2P networks?
    context: Multiple ultrapeer nodes indicate systematic P2P infrastructure requiring immediate organizational response.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains:
            - 'GnucDNA'
            - 'Ultrapeer'
        condition: selection
      fields:
        - src_ip
        - count

  - question: Are there coordinated P2P ultrapeer operations suggesting organized file sharing infrastructure?
    context: Multiple ultrapeers operating simultaneously may indicate deliberate P2P network establishment within the organization.
    range: -12h/+12h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: 'P2P'
        condition: selection
      fields:
        - src_ip
        - alert.signature
        - count