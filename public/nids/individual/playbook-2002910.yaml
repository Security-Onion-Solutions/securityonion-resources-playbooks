name: ET SCAN Potential VNC Scan 5800-5820
id: 22002910
description: |
  Detects potential VNC scanning activity targeting ports 5800-5820 based on multiple connection attempts.
  May trigger on legitimate VNC clients with connection issues or network troubleshooting activities.
type: detection
detection_id: 2002910
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What specific VNC port range and connection attempts triggered this scanning alert?
    context: Understanding the targeted ports helps identify VNC service discovery patterns and scanning scope.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - rule.name

  - question: How many VNC connection attempts were made within the detection timeframe?
    context: Analyzing connection frequency distinguishes scanning from legitimate VNC client retry attempts.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 5800
            - 5801
            - 5802
            - 5803
            - 5804
            - 5805
            - 5900
            - 5901
            - 5902
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - conn_state
        - flags

  # Type 2: Triage Assessment
  - question: Is this source IP authorized for VNC access to our systems?
    context: Determining if this represents legitimate remote desktop access or unauthorized scanning.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 5800
            - 5900
          conn_state: 'SF'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - duration
        - bytes_in
        - bytes_out

  - question: Are there established VNC services running on the targeted hosts?
    context: Verifying if targeted systems actually have VNC services that could be exploited.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 5800
            - 5801
            - 5900
            - 5901
        condition: selection
      fields:
        - src_ip
        - dst_port
        - conn_state
        - service

  # Type 3: Activity Context
  - question: What other services or ports has this source attempted to access?
    context: Understanding if this is targeted VNC scanning or part of broader network reconnaissance.
    range: +/-30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto
        - service
        - conn_state

  - question: What is the geographic origin and network reputation of this scanning source?
    context: Assessing threat level based on source location and known malicious activity patterns.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - geo.src_country
        - geo.src_city
        - geo.src_asn

  - question: Are multiple hosts being targeted by this VNC scanning campaign?
    context: Determining the scope and systematic nature of the scanning activity.
    range: +/-30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 5800
            - 5801
            - 5802
            - 5900
            - 5901
            - 5902
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - conn_state

  # Type 4: Impact Assessment
  - question: Have any VNC connection attempts been successful from this source?
    context: Determining if scanning has led to successful VNC authentication or access.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 5800
            - 5900
          duration|gt: 30
          bytes_in|gt: 500
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - duration
        - bytes_in
        - bytes_out
        - conn_state

  - question: Are there signs of active VNC sessions or screen sharing activity?
    context: Checking for post-connection activity indicating successful remote desktop access.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 5800
            - 5900
          duration|gt: 300
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - duration
        - bytes_in
        - bytes_out

  # Type 5: Forensic Deep-Dive
  - question: What VNC authentication methods are being attempted against our systems?
    context: Understanding attack patterns and security weaknesses in VNC configurations.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 5800
            - 5900
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - conn_state
        - duration
        - bytes_in

  - question: Are there patterns indicating automated scanning tools versus manual connection attempts?
    context: Distinguishing between automated reconnaissance and targeted manual attacks.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 5800
            - 5900
        condition: selection
      fields:
        - duration
        - bytes_in
        - bytes_out
        - conn_state
        - flags

  # Type 6: Enterprise Correlation
  - question: Are other external sources conducting VNC scanning against our infrastructure?
    context: Understanding the broader VNC attack landscape and coordinated scanning campaigns.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'VNC'
            - 'Scan'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: What other remote access scanning activities are occurring enterprise-wide?
    context: Determining if VNC scanning is part of broader remote access reconnaissance campaign.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'RDP'
            - 'SSH'
            - 'VNC'
            - 'Remote'
            - 'Scan'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - rule.category