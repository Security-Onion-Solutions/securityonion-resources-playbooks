name: ET MALWARE Banker.Delf Infection - Sending Initial Email to Owner
id: 22002976
description: |
  Detects Banker.Delf malware sending infection notification emails with system details.
  This banking trojan reports successful infections including Windows version and MAC address.
  Legitimate software should not send unsolicited emails with detailed system information.
type: detection
detection_id: 2002976
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What specific system details were included in the Banker.Delf notification email?
    context: Analyzing the email reveals what system information the banking trojan collected and reported.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - app_proto
        - flow.pkts_toserver

  - question: What was the complete email structure including recipient and sender information?
    context: Email headers reveal the malware's command infrastructure and operator communication methods.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - bytes_toserver
        - duration

  # Type 2: Triage Assessment
  - question: Is this system authorized to send automated system information via email?
    context: Legitimate system management tools may send similar data but through approved channels and formats.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 25
            - 465
            - 587
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - conn_state

  - question: Are there any documented system monitoring solutions that could generate similar email notifications?
    context: Distinguishing between legitimate system reporting and malware infection notifications.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'system'
            - 'monitor'
            - 'inventory'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  # Type 3: Activity Context
  - question: What process on this system generated the Banker.Delf infection notification?
    context: Identifying the malware process helps understand the infection mechanism and payload behavior.
    range: +/-15m
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ProcessGuid
        - User

  - question: What network activity or downloads preceded this banking trojan infection?
    context: Understanding the delivery vector helps identify the attack chain and potential additional compromises.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - 'MALWARE'
            - 'TROJAN'
            - 'DOWNLOAD'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.category

  - question: Were there file system changes associated with this Banker.Delf infection?
    context: Banking trojans typically create persistence files and may download additional components.
    range: +/-30m
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessGuid

  # Type 4: Impact Assessment
  - question: Did the banking trojan successfully establish persistence on the infected system?
    context: Successful persistence indicates ongoing compromise and potential for credential theft operations.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - 'Run'
            - 'RunOnce'
            - 'Services'
            - 'Winlogon'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessGuid

  - question: Are there indicators of banking credential harvesting or financial data theft following infection?
    context: Banker.Delf specifically targets banking credentials and financial information for fraud operations.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'banking'
            - 'credential'
            - 'keylog'
            - 'financial'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.category

  # Type 5: Forensic Deep-Dive
  - question: What specific Banker.Delf variant characteristics match this infection notification pattern?
    context: Different Banker.Delf variants have unique signatures that help identify the threat actor and capabilities.
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'Banker'
            - 'Delf'
            - 'banking'
        condition: selection
      fields:
        - rule.name
        - rule.signature_id
        - rule.rev

  - question: What command and control infrastructure is associated with this Banker.Delf infection?
    context: C2 communications reveal the threat actor's operational infrastructure and campaign scope.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - geoip.country_name
        - bytes_toserver

  # Type 6: Enterprise Correlation
  - question: Are other systems in our network showing signs of Banker.Delf infection or similar notification behavior?
    context: Banking trojans often spread through targeted email campaigns affecting multiple users.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.signature_id: 2002976
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - count

  - question: Is this banking trojan infection part of broader financial malware activity targeting our organization?
    context: Banking trojans often deploy alongside other financial malware for comprehensive credential theft.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.category: 'MALWARE'
          rule.name|contains:
            - 'banking'
            - 'trojan'
            - 'financial'
            - 'credential'
        condition: selection
      fields:
        - src_ip
        - rule.name
        - rule.category