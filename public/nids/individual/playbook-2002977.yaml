name: ET MALWARE Banload Downloader Infection - Sending initial email to owner
id: 22002977
description: |
  Detects Banload downloader malware sending infection notification emails to its operators.
  This Brazilian banking trojan reports successful infections with system details.
  Legitimate software should not send unsolicited emails with system information.
type: detection
detection_id: 2002977
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What specific system information was included in the Banload notification email?
    context: Analyzing the email content reveals what data the malware collected about the infected system.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - app_proto
        - flow.pkts_toserver

  - question: What was the complete email structure including headers and recipient information?
    context: Email headers reveal the malware's command and control infrastructure and operator details.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - bytes_toserver
        - flow.pkts_toserver

  # Type 2: Triage Assessment
  - question: Is this system authorized to send automated emails with system information?
    context: Legitimate system monitoring tools may send similar notifications but through proper channels.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 25
            - 465
            - 587
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - conn_state

  - question: Are there any scheduled system monitoring or reporting tools that could generate similar traffic?
    context: Distinguishing between legitimate system reporting and malware notification emails.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'monitoring'
            - 'report'
            - 'backup'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  # Type 3: Activity Context
  - question: What process executed on this system that initiated the malware notification email?
    context: Identifying the malware process helps understand the infection vector and payload characteristics.
    range: +/-15m
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ProcessGuid
        - User

  - question: What network connections or downloads preceded this Banload infection notification?
    context: Understanding the infection vector helps determine how the malware was delivered and installed.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - 'MALWARE'
            - 'TROJAN'
            - 'DOWNLOAD'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.category

  - question: Were there any file creation or modification events associated with this malware activity?
    context: Banload creates persistence mechanisms and may download additional payload components.
    range: +/-30m
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessGuid

  # Type 4: Impact Assessment
  - question: Did the malware successfully establish persistence mechanisms on the infected system?
    context: Successful persistence indicates ongoing compromise and potential for additional payload delivery.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - 'Run'
            - 'RunOnce'
            - 'Services'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessGuid

  - question: Are there signs of banking credential theft or financial data access following the infection?
    context: Banload specifically targets banking information and financial credentials.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'banking'
            - 'financial'
            - 'credential'
            - 'keylog'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.category

  # Type 5: Forensic Deep-Dive
  - question: What specific Banload variant or campaign does this infection notification match?
    context: Different Banload variants have distinct characteristics that help identify the threat actor and capabilities.
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'Banload'
            - 'banking'
            - 'trojan'
        condition: selection
      fields:
        - rule.name
        - rule.signature_id
        - rule.rev

  - question: What command and control infrastructure is this Banload infection communicating with?
    context: C2 infrastructure reveals the threat actor's operational security and campaign scope.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - geoip.country_name
        - bytes_toserver

  # Type 6: Enterprise Correlation
  - question: Are other systems in our network showing signs of Banload infection or similar notification emails?
    context: Banking trojans often spread through email campaigns targeting multiple users within organizations.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.signature_id: 2002977
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - count

  - question: Is this Banload infection part of broader banking trojan activity targeting our organization?
    context: Banking trojans often deploy in coordinated campaigns with multiple malware families.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.category: 'MALWARE'
          rule.name|contains:
            - 'banking'
            - 'trojan'
            - 'financial'
        condition: selection
      fields:
        - src_ip
        - rule.name
        - rule.category