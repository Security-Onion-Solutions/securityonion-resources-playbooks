name: ET MALWARE SC-KeyLog Keylogger Installed - Sending Initial Email Report
id: 22002979
description: |
  Detects SC-KeyLog keylogger sending initial installation notification email.
  Indicates confirmed malware installation and potential data theft initiation.
type: detection
detection_id: 2002979
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What is the exact keylogger installation email content detected?
    context: Analyzing the email content confirms SC-KeyLog installation and reveals configuration details.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - packet_info.length

  - question: What email server is the keylogger using for exfiltration?
    context: Identifying the SMTP server reveals the attacker's email infrastructure.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 25
        condition: selection
      fields:
        - dst_ip
        - dst_country
        - dst_asn
        - bytes_toserver

  - question: What process installed and is running the SC-KeyLog malware?
    context: Identifying the malware process enables immediate containment and removal.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'keylog'
            - 'sc-keylog'
            - 'keylogger'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ProcessGuid
        - User

  - question: What files has the keylogger created on the system?
    context: File analysis reveals keylogger installation location and log storage paths.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - 'keylog'
            - '.log'
            - 'sc-keylog'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size
        - EventType

  - question: How did the keylogger initially compromise this system?
    context: Understanding the infection vector prevents future similar compromises.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid

  - question: What sensitive data has the keylogger already captured?
    context: Assessing data exposure helps determine breach impact and notification requirements.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - '.log'
            - 'capture'
            - 'keys'
        condition: selection
      fields:
        - TargetFilename
        - file.size
        - EventType
        - file.hash.md5

  - question: What email address is receiving the keylogger reports?
    context: Identifying the attacker's email helps with threat intelligence and law enforcement.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 25
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - bytes_toclient
        - duration

  - question: What registry modifications did the keylogger make for persistence?
    context: Registry changes reveal persistence mechanisms that must be removed.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - 'Run'
            - 'RunOnce'
            - 'keylog'
        condition: selection
      fields:
        - TargetObject
        - Details
        - EventType

  - question: What user account is the keylogger running under?
    context: User context determines privilege level and potential access to sensitive data.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains: 'keylog'
        condition: selection
      fields:
        - User
        - Image
        - ProcessGuid
        - IntegrityLevel

  - question: Are other systems in the network infected with SC-KeyLog?
    context: Multiple infections indicate coordinated attack or worm-like propagation.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_port: 25
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - connection_count