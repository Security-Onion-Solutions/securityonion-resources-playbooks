name: ET SCAN Rapid POP3 Connections - Possible Brute Force Attack
id: 22002992
description: |
  Detects rapid POP3 connection attempts from external sources, indicating possible brute force attacks.
  May trigger on legitimate email clients with aggressive retry behavior or automated email processing.
type: detection
detection_id: 2002992
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What is the exact connection pattern and frequency from the source IP?
    context: Understanding connection timing helps distinguish between legitimate retries and brute force attempts.
    range: -15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 110
        condition: selection
      fields:
        - dst_ip
        - connection_state
        - duration
        - orig_bytes
        - resp_bytes

  - question: What specific TCP flags were observed in these connection attempts?
    context: SYN flood patterns versus legitimate connection attempts show different flag combinations.
    range: -10m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_port
        - dst_port
        - rule.name

  # Type 2: Triage Assessment
  - question: Is this source IP a known legitimate email client or server?
    context: Corporate email servers or mobile devices may create rapid connection patterns during synchronization.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 25
            - 110
            - 143
            - 993
            - 995
        condition: selection
      fields:
        - dst_port
        - connection_state
        - service

  - question: Are there successful POP3 authentications from this source?
    context: Successful logins indicate legitimate use versus failed attempts suggesting brute force.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 110
          connection_state: SF
        condition: selection
      fields:
        - dst_ip
        - orig_bytes
        - resp_bytes
        - duration

  # Type 3: Activity Context
  - question: What other scanning activity preceded these POP3 connections?
    context: Port scanning often precedes targeted brute force attacks on discovered services.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_port
        - connection_state
        - service
        - dst_ip

  - question: Are multiple email services being targeted simultaneously?
    context: Attackers often target multiple email protocols to maximize attack surface.
    range: -15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 25
            - 110
            - 143
            - 993
            - 995
        condition: selection
      fields:
        - dst_port
        - dst_ip
        - connection_state

  # Type 4: Impact Assessment
  - question: How many unique POP3 servers are being targeted?
    context: Multiple targets indicate broader attack campaign versus focused credential stuffing.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 110
        condition: selection
      fields:
        - dst_ip
        - connection_state

  - question: Are there any successful connections with data transfer?
    context: Data transfer after connection suggests successful authentication and potential compromise.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 110
          connection_state: SF
        condition: selection
      fields:
        - dst_ip
        - orig_bytes
        - resp_bytes
        - duration

  # Type 5: Forensic Deep-Dive
  - question: What is the geographic origin and reputation of the source IP?
    context: Malicious IPs often originate from specific regions or known bad actor infrastructure.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_port
        - service
        - connection_state

  - question: What user agents or client signatures are associated with these connections?
    context: Automated tools leave different fingerprints than legitimate email clients.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 110
        condition: selection
      fields:
        - orig_bytes
        - resp_bytes
        - duration
        - connection_state

  # Type 6: Enterprise Correlation
  - question: Are other external IPs showing similar POP3 brute force patterns?
    context: Coordinated attacks often involve multiple source IPs targeting the same services.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "POP3 Connections"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name