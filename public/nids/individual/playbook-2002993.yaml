name: ET SCAN Rapid POP3S Connections - Possible Brute Force Attack
id: 22002993
description: |
  Detects rapid POP3S (secure POP3) connection attempts from external sources, indicating possible brute force attacks.
  May trigger on legitimate email clients with aggressive retry behavior or automated email processing over SSL.
type: detection
detection_id: 2002993
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What is the exact SSL/TLS handshake pattern in these rapid connections?
    context: SSL handshake failures versus successful negotiations reveal brute force versus legitimate client behavior.
    range: -15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 995
        condition: selection
      fields:
        - tls.server.certificate.subject
        - tls.version
        - tls.handshake_completed

  - question: What specific TCP connection states are observed for port 995?
    context: Connection state patterns help distinguish between scanning and legitimate email access attempts.
    range: -10m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_port
        - dst_port
        - rule.name

  # Type 2: Triage Assessment
  - question: Is this source IP a known legitimate email client or mobile device?
    context: Corporate email systems and mobile devices often create burst connection patterns during sync.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 465
            - 587
            - 993
            - 995
        condition: selection
      fields:
        - dst_port
        - connection_state
        - service

  - question: Are there successful SSL negotiations and data transfers from this source?
    context: Successful SSL sessions with data transfer indicate legitimate use versus failed brute force attempts.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 995
          connection_state: SF
        condition: selection
      fields:
        - dst_ip
        - orig_bytes
        - resp_bytes
        - duration

  # Type 3: Activity Context
  - question: What other secure email services are being targeted concurrently?
    context: Attackers often probe multiple secure email ports to find vulnerable services.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 465
            - 587
            - 993
            - 995
        condition: selection
      fields:
        - dst_port
        - connection_state
        - service
        - dst_ip

  - question: Was there reconnaissance activity before these POP3S attempts?
    context: Port scanning or service enumeration often precedes targeted brute force attacks.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_port
        - connection_state
        - service
        - dst_ip

  # Type 4: Impact Assessment
  - question: How many unique POP3S servers are being targeted?
    context: Multiple targets suggest a broader campaign versus focused credential attacks.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 995
        condition: selection
      fields:
        - dst_ip
        - connection_state

  - question: Are there any successful POP3S sessions with significant data transfer?
    context: Large data transfers after successful connection indicate potential email access or exfiltration.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 995
          connection_state: SF
        condition: selection
      fields:
        - dst_ip
        - orig_bytes
        - resp_bytes
        - duration

  # Type 5: Forensic Deep-Dive
  - question: What SSL certificate details are being accessed during these connections?
    context: Certificate information reveals which email servers are being targeted and potential SSL bypass attempts.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 995
        condition: selection
      fields:
        - tls.server.certificate.subject
        - tls.server.certificate.issuer
        - tls.version
        - tls.handshake_completed

  - question: What timing patterns distinguish this from legitimate email client behavior?
    context: Legitimate clients have predictable retry intervals while brute force tools show rapid, consistent timing.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 995
        condition: selection
      fields:
        - connection_state
        - duration
        - orig_bytes
        - resp_bytes

  # Type 6: Enterprise Correlation
  - question: Are other external sources showing similar POP3S brute force patterns?
    context: Coordinated attacks often involve multiple IPs targeting the same secure email infrastructure.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "POP3S Connections"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name