name: ET SCAN Rapid IMAP Connections - Possible Brute Force Attack
id: 22002994
description: |
  Detects rapid IMAP connection attempts from external sources, indicating possible brute force attacks.
  May trigger on legitimate email clients with aggressive synchronization or automated email processing systems.
type: detection
detection_id: 2002994
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What is the exact connection frequency and pattern for IMAP attempts?
    context: IMAP brute force shows distinct timing patterns compared to legitimate client synchronization.
    range: -15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 143
        condition: selection
      fields:
        - dst_ip
        - connection_state
        - duration
        - orig_bytes
        - resp_bytes

  - question: What specific TCP flags and connection states are observed?
    context: Understanding connection establishment patterns helps distinguish scanning from legitimate IMAP access.
    range: -10m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_port
        - dst_port
        - rule.name

  # Type 2: Triage Assessment
  - question: Is this source IP associated with known email infrastructure?
    context: Corporate email servers, mobile devices, or webmail systems may generate rapid IMAP connections.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 25
            - 110
            - 143
            - 993
            - 995
        condition: selection
      fields:
        - dst_port
        - connection_state
        - service

  - question: Are there successful IMAP sessions with normal data exchange patterns?
    context: Legitimate IMAP clients establish longer sessions with bidirectional data flow for email synchronization.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 143
          connection_state: SF
        condition: selection
      fields:
        - dst_ip
        - orig_bytes
        - resp_bytes
        - duration

  # Type 3: Activity Context
  - question: What reconnaissance or scanning activity preceded these IMAP attempts?
    context: Port scanning often precedes targeted attacks on discovered email services.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_port
        - connection_state
        - service
        - dst_ip

  - question: Are multiple email protocols being targeted simultaneously?
    context: Attackers often probe various email services to maximize attack opportunities.
    range: -15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 25
            - 110
            - 143
            - 993
            - 995
        condition: selection
      fields:
        - dst_port
        - dst_ip
        - connection_state

  - question: What timing correlation exists with other suspicious network activity?
    context: Coordinated attacks often show temporal correlation between different attack vectors.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - dst_port

  # Type 4: Impact Assessment
  - question: How many unique IMAP servers are being targeted?
    context: Multiple targets indicate broader attack campaign versus focused credential stuffing.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 143
        condition: selection
      fields:
        - dst_ip
        - connection_state

  - question: Are there any successful IMAP sessions with significant data retrieval?
    context: Large inbound data transfers suggest successful email access and potential data exfiltration.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 143
          connection_state: SF
        condition: selection
      fields:
        - dst_ip
        - orig_bytes
        - resp_bytes
        - duration

  # Type 5: Forensic Deep-Dive
  - question: What IMAP client behavior patterns can be identified from connection metadata?
    context: Legitimate IMAP clients show distinct connection duration and data transfer patterns compared to brute force tools.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 143
        condition: selection
      fields:
        - connection_state
        - duration
        - orig_bytes
        - resp_bytes

  - question: What geographic and infrastructure context exists for the source IP?
    context: Malicious sources often originate from specific regions or compromised infrastructure.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_port
        - service
        - connection_state

  # Type 6: Enterprise Correlation
  - question: Are other external sources showing similar IMAP brute force patterns?
    context: Distributed attacks often coordinate multiple source IPs against the same email infrastructure.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "IMAP Connections"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name