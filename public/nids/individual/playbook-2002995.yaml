name: ET SCAN Rapid IMAPS Connections - Possible Brute Force Attack
id: 22002995
description: |
  Detects rapid IMAPS (secure IMAP) connection attempts from external sources, indicating possible brute force attacks.
  May trigger on legitimate email clients with aggressive retry behavior or automated systems using secure IMAP over SSL/TLS.
type: detection
detection_id: 2002995
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What SSL/TLS handshake patterns are observed in these rapid IMAPS connections?
    context: SSL handshake success rates and certificate details reveal legitimate clients versus brute force tools.
    range: -15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 993
        condition: selection
      fields:
        - tls.server.certificate.subject
        - tls.version
        - tls.handshake_completed

  - question: What specific connection establishment patterns are detected for port 993?
    context: IMAPS connection states and timing help distinguish between scanning and legitimate secure email access.
    range: -10m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_port
        - dst_port
        - rule.name

  # Type 2: Triage Assessment
  - question: Is this source IP associated with legitimate secure email infrastructure?
    context: Corporate email systems, mobile apps, and webmail services often create burst IMAPS connections during synchronization.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 465
            - 587
            - 993
            - 995
        condition: selection
      fields:
        - dst_port
        - connection_state
        - service

  - question: Are there successful IMAPS sessions with normal secure email traffic patterns?
    context: Legitimate IMAPS clients maintain longer SSL sessions with substantial bidirectional data flow.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 993
          connection_state: SF
        condition: selection
      fields:
        - dst_ip
        - orig_bytes
        - resp_bytes
        - duration

  # Type 3: Activity Context
  - question: What other secure email services are being targeted concurrently?
    context: Attackers often probe multiple secure email ports systematically to find vulnerable services.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 465
            - 587
            - 993
            - 995
        condition: selection
      fields:
        - dst_port
        - connection_state
        - service
        - dst_ip

  - question: Was there port scanning or service enumeration before these IMAPS attempts?
    context: Reconnaissance activity often precedes targeted brute force attacks on discovered secure services.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_port
        - connection_state
        - service
        - dst_ip

  - question: What temporal correlation exists with other attack indicators?
    context: Coordinated attacks show timing patterns across different attack vectors and services.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - dst_port

  # Type 4: Impact Assessment
  - question: How many unique IMAPS servers are being targeted in this campaign?
    context: Multiple targets suggest broader attack scope versus focused credential attacks on specific servers.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 993
        condition: selection
      fields:
        - dst_ip
        - connection_state

  - question: Are there any successful IMAPS sessions with significant encrypted data transfer?
    context: Large encrypted data transfers after successful SSL negotiation indicate potential email access or exfiltration.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 993
          connection_state: SF
        condition: selection
      fields:
        - dst_ip
        - orig_bytes
        - resp_bytes
        - duration

  # Type 5: Forensic Deep-Dive
  - question: What SSL certificate and encryption details are being accessed?
    context: Certificate information reveals targeted email infrastructure and potential SSL bypass or downgrade attempts.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 993
        condition: selection
      fields:
        - tls.server.certificate.subject
        - tls.server.certificate.issuer
        - tls.version
        - tls.handshake_completed

  - question: What connection timing and behavior patterns distinguish this from legitimate IMAPS clients?
    context: Legitimate secure email clients have predictable retry intervals and session durations compared to brute force tools.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 993
        condition: selection
      fields:
        - connection_state
        - duration
        - orig_bytes
        - resp_bytes

  # Type 6: Enterprise Correlation
  - question: Are other external sources showing coordinated IMAPS brute force activity?
    context: Distributed attacks often involve multiple source IPs targeting the same secure email infrastructure simultaneously.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "IMAPS Connections"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name