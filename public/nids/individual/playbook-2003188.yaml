name: ET MALWARE Win32.Lager Trojan Reporting
id: 22003188
description: |
  Detects ongoing reporting communication from Win32.Lager trojan infections to command and control servers.
  May trigger on legitimate applications using similar URI patterns or parameter structures.
type: detection
detection_id: 2003188
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What information is being reported in the Lager trojan communication?
    context: Analyzing the v, b, and name parameters reveals what data the trojan is transmitting to the C2 server.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.full
        - url.query
        - http.request.method

  - question: How does this reporting differ from the initial checkin pattern?
    context: Comparing reporting vs checkin patterns helps understand the trojan's operational phases.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains: '/cp/rule.php'
        condition: selection
      fields:
        - url.query
        - http.request.headers
        - user_agent.original

  # Type 2: Triage Assessment
  - question: How frequently is this infected system reporting to the C2 server?
    context: Understanding reporting frequency helps assess the trojan's operational status and persistence.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains: '/cp/rule.php'
          url.query|contains: 'v='
        condition: selection
      fields:
        - dst_ip
        - url.query
        - user_agent.original

  - question: Is this system showing other concurrent malware activity?
    context: Multiple malware infections may indicate a compromised system requiring comprehensive remediation.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: 'MALWARE'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - alert.severity

  # Type 3: Activity Context
  - question: What triggered this specific reporting event?
    context: Understanding what causes reporting helps identify the trojan's operational triggers and conditions.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains: 'http'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid

  - question: What system activities occurred before this reporting event?
    context: Pre-reporting activities may reveal what information the trojan is collecting and transmitting.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - Image

  - question: What commands or instructions did the C2 server provide in response?
    context: Analyzing C2 responses reveals the trojan's next actions and operational directives.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - http.response.body.content
        - http.response.status_code
        - http.response.headers

  # Type 4: Impact Assessment
  - question: Has the trojan executed any commands following this reporting event?
    context: Post-reporting activities reveal the operational impact and potential damage from the infection.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid

  - question: Are there signs of data collection or exfiltration following the reporting?
    context: Trojans may collect and transmit sensitive data after receiving C2 instructions.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method: POST
          http.request.body.content|contains:
            - 'data'
            - 'file'
            - 'content'
        condition: selection
      fields:
        - url.full
        - http.request.body.content
        - dst_ip

  # Type 5: Forensic Deep-Dive
  - question: What specific data is being reported in the version parameter?
    context: The version parameter may contain system information, infection status, or operational data.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.query|contains:
            - 'v='
            - '&b='
            - 'name='
        condition: selection
      fields:
        - dst_ip
        - url.query
        - user_agent.original

  - question: How has the trojan's behavior evolved since initial infection?
    context: Comparing initial and ongoing communications reveals the trojan's operational evolution.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains: '/cp/rule.php'
        condition: selection
      fields:
        - url.query
        - dst_ip
        - user_agent.original

  # Type 6: Enterprise Correlation
  - question: Are other systems showing similar Lager trojan reporting patterns?
    context: Multiple infected systems may indicate a coordinated attack or lateral movement within the network.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'Lager Trojan'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name