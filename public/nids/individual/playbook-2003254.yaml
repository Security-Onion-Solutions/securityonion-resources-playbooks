name: ET INFO SOCKSv5 Port 25 Inbound Request (Windows Source)
id: 22003254
description: |
  Detects SOCKSv5 proxy requests targeting port 25 (SMTP) from Windows systems.
  May indicate legitimate email proxy usage or potential spam/malware communication using newer SOCKS protocol.
type: detection
detection_id: 2003254
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete SOCKSv5 request structure for port 25?
    context: SOCKSv5 requests contain authentication and connection details that reveal proxy configuration.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - packet_info.length

  - question: What authentication method was used in this SOCKSv5 request?
    context: SOCKSv5 supports various authentication methods that may indicate the proxy's security configuration.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - src_ip
        - src_port
        - flow_id

  # Type 2: Triage Assessment
  - question: Is this Windows system configured to use SOCKSv5 proxies for email?
    context: Legitimate email clients may be configured to use SOCKSv5 proxies for SMTP connections.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port:
            - 25
            - 587
            - 465
            - 1080
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection_state
        - bytes_toserver

  - question: Does this SOCKSv5 usage pattern match legitimate email client behavior?
    context: Normal email clients have predictable connection patterns and timing.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 25
        condition: selection
      fields:
        - dst_ip
        - connection_state
        - bytes_toserver
        - duration

  # Type 3: Activity Context
  - question: What processes initiated network connections around this SOCKSv5 request?
    context: Identifying the originating process helps distinguish between legitimate email clients and malware.
    range: +/-30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid
        - ParentImage

  - question: Were there concurrent SOCKSv5 requests from this Windows system?
    context: Multiple simultaneous proxy requests may indicate automated tools or malware activity.
    range: +/-15m
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains: 'SOCKSv5'
        condition: selection
      fields:
        - alert.signature
        - dst_ip
        - dst_port
        - alert.severity

  # Type 4: Impact Assessment
  - question: Was the SMTP connection successfully negotiated through SOCKSv5?
    context: Successful proxy negotiation indicates potential email transmission capability.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - connection_state
        - bytes_toserver
        - bytes_toclient
        - duration

  - question: What volume of email traffic occurred after this proxy request?
    context: Large SMTP data transfers following proxy setup may indicate bulk email sending.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 25
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - connection_state
        - duration

  # Type 5: Forensic Deep-Dive
  - question: Are there signs of advanced email tools or malware using SOCKSv5?
    context: Sophisticated malware often uses SOCKSv5 for its advanced features and authentication.
    range: +/-2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'proxifier'
            - 'sockscap'
            - 'proxychains'
            - 'tor'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - User
        - ProcessGuid

  - question: What registry modifications occurred related to proxy or email configuration?
    context: Malware often modifies registry settings to configure proxy usage or email clients.
    range: +/-1h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - 'ProxyServer'
            - 'ProxyEnable'
            - 'SMTP'
            - 'Mail'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessGuid

  # Type 6: Enterprise Correlation
  - question: Are other Windows systems exhibiting similar SOCKSv5 SMTP behavior?
    context: Multiple systems using SOCKSv5 for SMTP may indicate a coordinated campaign or malware family.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains:
            - 'SOCKSv5 Port 25'
            - 'Windows Source'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature
        - alert.severity