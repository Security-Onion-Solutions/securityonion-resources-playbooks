name: ET INFO SOCKSv5 Port 25 Inbound Request (Linux Source)
id: 22003255
description: |
  Detects SOCKSv5 proxy requests targeting port 25 (SMTP) from Linux systems.
  May indicate legitimate mail server proxy usage or potential spam/malware communication.
type: detection
detection_id: 2003255
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete SOCKSv5 request payload targeting port 25?
    context: SOCKSv5 protocol details reveal authentication methods and target server information.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - packet_info.length

  - question: What SMTP server was targeted through this SOCKSv5 proxy?
    context: The destination IP and port reveal which mail server was being accessed through the proxy.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - src_ip
        - src_port
        - flow_id

  # Type 2: Triage Assessment
  - question: Is this Linux system a legitimate mail server or relay?
    context: Mail servers commonly use proxies for outbound SMTP connections to avoid IP reputation issues.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port:
            - 25
            - 587
            - 465
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection_state
        - bytes_toserver

  - question: Does this SOCKSv5 activity align with normal mail server operations?
    context: Legitimate mail servers have predictable patterns of SMTP connections and timing.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 25
        condition: selection
      fields:
        - dst_ip
        - connection_state
        - bytes_toserver
        - duration

  # Type 3: Activity Context
  - question: What mail-related processes were running on this Linux system?
    context: Identifying mail transfer agents or spam tools helps determine the nature of the activity.
    range: +/-30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'sendmail'
            - 'postfix'
            - 'exim'
            - 'qmail'
            - 'smtp'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: Were there multiple SOCKSv5 requests from this Linux source?
    context: Bulk SOCKS requests may indicate spam campaigns or automated mail sending tools.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains: 'SOCKSv5'
        condition: selection
      fields:
        - alert.signature
        - dst_ip
        - dst_port
        - alert.severity

  # Type 4: Impact Assessment
  - question: Was the SMTP connection successfully established through SOCKSv5?
    context: Successful proxy connections indicate potential email transmission capability.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - connection_state
        - bytes_toserver
        - bytes_toclient
        - duration

  - question: What volume of email traffic was generated after this proxy request?
    context: Large SMTP data volumes may indicate bulk email sending or spam campaigns.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 25
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - connection_state
        - duration

  # Type 5: Forensic Deep-Dive
  - question: Are there indicators of spam tools or compromised mail servers?
    context: Compromised Linux systems often run spam tools that use SOCKS proxies to hide their activity.
    range: +/-2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'bulk'
            - 'mass'
            - 'spam'
            - 'proxychains'
            - 'tor'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - User

  - question: What configuration files were accessed during this SMTP proxy activity?
    context: Mail configuration files may reveal proxy settings or spam tool configurations.
    range: +/-30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - '/etc/postfix'
            - '/etc/exim'
            - '/etc/sendmail'
            - 'main.cf'
            - 'master.cf'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessGuid

  # Type 6: Enterprise Correlation
  - question: Are other Linux systems showing similar SOCKSv5 SMTP patterns?
    context: Multiple Linux systems using SMTP proxies may indicate a botnet or coordinated spam operation.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains:
            - 'SOCKSv5 Port 25'
            - 'Linux Source'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature
        - alert.severity