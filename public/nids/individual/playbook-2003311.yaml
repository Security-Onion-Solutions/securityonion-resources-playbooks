name: ET P2P Edonkey Publicize File ACK
id: 22003311
description: |
  Detects eDonkey/eMule P2P network file advertisement acknowledgment packets.
  This indicates active participation in P2P file sharing, potentially involving copyrighted content.
  The specific UDP pattern identifies eDonkey protocol responses to file publication requests.
type: detection
detection_id: 2003311
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact eDonkey protocol acknowledgment packet that triggered this detection?
    context: The specific byte pattern reveals the type of P2P activity and confirms legitimate eDonkey traffic versus protocol spoofing.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - alert.signature
        - src_ip
        - dst_ip
        - src_port
        - dst_port

  - question: What eDonkey servers or peers are involved in this file sharing activity?
    context: Identifying P2P servers and peer connections helps understand the scope of file sharing network participation.
    range: -1h/+1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
          proto: udp
        condition: selection
      fields:
        - src_port
        - dst_port
        - bytes_toserver
        - bytes_toclient
        - count

  # Type 2: Triage Assessment
  - question: Is eDonkey or P2P file sharing software authorized on this network?
    context: Most organizations prohibit P2P applications due to legal liability, security risks, and bandwidth consumption.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          alert.signature|contains:
            - 'Edonkey'
            - 'P2P'
        condition: selection
      fields:
        - alert.signature
        - src_ip
        - count

  - question: Does this P2P activity occur during permitted personal use hours?
    context: Some organizations may allow limited personal internet use during specific time periods.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          proto: udp
        condition: selection
      fields:
        - src_ip
        - src_port
        - dst_port
        - count

  # Type 3: Activity Context
  - question: What other P2P file sharing applications are being used from this system?
    context: Multiple P2P clients indicate extensive file sharing activity with increased legal and security exposure.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          alert.signature|contains:
            - 'P2P'
            - 'BitTorrent'
            - 'Kazaa'
            - 'Ares'
        condition: selection
      fields:
        - alert.signature
        - src_ip
        - count

  - question: What is the frequency and pattern of eDonkey file advertisement activity?
    context: High frequency file advertisements suggest active sharing of multiple files, increasing policy violation severity.
    range: -6h/+6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          alert.signature|contains: 'Edonkey'
        condition: selection
      fields:
        - src_ip
        - alert.signature
        - count

  # Type 4: Impact Assessment
  - question: Is this P2P activity impacting network performance for business applications?
    context: P2P file sharing can consume significant bandwidth and affect critical business operations.
    range: -2h/+2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - proto
        - bytes_toserver
        - bytes_toclient

  - question: Are there signs of malware or unwanted software associated with this P2P activity?
    context: P2P networks are common distribution channels for malware disguised as legitimate files.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          file.mime_type|contains:
            - 'application/x-executable'
            - 'application/x-dosexec'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size

  # Type 5: Forensic Deep-Dive
  - question: What eDonkey client software and user accounts are associated with this file sharing?
    context: Identifying specific users and applications helps with policy enforcement and security assessment.
    range: -2h/+2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - 'emule'
            - 'edonkey'
            - 'amule'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ParentImage

  - question: What specific files are being advertised or shared through the eDonkey network?
    context: File types and names help assess legal risks associated with potential copyright infringement.
    range: -4h/+4h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.mime_type
        - file.size

  # Type 6: Enterprise Correlation
  - question: How many systems across the organization are participating in eDonkey file sharing?
    context: Widespread P2P usage indicates systematic policy violations requiring organizational response.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: 'Edonkey'
        condition: selection
      fields:
        - dst_ip
        - src_ip
        - count

  - question: Are there coordinated P2P file sharing activities across multiple users or departments?
    context: Organized file sharing within the organization may indicate need for policy education and enforcement measures.
    range: -12h/+12h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: 'P2P'
        condition: selection
      fields:
        - dst_ip
        - alert.signature
        - count