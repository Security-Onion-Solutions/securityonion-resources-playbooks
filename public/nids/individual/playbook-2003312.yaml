name: ET P2P Edonkey Connect Request
id: 22003312
description: |
  Detects eDonkey/eMule P2P network connection initiation requests.
  This indicates attempts to join P2P file sharing networks, potentially for copyrighted content distribution.
  The specific UDP pattern identifies outbound eDonkey protocol connection attempts.
type: detection
detection_id: 2003312
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact eDonkey connection request packet that triggered this detection?
    context: The specific byte pattern confirms legitimate eDonkey protocol usage and reveals connection parameters.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - alert.signature
        - src_ip
        - dst_ip
        - src_port
        - dst_port

  - question: What eDonkey servers or peers are being contacted for P2P connections?
    context: Identifying target servers helps understand the P2P network topology and potential content sources.
    range: -1h/+1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          proto: udp
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver
        - bytes_toclient
        - count

  # Type 2: Triage Assessment
  - question: Is eDonkey or other P2P software authorized for use on this system?
    context: Most corporate policies prohibit P2P applications due to legal, security, and performance concerns.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains:
            - 'Edonkey'
            - 'P2P'
        condition: selection
      fields:
        - alert.signature
        - count

  - question: Does this P2P connection attempt occur during authorized personal internet use time?
    context: Some organizations permit limited personal use during breaks or after hours, affecting violation assessment.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          proto: udp
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - count

  # Type 3: Activity Context
  - question: What other P2P applications or file sharing services are being used from this system?
    context: Multiple P2P clients suggest extensive file sharing activity with compounded legal and security risks.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains:
            - 'P2P'
            - 'BitTorrent'
            - 'Kazaa'
            - 'Ares'
        condition: selection
      fields:
        - alert.signature
        - count

  - question: What is the frequency and success rate of eDonkey connection attempts?
    context: Repeated connection attempts may indicate persistent P2P usage or connectivity issues with file sharing networks.
    range: -6h/+6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains: 'Edonkey'
        condition: selection
      fields:
        - dst_ip
        - alert.signature
        - count

  # Type 4: Impact Assessment
  - question: Is this P2P activity consuming network bandwidth during business-critical hours?
    context: P2P connections can impact business applications through bandwidth consumption and network congestion.
    range: -2h/+2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - proto
        - bytes_toserver
        - bytes_toclient

  - question: Are there successful P2P connections following these connection attempts?
    context: Successful connections indicate active file sharing participation requiring immediate policy enforcement.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          proto: udp
          bytes_toserver: '>1000'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver
        - bytes_toclient
        - duration

  # Type 5: Forensic Deep-Dive
  - question: What eDonkey client processes and user accounts initiated these connection attempts?
    context: Identifying specific users and applications helps with accountability and policy enforcement measures.
    range: -1h/+1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'emule'
            - 'edonkey'
            - 'amule'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ParentImage

  - question: What files or content are being accessed through successful eDonkey connections?
    context: File types and transfer patterns help assess legal risks and policy violation severity.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.mime_type
        - file.size

  # Type 6: Enterprise Correlation
  - question: How many systems across the organization are attempting eDonkey P2P connections?
    context: Widespread P2P connection attempts indicate systematic policy violations requiring organizational intervention.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: 'Edonkey'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - count

  - question: Are there coordinated P2P connection attempts suggesting organized file sharing activity?
    context: Simultaneous connection attempts by multiple users may indicate coordinated file sharing requiring management response.
    range: -4h/+4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: 'P2P'
        condition: selection
      fields:
        - src_ip
        - alert.signature
        - count