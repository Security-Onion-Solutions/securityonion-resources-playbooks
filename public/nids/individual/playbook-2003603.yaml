name: ET MALWARE W32.Virut.A joining an IRC Channel
id: 22003603
description: |
  Detects W32.Virut.A malware attempting to join the "&virtu" IRC channel for command and control communication.
  This specific channel name is characteristic of the Virut malware family and indicates active infection.
  Legitimate IRC usage would not involve this specific malware-associated channel name.
type: detection
detection_id: 2003603
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete IRC JOIN command and channel details observed?
    context: The specific channel name and JOIN syntax confirms Virut malware family identification.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - src_ip
        - dst_ip

  - question: What IRC server and port was contacted for the malicious channel join?
    context: IRC server details help identify the malware's command and control infrastructure.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - dst_port
        - connection_state
        - tx_bytes
        - rx_bytes

  # Type 2: Triage Assessment
  - question: Is IRC communication authorized from this system?
    context: Most corporate environments prohibit IRC usage, making any IRC activity highly suspicious.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 6667
            - 6668
            - 6669
            - 194
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection_state
        - duration

  - question: Has this system been approved for IRC client software installation?
    context: Legitimate IRC usage would involve documented approval and authorized client applications.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'irc'
            - 'mirc'
            - 'xchat'
            - 'hexchat'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  # Type 3: Activity Context
  - question: What process initiated the IRC connection and Virut channel join?
    context: Process identification helps understand the malware's execution context and infection vector.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid

  - question: What other IRC protocol activity occurred during this malware session?
    context: Complete IRC session analysis reveals malware capabilities and C2 communication patterns.
    range: +/-30m
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: 'IRC'
        condition: selection
      fields:
        - rule.name
        - payload_printable
        - rule.category

  # Type 4: Impact Assessment
  - question: Has the Virut malware received commands or instructions from the IRC channel?
    context: Command reception indicates active malware operation and potential for additional malicious activity.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'IRC'
            - 'PRIVMSG'
            - 'NOTICE'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - payload_printable

  - question: What malicious activities has the system performed since Virut infection?
    context: Post-infection activity assessment reveals the malware's operational impact and damage scope.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - 'trojan'
            - 'malware'
            - 'exploit'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - dst_ip

  # Type 5: Forensic Deep-Dive
  - question: What files and processes are associated with the W32.Virut.A infection?
    context: File system analysis helps identify malware components and enables complete removal.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.hash.md5: '06b522eacdfe51bed5d041fd672e880f'
        condition: selection
      fields:
        - TargetFilename
        - ProcessName
        - file.hash.md5
        - file.size

  - question: What persistence mechanisms has Virut established on the infected system?
    context: Understanding persistence ensures complete malware removal and prevents reinfection.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - 'startup'
            - 'autostart'
            - 'run'
            - 'runonce'
        condition: selection
      fields:
        - TargetFilename
        - ProcessName
        - file.hash.md5

  - question: What registry modifications has the Virut malware made?
    context: Registry analysis reveals malware configuration and helps with forensic reconstruction.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - 'Run'
            - 'RunOnce'
            - 'Winlogon'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessName

  - question: Has the malware infected or modified other executable files on the system?
    context: Virut is known for file infection capabilities that can spread to other executables.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - '.exe'
            - '.scr'
            - '.com'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessName
        - file.size

  # Type 6: Enterprise Correlation
  - question: Are other systems showing signs of W32.Virut.A infection or similar IRC activity?
    context: Virut can spread through network shares and removable media, potentially affecting multiple systems.
    range: +/-6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: 'ET MALWARE W32.Virut.A joining an IRC Channel'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - payload_printable

  - question: What other Virut-related malware indicators are present enterprise-wide?
    context: Comprehensive Virut campaign analysis helps understand infection scope and spread patterns.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'Virut'
        condition: selection
      fields:
        - rule.name
        - src_ip
        - dst_ip
        - rule.category