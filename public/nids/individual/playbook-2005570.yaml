name: ET WEB_SPECIFIC_APPS ThWboard SQL Injection Attempt -- index.php board DELETE
id: 22005570
description: |
  Detects SQL injection attempts against ThWboard application targeting the board parameter in index.php with DELETE statements.
  This specific attack attempts to delete data from the database and indicates active exploitation of CVE-2007-0340.
type: detection
detection_id: 2005570
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What is the complete SQL injection payload in the board parameter?
    context: The exact payload reveals the attacker's intent, target tables, and level of database knowledge.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.full
        - url.query
        - http.request.body.content
        - http.request.method

  - question: What specific DELETE FROM statement structure was used in the attack?
    context: Understanding the DELETE syntax helps assess what data the attacker attempted to remove or modify.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.path
        - url.query
        - http.request.headers.user-agent

  # Type 2: Triage Assessment
  - question: Is ThWboard application legitimately installed on this web server?
    context: Confirming the presence of vulnerable application helps distinguish between targeted attacks and scanning.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains:
            - 'index.php'
            - 'thwboard'
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.user_agent
        - http.response.status_code

  - question: Are there legitimate administrative activities on this ThWboard installation?
    context: Distinguishing between authorized database operations and malicious SQL injection attempts.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains: 'index.php'
          src_ip|contains:
            - '10.'
            - '192.168.'
            - '172.'
        condition: selection
      fields:
        - src_ip
        - url.query
        - http.user_agent

  # Type 3: Activity Context
  - question: What reconnaissance or scanning activity preceded this SQL injection attempt?
    context: Attackers often perform reconnaissance to identify vulnerable applications before launching targeted attacks.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - url.query
        - http.user_agent
        - http.response.status_code

  - question: What other web application attacks originated from this source IP?
    context: Understanding the attacker's broader targeting helps assess threat level and campaign scope.
    range: -1d
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category: 'web-application-attack'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - url.full

  - question: What was the web server's response to this SQL injection attempt?
    context: Server responses indicate whether the attack succeeded and what information may have been disclosed.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - http.response.body.bytes

  # Type 4: Impact Assessment
  - question: Did the SQL injection attempt successfully execute and modify database content?
    context: Successful DELETE operations indicate data loss and potential system compromise requiring immediate response.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.response.status_code: 200
        condition: selection
      fields:
        - url.full
        - http.response.body.bytes
        - http.response.body.content

  - question: Are there signs of follow-up exploitation or data exfiltration attempts?
    context: Successful SQL injection often leads to further database enumeration, data theft, or system compromise.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - url.query
        - http.request.method
        - http.response.body.bytes

  # Type 5: Forensic Deep-Dive
  - question: What other SQL injection techniques were attempted against this application?
    context: Comprehensive attack analysis reveals the attacker's skill level and persistence in exploitation attempts.
    range: -1d/+1d
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: 'SQL'
        condition: selection
      fields:
        - rule.name
        - url.full
        - url.query

  - question: What database error messages or information disclosure occurred during the attack?
    context: Error messages reveal database structure, table names, and system information useful for forensic analysis.
    range: -30m/+30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.response.body.content|contains:
            - 'mysql'
            - 'error'
            - 'database'
            - 'SQL'
        condition: selection
      fields:
        - http.response.body.content
        - url.query
        - http.response.status_code

  - question: What specific ThWboard tables or data were targeted by the DELETE operations?
    context: Understanding targeted data helps assess business impact and required recovery procedures.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.query
        - http.request.body.content
        - rule.name

  # Type 6: Enterprise Correlation
  - question: Are other web servers or applications being targeted with similar SQL injection attacks?
    context: Coordinated attacks across multiple systems indicate broader campaign scope and systematic targeting.
    range: -1d/+1d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: 'SQL'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - url.domain

  - question: Is this attacker IP associated with other web application attacks across the enterprise?
    context: Understanding attacker infrastructure and targeting patterns helps with threat attribution and defense.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category: 'web-application-attack'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - url.domain