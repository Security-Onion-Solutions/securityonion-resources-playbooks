name: ET MALWARE Bot Backdoor Checkin/registration Request
id: 22006366
description: |
  Detects generic bot backdoor communication attempting to register or check in with command and control servers.
  This pattern indicates malware transmitting system information including OS, user, status, version, and build details.
  Legitimate applications typically do not send this specific combination of system parameters to external servers.
type: detection
detection_id: 2006366
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What system information was transmitted in this bot registration request?
    context: The OS, user, status, version, and build parameters reveal victim system details and malware variant.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - url.query
        - http.request.body.content

  - question: What is the complete remote.php URL structure and C2 server details?
    context: The specific URL pattern and server information help identify the botnet infrastructure and campaign.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - url.path
        - dst_port

  # Type 2: Triage Assessment
  - question: Has this system previously communicated with known bot C2 infrastructure?
    context: Historical bot communication patterns help determine infection timeline and campaign persistence.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains: "remote.php"
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - timestamp

  - question: Are there legitimate remote administration tools on this system that might generate similar traffic?
    context: Distinguishing between malware and authorized remote management helps avoid false positive responses.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - "teamviewer"
            - "vnc"
            - "rdp"
            - "remote"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  # Type 3: Activity Context
  - question: What process initiated this bot registration communication?
    context: Identifying the parent process reveals the malware executable and potential infection mechanism.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid
        - User

  - question: What network connections were established around the time of this bot checkin?
    context: Concurrent connections may reveal additional C2 channels or command execution activity.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - protocol
        - bytes_sent
        - bytes_received

  - question: Were there DNS queries for the C2 domain before this registration attempt?
    context: DNS resolution timing helps establish the complete bot communication timeline.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          dns.query.name|expand: '%url.domain%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  # Type 4: Impact Assessment
  - question: Did the C2 server respond with commands or configuration updates?
    context: Successful bot registration indicates active command and control capability.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes
        - http.response.body.content

  - question: Has this system executed any suspicious commands or downloaded additional payloads since registration?
    context: Post-registration activity reveals the scope of bot capabilities and potential damage.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid

  # Type 5: Forensic Deep-Dive
  - question: What specific bot family or variant is indicated by this registration pattern?
    context: Bot family identification helps determine capabilities, persistence mechanisms, and removal procedures.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - payload

  - question: Are there file system artifacts associated with this bot installation?
    context: Malware files and configuration data help confirm infection and guide forensic analysis.
    range: +/-30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.hash.sha256
        - ProcessImage

  # Type 6: Enterprise Correlation
  - question: Are other systems in the enterprise showing similar bot registration activity?
    context: Multiple bot infections indicate a broader campaign requiring coordinated incident response.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Bot Backdoor"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name