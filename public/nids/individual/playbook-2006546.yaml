name: ET SCAN LibSSH Based Frequent SSH Connections Likely BruteForce Attack
id: 22006546
description: |
  Detects potential SSH brute force attacks using LibSSH library with frequent connection attempts.
  May indicate automated credential stuffing or password spraying attacks.
  Could also trigger on legitimate automated SSH tools or backup systems.
type: detection
detection_id: 2006546
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What specific LibSSH version and client characteristics were detected?
    context: LibSSH version information helps identify the tool or malware used in the brute force attack.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - ssh.client.version
        - ssh.client.software
        - payload

  - question: What was the exact frequency and pattern of SSH connection attempts?
    context: Understanding the connection pattern helps distinguish between legitimate automation and malicious brute forcing.
    range: -30m/+30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 22
        condition: selection
      fields:
        - dst_ip
        - connection_count
        - unique_destinations

  # Type 2: Triage Assessment
  - question: Is this source IP authorized for SSH access to these systems?
    context: Legitimate automated systems may use LibSSH for scheduled connections and maintenance tasks.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 22
          connection_state: 'established'
        condition: selection
      fields:
        - dst_ip
        - successful_connections
        - duration

  - question: Does this align with scheduled backup or automation processes?
    context: Backup systems and configuration management tools often use SSH with high frequency connections.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 22
        condition: selection
      fields:
        - dst_ip
        - connection_pattern
        - time_distribution

  # Type 3: Activity Context
  - question: What other scanning or reconnaissance activity has this source performed?
    context: Brute force attacks are often preceded by port scanning and service enumeration activities.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_port
        - connection_count
        - unique_destinations

  - question: What is the geographic and temporal distribution of these SSH attempts?
    context: Understanding attack timing and target distribution reveals the scope and methodology of the brute force campaign.
    range: -4h/+4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 22
        condition: selection
      fields:
        - dst_ip
        - connection_count
        - time_pattern

  # Type 4: Impact Assessment
  - question: Have any SSH connections from this source been successful?
    context: Successful connections indicate potential credential compromise and system access.
    range: -1h/+1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 22
          connection_state: 'established'
        condition: selection
      fields:
        - dst_ip
        - duration
        - bytes_toserver
        - bytes_toclient

  - question: Are there signs of post-authentication activity from successful connections?
    context: Command execution following successful SSH authentication indicates active system compromise.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          ParentImage|contains: 'sshd'
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - User
        - CommandLine
        - ProcessGuid
        - Image

  # Type 5: Forensic Deep-Dive
  - question: What usernames and authentication methods are being attempted?
    context: Understanding targeted accounts helps assess the sophistication and focus of the brute force attack.
    range: -1h/+1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 22
        condition: selection
      fields:
        - ssh.auth.username
        - ssh.auth.method
        - attempt_count

  - question: Are there indicators of credential stuffing or password spraying techniques?
    context: Different attack patterns indicate varying levels of sophistication and potential credential sources.
    range: -2h/+2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 22
        condition: selection
      fields:
        - dst_ip
        - unique_usernames
        - attempts_per_target

  # Type 6: Enterprise Correlation
  - question: Are other systems experiencing similar LibSSH-based brute force attacks?
    context: Widespread SSH brute forcing indicates a coordinated attack campaign against the organization.
    range: -24h/+24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'SSH'
            - 'brute'
            - 'LibSSH'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert_count

  - question: Is this part of a broader credential-based attack campaign across the network?
    context: Correlating with other authentication attacks reveals the scope of credential compromise attempts.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.category|contains:
            - 'brute'
            - 'credential'
            - 'authentication'
        condition: selection
      fields:
        - src_ip
        - rule.name
        - target_count