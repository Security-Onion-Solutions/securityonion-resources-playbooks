name: ET WEB_SPECIFIC_APPS ClickTech ClickContact SQL Injection Attempt -- default.asp AlphaSort UNION SELECT
id: 22007266
description: |
  Detects SQL injection attempts targeting ClickTech ClickContact's AlphaSort parameter using UNION SELECT statements (CVE-2006-6181).
  May trigger on legitimate database queries or reporting functions that use UNION operations for data consolidation.
type: detection
detection_id: 2007266
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete UNION SELECT payload injected into the AlphaSort parameter?
    context: Understanding the UNION SELECT structure reveals what database information the attacker is trying to extract.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - http.request.body.content

  - question: What specific columns or tables is the attacker attempting to access with this UNION SELECT?
    context: The SELECT statement structure reveals the attacker's knowledge of the database schema and target data.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - url.query
        - http.request.headers
        - http.request.body.content

  # Type 2: Triage Assessment
  - question: Is this a legitimate user accessing the ClickContact application interface?
    context: Authorized users may perform legitimate sorting operations that could trigger this rule.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains: '/default.asp'
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.request.method
        - http.response.status_code

  - question: Has this IP address previously used the ClickContact application legitimately?
    context: Established application users are less likely to be conducting SQL injection attacks.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.request.method
        - http.response.status_code

  # Type 3: Activity Context
  - question: What other SQL injection vectors has this attacker tested against the application?
    context: Multiple SQL injection attempts indicate systematic database exploitation rather than accidental triggers.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.query|contains:
            - 'UNION'
            - 'SELECT'
            - 'INSERT'
            - 'UPDATE'
            - 'ORDER BY'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.response.status_code

  - question: Were there any application enumeration attempts before this SQL injection?
    context: Attackers often probe application parameters and functionality before launching targeted SQL injection.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains: '/default.asp'
        condition: selection
      fields:
        - url.query
        - http.request.method
        - http.response.status_code
        - http.request.headers

  - question: What authentication or session management requests preceded this attack?
    context: Understanding the authentication context helps determine if this is an insider threat or external attack.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.request.method
        - http.response.status_code
        - http.request.body.content

  # Type 4: Impact Assessment
  - question: What was the application server's response to this UNION SELECT injection?
    context: Successful SQL injection typically returns database content or error messages revealing schema information.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - http.response.headers

  - question: Are there signs of successful data extraction or database enumeration?
    context: Successful UNION SELECT attacks may lead to additional requests for systematic data extraction.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.response.status_code

  # Type 5: Forensic Deep-Dive
  - question: What ClickContact application version and database backend is being targeted?
    context: Understanding the application environment helps assess vulnerability scope and exploitation methods.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains: '.asp'
        condition: selection
      fields:
        - url.path
        - http.response.headers
        - http.response.status_code

  - question: Are there any suspicious database or application log entries on the server?
    context: SQL injection attacks often generate database errors or unusual application behavior in server logs.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.mime_type

  # Type 6: Enterprise Correlation
  - question: Are other ASP-based applications in the organization experiencing similar SQL injection attempts?
    context: Coordinated SQL injection campaigns often target multiple applications with similar technologies.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          url.query|contains:
            - 'UNION'
            - 'SELECT'
          url.path|endswith: '.asp'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - url.full