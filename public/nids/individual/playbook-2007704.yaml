name: ET WEB_CLIENT Apple Quicktime RTSP Content-Type overflow attempt
id: 22007704
description: |
  Detects attempts to exploit buffer overflow vulnerability in Apple QuickTime RTSP Content-Type handling.
  This targets client-side vulnerability that can lead to remote code execution.
  May trigger on legitimate RTSP streams with long Content-Type headers.
type: detection
detection_id: 2007704
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact RTSP Content-Type header structure and length detected?
    context: Understanding the overflow attempt reveals the specific exploitation technique being used.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - src_ip
        - dst_ip
        - src_port

  - question: What specific QuickTime vulnerability is being targeted by this overflow?
    context: Different overflow lengths and patterns target specific QuickTime versions and vulnerabilities.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          protocol: udp
        condition: selection
      fields:
        - bytes_sent
        - bytes_received
        - src_port

  # Type 2: Triage Assessment
  - question: Is this legitimate RTSP streaming content with long headers?
    context: Some legitimate RTSP streams may have long Content-Type headers, but overflow attempts are clearly malicious.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          protocol: udp
        condition: selection
      fields:
        - src_ip
        - connection_count

  - question: Does this user typically access RTSP streaming content?
    context: Regular RTSP usage may indicate legitimate streaming activity versus targeted exploitation.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - protocol
        - stream_count

  # Type 3: Activity Context
  - question: What web browsing activity preceded this RTSP exploit attempt?
    context: QuickTime exploits often come through web pages with embedded media content.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.response.status_code

  - question: Was this RTSP stream embedded in a web page or accessed directly?
    context: Understanding delivery method helps identify attack vector and potential scope.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          http.response.body.content|contains:
            - rtsp
            - quicktime
            - media
        condition: selection
      fields:
        - url.full
        - http.request.referrer

  # Type 4: Impact Assessment
  - question: Did the QuickTime client crash or show signs of exploitation?
    context: Successful buffer overflow exploitation may cause application crashes or unexpected behavior.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - quicktime
            - qtplugin
        condition: selection
      fields:
        - Image
        - CommandLine
        - ProcessGuid

  - question: Are there signs of shellcode execution or malware installation?
    context: Successful QuickTime exploitation can lead to arbitrary code execution and malware installation.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessImage

  # Type 5: Forensic Deep-Dive
  - question: What QuickTime version and plugins are installed on the target system?
    context: Specific QuickTime versions have different vulnerabilities and exploitation success rates.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - quicktime
            - qt
        condition: selection
      fields:
        - Image
        - file.version
        - ProcessGuid

  - question: What browser and media player configuration enabled this exploit?
    context: Understanding client configuration helps assess vulnerability and implement protections.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - browser
            - iexplore
            - firefox
            - chrome
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  # Type 6: Enterprise Correlation
  - question: Are other systems showing similar QuickTime exploitation attempts?
    context: Client-side exploits often target multiple users through malicious websites or email campaigns.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Quicktime"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert_count

  - question: Is this part of a broader web-based exploitation campaign?
    context: QuickTime exploits may be part of exploit kits targeting multiple client vulnerabilities.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "WEB_CLIENT"
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - alert_count