name: ET MALWARE Nebuler/Dialer.qn HTTP Request - Checkin
id: 22007743
description: |
  Detects HTTP checkin requests from Nebuler/Dialer.qn malware family using distinctive parameter patterns.
  This dialer malware connects to remote servers to report system information and receive commands.
  Legitimate applications do not typically use this specific parameter combination pattern.
type: detection
detection_id: 2007743
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete parameter string sent by the Nebuler/Dialer malware?
    context: The parameter values reveal victim identification, malware version, and system configuration data.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - url.query
        - http.request.headers

  - question: What system information was transmitted in the malware checkin?
    context: Parameter values often contain encoded system details, user information, and malware configuration.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.request.body.content
        - http.response.body.content
        - http.response.status_code

  # Type 2: Triage Assessment
  - question: Is this system known to run legitimate dialer or telephony applications?
    context: Some legitimate dialer software may have similar communication patterns, requiring context analysis.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          process.name|contains:
            - "dialer"
            - "phone"
            - "telephony"
            - "modem"
        condition: selection
      fields:
        - process.name
        - process.command_line
        - User
        - process.parent.name

  - question: Has this destination been contacted by other systems recently?
    context: Multiple systems contacting the same server may indicate widespread infection or legitimate service.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|expand: '%dst_port%'
        condition: selection
      fields:
        - src_ip
        - protocol
        - bytes_out
        - bytes_in

  # Type 3: Activity Context
  - question: What process initiated this malware communication?
    context: Identifying the parent process helps understand infection vector and malware deployment method.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - User
        - ProcessGuid

  - question: What network activity preceded this dialer checkin?
    context: Prior network connections may reveal initial infection vector or malware download activity.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - http.request.method
        - http.response.status_code

  - question: Were there any file modifications around the time of this communication?
    context: Dialer malware often modifies system files or creates persistence mechanisms during operation.
    range: +/-30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          event.action|contains:
            - "created"
            - "modified"
        condition: selection
      fields:
        - file.name
        - file.path
        - process.name
        - file.hash.md5

  # Type 4: Impact Assessment
  - question: Did the malware server provide commands or configuration updates?
    context: Server responses indicate active command and control capability and potential for additional malicious activity.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
          http.response.status_code: 200
        condition: selection
      fields:
        - http.response.body.content
        - http.response.body.bytes
        - http.response.headers

  - question: Are there signs of premium-rate dialing or telephony abuse?
    context: Dialer malware typically attempts to establish expensive phone connections or modify dial-up settings.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          registry.path|contains:
            - "\\Telephony"
            - "\\RAS"
            - "\\Dialup"
            - "\\Internet Settings"
        condition: selection
      fields:
        - registry.path
        - registry.value
        - process.name

  # Type 5: Forensic Deep-Dive
  - question: What is the reputation and hosting profile of the command server?
    context: Analyzing server infrastructure helps identify threat actor operations and malware family characteristics.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          dns.resolved_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - src_ip

  - question: What persistence mechanisms has this malware family established?
    context: Nebuler variants often create registry entries, scheduled tasks, or service installations for persistence.
    range: +/-4h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          registry.path|contains:
            - "\\Run"
            - "\\RunOnce"
            - "\\Services"
            - "\\CurrentVersion\\Windows"
        condition: selection
      fields:
        - registry.path
        - registry.value
        - process.name
        - event.action

  # Type 6: Enterprise Correlation
  - question: Are other endpoints showing similar Nebuler/Dialer activity patterns?
    context: Identifies campaign scope and potential network-based spreading mechanisms.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - "Nebuler"
            - "Dialer"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - timestamp

  - question: Is this part of a coordinated malware distribution campaign?
    context: Multiple infections may indicate email-based distribution, drive-by downloads, or network propagation.
    range: +/-7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - protocol
        - bytes_out