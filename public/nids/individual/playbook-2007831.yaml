name: ET MALWARE Downloader General Bot Checking In via HTTP Post (bot_id push)
id: 22007831
description: |
  Detects generic bot malware checking in with command and control servers via HTTP POST requests.
  This pattern indicates malware transmitting bot identification, build information, and network configuration details.
  The specific parameter combination is characteristic of bot malware families and not used by legitimate applications.
type: detection
detection_id: 2007831
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What bot identification and system information was transmitted in this POST request?
    context: The bot_id, build_id, and port configuration reveal unique bot identifier and malware capabilities.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - http.request.body.content
        - url.full
        - dst_ip

  - question: What network port configuration details are included in this bot checkin?
    context: Sport and hport parameters reveal malware network configuration and potential backdoor capabilities.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - http.request.body.content
        - url.domain

  # Type 2: Triage Assessment
  - question: Has this system previously used this bot_id for malware communications?
    context: Bot ID reuse patterns help establish infection timeline and track persistent bot activity.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.body.content|contains: "bot_id="
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - timestamp

  - question: Are there legitimate applications on this system that might use similar POST parameters?
    context: Distinguishing between malware and legitimate software helps avoid false positive responses.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - "build"
            - "ping"
            - "speed"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  # Type 3: Activity Context
  - question: What process initiated this bot checkin via HTTP POST?
    context: Identifying the parent process reveals the bot executable and potential infection mechanism.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid
        - User

  - question: What network connections were established around the time of this bot POST request?
    context: Concurrent connections may reveal additional C2 channels or command execution activity.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - protocol
        - bytes_sent
        - bytes_received

  - question: Were there DNS queries for the C2 domain before this bot checkin?
    context: DNS resolution timing helps establish the complete bot communication sequence.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          dns.query.name|expand: '%url.domain%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  # Type 4: Impact Assessment
  - question: Did the C2 server respond with commands or configuration updates after this bot checkin?
    context: Successful bot registration indicates active command and control capability.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes
        - http.response.body.content

  - question: Has this system opened any network ports or services since the bot checkin?
    context: New network services may indicate backdoor activation or additional malware deployment.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - protocol
        - bytes_sent

  # Type 5: Forensic Deep-Dive
  - question: What specific bot family is indicated by this POST parameter pattern?
    context: Bot family identification helps determine capabilities, persistence mechanisms, and removal procedures.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - payload

  - question: Are there file system artifacts associated with this bot installation?
    context: Bot files and configuration data help confirm infection and guide forensic analysis.
    range: +/-30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.hash.sha256
        - ProcessImage

  # Type 6: Enterprise Correlation
  - question: Are other systems in the enterprise showing similar bot checkin activity with related bot_ids?
    context: Related bot IDs across multiple systems indicate coordinated botnet deployment and campaign scope.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Bot Checking"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name