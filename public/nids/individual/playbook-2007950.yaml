name: ET MALWARE Possible Infection Report Mail - Indy Mail lib and Nome do Computador in Body
id: 22007950
description: |
  Detects email containing Indy mail library headers with Portuguese "Nome do Computador" (Computer Name) text.
  This pattern is associated with malware that automatically sends infection reports via email,
  though could occur in legitimate Portuguese-language system administration emails.
type: detection
detection_id: 2007950
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete email content including headers and body?
    context: Full email analysis reveals the infection report format and system information being transmitted.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - alert.signature
        - flow_id

  - question: What specific computer name and system information was included in the email?
    context: The computer name and system details reveal the identity and configuration of the infected system.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_port
        - dst_port
        - bytes_toserver

  # Type 2: Triage Assessment
  - question: Is this system located in a Portuguese-speaking region or used by Portuguese speakers?
    context: Legitimate system administration emails in Portuguese environments may contain similar language patterns.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 25
            - 587
            - 465
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - conn_state

  - question: Does this system normally send emails through this mail server?
    context: Unusual mail server usage may indicate malware bypassing normal email infrastructure.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 25
            - 587
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - conn_state

  # Type 3: Activity Context
  - question: What process initiated the email transmission using the Indy mail library?
    context: Identifying the sending process helps distinguish between legitimate applications and malware.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - '.exe'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: Were there any suspicious file downloads or installations prior to this email?
    context: Recent malware installation may explain the automated infection reporting behavior.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - '.exe'
            - '.dll'
            - '.scr'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessName

  - question: What other network connections were established around the time of email transmission?
    context: Malware often communicates with command and control servers before or after sending infection reports.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver
        - conn_state

  # Type 4: Impact Assessment
  - question: Was the infection report email successfully delivered to external recipients?
    context: Successful delivery provides attackers with confirmation of system compromise and victim information.
    range: +10m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port|expand: '%dst_port%'
        condition: selection
      fields:
        - bytes_toserver
        - bytes_toclient
        - conn_state

  - question: What sensitive system information was disclosed in the infection report?
    context: Infection reports often contain system configuration, installed software, and network information.
    range: -5m
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'systeminfo.exe'
            - 'wmic.exe'
            - 'reg.exe'
        condition: selection
      fields:
        - CommandLine
        - User
        - ProcessName

  # Type 5: Forensic Deep-Dive
  - question: Are there indicators of specific malware families that use Indy mail libraries for reporting?
    context: Certain malware strains are known to use Indy components for automated email communications.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - 'indy'
            - 'mail'
            - '.dll'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessName

  - question: What persistence mechanisms were established by the malware?
    context: Malware that sends infection reports typically establishes persistence for continued access and reporting.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - 'Run'
            - 'RunOnce'
            - 'Services'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessName

  - question: Are there signs of data collection activities preceding the infection report?
    context: Malware often gathers system information before compiling and sending infection reports.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'dir'
            - 'type'
            - 'findstr'
        condition: selection
      fields:
        - CommandLine
        - User
        - ProcessName

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network sending similar infection report emails?
    context: Multiple infection reports may indicate a widespread malware campaign across the organization.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: 'Indy Mail'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature