name: ET MALWARE Perfect Keylogger FTP Initial Install Log Upload
id: 22007973
description: |
  Detects Perfect Keylogger malware attempting to upload installation logs via FTP.
  This indicates successful keylogger installation and initial communication with attacker infrastructure.
  No legitimate use cases for this specific message pattern.
type: detection
detection_id: 2007973
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete FTP communication containing the keylogger installation message?
    context: Analyzing the full FTP session reveals installation details and potential data exfiltration patterns.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - flow_id
        - app_proto
  - question: Is this system authorized to use FTP for legitimate file transfers?
    context: Distinguishing between authorized FTP usage and malicious keylogger communications.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 21
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - bytes_toclient
  - question: What triggered the keylogger installation on this system?
    context: Understanding the infection vector helps identify other potentially compromised systems.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
  - question: What other network connections has this infected system established?
    context: Identifying additional C2 communications and lateral movement attempts.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - app_proto
        - bytes_toserver
  - question: Has the keylogger created any persistence mechanisms on the infected system?
    context: Determining if the malware will survive system reboots and maintain access.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - 'Run'
            - 'RunOnce'
            - 'Services'
        condition: selection
      fields:
        - TargetObject
        - Details
        - Image
  - question: What files has the keylogger created or modified on the system?
    context: Identifying keylogger components and captured data files for containment.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - Image
  - question: Are there signs of data exfiltration beyond the initial installation log?
    context: Assessing the scope of data compromise and ongoing exfiltration activities.
    range: +24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - bytes_toserver
        - app_proto
        - duration
  - question: Has this keylogger variant been observed on other systems in the network?
    context: Determining if this is part of a broader campaign affecting multiple endpoints.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'Perfect Keylogger'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
  - question: What DNS queries preceded the FTP connection to identify the C2 infrastructure?
    context: Understanding how the malware resolved the C2 server helps identify infrastructure patterns.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name