name: ET MALWARE Turkojan C&C Initial Checkin (ams)
id: 22008021
description: |
  Detects Turkojan RAT performing initial check-in with command and control server using "ams" beacon.
  This indicates successful malware installation and establishment of C2 communication channel.
  No legitimate applications use this specific 3-byte "ams" message pattern.
type: detection
detection_id: 2008021
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the exact network communication containing the "ams" beacon?
    context: Analyzing the complete C2 handshake reveals communication protocol and potential follow-up commands.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - flow_id
        - community_id
  - question: Is this TCP connection to high ports part of legitimate business operations?
    context: Distinguishing between authorized high-port communications and malicious C2 traffic.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - '1024'
            - '1025'
            - '1026'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver
        - bytes_toclient
  - question: What process initiated the Turkojan C2 communication?
    context: Understanding the execution chain helps identify infection vector and malware deployment method.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid
  - question: What follow-up C2 communications occurred after the initial "ams" beacon?
    context: Identifying subsequent commands and data exfiltration activities from the RAT.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - bytes_toserver
        - bytes_toclient
        - duration
  - question: Has the Turkojan RAT established persistence mechanisms on the infected system?
    context: Determining if the malware will maintain access after system reboots.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - 'Run'
            - 'RunOnce'
            - 'Services'
        condition: selection
      fields:
        - TargetObject
        - Details
        - Image
  - question: What files has the Turkojan malware created or modified on the system?
    context: Identifying RAT components and potential data collection files for forensic analysis.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - Image
  - question: Are there signs of remote access or lateral movement from this infected system?
    context: Assessing if the RAT is being used for interactive access or network reconnaissance.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - app_proto
        - bytes_toserver
  - question: Has this Turkojan C2 server been contacted by other systems in the network?
    context: Determining if this is part of a broader campaign affecting multiple endpoints.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - bytes_toserver
  - question: What DNS queries were made to resolve the Turkojan C2 infrastructure?
    context: Understanding domain resolution patterns helps identify related C2 infrastructure.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name
  - question: Are there other Turkojan-related alerts or similar RAT activity across the enterprise?
    context: Identifying the scope of the Turkojan campaign and related malware families.
    range: -48h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'Turkojan'
            - 'RAT'
            - 'Remote Access'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name