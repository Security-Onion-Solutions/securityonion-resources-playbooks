name: ET MALWARE Daemonize.ft HTTP Checkin
id: 22008086
description: |
  Detects HTTP checkin activity from Daemonize.ft malware using specific parameter patterns.
  This malware uses PHP scripts with distinctive parameter combinations for command and control.
  Legitimate applications rarely use this exact parameter sequence pattern.
type: detection
detection_id: 2008086
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete HTTP URI pattern that triggered this Daemonize.ft detection?
    context: Understanding the full URI structure reveals the malware's communication protocol and configuration.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - url.path
        - url.query

  - question: What specific parameter values were transmitted in this malware checkin?
    context: Parameter values can reveal victim identification, malware version, and operational status.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.request.body.content
        - http.response.status_code
        - http.response.body.content

  # Type 2: Triage Assessment
  - question: Is this destination server known for hosting legitimate PHP applications?
    context: Helps distinguish between compromised legitimate servers and dedicated malware infrastructure.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          http.request.method: "GET"
        condition: selection
      fields:
        - url.domain
        - url.path
        - src_ip

  - question: Has this source system exhibited normal web browsing patterns recently?
    context: Normal browsing activity suggests potential compromise versus dedicated malware host.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - http.request.method

  # Type 3: Activity Context
  - question: What process initiated this HTTP connection on the source system?
    context: Identifying the parent process helps determine infection vector and malware deployment method.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port|expand: '%dst_port%'
        condition: selection
      fields:
        - process.name
        - process.pid
        - process.command_line

  - question: What other network connections occurred from this system around the same time?
    context: Concurrent connections may reveal additional malware components or lateral movement attempts.
    range: +/-30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - protocol
        - bytes_out

  # Type 4: Impact Assessment
  - question: Did the malware server respond with commands or payloads?
    context: Server responses indicate active command and control communication and potential payload delivery.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
          http.response.status_code: 200
        condition: selection
      fields:
        - http.response.body.content
        - http.response.body.bytes
        - http.response.headers

  - question: Are there signs of file downloads or additional malware installation?
    context: Successful C2 communication often leads to secondary payload downloads or system modifications.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          event.action: "created"
        condition: selection
      fields:
        - file.name
        - file.path
        - file.hash.md5
        - process.name

  # Type 5: Forensic Deep-Dive
  - question: What is the infrastructure profile of the destination server?
    context: Analyzing server characteristics helps identify malware family operations and threat actor infrastructure.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - tls.server.certificate.subject
        - tls.server.certificate.issuer
        - tls.server.certificate.not_after

  - question: What persistence mechanisms might be associated with this malware family?
    context: Daemonize.ft variants often establish persistence through registry modifications or scheduled tasks.
    range: +/-2h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          registry.path|contains:
            - "\\Run"
            - "\\RunOnce"
            - "\\Services"
        condition: selection
      fields:
        - registry.path
        - registry.value
        - process.name

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network communicating with this malware infrastructure?
    context: Identifies scope of compromise and potential worm-like spreading behavior.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - bytes_out
        - bytes_in

  - question: Is this part of a broader malware campaign affecting multiple endpoints?
    context: Correlating similar alerts across the enterprise reveals campaign scope and attack patterns.
    range: +/-7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Daemonize"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - timestamp
        - rule.name