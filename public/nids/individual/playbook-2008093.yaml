name: ET SCAN External to Internal UPnP Request tcp port 2555
id: 22008093
description: |
  Detects external UPnP discovery requests targeting internal systems on TCP port 2555.
  This indicates potential external reconnaissance or exploitation attempts against UPnP services.
  External UPnP requests are typically malicious as they suggest network boundary compromise.
type: detection
detection_id: 2008093
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete external UPnP request that penetrated the network perimeter?
    context: Analyzing external UPnP requests reveals attack techniques and potential firewall bypasses.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - http.request.method
        - http.request.uri

  - question: What specific UPnP device or service was the external attacker targeting?
    context: The targeted UUID or service helps identify attack objectives and potential vulnerabilities.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - http.request.headers
        - user_agent

  # Type 2: Triage Assessment
  - question: Is this external IP associated with legitimate business partners or services?
    context: Some authorized external services might legitimately query internal UPnP devices.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - service
        - first_seen

  - question: Are there documented firewall rules allowing UPnP traffic from this source?
    context: Understanding network policies helps determine if this represents a security control failure.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - connection_state
        - proto
        - bytes_toserver

  # Type 3: Activity Context
  - question: How did this external traffic reach the internal UPnP service?
    context: Understanding the network path reveals potential security control bypasses or misconfigurations.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - service
        - connection_state

  - question: What other external reconnaissance activities originated from this source?
    context: Understanding broader scanning patterns reveals threat actor methodology and campaign scope.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.category|contains: 'scan'
        condition: selection
      fields:
        - dst_ip
        - alert.signature
        - alert.severity

  # Type 4: Impact Assessment
  - question: Did the internal UPnP service respond with device information to this external request?
    context: Successful responses expose internal network topology and device capabilities to external attackers.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
          src_port: 2555
        condition: selection
      fields:
        - bytes_toclient
        - bytes_toserver
        - duration

  - question: Are there signs of successful UPnP exploitation following this discovery?
    context: External UPnP discovery often precedes exploitation attempts against discovered vulnerabilities.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          alert.signature|contains:
            - 'exploit'
            - 'vulnerability'
            - 'attack'
        condition: selection
      fields:
        - alert.signature
        - alert.severity
        - payload

  # Type 5: Forensic Deep-Dive
  - question: What specific UPnP vulnerabilities might this external actor be targeting?
    context: Understanding targeted vulnerabilities helps prioritize patching and containment efforts.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains: 'UPnP'
        condition: selection
      fields:
        - dst_ip
        - alert.signature
        - cve_id

  - question: Are there indicators of lateral movement following this external UPnP access?
    context: Successful external UPnP exploitation can provide initial foothold for network traversal.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 445
            - 139
            - 3389
            - 22
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - service

  # Type 6: Enterprise Correlation
  - question: Are other internal systems being targeted by external UPnP scanning from this source?
    context: Understanding attack scope helps prioritize incident response and network hardening.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains: 'UPnP'
        condition: selection
      fields:
        - dst_ip
        - alert.signature
        - count

  - question: Is this external IP part of a coordinated campaign against multiple organizations?
    context: Understanding threat intelligence context helps assess attacker sophistication and likely persistence.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - alert.signature
        - alert.category