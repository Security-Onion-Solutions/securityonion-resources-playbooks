name: ET SCAN External to Internal UPnP Request udp port 1900
id: 22008094
description: |
  Detects external UPnP discovery requests targeting internal systems.
  May indicate reconnaissance for vulnerable UPnP devices or legitimate service discovery.
  External UPnP requests pose security risks as they can expose internal services.
type: detection
detection_id: 2008094
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact UPnP MSEARCH request structure and headers?
    context: Understanding the complete UPnP request reveals the specific services being discovered.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - src_ip
        - dst_ip
        - dst_port

  - question: What specific UPnP services or device types are being searched for?
    context: Different UPnP search targets indicate different attack objectives or reconnaissance goals.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 1900
          protocol: udp
        condition: selection
      fields:
        - bytes_sent
        - bytes_received

  # Type 2: Triage Assessment
  - question: Is this legitimate UPnP service discovery from authorized sources?
    context: UPnP discovery should typically occur within local networks, not from external sources.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 1900
        condition: selection
      fields:
        - src_ip
        - connection_count

  - question: Does this system typically respond to UPnP discovery requests?
    context: Systems with UPnP services enabled may legitimately respond to discovery requests.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 1900
        condition: selection
      fields:
        - src_ip
        - protocol
        - response_count

  # Type 3: Activity Context
  - question: What other network reconnaissance preceded this UPnP discovery?
    context: UPnP scanning often follows broader network discovery and port scanning.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 80
            - 443
            - 8080
            - 5000
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection_state

  - question: Is this part of a systematic network device enumeration?
    context: Attackers often scan for UPnP devices as part of IoT device discovery.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - protocol

  # Type 4: Impact Assessment
  - question: Did the target system respond with UPnP device information?
    context: UPnP responses expose device capabilities and potential attack surfaces.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - src_port
        - bytes_sent
        - protocol

  - question: Are there signs of exploitation attempts against discovered UPnP services?
    context: UPnP discovery often precedes exploitation attempts against vulnerable services.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - bytes_sent
        - connection_state

  # Type 5: Forensic Deep-Dive
  - question: What UPnP-enabled devices and services are running on this system?
    context: Identifying UPnP services helps assess exposure and vulnerability.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - upnp
            - ssdp
            - dlna
        condition: selection
      fields:
        - Image
        - CommandLine
        - ProcessGuid

  - question: What network services are listening on UPnP-related ports?
    context: Understanding service exposure helps determine attack surface.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 1900
            - 5000
            - 8080
        condition: selection
      fields:
        - src_ip
        - dst_port
        - protocol

  # Type 6: Enterprise Correlation
  - question: Are other internal systems receiving similar UPnP discovery requests?
    context: Broad UPnP scanning may indicate reconnaissance for vulnerable IoT devices.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "UPnP"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert_count

  - question: Is this part of a broader IoT device discovery campaign?
    context: UPnP scanning often targets IoT devices as part of botnet recruitment or exploitation.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "SCAN"
            - "UPnP"
            - "SSDP"
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - alert_count