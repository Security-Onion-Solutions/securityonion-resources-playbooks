name: ET TFTP Outbound TFTP Write Request
id: 22008116
description: |
  Detects outbound TFTP write requests from internal network to external hosts.
  TFTP writes can indicate legitimate device configuration uploads but may also
  represent data exfiltration, malware uploads, or unauthorized file transfers.
type: detection
detection_id: 2008116
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What file is being uploaded via TFTP write request?
    context: TFTP write requests contain the filename being uploaded, revealing what data is being transferred.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - src_ip
        - dst_ip
        - dst_port

  - question: Is this TFTP write request part of authorized network operations?
    context: Legitimate TFTP uploads often occur during device configuration backups or firmware updates.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 69
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - bytes_toclient

  - question: What system is initiating this TFTP write operation?
    context: Identifying the source system helps determine if this is expected device behavior or potential data exfiltration.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto
        - app_proto

  - question: Are there multiple TFTP write requests from this source?
    context: Repeated TFTP uploads may indicate systematic data exfiltration or bulk file transfer.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 69
        condition: selection
      fields:
        - dst_ip
        - community_id
        - bytes_toserver

  - question: What is the size and content of the TFTP upload?
    context: Large uploads or sensitive file types may indicate data exfiltration or malware distribution.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - bytes_toserver
        - bytes_toclient
        - duration

  - question: Has this external TFTP destination been used before?
    context: New or unusual TFTP upload destinations may indicate malicious infrastructure or data exfiltration.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 69
        condition: selection
      fields:
        - src_ip
        - bytes_toserver

  - question: Are there DNS queries for the TFTP upload destination?
    context: DNS lookups may reveal domain names associated with the TFTP server receiving uploads.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          dns.resolved_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - src_ip

  - question: What processes were active on the source system before the upload?
    context: Identifying running processes helps determine if TFTP write originated from legitimate software or malware.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: What files were accessed before the TFTP upload?
    context: File access events may reveal what data is being uploaded via TFTP.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.mime_type

  - question: Are there other suspicious network activities from this source?
    context: TFTP uploads may be part of broader attack activities including reconnaissance or lateral movement.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - alert.category

  - question: Are other internal systems uploading to the same TFTP server?
    context: Multiple systems uploading to the same destination may indicate coordinated data exfiltration.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 69
        condition: selection
      fields:
        - src_ip
        - bytes_toserver
        - community_id

  - question: What is the geolocation and reputation of the TFTP upload destination?
    context: External or suspicious destinations may indicate data exfiltration to attacker-controlled infrastructure.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - proto
        - app_proto