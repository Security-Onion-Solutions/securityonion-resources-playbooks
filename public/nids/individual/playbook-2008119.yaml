name: ET TFTP Outbound TFTP Error Message
id: 22008119
description: |
  Detects outbound TFTP error messages from internal systems to external hosts.
  May indicate legitimate file transfer issues or potential data exfiltration attempts via TFTP.
type: detection
detection_id: 2008119
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What specific TFTP error code was transmitted in the outbound traffic?
    context: Understanding the error type reveals the nature of the failed transfer attempt.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - alert.signature

  - question: What was the complete UDP payload content of this TFTP error message?
    context: Analyzing the full payload helps determine if this is legitimate TFTP traffic or potential data exfiltration.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - network.bytes
        - network.protocol
        - network.transport

  # Type 2: Triage Assessment
  - question: Is TFTP communication normal for this internal host?
    context: Legitimate network devices and systems may use TFTP for configuration updates or firmware transfers.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 69
        condition: selection
      fields:
        - dst_ip
        - network.bytes
        - network.packets

  - question: Does this host have authorized TFTP server access during business hours?
    context: Some network equipment legitimately uses TFTP for backup or configuration management.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 69
            - 21
            - 22
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.bytes

  # Type 3: Activity Context
  - question: What network activity preceded this TFTP error message?
    context: Understanding the sequence helps determine if this was part of a legitimate transfer or malicious activity.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.protocol
        - network.bytes

  - question: Was there successful TFTP communication before this error occurred?
    context: Successful transfers followed by errors may indicate interrupted data exfiltration attempts.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 69
        condition: selection
      fields:
        - network.bytes
        - network.packets
        - network.direction

  # Type 4: Impact Assessment
  - question: What volume of data was transferred before this TFTP error?
    context: Large data transfers followed by errors may indicate attempted data exfiltration.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 69
        condition: selection
      fields:
        - dst_ip
        - network.bytes
        - network.packets

  - question: Are there signs of successful file transfers to external TFTP servers?
    context: Successful transfers indicate potential data exfiltration capabilities.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 69
        condition: selection
      fields:
        - dst_ip
        - network.bytes
        - network.packets

  # Type 5: Forensic Deep-Dive
  - question: What processes on this host initiated TFTP connections?
    context: Identifying the source process helps determine if this is legitimate system activity or malware.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - User

  - question: Are there file access events related to potential TFTP transfers?
    context: File system activity may reveal what data was being transferred via TFTP.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - file.path
        - file.name
        - process.name
        - event.action

  # Type 6: Enterprise Correlation
  - question: Are other internal hosts communicating with the same external TFTP server?
    context: Multiple hosts using the same external TFTP server may indicate coordinated data exfiltration.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 69
        condition: selection
      fields:
        - src_ip
        - network.bytes
        - network.packets