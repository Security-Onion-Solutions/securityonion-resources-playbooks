name: ET MALWARE Common Downloader Access Count Tracking URL
id: 22008132
description: |
  Detects malware downloaders tracking access counts via specific URL patterns with MAC address parameters.
  Pattern includes hexadecimal MAC address format and access count tracking mechanism.
  Legitimate applications rarely use this specific URL structure with MAC address tracking.
type: detection
detection_id: 2008132
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete access count tracking URL and parameters?
    context: The full URL structure reveals the tracking mechanism and potential campaign identification.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.full
        - url.query
        - http.request.method

  - question: What MAC address format was detected in the URL parameters?
    context: The MAC address format helps identify the specific malware variant and host identification method.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - url.query
        - url.path

  # Type 2: Triage Assessment
  - question: Is this host known to run legitimate applications that track access counts with MAC addresses?
    context: Some network management or asset tracking tools might use similar URL patterns, though uncommon.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains: "access_count"
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - http.user_agent

  - question: Does this activity align with scheduled maintenance or inventory processes?
    context: Legitimate access tracking might occur during scheduled network audits or asset management.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.domain
        - http.user_agent
        - timestamp

  # Type 3: Activity Context
  - question: What process initiated this access count tracking request?
    context: Identifying the originating process helps determine if this is malware or legitimate software.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port|expand: '%dst_port%'
        condition: selection
      fields:
        - process.name
        - process.pid
        - process.command_line

  - question: What other HTTP requests preceded this access count tracking?
    context: Malware often performs reconnaissance or initial communication before tracking access counts.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.request.method
        - http.response.status_code

  - question: Are there signs of initial infection or downloader execution?
    context: Access count tracking typically occurs after initial malware installation and execution.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - User

  # Type 4: Impact Assessment
  - question: Did the server respond successfully to the access count tracking request?
    context: Successful responses indicate active C2 communication and potential for further malicious activity.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains: "access_count"
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes
        - url.query

  - question: Has the malware proceeded to download additional payloads after access tracking?
    context: Access count tracking often precedes payload downloads in downloader malware families.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.response.body.bytes
        - http.request.method

  # Type 5: Forensic Deep-Dive
  - question: What specific downloader family characteristics match this access tracking pattern?
    context: Different downloader families use unique access tracking mechanisms and URL structures.
    range: +/-2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.path
        - url.query
        - http.user_agent
        - http.request.body.content

  - question: Are there file system artifacts indicating downloader installation?
    context: Downloaders typically create temporary files or modify system directories during operation.
    range: +/-4h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - file.name
        - file.path
        - file.hash.md5
        - process.name

  # Type 6: Enterprise Correlation
  - question: Are other systems showing similar access count tracking behavior?
    context: Downloader campaigns often affect multiple systems simultaneously or through lateral movement.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          url.path|contains: "access_count.html"
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - url.query
        - http.user_agent