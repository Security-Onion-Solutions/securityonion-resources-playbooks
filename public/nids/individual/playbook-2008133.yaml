name: ET MALWARE Common Downloader Install Count Tracking URL
id: 22008133
description: |
  Detects malware downloaders tracking installation counts via specific URL patterns with MAC address parameters.
  Pattern indicates successful malware installation reporting back to C2 infrastructure.
  Legitimate software rarely uses this specific URL structure for installation tracking.
type: detection
detection_id: 2008133
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete install count tracking URL and identification parameters?
    context: The full URL structure reveals installation tracking mechanism and campaign identification details.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.full
        - url.query
        - http.request.method

  - question: What specific MAC address and ID combination was used for installation tracking?
    context: The MAC address and ID parameters help identify the specific infected host and malware instance.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - url.query
        - url.path
        - http.user_agent

  # Type 2: Triage Assessment
  - question: Is this system authorized to report software installation metrics to external servers?
    context: Some legitimate enterprise software may report installation statistics, though uncommon with MAC addresses.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains: "install_count"
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - http.user_agent

  - question: Does this activity correlate with legitimate software deployment schedules?
    context: Authorized installation tracking would typically align with documented deployment windows.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.domain
        - http.user_agent
        - timestamp

  # Type 3: Activity Context
  - question: What installation or execution events preceded this tracking request?
    context: Install count tracking typically follows successful malware installation and initial execution.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - User

  - question: What network activity occurred before the installation count reporting?
    context: Malware often performs initial C2 communication or payload downloads before reporting installation success.
    range: -4h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.request.method
        - http.response.status_code
        - http.response.body.bytes

  - question: Are there file creation events indicating recent malware installation?
    context: Installation count tracking suggests recent malware deployment with associated file system changes.
    range: -6h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - file.name
        - file.path
        - file.hash.md5
        - process.name

  # Type 4: Impact Assessment
  - question: Did the C2 server acknowledge the installation count report?
    context: Successful acknowledgment indicates active C2 channel and potential for receiving further commands.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains: "install_count"
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes
        - url.query

  - question: Has the malware established persistence mechanisms after installation reporting?
    context: Installation count tracking often precedes persistence establishment and further malicious activity.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - registry.key
        - registry.value.name
        - registry.value.data
        - process.name

  # Type 5: Forensic Deep-Dive
  - question: What specific downloader family uses this installation tracking mechanism?
    context: Different malware families have unique installation reporting patterns and C2 communication structures.
    range: +/-2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.path
        - url.query
        - http.user_agent
        - http.request.body.content

  - question: Are there additional payload downloads following installation confirmation?
    context: Downloaders typically fetch secondary payloads after confirming successful installation to C2 server.
    range: +8h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.response.body.bytes
        - http.request.method
        - file.hash.md5

  - question: What persistence and configuration files were created post-installation?
    context: Successful installation typically involves creating configuration files and persistence mechanisms.
    range: +6h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - file.name
        - file.path
        - file.extension
        - process.name

  # Type 6: Enterprise Correlation
  - question: Are other hosts reporting similar installation counts to the same C2 infrastructure?
    context: Downloader campaigns often target multiple systems with coordinated installation tracking.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          url.path|contains: "install_count.html"
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - url.query
        - http.user_agent