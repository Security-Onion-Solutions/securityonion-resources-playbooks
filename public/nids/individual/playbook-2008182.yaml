name: ET MALWARE Common Downloader Install Report URL
id: 22008182
description: |
  Detects malware downloaders reporting installation status via GET requests with specific parameter combinations.
  Pattern includes multiple tracking parameters (a, k, wmid, ucid) indicating successful malware deployment.
  Legitimate applications rarely use this specific parameter combination for installation reporting.
type: detection
detection_id: 2008182
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What were the specific parameter values in the installation report URL?
    context: The parameter values reveal campaign identifiers, system information, and tracking mechanisms used by the malware.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.full
        - url.query
        - http.request.method

  - question: What do the wmid and ucid parameters indicate about the malware campaign?
    context: These parameters often contain campaign identifiers or affiliate tracking information for malware distribution.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - url.query
        - url.path
        - http.user_agent

  # Type 2: Triage Assessment
  - question: Is this host authorized to send installation reports with these parameter patterns?
    context: Some legitimate software may send installation metrics, but this specific parameter combination is uncommon.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.query|contains: "wmid="
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - http.user_agent

  - question: Does this activity align with known software deployment or update processes?
    context: Legitimate installation reporting would typically occur during scheduled maintenance or deployment windows.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.domain
        - http.user_agent
        - timestamp

  # Type 3: Activity Context
  - question: What process initiated this installation report request?
    context: Identifying the originating process helps determine if this is malware communication or legitimate software.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port|expand: '%dst_port%'
        condition: selection
      fields:
        - process.name
        - process.pid
        - process.command_line

  - question: What installation or execution events preceded this report?
    context: Installation reports typically follow recent malware deployment or execution events.
    range: -4h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - User

  - question: Are there file downloads or creation events associated with this installation?
    context: Installation reporting suggests recent file system changes from malware deployment.
    range: -6h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - file.name
        - file.path
        - file.hash.md5
        - process.name

  # Type 4: Impact Assessment
  - question: Did the C2 server successfully receive and acknowledge the installation report?
    context: Successful acknowledgment indicates active C2 communication and potential for receiving further instructions.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes
        - url.query

  - question: Has the malware received additional commands or payloads after installation reporting?
    context: Installation reports often trigger the delivery of secondary payloads or configuration updates.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.response.body.bytes
        - http.request.method

  # Type 5: Forensic Deep-Dive
  - question: What specific malware family characteristics match this installation reporting pattern?
    context: Different downloader families use unique parameter combinations and reporting mechanisms.
    range: +/-2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.path
        - url.query
        - http.user_agent
        - http.request.body.content

  - question: Are there registry modifications or persistence mechanisms established post-installation?
    context: Successful installation reporting typically precedes persistence establishment and configuration changes.
    range: +6h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - registry.key
        - registry.value.name
        - registry.value.data
        - process.name

  - question: What additional malware components were downloaded following installation confirmation?
    context: Downloaders often fetch additional modules or payloads after confirming successful installation.
    range: +8h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.response.body.bytes
        - file.hash.md5
        - http.request.method

  # Type 6: Enterprise Correlation
  - question: Are other systems reporting installations to the same C2 infrastructure with similar parameters?
    context: Coordinated malware campaigns often show similar installation reporting patterns across multiple hosts.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          url.query|contains: "wmid="
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - url.query
        - http.user_agent