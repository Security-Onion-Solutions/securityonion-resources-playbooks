name: ET MALWARE Common Downloader Install Report URL (pid - mac)
id: 22008183
description: |
  Detects malware downloaders reporting installation status with process ID and MAC address parameters.
  Pattern includes HTML page requests with set, pid, and mac parameters indicating system identification.
  Legitimate applications rarely combine PID and MAC address in installation reporting URLs.
type: detection
detection_id: 2008183
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What were the specific PID and MAC address values reported in the installation URL?
    context: The PID and MAC address combination provides unique system identification and process tracking information.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.full
        - url.query
        - http.request.method

  - question: What does the 'set' parameter indicate about the malware configuration or campaign?
    context: The set parameter often contains configuration identifiers or campaign-specific settings for the malware.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - url.query
        - url.path
        - http.user_agent

  # Type 2: Triage Assessment
  - question: Is this system authorized to report process IDs and MAC addresses to external servers?
    context: Some network management tools may collect system information, but this specific combination is uncommon.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.query|contains: "pid="
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - http.user_agent

  - question: Does this activity correlate with legitimate system monitoring or asset management?
    context: Authorized system reporting would typically use established monitoring protocols and known management servers.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.domain
        - http.user_agent
        - timestamp

  # Type 3: Activity Context
  - question: What process corresponds to the PID reported in the installation URL?
    context: Correlating the reported PID with actual running processes helps identify the malware executable.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - process.name
        - process.pid
        - process.command_line
        - process.parent.name

  - question: What network connection initiated this installation report?
    context: Identifying the originating connection helps determine the communication channel and process responsible.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port|expand: '%dst_port%'
        condition: selection
      fields:
        - process.name
        - process.pid
        - protocol
        - bytes_out

  - question: Are there recent file creation or modification events associated with the reporting process?
    context: Installation reporting suggests recent malware deployment with associated file system changes.
    range: -4h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - file.name
        - file.path
        - file.hash.md5
        - process.name

  # Type 4: Impact Assessment
  - question: Did the malware successfully communicate its installation status to the C2 server?
    context: Successful communication indicates active compromise and potential for receiving further malicious instructions.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.query|contains: "mac="
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes
        - url.query

  - question: Has the malware established persistence mechanisms after installation reporting?
    context: Installation confirmation often triggers persistence establishment and configuration updates.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - registry.key
        - registry.value.name
        - registry.value.data
        - process.name

  # Type 5: Forensic Deep-Dive
  - question: What specific downloader family uses PID and MAC address reporting mechanisms?
    context: Different malware families have unique system identification and reporting patterns for C2 communication.
    range: +/-2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.path
        - url.query
        - http.user_agent
        - http.request.body.content

  - question: Are there additional payload downloads following installation confirmation?
    context: Downloaders typically fetch secondary components after confirming successful installation to C2 servers.
    range: +8h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.response.body.bytes
        - http.request.method
        - file.hash.md5

  - question: What system configuration changes occurred after the installation report?
    context: Successful installation reporting often precedes system modifications and malware configuration.
    range: +6h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - file.name
        - file.path
        - file.extension
        - process.name

  # Type 6: Enterprise Correlation
  - question: Are other hosts reporting similar PID and MAC address combinations to the same C2 infrastructure?
    context: Coordinated malware campaigns often show consistent reporting patterns across multiple infected systems.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          url.query|contains: "pid="
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - url.query
        - http.user_agent