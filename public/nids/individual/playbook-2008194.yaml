name: ET MALWARE Common Downloader Install Report URL (wmid - ucid)
id: 22008194
description: |
  Detects HTTP GET requests with specific parameter patterns commonly used by malware downloaders for installation reporting.
  The combination of parameters (a, k, wmid, ucid) indicates communication with command and control infrastructure.
  Legitimate applications rarely use this exact parameter combination.
type: detection
detection_id: 2008194
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete URL and parameter values in the malware communication?
    context: Analyzing the full URL structure reveals the specific malware family and campaign identifiers.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.full
        - url.query
        - http.request.method
        - http.request.headers.user_agent

  - question: What specific parameter values were transmitted in the wmid and ucid fields?
    context: These parameters often contain unique identifiers that help track malware campaigns and infected systems.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.query|contains:
            - 'wmid='
            - 'ucid='
        condition: selection
      fields:
        - url.query
        - url.path
        - http.request.method

  # Type 2: Triage Assessment
  - question: Is this communication pattern normal for applications on this system?
    context: Legitimate software rarely uses this specific parameter combination for HTTP communications.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.query|contains:
            - '?a='
            - '&k='
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - count

  - question: Does the timing of this activity align with user logon or scheduled tasks?
    context: Malware often communicates immediately after system startup or at regular intervals.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  # Type 3: Activity Context
  - question: What process initiated this HTTP communication?
    context: Identifying the parent process helps determine if this is legitimate software or malware.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - '.exe'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ParentImage
        - ProcessGuid

  - question: What other network connections occurred around the same time from this system?
    context: Malware often makes multiple connections for different purposes like data exfiltration or additional payload downloads.
    range: +/-30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - protocol
        - bytes_sent
        - bytes_received

  # Type 4: Impact Assessment
  - question: Did the malware successfully download additional payloads after this communication?
    context: Successful C2 communication often leads to secondary payload downloads or data exfiltration.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method: 'GET'
        condition: selection
      fields:
        - dst_ip
        - url.full
        - http.response.status_code
        - http.response.body.bytes

  - question: Are there signs of data exfiltration or lateral movement from this system?
    context: Compromised systems often attempt to spread to other network resources or steal sensitive data.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 445
            - 139
            - 3389
            - 22
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - protocol
        - bytes_sent

  # Type 5: Forensic Deep-Dive
  - question: What is the reputation and categorization of the destination domain?
    context: Malware C2 servers often use domains with poor reputation or suspicious registration patterns.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  - question: Are there any file system changes or new executables created after this communication?
    context: Malware often downloads and executes additional components after successful C2 communication.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.extension|contains:
            - '.exe'
            - '.dll'
            - '.bat'
            - '.ps1'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.hash.sha256
        - ProcessGuid

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network showing similar malware communication patterns?
    context: Successful malware campaigns often spread to multiple systems within the same network.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.query|contains:
            - 'wmid='
            - 'ucid='
        condition: selection
      fields:
        - src_ip
        - count
        - url.domain