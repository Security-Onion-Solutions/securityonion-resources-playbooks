name: ET MALWARE ProxyBot Phone Home Traffic
id: 22008244
description: |
  Detects HTTP requests indicating ProxyBot malware command and control communication.
  ProxyBot is malware that turns infected systems into proxy servers for malicious traffic routing.
  The pattern shows infected bots checking in with C2 servers using specific URI parameters.
type: detection
detection_id: 2008244
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the unique bot identifier and parameters in the ProxyBot phone home communication?
    context: The UID parameter uniquely identifies the infected system while other parameters reveal bot capabilities.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.full
        - url.query
        - http.request.method

  - question: What C2 server infrastructure is being used for ProxyBot coordination?
    context: Identifying C2 infrastructure helps understand the botnet scope and threat actor capabilities.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - http.request.headers.host

  # Type 2: Triage Assessment
  - question: Has this system previously communicated with ProxyBot C2 servers?
    context: Historical C2 communication confirms ongoing bot infection and helps establish compromise timeline.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains:
            - "ind.php"
        condition: selection
      fields:
        - dst_ip
        - url.query
        - timestamp

  - question: Is this system exhibiting proxy server behavior consistent with ProxyBot infection?
    context: ProxyBot turns systems into proxy servers, so unusual outbound connection patterns indicate active infection.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - bytes_in

  # Type 3: Activity Context
  - question: What process is responsible for the ProxyBot C2 communication?
    context: Identifying the malware process helps understand infection method and system compromise extent.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ProcessGuid
        - ParentImage

  - question: What network activity preceded this ProxyBot phone home communication?
    context: Previous activity may reveal the initial infection vector or other malware components.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - bytes_in

  # Type 4: Impact Assessment
  - question: What commands or proxy configuration did the C2 server provide to the bot?
    context: C2 responses contain proxy server configuration and commands for malicious traffic routing.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains:
            - "ind.php"
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - http.response.body.bytes

  - question: Is this system actively being used as a proxy server for malicious traffic?
    context: Active proxy usage indicates the bot is operational and potentially facilitating other attacks.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - bytes_in

  # Type 5: Forensic Deep-Dive
  - question: What DNS queries were made to resolve the ProxyBot C2 infrastructure?
    context: DNS patterns help identify the complete botnet infrastructure and potential domain generation algorithms.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.resolved_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  - question: What persistence mechanisms has the ProxyBot malware established?
    context: Understanding persistence helps with complete malware removal and prevents botnet rejoining.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - "Run"
            - "RunOnce"
            - "Services"
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessGuid

  - question: What proxy server configuration files or settings were created?
    context: Proxy configuration reveals the malware's capabilities and how it routes malicious traffic.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.extension|contains:
            - "cfg"
            - "conf"
            - "ini"
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network part of the same ProxyBot botnet?
    context: Multiple bots indicate botnet scope and potential coordinated malicious proxy activity.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          url.path|contains:
            - "ind.php"
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - url.query
        - http.request.headers.user_agent

  - question: Is this part of a broader ProxyBot campaign targeting the organization?
    context: Correlating botnet indicators helps understand campaign scope and potential coordinated attacks.
    range: +/-7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - "ProxyBot"
            - "ind.php"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name