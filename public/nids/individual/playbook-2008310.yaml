name: ET MALWARE Codesoft PW Stealer Email Report Outbound
id: 22008310
description: |
  Detects Codesoft password stealer sending stolen credentials via email to attackers.
  This malware specifically targets Steam gaming platform passwords and other stored credentials.
  Indicates active credential theft with exfiltration of sensitive authentication data.
type: detection
detection_id: 2008310
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What is the complete email content containing the stolen password data?
    context: Analyzing the full email reveals the scope of credential theft and targeted applications.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - email.subject

  - question: What specific credentials and applications are being targeted by the stealer?
    context: The Steam-focused stealer may also target other gaming platforms and stored passwords.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - email.body.content
        - smtp.data
        - packet_info.length

  # Type 2: Triage Assessment
  - question: Is this email transmission from a known malware analysis environment?
    context: Security researchers may intentionally execute password stealers for analysis purposes.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - "sandbox"
            - "analysis"
            - "vm"
        condition: selection
      fields:
        - User
        - Image
        - CommandLine

  - question: Does the infected system show signs of authorized security testing?
    context: Penetration testers may deploy password stealers to demonstrate credential theft risks.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 25
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - connection_state

  # Type 3: Activity Context
  - question: What gaming or credential storage applications are present on the infected system?
    context: Password stealers target specific applications where users store valuable credentials.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - "steam"
            - "discord"
            - "chrome"
            - "firefox"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  - question: What was the initial infection vector for the password stealer?
    context: Understanding the infection method helps prevent similar compromises.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.extension|contains:
            - "exe"
            - "scr"
            - "zip"
        condition: selection
      fields:
        - TargetFilename
        - ProcessName
        - file.hash.md5

  # Type 4: Impact Assessment
  - question: What sensitive files and credential stores were accessed by the stealer?
    context: Password stealers target browser saved passwords, gaming accounts, and cryptocurrency wallets.
    range: +15m
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - "Login Data"
            - "config.vdf"
            - "wallet.dat"
            - "cookies"
        condition: selection
      fields:
        - TargetFilename
        - ProcessName
        - file.size

  - question: Has the stealer successfully exfiltrated additional data beyond passwords?
    context: Modern stealers often collect browser data, cryptocurrency wallets, and personal files.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 25
            - 587
            - 465
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - connection_state

  # Type 5: Forensic Deep-Dive
  - question: What stealer family and capabilities are present on the system?
    context: Different stealer families have varying capabilities and target different credential types.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.extension: "exe"
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.hash.sha256
        - file.size

  - question: What persistence mechanisms has the stealer established?
    context: Stealers may establish persistence to continue harvesting credentials over time.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - "Run"
            - "RunOnce"
            - "Startup"
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessName

  - question: Are there signs of additional malware or attack tools on this system?
    context: Compromised systems often host multiple malware families or serve as beachheads for further attacks.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.category|contains:
            - "A Network Trojan was detected"
            - "Attempted Administrator Privilege Gain"
        condition: selection
      fields:
        - alert.signature
        - dst_ip
        - alert.severity

  # Type 6: Enterprise Correlation
  - question: Are other systems showing similar credential theft activity?
    context: Enterprise-wide stealer infections indicate coordinated credential harvesting campaign.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature_id: 2008310
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature