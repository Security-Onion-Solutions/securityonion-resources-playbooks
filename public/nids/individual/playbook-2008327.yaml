name: ET MALWARE Perfect Keylogger FTP Initial Install Log Upload (Null obfuscated)
id: 22008327
description: |
  Detects Perfect Keylogger malware using null-byte obfuscation to evade detection while uploading installation logs.
  This variant uses Unicode null bytes between characters to bypass simple string detection.
  No legitimate applications use this specific obfuscation pattern.
type: detection
detection_id: 2008327
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete obfuscated payload detected in the FTP communication?
    context: Analyzing the null-byte obfuscation technique reveals evasion sophistication and payload content.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - flow_id
        - app_proto
  - question: Has this system shown other signs of obfuscated malware communications?
    context: Identifying if this is an isolated incident or part of broader evasive malware activity.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'obfuscat'
            - 'Obfuscat'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - app_proto
  - question: What process initiated this obfuscated network communication?
    context: Understanding the parent process helps identify the infection vector and malware execution chain.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'ftp'
            - 'upload'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid
  - question: Are there other network connections using similar obfuscation techniques?
    context: Identifying additional C2 channels and the scope of obfuscated communications.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver
        - app_proto
  - question: Has the obfuscated keylogger established persistence on the infected system?
    context: Determining if the advanced evasive malware has created lasting access mechanisms.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - 'CurrentVersion\Run'
            - 'Services'
        condition: selection
      fields:
        - TargetObject
        - Details
        - Image
  - question: What files were created with potential obfuscated content or names?
    context: Identifying malware components that may use similar obfuscation in file operations.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.mime_type
  - question: Is this obfuscated variant exfiltrating captured keystrokes or other sensitive data?
    context: Assessing ongoing data compromise through obfuscated communication channels.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - bytes_toserver
        - duration
        - app_proto
  - question: Are other systems in the network infected with this obfuscated keylogger variant?
    context: Determining campaign scope and identifying additional compromised endpoints.
    range: -48h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'Perfect Keylogger'
          rule.name|contains: 'obfuscat'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
  - question: What DNS resolution patterns preceded this obfuscated C2 communication?
    context: Understanding infrastructure resolution helps identify related obfuscated malware campaigns.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name
  - question: Has this advanced evasion technique been observed in other malware families on the network?
    context: Identifying if this represents a broader shift to obfuscated communications by threat actors.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'obfuscat'
            - 'Obfuscat'
            - 'evasion'
        condition: selection
      fields:
        - rule.name
        - src_ip
        - rule.category