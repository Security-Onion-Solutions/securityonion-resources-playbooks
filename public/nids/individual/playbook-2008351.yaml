name: ET INFO ICP Email Send via HTTP - Often Trojan Install Reports
id: 22008351
description: |
  Detects HTTP requests to ICP email sending services that are commonly used by trojans for installation reports.
  The pattern matches specific PHP script parameters used for sending notification emails.
  May trigger on legitimate use of ICP email services, though this is uncommon in enterprise environments.
type: detection
detection_id: 2008351
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What specific parameters were included in the email notification request?
    context: Analyzing the complete parameter set reveals what information the malware is reporting back.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.full
        - url.query
        - http.request.method
        - http.request.body.content

  - question: What user and system information is being transmitted in the email parameters?
    context: Trojan installation reports typically contain victim system details and user credentials.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - url.query
        - http.request.headers.user-agent
        - http.request.headers.referer

  - question: Is this a legitimate business use of ICP email services?
    context: Enterprise environments rarely use ICP email services, making this likely malicious activity.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains:
            - "email_thank_you.php"
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - User

  - question: What process or application initiated this email sending request?
    context: Identifying the source process helps determine if this is browser-based or executable-based malware.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - process.executable
        - User

  - question: What malware installation activity preceded this email notification?
    context: Installation reports typically follow malware deployment, helping identify the infection vector.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - file.name
        - file.path
        - file.hash.md5
        - process.name
        - file.size

  - question: Are there signs of data collection or system reconnaissance?
    context: Trojans often gather system information before sending installation reports.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          process.command_line|contains:
            - "systeminfo"
            - "whoami"
            - "ipconfig"
            - "net user"
        condition: selection
      fields:
        - process.command_line
        - process.name
        - process.parent.name
        - User

  - question: What other network communications occurred around the same time?
    context: Malware often establishes multiple connections for C2 communication and data exfiltration.
    range: -30m/+30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.bytes_sent
        - network.bytes_received
        - network.protocol

  - question: Did the server successfully receive and process the installation report?
    context: Successful responses confirm that the attacker received notification of the successful infection.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes
        - http.response.headers.content-type

  - question: Are there registry modifications indicating malware persistence?
    context: Trojans typically establish persistence mechanisms before sending installation reports.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          registry.path|contains:
            - "Run"
            - "RunOnce"
            - "Services"
            - "Startup"
        condition: selection
      fields:
        - registry.path
        - registry.value.name
        - registry.value.data
        - process.name

  - question: What DNS queries were made to resolve the ICP email service domain?
    context: DNS resolution patterns help identify the malware's communication infrastructure.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.resolved_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.question.name
        - dns.question.type
        - dns.answers.data

  - question: Are other hosts in the network sending similar installation reports?
    context: Malware campaigns often affect multiple systems simultaneously through email or exploit kits.
    range: -2h/+2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          url.path|contains:
            - "email_thank_you.php"
          url.query|contains:
            - "folder_id="
            - "params_count="
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - url.domain