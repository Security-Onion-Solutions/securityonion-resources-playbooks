name: ET MALWARE Donkeyp2p Update Detected
id: 22008364
description: |
  Detects communication with Donkeyp2p malware command and control servers during update checks.
  This specific pattern indicates malware attempting to retrieve updates or commands from C2 infrastructure.
  Legitimate applications would not use this specific parameter combination.
type: detection
detection_id: 2008364
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What were the complete URL parameters sent in the Donkeyp2p update request?
    context: The specific parameter values reveal malware version, unique identifier, and requested update type.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - url.query
        - http.request.body.content

  - question: What is the target C2 server domain and IP address for this update attempt?
    context: Identifying the command and control infrastructure helps track malware campaign scope.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - dst_port

  # Type 2: Triage Assessment
  - question: Has this system previously communicated with known Donkeyp2p infrastructure?
    context: Historical communication patterns help determine infection timeline and persistence.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains: "donkeyp2p.php"
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - timestamp

  - question: Are there other systems in the network communicating with this C2 server?
    context: Multiple infected systems indicate broader compromise requiring coordinated response.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - bytes_sent
        - bytes_received

  # Type 3: Activity Context
  - question: What process initiated this malicious HTTP request?
    context: Identifying the parent process reveals the malware executable and infection vector.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid

  - question: What network connections were established around the time of this update attempt?
    context: Concurrent connections may reveal additional C2 communication or lateral movement.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - protocol
        - bytes_sent
        - bytes_received

  - question: Were there any DNS queries for the C2 domain before this connection?
    context: DNS resolution timing helps establish the complete attack timeline.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          dns.query.name|expand: '%url.domain%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  # Type 4: Impact Assessment
  - question: Did the C2 server respond with update content or commands?
    context: Successful C2 communication indicates active malware control and potential payload delivery.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes
        - http.response.body.content

  - question: Has any suspicious file activity occurred on this system recently?
    context: File modifications may indicate malware updates, additional payload downloads, or data collection.
    range: +/-30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.hash.sha256
        - ProcessImage

  # Type 5: Forensic Deep-Dive
  - question: What specific malware variant and version is indicated by the update parameters?
    context: Version information helps identify malware capabilities, known IOCs, and appropriate remediation steps.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - payload
        - http.request.body.content

  # Type 6: Enterprise Correlation
  - question: Are other systems showing similar Donkeyp2p activity patterns across the enterprise?
    context: Enterprise-wide correlation reveals campaign scope and helps prioritize incident response efforts.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Donkeyp2p"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name