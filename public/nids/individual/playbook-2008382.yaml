name: ET MALWARE Piptea.a Related Trojan Checkin (1)
id: 22008382
description: |
  Detects HTTP requests indicating Piptea.a trojan command and control communication.
  The pattern shows infected systems checking in with C2 servers using specific URI structure.
  Legitimate applications would not use this hexadecimal ID and version parameter pattern.
type: detection
detection_id: 2008382
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact hexadecimal ID and version parameter in the C2 communication?
    context: The hex ID uniquely identifies the infected system while version indicates malware variant.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.full
        - url.query
        - http.request.method

  - question: What C2 server domain and IP was contacted?
    context: Identifying the C2 infrastructure helps understand the threat actor's network and campaign scope.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - http.request.headers.host

  # Type 2: Triage Assessment
  - question: Has this system previously communicated with known Piptea.a C2 servers?
    context: Historical C2 communication confirms ongoing infection and helps establish infection timeline.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains:
            - "/cd/cd.php"
        condition: selection
      fields:
        - dst_ip
        - url.query
        - timestamp

  - question: Is this communication pattern consistent with automated malware behavior?
    context: Regular intervals and consistent parameters indicate automated trojan communication versus manual activity.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path: "/cd/cd.php"
        condition: selection
      fields:
        - dst_ip
        - url.query
        - http.request.headers.user_agent

  # Type 3: Activity Context
  - question: What process initiated this C2 communication?
    context: Identifying the malware process helps understand infection method and persistence mechanisms.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ProcessGuid
        - ParentImage

  - question: What other network connections occurred around the same time?
    context: Concurrent connections may reveal additional C2 channels or lateral movement attempts.
    range: +/-15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - bytes_in

  # Type 4: Impact Assessment
  - question: What response did the C2 server provide to the infected system?
    context: C2 responses may contain commands, updates, or additional payloads for the compromised system.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path: "/cd/cd.php"
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - http.response.body.bytes

  - question: Are there signs of additional payload downloads or command execution?
    context: C2 communication often leads to secondary payload downloads or remote command execution.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ProcessGuid
        - User

  # Type 5: Forensic Deep-Dive
  - question: What DNS queries were made to resolve the C2 domain?
    context: DNS resolution patterns help identify the C2 infrastructure and potential domain generation algorithms.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.resolved_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  - question: What persistence mechanisms has the Piptea.a malware established?
    context: Understanding persistence helps with complete malware removal and prevents reinfection.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - "Run"
            - "RunOnce"
            - "Services"
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessGuid

  # Type 6: Enterprise Correlation
  - question: Are other systems showing similar Piptea.a C2 communication patterns?
    context: Multiple infected systems indicate campaign scope and potential lateral movement within the network.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          url.path: "/cd/cd.php"
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - url.query
        - http.request.headers.user_agent

  - question: Is this part of a broader Piptea.a infection campaign across the organization?
    context: Correlating similar malware indicators helps identify campaign timeline and additional compromised assets.
    range: +/-7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - "Piptea"
            - "/cd/cd.php"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name