name: ET MALWARE Piptea.a Related Trojan Checkin (2)
id: 22008383
description: |
  Detects HTTP requests indicating Piptea.a trojan command and control communication via un2.php endpoint.
  This represents an alternate C2 channel for the same malware family using different URI structure.
  Legitimate applications would not use this hexadecimal ID and version parameter pattern.
type: detection
detection_id: 2008383
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact hexadecimal ID and version parameter in this alternate C2 communication?
    context: The hex ID and version help correlate this activity with other Piptea.a communications and variants.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.full
        - url.query
        - http.request.method

  - question: How does this un2.php endpoint differ from the standard cd.php C2 channel?
    context: Understanding different C2 endpoints reveals malware capabilities and redundant communication channels.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - dst_ip
        - url.path
        - url.domain

  # Type 2: Triage Assessment
  - question: Has this system used both cd.php and un2.php C2 endpoints?
    context: Multiple C2 endpoints from the same system confirm active Piptea.a infection with redundant channels.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains:
            - "/cd/cd.php"
            - "/cd/un2.php"
        condition: selection
      fields:
        - dst_ip
        - url.path
        - url.query

  - question: Is the communication frequency consistent with automated malware behavior?
    context: Regular communication intervals indicate automated trojan activity rather than manual reconnaissance.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path: "/cd/un2.php"
        condition: selection
      fields:
        - dst_ip
        - url.query
        - timestamp

  # Type 3: Activity Context
  - question: What process is responsible for this alternate C2 communication channel?
    context: Identifying the malware process helps understand if this is the same or different Piptea.a variant.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ProcessGuid
        - ParentImage

  - question: What triggered the switch to this alternate C2 endpoint?
    context: Understanding why the malware switched endpoints reveals its resilience and failover mechanisms.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains:
            - "/cd/"
        condition: selection
      fields:
        - dst_ip
        - url.path
        - http.response.status_code

  # Type 4: Impact Assessment
  - question: What commands or payloads were received via this un2.php channel?
    context: Different C2 endpoints may serve different purposes like command delivery versus data exfiltration.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path: "/cd/un2.php"
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - http.response.body.bytes

  - question: Are there signs of data exfiltration or additional malware downloads via this channel?
    context: Alternate C2 channels may be used for specific functions like data theft or payload delivery.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - bytes_out
        - bytes_in
        - duration

  # Type 5: Forensic Deep-Dive
  - question: How does the malware determine which C2 endpoint to use?
    context: Understanding endpoint selection logic reveals malware sophistication and anti-detection measures.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.resolved_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.response_code

  - question: What configuration or state files does the malware maintain for C2 communication?
    context: Configuration files reveal C2 infrastructure, communication schedules, and malware capabilities.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.extension|contains:
            - "cfg"
            - "dat"
            - "tmp"
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size

  - question: Are there indicators of the malware updating its C2 configuration?
    context: Configuration updates indicate active threat actor management and potential infrastructure changes.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessGuid

  # Type 6: Enterprise Correlation
  - question: Are other systems using the same un2.php C2 endpoint?
    context: Multiple systems using the same endpoint indicates campaign scope and shared C2 infrastructure.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          url.path: "/cd/un2.php"
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - url.query
        - http.request.headers.user_agent

  - question: Is this part of a coordinated Piptea.a campaign using multiple C2 channels?
    context: Correlating different C2 endpoints helps understand campaign infrastructure and redundancy measures.
    range: +/-7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - "Piptea"
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - rule.name
        - url.path