name: ET MALWARE Rouge Security Software Win32.BHO.egw
id: 22008461
description: |
  Detects HTTP GET requests associated with Win32.BHO.egw rogue security software.
  This malware masquerades as legitimate security software while performing malicious activities.
  May trigger on legitimate applications using similar affiliate tracking parameters.
type: detection
detection_id: 2008461
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What were the specific affiliate and tracking parameters in the rogue security software request?
    context: The affid, subid, guid, ver, and key parameters reveal the malware campaign and variant details.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - url.query
        - rule.name

  - question: What was the complete URL structure and PHP endpoint targeted?
    context: Understanding the full request helps identify the rogue security software's command infrastructure.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - url.full
        - url.path
        - url.domain
        - http.request.headers

  # Type 2: Triage Assessment
  - question: Is this system known to run legitimate software with similar affiliate tracking patterns?
    context: Legitimate software may use affid and subid parameters for affiliate marketing tracking.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method: "GET"
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - url.query

  - question: Does this request align with normal user browsing behavior?
    context: User-initiated browsing would suggest potential false positive rather than automated malware behavior.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - http.request.method
        - url.domain

  # Type 3: Activity Context
  - question: What process initiated this rogue security software communication?
    context: Identifying the parent process helps determine if this is malware execution or legitimate application.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ProcessGuid
        - ParentImage

  - question: Were there recent security software installations or updates on this system?
    context: Recent security software activity might indicate legitimate updates versus rogue software installation.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ProcessGuid

  - question: What other network connections were made around this time?
    context: Additional connections may reveal the full scope of rogue security software communication.
    range: +/-15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - protocol
        - bytes_in

  # Type 4: Impact Assessment
  - question: Did the rogue security software server respond with configuration or update data?
    context: Successful responses may indicate system compromise and receipt of malicious instructions.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - bytes_in

  - question: What volume of data was exchanged in this rogue security software communication?
    context: Large data transfers may indicate payload downloads or extensive system information exfiltration.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - bytes_in
        - bytes_out
        - duration

  # Type 5: Forensic Deep-Dive
  - question: Are there signs of fake security software installation or execution after this request?
    context: Rogue security software typically installs fake antivirus or system optimization tools.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessGuid

  - question: Were there registry modifications consistent with rogue security software installation?
    context: Fake security software often modifies registry to appear legitimate and establish persistence.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessGuid

  # Type 6: Enterprise Correlation
  - question: Are other systems showing similar rogue security software communication patterns?
    context: Identifying additional infected systems helps determine campaign scope and containment strategy.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Rouge Security Software"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name