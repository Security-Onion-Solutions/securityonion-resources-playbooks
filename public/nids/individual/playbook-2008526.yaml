name: ET SCAN Smap VOIP Device Scan
id: 22008526
description: |
  Detects Smap tool scanning for VoIP-enabled devices on SIP port 5060.
  This tool specifically targets SIP services to enumerate VoIP infrastructure.
  May trigger on legitimate SIP testing tools or network diagnostics.
type: detection
detection_id: 2008526
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete SIP message containing the smap signature?
    context: Analyzing the full SIP packet reveals the scanning tool's fingerprint and target enumeration method.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - app_proto

  - question: What specific SIP method was used in the scanning attempt?
    context: Different SIP methods indicate various reconnaissance techniques and tool capabilities.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_port
        - dst_port
        - proto

  # Type 2: Triage Assessment
  - question: Is this source IP conducting legitimate SIP communications with our VoIP infrastructure?
    context: Distinguishing between authorized VoIP testing and malicious reconnaissance activities.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 5060
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - bytes_toclient

  - question: Are there any registered SIP devices or services on the targeted system?
    context: Determining if the target is a legitimate VoIP endpoint or unexpected service exposure.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 5060
        condition: selection
      fields:
        - src_ip
        - proto
        - conn_state

  # Type 3: Activity Context
  - question: What other scanning activity originated from this source around the same time?
    context: VoIP scanners often perform comprehensive network reconnaissance beyond just SIP services.
    range: +/-15m
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - 'SCAN'
            - 'RECON'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - dst_port

  - question: Was this part of a broader port scan targeting multiple VoIP-related services?
    context: Attackers often scan multiple VoIP ports (5060, 5061, 1720) during reconnaissance.
    range: +/-30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 5060
            - 5061
            - 1720
            - 2000
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - conn_state

  # Type 4: Impact Assessment
  - question: Did any targeted systems respond with SIP registration or capability information?
    context: Successful responses indicate exposed VoIP services that could be further exploited.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
          dst_port|expand: '%src_port%'
        condition: selection
      fields:
        - bytes_toclient
        - conn_state
        - duration

  - question: Are there signs of follow-up exploitation attempts against discovered VoIP services?
    context: Successful reconnaissance often leads to authentication attacks or service exploitation.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.category|contains:
            - 'ATTACK'
            - 'EXPLOIT'
        condition: selection
      fields:
        - rule.name
        - rule.category

  # Type 5: Forensic Deep-Dive
  - question: What VoIP scanning tools or frameworks match this traffic pattern?
    context: Identifying specific tools helps understand attacker capabilities and likely next steps.
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'VOIP'
            - 'SIP'
            - 'Smap'
        condition: selection
      fields:
        - rule.name
        - rule.signature_id

  - question: What is the geographic origin and reputation of the scanning source?
    context: Understanding attacker infrastructure helps assess threat level and attribution.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - src_ip
        - geoip.country_name
        - geoip.city_name

  # Type 6: Enterprise Correlation
  - question: Are other internal VoIP systems experiencing similar scanning activity?
    context: Coordinated scanning across multiple VoIP endpoints indicates systematic reconnaissance.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.signature_id: 2008526
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - count

  - question: Is this scanning activity part of a broader campaign targeting our organization's communication infrastructure?
    context: VoIP attacks often coincide with other communication system targeting for comprehensive compromise.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.category|contains:
            - 'SCAN'
            - 'RECON'
          dst_port|contains:
            - 25
            - 110
            - 143
            - 993
            - 995
            - 5060
            - 5061
        condition: selection
      fields:
        - src_ip
        - dst_port
        - rule.name