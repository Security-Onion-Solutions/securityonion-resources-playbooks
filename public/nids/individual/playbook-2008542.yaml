name: ET SCADA CitectSCADA ODBC Overflow Attempt
id: 22008542
description: |
  Detects buffer overflow exploitation attempts against CitectSCADA ODBC service on port 20222 (CVE-2008-2639).
  This vulnerability allows remote code execution in industrial control systems through malformed ODBC requests.
  May trigger on legitimate large ODBC queries, though packets over 399 bytes to port 20222 are highly suspicious.
type: detection
detection_id: 2008542
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact size and content of the malformed ODBC request?
    context: Analyzing the overflow payload reveals the exploitation technique and potential shellcode being deployed.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - packet_size
        - dsize

  - question: What is the source of this CitectSCADA exploitation attempt?
    context: Identifying the attacker's location helps understand if this is external threat or insider attack on SCADA systems.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_port
        - dst_port

  # Type 2: Triage Assessment
  - question: Is this system a legitimate CitectSCADA server that would be vulnerable to CVE-2008-2639?
    context: Confirming the target runs CitectSCADA helps validate this is a real attack versus false positive.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 20222
        condition: selection
      fields:
        - src_ip
        - service
        - bytes_toserver
        - conn_state

  - question: Are there legitimate ODBC operations on this SCADA system that might generate large packets?
    context: Understanding normal ODBC usage patterns helps distinguish between legitimate operations and exploitation.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 20222
        condition: selection
      fields:
        - src_ip
        - bytes_toserver
        - duration
        - conn_state

  # Type 3: Activity Context
  - question: What reconnaissance activity preceded this SCADA exploitation attempt?
    context: Attackers often scan for SCADA services before launching CVE-2008-2639 exploits.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - service
        - conn_state
        - duration

  - question: Has this source attempted to connect to other SCADA-related ports?
    context: Multiple SCADA port connections indicate systematic targeting of industrial control systems.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 502
            - 20222
            - 44818
            - 789
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - service
        - conn_state

  - question: What was the timing pattern of connections to this SCADA system?
    context: Rapid successive connections may indicate automated exploitation tools targeting industrial systems.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - conn_state
        - duration

  # Type 4: Impact Assessment
  - question: Did the CitectSCADA system respond to the buffer overflow attempt?
    context: Response patterns help determine if the exploit was successful or if the system crashed.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - bytes_toserver
        - bytes_toclient
        - conn_state
        - duration

  - question: Are there signs of successful compromise of the SCADA system following this exploit?
    context: Successful CVE-2008-2639 exploitation may lead to unauthorized SCADA control or data theft.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - service
        - bytes_toserver

  # Type 5: Forensic Deep-Dive
  - question: What specific CVE-2008-2639 exploit variant was used based on payload analysis?
    context: Different exploit variants have distinct payload signatures that reveal the attack tool used.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - "CVE-2008-2639"
            - "CitectSCADA"
            - "ODBC"
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - severity

  - question: Are there other SCADA-related exploitation attempts from this source?
    context: Multiple SCADA exploits indicate persistent targeting of industrial control infrastructure.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - "SCADA"
            - "Industrial"
            - "Modbus"
            - "DNP3"
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - severity

  # Type 6: Enterprise Correlation
  - question: Are other SCADA systems in the network being targeted with similar exploits?
    context: Enterprise-wide SCADA targeting suggests coordinated attacks against critical infrastructure.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - "SCADA"
            - "CVE-2008-2639"
            - "CitectSCADA"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - severity

  - question: What other industrial control systems are present in the network that may be at risk?
    context: Identifying additional SCADA systems helps assess the scope of potential industrial infrastructure compromise.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_port|contains:
            - 502
            - 20222
            - 44818
            - 789
            - 2404
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - service
        - src_ip