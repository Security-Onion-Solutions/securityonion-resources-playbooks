name: ET SCAN NNG MS02-039 Exploit False Positive Generator - May Conceal A Genuine Attack
id: 22008560
description: |
  Detects NNG (Nessus/Nmap/Generic) scanner generating false positives for MS02-039 vulnerability.
  This tool can be used to mask genuine attacks by flooding IDS with false alerts.
  May indicate reconnaissance activity or attempt to evade detection systems.
type: detection
detection_id: 2008560
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What is the complete UDP payload content that triggered this NNG detection?
    context: Analyzing the full payload reveals the specific NNG scanner signature and potential masking technique.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - packet_info.length

  - question: What specific MS02-039 vulnerability patterns are being mimicked?
    context: Understanding the false positive generation helps identify if this is masking real exploitation attempts.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - alert.signature
        - alert.metadata
        - flow.bytes_toclient

  # Type 2: Triage Assessment
  - question: Is this activity from a known security scanner or penetration testing tool?
    context: Legitimate security testing may use NNG tools, requiring verification with security team.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          protocol: UDP
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver

  - question: Does the timing align with scheduled vulnerability assessments?
    context: Authorized scanning activities should correlate with documented security testing schedules.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.category: "Attempted Information Leak"
        condition: selection
      fields:
        - alert.signature
        - dst_ip
        - dst_port

  # Type 3: Activity Context
  - question: What other scanning activity preceded this NNG detection?
    context: NNG tools are often part of broader reconnaissance campaigns targeting multiple services.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.category|contains:
            - "Attempted Information Leak"
            - "Network Scan"
        condition: selection
      fields:
        - alert.signature
        - dst_ip
        - dst_port

  - question: Are there multiple UDP 1434 connections from this source?
    context: Repeated connections to SQL Server port 1434 may indicate systematic database server discovery.
    range: -15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 1434
          protocol: UDP
        condition: selection
      fields:
        - dst_ip
        - connection_state
        - bytes_toserver

  # Type 4: Impact Assessment
  - question: Did any systems respond to the false positive generation attempts?
    context: Systems responding to NNG probes may indicate vulnerable SQL Server installations.
    range: +5m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
          src_port: 1434
          protocol: UDP
        condition: selection
      fields:
        - src_ip
        - bytes_toclient
        - connection_state

  - question: Are there signs of successful SQL Server exploitation following this activity?
    context: NNG may mask real exploitation attempts against vulnerable SQL Server instances.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          alert.category|contains:
            - "A Network Trojan was detected"
            - "Attempted Administrator Privilege Gain"
        condition: selection
      fields:
        - alert.signature
        - src_ip
        - alert.severity

  # Type 5: Forensic Deep-Dive
  - question: What is the source IP's reputation and geolocation?
    context: NNG scanning from suspicious geographic locations or known malicious IPs indicates threat activity.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - geoip.country_name
        - geoip.city_name
        - threat_intel.ioc_value

  - question: Are there other reconnaissance tools being used from this source?
    context: Multiple scanning tools from same source indicates organized reconnaissance campaign.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains:
            - "scan"
            - "reconnaissance"
            - "probe"
        condition: selection
      fields:
        - alert.signature
        - dst_ip
        - dst_port

  # Type 6: Enterprise Correlation
  - question: Are other internal systems being targeted with similar NNG activity?
    context: Enterprise-wide NNG scanning indicates coordinated reconnaissance of SQL Server infrastructure.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature_id: 2008560
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature