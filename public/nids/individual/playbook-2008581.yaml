name: ET P2P BitTorrent DHT ping request
id: 22008581
description: |
  Detects BitTorrent DHT ping requests used for peer discovery in P2P networks.
  This may indicate policy violations if P2P traffic is prohibited, but could be legitimate file sharing activity.
type: detection
detection_id: 2008581
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete DHT ping request structure and node ID?
    context: The DHT ping request contains the node ID and protocol version which identifies the BitTorrent client.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - network.bytes
        - src_port
        - dst_port

  - question: Is P2P traffic authorized for this user or system?
    context: Some organizations allow P2P traffic for legitimate business purposes or specific user groups.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 6881
            - 6882
            - 6883
            - 6884
            - 6885
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.bytes

  - question: What BitTorrent client software is generating this traffic?
    context: Different BitTorrent clients have distinct DHT implementation patterns that can be identified.
    range: +/-30m
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - "torrent"
            - "utorrent"
            - "bittorrent"
            - "deluge"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: What other DHT protocol activity is occurring from this source?
    context: DHT ping requests are typically part of larger P2P communication patterns including announces and queries.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          network.protocol: "udp"
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.bytes

  - question: Are there signs of large-scale file transfer activity?
    context: DHT ping requests often precede actual file transfers, indicating active P2P file sharing.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          network.bytes: ">1000000"
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.bytes
        - network.protocol

  - question: What DNS queries were made to resolve DHT bootstrap nodes?
    context: BitTorrent clients query DNS for bootstrap nodes to join the DHT network.
    range: -15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.query.name|contains:
            - "dht"
            - "bootstrap"
            - "tracker"
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  - question: What files are being accessed by the P2P application?
    context: P2P applications access torrent files and downloaded content that may violate organizational policies.
    range: +/-30m
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - ".torrent"
            - "downloads"
            - "incomplete"
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - User
        - ProcessName

  - question: Are there indicators of copyrighted content being shared?
    context: P2P traffic may involve copyright infringement which poses legal risks to the organization.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - ".mp4"
            - ".avi"
            - ".mkv"
            - ".mp3"
            - ".flac"
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - User

  - question: What bandwidth consumption patterns are associated with this activity?
    context: P2P traffic can consume significant bandwidth impacting business operations and network performance.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - network.bytes
        - network.protocol

  - question: Are other systems in the network engaging in similar P2P activity?
    context: P2P usage may be widespread across the organization requiring policy enforcement measures.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "BitTorrent"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name