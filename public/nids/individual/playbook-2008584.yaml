name: ET P2P BitTorrent DHT get_peers request
id: 22008584
description: |
  Detects BitTorrent DHT get_peers requests used for peer discovery in torrent swarms.
  May indicate unauthorized P2P file sharing violating organizational policy.
  Could represent legitimate BitTorrent usage or distributed application protocols.
type: detection
detection_id: 2008584
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What is the exact BitTorrent DHT get_peers request payload?
    context: Analyzing the bencode payload reveals the info_hash and target content being sought.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - src_port
        - dst_port

  - question: Is BitTorrent usage authorized for this user or system?
    context: Determines if DHT peer discovery violates security policy or acceptable use guidelines.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          protocol: UDP
          dst_port|contains:
            - 6881
            - 6889
            - 8080
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out

  - question: What BitTorrent client is performing DHT peer discovery?
    context: Identifies the specific P2P application making DHT requests for content discovery.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - utorrent
            - bittorrent
            - qbittorrent
            - transmission
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  - question: How many DHT get_peers requests has this system made recently?
    context: High request frequency indicates active torrent participation and content seeking.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "BitTorrent DHT get_peers"
        condition: selection
      fields:
        - dst_ip
        - rule.name

  - question: What DHT nodes is this system querying for peer information?
    context: DHT node contacts reveal P2P network participation and distributed hash table usage.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          protocol: UDP
          dst_port|contains:
            - 6881
            - 6889
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out

  - question: Are there subsequent peer connections following DHT discovery?
    context: TCP connections after DHT queries indicate successful peer discovery and potential file transfer.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          protocol: TCP
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_in
        - bytes_out

  - question: What torrent files or magnet links has this system accessed?
    context: Torrent metadata reveals specific content being downloaded and potential copyright issues.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - .torrent
            - magnet
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - User

  - question: Has this system visited BitTorrent tracker or indexing websites?
    context: Web activity indicates intentional torrent discovery and potential copyright violation.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.domain|contains:
            - thepiratebay
            - kickass
            - torrentz
            - tracker
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.response.status_code

  - question: What DNS queries for BitTorrent infrastructure originated from this system?
    context: DNS lookups reveal tracker discovery and DHT bootstrap node resolution.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.query.name|contains:
            - tracker
            - dht
            - torrent
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  - question: Are multiple systems performing BitTorrent DHT requests?
    context: Widespread DHT activity may indicate coordinated P2P usage or malware distribution.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "BitTorrent DHT"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: What is the content and bandwidth impact of this BitTorrent activity?
    context: Transfer volume analysis reveals network resource consumption and content distribution scale.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          protocol: TCP
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_in
        - bytes_out
        - duration

  - question: Are there signs of torrent seeding activity from this system?
    context: Outbound transfer patterns may indicate content distribution and potential copyright violation.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          protocol: TCP
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - duration