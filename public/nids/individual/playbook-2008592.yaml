name: ET MALWARE Nbar.co.kr Related Trojan Checkin
id: 22008592
description: |
  Detects HTTP communication patterns associated with Nbar.co.kr related trojans.
  This malware transmits system information including MAC address, OS version, and IE version.
  May trigger on legitimate applications collecting similar system information.
type: detection
detection_id: 2008592
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What system information was transmitted in the malware check-in request?
    context: The nid_mac, nid_os_ver, and nid_ie_ver parameters contain sensitive system fingerprinting data.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.full
        - url.query
        - http.request.method
        - http.request.body.content

  - question: What specific MAC address and system details were exfiltrated?
    context: Understanding what system information was compromised helps assess the scope of data exposure.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - url.query
        - http.request.headers
        - http.response.status_code

  # Type 2: Triage Assessment
  - question: Is this system information collection part of legitimate IT asset management?
    context: Some legitimate applications collect similar system information for inventory or compliance purposes.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.query|contains:
            - "mac"
            - "os_ver"
            - "ie_ver"
        condition: selection
      fields:
        - dst_ip
        - url.path
        - http.request.method

  - question: Are there authorized applications that transmit system information to external hosts?
    context: Distinguishing between malware and legitimate system monitoring tools is crucial for accurate assessment.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          Hostname|expand: '%src_ip%'
          CommandLine|contains:
            - "systeminfo"
            - "wmic"
            - "getmac"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  # Type 3: Activity Context
  - question: What process initiated this system information collection and transmission?
    context: Identifying the source process helps determine if this is malware execution or legitimate software.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          Hostname|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid

  - question: What network activity preceded this malware check-in?
    context: Previous connections may reveal initial infection vectors or other malware components.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - protocol
        - bytes_received

  - question: Are there other malware indicators associated with Nbar.co.kr campaigns?
    context: This malware may be part of a larger campaign with multiple components requiring comprehensive analysis.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "Nbar"
            - "MALWARE"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - alert.severity

  # Type 4: Impact Assessment
  - question: Did the malware successfully transmit system information to the command-and-control server?
    context: HTTP response codes indicate whether sensitive system data was successfully exfiltrated.
    range: +10m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - http.response.headers

  - question: What additional data or commands were received after the initial check-in?
    context: Successful system profiling often leads to additional payload downloads or command execution.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.request.method
        - http.response.status_code

  # Type 5: Forensic Deep-Dive
  - question: What specific Nbar.co.kr malware variant is indicated by this communication pattern?
    context: Different variants have distinct capabilities and require tailored remediation approaches.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category: "command-and-control"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - alert.signature_id

  - question: What persistence mechanisms and system modifications has this malware made?
    context: Understanding system changes helps with complete malware removal and damage assessment.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: registry_event
      detection:
        selection:
          Hostname|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetObject
        - Details
        - EventType

  # Type 6: Enterprise Correlation
  - question: Are other systems showing similar Nbar.co.kr related malware activity?
    context: Identifying additional infected systems helps scope the incident and prevent further spread.
    range: +/-8h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: "ET MALWARE Nbar.co.kr Related Trojan Checkin"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.severity

  - question: Is this system information exfiltration part of a broader reconnaissance campaign?
    context: System profiling often precedes targeted attacks requiring comprehensive threat hunting.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.category: "command-and-control"
        condition: selection
      fields:
        - src_ip
        - rule.name
        - alert.severity