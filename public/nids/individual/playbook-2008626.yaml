name: ET MALWARE PlayMP3z.biz Related Spyware/Trojan Install Report
id: 22008626
description: |
  Detects HTTP requests indicating spyware/trojan installation reporting to PlayMP3z.biz infrastructure.
  The pattern shows malware reporting successful installation with campaign tracking parameters.
  Legitimate software would not use this specific parameter structure for installation reporting.
type: detection
detection_id: 2008626
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What application, campaign, and version information was reported in the installation?
    context: These parameters reveal the specific malware variant, distribution campaign, and tracking codes used.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.full
        - url.query
        - http.request.method

  - question: What setup stage and activation code were transmitted?
    context: Stage and code parameters indicate installation progress and unique system identifiers for tracking.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - http.request.headers.user_agent

  # Type 2: Triage Assessment
  - question: Has this system previously contacted PlayMP3z.biz or related infrastructure?
    context: Previous contact with malware infrastructure indicates ongoing infection or repeated exposure attempts.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.domain|contains:
            - "playmp3z.biz"
        condition: selection
      fields:
        - dst_ip
        - url.path
        - url.query

  - question: Is this installation report consistent with user-initiated software installation?
    context: Timing and context help distinguish between legitimate software installation and malware deployment.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - "setup.exe"
            - "install.exe"
            - "msiexec.exe"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  # Type 3: Activity Context
  - question: What process or installer triggered this installation report?
    context: Identifying the installation process helps understand the malware delivery mechanism and entry point.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ProcessGuid
        - ParentImage

  - question: What file downloads or installations occurred before this report?
    context: Previous activity reveals the malware delivery chain and initial compromise vector.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.response.status_code: 200
        condition: selection
      fields:
        - url.full
        - http.response.body.bytes
        - http.response.headers.content_type

  # Type 4: Impact Assessment
  - question: What response did the malware control server provide to the installation report?
    context: Server responses may contain additional commands, configuration updates, or secondary payloads.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - http.response.body.bytes

  - question: Are there signs of spyware functionality activation after the installation report?
    context: Post-installation activity indicates successful malware deployment and active threat presence.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ProcessGuid
        - User

  # Type 5: Forensic Deep-Dive
  - question: What DNS queries were made to resolve the PlayMP3z.biz infrastructure?
    context: DNS resolution patterns help identify the complete malware infrastructure and potential domain rotation.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.query.name|contains:
            - "playmp3z.biz"
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  - question: What files were created or modified during the spyware installation?
    context: File system changes reveal the complete malware installation footprint and persistence mechanisms.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size
        - file.mime_type

  - question: What registry modifications were made to establish persistence?
    context: Registry changes indicate how the malware maintains persistence and what system functions it hooks.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - "Run"
            - "RunOnce"
            - "Services"
            - "Winlogon"
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessGuid

  # Type 6: Enterprise Correlation
  - question: Are other systems reporting installations to the same PlayMP3z.biz campaign?
    context: Multiple installation reports indicate campaign scope and potential organization-wide compromise.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          url.query|contains:
            - "stage=setup"
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - url.query
        - http.request.headers.user_agent

  - question: Is this part of a broader spyware distribution campaign across the organization?
    context: Correlating installation reports helps identify campaign timeline, distribution method, and affected systems.
    range: +/-7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - "PlayMP3z"
            - "stage=setup"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name