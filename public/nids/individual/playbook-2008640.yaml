name: ET SCAN SIP erase_registrations/add registrations attempt
id: 22008640
description: |
  Detects SIP REGISTER requests with "Hacker" user agent attempting to manipulate registrations.
  This indicates attempts to erase existing registrations or add unauthorized ones.
  May trigger on legitimate SIP testing tools that use generic user agent strings.
type: detection
detection_id: 2008640
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete SIP REGISTER message with the "Hacker" user agent?
    context: Analyzing the full registration request reveals the manipulation intent and target accounts.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - app_proto
        - flow.pkts_toserver

  - question: What specific SIP registration parameters were being manipulated in this attempt?
    context: Understanding registration details reveals whether this targets specific accounts or performs bulk operations.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - bytes_toserver
        - flow.pkts_toserver

  # Type 2: Triage Assessment
  - question: Is this source authorized to perform SIP registration management on our systems?
    context: Distinguishing between legitimate administrative tools and malicious registration manipulation.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 5060
        condition: selection
      fields:
        - dst_ip
        - conn_state
        - bytes_toclient

  - question: Are there any documented SIP administration activities scheduled for this timeframe?
    context: Legitimate registration management may use tools with generic user agent strings.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - 'SIP'
            - 'REGISTER'
        condition: selection
      fields:
        - src_ip
        - rule.name
        - count

  # Type 3: Activity Context
  - question: What SIP reconnaissance or enumeration preceded this registration manipulation attempt?
    context: Registration attacks typically follow user enumeration or service discovery activities.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category: 'SCAN'
          rule.name|contains:
            - 'SIP'
            - 'VOIP'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.signature_id

  - question: Were there multiple registration manipulation attempts targeting different accounts or services?
    context: Bulk registration attacks indicate systematic attempts to disrupt VoIP service availability.
    range: +/-30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 5060
        condition: selection
      fields:
        - dst_ip
        - flow.pkts_toserver
        - bytes_toserver

  - question: What was the response pattern from the SIP server to these registration requests?
    context: Server responses indicate whether the manipulation attempts were successful or blocked.
    range: +15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
          src_port: 5060
        condition: selection
      fields:
        - bytes_toclient
        - conn_state
        - duration

  # Type 4: Impact Assessment
  - question: Were any legitimate SIP registrations successfully erased or modified?
    context: Successful registration manipulation can disrupt VoIP service for legitimate users.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 5060
        condition: selection
      fields:
        - src_ip
        - conn_state
        - bytes_toclient

  - question: Are there signs of unauthorized SIP registrations being established from external sources?
    context: Successful registration addition allows attackers to make unauthorized calls or intercept communications.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - 'SIP'
            - 'VOIP'
            - 'unauthorized'
        condition: selection
      fields:
        - src_ip
        - rule.name
        - rule.category

  # Type 5: Forensic Deep-Dive
  - question: What specific SIP hacking tools or frameworks match this registration manipulation pattern?
    context: Identifying the tool helps understand attacker capabilities and likely next steps.
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'Hacker'
            - 'SIP'
            - 'registration'
        condition: selection
      fields:
        - rule.name
        - rule.signature_id
        - rule.rev

  - question: What is the infrastructure profile and geographic origin of this registration attack?
    context: Understanding attacker infrastructure helps assess threat level and potential attribution.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - src_ip
        - geoip.country_name
        - geoip.asn
        - geoip.city_name

  # Type 6: Enterprise Correlation
  - question: Are other SIP servers in our network experiencing similar registration manipulation attempts?
    context: Coordinated registration attacks indicate systematic targeting of VoIP infrastructure.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.signature_id: 2008640
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - count

  - question: Is this SIP registration attack part of broader VoIP or communication system targeting?
    context: Registration manipulation often occurs alongside other VoIP attacks for comprehensive service disruption.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.category|contains:
            - 'SCAN'
            - 'ATTACK'
          dst_port|contains:
            - 5060
            - 5061
            - 1720
            - 2000
        condition: selection
      fields:
        - src_ip
        - dst_port
        - rule.name