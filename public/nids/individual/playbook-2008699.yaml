name: ET NETBIOS Microsoft Windows NETAPI Stack Overflow Inbound - MS08-067 (10)
id: 22008699
description: |
  Detects MS08-067 NETAPI stack overflow exploitation attempts via UDP NetBIOS.
  This critical vulnerability allows remote code execution through malformed path traversal sequences.
  Legitimate NetBIOS traffic should not contain these specific exploit patterns.
type: detection
detection_id: 2008699
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete UDP NetBIOS payload containing the exploit signature?
    context: Analyzing the raw payload reveals the specific exploit variant and shellcode used.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - src_ip
        - dst_ip
        - dst_port

  - question: Is this system normally accessed via NetBIOS from this source IP?
    context: Legitimate NetBIOS access patterns help distinguish authorized administration from exploitation.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 139
        condition: selection
      fields:
        - src_ip
        - bytes_toserver
        - bytes_toclient

  - question: What NetBIOS session activity preceded this exploitation attempt?
    context: Understanding the session establishment reveals if this was targeted or opportunistic scanning.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 139
        condition: selection
      fields:
        - timestamp
        - conn_state
        - duration
        - bytes_toserver

  - question: Has the target system shown signs of successful compromise?
    context: Post-exploitation activity indicates if the vulnerability was successfully leveraged.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - User

  - question: What other MS08-067 exploitation signatures were detected from this source?
    context: Multiple exploit variants suggest persistent targeting or automated exploitation tools.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: 'MS08-067'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - dst_port

  - question: Are there network connections to known malicious infrastructure from the target?
    context: Successful exploitation often results in command and control communications.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toclient
        - conn_state

  - question: What file system activity occurred on the target system after the exploit?
    context: Successful exploitation typically results in file drops, execution, or persistence mechanisms.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size

  - question: Has this source IP targeted other systems with similar exploitation attempts?
    context: Understanding attack scope helps determine if this is part of a broader campaign.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: 'NETAPI Stack Overflow'
        condition: selection
      fields:
        - dst_ip
        - rule.name

  - question: What authentication attempts were made from this source before the exploit?
    context: Failed authentication often precedes exploitation attempts in lateral movement scenarios.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 445
            - 139
            - 135
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - conn_state
        - duration

  - question: Are there indicators of lateral movement from the compromised system?
    context: Successful exploitation may lead to further network compromise and privilege escalation.
    range: +6h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 445
            - 139
            - 135
            - 3389
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver
        - conn_state

  - question: What other systems in the network are vulnerable to MS08-067?
    context: Identifying vulnerable systems helps prioritize patching and containment efforts.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'MS08-067'
        condition: selection
      fields:
        - dst_ip
        - src_ip
        - rule.name