name: ET NETBIOS Microsoft Windows NETAPI Stack Overflow Inbound - MS08-067 (11)
id: 22008701
description: |
  Detects MS08-067 NETAPI stack overflow exploitation attempts via TCP SMB on port 445.
  This variant targets the SMB service with specific exploit signatures for remote code execution.
  Legitimate SMB traffic should not contain these malicious byte patterns.
type: detection
detection_id: 2008701
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete SMB packet containing the MS08-067 exploit signature?
    context: Analyzing the SMB packet structure reveals the specific exploit technique and payload delivery method.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - src_ip
        - dst_ip
        - dst_port

  - question: Is this SMB connection part of normal business operations?
    context: Legitimate SMB access patterns help distinguish authorized file sharing from exploitation attempts.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - src_ip
        - bytes_toserver
        - bytes_toclient
        - duration

  - question: What SMB session negotiation occurred before this exploitation attempt?
    context: Understanding the SMB handshake reveals authentication status and connection establishment.
    range: -5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - conn_state
        - duration
        - bytes_toserver
        - bytes_toclient

  - question: Has the target system shown signs of compromise following this attempt?
    context: Successful SMB exploitation typically results in immediate process execution or system changes.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - User

  - question: What other MS08-067 variants were detected from this source?
    context: Multiple exploit variants suggest sophisticated targeting or automated exploitation frameworks.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: 'MS08-067'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - dst_port

  - question: Are there outbound connections from the target indicating successful compromise?
    context: Successful exploitation often results in reverse shells or command and control communications.
    range: +3h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toclient
        - conn_state

  - question: What file system modifications occurred on the target after exploitation?
    context: SMB exploitation commonly results in file drops, modifications, or malware installation.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size
        - file.mime_type

  - question: Has this attacker targeted other SMB services in the network?
    context: Understanding attack scope helps identify if this is part of a broader lateral movement campaign.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 445
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - rule.category

  - question: What authentication events preceded this SMB exploitation attempt?
    context: Failed or successful authentication attempts provide context for the attack vector.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 445
            - 139
        condition: selection
      fields:
        - dst_ip
        - conn_state
        - duration
        - bytes_toserver

  - question: Are there signs of privilege escalation following the exploitation?
    context: MS08-067 exploitation often leads to SYSTEM level access requiring privilege escalation analysis.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          User|contains:
            - 'SYSTEM'
            - 'Administrator'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: What other enterprise systems are vulnerable to similar SMB attacks?
    context: Identifying vulnerable SMB services helps prioritize patching and network segmentation.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_port: 445
          rule.name|contains: 'NETAPI Stack Overflow'
        condition: selection
      fields:
        - dst_ip
        - src_ip
        - rule.name