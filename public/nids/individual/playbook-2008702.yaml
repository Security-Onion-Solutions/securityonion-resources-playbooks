name: ET NETBIOS Microsoft Windows NETAPI Stack Overflow Inbound - MS08-067 (12)
id: 22008702
description: |
  Detects MS08-067 NETAPI stack overflow exploitation with path traversal sequences via SMB.
  This variant uses specific Unicode path traversal patterns to trigger the vulnerability.
  Legitimate SMB file access should not contain these malicious path sequences.
type: detection
detection_id: 2008702
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the exact path traversal sequence used in this exploitation attempt?
    context: The specific path traversal pattern reveals the exploit technique and intended target directory.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - src_ip
        - dst_ip

  - question: Is this path traversal pattern part of legitimate file access?
    context: Understanding normal file access patterns helps distinguish malicious from authorized operations.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - src_ip
        - bytes_toserver
        - duration

  - question: What SMB commands preceded this path traversal exploitation?
    context: Understanding the SMB command sequence reveals the attack methodology and file system targeting.
    range: -10m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - conn_state
        - bytes_toserver
        - bytes_toclient
        - duration

  - question: Did this exploitation result in unauthorized file system access?
    context: Successful path traversal exploitation may lead to sensitive file access or system compromise.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size

  - question: What processes were spawned following this path traversal attempt?
    context: Successful exploitation often results in process execution or shell access.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - User

  - question: Are there other path traversal attempts from this source?
    context: Multiple path traversal attempts suggest systematic exploitation or reconnaissance.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: 'path traversal'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - timestamp

  - question: What network connections were established after successful exploitation?
    context: Path traversal exploitation may lead to command and control or lateral movement connections.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toclient
        - conn_state

  - question: Has this attack pattern been used against other systems?
    context: Understanding attack scope helps identify if this is part of a coordinated campaign.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: 'MS08-067'
        condition: selection
      fields:
        - dst_ip
        - rule.name

  - question: What authentication context was used for this SMB exploitation?
    context: Understanding authentication status reveals if this was an authenticated or unauthenticated attack.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - conn_state
        - duration
        - bytes_toserver

  - question: Are there signs of data exfiltration following the path traversal?
    context: Successful path traversal may lead to sensitive data access and subsequent exfiltration.
    range: +8h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toclient
        - duration

  - question: What other systems show similar path traversal exploitation patterns?
    context: Identifying vulnerable systems helps prioritize incident response and remediation efforts.
    range: -48h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'path traversal'
          dst_port: 445
        condition: selection
      fields:
        - dst_ip
        - src_ip
        - rule.name