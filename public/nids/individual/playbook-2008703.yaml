name: ET NETBIOS Microsoft Windows NETAPI Stack Overflow Inbound - MS08-067 (13)
id: 22008703
description: |
  Detects MS08-067 NETAPI stack overflow exploitation using "../" path traversal via SMB.
  This variant uses classic directory traversal sequences to exploit the vulnerability.
  No legitimate SMB operations should contain these specific exploit patterns.
type: detection
detection_id: 2008703
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete "../" path traversal sequence in this exploit?
    context: The directory traversal pattern reveals the specific exploit variant and target path manipulation.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - src_ip
        - dst_ip

  - question: Is this directory traversal part of legitimate file system navigation?
    context: Understanding normal file access patterns helps distinguish authorized operations from exploitation.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - src_ip
        - bytes_toserver
        - bytes_toclient

  - question: What SMB session activity led to this directory traversal attempt?
    context: Understanding the SMB session context reveals the attack progression and file system targeting.
    range: -10m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - conn_state
        - duration
        - bytes_toserver

  - question: Did this directory traversal result in unauthorized file access?
    context: Successful directory traversal exploitation may expose sensitive files or system directories.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.mime_type

  - question: What processes executed following this traversal exploitation attempt?
    context: Successful exploitation often leads to process spawning or shell command execution.
    range: +45m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid

  - question: Are there multiple directory traversal attempts from this attacker?
    context: Repeated traversal attempts suggest systematic exploitation or automated attack tools.
    range: -3h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          payload|contains: '../'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - timestamp

  - question: What outbound network activity followed this exploitation?
    context: Successful directory traversal may lead to data exfiltration or command and control communications.
    range: +6h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toclient
        - duration

  - question: Has this attack source targeted other SMB services with similar techniques?
    context: Understanding attack scope helps identify if this is part of a broader network compromise.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 445
          rule.name|contains: 'traversal'
        condition: selection
      fields:
        - dst_ip
        - rule.name

  - question: What authentication events occurred before this directory traversal?
    context: Authentication context reveals whether this was an authenticated or anonymous attack.
    range: -20m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 445
            - 139
        condition: selection
      fields:
        - dst_ip
        - conn_state
        - bytes_toserver

  - question: Are there indicators of privilege escalation after successful traversal?
    context: Directory traversal exploitation may lead to elevated privileges or system-level access.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          User|contains:
            - 'SYSTEM'
            - 'Administrator'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  - question: What other enterprise systems show similar directory traversal patterns?
    context: Identifying vulnerable systems helps assess campaign scope and prioritize remediation.
    range: -48h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'directory traversal'
          dst_port: 445
        condition: selection
      fields:
        - dst_ip
        - src_ip
        - rule.name