name: ET NETBIOS Microsoft Windows NETAPI Stack Overflow Inbound - MS08-067 (15)
id: 22008705
description: |
  Detects MS08-067 NETAPI stack overflow exploitation using Unicode backslash path traversal.
  This variant uses Unicode-encoded backslash sequences for Windows-specific path manipulation.
  Legitimate Windows file sharing should not contain these malicious Unicode patterns.
type: detection
detection_id: 2008705
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the Unicode backslash traversal sequence used in this exploit?
    context: Unicode backslash analysis reveals Windows-specific exploitation techniques and path manipulation.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - src_ip
        - dst_ip

  - question: Is this Unicode backslash pattern part of normal Windows file access?
    context: Understanding Windows file path conventions helps distinguish legitimate from malicious operations.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - src_ip
        - bytes_toserver
        - bytes_toclient

  - question: What Windows SMB commands preceded this backslash traversal?
    context: Understanding Windows SMB protocol usage reveals the attack methodology and system targeting.
    range: -8m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - conn_state
        - duration
        - bytes_toserver

  - question: Did this backslash traversal access Windows system directories?
    context: Successful backslash traversal may expose critical Windows system files and directories.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.mime_type

  - question: What Windows processes executed after this traversal attempt?
    context: Successful Windows exploitation often results in cmd.exe, powershell.exe, or system process execution.
    range: +45m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - User

  - question: Are there other Windows-specific evasion attempts from this attacker?
    context: Multiple Windows evasion techniques suggest targeted Windows environment exploitation.
    range: -3h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: 'Windows'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - timestamp

  - question: What Windows services were accessed following this exploitation?
    context: Successful Windows exploitation may lead to service manipulation or privilege escalation.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 135
            - 445
            - 3389
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toclient

  - question: Has this Windows exploitation technique targeted other domain systems?
    context: Understanding Windows domain attack scope helps identify lateral movement and privilege escalation.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 445
          rule.name|contains: 'backslash'
        condition: selection
      fields:
        - dst_ip
        - rule.name

  - question: What Windows authentication events occurred before this traversal?
    context: Windows authentication context reveals domain credentials usage or anonymous access attempts.
    range: -20m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 445
            - 139
            - 88
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - conn_state

  - question: Are there signs of Windows registry manipulation after exploitation?
    context: Windows exploitation often includes registry modifications for persistence or configuration changes.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetObject
        - Details

  - question: What other Windows domain controllers show similar attack patterns?
    context: Identifying Windows domain attack patterns helps assess Active Directory compromise scope.
    range: -48h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'Windows'
          dst_port: 445
        condition: selection
      fields:
        - dst_ip
        - src_ip
        - rule.name