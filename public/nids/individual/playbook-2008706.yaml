name: ET NETBIOS Microsoft Windows NETAPI Stack Overflow Inbound - MS08-067 (16)
id: 22008706
description: |
  Detects MS08-067 NETAPI stack overflow exploitation via TCP NetBIOS on port 139.
  This variant targets NetBIOS session service with specific exploit signatures.
  Legitimate NetBIOS session traffic should not contain these malicious byte patterns.
type: detection
detection_id: 2008706
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the NetBIOS session packet containing the MS08-067 exploit?
    context: NetBIOS session analysis reveals the specific exploit delivery method and payload structure.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - src_ip
        - dst_ip
        - dst_port

  - question: Is this NetBIOS session part of legitimate network browsing?
    context: Understanding normal NetBIOS usage helps distinguish authorized network operations from exploitation.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 139
        condition: selection
      fields:
        - src_ip
        - bytes_toserver
        - bytes_toclient

  - question: What NetBIOS name resolution preceded this exploitation attempt?
    context: Understanding NetBIOS name resolution reveals network discovery and targeting methodology.
    range: -10m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 137
            - 138
            - 139
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - conn_state

  - question: Did this NetBIOS exploitation result in system compromise?
    context: Successful NetBIOS exploitation typically results in remote access or process execution.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid

  - question: What other NetBIOS services were targeted by this attacker?
    context: Multiple NetBIOS service targeting suggests comprehensive network reconnaissance and exploitation.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 137
            - 138
            - 139
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - rule.name

  - question: Are there outbound connections from the target after NetBIOS exploitation?
    context: Successful NetBIOS exploitation often establishes reverse connections or command channels.
    range: +3h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toclient
        - conn_state

  - question: What file shares were accessed following this NetBIOS attack?
    context: NetBIOS exploitation may lead to unauthorized file share access and data compromise.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size

  - question: Has this NetBIOS attack pattern been used against other network hosts?
    context: Understanding NetBIOS attack scope helps identify network-wide compromise and lateral movement.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 139
          rule.name|contains: 'NETBIOS'
        condition: selection
      fields:
        - dst_ip
        - rule.name

  - question: What NetBIOS enumeration occurred before this exploitation?
    context: NetBIOS enumeration often precedes exploitation as part of network reconnaissance.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 137
            - 139
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - duration
        - bytes_toserver

  - question: Are there signs of NetBIOS session hijacking or manipulation?
    context: Advanced NetBIOS attacks may include session hijacking or man-in-the-middle techniques.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 139
        condition: selection
      fields:
        - src_ip
        - conn_state
        - duration
        - bytes_toserver

  - question: What other legacy protocol attacks are associated with this campaign?
    context: NetBIOS exploitation often occurs alongside other legacy protocol attacks in comprehensive campaigns.
    range: -48h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'NETBIOS'
            - 'SMB'
            - 'RPC'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - dst_port