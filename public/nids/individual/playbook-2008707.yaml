name: ET NETBIOS Microsoft Windows NETAPI Stack Overflow Inbound - MS08-067 (17)
id: 22008707
description: |
  Detects MS08-067 NETAPI stack overflow with mixed path traversal sequences via NetBIOS.
  This variant combines different path traversal techniques in NetBIOS session traffic.
  Legitimate NetBIOS operations should not contain these complex traversal patterns.
type: detection
detection_id: 2008707
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the mixed path traversal sequence in this NetBIOS exploit?
    context: Mixed traversal patterns reveal sophisticated exploitation techniques and evasion methods.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - src_ip
        - dst_ip

  - question: Is this complex path pattern part of legitimate NetBIOS file operations?
    context: Understanding normal NetBIOS file access helps distinguish authorized from malicious path usage.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 139
        condition: selection
      fields:
        - src_ip
        - bytes_toserver
        - duration

  - question: What NetBIOS session establishment preceded this complex traversal?
    context: Understanding NetBIOS session context reveals the attack progression and file system targeting.
    range: -8m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 139
        condition: selection
      fields:
        - conn_state
        - bytes_toserver
        - bytes_toclient

  - question: Did this mixed traversal bypass file system security controls?
    context: Complex traversal techniques may circumvent basic path filtering and access controls.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.mime_type

  - question: What processes were spawned after this complex NetBIOS exploitation?
    context: Successful complex exploitation often results in immediate process execution or shell access.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - User

  - question: Are there other complex evasion techniques from this attack source?
    context: Multiple complex techniques suggest advanced attack tools or sophisticated threat actors.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: 'traversal'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - timestamp

  - question: What network communications followed this complex NetBIOS attack?
    context: Advanced NetBIOS exploitation may establish sophisticated command and control channels.
    range: +5h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toclient
        - duration

  - question: Has this complex attack pattern been used against other NetBIOS services?
    context: Understanding complex attack scope helps identify advanced persistent threat campaigns.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 139
          rule.name|contains: 'complex'
        condition: selection
      fields:
        - dst_ip
        - rule.name

  - question: What advanced authentication bypass preceded this complex exploitation?
    context: Complex exploitation often includes sophisticated authentication bypass or credential theft.
    range: -25m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 139
            - 445
            - 88
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - conn_state

  - question: Are there signs of advanced persistence following complex NetBIOS exploitation?
    context: Sophisticated NetBIOS attacks often include advanced persistence and stealth mechanisms.
    range: +6h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetFilename|contains:
            - 'system32'
            - 'drivers'
            - 'startup'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5

  - question: What other enterprise systems show similar complex exploitation patterns?
    context: Identifying complex attack patterns helps assess advanced threat campaign scope and sophistication.
    range: -72h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'complex'
          dst_port: 139
        condition: selection
      fields:
        - dst_ip
        - src_ip
        - rule.name