name: ET NETBIOS Microsoft Windows NETAPI Stack Overflow Inbound - MS08-067 (19)
id: 22008709
description: |
  Detects MS08-067 exploitation attempts targeting NETAPI stack overflow vulnerability via SMB on port 139.
  This critical vulnerability allows remote code execution through malformed RPC requests.
  Legitimate SMB traffic should not contain these specific exploit patterns.
type: detection
detection_id: 2008709
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What specific exploit payload patterns were detected in the SMB traffic?
    context: Analyzing the exact byte sequences helps confirm MS08-067 exploitation attempt and variant.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - rule.name
        - alert.signature

  - question: What was the complete network flow context for this exploitation attempt?
    context: Understanding connection details reveals attack vector and potential source characteristics.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_port
        - dst_port
        - proto
        - conn_state
        - duration

  # Type 2: Triage Assessment
  - question: Is this source IP known for legitimate SMB administrative access?
    context: Distinguishing between authorized network administration and malicious exploitation attempts.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 139
            - 445
        condition: selection
      fields:
        - dst_ip
        - service
        - orig_bytes
        - resp_bytes

  - question: Does the target system typically receive SMB connections during this timeframe?
    context: Establishing baseline SMB activity patterns to identify anomalous exploitation attempts.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 139
        condition: selection
      fields:
        - src_ip
        - conn_state
        - orig_bytes
        - resp_bytes

  # Type 3: Activity Context
  - question: What other network reconnaissance preceded this exploitation attempt?
    context: MS08-067 attacks often follow port scanning and SMB enumeration activities.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - service
        - conn_state
        - duration

  - question: Were there any DNS queries from the source IP before the attack?
    context: Understanding attacker reconnaissance and targeting methodology.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.resolved_ip

  # Type 4: Impact Assessment
  - question: Did the target system show signs of successful compromise after this attempt?
    context: Determining if the MS08-067 exploitation was successful and requires immediate response.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ParentImage

  - question: Were any suspicious network connections initiated from the target after exploitation?
    context: Identifying potential command and control or lateral movement activities.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - service
        - orig_bytes
        - resp_bytes

  # Type 5: Forensic Deep-Dive
  - question: What file system changes occurred on the target system post-exploitation?
    context: MS08-067 exploitation often involves dropping malware or creating persistence mechanisms.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.hash.sha256
        - ProcessName

  - question: Were there any registry modifications indicating persistence establishment?
    context: Successful MS08-067 exploitation typically involves registry changes for persistence.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessName
        - User

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network experiencing similar MS08-067 exploitation attempts?
    context: Determining if this is part of a broader worm-like attack campaign across the enterprise.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "MS08-067"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - alert.severity

  - question: Is the source IP targeting multiple internal systems with various attack vectors?
    context: Understanding the scope of the attack campaign and attacker capabilities.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - rule.category
        - rule.name
        - alert.signature