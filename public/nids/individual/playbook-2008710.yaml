name: ET NETBIOS Microsoft Windows NETAPI Stack Overflow Inbound - MS08-067 (20)
id: 22008710
description: |
  Detects MS08-067 exploitation attempts targeting NETAPI stack overflow vulnerability via SMB on port 139.
  This variant uses different directory traversal patterns in the exploit payload.
  Legitimate SMB traffic should not contain these specific malformed path traversal sequences.
type: detection
detection_id: 2008710
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What specific directory traversal patterns were detected in this MS08-067 variant?
    context: Analyzing the exact path traversal sequences helps identify the specific exploit technique used.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - rule.name
        - alert.signature

  - question: What was the SMB connection state and characteristics during this attack?
    context: Understanding the network flow helps determine attack success and connection behavior.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_port
        - dst_port
        - conn_state
        - orig_bytes
        - resp_bytes

  # Type 2: Triage Assessment
  - question: Has this source IP attempted legitimate SMB authentication recently?
    context: Differentiating between authorized network access and malicious exploitation attempts.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 139
            - 445
        condition: selection
      fields:
        - dst_ip
        - service
        - conn_state
        - duration

  - question: Is the target system configured to accept SMB connections from this network segment?
    context: Validating if SMB access from this source should be permitted based on network policy.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 139
        condition: selection
      fields:
        - src_ip
        - conn_state
        - orig_bytes
        - resp_bytes

  # Type 3: Activity Context
  - question: What reconnaissance activities preceded this specific exploitation variant?
    context: MS08-067 attacks typically follow systematic network enumeration and service identification.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - service
        - conn_state
        - duration

  - question: Were there other MS08-067 exploitation attempts from this source using different variants?
    context: Understanding if the attacker is using multiple exploit variants to increase success probability.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "MS08-067"
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - alert.signature

  # Type 4: Impact Assessment
  - question: Did the target system exhibit signs of compromise following this exploitation attempt?
    context: Determining if the MS08-067 variant successfully compromised the target system.
    range: +45m
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid

  - question: Were any outbound connections established from the target system after the attack?
    context: Identifying potential command and control communication or data exfiltration activities.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - service
        - orig_bytes
        - resp_bytes

  # Type 5: Forensic Deep-Dive
  - question: What malware artifacts were created on the target system post-exploitation?
    context: MS08-067 successful exploitation typically results in malware deployment and persistence.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.hash.sha256
        - ProcessName
        - file.mime_type

  - question: Were there any system configuration changes indicating successful compromise?
    context: Analyzing registry and system changes that indicate successful MS08-067 exploitation.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessName
        - User

  # Type 6: Enterprise Correlation
  - question: Are other systems experiencing similar MS08-067 variant attacks from this source?
    context: Determining the scope of the attack campaign and identifying other potential victims.
    range: +/-3h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "MS08-067"
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - alert.signature
        - alert.severity

  - question: Is this part of a coordinated attack campaign targeting multiple vulnerabilities?
    context: Understanding if MS08-067 exploitation is part of a broader multi-vector attack strategy.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - rule.category
        - rule.name
        - alert.signature