name: ET NETBIOS Microsoft Windows NETAPI Stack Overflow Inbound - MS08-067 (22)
id: 22008712
description: |
  Detects MS08-067 exploitation attempts targeting NETAPI stack overflow vulnerability via SMB on port 445.
  This variant targets the more common SMB port 445 with specific path traversal patterns.
  Legitimate SMB traffic should not contain these malformed directory traversal sequences.
type: detection
detection_id: 2008712
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What specific exploit payload was detected in this port 445 MS08-067 attempt?
    context: Analyzing the exact byte patterns helps confirm the exploitation technique and variant used.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - rule.name
        - alert.signature

  - question: What were the SMB connection characteristics for this port 445 attack?
    context: Understanding the network flow details reveals attack vector and connection behavior patterns.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_port
        - dst_port
        - conn_state
        - orig_bytes
        - resp_bytes

  # Type 2: Triage Assessment
  - question: Is this source IP authorized for SMB access on port 445 to this target?
    context: Determining if the connection attempt aligns with legitimate network administration or file sharing.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 445
        condition: selection
      fields:
        - dst_ip
        - service
        - conn_state
        - orig_bytes
        - resp_bytes

  - question: Does the target system typically accept SMB connections on port 445 during business hours?
    context: Establishing baseline SMB activity patterns to identify anomalous exploitation attempts.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - src_ip
        - conn_state
        - duration
        - service

  # Type 3: Activity Context
  - question: What port scanning or enumeration activities preceded this port 445 exploitation?
    context: MS08-067 attacks often follow systematic network reconnaissance and service discovery.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - service
        - conn_state
        - duration

  - question: Were there simultaneous attacks on both port 139 and 445 from this source?
    context: Understanding if the attacker is targeting multiple SMB ports to maximize exploitation success.
    range: +/-30m
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: "MS08-067"
        condition: selection
      fields:
        - rule.name
        - alert.signature
        - dst_port

  # Type 4: Impact Assessment
  - question: Did the target system show evidence of successful compromise after this port 445 attack?
    context: Determining if the MS08-067 exploitation was successful and requires immediate incident response.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid

  - question: Were any suspicious network services or connections established post-exploitation?
    context: Identifying potential backdoor installation or command and control communication channels.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - service
        - orig_bytes
        - resp_bytes

  # Type 5: Forensic Deep-Dive
  - question: What files were created or modified on the target system following the exploitation?
    context: MS08-067 successful exploitation typically involves malware deployment and system modification.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.hash.sha256
        - ProcessName
        - file.mime_type

  - question: Were there any registry changes indicating persistence mechanism installation?
    context: Analyzing system changes that indicate successful MS08-067 exploitation and malware persistence.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessName
        - User

  # Type 6: Enterprise Correlation
  - question: Are other systems experiencing similar port 445 MS08-067 attacks from this source?
    context: Determining the scope of the attack campaign and identifying other potential victims in the network.
    range: +/-3h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "MS08-067"
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - alert.signature
        - alert.severity

  - question: Is this source IP conducting a broader attack campaign beyond MS08-067 exploitation?
    context: Understanding the full scope of the attacker's activities and threat level to the organization.
    range: +/-6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - rule.category
        - rule.name
        - alert.signature