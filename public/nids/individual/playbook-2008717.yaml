name: ET NETBIOS Microsoft Windows NETAPI Stack Overflow Inbound - MS08-067 (27)
id: 22008717
description: |
  Detects MS08-067 exploitation attempts targeting NETAPI stack overflow vulnerability via SMB on port 139.
  This variant uses mixed encoding with backslash directory traversal patterns in the exploit payload.
  Legitimate SMB traffic should not contain these specific malformed mixed-encoding path sequences.
type: detection
detection_id: 2008717
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What specific mixed-encoding backslash patterns were detected in this MS08-067 variant?
    context: Analyzing the exact mixed-encoding sequences helps identify advanced evasion techniques and exploit sophistication.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - rule.name
        - alert.signature

  - question: What were the SMB port 139 connection characteristics during this mixed-encoding attack?
    context: Understanding the network flow details reveals attack vector and connection behavior on the legacy SMB port.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_port
        - dst_port
        - conn_state
        - orig_bytes
        - resp_bytes

  # Type 2: Triage Assessment
  - question: Is this source IP authorized for legacy SMB access on port 139 with mixed encoding?
    context: Determining if the mixed-encoding patterns align with legitimate legacy system operations.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 139
        condition: selection
      fields:
        - dst_ip
        - service
        - conn_state
        - orig_bytes
        - resp_bytes

  - question: Does the target system typically accept legacy SMB connections with complex encoding?
    context: Establishing baseline legacy SMB activity patterns to identify anomalous mixed-encoding exploitation.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 139
        condition: selection
      fields:
        - src_ip
        - conn_state
        - duration
        - service

  # Type 3: Activity Context
  - question: What reconnaissance activities preceded this mixed-encoding MS08-067 exploitation?
    context: Understanding if the attacker specifically targeted legacy systems with advanced encoding evasion.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - service
        - conn_state
        - duration

  - question: Were there other advanced encoding variants of MS08-067 attacks from this source?
    context: Determining if the attacker is using sophisticated encoding techniques to evade multiple security layers.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: "MS08-067"
        condition: selection
      fields:
        - rule.name
        - alert.signature
        - alert.severity

  # Type 4: Impact Assessment
  - question: Did the target system show evidence of compromise after this mixed-encoding exploitation?
    context: Determining if the advanced encoding techniques successfully bypassed security controls and achieved compromise.
    range: +45m
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid

  - question: Were any suspicious network connections established after the advanced encoding attack?
    context: Identifying potential command and control or lateral movement following sophisticated exploitation.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - service
        - orig_bytes
        - resp_bytes

  # Type 5: Forensic Deep-Dive
  - question: What files were created or modified following the mixed-encoding exploitation attempt?
    context: MS08-067 successful exploitation with advanced encoding may involve sophisticated malware deployment.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.hash.sha256
        - ProcessName
        - file.mime_type

  - question: Were there any system configuration changes indicating advanced persistent compromise?
    context: Analyzing system changes that confirm successful MS08-067 exploitation using sophisticated encoding techniques.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessName
        - User

  # Type 6: Enterprise Correlation
  - question: Are other systems experiencing similar mixed-encoding MS08-067 attacks?
    context: Determining if this is part of an advanced persistent threat campaign using sophisticated evasion techniques.
    range: +/-3h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "MS08-067"
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - alert.signature
        - alert.severity

  - question: Is this source IP demonstrating advanced evasion capabilities across multiple attack vectors?
    context: Understanding the sophistication level and potential APT characteristics of the attacking entity.
    range: +/-6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - rule.category
        - rule.name
        - alert.signature