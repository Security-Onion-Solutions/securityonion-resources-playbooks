name: ET MALWARE Conficker/KernelBot/MS08-067 related Trojan Checkin
id: 22008737
description: |
  Detects Conficker/KernelBot trojan check-in communication related to MS08-067 exploitation.
  This malware spreads through network shares and removable media, establishing persistent access.
  May trigger on legitimate system update or version checking mechanisms.
type: detection
detection_id: 2008737
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete Conficker check-in URL with version information?
    context: The URL structure reveals the malware variant and victim system identification.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.full
        - url.query
        - url.path
        - http.request.method

  - question: What version information was transmitted in the Ver parameter?
    context: The version parameter indicates the specific Conficker variant and infection timeline.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.query
        - http.request.headers
        - http.request.referrer

  - question: Is this system authorized to perform automated version checking to external servers?
    context: Legitimate software may perform similar version checks that could trigger false positives.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains: "/kernel/"
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - url.path

  - question: What process initiated this Conficker/KernelBot communication attempt?
    context: Identifying the execution context helps determine the infection vector and malware behavior.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid
        - User

  - question: What network shares or removable media were accessed prior to this activity?
    context: Conficker spreads through network shares and USB drives, indicating potential propagation vectors.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - "\\\\*"
            - "autorun.inf"
            - "removable"
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessGuid

  - question: Has the system received updates or additional payloads from the C2 server?
    context: Successful C2 communication indicates active compromise requiring immediate containment.
    range: -30m/+2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.response.status_code: 200
        condition: selection
      fields:
        - http.response.body.bytes
        - url.full
        - http.response.mime_type

  - question: What network scanning or propagation attempts occurred from this system?
    context: Conficker actively scans for vulnerable systems to spread through MS08-067 exploitation.
    range: -1h/+4h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 445
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - community_id
        - network.bytes_sent

  - question: Are there signs of MS08-067 exploitation attempts from this infected system?
    context: Conficker exploits MS08-067 vulnerability to spread to other systems in the network.
    range: -1h/+6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "MS08-067"
            - "SMB"
            - "RPC"
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - rule.category

  - question: What persistence mechanisms were established by the Conficker malware?
    context: Conficker establishes multiple persistence mechanisms to survive system reboots and removal attempts.
    range: -2h/+1h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - "Run"
            - "RunOnce"
            - "Services"
            - "SharedAccess"
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessGuid

  - question: Are other systems in the network showing similar Conficker infection patterns?
    context: Conficker spreads rapidly through networks, requiring comprehensive incident response.
    range: -24h/+1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - "Conficker"
            - "KernelBot"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: What DNS queries were made to resolve Conficker C2 domains?
    context: Conficker uses domain generation algorithms requiring analysis of DNS patterns.
    range: -1h/+1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          dns.resolved_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  - question: What system services were modified or created by the malware?
    context: Conficker creates system services to maintain persistence and execute malicious activities.
    range: -2h/+1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - "sc create"
            - "net start"
            - "services.exe"
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid