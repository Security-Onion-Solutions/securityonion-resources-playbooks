name: ET MALWARE Asprox Form Submission to C&C
id: 22009054
description: |
  Detects Asprox botnet command and control communication via specific form
  submission patterns. Indicates compromised host participating in botnet
  activities. Unlikely to trigger on legitimate traffic due to specific
  boundary signature.
type: detection
detection_id: 2009054
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete C&C server URL receiving the Asprox form submission?
    context: The C&C URL reveals the botnet infrastructure and command server location.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.full
        - url.domain
        - dst_ip

  - question: What specific form data was submitted in the multipart boundary?
    context: Form content reveals bot identification, system information, or stolen data.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.request.body.content
        - http.content_type
        - http.request.headers

  # Type 2: Triage Assessment
  - question: Is this host known to be part of a legitimate testing or research environment?
    context: Security researchers may simulate botnet communications for analysis purposes.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.domain
        - user_agent.original
        - http.request.method

  - question: Does this system have documented malware analysis or sandbox activities?
    context: Malware analysis environments may legitimately generate botnet traffic.
    range: -1d
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          process.name|contains:
            - 'sandbox'
            - 'analysis'
            - 'vm'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - user.name

  # Type 3: Activity Context
  - question: What initial infection vector led to this Asprox botnet participation?
    context: Understanding infection source helps prevent similar compromises.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - 'malware'
            - 'exploit'
            - 'trojan'
        condition: selection
      fields:
        - rule.name
        - url.domain
        - dst_ip

  - question: What other C&C communications occurred from this infected host?
    context: Compromised systems often communicate with multiple C&C servers or protocols.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category: 'command-and-control'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - url.domain

  # Type 4: Impact Assessment
  - question: What commands or payloads were received from the C&C server?
    context: C&C responses may contain additional malware, commands, or configuration updates.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - http.response.body.content
        - http.response.status_code
        - http.response.body.bytes

  - question: Are there signs of data exfiltration or credential theft?
    context: Asprox botnet is known for stealing credentials and sensitive information.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method: 'POST'
        condition: selection
      fields:
        - url.domain
        - http.request.body.content
        - http.content_type

  # Type 5: Forensic Deep-Dive
  - question: What persistence mechanisms were established by the Asprox infection?
    context: Botnet malware typically creates persistence through registry, services, or scheduled tasks.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - registry.key
        - registry.value.name
        - registry.value.data
        - process.name

  - question: What additional malware components were downloaded or executed?
    context: Asprox often downloads additional payloads or updates from C&C servers.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - file.hash.md5

  - question: What system information was collected and transmitted to the C&C?
    context: Botnets typically collect system details for targeting and capability assessment.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          process.name|contains:
            - 'systeminfo'
            - 'ipconfig'
            - 'whoami'
            - 'net'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - user.name

  # Type 6: Enterprise Correlation
  - question: Are other hosts in the network communicating with the same Asprox C&C infrastructure?
    context: Botnet infections often spread laterally or affect multiple systems simultaneously.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'Asprox'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - rule.name
        - url.domain

  - question: What other malware families are associated with this C&C infrastructure?
    context: Criminal infrastructure often hosts multiple malware families and campaigns.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.category|contains:
            - 'malware'
            - 'command-and-control'
        condition: selection
      fields:
        - rule.name
        - src_ip
        - url.domain