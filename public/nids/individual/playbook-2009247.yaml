name: ET SHELLCODE Rothenburg Shellcode
id: 22009247
description: |
  Detects TCP traffic containing Rothenburg shellcode patterns.
  May indicate exploit payload delivery or legitimate security research.
type: detection
detection_id: 2009247
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete TCP payload containing the Rothenburg shellcode?
    context: Analyzing the full payload reveals the shellcode's functionality and target system.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_port
        - dst_port
        - payload
  - question: Is this established connection part of authorized security testing?
    context: Legitimate penetration testing may use known shellcode patterns for vulnerability assessment.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          connection_state: 'established'
        condition: selection
      fields:
        - src_port
        - dst_port
        - bytes_in
        - bytes_out
  - question: What application or service received this shellcode?
    context: Understanding the target service helps determine vulnerability and potential impact.
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|expand: '%dst_port%'
        condition: selection
      fields:
        - src_ip
        - service
        - application_protocol
  - question: Did the shellcode successfully execute on the target system?
    context: Successful exploitation may result in process creation or network callbacks.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ProcessGuid
        - User
  - question: What other exploit attempts targeted this system?
    context: Multiple exploit attempts may indicate systematic targeting or vulnerability scanning.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          alert.category|contains:
            - 'SHELLCODE'
            - 'EXPLOIT'
        condition: selection
      fields:
        - src_ip
        - alert.signature
        - alert.severity
  - question: Are there indicators of post-exploitation activity?
    context: Successful shellcode execution enables further malicious activities like data exfiltration.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - connection_state
  - question: What files were accessed or modified after the shellcode delivery?
    context: File system changes may indicate successful exploitation and payload deployment.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessGuid
  - question: Has this Rothenburg shellcode pattern appeared elsewhere in the network?
    context: Similar patterns across multiple hosts may indicate a coordinated attack campaign.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: 'Rothenburg Shellcode'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature
  - question: What security controls detected or blocked related activities?
    context: Security systems may have additional context on the attack progression.
    range: +/-30m
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          alert.action|contains:
            - 'blocked'
            - 'prevented'
        condition: selection
      fields:
        - alert.signature
        - src_ip
        - alert.action