name: ET SCAN Port Unreachable Response to Xprobe2 OS Fingerprint Scan
id: 22009298
description: |
  Detects ICMP port unreachable responses that indicate Xprobe2 OS fingerprinting attempts.
  Xprobe2 uses specific probe packets to identify operating system types and versions through response analysis.
  May trigger on legitimate network troubleshooting or security scanning by authorized personnel.
type: detection
detection_id: 2009298
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What specific ICMP port unreachable response pattern indicates Xprobe2 fingerprinting?
    context: Understanding the fingerprinting technique reveals the sophistication and intent of the reconnaissance.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - icmp.type
        - icmp.code

  - question: Is this OS fingerprinting part of authorized security assessment?
    context: Legitimate security teams may use Xprobe2 for authorized network assessment and vulnerability scanning.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_port
        - network.bytes_sent
        - network.packets

  - question: What was the original probe traffic that triggered this ICMP response?
    context: Understanding the initial probe helps identify the fingerprinting methodology and target services.
    range: -5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_port
        - dst_port
        - network.bytes_sent
        - network.protocol

  - question: Are there other OS fingerprinting or reconnaissance activities from this source?
    context: Attackers often combine multiple reconnaissance techniques to gather comprehensive target information.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - 'SCAN'
            - 'fingerprint'
            - 'reconnaissance'
            - 'probe'
        condition: selection
      fields:
        - rule.name
        - src_ip
        - rule.category

  - question: Has the fingerprinting source attempted to exploit identified services?
    context: OS fingerprinting is often followed by targeted exploitation attempts against discovered vulnerabilities.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'EXPLOIT'
            - 'attack'
            - 'vulnerability'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - dst_port

  - question: Are multiple systems in the network being fingerprinted by the same source?
    context: Network-wide OS fingerprinting indicates systematic reconnaissance for attack planning.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: 'ET SCAN Port Unreachable Response to Xprobe2 OS Fingerprint Scan'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - rule.category

  - question: What is the geographic origin and reputation of the fingerprinting source?
    context: OS fingerprinting attacks often originate from specific geographic regions or known malicious infrastructure.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          dns.resolved_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name

  - question: Are there signs of port scanning or service enumeration from the same source?
    context: OS fingerprinting is typically part of comprehensive reconnaissance including port and service discovery.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - 'port scan'
            - 'service'
            - 'enumeration'
        condition: selection
      fields:
        - rule.name
        - src_ip
        - dst_port

  - question: Has the target system responded with other OS-identifying information?
    context: Multiple OS identification responses help confirm the effectiveness of the fingerprinting attempt.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          network.protocol: 'icmp'
        condition: selection
      fields:
        - network.bytes_sent
        - network.packets
        - icmp.type

  - question: Is this fingerprinting activity part of a broader reconnaissance campaign?
    context: Coordinated reconnaissance campaigns often use multiple techniques across extended time periods.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - 'reconnaissance'
            - 'SCAN'
            - 'probe'
            - 'fingerprint'
        condition: selection
      fields:
        - rule.name
        - src_ip
        - rule.category

  - question: Are there indicators of automated scanning tools or coordinated botnet activity?
    context: OS fingerprinting may be part of automated attack frameworks or botnet reconnaissance activities.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - network.bytes_sent
        - network.packets