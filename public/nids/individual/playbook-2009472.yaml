name: ET MALWARE Fasec/FakeAV Alert/Keylogger/Dropper/DNSChanger Possible Rootkit - HTTP GET
id: 22009472
description: |
  Detects HTTP GET requests with parameter patterns associated with Fasec malware family and related rootkits.
  The combination of parameters (Command, snNO, Encode, SFBH) indicates communication with Fasec C2 infrastructure.
  This pattern is highly specific to malware and rarely appears in legitimate applications.
type: detection
detection_id: 2009472
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What command and encoded data was transmitted in the Fasec communication?
    context: Analyzing the Command parameter and encoded content reveals the specific malware instructions and data being exchanged.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.full
        - url.query
        - http.request.method
        - http.request.headers.user_agent

  - question: What is the decoded content of the SFBH and Encode parameters?
    context: The encoded parameters often contain system information, stolen data, or command responses that need decoding for analysis.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.query|contains:
            - 'SFBH'
            - 'Encode='
        condition: selection
      fields:
        - url.query
        - url.path
        - http.request.method

  # Type 2: Triage Assessment
  - question: Is there any legitimate software on this system that could generate similar HTTP patterns?
    context: Fasec-specific parameters are highly indicative of malware and rarely used by legitimate applications.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.query|contains:
            - 'Command='
            - 'snNO='
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - count

  - question: Does this activity correlate with recent software installations or system changes?
    context: Rootkits often install alongside other software or exploit system vulnerabilities during installation.
    range: -4h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'setup.exe'
            - 'install.exe'
            - 'msiexec.exe'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ParentImage

  # Type 3: Activity Context
  - question: What process is responsible for generating this Fasec rootkit communication?
    context: Identifying the source process helps understand how the rootkit gained execution and maintains persistence.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ParentImage
        - ProcessGuid

  - question: What system modifications preceded this rootkit communication?
    context: Rootkits typically modify system files, registry entries, or services before establishing C2 communication.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessGuid
        - Image

  - question: Is this communication part of a regular beacon pattern?
    context: Fasec rootkits often maintain persistent communication schedules with their command and control servers.
    range: +/-6h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.query|contains: 'Command='
        condition: selection
      fields:
        - count
        - url.path
        - http.request.method

  # Type 4: Impact Assessment
  - question: Has the rootkit successfully exfiltrated data or received additional commands?
    context: Successful rootkit communication often leads to data theft, credential harvesting, or additional payload downloads.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method|contains:
            - 'POST'
            - 'PUT'
        condition: selection
      fields:
        - dst_ip
        - url.full
        - http.request.body.bytes
        - http.response.status_code

  - question: Are there signs of DNS manipulation or redirection by the DNSChanger component?
    context: Fasec family includes DNSChanger functionality that redirects DNS queries to malicious servers.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  # Type 5: Forensic Deep-Dive
  - question: What keylogging or credential harvesting activities are present on this system?
    context: Fasec family includes keylogging capabilities that steal user credentials and sensitive information.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - 'keylog'
            - 'password'
            - 'credential'
            - '.log'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessGuid

  - question: What rootkit hiding mechanisms are employed by this malware?
    context: Fasec rootkits use various techniques to hide processes, files, and network connections from detection.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'taskkill'
            - 'sc delete'
            - 'reg delete'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network infected with the same Fasec rootkit family?
    context: Rootkit infections often spread through network shares or exploit kits targeting multiple systems.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.query|contains:
            - 'Command='
            - 'SFBH'
        condition: selection
      fields:
        - src_ip
        - count
        - url.domain