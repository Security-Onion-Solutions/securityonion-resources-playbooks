name: ET VOIP Multiple Unauthorized SIP Responses UDP
id: 22009700
description: |
  Detects multiple SIP 401 Unauthorized responses indicating potential VoIP credential brute force attack.
  Triggers when 5+ unauthorized responses within 6 minutes suggest systematic authentication attempts.
  May trigger during legitimate phone misconfiguration or credential rotation events.
type: detection
detection_id: 2009700
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What were the specific SIP 401 Unauthorized response patterns detected?
    context: Analyzing unauthorized responses reveals credential attack methodology and targeted accounts.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - flow_id
        - app_proto
  - question: Are these unauthorized responses due to legitimate credential issues?
    context: Distinguishing between misconfigured phones and malicious credential brute force attempts.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 5060
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - bytes_toclient
  - question: What SIP registration attempts preceded these unauthorized responses?
    context: Understanding the authentication sequence helps identify attack patterns and targeted accounts.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
          src_ip|expand: '%dst_ip%'
          dst_port: 5060
        condition: selection
      fields:
        - bytes_toserver
        - bytes_toclient
        - duration
  - question: Are there successful authentications mixed with the unauthorized responses?
    context: Determining if credential brute force attacks have achieved any successful logins.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - bytes_toserver
        - bytes_toclient
        - duration
  - question: What external sources are triggering these unauthorized SIP responses?
    context: Identifying attack sources and potential botnet infrastructure targeting VoIP credentials.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
          dst_port: 5060
        condition: selection
      fields:
        - src_ip
        - bytes_toserver
        - duration
  - question: Are there other VoIP authentication attacks occurring simultaneously?
    context: Identifying coordinated attacks against multiple VoIP services or accounts.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'VOIP'
            - 'Unauthorized'
            - 'Authentication'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.category
  - question: What legitimate VoIP accounts or services are being targeted?
    context: Understanding business impact and prioritizing protection of critical VoIP accounts.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 5060
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - bytes_toclient
  - question: Has this attack source targeted other VoIP systems in the network?
    context: Assessing campaign scope and identifying additional vulnerable VoIP infrastructure.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_port: 5060
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - duration
  - question: Are there DNS queries indicating VoIP infrastructure reconnaissance?
    context: Determining if credential attacks were preceded by systematic VoIP service discovery.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name
  - question: What is the timing and pattern of the credential brute force attempts?
    context: Analyzing attack characteristics helps implement effective account lockout and rate limiting.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - bytes_toserver
        - bytes_toclient
        - duration
  - question: Are there similar VoIP credential attacks across other organizational networks?
    context: Identifying broader campaign patterns and shared attack infrastructure.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'Unauthorized'
            - 'VOIP'
            - 'SIP'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name