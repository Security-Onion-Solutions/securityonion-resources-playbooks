name: ET P2P KuGoo P2P Connection
id: 22009966
description: |
  Detects KuGoo P2P file sharing application connections via UDP traffic patterns.
  May indicate policy violations if P2P applications are prohibited, or legitimate file sharing activity.
type: detection
detection_id: 2009966
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact UDP payload pattern that triggered the KuGoo detection?
    context: Analyzing the specific byte patterns helps confirm P2P protocol identification.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - payload
        - packet_info.length

  - question: What are the source and destination port ranges for this P2P connection?
    context: P2P applications often use dynamic port ranges which can indicate the scope of activity.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - src_port
        - dst_port
        - proto

  # Type 2: Triage Assessment
  - question: Is P2P file sharing permitted for this user or system?
    context: Determining if this activity violates organizational policy or is authorized usage.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          proto: udp
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver
        - bytes_toclient

  - question: Does this system regularly engage in P2P communications?
    context: Historical analysis helps distinguish between one-off incidents and regular P2P usage.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: P2P
        condition: selection
      fields:
        - rule.name
        - dst_ip

  # Type 3: Activity Context
  - question: What other network activity occurred from this source around the same time?
    context: Understanding concurrent network activity helps identify if this is part of broader file sharing behavior.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          proto: udp
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver
        - bytes_toclient

  - question: What process or application initiated this UDP connection?
    context: Identifying the source application confirms whether this is intentional P2P usage.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  # Type 4: Impact Assessment
  - question: How much data was transferred in this P2P session?
    context: Data volume indicates the extent of file sharing activity and potential policy impact.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          proto: udp
        condition: selection
      fields:
        - bytes_toserver
        - bytes_toclient
        - duration

  - question: Are there signs of file downloads or uploads completing?
    context: Successful file transfers indicate active P2P usage rather than just connection attempts.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.size
        - file.hash.md5

  # Type 5: Forensic Deep-Dive
  - question: What specific files or content was being shared via KuGoo?
    context: Understanding shared content helps assess potential copyright or security implications.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.mime_type|contains:
            - video
            - audio
            - application
        condition: selection
      fields:
        - TargetFilename
        - file.mime_type
        - file.size

  - question: Are there other P2P applications or protocols active on this system?
    context: Multiple P2P applications may indicate systematic policy violations or security risks.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category: P2P
        condition: selection
      fields:
        - rule.name
        - dst_ip

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network also using KuGoo or similar P2P applications?
    context: Widespread P2P usage may indicate need for policy enforcement or network security review.
    range: +/-1d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: KuGoo
        condition: selection
      fields:
        - src_ip
        - dst_ip

  - question: Is this part of a broader pattern of policy violations from this user or department?
    context: Contextualizing within organizational compliance helps prioritize response actions.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category: policy-violation
        condition: selection
      fields:
        - rule.name
        - rule.category