name: ET P2P eMule KAD Network Connection Request(2)
id: 22009968
description: |
  Detects eMule KAD network connection requests via UDP traffic with specific byte patterns.
  May indicate P2P file sharing activity which could violate organizational policy or consume bandwidth.
  Could be legitimate user activity or unauthorized P2P usage.
type: detection
detection_id: 2009968
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What is the exact UDP payload content that triggered this KAD network detection?
    context: Analyzing the payload helps confirm this is genuine eMule KAD traffic versus false positive.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - src_port
        - dst_port

  - question: Is P2P file sharing authorized for this user or system?
    context: Determines if this represents policy violation or legitimate business use.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          protocol: UDP
          dst_port|contains:
            - 4665
            - 4672
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out

  - question: What initiated this KAD network connection attempt?
    context: Understanding the triggering process helps determine if user-initiated or automated.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - emule
            - amule
            - mldonkey
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  - question: How many KAD connection requests has this system made recently?
    context: High frequency may indicate active P2P participation versus occasional usage.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          protocol: UDP
          dst_port|contains:
            - 4665
            - 4672
            - 4661
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out

  - question: What external KAD nodes is this system communicating with?
    context: Identifies the P2P network nodes and potential geographic distribution.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          protocol: UDP
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_in
        - bytes_out

  - question: Are there signs of file transfer activity associated with this KAD traffic?
    context: Confirms if P2P network is being used for actual file sharing.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          protocol: TCP
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_in
        - bytes_out

  - question: What eMule-related processes are currently running on this system?
    context: Identifies the specific P2P application and version in use.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - emule.exe
            - amule
            - mldonkey
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ParentImage

  - question: Has this system accessed any file sharing websites recently?
    context: Web activity may indicate intentional P2P software installation and usage.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.domain|contains:
            - emule-project.net
            - sourceforge.net
            - amule.org
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.response.status_code

  - question: What DNS queries for P2P-related domains originated from this system?
    context: DNS lookups may reveal P2P software configuration or server discovery.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.query.name|contains:
            - emule
            - kad
            - edonkey
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  - question: Are other systems on the network showing similar KAD network activity?
    context: Determines if this is isolated incident or broader P2P usage across organization.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "eMule KAD Network"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: What bandwidth consumption is associated with this P2P activity?
    context: Assesses network impact and resource consumption from P2P traffic.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          protocol: UDP
        condition: selection
      fields:
        - dst_ip
        - bytes_in
        - bytes_out
        - duration