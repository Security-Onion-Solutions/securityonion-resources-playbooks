name: ET P2P eMule KAD Network Server Status Request
id: 22009972
description: |
  Detects eMule KAD network server status requests used for P2P network discovery.
  May indicate unauthorized P2P file sharing activity violating organizational policy.
  Could represent legitimate research or authorized P2P usage.
type: detection
detection_id: 2009972
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What is the exact server status request payload detected?
    context: Analyzing the specific payload confirms genuine KAD server discovery versus false positive.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - src_port
        - dst_port

  - question: Is P2P server discovery authorized for this user or system?
    context: Determines if KAD server status requests violate security policy or network usage guidelines.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          protocol: UDP
          dst_port|contains:
            - 4665
            - 4672
            - 4661
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out

  - question: What application is performing KAD server status requests?
    context: Identifies the specific P2P client software making server discovery requests.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - emule
            - amule
            - mldonkey
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  - question: How many KAD servers is this system attempting to contact?
    context: High server contact frequency indicates active P2P network participation.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          protocol: UDP
          dst_port|contains:
            - 4665
            - 4672
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out

  - question: What responses are received from contacted KAD servers?
    context: Server responses indicate successful P2P network discovery and potential file sharing capability.
    range: +15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
          protocol: UDP
          src_port|contains:
            - 4665
            - 4672
        condition: selection
      fields:
        - src_ip
        - src_port
        - bytes_in

  - question: Are there subsequent file transfer connections after server discovery?
    context: TCP connections following UDP server discovery may indicate actual P2P file sharing.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          protocol: TCP
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_in
        - bytes_out

  - question: What eMule server list configuration is being used?
    context: Server list files reveal P2P network infrastructure and connection preferences.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - server.met
            - nodes.dat
            - serverlist
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - User

  - question: Has this system downloaded updated KAD server lists recently?
    context: Server list updates indicate active maintenance of P2P network connectivity.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains:
            - server.met
            - nodes.dat
            - serverlist
        condition: selection
      fields:
        - url.full
        - http.response.status_code
        - http.response.body.bytes

  - question: What DNS queries reveal KAD server discovery attempts?
    context: DNS lookups for P2P servers indicate network discovery and connection preparation.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.query.name|contains:
            - emule
            - edonkey
            - kad
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  - question: Are multiple systems performing KAD server status requests?
    context: Widespread server discovery may indicate coordinated P2P usage across the organization.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "KAD Network Server Status"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: What is the geographic distribution of contacted KAD servers?
    context: Server location analysis reveals P2P network scope and potential data sovereignty concerns.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          protocol: UDP
          dst_port|contains:
            - 4665
            - 4672
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out