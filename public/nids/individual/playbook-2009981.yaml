name: ET FTP Possible FTP Daemon Username SELECT FROM SQL Injection Attempt
id: 22009981
description: |
  Detects SQL injection attempts targeting FTP daemon username fields using SELECT FROM syntax.
  May indicate attempts to exploit vulnerable FTP applications with database backends.
  Could be legitimate testing or malicious exploitation of web-based FTP management interfaces.
type: detection
detection_id: 2009981
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete SQL injection payload in the FTP username field?
    context: Understanding the exact injection syntax reveals attacker intent and target database type.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - alert.signature
        - flow_id
  - question: Is this authorized penetration testing or security assessment activity?
    context: SQL injection testing may be part of legitimate security assessments or vulnerability scanning.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 21
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - flow.state
  - question: What other SQL injection techniques were attempted against this FTP service?
    context: Multiple injection methods indicate systematic exploitation attempts rather than isolated testing.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          alert.signature|contains: "SQL Injection"
        condition: selection
      fields:
        - alert.signature
        - dst_port
  - question: Did the FTP service respond with database error messages or unusual data?
    context: Error responses or data leakage indicate successful injection and potential information disclosure.
    range: +5m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
          src_port: 21
          bytes_toclient|gte: 100
        condition: selection
      fields:
        - bytes_toclient
        - flow.state
        - community_id
  - question: What was the sequence of FTP commands leading up to the injection attempt?
    context: Command sequence reveals attack methodology and potential authentication bypass attempts.
    range: -5m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 21
        condition: selection
      fields:
        - bytes_toserver
        - flow.state
        - community_id
  - question: Are there signs of successful SQL injection exploitation and data extraction?
    context: Successful injection may lead to database enumeration, data theft, or authentication bypass.
    range: +15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 21
          bytes_toclient|gte: 500
        condition: selection
      fields:
        - bytes_toclient
        - bytes_toserver
        - flow.age
  - question: What other web applications or services were targeted by this source with SQL injection?
    context: Multiple target applications indicate broader SQL injection campaign requiring comprehensive response.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains: "SQL Injection"
        condition: selection
      fields:
        - alert.signature
        - dst_ip
        - dst_port
  - question: Did the attacker attempt to establish persistent access after successful injection?
    context: Follow-up activities indicate successful exploitation requiring immediate containment measures.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.category|contains:
            - "Web Application Attack"
            - "Attempted Administrator Privilege Gain"
            - "Trojan Activity"
        condition: selection
      fields:
        - alert.signature
        - dst_ip
        - dst_port
  - question: Are there indicators of database backend compromise or unauthorized access?
    context: Successful FTP SQL injection may compromise underlying database containing sensitive information.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          alert.signature|contains:
            - "Database"
            - "SQL"
            - "Authentication"
        condition: selection
      fields:
        - alert.signature
        - src_ip
        - dst_port
  - question: Is this SQL injection attempt part of a broader campaign targeting multiple organizations?
    context: Coordinated SQL injection campaigns indicate sophisticated threat actors requiring threat intelligence sharing.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: "FTP Daemon Username SELECT FROM SQL Injection"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - host.name