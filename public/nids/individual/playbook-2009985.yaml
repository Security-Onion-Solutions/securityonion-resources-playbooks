name: ET FTP Possible FTP Daemon Username UNION SELECT SQL Injection Attempt
id: 22009985
description: |
  Detects SQL injection attempts targeting FTP daemon username fields using UNION SELECT syntax.
  May indicate attempts to exploit vulnerable FTP applications with database backends for data extraction.
  Could be legitimate testing or malicious exploitation targeting sensitive information disclosure.
type: detection
detection_id: 2009985
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete UNION SELECT SQL injection payload in the FTP username field?
    context: Understanding the exact union syntax reveals attacker intent to extract data from database tables.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - alert.signature
        - flow_id
  - question: Is this authorized penetration testing or legitimate database query activity?
    context: UNION SELECT operations may be part of legitimate security assessments or database reporting procedures.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 21
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - flow.state
  - question: What other data extraction SQL injection techniques were attempted?
    context: Multiple extraction methods indicate systematic data theft attempts requiring immediate data protection measures.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          alert.signature|contains:
            - "UNION"
            - "SELECT"
            - "SQL Injection"
        condition: selection
      fields:
        - alert.signature
        - dst_port
  - question: Did the FTP service respond with database content or error messages?
    context: Service responses containing data indicate successful information disclosure requiring breach assessment.
    range: +5m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
          src_port: 21
          bytes_toclient|gte: 200
        condition: selection
      fields:
        - bytes_toclient
        - flow.state
        - community_id
  - question: What database tables or columns were targeted in the UNION SELECT attempt?
    context: Understanding target data helps assess potential information disclosure and required breach notifications.
    range: -5m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 21
        condition: selection
      fields:
        - bytes_toserver
        - flow.state
        - community_id
  - question: Are there signs of successful data extraction or information disclosure?
    context: Successful UNION SELECT injection may expose sensitive data requiring immediate breach response procedures.
    range: +15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 21
          bytes_toclient|gte: 1000
        condition: selection
      fields:
        - bytes_toclient
        - bytes_toserver
        - flow.age
  - question: What other applications were targeted with UNION SELECT data extraction attacks?
    context: Multiple targets indicate coordinated data theft campaign requiring enterprise-wide data protection assessment.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains:
            - "UNION SELECT"
            - "SQL Injection"
        condition: selection
      fields:
        - alert.signature
        - dst_ip
        - dst_port
  - question: Did the attacker attempt to exfiltrate extracted data through additional channels?
    context: Post-extraction data transfer activities indicate successful data theft requiring comprehensive incident response.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          bytes_toserver|gte: 1000
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver
  - question: Are there indicators of database schema enumeration or advanced reconnaissance?
    context: Schema discovery indicates sophisticated attack requiring comprehensive database security assessment.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains:
            - "Database"
            - "Schema"
            - "Information"
        condition: selection
      fields:
        - alert.signature
        - dst_ip
        - dst_port
  - question: Is this UNION SELECT injection part of a broader data theft campaign?
    context: Enterprise-wide data extraction attacks indicate advanced persistent threats requiring coordinated threat response.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: "FTP Daemon Username UNION SELECT SQL Injection"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - host.name