name: ET FTP Possible FTP Daemon Username INTO OUTFILE SQL Injection Attempt
id: 22010081
description: |
  Detects SQL injection attempts targeting FTP daemon username fields using INTO OUTFILE syntax.
  May indicate attempts to exploit vulnerable FTP applications for file system access and backdoor creation.
  Could be legitimate testing or malicious exploitation targeting web shell deployment and persistence.
type: detection
detection_id: 2010081
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete INTO OUTFILE SQL injection payload and target file path?
    context: Understanding the exact file output syntax reveals attacker intent to create backdoors or web shells on the system.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - alert.signature
        - flow_id
  - question: Is this authorized security testing or legitimate database export activity?
    context: INTO OUTFILE operations may be part of legitimate database backup procedures or penetration testing.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 21
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - flow.state
  - question: What other file system manipulation SQL injection techniques were attempted?
    context: Multiple file operations indicate systematic backdoor deployment requiring immediate file system analysis.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          alert.signature|contains:
            - "OUTFILE"
            - "DUMPFILE"
            - "LOAD_FILE"
        condition: selection
      fields:
        - alert.signature
        - dst_port
  - question: Did the FTP service respond indicating successful or failed file creation?
    context: Service responses reveal whether malicious file creation succeeded requiring immediate file system forensics.
    range: +5m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
          src_port: 21
        condition: selection
      fields:
        - bytes_toclient
        - flow.state
        - community_id
  - question: What was the intended file path and content of the OUTFILE operation?
    context: Understanding target file locations helps identify potential web shells or backdoors requiring immediate removal.
    range: -5m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 21
        condition: selection
      fields:
        - bytes_toserver
        - flow.state
        - community_id
  - question: Are there signs of successful web shell or backdoor file creation?
    context: Successful file creation may establish persistent access requiring immediate system cleanup and hardening.
    range: +15m
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          alert.signature|contains:
            - "Web Shell"
            - "Backdoor"
            - "Suspicious File"
        condition: selection
      fields:
        - alert.signature
        - src_ip
        - dst_port
  - question: What other systems were targeted with INTO OUTFILE backdoor deployment attacks?
    context: Multiple targets indicate coordinated backdoor campaign requiring enterprise-wide file system analysis.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains:
            - "INTO OUTFILE"
            - "SQL Injection"
        condition: selection
      fields:
        - alert.signature
        - dst_ip
        - dst_port
  - question: Did the attacker attempt to access or execute the created files?
    context: Post-creation file access indicates successful backdoor deployment requiring immediate containment measures.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.request.method
        - http.response.status_code
  - question: Are there indicators of persistent access or lateral movement after file creation?
    context: Successful backdoor deployment may enable further system compromise requiring comprehensive incident response.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.category|contains:
            - "Trojan Activity"
            - "Attempted Administrator Privilege Gain"
            - "Web Application Attack"
        condition: selection
      fields:
        - alert.signature
        - dst_ip
        - dst_port
  - question: Is this INTO OUTFILE injection part of a broader web shell deployment campaign?
    context: Enterprise-wide backdoor deployment indicates advanced persistent threats requiring coordinated threat hunting.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: "FTP Daemon Username INTO OUTFILE SQL Injection"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - host.name