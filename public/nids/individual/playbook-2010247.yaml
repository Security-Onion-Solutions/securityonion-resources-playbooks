name: ET MALWARE WindowsEnterpriseSuite FakeAV Reporting via POST
id: 22010247
description: |
  Detects WindowsEnterpriseSuite fake antivirus malware reporting infection status via HTTP POST.
  This specific POST pattern with verint, uid, wv, report, abbr, and pid parameters is unique to this malware family.
type: detection
detection_id: 2010247
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What specific parameters and values were sent in the fake AV POST request?
    context: The POST body parameters reveal infection status, system identifiers, and malware configuration details.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.body.content
        - http.request.method
        - url.full
        - http.request.headers.content-type

  - question: What is the complete destination URL receiving the fake AV reports?
    context: The command and control server URL helps identify the threat actor infrastructure and campaign.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - url.path
        - url.full

  # Type 2: Triage Assessment
  - question: Is this host known to have legitimate enterprise security software installed?
    context: Distinguishing between legitimate security software communications and fake AV malware reporting.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method: 'POST'
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - http.user_agent

  - question: Does this HTTP POST pattern match known legitimate application behavior?
    context: The specific parameter structure is unique to WindowsEnterpriseSuite malware and not legitimate software.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.body.content|contains:
            - 'verint='
            - '&uid='
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - http.request.body.content

  # Type 3: Activity Context
  - question: What processes were running on the host when the fake AV reporting occurred?
    context: Identifying the malware process helps understand execution context and persistence mechanisms.
    range: -5m/+5m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid

  - question: What initial infection vector led to this fake AV installation?
    context: Understanding the delivery method helps prevent similar infections and identify attack campaigns.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - 'EXPLOIT'
            - 'MALWARE'
            - 'TROJAN'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - url.full

  # Type 4: Impact Assessment
  - question: Is the fake AV malware attempting to download additional payloads?
    context: Fake AV often serves as a dropper for additional malware or ransomware components.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method: 'GET'
        condition: selection
      fields:
        - dst_ip
        - url.full
        - http.response.mime_type
        - http.response.body.bytes

  - question: Are there signs of system modification or file encryption activities?
    context: Fake AV malware may perform system changes, file encryption, or install additional malicious components.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - Image
        - ProcessGuid

  # Type 5: Forensic Deep-Dive
  - question: What registry modifications were made by the WindowsEnterpriseSuite malware?
    context: Registry changes reveal persistence mechanisms, configuration storage, and system modifications.
    range: -30m/+30m
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetObject
        - Details
        - Image
        - ProcessGuid

  - question: What other malware families or C2 communications are present on this host?
    context: Fake AV infections often coincide with other malware families or serve as part of larger campaigns.
    range: -1d/+1d
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - 'MALWARE'
            - 'TROJAN'
            - 'command-and-control'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - url.domain

  - question: What specific WindowsEnterpriseSuite variant is indicated by the POST parameters?
    context: Parameter values and structure variations help identify specific malware variants and campaigns.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.body.content
        - rule.name
        - src_ip
        - dst_ip

  # Type 6: Enterprise Correlation
  - question: Are other hosts in the network infected with WindowsEnterpriseSuite fake AV?
    context: Identifying infection scope helps prioritize remediation and understand campaign reach.
    range: -7d/+1d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'WindowsEnterpriseSuite'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - url.domain

  - question: Is this C2 server communicating with other hosts for different malware families?
    context: Shared C2 infrastructure indicates broader threat actor operations and related campaigns.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - rule.name
        - rule.category