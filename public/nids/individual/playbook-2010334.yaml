name: ET MALWARE Dosenjo/Kvadr Proxy Trojan Activity
id: 22010334
description: |
  Detects communication with Dosenjo/Kvadr proxy trojan command and control servers.
  This malware creates unauthorized proxy connections through infected systems.
  The specific parameter pattern is unique to this malware family and not used by legitimate applications.
type: detection
detection_id: 2010334
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What is the complete URL pattern and parameters used in this Kvadr proxy trojan communication?
    context: The specific cachingDeny parameter and ID format reveal malware variant and configuration details.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - url.query
        - url.path

  - question: What is the hexadecimal ID value transmitted to the C2 server?
    context: The 16-character hex ID serves as a unique bot identifier for tracking infected systems.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - http.request.body.content
        - url.query

  # Type 2: Triage Assessment
  - question: Has this system previously exhibited proxy trojan behavior or unusual outbound connections?
    context: Historical proxy activity patterns help determine infection duration and scope of unauthorized usage.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 8080
            - 3128
            - 1080
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_sent
        - bytes_received

  - question: Are there legitimate applications on this system that might generate similar HTTP patterns?
    context: Distinguishing between malware and legitimate proxy software helps avoid false positive responses.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - "proxy"
            - "squid"
            - "nginx"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  # Type 3: Activity Context
  - question: What process initiated this malicious proxy trojan communication?
    context: Identifying the parent process reveals the malware executable and potential infection vector.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid
        - User

  - question: What other network activity occurred around the time of this proxy trojan communication?
    context: Concurrent connections may reveal additional C2 channels or proxy abuse by external actors.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - protocol
        - bytes_sent
        - bytes_received

  - question: Were there DNS queries for the C2 domain before this proxy registration?
    context: DNS resolution patterns help establish the complete attack timeline and infrastructure mapping.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          dns.query.name|expand: '%url.domain%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  # Type 4: Impact Assessment
  - question: Did the C2 server respond with proxy configuration or commands?
    context: Successful registration indicates the system is now available as an unauthorized proxy node.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes
        - http.response.body.content

  - question: Has this system been used as a proxy for external connections since infection?
    context: Evidence of proxy abuse indicates active exploitation and potential involvement in malicious campaigns.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - bytes_sent
        - bytes_received

  # Type 5: Forensic Deep-Dive
  - question: What specific Dosenjo/Kvadr variant is indicated by the communication pattern?
    context: Variant identification helps determine malware capabilities and select appropriate removal tools.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - payload

  - question: Are there file system artifacts associated with this proxy trojan installation?
    context: Malware files and registry modifications help confirm infection and guide remediation efforts.
    range: +/-30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.hash.sha256
        - ProcessImage

  # Type 6: Enterprise Correlation
  - question: Are other systems in the enterprise showing similar Kvadr proxy trojan activity?
    context: Multiple infections indicate a broader campaign requiring coordinated incident response.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Kvadr"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name