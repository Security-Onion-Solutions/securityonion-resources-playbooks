name: ET EXPLOIT Possible Oracle Database Text Component ctxsys.drvxtabc.create_tables Remote SQL Injection Attempt
id: 22010375
description: |
  Detects SQL injection attempts targeting Oracle Database Text Component via ctxsys.drvxtabc.create_tables function.
  This CVE-2009-1991 vulnerability allows remote attackers to execute arbitrary SQL commands.
  Legitimate applications should not invoke this specific function combination with SQL commands.
type: detection
detection_id: 2010375
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete SQL injection payload targeting the Oracle ctxsys component?
    context: The exact SQL commands reveal the attacker's intent and potential data targets within the database.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - alert.signature
        - src_ip
        - dst_ip
        - dst_port

  - question: What Oracle database connection parameters were used in this attack?
    context: Connection details help identify the targeted database instance and authentication method.
    range: -5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port|expand: '%dst_port%'
        condition: selection
      fields:
        - bytes_toserver
        - bytes_toclient
        - proto

  # Type 2: Triage Assessment
  - question: Is this source IP authorized to access Oracle database services?
    context: Legitimate database administrators or applications may have authorized access to Oracle systems.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 1521
            - 1522
            - 1526
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - count

  - question: Does this activity align with scheduled database maintenance or application usage?
    context: Legitimate database operations might trigger false positives during maintenance windows or application updates.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|expand: '%dst_port%'
        condition: selection
      fields:
        - src_ip
        - count

  # Type 3: Activity Context
  - question: What database enumeration or reconnaissance preceded this SQL injection attempt?
    context: Attackers typically gather database information before launching targeted SQL injection attacks.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - bytes_toserver
        - bytes_toclient

  - question: What was the sequence of database queries leading to this exploitation attempt?
    context: Understanding the attack progression helps identify the full scope of database compromise attempts.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          alert.signature|contains: 'SQL'
        condition: selection
      fields:
        - alert.signature
        - dst_port

  # Type 4: Impact Assessment
  - question: Did the SQL injection attempt result in successful database access or data extraction?
    context: Large data transfers following SQL injection indicate successful data exfiltration requiring immediate response.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - bytes_toserver
        - bytes_toclient
        - duration

  - question: Are there signs of database privilege escalation following this attack?
    context: Successful exploitation may lead to administrative access and further database compromise.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          alert.signature|contains:
            - 'Oracle'
            - 'Database'
            - 'SQL'
        condition: selection
      fields:
        - alert.signature
        - alert.severity

  # Type 5: Forensic Deep-Dive
  - question: What specific Oracle database tables or schemas were targeted in this attack?
    context: Identifying targeted database objects helps assess the scope of potential data compromise.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - payload_printable
        - alert.signature

  - question: What database management tools or SQL clients were used in this attack campaign?
    context: Identifying attack tools helps understand the sophistication level and potential attribution.
    range: -1h/+1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - http.request.headers.user_agent
        - url.full
        - http.request.method

  # Type 6: Enterprise Correlation
  - question: Are other Oracle database systems in the environment being targeted with similar attacks?
    context: Database-focused attacks often target multiple systems to maximize data access and impact.
    range: -4h/+4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: 'Oracle'
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - alert.signature
        - count

  - question: Is this part of a broader SQL injection campaign across different database platforms?
    context: Attackers often use automated tools to target multiple database types in the same campaign.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains: 'SQL'
        condition: selection
      fields:
        - alert.signature
        - dst_ip
        - count