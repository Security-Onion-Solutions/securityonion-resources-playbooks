name: ET MALWARE Dropper Checkin (often scripts.dlv4.com related)
id: 22010458
description: |
  Detects HTTP checkin requests from malware droppers, commonly associated with scripts.dlv4.com infrastructure.
  These droppers typically download and install additional malware payloads after initial system compromise.
  Legitimate applications do not use this specific parameter pattern for module communication.
type: detection
detection_id: 2010458
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What were the complete parameter values in this dropper checkin request?
    context: Parameter analysis reveals broker identification, product codes, and victim tracking information used by the dropper.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - url.path
        - url.query

  - question: What specific module or payload was being requested from the dropper infrastructure?
    context: Understanding the module request helps identify the secondary payload type and malware family being deployed.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.request.body.content
        - http.response.body.content
        - http.response.status_code
        - http.response.headers

  # Type 2: Triage Assessment
  - question: Is this system known to access legitimate module or plugin distribution services?
    context: Some legitimate software uses similar module download patterns, requiring contextual analysis.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains: "/module"
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - url.path
        - http.request.method

  - question: Has this destination been contacted by other systems in the network?
    context: Multiple systems contacting the same dropper infrastructure indicates widespread compromise or campaign activity.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|expand: '%dst_port%'
        condition: selection
      fields:
        - src_ip
        - protocol
        - bytes_out
        - bytes_in

  # Type 3: Activity Context
  - question: What process initiated this dropper communication?
    context: Identifying the parent process helps understand initial infection vector and dropper deployment method.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - User
        - ProcessGuid

  - question: What network activity preceded this dropper checkin?
    context: Prior connections may reveal initial compromise vector, exploit kit activity, or malicious email attachments.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - http.request.method
        - http.response.status_code

  - question: Were there file system changes around the time of this dropper activity?
    context: Droppers typically create temporary files, download payloads, and modify system files during operation.
    range: +/-30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          event.action|contains:
            - "created"
            - "modified"
        condition: selection
      fields:
        - file.name
        - file.path
        - process.name
        - file.hash.md5

  # Type 4: Impact Assessment
  - question: Did the dropper server respond with a payload or additional malware modules?
    context: Successful payload delivery indicates active compromise and potential for additional malicious activity installation.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
          http.response.status_code: 200
        condition: selection
      fields:
        - http.response.body.content
        - http.response.body.bytes
        - http.response.headers

  - question: Are there signs of secondary payload execution or installation?
    context: Droppers typically execute downloaded payloads immediately or install them for persistent access.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - User

  # Type 5: Forensic Deep-Dive
  - question: What is the infrastructure profile of the dropper command server?
    context: Analyzing server characteristics helps identify threat actor operations and dropper family attribution.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          dns.resolved_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - src_ip

  - question: What persistence mechanisms were established by the dropper or its payloads?
    context: Understanding persistence helps with complete malware removal and prevents reinfection attempts.
    range: +/-4h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          registry.path|contains:
            - "\\Run"
            - "\\RunOnce"
            - "\\Services"
            - "\\Policies"
        condition: selection
      fields:
        - registry.path
        - registry.value
        - process.name
        - event.action

  # Type 6: Enterprise Correlation
  - question: Are other endpoints showing similar dropper activity or contacting related infrastructure?
    context: Identifies campaign scope and potential network-based spreading or coordinated infection attempts.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Dropper"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - timestamp

  - question: Is this part of a broader malware distribution campaign using similar infrastructure?
    context: Correlating related infrastructure helps identify threat actor operations and campaign attribution.
    range: +/-7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - protocol
        - bytes_out