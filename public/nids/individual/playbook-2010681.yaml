name: ET SCAN ICMP Delphi Likely Precursor to Scan
id: 22010681
description: |
  Detects ICMP ping packets containing "Pinging from Delphi code written" string.
  This indicates network reconnaissance using Delphi-based scanning tools or custom applications.
  May trigger on legitimate network testing tools written in Delphi programming language.
type: detection
detection_id: 2010681
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete ICMP payload containing the Delphi code signature?
    context: The full payload may reveal additional information about the scanning tool or custom application being used.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - alert.signature
        - src_ip
        - dst_ip
        - payload_printable
        - icmp.type
        - icmp.code

  - question: What specific Delphi application or tool generated this ICMP ping pattern?
    context: Understanding the source application helps determine if this is reconnaissance or legitimate network testing.
    range: -15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver
        - connection_state

  # Type 2: Triage Assessment
  - question: Is this source IP authorized to perform network scanning or testing?
    context: Legitimate network administrators may use Delphi-based tools for network diagnostics and monitoring.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection_state
        - duration

  - question: Are there documented network testing or monitoring activities scheduled for this timeframe?
    context: Scheduled network maintenance or testing activities might legitimately use custom Delphi tools.
    range: -2h/+2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains:
            - 'SCAN'
            - 'PING'
        condition: selection
      fields:
        - dst_ip
        - alert.signature
        - alert.category

  # Type 3: Activity Context
  - question: What network reconnaissance preceded this Delphi-based ICMP scanning?
    context: ICMP pings often follow initial network discovery to identify live hosts before port scanning.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection_state
        - bytes_toserver

  - question: What port scanning or service enumeration followed this ICMP reconnaissance?
    context: ICMP host discovery typically precedes systematic port scanning to identify vulnerable services.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains:
            - 'SCAN'
            - 'Portscan'
        condition: selection
      fields:
        - dst_ip
        - alert.signature
        - alert.severity

  - question: How many hosts were targeted by this Delphi-based ICMP scanning?
    context: The scope of scanning helps determine if this is targeted reconnaissance or broad network discovery.
    range: -30m/+30m
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains: 'Delphi'
        condition: selection
      fields:
        - dst_ip
        - alert.signature

  # Type 4: Impact Assessment
  - question: What sensitive network segments or systems were discovered through this scanning?
    context: Understanding what was discovered helps assess the potential impact of subsequent attacks.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection_state

  - question: Are there signs of successful exploitation following this reconnaissance?
    context: Successful reconnaissance often leads to targeted exploitation attempts against discovered services.
    range: +6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains: 'EXPLOIT'
        condition: selection
      fields:
        - dst_ip
        - alert.signature
        - alert.severity

  # Type 5: Forensic Deep-Dive
  - question: What specific Delphi network scanning framework or tool is being used?
    context: Different Delphi-based tools have varying capabilities and may indicate specific threat actor preferences.
    range: -2h/+2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains:
            - 'SCAN'
            - 'ICMP'
        condition: selection
      fields:
        - dst_ip
        - alert.signature
        - alert.category

  - question: Are there patterns indicating automated scanning versus manual network testing?
    context: Timing patterns and target selection can reveal whether this is automated reconnaissance or manual testing.
    range: -4h/+4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - duration

  - question: What other custom tools or applications is this attacker using for reconnaissance?
    context: Custom tool usage may indicate sophisticated threat actor with developed capabilities.
    range: -6h/+6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains:
            - 'SCAN'
            - 'Custom'
        condition: selection
      fields:
        - dst_ip
        - alert.signature

  # Type 6: Enterprise Correlation
  - question: Are multiple network segments experiencing this Delphi-based reconnaissance?
    context: Enterprise-wide scanning indicates comprehensive network mapping for potential large-scale attack.
    range: -4h/+4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: 'Delphi'
        condition: selection
      fields:
        - src_ip
        - dst_ip

  - question: What other reconnaissance techniques is this attacker employing across the enterprise?
    context: Multiple reconnaissance methods indicate systematic approach to network mapping and vulnerability discovery.
    range: -12h/+12h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains:
            - 'SCAN'
            - 'Reconnaissance'
            - 'Discovery'
        condition: selection
      fields:
        - dst_ip
        - alert.signature
        - alert.category