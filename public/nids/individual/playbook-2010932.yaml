name: ET MALWARE Dropper Checkin 2 (often scripts.dlv4.com related)
id: 22010932
description: |
  Detects additional HTTP checkin patterns from malware droppers, commonly associated with scripts.dlv4.com infrastructure.
  This variant uses different parameter combinations but serves the same purpose of downloading secondary payloads.
  Legitimate applications do not typically use this specific parameter pattern for automated page generation.
type: detection
detection_id: 2010932
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What were the specific parameter values in this dropper variant checkin?
    context: Parameter analysis reveals dropper configuration, victim tracking, and payload selection criteria.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - url.path
        - url.query

  - question: What does the autogenerated page parameter indicate about the dropper operation?
    context: Understanding the page generation mechanism helps identify dropper customization and targeting capabilities.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.request.body.content
        - http.response.body.content
        - http.response.status_code
        - http.response.headers

  # Type 2: Triage Assessment
  - question: Is this system known to use legitimate automated content generation services?
    context: Some legitimate applications use automated page generation, requiring contextual analysis to distinguish from malware.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.query|contains: "autogenerated"
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - url.path
        - http.request.method

  - question: Has this dropper infrastructure been contacted by other network systems?
    context: Multiple infected systems contacting the same infrastructure indicates campaign scope and spreading mechanisms.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|expand: '%dst_port%'
        condition: selection
      fields:
        - src_ip
        - protocol
        - bytes_out
        - bytes_in

  # Type 3: Activity Context
  - question: What process was responsible for initiating this dropper communication?
    context: Identifying the parent process helps understand infection method and dropper execution context.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - User
        - ProcessGuid

  - question: What network connections were established prior to this dropper activity?
    context: Prior connections may reveal initial infection vector, exploit delivery, or command server communication.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - http.request.method
        - http.response.status_code

  - question: Were there concurrent file system modifications during this dropper operation?
    context: Droppers typically create temporary files, download payloads, and modify system configurations.
    range: +/-30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          event.action|contains:
            - "created"
            - "modified"
            - "deleted"
        condition: selection
      fields:
        - file.name
        - file.path
        - process.name
        - file.hash.md5

  # Type 4: Impact Assessment
  - question: Did the dropper server deliver a payload or provide installation instructions?
    context: Server response analysis determines if payload delivery was successful and what type of malware was deployed.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
          http.response.status_code: 200
        condition: selection
      fields:
        - http.response.body.content
        - http.response.body.bytes
        - http.response.headers

  - question: Are there indicators of secondary malware installation or execution?
    context: Successful dropper operation typically results in additional malware deployment and system compromise.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - User

  # Type 5: Forensic Deep-Dive
  - question: What is the hosting and infrastructure profile of this dropper server?
    context: Server analysis helps identify threat actor operations, hosting patterns, and malware family attribution.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - tls.server.certificate.subject
        - tls.server.certificate.issuer
        - tls.server.certificate.not_after

  - question: What persistence mechanisms were established by this dropper variant?
    context: Understanding persistence helps with complete malware removal and prevents dropper reactivation.
    range: +/-4h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          registry.path|contains:
            - "\\Run"
            - "\\RunOnce"
            - "\\Services"
            - "\\Windows\\CurrentVersion"
        condition: selection
      fields:
        - registry.path
        - registry.value
        - process.name
        - event.action

  # Type 6: Enterprise Correlation
  - question: Are other systems showing similar dropper variant activity patterns?
    context: Identifies campaign scope and potential coordinated infection attempts across the network.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Dropper"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - timestamp

  - question: Is this part of a broader malware campaign using scripts.dlv4.com infrastructure?
    context: Correlating related infrastructure helps identify threat actor operations and campaign coordination.
    range: +/-7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          dns.query.name|contains: "dlv4.com"
        condition: selection
      fields:
        - src_ip
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name