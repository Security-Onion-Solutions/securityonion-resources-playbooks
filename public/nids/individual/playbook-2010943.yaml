name: ET ACTIVEX SoftCab Sound Converter ActiveX SaveFormat File overwrite Attempt
id: 22010943
description: |
  Detects exploitation attempts against SoftCab Sound Converter ActiveX control using SaveFormat method for file overwrite.
  This vulnerability allows arbitrary file overwrite leading to system compromise. May trigger on legitimate ActiveX usage.
type: detection
detection_id: 2010943
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete ActiveX object instantiation and method call?
    context: The full HTML content reveals the malicious ActiveX control usage and target file paths.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.response.body.content
        - url.full
        - http.response.headers

  - question: Is SoftCab Sound Converter legitimately installed on client systems?
    context: Legitimate installations may trigger false positives during normal ActiveX operations.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.response.body.content|contains: "66757BFC-DA0C-41E6-B3FE-B6D461223FF5"
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - http.response.status_code

  - question: What website is hosting the malicious ActiveX content?
    context: Identifying the hosting website helps determine the attack vector and potential campaign scope.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.domain
        - url.path
        - dst_ip
        - http.request.headers

  - question: What other ActiveX-related activity occurred from this client?
    context: Multiple ActiveX exploitation attempts may indicate a broader malware campaign or drive-by download.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.response.body.content|contains: "classid"
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - url.path

  - question: Has the client system shown signs of successful compromise?
    context: Successful ActiveX exploitation may result in file system changes or malicious process execution.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ParentImage

  - question: What files were accessed or modified on the client system after the attack?
    context: The SaveFormat method can overwrite critical system files, indicating successful exploitation.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - User
        - ProcessName

  - question: What DNS queries were made to resolve the malicious domain?
    context: DNS resolution patterns help identify the attack infrastructure and potential command and control.
    range: -5m
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.resolved_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.resolved_ip

  - question: Are there registry modifications related to ActiveX security settings?
    context: Attackers may modify registry settings to bypass ActiveX security controls and enable exploitation.
    range: +/-30m
    query: |
      aggregation: true
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - "ActiveX"
            - "66757BFC-DA0C-41E6-B3FE-B6D461223FF5"
        condition: selection
      fields:
        - TargetObject
        - Details
        - User

  - question: What network connections were established after the ActiveX exploitation?
    context: Successful compromise often results in callback connections to attacker infrastructure.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.bytes
        - network.protocol

  - question: Are other clients accessing the same malicious website?
    context: Multiple clients accessing the same malicious site indicates a broader organizational impact.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.domain|expand: '%url.domain%'
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.request.headers

  - question: What SSL certificate information is available for the malicious site?
    context: SSL certificate details help identify the attack infrastructure and potential attribution.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - tls.server.certificate.subject
        - tls.server.certificate.issuer
        - tls.server.certificate.serial_number