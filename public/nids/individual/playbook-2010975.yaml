name: ET MALWARE Unruy Downloader Checkin
id: 22010975
description: |
  Detects Unruy downloader malware command and control communication patterns.
  Indicates active malware infection with established C2 channel requiring immediate response.
type: detection
detection_id: 2010975
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete C2 communication URL and parameters?
    context: The full URL reveals victim system information and C2 infrastructure details.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.full
        - url.query
        - http.request.method

  - question: Is this system known to be infected with Unruy malware?
    context: Previous Unruy activity confirms ongoing infection requiring immediate containment.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "Unruy"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - url.domain

  - question: What C2 server is the malware communicating with?
    context: Identifying C2 infrastructure helps block communication and assess campaign scope.
    range: -1h/+1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - http.response.status_code

  - question: How frequently is the malware checking in with C2?
    context: Communication frequency indicates malware configuration and potential for command reception.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.query|contains: "U="
        condition: selection
      fields:
        - url.full
        - http.response.status_code
        - dst_ip

  - question: What process is hosting the Unruy malware?
    context: Identifying the malware process enables targeted termination and forensic analysis.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid
        - ParentImage

  - question: Has the C2 server responded with commands or payloads?
    context: C2 responses may contain additional malware or instructions for data theft.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes
        - url.full

  - question: Are there signs of data exfiltration from this infected system?
    context: Unruy malware may steal sensitive data requiring breach assessment.
    range: -2h/+1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.bytes_sent
        - network.bytes_received

  - question: What files has the malware accessed or modified?
    context: File activity reveals data theft targets and persistence mechanisms.
    range: -1h/+30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - file.path
        - file.name
        - User
        - file.hash.md5

  - question: Are there registry modifications indicating malware persistence?
    context: Registry changes show how malware maintains persistence across reboots.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetObject
        - Details
        - User

  - question: Are other internal systems infected with Unruy malware?
    context: Multiple infections indicate enterprise-wide compromise requiring coordinated response.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Unruy"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - url.domain

  - question: What is the timeline of initial Unruy infection on this system?
    context: Infection timeline helps identify attack vector and assess data exposure duration.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - "MALWARE"
            - "TROJAN"
        condition: selection
      fields:
        - rule.name
        - dst_ip