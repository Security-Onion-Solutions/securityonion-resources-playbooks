name: ET WEB_SERVER /bin/csh In URI Possible Shell Command Execution Attempt
id: 22011464
description: |
  Detects attempts to execute the csh shell via URI path, indicating potential
  command injection or web shell exploitation. May trigger on legitimate
  applications that reference shell binaries in paths or documentation.
type: detection
detection_id: 2011464
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete URI path containing the /bin/csh reference?
    context: The full URI reveals the attack vector and specific application endpoint being targeted.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.full
        - url.path
        - http.request.method

  - question: What HTTP headers and user agent were included in this request?
    context: Headers may reveal automated tools or specific exploitation frameworks being used.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - user_agent.original
        - http.request.headers
        - http.request.body.content

  # Type 2: Triage Assessment
  - question: Is this web server known to legitimately use csh shell references?
    context: Some Unix applications may reference csh for configuration or system operations.
    range: -14d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|expand: '%dst_port%'
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.request.method

  - question: Does this request originate from a known administrative or development network?
    context: Legitimate shell references are more common from trusted administrative sources.
    range: -1d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - url.path
        - http.request.method

  # Type 3: Activity Context
  - question: What scanning or enumeration activity preceded this shell execution attempt?
    context: Command injection attempts often follow web application reconnaissance.
    range: -45m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.request.method
        - http.response.status_code
        - user_agent.original

  - question: What other shell or command injection patterns were attempted?
    context: Attackers typically try multiple shell types and injection techniques.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - '/bin/'
            - 'shell'
            - 'command'
            - 'injection'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - url.path

  # Type 4: Impact Assessment
  - question: How did the web server respond to this shell execution attempt?
    context: Response codes and content reveal whether the injection was successful.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes
        - http.response.body.content

  - question: What outbound network activity originated from the target server?
    context: Successful command execution may establish reverse shells or exfiltrate data.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.protocol
        - network.bytes

  # Type 5: Forensic Deep-Dive
  - question: Are there signs of web shell deployment or persistent backdoor installation?
    context: Successful shell execution often results in web shell installation for persistent access.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          http.request.method: 'POST'
        condition: selection
      fields:
        - url.path
        - http.request.body.content
        - src_ip
        - user_agent.original

  - question: What system processes were spawned on the target server after this request?
    context: Shell commands may execute system utilities for reconnaissance or data access.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - user.name

  # Type 6: Enterprise Correlation
  - question: Are other web servers being targeted with similar csh execution attempts?
    context: Coordinated attacks often use the same techniques across multiple targets.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: '/bin/csh'
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - url.path

  - question: What other malicious activity patterns are associated with this source IP?
    context: Attackers often exhibit multiple attack behaviors across different systems and timeframes.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - dst_ip
        - url.path