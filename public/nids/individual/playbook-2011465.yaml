name: ET WEB_SERVER /bin/sh In URI Possible Shell Command Execution Attempt
id: 22011465
description: |
  Detects attempts to execute the sh shell via URI path, indicating potential
  command injection or web shell exploitation. May trigger on legitimate
  applications that reference shell binaries in paths or documentation.
type: detection
detection_id: 2011465
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete URI path containing the /bin/sh reference?
    context: The full URI reveals the attack vector and target application endpoint.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.full
        - url.path
        - http.request.method

  - question: What additional command parameters or arguments were included?
    context: Command parameters reveal the specific malicious intent and payload.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.request.body.content
        - url.query
        - http.request.headers

  # Type 2: Triage Assessment
  - question: Is this web application known to legitimately reference shell paths?
    context: Some applications may reference shell binaries for system information or documentation.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|expand: '%dst_port%'
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.request.method

  - question: Does the source IP have a history of legitimate access to this server?
    context: Established users are less likely to be conducting malicious shell execution.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.request.method
        - http.response.status_code

  # Type 3: Activity Context
  - question: What vulnerability scanning or reconnaissance preceded this attempt?
    context: Shell execution attempts often follow reconnaissance of vulnerable endpoints.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.request.method
        - http.response.status_code
        - user_agent.original

  - question: What other command injection patterns were attempted from this source?
    context: Attackers often try multiple injection techniques against the same target.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'command'
            - 'injection'
            - 'shell'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - url.path

  # Type 4: Impact Assessment
  - question: Did the server respond successfully to the shell execution request?
    context: HTTP 200 responses may indicate successful command execution.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes
        - http.response.body.content

  - question: What network connections were established from the target server afterward?
    context: Successful shell execution may result in reverse shells or data exfiltration.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.protocol
        - network.bytes

  # Type 5: Forensic Deep-Dive
  - question: Are there indicators of web shell installation or backdoor deployment?
    context: Successful command execution often leads to persistent access mechanisms.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          http.request.method: 'POST'
        condition: selection
      fields:
        - url.path
        - http.request.body.content
        - src_ip
        - user_agent.original

  - question: What process execution occurred on the target server following this request?
    context: Shell commands may spawn processes for system reconnaissance or data access.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - user.name

  # Type 6: Enterprise Correlation
  - question: Are other systems experiencing similar shell execution attempts from this source?
    context: Coordinated attacks often target multiple web servers with the same techniques.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: '/bin/sh'
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - url.path

  - question: What other malicious indicators are associated with this source IP across the enterprise?
    context: Attackers often exhibit multiple malicious behaviors across different systems.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - dst_ip