name: ET WEB_SERVER /bin/tsh In URI Possible Shell Command Execution Attempt
id: 22011466
description: |
  Detects attempts to execute the tsh shell via URI path, indicating potential
  command injection or web shell exploitation. May trigger on legitimate
  applications that reference shell binaries in paths or documentation.
type: detection
detection_id: 2011466
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete URI path containing the /bin/tsh reference?
    context: The full URI reveals the attack vector and target application endpoint.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.full
        - url.path
        - http.request.method

  - question: What HTTP method and additional parameters were used in this request?
    context: POST requests with parameters often indicate command injection attempts.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.request.method
        - http.request.body.content
        - url.query

  # Type 2: Triage Assessment
  - question: Is this web server known to legitimately reference shell binaries?
    context: Some applications may reference shell paths in documentation or configuration.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|expand: '%dst_port%'
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.request.method

  - question: Does this activity align with normal business hours and user patterns?
    context: Shell execution attempts outside business hours are more suspicious.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - http.request.method

  # Type 3: Activity Context
  - question: What preceded this shell execution attempt in the same session?
    context: Previous requests may show reconnaissance or vulnerability scanning.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.request.method
        - http.response.status_code

  - question: What other shell-related activity occurred from this source?
    context: Multiple shell references indicate systematic exploitation attempts.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'shell'
            - '/bin/'
            - 'command'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - url.path

  # Type 4: Impact Assessment
  - question: Did the web server respond with success codes to this request?
    context: Successful responses may indicate command execution or web shell deployment.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes
        - http.response.body.content

  - question: What outbound connections originated from the target server after this request?
    context: Command execution may result in reverse shells or data exfiltration.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.protocol
        - network.bytes

  # Type 5: Forensic Deep-Dive
  - question: Are there signs of web shell deployment or persistence mechanisms?
    context: Successful exploitation often results in web shell installation.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          http.request.method: 'POST'
        condition: selection
      fields:
        - url.path
        - http.request.body.content
        - src_ip

  - question: What file system activity occurred on the target server?
    context: Shell execution may result in file creation, modification, or deletion.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - file.path
        - file.name
        - event.action
        - process.name

  # Type 6: Enterprise Correlation
  - question: Are other web servers experiencing similar shell execution attempts?
    context: Coordinated attacks often target multiple systems simultaneously.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: '/bin/'
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - url.path