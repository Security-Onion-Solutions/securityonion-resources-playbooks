name: ET HUNTING Suspicious Percentage Symbol Usage in FTP Username
id: 22011487
description: |
  Detects FTP login attempts containing percentage symbols in usernames.
  This pattern may indicate URL encoding exploitation attempts or obfuscation techniques.
  Could also trigger on legitimate applications using encoded usernames for authentication.
type: detection
detection_id: 2011487
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete FTP username containing the percentage symbol?
    context: The exact username reveals the encoding pattern and potential exploitation technique being used.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - ftp.user
        - ftp.command

  - question: What does the URL-decoded username resolve to?
    context: Decoding the username may reveal the actual target account or exploitation payload.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - ftp.user
        - ftp.password
        - ftp.response_code

  # Type 2: Triage Assessment
  - question: Is this FTP server known to accept encoded usernames for legitimate purposes?
    context: Some applications legitimately use URL-encoded usernames for special characters or authentication tokens.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: ftp
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 21
        condition: selection
      fields:
        - src_ip
        - ftp.user
        - ftp.response_code

  - question: Does the source IP have a history of successful FTP authentication?
    context: Established FTP users are less likely to be conducting exploitation attempts.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: ftp
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          ftp.response_code: '230'
        condition: selection
      fields:
        - ftp.user
        - ftp.command

  # Type 3: Activity Context
  - question: What other FTP commands were attempted in this session?
    context: The sequence of FTP commands reveals the attacker's intent and exploitation methodology.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: ftp
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - ftp.command
        - ftp.command_arg
        - ftp.response_code

  - question: Were there multiple login attempts with different encoded usernames?
    context: Brute force attacks may use various encoding techniques to bypass authentication controls.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: ftp
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          ftp.user|contains: '%'
        condition: selection
      fields:
        - ftp.user
        - ftp.response_code

  - question: What was the authentication outcome for this encoded username attempt?
    context: Successful authentication with encoded usernames may indicate compromise or legitimate encoded access.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: ftp
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - ftp.response_code
        - ftp.response_text

  # Type 4: Impact Assessment
  - question: Did the FTP session result in successful file transfers or directory access?
    context: Successful exploitation may lead to data exfiltration or malware upload activities.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: ftp
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          ftp.command|contains:
            - 'RETR'
            - 'STOR'
            - 'LIST'
        condition: selection
      fields:
        - ftp.command
        - ftp.command_arg
        - ftp.response_code

  - question: Are there signs of privilege escalation or system compromise on the FTP server?
    context: Successful exploitation may lead to further system compromise beyond FTP access.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  # Type 5: Forensic Deep-Dive
  - question: What specific vulnerability is being targeted by this encoding technique?
    context: Understanding the exploitation method helps identify the specific FTP server vulnerability.
    range: -5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 21
        condition: selection
      fields:
        - network.bytes_sent
        - network.bytes_received

  - question: Are there indicators of automated exploitation tools or scanners?
    context: Rapid successive attempts with various encoded patterns may indicate automated exploitation tools.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: ftp
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - ftp.user

  # Type 6: Enterprise Correlation
  - question: Are other FTP servers in the network experiencing similar encoded username attempts?
    context: Coordinated attacks may target multiple FTP services simultaneously across the organization.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: 'ET HUNTING Suspicious Percentage Symbol Usage in FTP Username'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - ftp.user

  - question: Is this source IP conducting reconnaissance against other network services?
    context: Attackers often scan multiple services before focusing exploitation efforts on vulnerable targets.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.protocol