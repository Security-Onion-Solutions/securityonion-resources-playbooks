name: ET MALWARE carberp check in
id: 22011798
description: |
  Detects Carberp banking trojan check-in communication via POST to /set/first.html.
  Unlikely to trigger on legitimate traffic due to specific URI pattern and parameters.
type: detection
detection_id: 2011798
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete POST request body containing the Carberp check-in data?
    context: Analyzing id, os, and plist parameters reveals infected system information sent to C2.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - http.request.body.content

  - question: What system information was transmitted in the Carberp beacon?
    context: The POST body contains victim system details used by attackers for targeting.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.request.body.content
        - url.path
        - http.request.method

  # Type 2: Triage Assessment
  - question: Is this the first Carberp check-in from this host?
    context: Initial infections show first-time check-ins, while established infections show regular beacons.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path: "/set/first.html"
          http.request.method: POST
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - http.request.body.bytes

  - question: Does this host show signs of legitimate banking or financial software?
    context: Distinguishing between malware and legitimate financial applications reduces false positives.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.domain|contains:
            - 'bank'
            - 'financial'
            - 'credit'
        condition: selection
      fields:
        - url.domain
        - url.path
        - http.request.method

  # Type 3: Activity Context
  - question: What process was responsible for generating this Carberp communication?
    context: Identifying the infected process helps understand the infection vector and persistence.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ParentImage

  - question: What network activity preceded this Carberp check-in?
    context: Understanding infection chain helps identify initial compromise vector.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.protocol
        - network.bytes_toserver

  - question: Are there signs of web browser exploitation that led to this infection?
    context: Carberp often spreads through exploit kits targeting browser vulnerabilities.
    range: -4h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.response.status_code: 200
        condition: selection
      fields:
        - url.full
        - http.request.headers.user_agent
        - http.response.body.bytes

  # Type 4: Impact Assessment
  - question: What commands or tasks were received from the Carberp C2 server?
    context: C2 responses contain instructions for data theft, additional downloads, or lateral movement.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.request.method: GET
        condition: selection
      fields:
        - url.full
        - http.response.body.content
        - http.response.status_code

  - question: Were any additional malware components downloaded after check-in?
    context: Carberp often downloads additional modules for specific banking fraud capabilities.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          event.action: FileCreate
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size

  # Type 5: Forensic Deep-Dive
  - question: What banking websites has this infected host accessed recently?
    context: Carberp targets specific financial institutions for credential theft and fraud.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.domain|contains:
            - 'bank'
            - 'credit'
            - 'paypal'
            - 'financial'
        condition: selection
      fields:
        - url.domain
        - url.path
        - http.request.method

  - question: Are there indicators of credential harvesting or form grabbing?
    context: Carberp specializes in stealing banking credentials through form interception.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method: POST
          http.request.body.content|contains:
            - 'password'
            - 'login'
            - 'username'
        condition: selection
      fields:
        - url.domain
        - http.request.body.bytes
        - url.path

  # Type 6: Enterprise Correlation
  - question: Are other hosts in the network infected with Carberp?
    context: Banking trojans often spread laterally or through shared infection vectors.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "carberp"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is this part of a broader financial fraud campaign?
    context: Carberp infections often coincide with other banking trojans in coordinated campaigns.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.category: "A Network Trojan was detected"
          rule.name|contains:
            - 'banking'
            - 'trojan'
            - 'financial'
        condition: selection
      fields:
        - src_ip
        - rule.name
        - alert.severity