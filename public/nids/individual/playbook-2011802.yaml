name: ET DNS DNS Lookup for localhost.DOMAIN.TLD
id: 22011802
description: |
  Detects DNS queries for localhost.DOMAIN.TLD patterns, often indicating malware or misconfigured applications.
  Legitimate systems typically resolve localhost locally without DNS queries.
  May indicate malware attempting to resolve hardcoded localhost domains or configuration errors.
type: detection
detection_id: 2011802
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact localhost domain pattern queried?
    context: The specific domain format helps identify malware families or misconfigured applications causing these lookups.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - dns.query.name
        - rule.name
        - payload

  - question: What DNS query type was used for the localhost lookup?
    context: The query type (A, AAAA, etc.) provides insight into what the application was trying to resolve.
    range: -5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.resolved_ip

  # Type 2: Triage Assessment
  - question: Is this system running applications known to have localhost DNS lookup issues?
    context: Some legitimate applications may be misconfigured to query localhost domains externally.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine

  - question: Has this source shown other suspicious DNS patterns recently?
    context: Multiple unusual DNS queries suggest malware rather than simple misconfiguration.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name

  - question: Is this occurring during normal business hours when legitimate configuration changes might happen?
    context: Timing helps distinguish between malware activity and legitimate but misconfigured applications.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name

  # Type 3: Activity Context
  - question: What processes were making network connections around the time of this DNS query?
    context: Identifying the source application helps determine if this is malware or misconfigured legitimate software.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  - question: What other network activity accompanied this localhost DNS lookup?
    context: Associated network connections help understand the application's purpose and identify malicious behavior.
    range: -15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - community_id

  # Type 4: Impact Assessment
  - question: Did the DNS server respond to this localhost query with any resolution?
    context: Understanding if the query was resolved helps assess potential impact and configuration issues.
    range: -10m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.query.name|contains: 'localhost'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.response_code

  - question: Are there signs of the system attempting to connect to resolved localhost addresses?
    context: Connections to resolved localhost domains indicate potential malware C2 communication or data exfiltration.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out

  # Type 5: Forensic Deep-Dive
  - question: What configuration files or registry entries might be causing these localhost DNS queries?
    context: Identifying configuration sources helps with remediation and understanding root cause.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - '.conf'
            - '.cfg'
            - 'hosts'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5

  - question: Are there registry modifications related to DNS or network configuration?
    context: Registry changes might indicate malware modifying DNS settings or legitimate software misconfiguration.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - 'DNS'
            - 'TCP'
            - 'Network'
        condition: selection
      fields:
        - TargetObject
        - Details

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network making similar localhost DNS queries?
    context: Multiple systems with localhost DNS queries indicate widespread misconfiguration or malware campaign.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          dns.query.name|contains: 'localhost'
        condition: selection
      fields:
        - src_ip
        - dns.query.name

  - question: Is this part of a broader DNS anomaly pattern across the organization?
    context: Enterprise-wide DNS anomalies help identify coordinated attacks or systematic configuration issues.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'DNS'
        condition: selection
      fields:
        - src_ip
        - rule.name