name: ET MALWARE X-Tag Zeus Mitmo user agent
id: 22011926
description: |
  Detects Zeus Mitmo mobile banking trojan communication using distinctive X-Tag user agent string.
  Indicates compromised mobile device communicating with Zeus command and control infrastructure.
type: detection
detection_id: 2011926
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete HTTP request containing the Zeus Mitmo X-Tag header?
    context: Understanding the full HTTP communication reveals C2 protocol details and potential data exfiltration.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - http.request.headers
        - payload_printable

  - question: What specific X-Tag value and additional headers were transmitted?
    context: X-Tag values may contain victim identification or campaign information for malware operators.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.request.headers
        - http.request.body.content
        - user_agent.original

  # Type 2: Triage Assessment
  - question: Is this device known to be infected with Zeus Mitmo malware?
    context: Confirming previous Zeus infections helps establish timeline and infection vector.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains:
            - "Zeus"
            - "banking"
            - "trojan"
        condition: selection
      fields:
        - alert.signature
        - dst_ip
        - alert.category

  - question: Does this mobile device have legitimate business justification for external connections?
    context: Corporate mobile devices may have authorized external communications that could mask malicious traffic.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - http.request.method

  # Type 3: Activity Context
  - question: What mobile banking or financial applications were accessed before this communication?
    context: Zeus Mitmo targets mobile banking sessions to intercept SMS tokens and credentials.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.domain|contains:
            - "bank"
            - "financial"
            - "paypal"
            - "mobile"
        condition: selection
      fields:
        - url.full
        - http.request.method
        - dst_ip

  - question: What SMS or authentication-related network activity occurred around this time?
    context: Zeus Mitmo intercepts SMS authentication tokens, which may generate related network traffic.
    range: -30m/+30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 25
            - 587
            - 465
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto

  # Type 4: Impact Assessment
  - question: What sensitive data was potentially exfiltrated in this Zeus communication?
    context: Zeus Mitmo steals banking credentials, SMS tokens, and personal information from mobile devices.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.request.body.content
        - http.response.body.content
        - bytes_toserver
        - bytes_toclient

  - question: Are there signs of credential harvesting or account compromise?
    context: Successful Zeus infections often lead to unauthorized banking transactions or account access.
    range: +24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.domain|contains:
            - "bank"
            - "financial"
            - "paypal"
        condition: selection
      fields:
        - url.full
        - http.request.method
        - dst_ip

  # Type 5: Forensic Deep-Dive
  - question: What Zeus Mitmo campaign or variant does this X-Tag pattern indicate?
    context: Different Zeus campaigns use distinct X-Tag formats to identify victims and track infections.
    range: -1h/+1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains: "Zeus"
        condition: selection
      fields:
        - alert.signature
        - dst_ip
        - payload_printable

  - question: What command and control infrastructure is this Zeus variant using?
    context: Identifying C2 servers helps understand the threat actor and enables blocking additional communications.
    range: -6h/+6h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.headers|contains: "X-Tag"
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - url.path

  - question: Are there indicators of Zeus persistence mechanisms on this mobile device?
    context: Zeus Mitmo establishes persistence through various mobile-specific techniques.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ParentImage

  # Type 6: Enterprise Correlation
  - question: Are other mobile devices showing similar Zeus Mitmo infection indicators?
    context: Zeus campaigns often target multiple devices within an organization through phishing or malicious apps.
    range: -24h/+24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: "Zeus Mitmo"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature