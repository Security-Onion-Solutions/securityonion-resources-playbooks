name: ET WEB_CLIENT Hex Obfuscation of arguments.callee % Encoding
id: 22012061
description: |
  Detects hex-encoded obfuscation of JavaScript arguments.callee function using percent encoding.
  May trigger on legitimate applications using encoded JavaScript for dynamic function execution.
type: detection
detection_id: 2012061
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete hex-encoded arguments.callee payload detected?
    context: Understanding the full obfuscated payload reveals the self-referencing JavaScript technique and intent.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.body.content
        - http.response.body.content
        - url.full
  - question: Is this legitimate use of encoded arguments.callee by this application?
    context: Some applications legitimately use arguments.callee for recursive functions or dynamic execution.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.domain
        - http.request.method
        - src_ip
  - question: What web page or script contained this obfuscated arguments.callee code?
    context: Identifying the source helps determine if this is part of a polymorphic malware attack.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.full
        - http.request.referrer
        - http.response.status_code
        - http.response.mime_type
  - question: What other self-modifying or recursive JavaScript techniques were detected?
    context: arguments.callee is often used in polymorphic malware for self-modification and evasion.
    range: +/-30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.response.body.content|contains:
            - 'arguments'
            - 'callee'
            - 'caller'
            - 'eval'
        condition: selection
      fields:
        - url.full
        - http.response.body.content
        - dst_ip
  - question: Did the self-referencing JavaScript execute and modify its own behavior?
    context: Successful arguments.callee execution may indicate polymorphic malware or exploit evasion.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method: 'POST'
        condition: selection
      fields:
        - url.full
        - http.request.body.content
        - http.response.status_code
        - dst_ip
  - question: Were any dynamic files or payloads generated after the JavaScript execution?
    context: Self-modifying JavaScript may generate new malware variants or download additional components.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - '.js'
            - '.exe'
            - '.tmp'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.mime_type
        - User
  - question: What processes were spawned that could indicate successful polymorphic execution?
    context: Self-modifying JavaScript exploits may create processes with varying characteristics.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ParentImage
  - question: Were JavaScript debugging or execution controls modified during this activity?
    context: Polymorphic malware may disable debugging to prevent analysis of self-modification.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - 'Script'
            - 'Debug'
            - 'JScript'
        condition: selection
      fields:
        - TargetObject
        - Details
        - User
        - Image
  - question: What DNS queries were made that could indicate variant malware communications?
    context: Polymorphic malware may use different communication patterns or domains.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name
  - question: Are other systems showing similar arguments.callee obfuscation patterns?
    context: Polymorphic campaigns may use consistent self-modification techniques across targets.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'arguments.callee'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - alert.severity
  - question: What is the hosting profile of servers delivering self-modifying JavaScript?
    context: Advanced exploit kits may specialize in polymorphic JavaScript delivery mechanisms.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - bytes_in
        - bytes_out