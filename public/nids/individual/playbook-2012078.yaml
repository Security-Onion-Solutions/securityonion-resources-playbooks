name: ET INFO Windows-Based OpenSSL Tunnel Outbound
id: 22012078
description: |
  Detects outbound SSL/TLS connections using Windows-based OpenSSL tunnel software with specific cipher suite patterns.
  May indicate legitimate encrypted tunneling or potential data exfiltration channels.
type: detection
detection_id: 2012078
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What specific OpenSSL cipher suites were negotiated in this tunnel connection?
    context: Understanding cipher suite selection reveals tunnel configuration and potential security implications.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - tls.version
        - alert.signature

  - question: What was the complete TLS handshake pattern indicating Windows-based OpenSSL?
    context: Specific handshake patterns can fingerprint the exact OpenSSL version and configuration used.
    query: |
      aggregation: false
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - tls.client.supported_ciphers
        - tls.version
        - tls.client.ja3

  # Type 2: Triage Assessment
  - question: Is this authorized encrypted tunnel usage for business purposes?
    context: Legitimate OpenSSL tunnels may be used for secure remote access or data protection.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 443
            - 993
            - 995
            - 465
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto
        - bytes_toserver

  - question: Does this system have legitimate need for encrypted tunneling software?
    context: Systems with authorized remote access or VPN requirements may legitimately use OpenSSL tunnels.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - "stunnel"
            - "openssl"
            - "tunnel"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  # Type 3: Activity Context
  - question: What process initiated this OpenSSL tunnel connection?
    context: Understanding the parent process helps determine if the tunnel is legitimate or malicious.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - "stunnel"
            - "openssl"
            - "s_client"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ParentImage
        - ParentCommandLine

  - question: What network reconnaissance preceded this tunnel establishment?
    context: Attackers may scan for open ports before establishing covert tunnels for data exfiltration.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - proto
        - bytes_toserver

  # Type 4: Impact Assessment
  - question: What volume of data was transmitted through this encrypted tunnel?
    context: Large data transfers may indicate data exfiltration or unauthorized file transfers.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - bytes_toserver
        - bytes_toclient
        - proto
        - dst_port

  - question: Are there signs of sensitive file access before tunnel establishment?
    context: Data exfiltration attacks often involve accessing sensitive files before encrypted transmission.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - ".doc"
            - ".pdf"
            - ".xls"
            - "database"
            - "backup"
        condition: selection
      fields:
        - TargetFilename
        - Image
        - User

  # Type 5: Forensic Deep-Dive
  - question: What specific tunneling software or configuration is being used?
    context: Identifying exact tools helps understand attacker capabilities and detection evasion techniques.
    range: -30m/+30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - "stunnel"
            - "openssl"
        condition: selection
      fields:
        - Image
        - CommandLine
        - ProcessGuid
        - ParentImage

  - question: Are there indicators of persistence mechanisms for tunnel software?
    context: Malicious tunnels often establish persistence to maintain covert communication channels.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - "\\Services\\"
            - "\\Run\\"
            - "stunnel"
            - "openssl"
        condition: selection
      fields:
        - TargetObject
        - Details
        - Image

  - question: What destinations are being accessed through this encrypted tunnel?
    context: Tunnel destinations may reveal the purpose and potential malicious intent of the connection.
    range: +6h
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - tls.server.certificate.subject
        - tls.server.certificate.issuer

  # Type 6: Enterprise Correlation
  - question: Are other systems establishing similar OpenSSL tunnels to external destinations?
    context: Coordinated tunnel usage may indicate widespread compromise or organized data exfiltration.
    range: -6h/+6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: "OpenSSL Tunnel"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature

  - question: Is this part of a broader policy violation or data loss prevention incident?
    context: Unauthorized tunneling may be part of larger security policy violations or insider threats.
    range: -24h/+24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.category: "Policy Violation"
        condition: selection
      fields:
        - alert.signature
        - dst_ip
        - dst_port