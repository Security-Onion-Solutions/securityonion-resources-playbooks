name: ET INFO Windows-Based OpenSSL Tunnel Connection Outbound 3
id: 22012080
description: |
  Detects Windows-based OpenSSL tunnel connections outbound on port 443.
  May indicate legitimate VPN/tunnel usage or potential data exfiltration channel.
type: detection
detection_id: 2012080
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What is the complete SSL handshake pattern that triggered this alert?
    context: Understanding the specific SSL cipher suite helps identify the tunnel software being used.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_port
        - dst_port
        - rule.name

  - question: What SSL/TLS certificate information is available for this connection?
    context: Certificate details can reveal if this is a legitimate service or suspicious tunnel.
    range: +/-5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - tls.server.certificate.subject
        - tls.server.certificate.issuer
        - tls.server.certificate.serial_number
        - tls.version

  # Type 2: Triage Assessment
  - question: Is this destination IP associated with known legitimate services?
    context: Helps determine if this is authorized VPN/tunnel usage versus malicious activity.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 443
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - network.bytes

  - question: Does this source system regularly establish tunnel connections?
    context: Historical pattern analysis helps identify if this is normal behavior for this host.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "OpenSSL Tunnel"
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - count

  # Type 3: Activity Context
  - question: What process initiated this SSL tunnel connection?
    context: Process information reveals if this was user-initiated or automated malware behavior.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - "stunnel"
            - "openssl"
            - "s_client"
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  - question: What network activity preceded this tunnel establishment?
    context: Prior connections may indicate reconnaissance or initial compromise stages.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.protocol
        - network.bytes

  # Type 4: Impact Assessment
  - question: How much data was transferred through this tunnel connection?
    context: Data volume indicates potential for data exfiltration or command channel usage.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - network.bytes
        - network.bytes_in
        - network.bytes_out
        - network.duration

  - question: Are there signs of data staging or collection before tunnel usage?
    context: File operations before tunneling may indicate preparation for data exfiltration.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.mime_type|contains:
            - "application/zip"
            - "application/x-rar"
            - "text/plain"
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size

  # Type 5: Forensic Deep-Dive
  - question: What specific tunnel software or configuration is being used?
    context: Identifying the exact tunnel implementation helps understand capabilities and intent.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - "stunnel.exe"
            - "openssl.exe"
            - "plink.exe"
        condition: selection
      fields:
        - CommandLine
        - ParentImage
        - ProcessGuid

  - question: Are there configuration files or certificates created for this tunnel?
    context: Tunnel configuration files reveal persistence mechanisms and target destinations.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - ".conf"
            - ".pem"
            - ".crt"
            - ".key"
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network establishing similar tunnel connections?
    context: Multiple tunnel connections may indicate coordinated campaign or lateral movement.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "OpenSSL Tunnel"
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - count