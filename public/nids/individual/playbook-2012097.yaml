name: ET ACTIVEX WMITools ActiveX Remote Code Execution
id: 22012097
description: |
  Detects exploitation attempts against WMITools ActiveX control via AddContextRef method.
  May trigger on legitimate WMI management applications using this control.
  Successful exploitation enables remote code execution through WMI interface abuse.
type: detection
detection_id: 2012097
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete WMITools ActiveX object instantiation and method call?
    context: Analyzing the full exploit payload reveals WMI abuse techniques and target scope.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.body.content
        - http.response.body.content
        - url.full

  - question: Is this system authorized to use WMITools ActiveX for administration?
    context: Enterprise management tools may legitimately utilize WMITools for system administration.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains:
            - "admin"
            - "manage"
            - "wmi"
        condition: selection
      fields:
        - src_ip
        - url.domain
        - http.response.status_code

  - question: What web attack vector delivered the WMITools exploit?
    context: Understanding the delivery mechanism reveals campaign targeting and sophistication.
    range: +/-10m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.request.headers.referer
        - http.response.status_code

  - question: Has WMI activity increased on the target system following this alert?
    context: Successful exploitation typically results in elevated WMI command execution.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - "wmic.exe"
            - "wmiprvse.exe"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: What is the threat intelligence profile of the attacking server?
    context: Known malicious infrastructure indicates targeted or opportunistic attack campaigns.
    range: -14d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - dst_ip

  - question: Are there other ActiveX or browser exploitation attempts from this source?
    context: Multiple exploit attempts indicate systematic client-side attack methodology.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "ACTIVEX"
            - "EXPLOIT"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - url.domain

  - question: What system processes were spawned after the exploitation attempt?
    context: Post-exploitation process creation reveals the scope of system compromise.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ParentImage
        - ProcessGuid

  - question: Has the compromised system initiated outbound WMI connections?
    context: Remote WMI connections may indicate lateral movement or distributed attack coordination.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 135
            - 445
            - 5985
            - 5986
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_in
        - bytes_out

  - question: Are other enterprise systems being targeted with similar WMITools exploits?
    context: Coordinated attacks may target multiple systems for widespread WMI abuse.
    range: +/-6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "WMITools"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - url.domain

  - question: What registry or file system changes occurred post-exploitation?
    context: Persistence mechanisms reveal attacker intent for long-term system access.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetObject
        - Details
        - Image

  - question: Has sensitive data been accessed via WMI queries following exploitation?
    context: WMI provides extensive system information that attackers may harvest for reconnaissance.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image: "*wmic.exe"
          CommandLine|contains:
            - "process"
            - "service"
            - "share"
            - "user"
        condition: selection
      fields:
        - CommandLine
        - User
        - ProcessGuid