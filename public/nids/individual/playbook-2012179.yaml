name: ET WEB_CLIENT Adobe Reader and Acrobat U3D File Invalid Array Index Remote Code Execution Attempt
id: 22012179
description: |
  Detects attempts to exploit CVE-2009-2990 in Adobe Reader/Acrobat through malicious U3D files.
  This vulnerability allows remote code execution via invalid array index manipulation in U3D content.
  May trigger on legitimate PDF files containing U3D content with specific length parameters.
type: detection
detection_id: 2012179
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the exact U3D content pattern that triggered this alert?
    context: Understanding the malicious U3D structure helps confirm exploitation attempt versus legitimate content.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.response.body.content
        - http.response.headers.content-type
        - url.full

  - question: Is this PDF download part of normal user browsing activity?
    context: Legitimate PDF downloads from trusted sources are common and may contain U3D content.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.response.headers.content-type|contains:
            - 'application/pdf'
            - 'application/x-pdf'
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - http.response.status_code

  - question: What web session led to this PDF download?
    context: Understanding the browsing session helps determine if user was socially engineered or visited malicious site.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - url.full
        - http.request.method
        - http.request.headers.referer

  - question: What process opened this PDF file on the target system?
    context: Confirms which Adobe application processed the malicious PDF and potential code execution.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          Hostname|expand: '%src_ip%'
          Image|contains:
            - 'AcroRd32.exe'
            - 'Acrobat.exe'
            - 'acrord64.exe'
        condition: selection
      fields:
        - User
        - CommandLine
        - ParentImage

  - question: Has the Adobe Reader process executed any suspicious child processes?
    context: Successful exploitation may spawn additional processes for payload execution or system manipulation.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          ParentImage|contains:
            - 'AcroRd32.exe'
            - 'Acrobat.exe'
            - 'acrord64.exe'
          Hostname|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  - question: Are there signs of successful code execution through file system changes?
    context: Malicious PDFs often drop files or modify system files as part of their payload.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          Hostname|expand: '%src_ip%'
          TargetFilename|contains:
            - '\Temp\'
            - '\AppData\'
            - '.exe'
            - '.dll'
        condition: selection
      fields:
        - TargetFilename
        - ProcessName
        - file.hash.md5

  - question: Has the system made any suspicious network connections post-exploitation?
    context: Successful exploitation may result in command-and-control communications or data exfiltration.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.bytes_sent
        - network.bytes_received

  - question: Are there registry modifications indicating persistence mechanisms?
    context: Advanced payloads may establish persistence through registry modifications for long-term access.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          Hostname|expand: '%src_ip%'
          TargetObject|contains:
            - '\Run\'
            - '\RunOnce\'
            - '\Services\'
            - '\Winlogon\'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessName

  - question: What is the reputation and history of the source domain serving this PDF?
    context: Malicious PDFs are often served from compromised or newly registered domains with poor reputation.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          dns.query.name|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.resolved_ip
        - dns.query.type_name

  - question: Are other systems in the network receiving similar malicious PDF files?
    context: Targeted campaigns often distribute malicious PDFs to multiple users within an organization.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: 'ET WEB_CLIENT Adobe Reader and Acrobat U3D File Invalid Array Index Remote Code Execution Attempt'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.category

  - question: Is this part of a broader attack campaign targeting Adobe vulnerabilities?
    context: Advanced persistent threats often use multiple Adobe exploits as part of coordinated attack campaigns.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'Adobe'
            - 'PDF'
            - 'Flash'
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.category