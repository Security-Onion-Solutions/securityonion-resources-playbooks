name: ET MALWARE W32 Bamital or Backdoor.Win32.Shiz CnC Communication
id: 22012299
description: |
  Detects command and control communication from W32 Bamital malware or Backdoor.Win32.Shiz.
  This malware uses favicon.ico requests with specific parameter patterns for C2 communication.
  Legitimate favicon requests would not contain these numbered parameter sequences.
type: detection
detection_id: 2012299
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete URI pattern that triggered this C2 detection?
    context: Understanding the exact parameter sequence reveals the malware's communication protocol.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - url.path
        - url.query

  - question: What specific numbered parameters were included in the favicon request?
    context: The parameter pattern helps identify the malware variant and communication stage.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.request.body.content
        - url.query
        - http.request.headers

  # Type 2: Triage Assessment
  - question: Is this system known to be infected or part of incident response?
    context: Determines if this is expected malware analysis traffic or active infection.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - "malware"
            - "trojan"
        condition: selection
      fields:
        - rule.name
        - dst_ip

  - question: Are there legitimate favicon requests from this host to external sites?
    context: Helps distinguish malware C2 from normal browser favicon requests.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path: "/favicon.ico"
        condition: selection
      fields:
        - dst_ip
        - url.query

  # Type 3: Activity Context
  - question: What process initiated this HTTP connection?
    context: Identifies if the request came from a browser or malicious process.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - "http"
            - "wget"
            - "curl"
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  - question: What other network activity occurred from this host around the same time?
    context: Reveals if this is part of broader malware communication or lateral movement.
    range: +/-30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.protocol

  # Type 4: Impact Assessment
  - question: Has the malware successfully established persistent C2 communication?
    context: Multiple successful connections indicate active infection requiring immediate response.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path: "/favicon.ico"
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes

  - question: What data was potentially exfiltrated in the C2 communication?
    context: Parameter values may contain encoded system information or stolen data.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.request.body.content
        - http.response.body.content
        - network.bytes

  # Type 5: Forensic Deep-Dive
  - question: Are there signs of Bamital or Shiz malware files on the infected system?
    context: File artifacts confirm malware presence and help with remediation.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.hash.md5: "fbcdfecc73c4389e8d3ed7e2e573b6f1"
        condition: selection
      fields:
        - TargetFilename
        - file.hash.sha256
        - file.size

  - question: What persistence mechanisms has the malware established?
    context: Registry changes or startup entries indicate how malware maintains infection.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - "Run"
            - "RunOnce"
            - "Services"
        condition: selection
      fields:
        - TargetObject
        - Details
        - EventType

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network communicating with the same C2 server?
    context: Identifies scope of infection and potential lateral movement.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port

  - question: Is this part of a broader malware campaign across the organization?
    context: Similar C2 patterns from multiple hosts indicate coordinated attack.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - "Bamital"
            - "Shiz"
            - "CnC"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name