name: ET WEB_SPECIFIC_APPS SOPHIA CMS SQL Injection Attempt dsp_page.cfm pageid SELECT
id: 22012420
description: |
  Detects SQL injection attempts targeting SOPHIA CMS's dsp_page.cfm script via SELECT statements in the pageid parameter.
  May trigger on legitimate ColdFusion applications using dynamic queries, but SELECT statements in user input typically indicate reconnaissance or data extraction attempts.
type: detection
detection_id: 2012420
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete SQL SELECT statement in the pageid parameter?
    context: Understanding the exact query structure reveals what database information the attacker attempted to extract.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.body.content
        - url.full
        - url.query

  - question: What database tables or columns were targeted in the SELECT query?
    context: Analyzing the SQL syntax helps identify what sensitive data the attacker sought to access.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - url.query
        - http.request.method

  # Type 2: Triage Assessment
  - question: Is this normal ColdFusion application behavior for SOPHIA CMS?
    context: Legitimate CMS operations may involve database queries, but user-controlled SELECT statements are typically malicious.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains: '/dsp_page.cfm'
        condition: selection
      fields:
        - src_ip
        - url.query
        - http.response.status_code

  - question: Does the source IP have a history of legitimate SOPHIA CMS usage?
    context: Established users may have different risk profiles than new or suspicious visitors.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains: '.cfm'
        condition: selection
      fields:
        - url.path
        - http.request.method
        - http.response.status_code

  # Type 3: Activity Context
  - question: What other ColdFusion pages were accessed by this source IP?
    context: SQL injection attempts often follow reconnaissance of ColdFusion applications and their parameters.
    range: -1h/+1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains: '.cfm'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.response.status_code

  - question: Was this preceded by parameter enumeration or application fingerprinting?
    context: Attackers often probe for vulnerable parameters before launching SQL injection attacks.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.response.status_code

  # Type 4: Impact Assessment
  - question: Did the SQL injection attempt return database information in the response?
    context: Successful SELECT injections may return sensitive data in HTTP responses or cause application errors.
    range: -5m/+5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes
        - http.response.body.content

  - question: Were there signs of successful data extraction or database enumeration?
    context: Multiple successful queries may indicate systematic database reconnaissance or data theft.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains: '.cfm'
        condition: selection
      fields:
        - url.query
        - http.response.status_code
        - http.response.body.bytes

  # Type 5: Forensic Deep-Dive
  - question: What SQL injection technique was employed in the SELECT statement?
    context: Different injection methods indicate varying levels of sophistication and potential for automation.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - url.query
        - http.request.body.content

  - question: Are there indicators of automated SQL injection tools or manual exploitation?
    context: Tool signatures and request patterns help identify the attack methodology and potential attribution.
    range: -15m/+15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - http.request.headers.user-agent
        - url.full
        - http.request.method

  # Type 6: Enterprise Correlation
  - question: Are other SOPHIA CMS installations experiencing similar SQL injection attempts?
    context: Coordinated attacks may target multiple instances of the same vulnerable CMS across the organization.
    range: -4h/+4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'SOPHIA CMS'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is this part of a broader campaign targeting ColdFusion applications?
    context: Attackers often systematically target specific technologies like ColdFusion across multiple systems.
    range: -6h/+6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: 'SQL Injection'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - url.path