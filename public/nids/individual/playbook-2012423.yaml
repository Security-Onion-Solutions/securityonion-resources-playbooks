name: ET WEB_SPECIFIC_APPS SOPHIA CMS SQL Injection Attempt -- dsp_page.cfm pageid DELETE
id: 22012423
description: |
  Detects SQL injection attempts targeting SOPHIA CMS's dsp_page.cfm script using DELETE statements in the pageid parameter.
  DELETE injections are highly destructive as they attempt to remove data from the database, potentially causing data loss or service disruption.
type: detection
detection_id: 2012423
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete DELETE statement payload in the pageid parameter?
    context: Understanding the DELETE syntax reveals what data the attacker attempted to remove from the database.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.body.content
        - url.full
        - url.query

  - question: What table and WHERE conditions were specified in the DELETE injection?
    context: Analyzing the DELETE structure shows which database records the attacker targeted for removal.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - url.query
        - http.request.method

  # Type 2: Triage Assessment
  - question: Is there any legitimate administrative function that performs DELETE operations in SOPHIA CMS?
    context: While DELETE statements may be legitimate in admin contexts, user-controlled DELETE injections are typically malicious and destructive.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains: '/dsp_page.cfm'
        condition: selection
      fields:
        - src_ip
        - url.query
        - http.response.status_code

  - question: Does the source IP have administrative privileges or content management access?
    context: Authorized content managers may legitimately delete records, though DELETE in user input parameters remains suspicious.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains: '.cfm'
        condition: selection
      fields:
        - url.path
        - http.request.method
        - http.response.status_code

  # Type 3: Activity Context
  - question: What database reconnaissance preceded this DELETE injection attempt?
    context: DELETE injections typically follow successful database enumeration to identify valuable targets for data destruction.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.response.status_code

  - question: Were there previous attempts to identify critical database tables or records?
    context: Attackers often enumerate database contents before launching targeted DELETE attacks on valuable data.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains: '/dsp_page.cfm'
        condition: selection
      fields:
        - url.query
        - http.response.status_code

  # Type 4: Impact Assessment
  - question: Did the DELETE injection execute successfully based on HTTP responses?
    context: Successful DELETE operations may cause significant data loss and should be treated as a high-priority incident.
    range: -5m/+5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes
        - http.response.body.content

  - question: What critical data or functionality might have been affected by the DELETE operation?
    context: DELETE injections targeting user accounts, content, or configuration data can cause severe business impact.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains: '.cfm'
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.response.status_code

  # Type 5: Forensic Deep-Dive
  - question: What specific records or data types were targeted for deletion?
    context: Analyzing DELETE targets helps assess the scope of potential data loss and required recovery efforts.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - url.query
        - http.request.body.content

  - question: Are there indicators of systematic data destruction or targeted sabotage?
    context: Multiple DELETE injections may indicate a coordinated attack aimed at causing maximum damage to the organization.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.response.status_code

  - question: What tools or techniques were used to craft the DELETE injection?
    context: Tool signatures help identify whether this was automated scanning or targeted manual exploitation.
    range: -15m/+15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - http.request.headers.user-agent
        - url.full
        - http.request.method

  # Type 6: Enterprise Correlation
  - question: Are other SOPHIA CMS installations experiencing similar DELETE injection attempts?
    context: Coordinated DELETE attacks across multiple systems may indicate a campaign aimed at widespread data destruction.
    range: -4h/+4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'SOPHIA CMS'
          rule.name|contains: 'DELETE'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is this source IP conducting DELETE injection attacks against other web applications?
    context: Attackers may use DELETE techniques across multiple targets to maximize damage to the organization's data assets.
    range: -6h/+6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: 'DELETE'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - url.path