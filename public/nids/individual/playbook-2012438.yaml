name: ET MALWARE TrojanDownloader Win32/Harnig.gen-P Reporting
id: 22012438
description: |
  Detects Win32/Harnig.gen-P trojan downloader reporting to command and control servers.
  This malware uses specific GET requests to bhanx.php with multiple parameters for C2 communication.
  May trigger on legitimate applications using similar parameter patterns.
type: detection
detection_id: 2012438
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete URI pattern and parameters used in the Harnig communication?
    context: Understanding the full C2 communication structure helps identify the specific malware variant and its configuration.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - url.path
        - url.query

  - question: What user agent and HTTP headers were used in the malicious request?
    context: Analyzing HTTP headers can reveal the infection vector and help identify other compromised systems.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.request.headers
        - user_agent.original
        - http.version

  # Type 2: Triage Assessment
  - question: Has this source IP made similar requests to other external hosts recently?
    context: Determines if this is isolated activity or part of broader malicious behavior patterns.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method: "GET"
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - url.path

  - question: Is this communication pattern consistent with known business applications?
    context: Helps eliminate false positives from legitimate software that might use similar parameter structures.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains:
            - ".php"
        condition: selection
      fields:
        - url.domain
        - url.path
        - http.request.method

  # Type 3: Activity Context
  - question: What process initiated this HTTP connection on the source system?
    context: Identifying the parent process helps determine the infection vector and persistence mechanism.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - "http"
            - "curl"
            - "wget"
            - "powershell"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ParentImage

  - question: What network connections were established around the time of this alert?
    context: Understanding concurrent network activity helps identify the full scope of malicious communications.
    range: +/-15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - protocol
        - connection.state

  # Type 4: Impact Assessment
  - question: Did the C2 server respond with any payload or commands?
    context: Determines if the malware successfully received instructions or additional payloads from the C2 server.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes
        - http.response.headers

  - question: Are there signs of file downloads or additional malware deployment?
    context: Assesses whether the trojan downloader successfully retrieved and executed additional malicious payloads.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.extension|contains:
            - "exe"
            - "dll"
            - "bat"
            - "scr"
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size

  # Type 5: Forensic Deep-Dive
  - question: What is the complete timeline of Harnig-related activity on this system?
    context: Provides comprehensive view of the malware's behavior pattern and persistence mechanisms.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "Harnig"
            - "TrojanDownloader"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - url.domain

  - question: Are there registry modifications or persistence mechanisms associated with this infection?
    context: Identifies how the malware maintains persistence and what system changes were made.
    range: +/-2h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - "Run"
            - "RunOnce"
            - "Startup"
        condition: selection
      fields:
        - TargetObject
        - Details
        - EventType

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network showing similar Harnig communication patterns?
    context: Determines if this is an isolated infection or part of a broader organizational compromise.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          url.path|contains: "/bhanx.php"
          url.query|contains:
            - "adv="
            - "code1="
            - "code2="
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - url.domain