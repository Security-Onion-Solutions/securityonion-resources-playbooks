name: ET MALWARE Downloader.Win32.Banload Reporting
id: 22012441
description: |
  Detects Downloader.Win32.Banload malware reporting to command and control servers.
  This Brazilian banking trojan uses GET requests to avisa.php with Portuguese parameters.
  May trigger on legitimate Portuguese applications using similar parameter names.
type: detection
detection_id: 2012441
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What were the specific Portuguese parameters sent in the Banload communication?
    context: Understanding the parameter values reveals system information being exfiltrated and malware configuration.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - url.query
        - url.path

  - question: What system information was being reported through the usuario, pc, and serial parameters?
    context: Analyzing exfiltrated system data helps understand the scope of information compromise.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.request.body.content
        - url.query
        - user_agent.original

  # Type 2: Triage Assessment
  - question: Is this system located in Brazil or Portuguese-speaking regions where Banload typically operates?
    context: Banload primarily targets Brazilian banking customers, helping validate the alert's legitimacy.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - geo.src.country_name
        - geo.dst.country_name

  - question: Are there legitimate Portuguese applications running on this system?
    context: Eliminates false positives from legitimate software using Portuguese language parameters.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - "usuario"
            - "versao"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  # Type 3: Activity Context
  - question: What process initiated this banking trojan communication?
    context: Identifying the parent process helps determine the infection vector and execution method.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - "http"
            - "avisa.php"
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - User
        - ProcessGuid

  - question: What network activity preceded this C2 communication?
    context: Understanding the infection chain helps identify how the malware initially contacted its C2 infrastructure.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 80
            - 443
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - protocol
        - connection.state

  # Type 4: Impact Assessment
  - question: Did the C2 server provide banking-related instructions or configuration updates?
    context: Determines if the banking trojan received new targets or operational instructions.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes
        - http.response.headers

  - question: Are there signs of banking-related data theft or credential harvesting?
    context: Assesses whether the malware successfully captured banking credentials or financial information.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.domain|contains:
            - "bank"
            - "banco"
            - "financ"
        condition: selection
      fields:
        - url.domain
        - url.path
        - http.request.method

  # Type 5: Forensic Deep-Dive
  - question: What is the complete behavioral pattern of this Banload variant?
    context: Provides comprehensive analysis of the malware's operational characteristics and capabilities.
    range: -12h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "Banload"
            - "Banking"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - url.domain

  - question: Are there file system modifications or dropped banking trojan components?
    context: Identifies additional malware components and persistence mechanisms used by the banking trojan.
    range: +/-2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - "banco"
            - "bank"
            - ".exe"
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size

  # Type 6: Enterprise Correlation
  - question: Are other systems showing similar Banload activity or Brazilian banking trojan indicators?
    context: Determines the scope of the banking trojan campaign across the organization.
    range: +/-6h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          url.path|contains: "/avisa.php"
          url.query|contains:
            - "usuario="
            - "versao="
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - url.domain

  - question: Is this part of a broader campaign targeting financial institutions or customers?
    context: Assesses whether this represents an isolated incident or coordinated attack on financial services.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - "Banking"
            - "Financial"
            - "Banload"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name