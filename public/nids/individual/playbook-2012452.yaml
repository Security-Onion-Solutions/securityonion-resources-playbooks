name: ET MOBILE_MALWARE Android Trojan MSO.PJApps checkin 2
id: 22012452
description: |
  Detects Android MSO.PJApps trojan communication with command and control servers via HTTP requests containing specific parameters.
  May trigger on legitimate mobile applications using similar parameter naming conventions for logging or analytics.
type: detection
detection_id: 2012452
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What specific device identifiers and software information were transmitted?
    context: The id and softid parameters reveal compromised device details and malware variant information.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.body.content
        - url.full
        - url.query

  - question: What data is being exfiltrated in the .log file transmission?
    context: Understanding the log file content reveals what sensitive information the trojan is stealing from the device.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.body.content
        - http.request.headers

  - question: Is this legitimate mobile application analytics or logging traffic?
    context: Some mobile apps use similar parameter structures for crash reporting or usage analytics.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.request.method

  - question: Are there other mobile devices communicating with this C2 server?
    context: Multiple devices contacting the same server indicates the scope of the trojan infection.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 9033
        condition: selection
      fields:
        - src_ip
        - dst_port
        - network.bytes

  - question: What triggered this trojan communication?
    context: Understanding the timing and context helps identify how the malware was activated or installed.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.path
        - http.request.method
        - http.response.status_code

  - question: How did the C2 server respond to the trojan checkin?
    context: Server responses may contain commands, configuration updates, or acknowledgment of data receipt.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - http.response.body.bytes

  - question: Is the trojan successfully exfiltrating device data?
    context: Successful data transmission indicates active compromise and ongoing information theft.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 9033
        condition: selection
      fields:
        - network.bytes
        - network.packets

  - question: What sensitive Android device information is being compromised?
    context: MSO.PJApps trojans typically steal contacts, SMS messages, device identifiers, and location data.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.query
        - http.request.body.content

  - question: Are there signs of trojan persistence or additional payload downloads?
    context: Modern trojans often download additional modules or establish multiple communication channels.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.path
        - http.response.body.content

  - question: What other malicious Android applications might be installed?
    context: Device compromise often involves multiple malware families or trojan variants working together.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.path
        - http.request.headers

  - question: Are other devices on the network showing similar trojan activity?
    context: Mobile malware can spread through shared networks or social engineering campaigns.
    range: -12h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'MOBILE_MALWARE'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - url.full

  - question: Is this part of a broader Android malware campaign?
    context: Coordinated mobile malware campaigns often target multiple devices with similar trojans and C2 infrastructure.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_port: 9033
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - network.bytes