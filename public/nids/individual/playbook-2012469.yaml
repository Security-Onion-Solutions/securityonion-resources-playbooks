name: ET WEB_SPECIFIC_APPS All In One Control Panel SQL Injection Attempt -- cp_menu_data_file.php menu UNION SELECT
id: 22012469
description: |
  Detects SQL injection attempts targeting All In One Control Panel via UNION SELECT statements in menu parameter.
  May trigger on legitimate database queries but typically indicates advanced SQL injection exploitation attempts.
type: detection
detection_id: 2012469
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete UNION SELECT payload used in this attack?
    context: Understanding the UNION SELECT structure reveals the attacker's database knowledge and extraction goals.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.full
        - url.query
        - http.request.method
        - http.request.body.content

  - question: How many columns were specified in the UNION SELECT statement?
    context: The column count in UNION SELECT reveals the attacker's knowledge of the target table structure.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - url.query
        - http.response.status_code
        - http.response.body.content
        - bytes_toclient

  # Type 2: Triage Assessment
  - question: Is this control panel application supposed to be publicly accessible?
    context: Some control panels may have legitimate public access for authorized users or administrators.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains: "cp_menu_data_file.php"
        condition: selection
      fields:
        - src_ip
        - http.request.method
        - http.response.status_code
        - url.query

  - question: Does the source IP have legitimate administrative credentials for this system?
    context: Authorized administrators may have documented access patterns and credentials for control panel access.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.response.status_code: 200
        condition: selection
      fields:
        - url.path
        - http.request.method
        - url.query

  # Type 3: Activity Context
  - question: What database enumeration activity preceded this UNION SELECT attempt?
    context: UNION SELECT attacks typically follow initial reconnaissance to determine table structure and column counts.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains: "cp_menu_data_file.php"
        condition: selection
      fields:
        - url.query
        - http.request.method
        - http.response.status_code
        - http.response.body.content

  - question: Are there signs of ORDER BY or column enumeration attempts?
    context: Attackers often use ORDER BY clauses to determine the number of columns before crafting UNION SELECT statements.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.query|contains:
            - "ORDER BY"
            - "GROUP BY"
        condition: selection
      fields:
        - url.path
        - url.query
        - http.response.status_code

  - question: What was the application's response pattern to this injection series?
    context: Analyzing response patterns helps understand if the injection attempts were successful or detected.
    range: -15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - http.response.status_code
        - url.query
        - bytes_toclient

  # Type 4: Impact Assessment
  - question: Was sensitive database information successfully extracted via UNION SELECT?
    context: Confirming successful data extraction helps assess the scope of potential data breach.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
          http.response.status_code: 200
        condition: selection
      fields:
        - http.response.body.content
        - bytes_toclient
        - http.response.headers

  - question: Are there signs of system information or credential extraction?
    context: UNION SELECT attacks often target system tables, user credentials, or configuration data.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.query|contains:
            - "information_schema"
            - "mysql.user"
            - "sys.database"
        condition: selection
      fields:
        - url.query
        - http.response.status_code
        - http.response.body.content

  # Type 5: Forensic Deep-Dive
  - question: What specific database tables and columns were targeted for extraction?
    context: Understanding target data helps assess the value and sensitivity of potentially compromised information.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.query|contains:
            - "UNION"
            - "SELECT"
        condition: selection
      fields:
        - url.query
        - http.response.status_code
        - http.response.body.content

  - question: Are there attempts to write files or execute commands through SQL injection?
    context: Advanced SQL injection may attempt to leverage database functions for file operations or command execution.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.query|contains:
            - "INTO OUTFILE"
            - "LOAD_FILE"
            - "xp_cmdshell"
        condition: selection
      fields:
        - url.query
        - http.response.status_code
        - http.response.body.content

  # Type 6: Enterprise Correlation
  - question: Are other systems being targeted with similar UNION SELECT attacks?
    context: Coordinated SQL injection campaigns often target multiple applications with similar techniques.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.query|contains:
            - "UNION"
            - "SELECT"
        condition: selection
      fields:
        - dst_ip
        - url.path
        - url.domain
        - http.response.status_code

  - question: Is this part of a broader database extraction campaign across the organization?
    context: Understanding campaign scope helps implement comprehensive database security measures and incident response.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.query|contains: "UNION"
        condition: selection
      fields:
        - dst_ip
        - url.path
        - http.request.method
        - http.response.status_code