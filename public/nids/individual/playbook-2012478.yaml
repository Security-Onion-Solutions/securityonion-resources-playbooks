name: ET WEB_SPECIFIC_APPS Flash Gallery wordpress plugin SQL Injection Attempt -- massedit_album.php gall_id UNION SELECT
id: 22012478
description: |
  Detects SQL injection attempts against WordPress Flash Gallery plugin targeting massedit_album.php with UNION SELECT.
  May trigger on legitimate database queries using UNION operations in similar WordPress plugins.
type: detection
detection_id: 2012478
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete UNION SELECT injection payload in the gall_id parameter?
    context: Understanding the UNION SELECT structure reveals what database information the attacker sought to extract.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.body.content
        - url.full
        - url.query

  - question: Is this legitimate WordPress administration activity?
    context: Plugin management activities may be authorized for WordPress administrators during content updates.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains: 'wp-admin'
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.request.method

  - question: What other WordPress plugin vulnerabilities were exploited from this source?
    context: Attackers often target multiple WordPress plugins in systematic exploitation campaigns.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'wordpress'
            - 'wp-content'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - url.path

  - question: Did the UNION SELECT injection successfully extract database data?
    context: Successful UNION attacks often return database schema information or sensitive data in HTTP responses.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - http.response.bytes

  - question: What WordPress database tables were targeted for data extraction?
    context: UNION SELECT attacks often target wp_users, wp_options, or plugin-specific tables.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.query|contains:
            - 'wp_users'
            - 'wp_options'
            - 'user_login'
            - 'user_pass'
        condition: selection
      fields:
        - url.query
        - url.path

  - question: Were there attempts to enumerate WordPress database structure?
    context: Attackers often use information_schema queries to map database tables before targeted extraction.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.query|contains:
            - 'information_schema'
            - 'table_name'
            - 'column_name'
        condition: selection
      fields:
        - url.query
        - url.path

  - question: Did the Flash Gallery plugin log any database errors?
    context: Failed UNION injections often generate MySQL errors revealing database structure information.
    range: +15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          http.response.body.content|contains:
            - 'mysql_'
            - 'SQL syntax'
            - 'duplicate column'
            - 'operand should contain'
        condition: selection
      fields:
        - http.response.body.content
        - url.path

  - question: What WordPress processes were active during this attack?
    context: Identifying WordPress/PHP processes helps assess the potential for code execution.
    range: -15m
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - 'php'
            - 'httpd'
            - 'apache'
            - 'nginx'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  - question: Were there subsequent attempts to upload malicious files to WordPress?
    context: Successful database compromise often leads to attempts to upload web shells or malware.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.request.method: 'POST'
          url.path|contains:
            - 'wp-content'
            - 'uploads'
        condition: selection
      fields:
        - url.path
        - http.request.method
        - http.response.status_code

  - question: Are other WordPress sites showing similar Flash Gallery plugin attacks?
    context: Plugin vulnerabilities are often exploited across multiple WordPress installations simultaneously.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'Flash Gallery'
            - 'massedit_album'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: What WordPress reconnaissance activity preceded this targeted injection?
    context: Attackers typically enumerate WordPress plugins and versions before launching specific exploits.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains:
            - 'wp-content/plugins'
            - '1-flash-gallery'
            - 'readme.txt'
        condition: selection
      fields:
        - url.path
        - http.response.status_code
        - http.response.bytes