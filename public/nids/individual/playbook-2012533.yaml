name: ET MALWARE Win32/Virut.BN Checkin
id: 22012533
description: |
  Detects Win32/Virut.BN malware performing command and control checkin.
  This polymorphic virus infects executable files and communicates with C2 servers using specific URI patterns.
  May trigger on legitimate applications using similar hexadecimal parameter patterns.
type: detection
detection_id: 2012533
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete URI pattern and hexadecimal parameter used in the Virut checkin?
    context: Understanding the exact C2 communication protocol helps identify the specific Virut variant and its configuration.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - url.path
        - url.query

  - question: What does the 100-character hexadecimal parameter decode to?
    context: Analyzing the encoded parameter reveals system information being exfiltrated and malware identification data.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - url.query
        - http.request.body.content
        - user_agent.original

  # Type 2: Triage Assessment
  - question: Are there legitimate applications using similar hexadecimal parameter patterns?
    context: Helps eliminate false positives from legitimate software that might use similar encoding schemes.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains: "list.php"
        condition: selection
      fields:
        - url.domain
        - url.query
        - user_agent.original

  - question: Is this system known to run applications that communicate with PHP-based services?
    context: Distinguishes between malicious C2 communication and legitimate application-to-server communication.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains: ".php"
        condition: selection
      fields:
        - url.domain
        - url.path
        - http.request.method

  # Type 3: Activity Context
  - question: What process initiated this Virut C2 communication?
    context: Identifying the requesting process helps determine which executable files may be infected by the virus.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - "list.php"
            - "http"
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - User
        - ProcessGuid

  - question: What executable files were accessed or modified before this checkin?
    context: Virut infects executable files, so understanding recent file activity helps identify infection vectors.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.extension|contains:
            - "exe"
            - "com"
            - "scr"
        condition: selection
      fields:
        - TargetFilename
        - EventType
        - Image
        - file.hash.md5

  # Type 4: Impact Assessment
  - question: Did the C2 server respond with commands or additional malware components?
    context: Determines if the virus received new instructions or payloads from its command and control infrastructure.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes
        - http.response.body.content

  - question: Are there signs of file infection or viral propagation activity?
    context: Assesses whether the virus is actively infecting other executable files on the system.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          EventType: "FileCreate"
          file.extension|contains:
            - "exe"
            - "com"
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size
        - Image

  # Type 5: Forensic Deep-Dive
  - question: What is the complete timeline of Virut activity and file infections?
    context: Provides comprehensive view of the virus behavior, infection pattern, and persistence mechanisms.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "Virut"
            - "Virus"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - url.domain

  - question: What network infrastructure is being used by this Virut variant?
    context: Understanding the C2 infrastructure helps identify the scope of the botnet and related malicious domains.
    range: +/-6h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.resolved_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.resolved_ip

  - question: Are there registry modifications or system changes made by the virus?
    context: Identifies the virus persistence mechanisms and system modifications for complete remediation.
    range: +/-4h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - "Run"
            - "Policies"
            - "Windows"
        condition: selection
      fields:
        - TargetObject
        - Details
        - EventType

  # Type 6: Enterprise Correlation
  - question: Are other systems showing similar Virut checkin patterns or file infections?
    context: Determines the scope of the viral infection across the organization and identifies propagation vectors.
    range: +/-8h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          url.path|contains: "list.php"
          url.query|contains:
            - "c="
            - "v="
            - "t="
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - url.domain

  - question: Is this part of a larger Virut botnet campaign affecting the enterprise?
    context: Assesses the enterprise-wide impact and helps prioritize containment efforts for the viral infection.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - "Virut"
            - "command-and-control"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name