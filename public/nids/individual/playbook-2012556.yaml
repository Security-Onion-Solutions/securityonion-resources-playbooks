name: ET WEB_SPECIFIC_APPS Shape Web Solutions imprimir.php SELECT FROM SQL Injection Attempt
id: 22012556
description: |
  Detects SQL injection attempts targeting Shape Web Solutions imprimir.php with SELECT FROM statements.
  May trigger on legitimate database queries or malicious attempts to extract sensitive data.
type: detection
detection_id: 2012556
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete SELECT statement injected into the imprimir.php parameter?
    context: Understanding the exact query reveals what database tables and columns the attacker targeted.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.uri
        - http.request.method
        - url.query
        - http.request.body.content

  - question: What database schema information was the attacker attempting to extract?
    context: SELECT injection attempts often target system tables to map database structure.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.uri|contains: '/imprimir.php'
        condition: selection
      fields:
        - http.uri
        - url.query
        - http.request.body.content

  - question: Is this normal database querying behavior for this application user?
    context: Legitimate users may perform complex queries that could resemble injection attempts.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.uri|contains: '/imprimir.php'
        condition: selection
      fields:
        - src_ip
        - http.request.method
        - url.path
        - http.user_agent

  - question: What other SQL injection techniques were attempted from this source?
    context: Attackers often try multiple injection methods to find successful exploitation vectors.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: 'SQL Injection'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - http.uri

  - question: What was the application's response to the SELECT injection attempt?
    context: Response analysis reveals if sensitive data was successfully extracted.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes
        - http.response.body.content

  - question: Did the injection reveal database errors or structure information?
    context: Error-based injection can expose database schema and configuration details.
    range: +2m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - http.response.body.content
        - http.response.status_code
        - http.response.headers

  - question: What reconnaissance activity preceded this injection attempt?
    context: Understanding the attack sequence helps identify the full scope of compromise.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - http.user_agent
        - http.response.status_code

  - question: Was sensitive data successfully extracted based on response size?
    context: Unusually large responses may indicate successful data extraction.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
          http.response.body.bytes|gte: 10000
        condition: selection
      fields:
        - http.response.body.bytes
        - http.response.status_code
        - network.bytes_sent

  - question: What authentication mechanisms were bypassed during this attack?
    context: SQL injection may be used to bypass login forms or extract credential hashes.
    range: -10m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.uri|contains:
            - 'login'
            - 'auth'
            - 'user'
        condition: selection
      fields:
        - http.uri
        - http.request.method
        - http.response.status_code

  - question: Are other Shape Web Solutions instances being targeted across the network?
    context: Coordinated attacks may target multiple vulnerable application instances.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'Shape Web Solutions'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: What data exfiltration occurred after successful SELECT injection?
    context: Successful data extraction may be followed by large outbound transfers.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          network.bytes_sent|gte: 100000
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.bytes_sent
        - network.protocol