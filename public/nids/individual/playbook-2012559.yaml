name: ET WEB_SPECIFIC_APPS Shape Web Solutions imprimir.php INSERT INTO SQL Injection Attempt
id: 22012559
description: |
  Detects SQL injection attempts targeting Shape Web Solutions imprimir.php with INSERT INTO statements.
  May trigger on legitimate data entry operations or malicious attempts to insert backdoors or corrupt data.
type: detection
detection_id: 2012559
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete INSERT INTO statement injected through imprimir.php?
    context: Understanding the insertion payload reveals what malicious data or backdoors were planted.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.uri
        - http.request.method
        - url.query
        - http.request.body.content

  - question: What table and columns were targeted for the malicious data insertion?
    context: INSERT injection targets help identify the scope of database compromise and data integrity risks.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.uri|contains: '/imprimir.php'
        condition: selection
      fields:
        - http.uri
        - url.query
        - http.request.body.content

  - question: Is this normal data entry activity for this application user?
    context: Legitimate users may perform bulk data imports that could resemble injection attempts.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.uri|contains: '/imprimir.php'
        condition: selection
      fields:
        - src_ip
        - http.request.method
        - url.path
        - http.user_agent

  - question: What reconnaissance preceded this INSERT injection attempt?
    context: Understanding the attack sequence reveals how the attacker mapped the database structure.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: 'SQL Injection'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - http.uri

  - question: Did the INSERT operation succeed based on application responses?
    context: Successful insertions may result in confirmation messages or database constraint errors.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes
        - http.response.body.content

  - question: What type of malicious data was inserted into the database?
    context: INSERT payloads may contain web shells, administrative accounts, or corrupted business data.
    range: +2m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - http.response.body.content
        - http.response.status_code
        - http.response.headers

  - question: Were administrative or privileged accounts created through this injection?
    context: INSERT attacks often target user management tables to create backdoor access accounts.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.uri|contains:
            - 'admin'
            - 'user'
            - 'login'
        condition: selection
      fields:
        - http.uri
        - http.request.method
        - http.response.status_code

  - question: What database integrity violations resulted from the malicious insertion?
    context: INSERT injections may violate foreign key constraints or trigger database error responses.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
          http.response.status_code|contains:
            - '500'
            - '400'
        condition: selection
      fields:
        - http.response.body.content
        - http.response.status_code
        - url.path

  - question: What persistent backdoors or web shells were planted via INSERT injection?
    context: Successful INSERT attacks may create persistent access mechanisms in application tables.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          http.uri|contains:
            - '.php'
            - 'shell'
            - 'cmd'
        condition: selection
      fields:
        - http.uri
        - src_ip
        - http.request.method
        - http.user_agent

  - question: Are other Shape Web Solutions instances being targeted for data insertion?
    context: Coordinated INSERT attacks may indicate systematic database poisoning across the enterprise.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'Shape Web Solutions'
          rule.name|contains: 'INSERT'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: What data exfiltration followed the successful database insertion?
    context: INSERT attacks may be used to stage data for extraction or create covert communication channels.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          network.bytes_sent|gte: 50000
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.bytes_sent
        - network.protocol