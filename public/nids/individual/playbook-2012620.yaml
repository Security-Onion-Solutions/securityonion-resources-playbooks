name: ET MALWARE Win32.FakeAV.chhq Checkin
id: 22012620
description: |
  Detects Win32.FakeAV.chhq malware performing command and control communication via HTTP GET requests with specific URI patterns.
  This indicates an infected system communicating with its C2 server for instructions or updates.
type: detection
detection_id: 2012620
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What is the complete URI pattern and hex-encoded content in the malware checkin?
    context: Analyzing the exact URI structure reveals the malware variant and communication protocol used by the threat actor.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - http.user_agent
        - src_ip
        - dst_ip

  - question: Is this HTTP traffic part of legitimate administrative activity or software updates?
    context: Eliminating false positives by checking if this matches documented maintenance windows or approved software behavior.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method: "GET"
        condition: selection
      fields:
        - dst_ip
        - url.path
        - http.user_agent
        - http.response.status_code

  - question: What other network connections has this infected host initiated recently?
    context: Understanding the full scope of malware communication and identifying additional C2 infrastructure.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.protocol
        - network.bytes_sent
        - network.bytes_received

  - question: Are there signs of successful malware payload execution on the infected system?
    context: Determining if the malware has established persistence or executed additional payloads beyond C2 communication.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ParentImage

  - question: What files have been created or modified on the infected system?
    context: Identifying malware artifacts, dropped files, or system modifications that indicate active infection.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size
        - ProcessName

  - question: Has this malware family been observed communicating with the same C2 server from other systems?
    context: Determining campaign scope and identifying other potentially infected systems in the environment.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains: "/index.php"
          http.user_agent: "Mozilla/3.0"
        condition: selection
      fields:
        - src_ip
        - url.full
        - http.request.method

  - question: What DNS queries were made to resolve the C2 server domain?
    context: Understanding the DNS resolution pattern helps identify the full C2 infrastructure and potential domain generation algorithms.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          dns.resolved_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.response_code

  - question: Are there registry modifications indicating malware persistence mechanisms?
    context: Identifying how the malware maintains persistence across system reboots and user sessions.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - "Run"
            - "RunOnce"
            - "Services"
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessName

  - question: What is the timeline of infection from initial compromise to C2 communication?
    context: Reconstructing the attack timeline helps understand the malware deployment method and dwell time.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - dst_ip
        - community_id

  - question: Has this FakeAV variant attempted to display fraudulent security warnings to users?
    context: Understanding the social engineering component and user impact of this fake antivirus malware.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - "antivirus"
            - "security"
            - "warning"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  - question: Are other enterprise systems showing similar FakeAV C2 communication patterns?
    context: Assessing enterprise-wide infection scope and identifying systems that may need immediate attention.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "FakeAV"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - host.hostname