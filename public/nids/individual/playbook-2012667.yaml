name: ET WEB_SPECIFIC_APPS Joomla Component Media Mall Factory Blind SQL Injection Attempt
id: 22012667
description: |
  Detects blind SQL injection attempts targeting the Joomla Media Mall Factory component via the category parameter.
  May trigger on legitimate database queries containing similar SQL keywords in normal application usage.
type: detection
detection_id: 2012667
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete SQL injection payload in the category parameter?
    context: Understanding the exact injection syntax reveals the attacker's database enumeration technique.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - url.query
        - http.request.body.content

  - question: What specific substring function was used in the blind SQL injection?
    context: The substring function indicates blind SQL injection technique for data extraction.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains: "/index.php"
          url.query|contains: "substring("
        condition: selection
      fields:
        - url.query
        - http.request.method
        - url.path

  # Type 2: Triage Assessment
  - question: Is this normal administrative access to the Media Mall Factory component?
    context: Legitimate administrators may access this component for media management purposes.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.query|contains: "option=com_mediamall"
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.request.method

  - question: Does the source IP have a history of legitimate Joomla administration?
    context: Regular administrative users would have consistent patterns of normal Joomla access.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains: "/administrator/"
        condition: selection
      fields:
        - src_ip
        - url.path
        - user_agent.original

  # Type 3: Activity Context
  - question: What other Joomla components were accessed in the same session?
    context: Attackers often enumerate multiple components to find vulnerabilities.
    range: -15m/+15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.query|contains: "option=com_"
        condition: selection
      fields:
        - url.query
        - url.path
        - http.request.method

  - question: Was there reconnaissance activity before the SQL injection attempt?
    context: Attackers typically perform reconnaissance to identify vulnerable components.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.response.status_code|contains:
            - 200
            - 404
            - 403
        condition: selection
      fields:
        - url.path
        - http.response.status_code
        - http.request.method

  # Type 4: Impact Assessment
  - question: Did the SQL injection attempt return successful database information?
    context: Successful blind SQL injection would show consistent response patterns indicating data extraction.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.query|contains: "option=com_mediamall"
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes
        - url.query

  - question: Were there signs of successful database enumeration through response timing?
    context: Blind SQL injection relies on response time differences to extract data.
    range: +10m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 80
            - 443
        condition: selection
      fields:
        - network.bytes
        - network.packets
        - network.duration

  # Type 5: Forensic Deep-Dive
  - question: What database schema information was the attacker attempting to extract?
    context: The specific substring queries reveal what database tables or columns were targeted.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.query|contains:
            - "substring("
            - "category="
        condition: selection
      fields:
        - url.query
        - url.full
        - http.request.method

  - question: Did the attacker attempt to escalate privileges through the SQL injection?
    context: Advanced attackers may attempt to gain administrative access through SQL injection.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains:
            - "/administrator/"
            - "/index.php"
        condition: selection
      fields:
        - url.path
        - url.query
        - http.response.status_code

  # Type 6: Enterprise Correlation
  - question: Are other Joomla installations in the environment being targeted?
    context: Attackers often target multiple instances of the same CMS across an organization.
    range: -1h/+1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.query|contains: "option=com_mediamall"
        condition: selection
      fields:
        - dst_ip
        - url.path
        - http.response.status_code

  - question: Is this part of a broader web application attack campaign?
    context: SQL injection attempts often occur alongside other web application attacks.
    range: -2h/+2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains: "web-application-attack"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - alert.severity