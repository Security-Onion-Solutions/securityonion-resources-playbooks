name: ET WEB_SPECIFIC_APPS Andy PHP Knowledgebase SQL Injection Attempt pdfgen.php pdfa SELECT
id: 22012672
description: |
  Detects SQL injection attempts targeting Andy PHP Knowledgebase pdfgen.php via pdfa parameter using SELECT statements.
  May trigger on legitimate PDF generation requests that include SQL-like keywords in content or parameters.
type: detection
detection_id: 2012672
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete SQL injection payload in the pdfa parameter?
    context: Understanding the exact SQL query reveals the attacker's database access intentions and technique sophistication.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.body.content
        - url.full
        - url.query

  - question: What specific database tables or fields were targeted in the SELECT statement?
    context: Analyzing the SQL structure helps identify what data the attacker attempted to access.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - url.path
        - url.query
        - http.request.method

  # Type 2: Triage Assessment
  - question: Is this legitimate PDF generation with content containing SQL keywords?
    context: Normal knowledgebase PDF generation may include SQL documentation or examples that could trigger false positives.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains:
            - "/plugins/pdfClasses/pdfgen.php"
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.request.method

  - question: Does this source IP have established patterns of knowledgebase access?
    context: Regular knowledgebase usage helps distinguish between legitimate users and attackers.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains:
            - "/plugins/"
            - "knowledgebase"
        condition: selection
      fields:
        - src_ip
        - url.path
        - user_agent.original

  # Type 3: Activity Context
  - question: What other knowledgebase requests preceded this SQL injection attempt?
    context: Understanding the access pattern helps identify reconnaissance or systematic exploitation attempts.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains:
            - "/plugins/"
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.request.method
        - http.response.status_code

  - question: What was the database server response to this SQL injection attempt?
    context: Response analysis indicates whether the injection was successful or blocked by security measures.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - http.response.headers

  # Type 4: Impact Assessment
  - question: Did the SQL injection attempt result in successful data extraction?
    context: Successful SQL injection can lead to database compromise and sensitive data exposure.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains:
            - "pdfgen.php"
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.response.body.content

  - question: Are there signs of database enumeration or privilege escalation following this attempt?
    context: SQL injection attacks often progress to database schema discovery and privilege escalation.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.query|contains:
            - "UNION"
            - "INFORMATION_SCHEMA"
            - "admin"
        condition: selection
      fields:
        - src_ip
        - url.path
        - url.query

  # Type 5: Forensic Deep-Dive
  - question: What SQL injection techniques and tools are indicated by the request patterns?
    context: Attack characteristics help identify automated tools versus manual exploitation attempts.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - user_agent.original
        - http.request.headers
        - src_ip

  - question: Are there other SQL injection attempts targeting different Andy PHP Knowledgebase components?
    context: Comprehensive attacks may target multiple vulnerable parameters or modules.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "Andy PHP Knowledgebase"
            - "SQL Injection"
        condition: selection
      fields:
        - rule.name
        - url.path
        - dst_ip

  - question: What database backend is being targeted based on SQL syntax and error responses?
    context: Database type identification helps understand the scope and techniques of the attack.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          http.response.body.content|contains:
            - "mysql"
            - "postgresql"
            - "oracle"
        condition: selection
      fields:
        - http.response.body.content
        - url.path
        - src_ip

  # Type 6: Enterprise Correlation
  - question: Are other systems showing similar SQL injection attempts against knowledgebase applications?
    context: Coordinated campaigns may target similar vulnerabilities across multiple knowledge management systems.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - "SQL Injection"
            - "knowledgebase"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name