name: ET WEB_SPECIFIC_APPS Andy PHP Knowledgebase SQL Injection Attempt pdfgen.php pdfa INSERT
id: 22012674
description: |
  Detects SQL injection attempts targeting Andy PHP Knowledgebase pdfgen.php with INSERT statements.
  May trigger on legitimate database operations but INSERT in URL parameters is typically malicious.
type: detection
detection_id: 2012674
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete SQL injection payload in the pdfa parameter?
    context: Understanding the exact injection syntax reveals the attacker's database manipulation intent.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.body.content
        - url.full
        - url.query
  - question: Is this legitimate administrative activity for the Andy PHP Knowledgebase system?
    context: Database administrators might perform legitimate INSERT operations through web interfaces.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains: '/plugins/pdfClasses/pdfgen.php'
        condition: selection
      fields:
        - src_ip
        - user_agent.original
        - http.request.method
  - question: What other HTTP requests preceded this SQL injection attempt?
    context: Attackers often probe the application before launching injection attacks.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.response.status_code
        - http.request.method
  - question: Did the SQL injection attempt succeed based on response codes?
    context: HTTP response codes indicate whether the injection was processed or blocked.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes
        - url.full
  - question: What database tables or data might be targeted by INSERT operations?
    context: INSERT statements in SQL injection often target user tables or configuration data.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - alert.signature
        - http.request.body.content
        - url.query
  - question: Are there signs of successful database manipulation following this attempt?
    context: Successful SQL injection may be followed by data extraction or privilege escalation.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.response.body.bytes
        - http.request.method
  - question: What user agent and source characteristics identify the attacker?
    context: Automated tools and manual testing often have distinctive user agent patterns.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - user_agent.original
        - src_ip
        - http.request.referrer
  - question: Has this source IP attempted other SQL injection techniques?
    context: Attackers typically try multiple injection methods against the same target.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.category|contains: 'web-application-attack'
        condition: selection
      fields:
        - alert.signature
        - dst_ip
        - url.path
  - question: Are there indicators of web shell upload or file manipulation attempts?
    context: SQL injection is often combined with file upload attacks for persistent access.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.request.method: 'POST'
        condition: selection
      fields:
        - url.path
        - http.request.body.bytes
        - content_type
  - question: What is the scope of this attack across other web applications?
    context: Attackers often target multiple applications once they identify vulnerable infrastructure.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.category|contains: 'web-application-attack'
        condition: selection
      fields:
        - dst_ip
        - alert.signature
        - url.path
  - question: Are there similar Andy PHP Knowledgebase exploitation attempts from other sources?
    context: Coordinated attacks or widespread scanning may indicate automated exploitation.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains: '/plugins/pdfClasses/pdfgen.php'
        condition: selection
      fields:
        - src_ip
        - alert.signature
        - url.query