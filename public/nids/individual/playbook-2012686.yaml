name: ET MALWARE SpyEye Checkin version 1.3.25 or later
id: 22012686
description: |
  Detects SpyEye banking trojan performing command and control communication via HTTP POST requests with base64-encoded data.
  This indicates an infected system transmitting stolen credentials or receiving commands from the botnet operator.
type: detection
detection_id: 2012686
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What is the complete POST data payload transmitted by the SpyEye malware?
    context: Analyzing the base64-encoded payload reveals stolen data, system information, or command responses being exfiltrated.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - http.request.body.content
        - url.full
        - src_ip
        - dst_ip

  - question: Is this POST request part of legitimate application traffic or business processes?
    context: Eliminating false positives by verifying if this matches known application behavior or approved data transfers.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method: "POST"
        condition: selection
      fields:
        - dst_ip
        - url.path
        - http.request.body.bytes
        - http.response.status_code

  - question: What banking or financial applications are running on the infected system?
    context: SpyEye targets banking credentials, so identifying financial software helps assess the scope of potential data theft.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - "bank"
            - "finance"
            - "wallet"
            - "trading"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: Has the SpyEye malware successfully harvested credentials or financial data?
    context: Determining the impact by checking for credential theft, form grabbing, or keylogging activity.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - "log"
            - "keylog"
            - "form"
            - "grab"
        condition: selection
      fields:
        - TargetFilename
        - file.size
        - ProcessName
        - file.hash.md5

  - question: What web browsers and their stored credentials are being targeted?
    context: Understanding which browsers are compromised helps assess the scope of credential theft and user impact.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - "chrome.exe"
            - "firefox.exe"
            - "iexplore.exe"
            - "edge.exe"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ParentImage

  - question: Are other systems in the network communicating with the same SpyEye C2 infrastructure?
    context: Identifying the full scope of the SpyEye botnet infection across the enterprise environment.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          http.request.method: "POST"
          http.request.body.content|contains: "data=vK6yv+"
        condition: selection
      fields:
        - src_ip
        - url.full
        - http.request.body.bytes

  - question: What DNS resolution activity preceded the C2 communication?
    context: Understanding the DNS infrastructure helps identify additional C2 domains and potential domain generation algorithms.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          dns.resolved_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.response_code

  - question: Has the SpyEye malware established persistence mechanisms on the infected system?
    context: Identifying how the malware maintains persistence helps understand the full scope of system compromise.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessName

  - question: What is the frequency and pattern of SpyEye C2 communications?
    context: Understanding communication patterns helps predict future activity and assess the malware's operational status.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.request.method: "POST"
        condition: selection
      fields:
        - url.path
        - http.request.body.bytes
        - http.response.status_code

  - question: Are there indicators of SpyEye attempting to steal SSL certificates or cryptographic material?
    context: Advanced SpyEye variants may target certificates for man-in-the-middle attacks or enhanced credential theft.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - ".pfx"
            - ".p12"
            - "certificate"
            - "cert"
        condition: selection
      fields:
        - TargetFilename
        - ProcessName
        - file.hash.md5

  - question: Is this SpyEye infection part of a broader banking trojan campaign across the organization?
    context: Correlating with other banking trojan alerts to understand if this is an isolated incident or coordinated attack.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - "SpyEye"
            - "Zeus"
            - "banking"
            - "trojan"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - host.hostname