name: ET WEB_SPECIFIC_APPS eGroupware loaddetails.php script UNION SELECT SQL Injection Attempt
id: 22012700
description: |
  Detects SQL injection attempts targeting eGroupware's loaddetails.php script using UNION SELECT statements.
  This indicates an attacker attempting to extract data from the database through union-based SQL injection.
  May trigger on legitimate reporting queries if UNION operations are used in application logic.
type: detection
detection_id: 2012700
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete UNION SELECT payload in the injection attempt?
    context: Understanding the UNION SELECT structure reveals what data the attacker is trying to extract.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - http.request.body.content
        - rule.name

  - question: How many columns is the attacker attempting to select in the UNION query?
    context: Column count in UNION queries indicates the attacker's knowledge of the database schema.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - url.query
        - http.request.method
        - url.path

  # Type 2: Triage Assessment
  - question: Are there legitimate UNION operations in this eGroupware installation's normal usage?
    context: Some applications may use UNION queries for complex reporting or data aggregation.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains:
            - 'loaddetails.php'
            - 'report'
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.response.status_code

  - question: Is this source IP associated with authorized database administrators or developers?
    context: Legitimate users might test or debug database queries through web interfaces.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.response.status_code
        - http.request.method

  # Type 3: Activity Context
  - question: What reconnaissance activity preceded this UNION SELECT injection?
    context: Attackers often probe for column counts and data types before crafting UNION queries.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.response.status_code

  - question: Were there any ORDER BY or GROUP BY probes to determine column structure?
    context: Attackers use ORDER BY with incrementing numbers to discover the number of columns.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: 'SQL'
        condition: selection
      fields:
        - rule.name
        - url.full
        - alert.signature

  # Type 4: Impact Assessment
  - question: What was the response size and content type for this UNION SELECT attempt?
    context: Large responses may indicate successful data extraction through the UNION query.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes
        - http.response.headers.content-type

  - question: Are there signs of successful data enumeration following this injection?
    context: Successful UNION injections often lead to further data extraction attempts.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.full
        - http.response.body.bytes
        - http.response.status_code

  # Type 5: Forensic Deep-Dive
  - question: What database tables or information schema is the attacker targeting?
    context: UNION SELECT attacks often target information_schema or specific application tables.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: 'SQL'
        condition: selection
      fields:
        - rule.name
        - url.full
        - alert.signature

  - question: Are there multiple UNION SELECT variations indicating systematic data extraction?
    context: Attackers often iterate through different UNION queries to extract various data types.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: 'UNION SELECT'
        condition: selection
      fields:
        - rule.name
        - url.path
        - alert.signature

  # Type 6: Enterprise Correlation
  - question: Are other eGroupware installations experiencing similar UNION SELECT attacks?
    context: Coordinated attacks may target multiple instances of the same vulnerable application.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: 'eGroupware'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - url.path

  - question: Is this source conducting UNION SELECT attacks against other web applications?
    context: Attackers may use the same techniques across multiple targets in the environment.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: 'UNION SELECT'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - alert.signature