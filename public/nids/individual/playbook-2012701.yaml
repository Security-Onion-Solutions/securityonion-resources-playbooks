name: ET WEB_SPECIFIC_APPS eGroupware loaddetails.php script INSERT INTO SQL Injection Attempt
id: 22012701
description: |
  Detects SQL injection attempts targeting eGroupware's loaddetails.php script using INSERT INTO statements.
  This indicates an attacker attempting to insert malicious data or backdoors into the database.
  May trigger on legitimate data entry operations if INSERT statements are processed through the web interface.
type: detection
detection_id: 2012701
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete INSERT INTO payload in the injection attempt?
    context: Understanding the INSERT statement reveals what data the attacker is trying to add to the database.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - http.request.body.content
        - rule.name

  - question: What table and columns is the attacker targeting with the INSERT statement?
    context: Target tables and columns indicate the attacker's knowledge of the database schema and intent.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - url.query
        - http.request.method
        - url.path

  # Type 2: Triage Assessment
  - question: Are there legitimate INSERT operations through this eGroupware interface?
    context: Some web applications allow data insertion through URL parameters for legitimate purposes.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains:
            - 'loaddetails.php'
            - 'add'
            - 'create'
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.request.method

  - question: Is this source IP authorized to perform data modification operations?
    context: Legitimate administrative users may have permissions to insert data through web interfaces.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.response.status_code
        - http.request.method

  # Type 3: Activity Context
  - question: What authentication or session establishment preceded this INSERT attempt?
    context: Understanding user context helps determine if this is authorized administrative activity.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains:
            - 'login'
            - 'auth'
            - 'session'
        condition: selection
      fields:
        - url.full
        - http.response.status_code
        - http.request.method

  - question: Were there any reconnaissance attempts to map database structure before the INSERT?
    context: Attackers often probe database structure before attempting to insert malicious data.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: 'SQL'
        condition: selection
      fields:
        - rule.name
        - url.full
        - alert.signature

  # Type 4: Impact Assessment
  - question: Was the INSERT statement successfully executed based on the HTTP response?
    context: Response codes and content indicate whether the malicious data insertion was successful.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes
        - http.response.body.content

  - question: Are there subsequent attempts to access or verify the inserted data?
    context: Successful injections are often followed by attempts to confirm the data was inserted.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.response.status_code

  # Type 5: Forensic Deep-Dive
  - question: What type of data is the attacker attempting to insert (backdoors, users, configuration)?
    context: The nature of inserted data reveals the attacker's persistence strategy and objectives.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: 'INSERT'
        condition: selection
      fields:
        - rule.name
        - url.full
        - alert.signature

  - question: Are there multiple INSERT attempts indicating systematic database manipulation?
    context: Multiple INSERT attempts suggest the attacker is establishing persistence or privilege escalation.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: 'INSERT'
        condition: selection
      fields:
        - rule.name
        - url.path
        - alert.signature

  # Type 6: Enterprise Correlation
  - question: Are other eGroupware servers experiencing similar INSERT-based attacks?
    context: Coordinated attacks may attempt to establish persistence across multiple application instances.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: 'eGroupware'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - url.path

  - question: Is this part of a broader campaign involving multiple SQL injection techniques?
    context: Sophisticated attackers use various SQL injection methods to achieve comprehensive database compromise.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: 'SQL Injection'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - alert.signature