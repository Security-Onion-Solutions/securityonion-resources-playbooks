name: ET WEB_SPECIFIC_APPS Joomla mod_virtuemart_latestprod module Remote File inclusion Attempt
id: 22012703
description: |
  Detects remote file inclusion attempts targeting Joomla's mod_virtuemart_latestprod module through the mosConfig_absolute_path parameter.
  This indicates an attacker attempting to include malicious remote files for code execution or system compromise.
  May trigger on legitimate configuration operations if external file paths are used in module configuration.
type: detection
detection_id: 2012703
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete remote file inclusion URL in the mosConfig_absolute_path parameter?
    context: Understanding the remote file URL reveals the attacker's payload source and intended malicious code.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - http.request.body.content
        - rule.name

  - question: What protocol is being used for the remote file inclusion (HTTP, HTTPS, FTP, PHP)?
    context: The protocol indicates the attacker's hosting infrastructure and potential payload delivery method.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - url.query
        - http.request.method
        - url.path

  # Type 2: Triage Assessment
  - question: Are there legitimate external file inclusions configured for this Joomla VirtueMart module?
    context: Some modules may legitimately reference external configuration files or resources.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains:
            - 'mod_virtuemart_latestprod'
            - 'virtuemart'
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.response.status_code

  - question: Is this source IP associated with authorized Joomla administrators or developers?
    context: Legitimate administrators may test or configure modules with external file references.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.response.status_code
        - http.request.method

  # Type 3: Activity Context
  - question: What reconnaissance or vulnerability scanning preceded this RFI attempt?
    context: Attackers often scan for vulnerable Joomla modules before attempting file inclusion attacks.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.response.status_code

  - question: Were there attempts to access other Joomla components or modules from this source?
    context: Attackers often target multiple Joomla components to find vulnerable entry points.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains:
            - 'joomla'
            - 'modules'
            - 'components'
        condition: selection
      fields:
        - url.full
        - http.response.status_code
        - http.request.method

  # Type 4: Impact Assessment
  - question: Was the remote file inclusion successful based on HTTP response characteristics?
    context: Response codes and sizes indicate whether the remote file was successfully included and executed.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes
        - http.response.headers.content-type

  - question: Are there subsequent requests indicating successful code execution or system compromise?
    context: Successful RFI attacks often lead to immediate follow-up activity like shell commands or file uploads.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.response.status_code

  # Type 5: Forensic Deep-Dive
  - question: What is hosted at the remote file inclusion URL and what malicious payload does it contain?
    context: Analyzing the remote payload reveals the attacker's capabilities and intended system compromise.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: 'Remote File'
        condition: selection
      fields:
        - rule.name
        - url.full
        - alert.signature

  - question: Are there multiple RFI attempts with different remote URLs indicating payload testing?
    context: Attackers often try multiple payloads to bypass security controls or achieve different objectives.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: 'Remote File'
        condition: selection
      fields:
        - rule.name
        - url.path
        - alert.signature

  # Type 6: Enterprise Correlation
  - question: Are other Joomla installations in the environment experiencing similar RFI attacks?
    context: Coordinated attacks may target multiple Joomla instances with the same vulnerable module.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: 'Joomla'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - url.path

  - question: Is this part of a broader web application attack campaign targeting multiple CMS platforms?
    context: Advanced attackers may target various CMS platforms using similar file inclusion techniques.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'WEB_SPECIFIC_APPS'
            - 'Remote File'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - alert.signature