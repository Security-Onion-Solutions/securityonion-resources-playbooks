name: ET WEB_SPECIFIC_APPS vtiger CRM service parameter Cross Site Scripting Attempt
id: 22012706
description: |
  Detects Cross-Site Scripting (XSS) attempts targeting the service parameter in vtiger CRM vtigerservice.php.
  Attackers inject malicious JavaScript to steal credentials or perform unauthorized actions.
  May trigger on legitimate dynamic content but typically indicates XSS exploitation attempt.
type: detection
detection_id: 2012706
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact XSS payload injected into the service parameter?
    context: Understanding the malicious script reveals the attacker's intent and potential impact.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.full
        - url.query
        - http.request.method

  - question: What specific JavaScript events or functions were targeted in the XSS attempt?
    context: Analyzing the script type helps determine the attack vector and potential user interaction required.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains: 'vtigerservice.php'
        condition: selection
      fields:
        - url.query
        - http.request.headers
        - user_agent.original

  # Type 2: Triage Assessment
  - question: Is this legitimate vtiger CRM administrative activity?
    context: Determining if this represents authorized CRM usage or malicious XSS exploitation.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains:
            - 'vtiger'
            - 'index.php'
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.request.method

  - question: Does the source IP have established vtiger CRM user sessions?
    context: Establishing if the source represents a legitimate CRM user or external attacker.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains: 'vtiger'
          http.request.headers|contains: 'Cookie'
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.request.headers

  # Type 3: Activity Context
  - question: What reconnaissance preceded this XSS attempt?
    context: Identifying scanning activity that typically precedes targeted XSS attacks.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains:
            - 'vtiger'
            - '.php'
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.response.status_code

  - question: What other vtiger CRM components were probed by this source?
    context: Understanding the scope of reconnaissance against the CRM installation.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains: 'vtiger'
        condition: selection
      fields:
        - src_ip
        - url.path
        - url.query

  # Type 4: Impact Assessment
  - question: Were there successful responses indicating potential XSS payload delivery?
    context: Determining if the XSS attempt succeeded based on server response characteristics.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains: 'vtigerservice.php'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes
        - http.response.headers

  - question: Did any users subsequently access the potentially compromised CRM page?
    context: Identifying potential victims who may have executed the injected JavaScript.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains: 'vtigerservice.php'
        condition: selection
      fields:
        - src_ip
        - user_agent.original
        - http.request.headers

  # Type 5: Forensic Deep-Dive
  - question: What data exfiltration or credential theft mechanisms were embedded in the XSS payload?
    context: Analyzing the malicious script to understand data theft capabilities and target information.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.query|contains:
            - 'document.cookie'
            - 'XMLHttpRequest'
            - 'fetch'
        condition: selection
      fields:
        - url.query
        - http.request.body.content
        - http.response.body.content

  - question: Are there signs of session hijacking or unauthorized CRM access following the XSS?
    context: Determining if the XSS led to compromise of legitimate user sessions.
    range: +6h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains: 'vtiger'
          http.request.method|contains:
            - 'POST'
            - 'PUT'
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.request.body.content

  # Type 6: Enterprise Correlation
  - question: Are other web applications in the environment experiencing similar XSS attacks?
    context: Identifying if this is part of a broader XSS campaign targeting multiple applications.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'Cross Site Scripting'
            - 'XSS'
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name