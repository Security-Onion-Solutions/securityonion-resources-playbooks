name: ET WEB_SPECIFIC_APPS CitusCMS filePath Parameter Remote File inclusion Attempt
id: 22012724
description: |
  Detects attempts to exploit Remote File Inclusion vulnerability in CitusCMS file.class.php via the filePath parameter.
  Attackers manipulate the filePath parameter to include malicious remote files for code execution.
  May trigger on legitimate file operations but typically indicates exploitation attempt.
type: detection
detection_id: 2012724
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete malicious URL and remote file path in the RFI attempt?
    context: Understanding the full exploit payload reveals the attacker's intended malicious file source and attack vector.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.full
        - url.query
        - http.request.method

  - question: What specific protocol and remote server was targeted for file inclusion?
    context: Analyzing the protocol scheme and remote server helps identify the attack infrastructure and malicious payload source.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains: '/include/classes/file.class.php'
        condition: selection
      fields:
        - url.query
        - url.path
        - http.request.headers

  # Type 2: Triage Assessment
  - question: Is this legitimate CitusCMS administrative file management activity?
    context: Determining if this represents authorized CMS administration or malicious RFI exploitation.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains:
            - '/admin/'
            - '/administrator/'
            - 'citus'
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.request.method

  - question: Does the source IP have a history of legitimate CitusCMS usage?
    context: Establishing baseline behavior to differentiate between authorized users and attackers.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains:
            - 'citus'
            - '/include/'
            - '/classes/'
        condition: selection
      fields:
        - src_ip
        - url.path
        - user_agent.original

  # Type 3: Activity Context
  - question: What reconnaissance activity preceded this RFI exploitation attempt?
    context: Identifying scanning patterns that typically precede targeted Remote File Inclusion attacks.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains:
            - '/include/'
            - '/classes/'
            - '.php'
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.response.status_code

  - question: What other CitusCMS components were targeted by this source?
    context: Understanding the scope of the attack campaign against the CMS installation.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains:
            - 'citus'
            - 'filePath='
            - '/include/'
        condition: selection
      fields:
        - src_ip
        - url.path
        - url.query

  # Type 4: Impact Assessment
  - question: Were there successful HTTP responses indicating potential file inclusion execution?
    context: Determining if the RFI attempt succeeded based on server response codes and content.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains: 'file.class.php'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes
        - url.full

  - question: What outbound connections occurred from the web server after the RFI attempt?
    context: Identifying potential command and control communications or data exfiltration following successful exploitation.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.bytes_sent

  # Type 5: Forensic Deep-Dive
  - question: What malicious payloads or backdoors were included via the remote file?
    context: Analyzing the content of included files to understand attacker capabilities and persistence mechanisms.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          http.request.method: 'GET'
        condition: selection
      fields:
        - url.full
        - http.request.headers
        - http.response.body.content

  - question: Are there signs of web shell deployment or file system manipulation?
    context: Determining if the RFI led to establishment of persistent backdoor access or file system compromise.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains:
            - '.php'
            - 'shell'
            - 'upload'
            - 'cmd'
        condition: selection
      fields:
        - src_ip
        - url.path
        - url.query

  # Type 6: Enterprise Correlation
  - question: Are other CMS installations in the environment under similar RFI attack?
    context: Identifying if this is part of a broader campaign targeting CMS platforms with RFI vulnerabilities.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'Remote File'
            - 'RFI'
            - 'filePath'
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name