name: ET SCAN Possible SQLMAP Scan
id: 22012754
description: |
  Detects potential SQLMAP automated SQL injection scanning activity based on characteristic UNION SELECT patterns.
  May trigger on legitimate database testing tools or manual SQL injection testing.
type: detection
detection_id: 2012754
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the exact SQLMAP signature pattern detected?
    context: Understanding the specific UNION SELECT NULL pattern helps confirm automated tool usage.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - url.query

  - question: Is this authorized penetration testing or security assessment?
    context: SQLMAP is commonly used in legitimate security testing and should be documented if authorized.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.request.headers.user_agent
        - http.request.method

  - question: What web applications are being systematically scanned?
    context: SQLMAP typically targets multiple parameters and pages to identify injection points.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - url.query
        - http.request.method

  - question: How many injection attempts occurred within the detection threshold?
    context: The detection filter requires 4 attempts in 20 seconds, indicating rapid automated scanning.
    range: -30s
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name: "ET SCAN Possible SQLMAP Scan"
        condition: selection
      fields:
        - url.path
        - url.query

  - question: Did SQLMAP identify any vulnerable injection points?
    context: Successful injection discovery typically results in different response patterns or extended scan duration.
    range: +5m
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.response.status_code: 200
        condition: selection
      fields:
        - url.path
        - http.response.body.bytes
        - url.query

  - question: What user-agent strings indicate SQLMAP or other automated tools?
    context: SQLMAP and similar tools often have distinctive user-agent patterns that confirm automated scanning.
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - http.request.headers.user_agent
        - url.path

  - question: Are there signs of successful SQL injection exploitation following the scan?
    context: SQLMAP scanning may be followed by manual exploitation of discovered vulnerabilities.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: "SQL Injection"
        condition: selection
      fields:
        - rule.name
        - url.path
        - url.query

  - question: What database enumeration activity followed the initial scan?
    context: Successful SQLMAP scans are often followed by database schema enumeration and data extraction.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.query|contains:
            - "information_schema"
            - "table_name"
            - "column_name"
        condition: selection
      fields:
        - url.full
        - http.response.status_code

  - question: What other reconnaissance techniques preceded the SQLMAP scan?
    context: SQLMAP scanning is often part of broader web application reconnaissance and vulnerability assessment.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - "SCAN"
            - "reconnaissance"
            - "directory"
        condition: selection
      fields:
        - rule.name
        - url.path

  - question: Are multiple web servers being scanned by this source?
    context: Systematic SQLMAP scanning across multiple targets indicates broad attack campaign scope.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name: "ET SCAN Possible SQLMAP Scan"
        condition: selection
      fields:
        - dst_ip
        - url.path

  - question: What data exfiltration occurred after successful injection discovery?
    context: SQLMAP can automatically extract database contents once vulnerabilities are confirmed.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - bytes_out
        - duration
        - dst_port

  - question: Are there enterprise-wide SQLMAP scanning patterns from this attacker?
    context: Understanding campaign scope helps prioritize response across all potentially vulnerable web applications.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name: "ET SCAN Possible SQLMAP Scan"
        condition: selection
      fields:
        - dst_ip
        - url.path