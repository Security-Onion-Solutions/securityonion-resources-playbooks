name: ET WEB_SPECIFIC_APPS WebAuction lang parameter Cross Site Scripting Attempt
id: 22012797
description: |
  Detects cross-site scripting (XSS) attempts targeting the WebAuction application's lang parameter in test.php.
  The attack attempts to inject malicious JavaScript code that could steal user sessions or perform unauthorized actions.
  May trigger on legitimate testing of calendar functionality with complex parameters.
type: detection
detection_id: 2012797
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact XSS payload injected into the lang parameter?
    context: Analyzing the specific JavaScript payload reveals the attacker's intent and potential impact.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - url.query
        - alert.signature

  - question: What JavaScript event handlers or functions were targeted in the XSS attempt?
    context: Different event handlers (onclick, onload, onmouseover) indicate varying attack sophistication and trigger mechanisms.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - url.query
        - url.path
        - http.request.method

  # Type 2: Triage Assessment
  - question: Is this legitimate testing of the WebAuction calendar functionality?
    context: Developers may test calendar components with various language parameters that could trigger false positives.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains: '/lib/jscalendar/'
        condition: selection
      fields:
        - src_ip
        - url.path
        - user_agent.original

  - question: Does this source IP have a history of legitimate WebAuction usage?
    context: Regular users of the WebAuction platform are less likely to be conducting malicious XSS attacks.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.response.status_code: 200
        condition: selection
      fields:
        - url.path
        - http.request.method
        - user_agent.original

  # Type 3: Activity Context
  - question: What other XSS or injection attempts originated from this source IP?
    context: XSS attacks are often part of broader web application security testing or malicious campaigns.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains:
            - 'Cross Site Scripting'
            - 'XSS'
            - 'Script Injection'
        condition: selection
      fields:
        - dst_ip
        - alert.signature
        - alert.severity

  - question: What was the user agent and referrer information for this request?
    context: Automated scanners and manual testing tools have distinct user agent patterns that help classify the threat.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - user_agent.original
        - http.request.referrer
        - http.request.method

  # Type 4: Impact Assessment
  - question: Did the XSS payload successfully execute based on server response?
    context: HTTP response codes and content length indicate whether the malicious script was processed by the application.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains: '/lib/jscalendar/test.php'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes
        - http.response.mime_type

  - question: Were there any subsequent requests that could indicate session hijacking or data theft?
    context: Successful XSS attacks may be followed by requests to steal cookies or perform unauthorized actions.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.request.method
        - http.request.body.content

  # Type 5: Forensic Deep-Dive
  - question: What cookies or session tokens were present in requests from this source?
    context: XSS attacks often target session management to impersonate legitimate users.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - http.request.headers
        - url.path
        - http.request.method

  - question: Were there any JavaScript error logs or security warnings generated on the target server?
    context: Failed XSS attempts may generate application errors that help confirm malicious intent.
    range: +15m
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          alert.category|contains:
            - 'web-application-attack'
            - 'policy-violation'
        condition: selection
      fields:
        - alert.signature
        - alert.severity
        - src_ip

  # Type 6: Enterprise Correlation
  - question: Are other web applications in the environment being targeted with similar XSS attacks?
    context: Attackers often test the same XSS payloads across multiple applications to find vulnerable targets.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains: 'Cross Site Scripting'
        condition: selection
      fields:
        - dst_ip
        - alert.signature
        - url.path