name: ET MOBILE_MALWARE Android/Smspacem CnC Communication Attempt
id: 22012924
description: |
  Detects Android/Smspacem malware attempting command and control communication via talktome.asmx endpoint.
  Legitimate ASMX web services may trigger false positives if using similar parameter names.
type: detection
detection_id: 2012924
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What specific data was transmitted in the cell and opname parameters?
    context: Analyzing the payload content reveals device information and command structure being exfiltrated.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.body.content
        - url.full
        - http.request.method

  - question: What is the complete structure of the ASMX SOAP request?
    context: Understanding the full request structure helps identify the specific malware variant and capabilities.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains: "/talktome.asmx"
        condition: selection
      fields:
        - http.request.body.content
        - http.request.headers.content_type
        - http.request.headers.user_agent

  # Type 2: Triage Assessment
  - question: Is this a legitimate Android device accessing authorized web services?
    context: Corporate mobile devices may legitimately connect to ASMX services for business applications.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.headers.user_agent|contains: "Android"
        condition: selection
      fields:
        - url.full
        - http.response.status_code
        - http.request.headers.user_agent

  - question: Does this device have a history of normal corporate network usage?
    context: Established legitimate network patterns help distinguish infected devices from normal mobile traffic.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.bytes

  # Type 3: Activity Context
  - question: What triggered this malware communication attempt?
    context: Understanding the activation trigger helps identify infection vector and campaign timing.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.response.status_code

  - question: Were there any suspicious downloads or installations before this communication?
    context: Mobile malware often communicates shortly after installation or system events.
    range: -6h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method: "GET"
          url.path|contains:
            - ".apk"
            - "download"
            - "install"
        condition: selection
      fields:
        - url.full
        - http.response.status_code
        - http.response.body.bytes

  # Type 4: Impact Assessment
  - question: Did the C&C server respond with commands or configuration updates?
    context: Server responses indicate active malware control and potential for additional malicious activities.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - http.response.body.bytes

  - question: What sensitive device information was potentially exfiltrated?
    context: Smspacem malware typically harvests SMS messages, contacts, and device identifiers.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method: "POST"
        condition: selection
      fields:
        - url.full
        - http.request.body.bytes
        - http.response.status_code

  # Type 5: Forensic Deep-Dive
  - question: What other malware families or C&C infrastructure is this device communicating with?
    context: Mobile devices often harbor multiple malware families with different C&C channels.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - "command-and-control"
            - "mobile-malware"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - dst_port

  - question: Are there indicators of SMS fraud or premium service abuse?
    context: Smspacem malware is known for SMS-based fraud and unauthorized premium service subscriptions.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.query|contains:
            - "sms"
            - "premium"
            - "billing"
            - "subscribe"
        condition: selection
      fields:
        - url.full
        - http.request.body.content
        - http.response.status_code

  # Type 6: Enterprise Correlation
  - question: Are other mobile devices in the network showing similar C&C communication patterns?
    context: Mobile malware campaigns often target multiple devices within the same network or organization.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Smspacem"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is this part of a broader mobile malware campaign affecting the organization?
    context: Coordinated mobile malware attacks may indicate targeted campaigns or compromised app distribution.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.category: "command-and-control"
          rule.name|contains: "Android"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name