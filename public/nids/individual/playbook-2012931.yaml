name: ET MALWARE Generic Dropper/Clicker Checkin
id: 22012931
description: |
  Detects generic dropper or clicker malware attempting to check in with command and control infrastructure via nxdtic.txt.
  May trigger on legitimate software update mechanisms or configuration file downloads with similar patterns.
type: detection
detection_id: 2012931
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete URL and headers for the nxdtic.txt request?
    context: The full request reveals the malware's communication protocol and potential C2 infrastructure.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.full
        - http.request.headers
        - http.request.method

  - question: What process initiated this suspicious HTTP request?
    context: Identifying the parent process helps determine the infection vector and malware family.
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - User

  - question: Is this a legitimate software component making configuration requests?
    context: Some legitimate applications may use similar file naming patterns for updates or configuration.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains:
            - ".txt"
        condition: selection
      fields:
        - url.path
        - http.request.headers.user_agent

  - question: What other suspicious network connections originated from this host?
    context: Malware often establishes multiple C2 channels or downloads additional payloads.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - src_port

  - question: What was the server's response to the malware checkin attempt?
    context: Response content may contain commands, configuration updates, or additional payload URLs.
    range: +2m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - http.response.body.bytes

  - question: Are there signs of click fraud or ad-related malicious activity?
    context: Clicker malware typically generates fraudulent ad clicks or redirects for monetization.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains:
            - "/click"
            - "/ad"
            - "/redirect"
        condition: selection
      fields:
        - url.full
        - http.request.headers.referer

  - question: What files were created or modified around the time of this checkin?
    context: Dropper malware may download and execute additional payloads after successful C2 communication.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.mime_type

  - question: Did the malware establish persistence mechanisms after checkin?
    context: Successful C2 communication may trigger installation of persistence mechanisms or additional malware.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - "\\Run"
            - "\\RunOnce"
            - "\\Services"
        condition: selection
      fields:
        - TargetObject
        - Details

  - question: What is the reputation and geolocation of the C2 server?
    context: C2 server characteristics help determine threat actor attribution and campaign scope.
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.resolved_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name

  - question: Are other hosts in the network exhibiting similar malware behavior?
    context: Malware campaigns often target multiple systems within the same network infrastructure.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - "Dropper"
            - "Clicker"
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - rule.name

  - question: Is this part of a broader malware distribution campaign?
    context: Similar C2 infrastructure may be used across multiple malware families or attack campaigns.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.category|contains:
            - "trojan-activity"
            - "command-and-control"
        condition: selection
      fields:
        - src_ip
        - rule.name