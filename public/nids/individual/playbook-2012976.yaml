name: ET WEB_SPECIFIC_APPS HP Insight Diagnostics Online Edition search.php XSS Attempt
id: 22012976
description: |
  Detects Cross-Site Scripting (XSS) attempts against HP Insight Diagnostics Online Edition search functionality.
  May trigger on legitimate search queries containing script-like content but specific patterns indicate malicious intent.
type: detection
detection_id: 2012976
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact XSS payload in the search query parameter?
    context: Understanding the payload reveals attack sophistication and intended impact.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.uri
        - http.request.body.content
        - url.query

  - question: What JavaScript functions or events were included in the attack?
    context: Specific JavaScript patterns indicate attack vector and potential data theft methods.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.uri
        - http.request.method
        - url.full

  # Type 2: Triage Assessment
  - question: Is HP Insight Diagnostics legitimately deployed in this environment?
    context: Confirming application presence helps validate if this is a targeted attack.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          http.uri|contains:
            - "/hpdiags/"
        condition: selection
      fields:
        - src_ip
        - http.uri
        - http.user_agent

  - question: Does the source IP have legitimate access to this HP application?
    context: Authorized users vs external attackers changes response priority.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - http.uri
        - http.user_agent
        - http.response.status_code

  # Type 3: Activity Context
  - question: What preceded this XSS attempt in the same session?
    context: Understanding attack sequence reveals if this is reconnaissance or exploitation.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - http.uri
        - http.request.method
        - http.response.status_code

  - question: Were there multiple XSS attempts with different payloads?
    context: Multiple attempts suggest automated scanning or persistent attacker.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.uri|contains:
            - "/hpdiags/frontend2/help/search.php"
        condition: selection
      fields:
        - http.uri
        - url.query
        - http.response.status_code

  # Type 4: Impact Assessment
  - question: Did the HP application return content that could execute the XSS payload?
    context: Successful XSS requires vulnerable response that reflects attacker input.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - http.response.headers

  - question: Are there signs of successful script execution or data theft?
    context: Follow-up requests may indicate successful XSS exploitation.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - http.uri
        - http.request.headers
        - url.domain

  # Type 5: Forensic Deep-Dive
  - question: What vulnerability scanning tools or signatures are present?
    context: User-Agent and request patterns may reveal automated exploitation tools.
    range: +/-30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - http.user_agent
        - http.request.headers
        - http.uri

  - question: Are there attempts to exploit other CVE-2010-4111 related vulnerabilities?
    context: Attackers often exploit multiple vulnerabilities in the same application.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.uri|contains:
            - "script"
            - "alert"
            - "onmouse"
            - "onclick"
        condition: selection
      fields:
        - http.uri
        - url.query
        - http.request.method

  # Type 6: Enterprise Correlation
  - question: Are other HP Insight Diagnostics instances being targeted?
    context: Coordinated attacks may target multiple HP installations across the network.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          http.uri|contains:
            - "/hpdiags/"
          url.query|contains:
            - "script"
            - "alert"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - http.uri

  - question: Is this source IP attacking other web applications in the environment?
    context: Broad scanning activity indicates opportunistic attacker vs targeted threat.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "XSS"
            - "web-application-attack"
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - http.uri