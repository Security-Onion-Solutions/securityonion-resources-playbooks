name: ET WEB_SPECIFIC_APPS ZOHO ManageEngine ADSelfService Employee Search XSS Attempt
id: 22012980
description: |
  Detects Cross-Site Scripting attempts against ZOHO ManageEngine ADSelfService Employee Search functionality.
  May trigger on legitimate employee searches containing script-like terms but specific parameter patterns indicate attack.
type: detection
detection_id: 2012980
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete XSS payload in the searchString parameter?
    context: Understanding the payload structure reveals attack sophistication and intended victim targeting.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.uri
        - url.query
        - http.request.body.content

  - question: What actionId was specified in the malicious request?
    context: The actionId parameter may indicate specific application functionality being exploited.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.uri
        - url.query
        - http.request.method

  # Type 2: Triage Assessment
  - question: Is ZOHO ManageEngine ADSelfService legitimately deployed for this organization?
    context: Confirming application deployment helps validate if this is a targeted attack against known infrastructure.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          http.uri|contains:
            - "/EmployeeSearch"
        condition: selection
      fields:
        - src_ip
        - http.user_agent
        - http.response.status_code

  - question: Does the attacking IP have legitimate access to employee directory services?
    context: Internal vs external source determines if this is insider threat or external attack.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - http.uri
        - http.user_agent
        - http.response.status_code

  # Type 3: Activity Context
  - question: What employee search activity preceded this XSS attempt?
    context: Legitimate searches followed by XSS may indicate session hijacking or escalation.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.uri|contains:
            - "/EmployeeSearch"
        condition: selection
      fields:
        - http.uri
        - url.query
        - http.response.status_code

  - question: Were there authentication attempts before the XSS attack?
    context: Failed logins followed by XSS suggests credential stuffing then exploitation.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.request.method: "POST"
        condition: selection
      fields:
        - http.uri
        - http.response.status_code
        - http.user_agent

  # Type 4: Impact Assessment
  - question: Did the ManageEngine application reflect the XSS payload in its response?
    context: Successful XSS requires vulnerable response that executes attacker JavaScript.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - http.response.headers

  - question: Are there signs of successful script execution or data exfiltration?
    context: Follow-up requests to attacker domains indicate successful XSS exploitation.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - http.uri

  # Type 5: Forensic Deep-Dive
  - question: What employee data was accessible through the compromised search function?
    context: Understanding data exposure helps determine breach notification requirements.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          http.uri|contains:
            - "/EmployeeSearch"
          http.response.status_code: 200
        condition: selection
      fields:
        - src_ip
        - url.query
        - http.response.body.bytes

  - question: Are there attempts to exploit other CVE-2010-3274 related vulnerabilities?
    context: Attackers often chain multiple vulnerabilities in the same application for maximum impact.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - http.uri
        - url.query
        - http.user_agent

  # Type 6: Enterprise Correlation
  - question: Are other ManageEngine installations being targeted across the network?
    context: Coordinated attacks may target multiple ManageEngine services for broader access.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          http.uri|contains:
            - "ManageEngine"
            - "EmployeeSearch"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - url.domain

  - question: Is this part of a broader XSS campaign against web applications?
    context: Multiple XSS attempts suggest automated scanning or persistent threat actor.
    range: +/-6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "XSS"
            - "web-application-attack"
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - http.uri