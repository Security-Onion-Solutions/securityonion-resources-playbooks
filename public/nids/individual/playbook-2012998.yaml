name: ET WEB_SERVER PHP Possible https Local File Inclusion Attempt
id: 22012998
description: |
  Detects potential Local File Inclusion (LFI) attacks using HTTPS wrapper streams in PHP applications.
  Legitimate applications may use HTTPS streams for remote content, but this pattern often indicates exploitation attempts.
type: detection
detection_id: 2012998
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete URI and parameter containing the https:// injection?
    context: Understanding the exact payload reveals the attacker's target file or remote resource.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - http.request.body.content

  - question: What specific PHP parameter was targeted for the file inclusion?
    context: Identifying vulnerable parameters helps assess application security posture.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.query
        - http.request.headers

  # Type 2: Triage Assessment
  - question: Is this web application known to legitimately use HTTPS stream wrappers?
    context: Some applications may use HTTPS streams for configuration or content loading.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|expand: '%dst_port%'
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.request.method

  - question: Does the source IP have a history of legitimate access to this web server?
    context: Established legitimate users are less likely to be conducting attacks.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.response.status_code
        - http.request.method

  # Type 3: Activity Context
  - question: What other HTTP requests occurred from this source around the same time?
    context: Attack patterns often involve reconnaissance and multiple exploitation attempts.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.response.status_code

  - question: Were there any successful responses (200 OK) to previous requests from this source?
    context: Successful responses may indicate reconnaissance or successful exploitation.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.response.status_code: 200
        condition: selection
      fields:
        - url.full
        - http.response.body.bytes

  # Type 4: Impact Assessment
  - question: Did the server return a successful response to this LFI attempt?
    context: A 200 response may indicate successful file inclusion and potential data exposure.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes

  - question: Are there signs of data exfiltration following this request?
    context: Large response sizes may indicate successful file disclosure.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - network.bytes
        - network.packets

  # Type 5: Forensic Deep-Dive
  - question: What other LFI or RFI attack patterns has this source attempted?
    context: Attackers often try multiple inclusion techniques to find vulnerable parameters.
    range: +/-2h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "File Inclusion"
            - "LFI"
            - "RFI"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - dst_port

  - question: Are there indicators of web shell deployment or command execution?
    context: Successful LFI attacks may lead to web shell installation or remote code execution.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - "Web Shell"
            - "Command Execution"
            - "Code Injection"
        condition: selection
      fields:
        - rule.name
        - src_ip

  # Type 6: Enterprise Correlation
  - question: Are other web servers in the environment experiencing similar LFI attempts?
    context: Coordinated attacks often target multiple systems with the same vulnerability.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "File Inclusion"
        condition: selection
      fields:
        - dst_ip
        - rule.name