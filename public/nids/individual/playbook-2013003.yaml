name: ET WEB_SERVER PHP Possible data Remote File Inclusion Attempt
id: 22013003
description: |
  Detects potential Remote File Inclusion (RFI) attacks using data wrapper streams in PHP applications.
  Legitimate applications may use data streams for inline content, but this pattern often indicates exploitation attempts.
type: detection
detection_id: 2013003
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete URI and parameter containing the data:// injection?
    context: Understanding the exact payload reveals the attacker's embedded code or data stream.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - http.request.body.content

  - question: What specific PHP parameter was targeted for the data stream inclusion?
    context: Identifying vulnerable parameters helps assess application security posture.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.query
        - http.request.headers

  # Type 2: Triage Assessment
  - question: Is this web application known to legitimately use data wrapper streams?
    context: Some applications may use data streams for inline content or configuration.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|expand: '%dst_port%'
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.request.method

  - question: Does the source IP have a history of legitimate access to this web server?
    context: Established legitimate users are less likely to be conducting attacks.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.response.status_code
        - http.request.method

  # Type 3: Activity Context
  - question: What other HTTP requests occurred from this source around the same time?
    context: Attack patterns often involve reconnaissance and multiple exploitation attempts.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.response.status_code

  - question: Were there any parameter fuzzing or injection attempts preceding this?
    context: Attackers often test parameters before attempting data stream inclusion.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - "Injection"
            - "Parameter"
            - "Fuzzing"
        condition: selection
      fields:
        - rule.name
        - url.full

  # Type 4: Impact Assessment
  - question: Did the server return a successful response to this data stream inclusion attempt?
    context: A 200 response may indicate successful code execution via data stream.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes

  - question: Are there signs of code execution or unusual server behavior following this request?
    context: Data stream inclusion can lead to immediate code execution and system compromise.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - network.bytes
        - network.packets

  # Type 5: Forensic Deep-Dive
  - question: What other data stream or inline code injection patterns has this source attempted?
    context: Attackers often try multiple data stream techniques for code execution.
    range: +/-2h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "data"
            - "Code Injection"
            - "Inline"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - dst_port

  - question: Are there indicators of persistent access or backdoor installation?
    context: Successful data stream attacks may lead to web shell deployment or persistent access.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - "Web Shell"
            - "Backdoor"
            - "Persistent"
        condition: selection
      fields:
        - rule.name
        - src_ip

  # Type 6: Enterprise Correlation
  - question: Are other web servers experiencing similar data wrapper inclusion attempts?
    context: Coordinated attacks often target multiple systems with the same vulnerability.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "data"
        condition: selection
      fields:
        - dst_ip
        - rule.name

  - question: Is this part of a broader campaign targeting PHP applications?
    context: Understanding campaign scope helps prioritize response and remediation efforts.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "PHP"
        condition: selection
      fields:
        - dst_ip
        - rule.name