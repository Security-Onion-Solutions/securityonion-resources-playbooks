name: ET WEB_SERVER PHP Possible glob Remote File Inclusion Attempt
id: 22013004
description: |
  Detects potential Remote File Inclusion (RFI) attacks using glob wrapper streams in PHP applications.
  Legitimate applications may use glob streams for file pattern matching, but this pattern often indicates exploitation attempts.
type: detection
detection_id: 2013004
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete URI and parameter containing the glob:// injection?
    context: Understanding the exact payload reveals the attacker's file pattern matching attempt.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - http.request.body.content

  - question: What specific PHP parameter was targeted for the glob stream inclusion?
    context: Identifying vulnerable parameters helps assess application security posture.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.query
        - http.request.headers

  # Type 2: Triage Assessment
  - question: Is this web application known to legitimately use glob pattern matching?
    context: Some applications may use glob streams for file operations or directory listing.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|expand: '%dst_port%'
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.request.method

  - question: Does the source IP have a history of legitimate access to this web server?
    context: Established legitimate users are less likely to be conducting attacks.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.response.status_code
        - http.request.method

  # Type 3: Activity Context
  - question: What other HTTP requests occurred from this source around the same time?
    context: Attack patterns often involve reconnaissance and multiple exploitation attempts.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.response.status_code

  - question: Were there any directory enumeration or file discovery attempts preceding this?
    context: Attackers often enumerate directories before attempting glob pattern inclusion.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - "Directory"
            - "Enumeration"
            - "File Discovery"
        condition: selection
      fields:
        - rule.name
        - url.full

  # Type 4: Impact Assessment
  - question: Did the server return a successful response to this glob inclusion attempt?
    context: A 200 response may indicate successful file pattern matching and potential information disclosure.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes

  - question: Are there signs of file system enumeration or data disclosure following this request?
    context: Glob patterns can reveal file system structure and sensitive file locations.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - network.bytes
        - network.packets

  # Type 5: Forensic Deep-Dive
  - question: What other file system wrapper or enumeration patterns has this source attempted?
    context: Attackers often try multiple wrapper types for file system access and enumeration.
    range: +/-2h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "glob"
            - "File System"
            - "Directory"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - dst_port

  - question: Are there indicators of privilege escalation or unauthorized file access?
    context: Successful glob attacks may lead to access of sensitive files or system information.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - "Privilege Escalation"
            - "Unauthorized Access"
            - "Sensitive File"
        condition: selection
      fields:
        - rule.name
        - src_ip

  # Type 6: Enterprise Correlation
  - question: Are other web servers experiencing similar glob wrapper inclusion attempts?
    context: Coordinated attacks often target multiple systems with the same vulnerability.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "glob"
        condition: selection
      fields:
        - dst_ip
        - rule.name

  - question: Is this part of a broader file system reconnaissance campaign?
    context: Understanding campaign scope helps prioritize response and remediation efforts.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "File"
            - "Directory"
            - "Enumeration"
        condition: selection
      fields:
        - dst_ip
        - rule.name