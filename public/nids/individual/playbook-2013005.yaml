name: ET WEB_SERVER PHP Possible phar Remote File Inclusion Attempt
id: 22013005
description: |
  Detects potential Remote File Inclusion (RFI) attacks using phar wrapper streams in PHP applications.
  Legitimate applications may use phar streams for archive access, but this pattern often indicates exploitation attempts.
type: detection
detection_id: 2013005
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete URI and parameter containing the phar:// injection?
    context: Understanding the exact payload reveals the attacker's target archive or deserialization attempt.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - http.request.body.content

  - question: What specific PHP parameter was targeted for the phar stream inclusion?
    context: Identifying vulnerable parameters helps assess application security posture and deserialization risks.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.query
        - http.request.headers

  # Type 2: Triage Assessment
  - question: Is this web application known to legitimately use phar archives or streams?
    context: Some applications may use phar streams for package management or archive processing.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|expand: '%dst_port%'
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.request.method

  - question: Does the source IP have a history of legitimate access to this web server?
    context: Established legitimate users are less likely to be conducting attacks.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.response.status_code
        - http.request.method

  # Type 3: Activity Context
  - question: What other HTTP requests occurred from this source around the same time?
    context: Attack patterns often involve reconnaissance and multiple exploitation attempts.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.response.status_code

  - question: Were there any file upload or archive manipulation attempts preceding this?
    context: Attackers often upload malicious phar files before attempting inclusion attacks.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - "File Upload"
            - "Archive"
            - "Upload"
        condition: selection
      fields:
        - rule.name
        - url.full

  # Type 4: Impact Assessment
  - question: Did the server return a successful response to this phar inclusion attempt?
    context: A 200 response may indicate successful deserialization and potential code execution.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes

  - question: Are there signs of deserialization or code execution following this request?
    context: Phar inclusion can trigger deserialization vulnerabilities and remote code execution.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - network.bytes
        - network.packets

  # Type 5: Forensic Deep-Dive
  - question: What other deserialization or phar-related attack patterns has this source attempted?
    context: Attackers often try multiple phar techniques for deserialization exploitation.
    range: +/-2h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "phar"
            - "Deserialization"
            - "Archive"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - dst_port

  - question: Are there indicators of object injection or gadget chain exploitation?
    context: Successful phar attacks may lead to object injection and gadget chain exploitation.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - "Object Injection"
            - "Gadget Chain"
            - "Serialization"
        condition: selection
      fields:
        - rule.name
        - src_ip

  # Type 6: Enterprise Correlation
  - question: Are other web servers experiencing similar phar wrapper inclusion attempts?
    context: Coordinated attacks often target multiple systems with the same vulnerability.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "phar"
        condition: selection
      fields:
        - dst_ip
        - rule.name

  - question: Is this part of a broader deserialization exploitation campaign?
    context: Understanding campaign scope helps prioritize response and remediation efforts.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "Deserialization"
            - "Object Injection"
            - "Serialization"
        condition: selection
      fields:
        - dst_ip
        - rule.name