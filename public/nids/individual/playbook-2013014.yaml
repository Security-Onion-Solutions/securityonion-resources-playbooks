name: ET WEB_SERVER PHP Possible zlib Remote File Inclusion Attempt
id: 22013014
description: |
  Detects potential Remote File Inclusion (RFI) attacks using zlib wrapper streams in PHP applications.
  Legitimate applications may use zlib streams for compression, but this pattern often indicates exploitation attempts.
type: detection
detection_id: 2013014
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete URI and parameter containing the zlib:// injection?
    context: Understanding the exact payload reveals the attacker's target compressed file or stream.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - http.request.body.content

  - question: What specific PHP parameter was targeted for the zlib stream inclusion?
    context: Identifying vulnerable parameters helps assess application security posture.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.query
        - http.request.headers

  # Type 2: Triage Assessment
  - question: Is this web application known to legitimately use zlib compression streams?
    context: Some applications may use zlib streams for data compression or decompression.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|expand: '%dst_port%'
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.request.method

  - question: Does the source IP have a history of legitimate access to this web server?
    context: Established legitimate users are less likely to be conducting attacks.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.response.status_code
        - http.request.method

  # Type 3: Activity Context
  - question: What other HTTP requests occurred from this source around the same time?
    context: Attack patterns often involve reconnaissance and multiple exploitation attempts.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.response.status_code

  - question: Were there any directory traversal or file enumeration attempts preceding this?
    context: Attackers often enumerate files before attempting inclusion attacks.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - "Directory Traversal"
            - "File Enumeration"
            - "Path Traversal"
        condition: selection
      fields:
        - rule.name
        - url.full

  # Type 4: Impact Assessment
  - question: Did the server return a successful response to this RFI attempt?
    context: A 200 response may indicate successful file inclusion and potential code execution.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes

  - question: Are there signs of compressed data transfer following this request?
    context: Large compressed data transfers may indicate successful exploitation or data exfiltration.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - network.bytes
        - network.packets

  # Type 5: Forensic Deep-Dive
  - question: What other stream wrapper or RFI attack patterns has this source attempted?
    context: Attackers often try multiple wrapper types to find vulnerable parameters.
    range: +/-2h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "File Inclusion"
            - "RFI"
            - "wrapper"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - dst_port

  - question: Are there indicators of malicious payload execution or web shell activity?
    context: Successful RFI attacks may lead to remote code execution or backdoor installation.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - "Web Shell"
            - "Code Execution"
            - "Backdoor"
        condition: selection
      fields:
        - rule.name
        - src_ip

  # Type 6: Enterprise Correlation
  - question: Are other web servers experiencing similar zlib wrapper inclusion attempts?
    context: Coordinated attacks often target multiple systems with the same vulnerability.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "zlib"
        condition: selection
      fields:
        - dst_ip
        - rule.name