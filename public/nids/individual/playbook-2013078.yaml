name: ET MOBILE_MALWARE Android.YzhcSms CnC Keepalive Message
id: 22013078
description: |
  Detects Android.YzhcSms malware sending keepalive messages to command and control servers.
  May trigger on legitimate Android applications using similar heartbeat mechanisms.
type: detection
detection_id: 2013078
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact C2 keepalive URI pattern detected?
    context: The specific URI structure reveals the Android.YzhcSms variant and C2 communication protocol.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - url.path
        - url.query

  - question: What additional parameters or data were included in the heartbeat request?
    context: Keepalive messages often contain device information or status updates for the C2 server.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.request.headers
        - http.request.body.content
        - http.response.status_code

  # Type 2: Triage Assessment
  - question: Is this communication from a known Android device on the network?
    context: Legitimate Android devices may have similar HTTP patterns, requiring device identification.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - bytes_in

  - question: Does this device have authorized mobile management or legitimate Android applications?
    context: Corporate mobile devices may have management software that could generate similar traffic patterns.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains:
            - "android"
            - "mobile"
        condition: selection
      fields:
        - url.full
        - dst_ip
        - http.request.method

  # Type 3: Activity Context
  - question: What triggered the initial Android.YzhcSms infection on this device?
    context: Understanding the infection vector helps prevent similar compromises and assess campaign scope.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains:
            - ".apk"
        condition: selection
      fields:
        - url.full
        - dst_ip
        - http.response.status_code

  - question: What other C2 communications have occurred from this infected device?
    context: YzhcSms typically maintains persistent C2 communication beyond just keepalive messages.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains:
            - "android"
            - ".php"
        condition: selection
      fields:
        - url.full
        - dst_ip
        - http.request.method

  - question: Has this device downloaded additional malicious payloads or updates?
    context: Mobile malware often downloads additional modules or updates from C2 servers.
    range: -6h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.full
        - http.response.body.bytes
        - dst_ip

  # Type 4: Impact Assessment
  - question: Is the C2 server responding and providing commands to the infected device?
    context: Active C2 communication indicates ongoing threat requiring immediate containment.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - http.response.status_code
        - http.response.body.content

  - question: What sensitive data or SMS capabilities might be compromised on this device?
    context: YzhcSms targets SMS functionality and personal data, requiring assessment of data exposure.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 25
            - 587
            - 465
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out

  # Type 5: Forensic Deep-Dive
  - question: What specific YzhcSms variant indicators are present in the traffic?
    context: Different YzhcSms variants have distinct C2 patterns that help identify capabilities and threat level.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains:
            - "dbug.php"
            - "heart"
        condition: selection
      fields:
        - url.full
        - http.request.headers
        - dst_ip

  - question: Are there signs of SMS interception or premium SMS abuse?
    context: YzhcSms primary function is SMS manipulation, requiring analysis of communication patterns.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - bytes_in

  # Type 6: Enterprise Correlation
  - question: Are other mobile devices showing similar YzhcSms infection indicators?
    context: Mobile malware campaigns often target multiple devices simultaneously.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          url.path|contains:
            - "/android/android.dbug.php?action=heart"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - url.full