name: ET WEB_SPECIFIC_APPS impressCMS dhtmltextarea root_path Parameter Remote File Inclusion Attempt
id: 22013089
description: |
  Detects remote file inclusion attempts targeting impressCMS dhtmltextarea editor via the root_path parameter.
  May trigger on legitimate file operations or testing activities that use similar URL patterns.
type: detection
detection_id: 2013089
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete malicious URL and payload used in the dhtmltextarea attack?
    context: Understanding the exact payload reveals the attacker's intended file inclusion source.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.request.body.content

  - question: What remote file or protocol was specified in the root_path parameter?
    context: Identifying the target file helps determine attack intent and potential payload delivery.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - url.query
        - http.request.referrer

  # Type 2: Triage Assessment
  - question: Is this impressCMS dhtmltextarea editor actively used by legitimate users?
    context: Determines if this is a production editor or abandoned installation vulnerable to exploitation.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains:
            - "/editors/dhtmltextarea/"
            - "/dhtmltextarea/"
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.response.status_code

  - question: Are there legitimate dhtmltextarea operations from this source IP?
    context: Helps distinguish between authorized content editing and malicious exploitation attempts.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains:
            - "/editors/dhtmltextarea/"
        condition: selection
      fields:
        - url.path
        - http.response.status_code
        - user_agent.original

  # Type 3: Activity Context
  - question: What editor reconnaissance activity preceded this dhtmltextarea attack?
    context: Attackers often probe for vulnerable editors before attempting exploitation.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains:
            - "/editors/"
            - "/dhtmltextarea/"
            - "/tinymce/"
            - "/fckeditor/"
        condition: selection
      fields:
        - url.path
        - http.response.status_code
        - http.request.method

  - question: What was the server's response to this dhtmltextarea file inclusion attempt?
    context: Response codes indicate if the attack succeeded and what error handling occurred.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes
        - http.response.body.content

  # Type 4: Impact Assessment
  - question: Did the dhtmltextarea file inclusion attempt result in successful code execution?
    context: Determines if malicious code was successfully included and executed on the server.
    range: +15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.response.status_code

  - question: Are there signs of webshell deployment after the dhtmltextarea attack?
    context: Successful RFI attacks often lead to webshell installation for persistent access.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains:
            - ".php"
            - "cmd="
            - "shell"
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.request.method

  # Type 5: Forensic Deep-Dive
  - question: What other impressCMS editor vulnerabilities were tested systematically?
    context: Attackers often test multiple editor vulnerabilities in the same CMS installation.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains:
            - "/editors/"
            - "/dhtmltextarea/"
            - "/tinymce/"
            - "/fckeditor/"
        condition: selection
      fields:
        - url.path
        - url.query
        - http.response.status_code

  - question: What attack methodology and tools were used against dhtmltextarea?
    context: Identifies automated tools or manual testing methods used by the attacker.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains:
            - "/dhtmltextarea/"
        condition: selection
      fields:
        - user_agent.original
        - http.request.method
        - url.query

  # Type 6: Enterprise Correlation
  - question: Are other web servers targeted with similar dhtmltextarea RFI attacks?
    context: Determines if this is part of a broader campaign against multiple web applications.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - "dhtmltextarea"
            - "Remote File"
            - "File Inclusion"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is this source IP conducting broader web application attacks?
    context: Helps identify if this is part of comprehensive web application security testing or attacks.
    range: +/-6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "WEB_SPECIFIC_APPS"
            - "SQL Injection"
            - "Cross Site"
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - rule.category