name: ET WEB_SPECIFIC_APPS Apache Archive confirmDeleteRepository script Cross Site Scripting Attempt
id: 22013106
description: |
  Detects Cross Site Scripting (XSS) attempts targeting Apache Archiva's confirmDeleteRepository functionality.
  Triggers on malicious JavaScript injection in repoid parameter. May trigger on legitimate repository
  names containing HTML/JavaScript-like content or automated security scanning.
type: detection
detection_id: 2013106
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the exact XSS payload injected in the repoid parameter?
    context: Understanding the payload reveals attack sophistication and potential for repository deletion.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.body.content
        - url.full
        - url.query

  - question: Is this legitimate repository deletion activity by authorized administrators?
    context: Repository deletion is a critical administrative function that requires verification of legitimacy.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains:
            - "/archiva/admin/confirmDeleteRepository"
        condition: selection
      fields:
        - url.query
        - http.request.method
        - user_agent.original

  - question: What repository management actions preceded this deletion attempt?
    context: Legitimate deletions typically follow repository listing or configuration review activities.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains:
            - "/archiva/admin/"
        condition: selection
      fields:
        - url.path
        - http.request.method
        - http.response.status_code

  - question: Did the XSS payload trigger successful repository deletion?
    context: Successful exploitation could result in critical data loss requiring immediate incident response.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains:
            - "/archiva/admin/deleteRepository"
        condition: selection
      fields:
        - src_ip
        - http.response.status_code
        - url.query

  - question: What authentication context was used for this deletion attempt?
    context: Repository deletion requires administrative privileges; compromised accounts need immediate attention.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - user_agent.original
        - http.request.headers

  - question: Are there signs of session token theft following this XSS attempt?
    context: XSS in deletion workflows often targets session hijacking for persistent administrative access.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.headers|contains:
            - "Cookie:"
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.request.headers

  - question: What repository enumeration occurred before this targeted attack?
    context: Attackers typically discover repository names before crafting targeted deletion XSS payloads.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains:
            - "/archiva/"
        condition: selection
      fields:
        - url.path
        - http.request.method
        - http.response.status_code

  - question: Has this source attempted XSS against other repository management functions?
    context: Comprehensive attacks often target multiple administrative functions for maximum impact.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "Apache Archive"
            - "XSS"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - alert.signature

  - question: What critical repository data could be at risk from this attack?
    context: Understanding repository contents helps assess potential data loss and business impact.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains:
            - "/archiva/repository/"
            - "/archiva/browse/"
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.response.body.bytes

  - question: Are other Apache Archiva instances showing similar deletion-focused XSS attempts?
    context: Enterprise attacks often target repository deletion across multiple Archiva deployments.
    range: -12h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - "confirmDeleteRepository"
            - "XSS"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: What backup and recovery actions were triggered following this attempt?
    context: Repository deletion attempts should trigger immediate backup verification and recovery procedures.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains:
            - "/archiva/admin/backup"
            - "/archiva/admin/restore"
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.request.method