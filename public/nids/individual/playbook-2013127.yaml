name: ET WEB_SPECIFIC_APPS SoftMP3 search Parameter UNION SELECT SQL Injection Attempt
id: 22013127
description: |
  Detects SQL injection attempts targeting SoftMP3 application via UNION SELECT statements in search parameter.
  May trigger on legitimate complex queries but requires investigation due to external origin and data extraction potential.
type: detection
detection_id: 2013127
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete UNION SELECT payload in the search parameter?
    context: UNION SELECT statements reveal data extraction attempts and database schema knowledge.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - http.request.body.content
        - rule.name

  - question: What database columns and tables were targeted for extraction?
    context: UNION SELECT structure reveals what sensitive data the attacker attempted to access.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path: "/minbrowse.php"
        condition: selection
      fields:
        - url.query
        - http.request.method
        - url.full

  - question: Is this normal complex query activity for the SoftMP3 application?
    context: Legitimate advanced search functionality may use complex SQL operations.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path: "/minbrowse.php"
        condition: selection
      fields:
        - src_ip
        - url.query
        - http.request.method

  - question: What reconnaissance preceded this UNION SELECT injection?
    context: Attackers typically probe database structure before attempting data extraction.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - url.query
        - http.request.method
        - http.response.status_code

  - question: Did the UNION SELECT injection successfully extract data?
    context: Successful data extraction may be indicated by large response sizes or specific content.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - http.response.body.bytes

  - question: What sensitive information was exposed through the injection response?
    context: UNION SELECT responses may contain passwords, user data, or configuration details.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.response.body.bytes|gt: 1000
        condition: selection
      fields:
        - http.response.body.content
        - http.response.body.bytes
        - url.path

  - question: Were system tables or configuration data accessed?
    context: UNION SELECT may target system tables to extract database credentials or configuration.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.response.body.content|contains:
            - "information_schema"
            - "mysql"
            - "admin"
            - "password"
        condition: selection
      fields:
        - http.response.body.content
        - url.path
        - http.response.status_code

  - question: What error messages revealed database schema structure?
    context: UNION SELECT errors can expose table names, column counts, and data types.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          http.response.body.content|contains:
            - "column count"
            - "doesn't match"
            - "unknown column"
            - "syntax error"
        condition: selection
      fields:
        - http.response.body.content
        - http.response.status_code
        - url.path

  - question: Was the extracted data used for further exploitation?
    context: Successful data extraction may lead to credential stuffing or lateral movement.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains:
            - "login"
            - "auth"
            - "admin"
        condition: selection
      fields:
        - url.full
        - http.response.status_code
        - http.request.method

  - question: Are there patterns of UNION SELECT attacks across multiple SoftMP3 installations?
    context: Automated scanning tools may target multiple vulnerable instances for data harvesting.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "SoftMP3"
          rule.name|contains: "UNION SELECT"
        condition: selection
      fields:
        - dst_ip
        - src_ip
        - rule.name

  - question: What is the data exfiltration volume and frequency from this attacker?
    context: Understanding data transfer patterns helps assess the scope of potential data theft.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toclient
        - bytes_toserver