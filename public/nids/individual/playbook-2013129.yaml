name: ET WEB_SPECIFIC_APPS SoftMP3 search Parameter UPDATE SET SQL Injection Attempt
id: 22013129
description: |
  Detects SQL injection attempts targeting SoftMP3 application via UPDATE SET statements in search parameter.
  May trigger on legitimate database operations but requires investigation due to external origin.
type: detection
detection_id: 2013129
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the exact SQL injection payload in the search parameter?
    context: Understanding the complete payload reveals the attacker's intent and target database structure.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - http.request.body.content
        - rule.name

  - question: What other parameters were included in the minbrowse.php request?
    context: Additional parameters may reveal the scope of the attack or reconnaissance efforts.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path: "/minbrowse.php"
        condition: selection
      fields:
        - url.query
        - http.request.method
        - url.full

  - question: Is this normal administrative activity for the SoftMP3 application?
    context: Legitimate database updates may occur during normal application maintenance.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path: "/minbrowse.php"
        condition: selection
      fields:
        - src_ip
        - url.query
        - http.request.method

  - question: What was the sequence of HTTP requests from this source IP?
    context: Attack patterns often involve multiple requests for reconnaissance and exploitation.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - url.query
        - http.request.method
        - http.response.status_code

  - question: What was the server's response to the SQL injection attempt?
    context: Response codes and content help determine if the injection was successful.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - http.response.body.bytes

  - question: Did the injection attempt result in database modifications?
    context: Successful UPDATE statements could indicate data corruption or unauthorized changes.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.response.status_code: 200
        condition: selection
      fields:
        - url.path
        - http.response.body.bytes
        - http.response.status_code

  - question: What database error messages were returned in responses?
    context: Error messages can reveal database structure and confirm injection success.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          http.response.body.content|contains:
            - "mysql"
            - "syntax error"
            - "database"
            - "SQL"
        condition: selection
      fields:
        - http.response.body.content
        - http.response.status_code
        - url.path

  - question: Are there signs of successful authentication bypass or privilege escalation?
    context: SQL injection may be used to bypass login mechanisms or escalate privileges.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains:
            - "admin"
            - "login"
            - "auth"
        condition: selection
      fields:
        - url.full
        - http.response.status_code
        - http.request.method

  - question: What sensitive files or directories were accessed after the injection?
    context: Post-exploitation activity may reveal data exfiltration or system compromise.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains:
            - "config"
            - "backup"
            - "dump"
            - "export"
        condition: selection
      fields:
        - url.full
        - http.response.body.bytes
        - http.response.status_code

  - question: Are other systems showing similar SoftMP3 SQL injection attempts?
    context: Coordinated attacks may target multiple SoftMP3 installations across the network.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "SoftMP3"
          rule.name|contains: "SQL Injection"
        condition: selection
      fields:
        - dst_ip
        - src_ip
        - rule.name

  - question: What is the geographical origin and reputation of the attacking IP?
    context: External threat intelligence helps assess the sophistication and intent of the attack.
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - bytes_toserver