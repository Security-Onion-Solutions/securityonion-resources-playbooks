name: ET MALWARE Win32.Jadtre Retrieving Cfg File
id: 22013286
description: |
  Detects Win32.Jadtre malware retrieving configuration files from remote servers.
  The malware uses specific URI patterns to download data.cfg, main.cfg, or patch.cfg files.
  Legitimate applications may use similar paths but the specific pattern is highly suspicious.
type: detection
detection_id: 2013286
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: Which specific configuration file was the Jadtre malware attempting to retrieve?
    context: Different cfg files (data, main, patch) indicate different malware functions and update stages.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - url.path
        - url.query

  - question: What was the complete URI structure used in this Jadtre communication?
    context: The full URI reveals the malware's server infrastructure and file organization.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - url.full
        - http.request.headers
        - user_agent.original

  # Type 2: Triage Assessment
  - question: Is this system authorized to download configuration files from external sources?
    context: Some legitimate applications download configuration updates from remote servers.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains: ".cfg"
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - url.path
        - http.response.status_code

  - question: Does this activity align with scheduled software updates or maintenance?
    context: Legitimate configuration updates typically occur during planned maintenance windows.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - bytes_out
        - bytes_in
        - network.protocol

  # Type 3: Activity Context
  - question: What process initiated the Jadtre configuration file download?
    context: Identifying the parent process helps determine how the malware was executed.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid
        - ParentImage
        - ParentCommandLine

  - question: What network activity preceded this configuration file request?
    context: Prior connections may reveal initial infection vector or command and control communication.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.protocol
        - bytes_out
        - bytes_in

  - question: Are there signs of file system changes related to this configuration download?
    context: Successful config downloads often result in file creation or modification.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.extension: "cfg"
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessGuid

  # Type 4: Impact Assessment
  - question: Was the Jadtre configuration file successfully downloaded?
    context: Successful downloads enable malware functionality and indicate active infection.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
          http.response.status_code: 200
        condition: selection
      fields:
        - http.response.body.bytes
        - http.response.headers
        - url.full

  - question: What subsequent malware activity occurred after the configuration download?
    context: Config files often contain instructions for additional malware functionality.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - network.protocol

  # Type 5: Forensic Deep-Dive
  - question: What specific Jadtre malware variant characteristics are evident?
    context: Different Jadtre variants use distinct server paths and configuration file structures.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains: "/tool/mavatarcfg/"
        condition: selection
      fields:
        - url.full
        - http.request.method
        - user_agent.original
        - http.request.headers

  - question: Are there registry modifications associated with this Jadtre infection?
    context: Jadtre malware often modifies registry entries for persistence and configuration.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessGuid

  - question: What persistence mechanisms has the Jadtre malware established?
    context: Understanding persistence helps with complete malware removal and prevention.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - "\\Startup\\"
            - "\\Run\\"
            - ".exe"
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessGuid

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network showing similar Jadtre malware indicators?
    context: Malware campaigns often target multiple systems within an organization.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains: "/tool/mavatarcfg/"
        condition: selection
      fields:
        - src_ip
        - url.path
        - user_agent.original