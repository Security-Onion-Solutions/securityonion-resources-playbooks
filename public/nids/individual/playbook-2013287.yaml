name: ET MALWARE Papras Banking Trojan Checkin
id: 22013287
description: |
  Detects Papras banking trojan command and control communications via specific binary pattern in HTTP POST requests.
  This signature identifies malware checkin behavior with distinctive binary markers indicating credential theft activity.
type: detection
detection_id: 2013287
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete HTTP POST request containing the Papras binary signature?
    context: The specific binary pattern reveals the malware communication protocol and potential data exfiltration.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.body.content
        - http.request.method
        - url.full
        - http.request.headers

  - question: Is this system known to perform legitimate banking operations?
    context: Banking trojans target financial institutions and users, but some legitimate banking software may trigger similar patterns.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method: "POST"
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - http.request.body.bytes

  - question: What other HTTP activity occurred from this source around the same time?
    context: Banking trojans often perform multiple requests during infection cycles including configuration updates and data theft.
    range: -15m/+15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - url.full
        - http.request.method
        - http.response.status_code

  - question: What processes were running on the infected system during this communication?
    context: Identifying the parent process helps determine infection vector and persistence mechanisms.
    range: -30m/+30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - User

  - question: Has this destination been contacted by other internal systems?
    context: Banking trojans often use shared C2 infrastructure affecting multiple victims simultaneously.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - bytes_sent
        - bytes_received

  - question: What DNS queries were made to resolve the C2 domain?
    context: DNS resolution patterns reveal domain generation algorithms and infrastructure used by banking trojans.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  - question: What files were created or modified on the infected system?
    context: Banking trojans often create configuration files, keystroke logs, and credential databases.
    range: -1h/+1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size
        - ProcessName

  - question: Were any registry modifications made indicating persistence mechanisms?
    context: Banking trojans establish persistence through registry modifications for startup execution and configuration storage.
    range: -2h/+30m
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessName

  - question: What SSL certificates were observed for this C2 communication?
    context: Certificate analysis reveals infrastructure reuse and helps identify additional malicious domains.
    range: -15m/+15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - tls.server.certificate.subject
        - tls.server.certificate.issuer
        - tls.server.certificate.fingerprint_sha1

  - question: Are other systems in the network showing similar Papras banking trojan indicators?
    context: Banking trojans often spread through email campaigns affecting multiple users simultaneously.
    range: -24h/+2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Papras"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: What data volumes were transmitted during this C2 session?
    context: Large data transfers may indicate credential harvesting or stolen banking information exfiltration.
    range: -5m/+5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - bytes_sent
        - bytes_received
        - duration
        - dst_port