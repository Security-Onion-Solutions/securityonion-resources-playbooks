name: ET WEB_SPECIFIC_APPS Nuke Evolution Xtreme pid Parameter UNION SELECT SQL Injection Attempt
id: 22013305
description: |
  Detects SQL injection attempts targeting the Nuke Evolution Xtreme CMS via the pid parameter in the Tutorials module.
  This specific pattern indicates an attempt to execute UNION SELECT SQL commands to extract data from the database.
  May trigger on legitimate database operations if the application processes user input containing these SQL keywords.
type: detection
detection_id: 2013305
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete UNION SELECT payload in the pid parameter?
    context: Understanding the exact UNION SELECT statement reveals what data the attacker is attempting to extract.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - url.query
        - http.request.body.content

  - question: How many columns and what data types is the UNION SELECT attempting to match?
    context: UNION SELECT requires matching column counts and types, revealing database structure knowledge.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.query|contains: 'UNION'
        condition: selection
      fields:
        - url.query
        - url.full
        - http.request.method

  # Type 2: Triage Assessment
  - question: Is this server running Nuke Evolution Xtreme CMS with the Tutorials module?
    context: Confirming the vulnerable application and module helps validate the alert's accuracy.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains: '/modules.php'
          url.query|contains: 'name=Tutorials'
        condition: selection
      fields:
        - src_ip
        - url.path
        - url.query

  - question: Are there legitimate database queries or reports running on this system?
    context: Scheduled reports or data exports might generate similar SQL patterns in logs.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains: '/modules.php'
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.request.method

  # Type 3: Activity Context
  - question: What reconnaissance activity preceded this UNION SELECT attempt?
    context: Attackers typically probe for column counts and data types before crafting successful UNION queries.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.query|contains:
            - 'ORDER BY'
            - 'GROUP BY'
            - 'HAVING'
        condition: selection
      fields:
        - url.full
        - url.query
        - http.response.status_code

  - question: What was the progression of SQL injection attempts from this source?
    context: Understanding the attack sequence helps identify the attacker's methodology and skill level.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.query|contains:
            - 'SELECT'
            - 'UNION'
            - 'pid='
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.response.status_code

  # Type 4: Impact Assessment
  - question: Did the UNION SELECT query return data successfully?
    context: Successful data extraction is indicated by 200 responses with substantial content length.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes
        - http.response.body.content

  - question: What sensitive data might have been exposed through this UNION SELECT?
    context: Identifying potential data exposure helps determine breach notification requirements.
    range: +10m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains: '/modules.php'
        condition: selection
      fields:
        - http.response.body.content
        - http.response.body.bytes
        - url.full

  # Type 5: Forensic Deep-Dive
  - question: What database tables and columns are being targeted by the UNION SELECT?
    context: Specific table and column names reveal the attacker's knowledge of the database schema.
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.query|contains: 'UNION SELECT'
        condition: selection
      fields:
        - url.query
        - url.full
        - http.response.status_code

  - question: Are there attempts to extract user credentials or administrative data?
    context: Targeting user tables or admin accounts indicates potential account compromise attempts.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.query|contains:
            - 'password'
            - 'user'
            - 'admin'
            - 'hash'
        condition: selection
      fields:
        - url.query
        - url.full
        - http.response.body.bytes

  # Type 6: Enterprise Correlation
  - question: Are other systems experiencing similar UNION SELECT injection attempts?
    context: Coordinated attacks may target multiple vulnerable CMS installations across the organization.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.query|contains:
            - 'UNION SELECT'
            - 'modules.php'
        condition: selection
      fields:
        - dst_ip
        - url.path
        - url.query