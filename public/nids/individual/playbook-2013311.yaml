name: ET INFO HTTP Request to a *.dlinkddns.com domain
id: 22013311
description: |
  Detects HTTP requests to D-Link Dynamic DNS domains which may indicate compromised D-Link devices or malicious infrastructure.
  May be legitimate traffic from D-Link router management but often indicates botnet communication or compromised devices.
type: detection
detection_id: 2013311
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What specific dlinkddns.com subdomain was contacted?
    context: The subdomain reveals the specific device or service being accessed.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.headers.host
        - url.full
        - dns.question.name

  - question: What HTTP method and URI path was requested?
    context: The request details reveal the purpose and nature of the communication.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.path
        - url.query
        - user_agent.original

  # Type 2: Triage Assessment
  - question: Are there legitimate D-Link devices on this network segment?
    context: Authorized D-Link routers or devices may legitimately use dlinkddns.com services.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          user_agent.original|contains:
            - "D-Link"
            - "Router"
            - "DCS-"
        condition: selection
      fields:
        - user_agent.original
        - http.request.headers.host
        - dst_ip

  - question: Is this traffic occurring during normal business hours?
    context: Legitimate device management typically occurs during business hours while malicious traffic may be random.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - timestamp
        - src_ip
        - dst_ip

  # Type 3: Activity Context
  - question: What DNS resolution preceded this HTTP request?
    context: DNS queries reveal how the dlinkddns.com domain was resolved and timing patterns.
    range: -15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.question.name|endswith: ".dlinkddns.com"
        condition: selection
      fields:
        - dns.question.name
        - dns.resolved_ip
        - dns.response_code

  - question: What other network connections were established by this host?
    context: Concurrent connections may reveal broader communication patterns or malicious activity.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.protocol
        - network.bytes

  # Type 4: Impact Assessment
  - question: What data was transmitted in this HTTP session?
    context: Request and response sizes indicate the volume and type of data exchanged.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.headers.host|endswith: ".dlinkddns.com"
        condition: selection
      fields:
        - http.request.body.bytes
        - http.response.body.bytes
        - http.response.status_code

  - question: Are there signs of command and control communication patterns?
    context: Regular intervals or specific response codes may indicate C2 communication.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.headers.host|endswith: ".dlinkddns.com"
        condition: selection
      fields:
        - http.response.status_code
        - http.request.body.bytes
        - http.response.body.bytes

  # Type 5: Forensic Deep-Dive
  - question: What processes on the host initiated this network connection?
    context: Process information reveals if legitimate software or malware made the connection.
    range: -5m
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          ProcessName|contains:
            - "browser"
            - "wget"
            - "curl"
            - "powershell"
        condition: selection
      fields:
        - ProcessName
        - CommandLine
        - User
        - ProcessGuid

  - question: Are there indicators of device compromise or malware infection?
    context: Compromised devices may show unusual network patterns or unauthorized processes.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - "trojan-activity"
            - "malware-cnc"
        condition: selection
      fields:
        - rule.name
        - rule.category
        - dst_ip

  # Type 6: Enterprise Correlation
  - question: Are other hosts communicating with dlinkddns.com domains?
    context: Multiple infected devices may indicate a broader compromise or botnet activity.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          dns.question.name|endswith: ".dlinkddns.com"
        condition: selection
      fields:
        - src_ip
        - dns.question.name
        - dns.resolved_ip

  - question: Is this part of a larger suspicious network communication pattern?
    context: Coordinated activity across multiple hosts may indicate organized malicious activity.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "dlinkddns.com"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name