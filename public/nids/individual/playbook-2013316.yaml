name: ET MOBILE_MALWARE Android.AdSms Retrieving XML File from CnC Server
id: 22013316
description: |
  Detects Android.AdSms malware communicating with command and control servers via specific URI parameters.
  May trigger on legitimate applications using similar parameter structures for analytics or configuration.
type: detection
detection_id: 2013316
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What are the exact parameter values being transmitted to the CnC server?
    context: The specific parameter values reveal device information and malware configuration being exfiltrated.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - url.query
        - http.request.body.content

  - question: Is this a legitimate mobile application analytics request?
    context: Some legitimate mobile apps use similar parameter structures for device telemetry and analytics.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.domain|expand: '%url.domain%'
        condition: selection
      fields:
        - url.path
        - http.request.method
        - http.response.status_code
        - bytes_in

  - question: What mobile device or application initiated this connection?
    context: Understanding the source application helps determine if this is malware or legitimate software behavior.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 80
        condition: selection
      fields:
        - src_port
        - protocol
        - bytes_out
        - bytes_in

  - question: What other suspicious network activity originated from this device?
    context: Android.AdSms malware typically performs multiple malicious activities beyond CnC communication.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - protocol
        - bytes_out

  - question: Were any SMS or telephony-related connections made from this device?
    context: AdSms malware is designed to send premium SMS messages, which may generate additional network traffic.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.query.name|contains:
            - 'sms'
            - 'mobile'
            - 'carrier'
            - 'gateway'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  - question: What response was received from the CnC server?
    context: The server response may contain additional malware payloads or configuration updates.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - http.response.mime_type
        - bytes_in

  - question: Are there indicators of data exfiltration from this device?
    context: The malware may be stealing contact lists, SMS messages, or other sensitive device data.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          bytes_out|gte: 10000
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - protocol

  - question: What is the reputation and hosting details of the CnC server?
    context: Understanding the CnC infrastructure helps assess the threat level and potential attribution.
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          dns.resolved_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - src_ip

  - question: Are other devices in the network communicating with the same CnC server?
    context: Android.AdSms campaigns may target multiple devices within the same network environment.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'Android.AdSms'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.category
        - rule.severity

  - question: Have there been other mobile malware alerts from this source?
    context: Infected devices may harbor multiple malware families or show recurring malicious behavior patterns.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - 'mobile'
            - 'android'
            - 'malware'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.category
        - rule.severity

  - question: What SSL/TLS certificates are associated with the CnC infrastructure?
    context: Certificate details may reveal additional infrastructure or help track the malware campaign.
    range: +/-1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - tls.server.certificate.subject
        - tls.server.certificate.issuer
        - tls.server.certificate.serial_number
        - tls.server.certificate.not_after