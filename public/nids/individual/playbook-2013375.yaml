name: ET MALWARE W32/Nolja Trojan Downloader Initial Checkin
id: 22013375
description: |
  Detects W32/Nolja trojan downloader performing initial command and control checkin via specific PHP parameters.
  May trigger on legitimate applications using similar parameter structures for configuration or system identification.
type: detection
detection_id: 2013375
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What system information is being transmitted in the CnC checkin?
    context: The pid, bo_table, wr_id, and mac parameters contain system identification and configuration data.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - url.query
        - http.request.body.content

  - question: Is this a legitimate application performing system identification?
    context: Some legitimate software may use similar parameter structures for system registration or configuration.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains: 'info.php'
        condition: selection
      fields:
        - url.domain
        - http.response.status_code
        - bytes_in
        - http.request.referrer

  - question: What process initiated this trojan downloader communication?
    context: Understanding the parent process helps identify the infection vector and malware execution chain.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid

  - question: What other network connections occurred during the initial infection?
    context: Trojan downloaders typically perform multiple network operations during initial setup and payload retrieval.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - protocol
        - bytes_out
        - bytes_in

  - question: What response and payload were received from the CnC server?
    context: The server response may contain additional malware payloads or configuration instructions for the downloader.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - http.response.mime_type
        - bytes_in

  - question: Were any files downloaded or created after the initial checkin?
    context: Successful trojan downloader checkins typically result in additional malware downloads and file creation.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.hash.sha256
        - file.mime_type
        - ProcessName

  - question: Are there signs of additional malware execution after the download?
    context: Downloaded payloads may execute additional malware components or establish persistence mechanisms.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'temp'
            - 'appdata'
            - 'programdata'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ParentImage

  - question: What is the hosting infrastructure and reputation of the CnC server?
    context: Understanding the CnC infrastructure helps assess threat level and potential campaign attribution.
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          dns.resolved_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - src_ip

  - question: Has the trojan established persistence mechanisms on the system?
    context: W32/Nolja may create registry entries, scheduled tasks, or service installations for persistence.
    range: +/-2h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - 'Run'
            - 'RunOnce'
            - 'Services'
            - 'Winlogon'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessName

  - question: Are other systems in the network infected with W32/Nolja or similar trojans?
    context: Trojan downloader campaigns may target multiple systems within the same network environment.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'Nolja'
            - 'Trojan'
            - 'Downloader'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - rule.category

  - question: What additional network indicators suggest ongoing trojan activity?
    context: Active trojan infections may generate periodic CnC communications or additional download attempts.
    range: +24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains:
            - '.php'
            - '.exe'
            - '.bin'
        condition: selection
      fields:
        - dst_ip
        - url.path
        - http.response.status_code
        - bytes_in