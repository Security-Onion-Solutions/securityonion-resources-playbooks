name: ET MALWARE W32/FakeAlert Fake Security Tool Checkin
id: 22013386
description: |
  Detects W32/FakeAlert malware attempting to communicate with command and control servers.
  This fake security tool performs checkins using specific URI patterns to receive commands.
  Legitimate security software typically uses encrypted channels and different communication patterns.
type: detection
detection_id: 2013386
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete HTTP request URI that triggered this alert?
    context: Understanding the full URI pattern helps confirm the FakeAlert malware variant and communication protocol.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - url.path
        - url.query
        - http.request.headers

  - question: What HTTP headers were present in this malware communication?
    context: FakeAlert variants often use specific User-Agent strings and headers that distinguish them from legitimate traffic.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.request.headers.user_agent
        - http.request.headers.host
        - http.request.headers.accept
        - http.response.status_code

  # Type 2: Triage Assessment
  - question: Is this communication from a known administrative workstation?
    context: Legitimate security tools may be installed on admin systems, helping distinguish false positives from actual malware.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_sent
        - bytes_received

  - question: Has this source IP shown legitimate business application traffic recently?
    context: Systems with only malware traffic patterns are more likely to be compromised than mixed-use systems.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.domain
        - http.request.method
        - http.response.status_code

  # Type 3: Activity Context
  - question: What process initiated this HTTP connection?
    context: Identifying the parent process helps determine if this is malware execution or legitimate software behavior.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ParentImage
        - ProcessGuid

  - question: What other network connections occurred from this host around the same time?
    context: FakeAlert malware often makes multiple C2 connections and may download additional payloads.
    range: +/-15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - protocol
        - bytes_sent
        - bytes_received

  # Type 4: Impact Assessment
  - question: Did the C2 server respond with commands or payload data?
    context: Successful C2 communication indicates active malware that may have received instructions or updates.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes
        - http.response.headers.content_type
        - bytes_received

  - question: Are there signs of file system changes indicating malware persistence?
    context: FakeAlert variants often create registry entries and files to maintain persistence on infected systems.
    range: +/-30m
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.hash.sha256
        - User

  # Type 5: Forensic Deep-Dive
  - question: What is the reputation and hosting details of the C2 server?
    context: FakeAlert C2 servers are typically hosted on compromised or bulletproof hosting infrastructure.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          dns.resolved_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.resolved_ip

  - question: Are there registry modifications consistent with FakeAlert installation?
    context: This malware family creates specific registry entries for persistence and configuration storage.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetObject
        - Details
        - User
        - Image

  # Type 6: Enterprise Correlation
  - question: Are other hosts in the network showing similar FakeAlert communication patterns?
    context: FakeAlert campaigns often target multiple systems simultaneously through email or drive-by downloads.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          url.path|contains: "==/count.htm"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - url.full
        - http.request.method

  - question: Is this part of a broader malware campaign affecting the organization?
    context: Understanding campaign scope helps determine incident response priorities and containment needs.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "FakeAlert"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - rule.category