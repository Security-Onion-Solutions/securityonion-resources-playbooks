name: ET MALWARE W32/Skintrim CnC Checkin
id: 22013396
description: |
  Detects W32/Skintrim malware performing command and control checkins with specific URI parameters.
  This malware family uses distinctive parameter patterns including platform, machine hash, and executable information.
  Legitimate software typically does not use these specific parameter combinations.
type: detection
detection_id: 2013396
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What were the complete URI parameters sent in this Skintrim checkin?
    context: The specific parameter values reveal system information being exfiltrated and help identify the malware variant.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - url.path
        - url.query
        - http.request.body.content

  - question: What system information is being transmitted in the platform and hash parameters?
    context: Skintrim sends machine-specific identifiers that help track individual infections and system characteristics.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - url.query
        - http.request.headers.user_agent
        - http.response.status_code
        - http.response.body.bytes

  # Type 2: Triage Assessment
  - question: Is this communication from a system with legitimate business applications?
    context: Distinguishing between infected systems and legitimate software helps prioritize incident response efforts.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.domain
        - http.request.method
        - http.response.status_code
        - bytes_sent

  - question: Has this source IP shown normal user activity patterns recently?
    context: Systems with regular user activity are less likely to be dedicated malware hosts.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - User
        - CommandLine
        - ProcessGuid

  # Type 3: Activity Context
  - question: What process initiated this Skintrim communication?
    context: Identifying the parent process helps understand the infection vector and execution context.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - User
        - ProcessGuid

  - question: What other network activity occurred around this C2 communication?
    context: Skintrim often performs additional network operations like downloading updates or exfiltrating data.
    range: +/-15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - protocol
        - bytes_sent
        - bytes_received

  # Type 4: Impact Assessment
  - question: Did the C2 server provide commands or payload responses?
    context: Successful C2 responses indicate active malware control and potential for additional malicious activities.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes
        - http.response.headers.content_type
        - bytes_received

  - question: Are there signs of data exfiltration or additional payload downloads?
    context: Skintrim variants may download additional modules or exfiltrate sensitive information beyond basic checkins.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          bytes_sent|gte: 1024
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_sent
        - bytes_received
        - protocol

  # Type 5: Forensic Deep-Dive
  - question: What is the infrastructure profile of the Skintrim C2 server?
    context: Understanding C2 hosting patterns helps attribute the campaign and identify related infrastructure.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          dns.resolved_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.resolved_ip

  - question: What files were created or modified during the Skintrim infection timeframe?
    context: Identifying malware artifacts helps with forensic analysis and system remediation efforts.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.hash.sha256
        - User
        - Image

  # Type 6: Enterprise Correlation
  - question: Are other systems showing similar Skintrim infection indicators?
    context: Skintrim campaigns often affect multiple systems through common infection vectors like email or web exploits.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          url.path|contains: "/binaries/bin.php"
          url.query|contains: "plateform="
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - url.full
        - http.request.method

  - question: Is this part of a coordinated malware campaign across the organization?
    context: Understanding campaign scope helps determine the extent of compromise and response requirements.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Skintrim"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - rule.category