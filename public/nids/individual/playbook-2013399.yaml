name: ET MALWARE Backdoor.Win32/Momibot Ping Checkin
id: 22013399
description: |
  Detects Momibot backdoor trojan ping/keepalive communications via specific base64-encoded payload in HTTP POST requests.
  This signature identifies malware heartbeat behavior indicating active command and control communication.
type: detection
detection_id: 2013399
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the specific base64-encoded ping payload transmitted to the C2 server?
    context: The encoded ping content reveals the malware's keepalive mechanism and communication protocol structure.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.body.content
        - url.full
        - http.request.method
        - http.request.headers

  - question: Is this regular keepalive traffic or part of a broader malware campaign?
    context: Ping checkins occur regularly in infected systems, requiring analysis of frequency and timing patterns.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path: "/index.php"
        condition: selection
      fields:
        - http.request.method
        - http.response.status_code

  - question: What other Momibot-related activity occurred around this ping checkin?
    context: Ping checkins often precede or follow command execution, data exfiltration, or configuration updates.
    range: -1h/+1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - url.full
        - http.request.method
        - http.request.body.bytes
        - http.response.status_code

  - question: What process initiated this backdoor ping communication?
    context: Identifying the parent process helps determine malware persistence and execution context.
    range: -10m/+10m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid
        - User

  - question: Are multiple systems pinging the same C2 infrastructure?
    context: Backdoor campaigns typically affect multiple victims simultaneously through shared command and control servers.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - bytes_sent
        - bytes_received

  - question: What DNS queries were made to resolve the C2 domain before pinging?
    context: DNS resolution patterns reveal the infrastructure used for Momibot command and control operations.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  - question: What system changes occurred that might have triggered this ping?
    context: Backdoor pings may be triggered by system events, user activity, or scheduled tasks.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - ProcessName
        - file.hash.md5

  - question: Were any registry modifications made around the time of this ping?
    context: Registry changes may indicate configuration updates or persistence modifications following C2 communication.
    range: -15m/+15m
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessName

  - question: What response did the C2 server provide to this ping checkin?
    context: Server responses to pings may contain commands, configuration updates, or instructions for the backdoor.
    range: -1m/+1m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path: "/index.php"
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes
        - http.response.headers.content_type

  - question: Are there other Momibot variants or related malware families active?
    context: Multiple malware families may share infrastructure or be part of the same campaign.
    range: -12h/+2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - "Momibot"
            - "backdoor"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: What is the frequency pattern of these ping checkins?
    context: Regular ping intervals help distinguish automated malware behavior from legitimate application traffic.
    range: -6h/+1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.request.method: "POST"
        condition: selection
      fields:
        - url.path
        - http.request.body.bytes