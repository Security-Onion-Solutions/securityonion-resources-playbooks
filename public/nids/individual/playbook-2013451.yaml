name: ET MALWARE NgrBot IRC CnC Channel Join
id: 22013451
description: |
  Detects NgrBot malware attempting to join IRC command and control channels.
  This signature identifies the characteristic authentication pattern used by NgrBot.
  May trigger on legitimate IRC clients using similar authentication sequences.
type: detection
detection_id: 2013451
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete IRC authentication sequence containing the NgrBot signature?
    context: The full IRC handshake reveals the bot's configuration and C2 server details.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - irc.command
        - irc.params
        - irc.nick

  - question: What IRC server and channel was the bot attempting to connect to?
    context: Identifying the C2 infrastructure helps map the botnet's command structure and scope.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - irc.channel

  # Type 2: Triage Assessment
  - question: Is this system authorized to use IRC for business purposes?
    context: Legitimate IRC usage is rare in corporate environments, making this likely malicious.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 6667
            - 6668
            - 6669
            - 194
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.protocol

  - question: Does the user account have legitimate reasons to access IRC services?
    context: Understanding user context helps determine if this represents unauthorized malware activity.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine

  # Type 3: Activity Context
  - question: What process initiated the IRC connection on the infected system?
    context: Identifying the malware executable helps understand the infection vector and persistence mechanisms.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'irc'
            - '6667'
            - 'PASS'
            - 'NICK'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ProcessGuid
        - ParentImage

  - question: What other network connections were established around the time of IRC activity?
    context: NgrBot may establish additional connections for data exfiltration or payload downloads.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.protocol
        - network.bytes_sent

  - question: Were there any file downloads or modifications preceding the IRC connection?
    context: Understanding the infection timeline helps identify the initial compromise vector.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.mime_type

  # Type 4: Impact Assessment
  - question: Has the bot successfully joined the IRC channel and received commands?
    context: Successful C2 communication indicates active botnet participation and potential for remote control.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port|expand: '%dst_port%'
        condition: selection
      fields:
        - network.bytes_received
        - network.bytes_sent
        - network.duration

  - question: Are there signs of data exfiltration or additional malware downloads?
    context: NgrBot is known for information stealing capabilities and may download additional payloads.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.response.status_code
        - network.bytes_received

  # Type 5: Forensic Deep-Dive
  - question: What specific NgrBot variant and configuration is present on the system?
    context: Different NgrBot variants have varying capabilities and persistence mechanisms.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - '.exe'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.hash.sha256
        - file.size

  - question: What persistence mechanisms has the malware established?
    context: Understanding persistence helps ensure complete malware removal and prevents reinfection.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - 'Run'
            - 'RunOnce'
            - 'Services'
        condition: selection
      fields:
        - TargetObject
        - Details

  - question: Has the malware attempted to steal credentials or sensitive information?
    context: NgrBot has information stealing capabilities including password harvesting and keylogging.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - 'password'
            - 'credential'
            - 'login'
            - '.log'
        condition: selection
      fields:
        - TargetFilename
        - file.size

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network showing similar NgrBot IRC activity?
    context: Botnet infections often spread laterally or arrive via mass distribution campaigns.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: 'ET MALWARE NgrBot IRC CnC Channel Join'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - irc.nick

  - question: Is this part of a broader malware campaign affecting multiple IRC C2 servers?
    context: Understanding campaign scope helps identify the full botnet infrastructure and attribution.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_port|contains:
            - 6667
            - 6668
            - 6669
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port