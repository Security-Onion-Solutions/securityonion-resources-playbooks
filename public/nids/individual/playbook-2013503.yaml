name: ET INFO OS X Software Update Request Outbound
id: 22013503
description: |
  Detects macOS software update requests to Apple servers via Software Update user agent.
  This is typically legitimate system maintenance but may indicate policy violations or unauthorized systems.
type: detection
detection_id: 2013503
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What specific macOS version and build is requesting software updates?
    context: User agent analysis reveals system version and helps identify unauthorized or unmanaged devices.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.user_agent
        - url.full
        - http.request.method

  - question: What Apple software update servers are being contacted?
    context: Destination analysis confirms legitimate Apple infrastructure versus potential malicious redirects.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - url.path

  - question: Is this macOS system part of authorized corporate infrastructure?
    context: Identifying managed versus unmanaged systems helps assess policy compliance and security posture.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - http.user_agent
        - url.domain
        - dst_ip

  - question: What other network activity is associated with this macOS system?
    context: Additional traffic patterns help identify system usage and potential security concerns.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.protocol
        - network.bytes_sent

  - question: What is the timing pattern of software update requests from this system?
    context: Update frequency and timing reveal system management practices and automation patterns.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "Software Update"
        condition: selection
      fields:
        - dst_ip
        - http.user_agent

  - question: Are software updates being successfully downloaded and installed?
    context: Response analysis and data transfer volumes indicate successful update completion.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.domain|contains: "apple.com"
        condition: selection
      fields:
        - http.response.status_code
        - network.bytes_received
        - url.path

  - question: What DNS queries are associated with Apple software update infrastructure?
    context: DNS resolution patterns confirm legitimate Apple services versus potential DNS hijacking.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.query.name|contains: "apple.com"
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  - question: Are there any SSL certificate anomalies in the update connections?
    context: Certificate validation ensures connections are to legitimate Apple servers and not intercepted.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - tls.server.certificate.subject
        - tls.server.certificate.issuer
        - tls.server.certificate.serial_number

  - question: What other Apple services are accessed from this system?
    context: Comprehensive Apple service usage reveals system integration and potential policy violations.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.domain|contains: "apple.com"
        condition: selection
      fields:
        - url.domain
        - url.path
        - http.user_agent

  - question: Are other systems showing similar macOS software update activity?
    context: Enterprise-wide macOS usage patterns help identify unauthorized systems and policy compliance.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "OS X Software Update"
        condition: selection
      fields:
        - src_ip
        - http.user_agent
        - dst_ip

  - question: What related Apple ecosystem IOCs appear across the organization?
    context: Comprehensive Apple service usage reveals organizational technology footprint and compliance status.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          url.domain|contains: "apple.com"
        condition: selection
      fields:
        - src_ip
        - url.domain
        - http.user_agent