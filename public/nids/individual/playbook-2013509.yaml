name: ET MALWARE W32/Lalus Trojan Downloader Checkin
id: 22013509
description: |
  Detects W32/Lalus trojan downloader communication with command and control servers.
  Identifies specific URI parameter patterns used for victim identification and update requests.
  Legitimate applications rarely use this exact combination of parameters.
type: detection
detection_id: 2013509
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete URI path and parameter values in the malicious request?
    context: The exact URI reveals victim identification data and trojan configuration details.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - url.path
        - url.query

  - question: What user agent and HTTP headers were used in the malicious communication?
    context: Headers provide insight into the trojan's communication method and potential evasion techniques.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.request.headers
        - http.request.user_agent
        - http.response.status_code

  # Type 2: Triage Assessment
  - question: Is this communication pattern normal for applications on this host?
    context: Establishes baseline behavior to distinguish malicious from legitimate traffic.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method: GET
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - http.request.user_agent

  - question: Has this host made similar requests to other external domains recently?
    context: Multiple similar requests may indicate broader trojan infection or campaign.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.query|contains:
            - "guid="
            - "&h="
            - "&v="
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - url.path

  # Type 3: Activity Context
  - question: What process initiated this HTTP communication?
    context: Identifies the specific malware executable and its execution context.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ParentImage

  - question: What network connections were established around the time of this alert?
    context: Reveals additional C2 infrastructure and communication patterns.
    range: +/-30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 80
            - 443
            - 8080
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection.state
        - network.bytes_sent

  # Type 4: Impact Assessment
  - question: What files were downloaded or created after this C2 communication?
    context: Determines if the trojan successfully downloaded additional payloads.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.extension|contains:
            - exe
            - dll
            - scr
            - bat
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size
        - User

  - question: Were any registry modifications made following this communication?
    context: Identifies persistence mechanisms and system modifications.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - Run
            - RunOnce
            - Startup
        condition: selection
      fields:
        - TargetObject
        - Details
        - User

  # Type 5: Forensic Deep-Dive
  - question: What specific variant of Lalus trojan is indicated by the parameter structure?
    context: Parameter analysis helps identify the exact malware family and capabilities.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Lalus"
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - rule.name
        - http.request.body.content
        - url.query

  - question: What DNS queries preceded this HTTP communication?
    context: Reveals domain resolution patterns and potential DGA activity.
    range: -5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.query.name|expand: '%url.domain%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  # Type 6: Enterprise Correlation
  - question: Are other hosts in the network showing similar Lalus trojan activity?
    context: Determines campaign scope and identifies additional compromised systems.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Lalus"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: What other malware families are active on this network segment?
    context: Identifies coordinated attack campaigns and threat actor patterns.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|contains: '%src_ip%'
          rule.category|contains: "malware"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.category