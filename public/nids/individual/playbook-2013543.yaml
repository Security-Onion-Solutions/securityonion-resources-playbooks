name: ET MALWARE W32/iGrabber Info Stealer FTP Upload
id: 22013543
description: |
  Detects iGrabber information stealer malware uploading stolen data via FTP.
  This signature identifies the characteristic "iGrabber Logs" identifier in FTP traffic.
  May trigger on legitimate applications with similar naming conventions for log files.
type: detection
detection_id: 2013543
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete FTP command containing the iGrabber Logs identifier?
    context: The full FTP command reveals the malware's data exfiltration method and file structure.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - ftp.command
        - ftp.command_arg
        - ftp.data_channel

  - question: What specific files or data were being uploaded to the FTP server?
    context: Understanding the exfiltrated data helps assess the scope and impact of the information theft.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - ftp.filename
        - ftp.file_size
        - ftp.transfer_type

  # Type 2: Triage Assessment
  - question: Is this system authorized to upload files to external FTP servers?
    context: Legitimate FTP uploads are uncommon in most corporate environments, making this likely malicious.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: ftp
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          ftp.command: 'STOR'
        condition: selection
      fields:
        - dst_ip
        - ftp.filename
        - ftp.user

  - question: Does the user account have legitimate business reasons for FTP file transfers?
    context: Understanding user context helps determine if this represents unauthorized data exfiltration.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine

  # Type 3: Activity Context
  - question: What process initiated the FTP upload containing iGrabber logs?
    context: Identifying the malware executable helps understand the infection vector and system compromise.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'ftp'
            - 'upload'
            - 'STOR'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ProcessGuid
        - ParentImage

  - question: What data collection activities occurred before the FTP upload?
    context: iGrabber typically harvests information from browsers, applications, and system files before exfiltration.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - 'password'
            - 'cookie'
            - 'credential'
            - 'browser'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size

  - question: Were there any authentication attempts to establish the FTP connection?
    context: Understanding the FTP authentication reveals the attacker's infrastructure and access methods.
    range: -10m
    query: |
      aggregation: false
      logsource:
        category: network
        service: ftp
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          ftp.command|contains:
            - 'USER'
            - 'PASS'
        condition: selection
      fields:
        - ftp.user
        - ftp.password
        - ftp.response_code

  # Type 4: Impact Assessment
  - question: How much data was successfully uploaded to the attacker's FTP server?
    context: Quantifying the data exfiltration helps assess the breach impact and regulatory requirements.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: ftp
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          ftp.command: 'STOR'
        condition: selection
      fields:
        - ftp.filename
        - ftp.file_size
        - ftp.response_code

  - question: What types of sensitive information were potentially compromised?
    context: iGrabber targets various data types including passwords, certificates, and personal information.
    range: -3h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - '.pfx'
            - '.p12'
            - 'wallet'
            - 'keystore'
        condition: selection
      fields:
        - TargetFilename
        - file.mime_type
        - file.size

  # Type 5: Forensic Deep-Dive
  - question: What specific iGrabber variant and configuration is present on the system?
    context: Different iGrabber versions have varying data collection capabilities and evasion techniques.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - 'grabber'
            - 'stealer'
            - '.exe'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.hash.sha256
        - file.size

  - question: What persistence mechanisms has the malware established for continued data theft?
    context: Understanding persistence helps ensure complete removal and prevents ongoing data exfiltration.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - 'Run'
            - 'RunOnce'
            - 'StartupApproved'
        condition: selection
      fields:
        - TargetObject
        - Details

  - question: Are there indicators of additional malware families or C2 communications?
    context: iGrabber infections may be part of larger malware campaigns with multiple payloads.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.protocol
        - network.bytes_sent

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network showing similar iGrabber FTP upload activity?
    context: Information stealers often spread through email campaigns or exploit kits affecting multiple users.
    range: -12h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: 'ET MALWARE W32/iGrabber Info Stealer FTP Upload'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - ftp.filename

  - question: Is this part of a coordinated data theft campaign targeting the organization?
    context: Understanding campaign scope helps identify the attack's breadth and potential insider threats.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: ftp
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          ftp.command: 'STOR'
        condition: selection
      fields:
        - src_ip
        - ftp.user
        - ftp.filename