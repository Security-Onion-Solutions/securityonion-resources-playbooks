name: ET MALWARE W32/Gagolino Banking Trojan Reporting to CnC
id: 22013546
description: |
  Detects W32/Gagolino banking trojan communication with command and control servers.
  Identifies specific parameter patterns used to exfiltrate system information including MAC address, computer name, and Windows version.
  Legitimate applications do not typically send this combination of system identifiers.
type: detection
detection_id: 2013546
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What system information was exfiltrated in the malicious request?
    context: The URI parameters reveal specific victim system details being sent to attackers.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - url.query
        - http.request.body.content

  - question: What was the complete HTTP transaction including response from the C2 server?
    context: Server response may contain commands or additional payloads for the banking trojan.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - http.response.headers
        - network.bytes_received

  # Type 2: Triage Assessment
  - question: Is this host authorized to send system information to external servers?
    context: Determines if this could be legitimate system management or monitoring software.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.query|contains:
            - "macaddress="
            - "pcname="
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - http.request.user_agent

  - question: Does this communication align with scheduled business processes?
    context: Banking trojans typically communicate outside business hours to avoid detection.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - connection.state
        - network.bytes_sent
        - network.bytes_received

  # Type 3: Activity Context
  - question: What process initiated this banking trojan communication?
    context: Identifies the malware executable and its execution method.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid

  - question: What network activity preceded this C2 communication?
    context: Reveals initial infection vector and communication establishment.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection.state
        - network.protocol

  - question: Were there any file downloads or modifications around this time?
    context: Banking trojans often download additional modules or configuration updates.
    range: +/-30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size
        - User

  # Type 4: Impact Assessment
  - question: What banking or financial applications are installed on this system?
    context: Determines potential targets for the banking trojan's credential theft capabilities.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - bank
            - finance
            - trading
            - wallet
        condition: selection
      fields:
        - Image
        - User
        - CommandLine

  - question: Has this system accessed banking websites recently?
    context: Identifies potential credential theft targets and timing of malicious activity.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.domain|contains:
            - bank
            - credit
            - paypal
            - finance
        condition: selection
      fields:
        - url.domain
        - url.path
        - http.request.user_agent

  # Type 5: Forensic Deep-Dive
  - question: What specific Gagolino variant is indicated by the parameter structure?
    context: Parameter analysis helps identify trojan capabilities and target geography.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Gagolino"
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - rule.name
        - url.query
        - dst_ip

  - question: What registry modifications indicate banking trojan persistence?
    context: Identifies how the malware maintains persistence and hooks into system processes.
    range: +/-2h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - Run
            - Winlogon
            - Browser
        condition: selection
      fields:
        - TargetObject
        - Details
        - User

  # Type 6: Enterprise Correlation
  - question: Are other systems showing similar banking trojan activity?
    context: Determines campaign scope and identifies additional compromised endpoints.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Gagolino"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: What other financial malware is active in the environment?
    context: Identifies coordinated financial crime campaigns and threat actor patterns.
    range: +/-7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - "Banking"
            - "Financial"
            - "Credential"
        condition: selection
      fields:
        - rule.name
        - src_ip
        - dst_ip