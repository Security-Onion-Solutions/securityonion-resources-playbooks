name: ET WEB_SPECIFIC_APPS University Of Vermont intro Parameter Remote File inclusion Attempt
id: 22013569
description: |
  Detects remote file inclusion attempts targeting the University of Vermont magicscript.php intro parameter.
  Attackers attempt to include remote files using HTTP, HTTPS, FTP, or PHP protocols.
  Legitimate usage would not include remote URLs in the intro parameter.
type: detection
detection_id: 2013569
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete remote file inclusion payload in the intro parameter?
    context: Analyzing the full RFI payload reveals the attacker's target file and exploitation method.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - url.query
        - http.request.body.content

  - question: What remote server and file was the attacker attempting to include?
    context: Understanding the remote resource helps identify the malicious payload and attacker infrastructure.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.query|contains: "intro="
        condition: selection
      fields:
        - url.query
        - url.path

  # Type 2: Triage Assessment
  - question: Is this a legitimate user of the University of Vermont web application?
    context: Determines if this could be authorized usage or confirmed remote file inclusion attack.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains: "magicscript.php"
        condition: selection
      fields:
        - url.query
        - http.request.method
        - http.response.status_code

  - question: Has this source IP made other legitimate requests to the target server?
    context: Establishes baseline behavior to differentiate between legitimate users and attackers.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.request.method
        - bytes_out
        - bytes_in

  # Type 3: Activity Context
  - question: What other remote file inclusion attempts has this attacker made?
    context: Understanding the attack pattern helps identify the scope of the web application testing.
    range: +/-2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.query|contains:
            - "http://"
            - "https://"
            - "ftp://"
            - "php://"
        condition: selection
      fields:
        - url.full
        - url.query
        - dst_ip

  - question: What was the sequence of requests leading up to this inclusion attempt?
    context: Understanding the attack progression reveals reconnaissance and exploitation phases.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - url.query
        - http.response.status_code

  - question: Did the attacker attempt to access the remote malicious file?
    context: Determines if the attacker successfully triggered the remote file inclusion vulnerability.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - bytes_in

  # Type 4: Impact Assessment
  - question: What was the web server's response to the remote file inclusion attempt?
    context: Server response reveals if the inclusion was successful and what content was returned.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - bytes_in

  - question: Are there signs of successful remote code execution?
    context: Determines if the RFI attempt led to successful code execution on the target server.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.request.method
        - bytes_in

  # Type 5: Forensic Deep-Dive
  - question: What web application vulnerabilities is the attacker systematically testing?
    context: Understanding the attack methodology helps identify other potential vulnerabilities.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.query|contains:
            - "Page="
            - "intro="
            - "include="
            - "file="
        condition: selection
      fields:
        - url.query
        - url.path
        - dst_ip

  - question: What automated tools or scripts is the attacker using for web application testing?
    context: User-Agent and request patterns reveal if this is manual testing or automated exploitation.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - http.request.headers.user_agent
        - http.request.method
        - url.path

  - question: What malicious payloads were hosted on the remote server?
    context: Analyzing the remote server content helps understand the attacker's intended payload.
    range: +/-30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - http.response.body.content
        - bytes_in
        - url.path

  # Type 6: Enterprise Correlation
  - question: Are other web applications in the environment being targeted with similar RFI attacks?
    context: Identifies if this is part of a broader campaign against the organization's web infrastructure.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.query|contains:
            - "http://"
            - "https://"
            - "ftp://"
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - url.path