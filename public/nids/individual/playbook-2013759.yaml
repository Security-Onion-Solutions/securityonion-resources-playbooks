name: ET WEB_SPECIFIC_APPS Mambo AHS Shop component SELECT FROM SQL Injection Attempt
id: 22013759
description: |
  Detects SQL injection attempts targeting the Mambo AHS Shop component through the flokkur parameter with SELECT statements.
  This attack attempts to extract data from the database, potentially exposing sensitive information like user credentials.
  Legitimate use of the AHS Shop component should not contain SQL SELECT statements in URL parameters.
type: detection
detection_id: 2013759
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the exact SQL SELECT payload injected through the flokkur parameter?
    context: Understanding the specific SQL injection reveals which database tables or columns the attacker targeted for data extraction.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - url.path
        - url.query
        - http.request.body.content

  - question: Is this a legitimate database query from an authorized administrator?
    context: Authorized users may access the AHS Shop component, but SQL statements in URL parameters indicate malicious intent.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.query|contains: "option=com_ahsshop"
        condition: selection
      fields:
        - http.request.method
        - url.path
        - url.query
        - http.response.status_code

  - question: Did the SQL SELECT injection successfully extract database information?
    context: HTTP response size and content indicate if sensitive data was returned from the database query.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - http.response.mime_type
        - network.bytes_received

  - question: What other SQL injection techniques is this attacker using for data extraction?
    context: SELECT injections are often combined with UNION operations and other techniques for comprehensive data extraction.
    range: +/-2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.query|contains:
            - "UNION"
            - "SELECT"
            - "ORDER BY"
            - "GROUP BY"
            - "HAVING"
        condition: selection
      fields:
        - url.full
        - url.path
        - url.query
        - http.response.status_code

  - question: Which database tables or sensitive data was the attacker targeting?
    context: Understanding extraction targets reveals the type of sensitive information at risk of compromise.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.query|contains:
            - "users"
            - "password"
            - "email"
            - "admin"
            - "credit"
            - "payment"
        condition: selection
      fields:
        - url.full
        - url.query
        - http.request.method
        - http.response.status_code

  - question: Has the attacker successfully enumerated the database structure?
    context: Successful SELECT injections often lead to database schema enumeration and systematic data extraction.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.query|contains:
            - "information_schema"
            - "table_name"
            - "column_name"
            - "database()"
            - "version()"
        condition: selection
      fields:
        - url.full
        - url.query
        - http.response.status_code
        - network.bytes_received

  - question: Are there signs of systematic data exfiltration following the injection?
    context: After successful SELECT injections, attackers often extract large amounts of data in subsequent requests.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.request.method
        - network.bytes_received
        - http.response.status_code

  - question: What credentials or authentication data was potentially compromised?
    context: SELECT injections targeting user tables may expose passwords, session tokens, or other authentication data.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.query|contains:
            - "password"
            - "hash"
            - "token"
            - "session"
            - "cookie"
        condition: selection
      fields:
        - url.full
        - url.query
        - http.response.status_code
        - network.bytes_received

  - question: What is the scope of this SQL injection reconnaissance campaign?
    context: Multiple SELECT operations indicate systematic database exploration and potential large-scale data theft.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category: "web-application-attack"
          rule.name|contains: "SQL"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.category

  - question: Has this Mambo installation been patched against known data extraction vulnerabilities?
    context: Vulnerable Mambo installations allow attackers to extract sensitive data through various SQL injection techniques.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains: "index.php"
          url.query|contains: "option=com_"
        condition: selection
      fields:
        - src_ip
        - url.query
        - http.response.status_code
        - http.request.method

  - question: Are other organizations experiencing similar Mambo AHS Shop data extraction attacks?
    context: Coordinated SELECT injection attacks may indicate automated tools targeting vulnerable Mambo installations.
    range: +/-6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Mambo AHS Shop"
          rule.name|contains: "SELECT"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name