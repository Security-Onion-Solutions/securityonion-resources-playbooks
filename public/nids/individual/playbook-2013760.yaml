name: ET WEB_SPECIFIC_APPS Mambo AHS Shop component DELETE FROM SQL Injection Attempt
id: 22013760
description: |
  Detects SQL injection attempts targeting the Mambo AHS Shop component through the flokkur parameter with DELETE statements.
  This attack attempts to delete data from the database, potentially causing data loss or removing security controls.
  Legitimate use of the AHS Shop component should not contain SQL DELETE statements in URL parameters.
type: detection
detection_id: 2013760
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the exact SQL DELETE payload injected through the flokkur parameter?
    context: Understanding the specific SQL injection reveals which database tables or records the attacker targeted for deletion.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - url.path
        - url.query
        - http.request.body.content

  - question: Is this a legitimate administrative maintenance request to the Mambo system?
    context: Authorized administrators may perform database maintenance, but SQL statements in URL parameters indicate malicious intent.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.query|contains: "option=com_ahsshop"
        condition: selection
      fields:
        - http.request.method
        - url.path
        - url.query
        - http.response.status_code

  - question: Did the SQL DELETE injection execute successfully against the database?
    context: HTTP response codes and content indicate if data deletion occurred and database integrity was compromised.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - http.response.mime_type
        - network.bytes_received

  - question: What other destructive SQL operations is this attacker attempting?
    context: DELETE injections are often combined with other SQL operations for comprehensive database manipulation.
    range: +/-2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.query|contains:
            - "DROP"
            - "TRUNCATE"
            - "ALTER"
            - "UPDATE"
            - "DELETE"
        condition: selection
      fields:
        - url.full
        - url.path
        - url.query
        - http.response.status_code

  - question: Which database tables or records were targeted for deletion?
    context: Understanding deletion targets reveals attacker intent to remove evidence, disable security, or cause data loss.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.query|contains:
            - "FROM"
            - "WHERE"
            - "users"
            - "admin"
            - "logs"
            - "security"
        condition: selection
      fields:
        - url.full
        - url.query
        - http.request.method
        - http.response.status_code

  - question: Has the attacker successfully compromised database integrity or removed security controls?
    context: Successful DELETE injections may result in disabled security features or removed audit trails.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains:
            - "admin"
            - "login"
            - "security"
            - "config"
        condition: selection
      fields:
        - url.full
        - url.path
        - http.request.method
        - http.response.status_code

  - question: Are there signs of data recovery attempts or backup access?
    context: After destructive SQL operations, attackers may attempt to access backups or recovery systems.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.query|contains:
            - "backup"
            - "restore"
            - "recovery"
            - "dump"
            - "export"
        condition: selection
      fields:
        - url.full
        - url.query
        - http.response.status_code
        - network.bytes_received

  - question: What is the scope of database damage from this SQL injection campaign?
    context: Multiple DELETE operations may indicate systematic database destruction or evidence removal.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category: "web-application-attack"
          rule.name|contains: "SQL"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.category

  - question: Has this Mambo installation been secured against known SQL injection vulnerabilities?
    context: Unpatched Mambo installations are vulnerable to various SQL injection techniques including DELETE operations.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains: "index.php"
          url.query|contains: "option=com_"
        condition: selection
      fields:
        - src_ip
        - url.query
        - http.response.status_code
        - http.request.method

  - question: Are other organizations experiencing similar Mambo AHS Shop DELETE injection attacks?
    context: Coordinated attacks against vulnerable Mambo installations may indicate automated exploitation tools.
    range: +/-6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Mambo AHS Shop"
          rule.name|contains: "DELETE"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: What was the attack progression from reconnaissance to destructive SQL operations?
    context: Understanding the full attack timeline helps assess the extent of database compromise and data loss.
    range: +/-8h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.category: "web-application-attack"
        condition: selection
      fields:
        - rule.name
        - url.path
        - url.query