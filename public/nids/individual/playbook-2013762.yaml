name: ET WEB_SPECIFIC_APPS Mambo AHS Shop component INSERT INTO SQL Injection Attempt
id: 22013762
description: |
  Detects SQL injection attempts targeting the Mambo AHS Shop component through the flokkur parameter.
  This attack attempts to insert malicious data into the database, potentially creating backdoor accounts or corrupting data.
  Legitimate use of the AHS Shop component should not contain SQL INSERT statements in URL parameters.
type: detection
detection_id: 2013762
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the exact SQL INSERT payload injected through the flokkur parameter?
    context: Understanding the specific SQL injection reveals the attacker's database manipulation intent and target tables.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - url.path
        - url.query
        - http.request.body.content

  - question: Is this a legitimate administrative request to the Mambo AHS Shop component?
    context: Authorized administrators may access the component, but SQL statements in URL parameters indicate malicious intent.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.query|contains: "option=com_ahsshop"
        condition: selection
      fields:
        - http.request.method
        - url.path
        - url.query
        - http.response.status_code

  - question: What was the database response to this SQL injection attempt?
    context: HTTP response codes and content indicate if the injection was successful and database structure exposed.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - http.response.mime_type
        - network.bytes_received

  - question: Are there other SQL injection attempts targeting this Mambo installation?
    context: Attackers typically probe multiple SQL injection vectors on the same target for comprehensive exploitation.
    range: +/-2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.query|contains:
            - "SELECT"
            - "INSERT"
            - "UPDATE"
            - "DELETE"
            - "UNION"
            - "DROP"
        condition: selection
      fields:
        - url.full
        - url.path
        - url.query
        - http.response.status_code

  - question: What data was the attacker attempting to insert into the database?
    context: SQL INSERT payloads often create backdoor admin accounts or inject malicious content for persistent access.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.query|contains:
            - "VALUES"
            - "admin"
            - "password"
            - "user"
            - "email"
        condition: selection
      fields:
        - url.full
        - url.query
        - http.request.method
        - http.response.status_code

  - question: Has the attacker successfully gained administrative access to the web application?
    context: Successful SQL injection may result in unauthorized login attempts or administrative actions.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains:
            - "admin"
            - "administrator"
            - "login"
            - "index.php"
        condition: selection
      fields:
        - url.full
        - url.path
        - http.request.method
        - http.response.status_code

  - question: Are there signs of database enumeration or data exfiltration?
    context: After successful injection, attackers often enumerate database structure and extract sensitive data.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.query|contains:
            - "information_schema"
            - "table_name"
            - "column_name"
            - "database()"
            - "version()"
        condition: selection
      fields:
        - url.full
        - url.query
        - http.response.status_code
        - network.bytes_received

  - question: What other web application vulnerabilities is this attacker exploiting?
    context: SQL injection attempts are often part of broader web application reconnaissance and exploitation campaigns.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - "web-application-attack"
            - "attempted-recon"
            - "shellcode-detect"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.category

  - question: Has this Mambo installation been updated against known vulnerabilities?
    context: Outdated Mambo installations are common targets for SQL injection and other web application attacks.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains: "index.php"
          url.query|contains: "option=com_"
        condition: selection
      fields:
        - src_ip
        - url.query
        - http.response.status_code
        - http.request.method

  - question: Are other systems showing similar Mambo AHS Shop exploitation attempts?
    context: Attackers often target multiple vulnerable Mambo installations across different organizations.
    range: +/-6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Mambo AHS Shop"
          rule.category: "web-application-attack"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: What is the attack timeline and progression of SQL injection techniques?
    context: Understanding attack progression helps identify the most effective injection methods and potential persistence.
    range: +/-8h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.category: "web-application-attack"
        condition: selection
      fields:
        - rule.name
        - url.path
        - url.query