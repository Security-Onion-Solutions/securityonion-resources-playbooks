name: ET WEB_SPECIFIC_APPS iBrowser Plugin dir Parameter Cross Site Scripting Attempt-2
id: 22013765
description: |
  Detects cross-site scripting (XSS) attempts targeting the iBrowser Plugin through the dir parameter in phpThumb.demo.random.php.
  This vulnerability allows attackers to inject malicious scripts that execute in victims' browsers.
  Legitimate use of phpThumb library should not contain script injection patterns in parameters.
type: detection
detection_id: 2013765
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the exact XSS payload injected through the dir parameter?
    context: Understanding the specific script injection reveals the attacker's intent and potential impact on victims.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - url.path
        - url.query
        - http.request.body.content

  - question: Is this a legitimate administrative request to the phpThumb application?
    context: Authorized administrators may access phpThumb demo pages, but script injection patterns indicate malicious intent.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains: "phpThumb"
        condition: selection
      fields:
        - http.request.method
        - url.path
        - http.response.status_code
        - http.request.referrer

  - question: What was the HTTP response to this XSS injection attempt?
    context: Response status and content indicate if the injection was successful and if the vulnerability exists.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - http.response.mime_type
        - network.bytes_received

  - question: Are there other XSS attempts targeting this web server from the same source?
    context: Attackers often probe multiple XSS vectors on the same target to find exploitable vulnerabilities.
    range: +/-2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.query|contains:
            - "script"
            - "onmouse"
            - "onkey"
            - "onload"
            - "onclick"
        condition: selection
      fields:
        - url.full
        - url.path
        - url.query
        - http.response.status_code

  - question: What other web application attacks originated from this source IP?
    context: XSS attempts are often part of broader web application reconnaissance and exploitation campaigns.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - "web-application-attack"
            - "attempted-recon"
            - "sql-injection"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.category

  - question: Did the XSS payload attempt to steal session cookies or credentials?
    context: Successful XSS attacks often focus on session hijacking or credential theft for account compromise.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.query|contains:
            - "cookie"
            - "document.cookie"
            - "session"
            - "password"
            - "login"
        condition: selection
      fields:
        - url.full
        - url.query
        - http.request.method
        - dst_ip

  - question: Are there signs of successful script execution or data exfiltration?
    context: Successful XSS may result in additional HTTP requests containing stolen data or session tokens.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
          http.request.method: "POST"
        condition: selection
      fields:
        - src_ip
        - url.full
        - http.request.body.content
        - http.request.referrer

  - question: What is the geolocation and reputation of the attacking IP address?
    context: Understanding attacker location and IP reputation helps assess threat level and potential attribution.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.protocol
        - network.bytes_sent

  - question: Has this web server been patched against known phpThumb vulnerabilities?
    context: Vulnerable phpThumb installations are common targets for XSS and other web application attacks.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains: "phpThumb"
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.response.status_code
        - http.request.method

  - question: Are there other web applications on this server showing similar attack patterns?
    context: Attackers often target multiple applications on the same server to maximize exploitation opportunities.
    range: +/-6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.category: "web-application-attack"
        condition: selection
      fields:
        - src_ip
        - rule.name
        - url.path

  - question: Is this part of a coordinated attack campaign against multiple targets?
    context: XSS attacks may be part of larger campaigns targeting multiple organizations with similar vulnerabilities.
    range: +/-12h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "phpThumb"
          rule.category: "web-application-attack"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name