name: ET SCAN NMAP SQL Spider Scan
id: 22013778
description: |
  Detects NMAP SQL Spider scan attempts containing SQL injection patterns in HTTP requests.
  May indicate automated vulnerability scanning or legitimate security testing.
type: detection
detection_id: 2013778
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete SQL injection pattern in the request?
    context: Understanding the exact payload helps determine scan sophistication and target vulnerability.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - http.request.body.content

  - question: Is this part of authorized security testing?
    context: SQL spider scans may be legitimate penetration testing or security assessments.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - http.request.method
        - url.path
        - http.response.status_code

  - question: What other scanning activity is coming from this source?
    context: Additional scanning patterns help identify if this is part of broader reconnaissance.
    range: -2h/+1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - "SCAN"
            - "scan"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - dst_port

  - question: How is the target application responding to these requests?
    context: Response codes and patterns indicate if the application is vulnerable or properly defended.
    range: -15m/+15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes
        - url.path

  - question: Are there signs of successful SQL injection exploitation?
    context: Successful exploitation would show different response patterns or error messages.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - url.full

  - question: What web application is being targeted?
    context: Identifying the target application helps assess vulnerability and business impact.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|expand: '%dst_port%'
        condition: selection
      fields:
        - http.response.header.server
        - url.path
        - http.request.header.user_agent

  - question: Are there other SQL injection attempts against this target?
    context: Multiple injection attempts indicate persistent targeting or automated scanning.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - "SQL"
            - "sql"
        condition: selection
      fields:
        - src_ip
        - rule.name
        - http.request.method

  - question: What is the geographic origin of this scanning activity?
    context: Source location helps determine if this is targeted or opportunistic scanning.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - network.bytes_sent
        - network.bytes_received

  - question: Are other internal systems being scanned by this source?
    context: Multiple internal targets indicate broader network reconnaissance or compromise.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - "SCAN"
            - "ATTACK"
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - dst_port