name: ET WEB_SPECIFIC_APPS IBSng str Parameter Cross Site Scripting Attempt
id: 22013871
description: |
  Detects cross-site scripting attempts targeting the IBSng application via the str parameter in show_multistr.php.
  May trigger on legitimate JavaScript usage but typically indicates XSS exploitation attempts.
type: detection
detection_id: 2013871
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact XSS payload in the str parameter?
    context: Analyzing the complete payload reveals the attack vector and intended malicious actions.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.full
        - url.query
        - http.request.body.content

  - question: What JavaScript events or HTML elements were used in the XSS attempt?
    context: Specific events like onload, onclick, or script tags reveal the attack methodology.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.query
        - http.request.method
        - user_agent.original

  # Type 2: Triage Assessment
  - question: Is IBSng legitimately installed and used on this server?
    context: Confirming application presence helps distinguish targeted attacks from random scanning.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains:
            - "/util/"
            - "ibsng"
            - "show_multistr.php"
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.response.status_code

  - question: Are there legitimate user sessions accessing IBSng functionality?
    context: Normal application usage patterns help identify if this is authorized testing or usage.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains:
            - "login"
            - "admin"
            - "dashboard"
        condition: selection
      fields:
        - url.path
        - http.response.status_code
        - user_agent.original

  # Type 3: Activity Context
  - question: What reconnaissance activity preceded this XSS attempt?
    context: Attackers typically probe for vulnerable parameters before crafting XSS payloads.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains:
            - "/util/"
            - ".php"
            - "test"
        condition: selection
      fields:
        - url.path
        - url.query
        - http.response.status_code

  - question: How did the application respond to this XSS attempt?
    context: Response analysis reveals if the payload was reflected and potentially executed.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes
        - http.response.body.content

  # Type 4: Impact Assessment
  - question: Was the XSS payload successfully reflected in the response?
    context: Successful XSS requires the payload to be reflected back to execute in the browser.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
          src_ip|expand: '%dst_ip%'
          http.response.body.content|contains:
            - "script"
            - "onload"
            - "onclick"
        condition: selection
      fields:
        - http.response.body.content
        - http.response.status_code
        - content_type

  - question: Are there signs of session hijacking or credential theft attempts?
    context: XSS attacks often aim to steal cookies, sessions, or redirect users to malicious sites.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.query|contains:
            - "document.cookie"
            - "location.href"
            - "window.location"
        condition: selection
      fields:
        - url.full
        - http.request.headers.referer
        - dst_ip

  # Type 5: Forensic Deep-Dive
  - question: What browser or client initiated this XSS attempt?
    context: User agent analysis may reveal automated tools or specific attack frameworks.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - user_agent.original
        - http.request.headers.accept
        - http.request.headers.accept_language

  - question: Are there other XSS attempts against different parameters or pages?
    context: Attackers often test multiple injection points to find successful attack vectors.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: "Cross Site Scripting"
        condition: selection
      fields:
        - url.path
        - url.query
        - rule.name

  - question: What client-side activity occurred after the XSS attempt?
    context: Successful XSS may trigger additional requests or data exfiltration attempts.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.headers.referer|contains: "show_multistr.php"
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.request.body.content

  # Type 6: Enterprise Correlation
  - question: Are other web applications being targeted with XSS attacks?
    context: Attackers may scan multiple applications for cross-site scripting vulnerabilities.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "Cross Site Scripting"
        condition: selection
      fields:
        - dst_ip
        - url.path
        - rule.name

  - question: Is this part of a broader web application attack campaign?
    context: XSS attempts often occur alongside other web exploitation techniques.
    range: -3h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category: "web-application-attack"
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - rule.category