name: ET DNS Excessive DNS Responses with 1 or more RR's to google.com.br possible Cache Poisoning Attempt
id: 22013894
description: |
  Detects potential DNS cache poisoning attacks targeting google.com.br domain.
  Excessive DNS responses (100+ in 10 seconds) indicate possible DNS manipulation or poisoning attempts.
  May trigger during legitimate high-traffic periods or DNS server issues.
type: detection
detection_id: 2013894
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What were the specific DNS response records and resolved IP addresses for google.com.br?
    context: Analyzing the DNS responses reveals if legitimate Google IPs or malicious redirects were returned.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - dns.resolved_ip
        - dns.response_code
        - dns.answers

  - question: How many DNS responses were generated and what was the exact timing pattern?
    context: The response frequency and timing help distinguish between legitimate traffic and poisoning attempts.
    range: -10m/+10m
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.query.name|contains: 'google.com.br'
        condition: selection
      fields:
        - response_count
        - dns.resolved_ip
        - dns.query.type_name

  # Type 2: Triage Assessment
  - question: Is this DNS server handling legitimate high-volume traffic for google.com.br?
    context: High-traffic DNS servers may legitimately generate many responses during peak usage periods.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.query.name|contains: '.br'
        condition: selection
      fields:
        - unique_queries
        - response_count
        - dns.query.name

  - question: Are the resolved IP addresses legitimate Google infrastructure?
    context: Legitimate Google services should resolve to known Google IP ranges and ASNs.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.query.name|contains: 'google.com'
        condition: selection
      fields:
        - dns.resolved_ip
        - dns.query.name
        - geoip.country_name
        - asn.organization

  # Type 3: Activity Context
  - question: What other DNS queries were made around the same time period?
    context: DNS poisoning attacks often target multiple domains or include reconnaissance activity.
    range: -30m/+30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name
        - dns.response_code

  - question: Were there any suspicious network connections to the resolved IP addresses?
    context: Malicious DNS poisoning often redirects users to attacker-controlled infrastructure.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dns.resolved_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - bytes_in
        - bytes_out
        - connection_state

  # Type 4: Impact Assessment
  - question: How many clients received the potentially poisoned DNS responses?
    context: Understanding the scope of affected clients helps assess the impact of the poisoning attempt.
    range: -1h/+1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
          dns.query.name|contains: 'google.com.br'
        condition: selection
      fields:
        - unique_src_ips
        - response_count
        - dns.resolved_ip

  - question: Did clients attempt to connect to the resolved IP addresses?
    context: Successful connections to malicious IPs indicate successful DNS poisoning and potential compromise.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dns.resolved_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - connection_state
        - bytes_exchanged

  # Type 5: Forensic Deep-Dive
  - question: What is the reputation and geolocation of the resolved IP addresses?
    context: Malicious DNS poisoning typically redirects to attacker-controlled infrastructure in suspicious locations.
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          dns.resolved_ip|expand: '%dns.resolved_ip%'
        condition: selection
      fields:
        - dns.resolved_ip
        - geoip.country_name
        - threat_intel.category
        - asn.organization

  - question: Are there signs of DNS tunneling or other DNS-based attacks?
    context: DNS poisoning attacks often occur alongside other DNS-based attack techniques.
    range: -2h/+2h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'DNS'
            - 'Tunnel'
            - 'Poison'
        condition: selection
      fields:
        - rule.name
        - dns.query.name
        - severity

  - question: What DNS query types and patterns suggest malicious activity?
    context: Unusual DNS query patterns help identify the attack methodology and tools used.
    range: -1h/+1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.type_name
        - query_count
        - unique_domains
        - dns.response_code

  # Type 6: Enterprise Correlation
  - question: Are other DNS servers in the network showing similar poisoning indicators?
    context: Coordinated DNS poisoning attacks often target multiple DNS infrastructure components.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'DNS'
            - 'Poison'
            - 'Cache'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - dns.query.name

  - question: Have there been other DNS-related security incidents in the Brazilian domain space?
    context: DNS poisoning campaigns often target specific geographic regions or country domains systematically.
    range: -7d
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          dns.query.name|contains: '.br'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - src_ip
        - geoip.country_name