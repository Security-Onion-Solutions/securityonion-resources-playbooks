name: ET MOBILE_MALWARE Android/KungFu Package Delete Command
id: 22013968
description: |
  Detects Android KungFu malware attempting to communicate with command and control servers.
  This alert indicates potential mobile malware infection sending device information to external servers.
  Legitimate Android applications do not typically use the specific URI patterns and user agent combinations seen in this rule.
type: detection
detection_id: 2013968
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete HTTP request URI that triggered this alert?
    context: The URI pattern reveals the specific KungFu malware variant and command structure being used.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - http.user_agent

  - question: What device information was being transmitted in the request parameters?
    context: KungFu malware typically sends IMEI, channel, and version information to C2 servers.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.query
        - http.request.body.content

  - question: Is this mobile device authorized to access external web services?
    context: Corporate mobile devices may have restricted internet access policies.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - url.domain

  - question: What other HTTP connections occurred from this source IP around the same time?
    context: KungFu malware often makes multiple C2 connections and may download additional payloads.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - url.full
        - http.user_agent

  - question: Has this source IP made other suspicious mobile malware-related connections?
    context: Mobile malware often uses multiple C2 domains and may exhibit recurring communication patterns.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - "MOBILE_MALWARE"
            - "TROJAN"
        condition: selection
      fields:
        - rule.name
        - dst_ip

  - question: What is the reputation and hosting information for the destination server?
    context: KungFu C2 servers are often hosted on compromised or bulletproof hosting infrastructure.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - dst_port
        - network.bytes
        - network.packets

  - question: Are there signs of successful malware installation or persistence on the mobile device?
    context: Successful KungFu infection may result in additional network activity or device behavior changes.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.protocol

  - question: What DNS queries were made by this device for the malicious domain?
    context: DNS resolution patterns can reveal if the device successfully resolved the C2 domain.
    range: +/-30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.resolved_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name

  - question: Has this mobile device pattern been observed from other source IPs in the network?
    context: KungFu malware outbreaks may affect multiple mobile devices simultaneously.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|expand: '%rule.name%'
        condition: selection
      fields:
        - src_ip
        - dst_ip

  - question: What is the timing pattern of these malware communications?
    context: KungFu malware may have scheduled check-in intervals or respond to specific triggers.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|expand: '%rule.name%'
        condition: selection
      fields:
        - src_ip
        - dst_ip