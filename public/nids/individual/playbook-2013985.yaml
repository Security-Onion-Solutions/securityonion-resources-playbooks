name: ET WEB_SPECIFIC_APPS Zabbix popup.php DELETE FROM SQL Injection Vulnerability
id: 22013985
description: |
  Detects SQL injection attempts targeting Zabbix popup.php using DELETE FROM statements.
  May trigger on legitimate database maintenance operations in rare cases.
type: detection
detection_id: 2013985
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete DELETE FROM SQL injection payload?
    context: Understanding the exact deletion statement reveals attacker intent to destroy data.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - http.request.body.content

  - question: Which Zabbix database tables were targeted for deletion?
    context: Identifying targeted tables helps assess potential data loss and system impact.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.query
        - http.request.referrer

  - question: Is this a legitimate Zabbix maintenance operation?
    context: Database administrators may perform cleanup operations through web interfaces.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains:
            - "/zabbix"
            - "/maintenance"
            - "/admin"
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.request.method

  - question: What was the attacker's reconnaissance pattern before this destructive attempt?
    context: DELETE attacks typically follow information gathering to identify valuable targets.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.full
        - http.response.status_code
        - http.request.method

  - question: Did the DELETE injection attempt execute successfully?
    context: Successful deletion attacks can cause significant data loss and system disruption.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains: "/popup.php"
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes
        - http.response.mime_type

  - question: What database processes were active during the injection attempt?
    context: Monitoring database activity helps determine if destructive operations occurred.
    range: +15m
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - "mysql"
            - "postgresql"
            - "sqlite"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  - question: Are there signs of data corruption or system instability following the attack?
    context: Successful DELETE injections can cause application errors and data integrity issues.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          http.response.status_code|contains:
            - "500"
            - "502"
            - "503"
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.response.status_code

  - question: What critical Zabbix data could have been deleted?
    context: Understanding potential data loss helps assess incident severity and recovery needs.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - "3306"
            - "5432"
            - "1521"
        condition: selection
      fields:
        - src_ip
        - dst_port
        - network.bytes_sent
        - network.bytes_received

  - question: Has the Zabbix system functionality been impacted?
    context: Monitoring system health helps determine operational impact of the attack.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains: "/zabbix"
        condition: selection
      fields:
        - http.response.status_code
        - url.path
        - src_ip

  - question: Are other Zabbix instances experiencing similar destructive attacks?
    context: Coordinated deletion attacks may target multiple monitoring systems.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Zabbix"
          rule.name|contains: "DELETE"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is this part of a broader campaign targeting monitoring infrastructure?
    context: Attackers may target monitoring systems to hide their activities in compromised networks.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "monitoring"
            - "SNMP"
            - "Nagios"
            - "Zabbix"
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - rule.category