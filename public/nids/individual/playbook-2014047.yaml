name: ET MALWARE Double HTTP/1.1 Header Inbound - Likely Hostile Traffic
id: 22014047
description: |
  Detects HTTP requests with duplicate HTTP/1.1 version headers, indicating malformed or malicious traffic.
  This pattern is commonly associated with malware communication, exploit kits, or protocol confusion attacks.
  Legitimate applications should never send duplicate HTTP version headers.
type: detection
detection_id: 2014047
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete HTTP request structure containing the duplicate headers?
    context: Analyzing the malformed HTTP request reveals the specific malware family or attack technique being used.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - src_ip
        - dst_ip
        - dst_port
        - community_id

  - question: What HTTP method and URL path were used in this malformed request?
    context: The HTTP method and target path provide insight into the intended exploitation or communication purpose.
    range: +/-5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - http.request.body.content

  - question: What user agent and other HTTP headers accompanied this malformed request?
    context: HTTP headers often contain malware signatures or indicate specific exploit kit characteristics.
    range: +/-5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - http.request.headers
        - http.response.status_code
        - http.response.body.content

  # Type 2: Triage Assessment
  - question: Is this traffic from a known infected or suspicious host?
    context: Previous malware alerts from the same source IP indicate ongoing compromise.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - "MALWARE"
            - "TROJAN"
            - "EXPLOIT"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.category

  - question: Does this match any legitimate application traffic patterns for this host?
    context: Some applications may have HTTP implementation bugs, though duplicate version headers are extremely rare.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - http.request.method
        - url.domain
        - http.response.status_code

  # Type 3: Activity Context
  - question: What process or application initiated this malformed HTTP communication?
    context: Identifying the source process helps determine if this is malware communication or a compromised application.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - "http"
            - "curl"
            - "wget"
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  - question: What network connections were established around the time of this malformed request?
    context: Additional network activity may reveal command and control communication or data exfiltration attempts.
    range: +/-30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 80
            - 443
            - 8080
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver
        - bytes_toclient

  - question: Were there any file downloads or uploads associated with this HTTP session?
    context: Malformed HTTP requests often precede malware downloads or data exfiltration activities.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.mime_type|contains:
            - "application"
            - "text/html"
            - "image"
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size

  # Type 4: Impact Assessment
  - question: Did the server respond successfully to this malformed HTTP request?
    context: Successful responses to malformed requests may indicate vulnerable servers or successful exploitation.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - bytes_toclient

  - question: Are there signs of successful malware installation or execution following this request?
    context: Malformed HTTP requests may be part of exploit delivery or malware communication protocols.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - ".tmp"
            - "temp"
            - "appdata"
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  # Type 5: Forensic Deep-Dive
  - question: What specific malware family or exploit kit characteristics match this HTTP pattern?
    context: Double HTTP headers are signatures of specific malware families or exploit kit communication protocols.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "HTTP"
            - "MALWARE"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.category

  - question: Are there additional protocol violations or malformed packets from this source?
    context: Multiple protocol violations indicate sophisticated malware or targeted attack tools.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "protocol"
            - "malformed"
            - "decode"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.category

  # Type 6: Enterprise Correlation
  - question: Are other hosts in the network exhibiting similar malformed HTTP traffic patterns?
    context: Multiple hosts with malformed HTTP requests may indicate worm propagation or coordinated malware campaign.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Double HTTP"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name