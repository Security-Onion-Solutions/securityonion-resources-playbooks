name: ET WEB_SPECIFIC_APPS Joomla com_dshop Component DELETE FROM SQL Injection Attempt
id: 22014062
description: |
  Detects SQL injection attempts targeting the Joomla com_dshop component using DELETE FROM statements.
  Attackers exploit vulnerable parameters to delete database records, causing data loss.
  May trigger on legitimate database maintenance if application uses similar parameter names.
type: detection
detection_id: 2014062
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete DELETE SQL injection payload in the request?
    context: Analyzing the full payload reveals which database tables and records the attacker is targeting for deletion.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.full
        - url.query
        - http.request.method
        - http.request.body.content

  - question: Which specific parameter and table is being targeted for deletion?
    context: Understanding the target helps assess data loss impact and prioritize database recovery efforts.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - url.query
        - url.path
        - http.request.headers.user-agent
        - http.request.headers.referer

  - question: Is this a legitimate database maintenance operation?
    context: Administrators may perform legitimate DELETE operations, requiring verification of authorized access.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains:
            - "administrator"
            - "admin"
            - "manage"
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.response.status_code
        - http.request.headers.cookie

  - question: What reconnaissance activity preceded this destructive SQL injection?
    context: Attackers typically gather database structure information before attempting destructive operations.
    range: -4h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.query|contains:
            - "SELECT"
            - "UNION"
            - "information_schema"
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.response.status_code

  - question: Did the DELETE operation execute successfully on the database?
    context: Successful execution indicates actual data loss requiring immediate database recovery actions.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes
        - http.response.headers.content-type

  - question: Are there signs of automated attack tools or mass deletion attempts?
    context: Automated tools may attempt to delete multiple tables or perform widespread data destruction.
    range: -1h/+1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.query|contains:
            - "DELETE"
            - "DROP"
            - "TRUNCATE"
        condition: selection
      fields:
        - url.path
        - http.request.headers.user-agent
        - http.response.status_code

  - question: What critical data or functionality could be affected by this deletion?
    context: Understanding the com_dshop component's data helps assess business impact and recovery priorities.
    range: -1h/+1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains:
            - "com_dshop"
        condition: selection
      fields:
        - url.query
        - http.request.method
        - http.response.status_code

  - question: Are there signs of data exfiltration before the deletion attempt?
    context: Attackers may steal data before destroying it to maximize damage and avoid detection.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.response.body.bytes|gte: 10000
        condition: selection
      fields:
        - url.full
        - http.response.body.bytes
        - http.response.headers.content-type

  - question: What other destructive activities is this attacker attempting?
    context: Attackers may target multiple components or use various attack vectors for maximum impact.
    range: -4h/+2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.query|contains:
            - "DELETE"
            - "DROP"
            - "TRUNCATE"
            - "UPDATE"
        condition: selection
      fields:
        - dst_ip
        - url.full
        - http.response.status_code

  - question: Are there database error messages indicating successful or failed deletion?
    context: Error messages reveal whether the attack succeeded and what database protections may be in place.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.response.status_code|contains:
            - "500"
            - "200"
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes
        - url.query

  - question: Are other Joomla sites in the network being targeted similarly?
    context: Attackers often target multiple Joomla installations once they identify a successful attack vector.
    range: -2h/+2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.query|contains:
            - "option=com_dshop"
            - "DELETE"
            - "FROM"
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - http.response.status_code