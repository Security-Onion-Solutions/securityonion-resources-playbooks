name: ET EXPLOIT_KIT Sakura Exploit Kit Landing Page Request
id: 22014147
description: |
  Detects outbound requests to Sakura Exploit Kit landing pages with characteristic URI patterns.
  Indicates potential compromise where infected systems are being redirected to exploit kits.
  May also trigger on legitimate penetration testing or security research activities.
type: detection
detection_id: 2014147
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete URI pattern and hexadecimal identifier in the request?
    context: The 25-character hex string uniquely identifies the exploit kit session and victim tracking.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.full
        - url.path
        - url.query
        - http.request.method

  - question: What was the complete HTTP request including headers and referrer information?
    context: Request headers reveal the infection vector and previous page that led to this exploit kit.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains: ".php?s="
        condition: selection
      fields:
        - http.request.headers
        - http.request.referrer
        - http.user_agent
        - url.full

  - question: What was the server response and payload delivered by the exploit kit?
    context: Response analysis reveals the exploit payload and success of the attack.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains: ".php?s="
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes
        - http.response.mime_type
        - http.response.headers

  # Type 2: Triage Assessment
  - question: Is this legitimate security testing or research activity?
    context: Security researchers and penetration testers may intentionally trigger exploit kits.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - "burp"
            - "zap"
            - "metasploit"
            - "nmap"
            - "nikto"
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  - question: Does the user agent and browser context suggest normal web browsing?
    context: Legitimate browsing sessions have consistent user agents and browsing patterns.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - http.user_agent
        - url.domain
        - http.request.method

  # Type 3: Activity Context
  - question: What web activity led to this exploit kit landing page?
    context: Understanding the infection vector helps identify the initial compromise method.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.full
        - http.request.referrer
        - http.response.status_code
        - http.user_agent

  - question: Were there any malicious advertisements or compromised websites visited?
    context: Exploit kits are commonly delivered through malvertising and compromised legitimate sites.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.domain|contains:
            - "ads"
            - "click"
            - "track"
            - "redirect"
        condition: selection
      fields:
        - url.domain
        - url.path
        - http.request.referrer

  - question: What process was responsible for making this web request?
    context: Identifying the requesting process helps determine if this was user-initiated or malware-driven.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - "browser"
            - "chrome"
            - "firefox"
            - "edge"
            - "iexplore"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  # Type 4: Impact Assessment
  - question: Was the exploit kit successful in delivering additional payloads?
    context: Successful exploitation often leads to secondary payload downloads and execution.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.response.mime_type|contains:
            - "application/octet-stream"
            - "application/x-executable"
            - "application/x-msdownload"
        condition: selection
      fields:
        - url.full
        - http.response.body.bytes
        - http.response.mime_type

  - question: Were any suspicious files downloaded or executed following this request?
    context: Exploit kit success typically results in malware download and execution.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - ".exe"
            - ".dll"
            - ".scr"
            - "temp"
            - "tmp"
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessGuid
        - User

  # Type 5: Forensic Deep-Dive
  - question: What is the complete network communication pattern with the exploit kit server?
    context: Full communication analysis reveals the exploit kit's behavior and payload delivery mechanism.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - network.protocol
        - network.bytes
        - network.packets

  - question: Are there indicators of successful system compromise or persistence?
    context: Successful exploit kit attacks often establish persistence mechanisms.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - "Run"
            - "RunOnce"
            - "Services"
            - "Winlogon"
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessGuid

  # Type 6: Enterprise Correlation
  - question: Are other internal systems showing similar exploit kit activity?
    context: Multiple infections indicate a broader campaign or common infection vector.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Sakura Exploit Kit"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is this part of a coordinated attack campaign against the organization?
    context: Exploit kit activity often correlates with broader malware campaigns and targeted attacks.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.category|contains:
            - "exploit-kit"
            - "malware"
            - "command-and-control"
        condition: selection
      fields:
        - src_ip
        - rule.name
        - rule.category