name: ET EXPLOIT_KIT Sakura Exploit Kit Binary Load Request
id: 22014148
description: |
  Detects requests to Sakura Exploit Kit binary loading endpoints indicating payload delivery.
  This represents the second stage where the exploit kit delivers malicious executables.
  Successful detection suggests active exploitation and malware deployment in progress.
type: detection
detection_id: 2014148
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete binary load request URL and parameter structure?
    context: The load.php endpoint and spl parameter reveal the exploit kit's payload delivery mechanism.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.full
        - url.path
        - url.query
        - http.request.method

  - question: What binary payload was delivered in response to this request?
    context: Response analysis reveals the malware family and payload characteristics.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains: "/load.php"
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes
        - http.response.mime_type
        - http.response.headers

  - question: What was the exact parameter value and encoding used in the request?
    context: The spl parameter often contains encoded victim or session information for tracking.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.query|contains: "spl="
        condition: selection
      fields:
        - url.query
        - http.request.headers
        - http.user_agent
        - http.request.referrer

  # Type 2: Triage Assessment
  - question: Is this legitimate security research or penetration testing activity?
    context: Security professionals may intentionally trigger exploit kits for analysis purposes.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - "wireshark"
            - "tcpdump"
            - "burp"
            - "zap"
            - "sandbox"
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  - question: Does the timing suggest automated or manual interaction?
    context: Rapid sequential requests indicate automated exploitation while manual timing suggests research.
    range: -5m
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.request.method
        - http.user_agent

  # Type 3: Activity Context
  - question: What exploit kit landing page activity preceded this binary load request?
    context: Binary loads typically follow successful exploitation from landing pages.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "Sakura Exploit Kit Landing"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - url.full

  - question: What browser or application process initiated this request?
    context: Understanding the requesting process helps determine if this was user-initiated or automated.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - "chrome"
            - "firefox"
            - "edge"
            - "iexplore"
            - "browser"
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - User
        - ProcessGuid

  - question: Were there any browser vulnerabilities or plugins that could be exploited?
    context: Exploit kits target specific browser vulnerabilities and plugin versions.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.user_agent|contains:
            - "Flash"
            - "Java"
            - "Silverlight"
            - "Adobe"
        condition: selection
      fields:
        - http.user_agent
        - url.domain
        - http.request.method

  # Type 4: Impact Assessment
  - question: Was the binary payload successfully downloaded and executed?
    context: Successful payload execution indicates complete system compromise.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - ".exe"
            - ".dll"
            - ".scr"
            - "temp"
            - "tmp"
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessGuid
        - User

  - question: Are there signs of malware execution or system changes following the binary load?
    context: Post-exploitation activity reveals the impact and capabilities of the delivered payload.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - "temp"
            - "tmp"
            - "appdata"
            - "programdata"
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - User
        - ProcessGuid

  - question: Has the system established any suspicious network connections post-exploitation?
    context: Malware often establishes command and control communications after successful deployment.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - "80"
            - "443"
            - "8080"
            - "53"
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.protocol
        - network.bytes

  # Type 5: Forensic Deep-Dive
  - question: What is the complete malware family and payload characteristics?
    context: Detailed payload analysis helps identify the specific malware family and capabilities.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - "malware"
            - "trojan"
            - "command-and-control"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.category

  - question: Are there persistence mechanisms or system modifications indicating advanced malware?
    context: Advanced malware establishes persistence and modifies system configurations.
    range: +6h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - "Run"
            - "RunOnce"
            - "Services"
            - "Policies"
            - "Security"
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessGuid

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network showing similar exploit kit binary load activity?
    context: Multiple systems indicate a broader campaign or common infection vector.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Sakura Exploit Kit Binary Load"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is this part of a coordinated malware distribution campaign?
    context: Exploit kit activity often correlates with broader malware campaigns targeting the organization.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.category|contains:
            - "exploit-kit"
            - "malware"
            - "trojan"
        condition: selection
      fields:
        - src_ip
        - rule.name
        - rule.category