name: ET MOBILE_MALWARE Android/SndApps.SM Sending Information to CnC
id: 22014162
description: |
  Detects Android/SndApps.SM malware communicating with command and control servers.
  This mobile malware steals device information and sends it to remote servers.
  May also trigger on legitimate Android applications with similar notification patterns.
type: detection
detection_id: 2014162
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete C&C communication URL and parameters sent?
    context: The notifier.php endpoint and parameters reveal the data being exfiltrated by the malware.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.full
        - url.path
        - url.query
        - http.request.method

  - question: What device information was being transmitted in the request?
    context: The 'h' parameter typically contains encoded device identifiers and stolen information.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains: "/android_notifier/notifier.php"
        condition: selection
      fields:
        - url.query
        - http.request.body.content
        - http.request.headers
        - http.user_agent

  - question: What was the server response and any additional commands received?
    context: C&C servers often respond with additional commands or configuration updates.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.query|contains: "h="
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - http.response.headers
        - http.response.body.bytes

  # Type 2: Triage Assessment
  - question: Is this a legitimate Android device or application making authorized requests?
    context: Some legitimate Android applications may use similar notification endpoints for valid purposes.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.user_agent|contains: "Android"
        condition: selection
      fields:
        - http.user_agent
        - url.domain
        - http.request.method

  - question: Does the source device show patterns consistent with legitimate mobile usage?
    context: Legitimate mobile devices have predictable usage patterns and application behaviors.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.domain
        - http.user_agent
        - dst_port

  # Type 3: Activity Context
  - question: What other network activity occurred from this Android device recently?
    context: Understanding overall device behavior helps distinguish malware from legitimate applications.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.protocol
        - network.bytes

  - question: Were there any suspicious application installations or updates on the device?
    context: Malware often arrives through malicious app installations or updates.
    range: -48h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains:
            - ".apk"
            - "download"
            - "install"
            - "update"
        condition: selection
      fields:
        - url.full
        - http.response.mime_type
        - http.response.body.bytes

  - question: What DNS queries preceded this C&C communication?
    context: DNS resolution patterns can reveal the malware's domain generation algorithm or hardcoded domains.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.resolved_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.resolved_ip

  # Type 4: Impact Assessment
  - question: What sensitive information was successfully transmitted to the C&C server?
    context: Determining data exfiltration scope helps assess privacy and security impact.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.response.status_code: 200
        condition: selection
      fields:
        - url.query
        - http.request.body.bytes
        - http.response.body.bytes

  - question: Are there indicators of additional malware functionality being activated?
    context: Successful C&C communication often triggers additional malicious activities.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.protocol
        - network.bytes

  - question: Has the device established connections to other suspicious or malicious servers?
    context: Mobile malware often communicates with multiple C&C servers or performs additional network activities.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - "command-and-control"
            - "malware"
            - "mobile-malware"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.category

  # Type 5: Forensic Deep-Dive
  - question: What is the complete communication protocol and data structure used by this malware?
    context: Understanding the full protocol helps with attribution and developing countermeasures.
    range: +6h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.request.headers
        - http.response.headers

  - question: Are there indicators of the malware's persistence and update mechanisms?
    context: Advanced mobile malware often has self-update and persistence capabilities.
    range: +12h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains:
            - "update"
            - "config"
            - "version"
            - "check"
        condition: selection
      fields:
        - url.full
        - http.response.mime_type
        - http.response.body.bytes

  # Type 6: Enterprise Correlation
  - question: Are other mobile devices in the network infected with similar malware?
    context: Mobile malware often spreads through enterprise networks or common infection vectors.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "SndApps.SM"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is this part of a broader mobile malware campaign targeting the organization?
    context: Mobile malware attacks often target multiple devices within an organization simultaneously.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.category|contains:
            - "mobile-malware"
            - "command-and-control"
        condition: selection
      fields:
        - src_ip
        - rule.name
        - rule.category

  - question: Are there patterns suggesting coordinated mobile device compromise across the network?
    context: Enterprise mobile security breaches often involve multiple devices and coordinated data theft.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          url.path|contains: "/android_notifier/"
          http.user_agent|contains: "Android"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - url.domain
        - http.user_agent