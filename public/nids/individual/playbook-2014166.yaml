name: ET MALWARE W32/Mentory CnC Server Providing Update Details
id: 22014166
description: |
  Detects W32/Mentory malware receiving update instructions from command and control server.
  This malware family uses specific update patterns to receive new configurations and payloads.
  Legitimate software updates do not use this specific protocol pattern.
type: detection
detection_id: 2014166
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What specific update commands and URLs were provided by the C&C server?
    context: Understanding the update payload reveals the malware's intended next actions and infrastructure.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.response.body.content
        - dst_ip
        - dst_port

  - question: Is this system known to be infected with W32/Mentory malware?
    context: Previous malware detections on this system confirm ongoing infection versus false positive.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'Mentory'
            - 'malware'
            - 'trojan'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - dst_ip

  - question: What process initiated this C&C communication?
    context: Identifying the malicious process helps understand infection vector and system compromise scope.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port|expand: '%dst_port%'
        condition: selection
      fields:
        - src_port
        - network.bytes_sent
        - network.bytes_received

  - question: Has the infected system downloaded additional malware components?
    context: Successful C&C communication often leads to secondary payload downloads or updates.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method: 'GET'
        condition: selection
      fields:
        - url.full
        - http.response.status_code
        - http.response.headers.content-type

  - question: Are there signs of new malicious processes spawning after the update?
    context: Malware updates often result in new process execution or modification of existing malicious processes.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          Hostname|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - User

  - question: Has the malware established new persistence mechanisms post-update?
    context: Updates may include new persistence methods to maintain long-term access to the compromised system.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          Hostname|expand: '%src_ip%'
          TargetObject|contains:
            - '\Run\'
            - '\RunOnce\'
            - '\Services\'
            - '\CurrentVersion\Windows\Load'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessName

  - question: Are there new files created on the system following the C&C update?
    context: Malware updates often involve dropping new executable files or configuration files.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          Hostname|expand: '%src_ip%'
          TargetFilename|contains:
            - '.exe'
            - '.dll'
            - '.bat'
            - '.tmp'
        condition: selection
      fields:
        - TargetFilename
        - ProcessName
        - file.hash.md5

  - question: What is the infrastructure pattern of the C&C server?
    context: Understanding C&C infrastructure helps identify related malware campaigns and block additional threats.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          dns.resolved_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name

  - question: Are other systems in the network communicating with this C&C server?
    context: Malware often spreads laterally, and multiple systems may be infected with the same malware family.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|expand: '%dst_port%'
        condition: selection
      fields:
        - src_ip
        - network.bytes_sent
        - network.bytes_received

  - question: Is this part of a broader W32/Mentory campaign across the enterprise?
    context: Coordinated malware campaigns often target multiple systems within an organization simultaneously.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: 'ET MALWARE W32/Mentory CnC Server Providing Update Details'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.category

  - question: Has the infected system attempted lateral movement or credential theft?
    context: Updated malware may include new capabilities for network reconnaissance and credential harvesting.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 445
            - 139
            - 135
            - 3389
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.bytes_sent