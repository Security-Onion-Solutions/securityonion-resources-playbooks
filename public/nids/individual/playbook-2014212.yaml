name: ET MALWARE MSUpdater POST checkin to CnC
id: 22014212
description: |
  Detects MSUpdater trojan communicating with command and control server via HTTP POST.
  The malware masquerades as Microsoft Update service using specific URI patterns.
  Legitimate Microsoft Update traffic would not use these specific paths and parameters.
type: detection
detection_id: 2014212
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete URI and ID parameter used in the MSUpdater communication?
    context: The URI pattern and ID parameter reveal the malware's communication protocol and potential victim identifier.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - url.path
        - url.query

  - question: What data was transmitted in the POST request body to the fake Microsoft endpoint?
    context: POST body analysis reveals what system information the malware is exfiltrating.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains: "/microsoft/errorpost/default.aspx"
        condition: selection
      fields:
        - http.request.body.content
        - bytes_out
        - url.query

  # Type 2: Triage Assessment
  - question: Is this system configured to use legitimate Microsoft Update services?
    context: Determines if this could be legitimate Microsoft Update traffic or confirmed malware.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|contains:
            - "windowsupdate.microsoft.com"
            - "update.microsoft.com"
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - bytes_in

  - question: Has this source IP made other suspicious requests to fake Microsoft domains?
    context: Identifies if this is part of broader malware communication patterns.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains: "microsoft"
        condition: selection
      fields:
        - url.domain
        - url.path
        - http.request.method

  # Type 3: Activity Context
  - question: What process initiated this fake Microsoft Update communication?
    context: Identifying the parent process helps determine how the malware was executed.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - User

  - question: What other network connections were established during this timeframe?
    context: Concurrent network activity reveals the full scope of malware communication.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - bytes_in

  - question: Were there any email or document opening events that preceded this activity?
    context: MSUpdater is often delivered via targeted email campaigns with malicious attachments.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.extension|contains:
            - ".doc"
            - ".pdf"
            - ".exe"
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size

  # Type 4: Impact Assessment
  - question: What response did the malicious command and control server provide?
    context: C2 server responses may contain additional commands or payload downloads.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - http.response.body.content
        - http.response.status_code
        - bytes_in

  - question: Are there signs of additional malware components being deployed?
    context: MSUpdater often downloads additional payloads after successful C2 communication.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.hash.sha256

  # Type 5: Forensic Deep-Dive
  - question: What persistence mechanisms has the MSUpdater malware established?
    context: Understanding persistence helps with complete malware removal and prevention of reinfection.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - "Run"
            - "RunOnce"
            - "Services"
        condition: selection
      fields:
        - TargetObject
        - Details
        - EventType

  - question: What system information was the malware attempting to collect?
    context: Understanding data collection helps assess the impact and required breach notifications.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - "systeminfo"
            - "ipconfig"
            - "net user"
            - "whoami"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network communicating with the same malicious infrastructure?
    context: Identifies the scope of the MSUpdater infection across the enterprise environment.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains: "/microsoft/errorpost/default.aspx"
        condition: selection
      fields:
        - src_ip
        - url.query
        - bytes_out