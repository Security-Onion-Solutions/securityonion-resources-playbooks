name: ET MOBILE_MALWARE Android/Plankton.P Commands Request to CnC Server
id: 22014215
description: |
  Detects Android/Plankton.P malware attempting to communicate with command and control servers.
  This specific pattern indicates infected Android devices requesting commands from malicious infrastructure.
  Legitimate applications would not use this specific protocol gateway path.
type: detection
detection_id: 2014215
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete HTTP request containing the Plankton.P command protocol?
    context: Analyzing the full request reveals the malware's communication pattern and potential command payload.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - http.request.headers
        - http.request.body.content

  - question: What specific command protocol path was accessed by the infected device?
    context: The URI path reveals the exact malware variant and communication protocol being used.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - url.path
        - url.query
        - http.request.method

  # Type 2: Triage Assessment
  - question: Is this device known to legitimately access protocol gateway services?
    context: Determining if this is expected mobile application behavior versus malicious activity.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains:
            - "/ProtocolGW/"
            - "/protocol/"
        condition: selection
      fields:
        - dst_ip
        - url.path
        - http.request.method

  - question: Has this source IP shown other suspicious mobile malware indicators?
    context: Correlating with other mobile malware signatures to assess infection scope.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - "MOBILE_MALWARE"
            - "MALWARE"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.category

  # Type 3: Activity Context
  - question: What triggered this command request from the infected device?
    context: Understanding the sequence of events that led to this C2 communication attempt.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.protocol
        - network.bytes

  - question: What other network connections occurred around the same time from this device?
    context: Identifying related malware communication patterns and potential data exfiltration.
    range: -30m/+30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.protocol
        - network.bytes

  # Type 4: Impact Assessment
  - question: Did the C2 server respond with commands to the infected device?
    context: Determining if the malware successfully received instructions from the command server.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - network.bytes

  - question: What data was transmitted from the infected device to the C2 server?
    context: Assessing potential data theft or device information disclosure.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
          http.request.method: "POST"
        condition: selection
      fields:
        - http.request.body.content
        - network.bytes
        - http.request.headers

  # Type 5: Forensic Deep-Dive
  - question: What specific Plankton.P variant is communicating based on the protocol structure?
    context: Identifying the exact malware family helps determine capabilities and persistence mechanisms.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.request.headers.user_agent
        - url.full
        - http.request.body.content

  - question: Are there signs of additional malware families or tools on this device?
    context: Determining if this is part of a larger infection or multi-stage attack.
    range: -1d/+1d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - "TROJAN"
            - "MALWARE"
            - "MOBILE_MALWARE"
        condition: selection
      fields:
        - rule.name
        - rule.category
        - dst_ip

  # Type 6: Enterprise Correlation
  - question: Are other devices in the network showing similar Plankton.P communication patterns?
    context: Identifying the scope of the mobile malware infection across the organization.
    range: -24h/+24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Plankton"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is this part of a broader mobile malware campaign targeting the organization?
    context: Understanding if this represents an isolated incident or coordinated attack.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.category: "MOBILE_MALWARE"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - rule.category