name: ET MALWARE LURK Trojan Communication Protocol detected
id: 22014225
description: |
  Detects LURK Trojan command and control communication via distinctive protocol markers.
  LURK is advanced malware used in targeted financial attacks and APT campaigns.
  May trigger on compressed data streams but specific pattern indicates malicious C2.
type: detection
detection_id: 2014225
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact LURK protocol signature and compressed data pattern detected?
    context: Understanding the specific protocol markers confirms LURK variant and communication encryption method.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - dsize
        - flow.state

  - question: What is the structure and content of the compressed data following the LURK header?
    context: Analyzing the zlib compressed payload reveals command structure and potential data exfiltration.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.body.content
        - http.request.method
        - url.full

  # Type 2: Triage Assessment
  - question: Is this outbound HTTP traffic part of legitimate application communication?
    context: Distinguishes between normal HTTP traffic and LURK C2 communication disguised as web traffic.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 80
        condition: selection
      fields:
        - http.request.method
        - url.path
        - http.response.status_code

  - question: Are there authorized applications on this system that use compressed HTTP communication?
    context: Validates if legitimate software explains the compressed data patterns over HTTP.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - "http"
            - "curl"
            - "wget"
        condition: selection
      fields:
        - User
        - Image
        - CommandLine

  # Type 3: Activity Context
  - question: What process initiated the outbound HTTP connection containing LURK protocol?
    context: Identifies the malware executable or compromised application establishing C2 communication.
    range: -15m
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  - question: What network activity preceded this LURK C2 communication attempt?
    context: Understanding initial infection vector and reconnaissance activities.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver
        - bytes_toclient

  - question: Are there multiple LURK communication attempts to different C2 servers?
    context: Reveals backup C2 infrastructure and persistence of malware communication.
    range: -2h/+2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature_id: 2014225
        condition: selection
      fields:
        - dst_ip
        - alert.signature

  # Type 4: Impact Assessment
  - question: Has the LURK Trojan successfully established command and control communication?
    context: Determines if attacker has active control capability for incident response prioritization.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - bytes_toclient

  - question: What data has been transmitted over the LURK C2 channel?
    context: Assesses potential data exfiltration or command execution performed via the trojan.
    range: +6h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.request.body.content
        - http.response.body.content
        - bytes_toserver
        - bytes_toclient

  # Type 5: Forensic Deep-Dive
  - question: What specific LURK Trojan variant and capabilities are indicated by the protocol signature?
    context: Variant analysis reveals attack objectives and potential attribution to specific threat groups.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - app_proto
        - proto

  - question: Are there file system artifacts indicating LURK Trojan installation or persistence?
    context: Identifies malware files and persistence mechanisms for complete system remediation.
    range: -4h/+4h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - ".exe"
            - ".dll"
            - ".tmp"
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.hash.sha256

  - question: What registry modifications indicate LURK persistence or configuration storage?
    context: Registry analysis reveals persistence mechanisms and trojan configuration details.
    range: -4h/+4h
    query: |
      aggregation: true
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - "Run"
            - "RunOnce"
            - "Service"
        condition: selection
      fields:
        - TargetObject
        - Details
        - EventType

  # Type 6: Enterprise Correlation
  - question: Are other systems showing LURK Trojan communication patterns?
    context: Identifies scope of trojan deployment and potential lateral movement across the enterprise.
    range: -24h/+24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature_id: 2014225
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature

  - question: Is this LURK activity part of a broader APT campaign or targeted financial attack?
    context: Correlates with other advanced threats to understand campaign scope and objectives.
    range: -7d/+1d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.category|contains:
            - "trojan-activity"
            - "command-and-control"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature