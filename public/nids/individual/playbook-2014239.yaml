name: ET MALWARE W32.Duptwux/Ganelp FTP Username - onthelinux
id: 22014239
description: |
  Detects W32.Duptwux/Ganelp malware using the characteristic "onthelinux" FTP username.
  This signature identifies a specific credential hardcoded in the malware for data exfiltration.
  May trigger on legitimate users with similar usernames, though this is highly unlikely.
type: detection
detection_id: 2014239
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete FTP authentication sequence using the "onthelinux" username?
    context: The full FTP login reveals the malware's hardcoded credentials and target server configuration.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - ftp.user
        - ftp.password
        - ftp.response_code

  - question: What FTP server and credentials were targeted by this malware authentication?
    context: Identifying the C2 infrastructure helps map the botnet's data collection and exfiltration capabilities.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - ftp.server_banner

  # Type 2: Triage Assessment
  - question: Is there any legitimate use of the "onthelinux" username in the organization?
    context: This highly specific username is characteristic of malware and unlikely to be used legitimately.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: ftp
      detection:
        selection:
          ftp.user: 'onthelinux'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - ftp.response_code

  - question: Does the infected system have authorized FTP access to external servers?
    context: Understanding system authorization helps determine if this represents unauthorized malware activity.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: ftp
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - ftp.user
        - ftp.response_code

  # Type 3: Activity Context
  - question: What process initiated the FTP connection with the malware-specific username?
    context: Identifying the malware executable helps understand the infection vector and system compromise.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'ftp'
            - 'onthelinux'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ProcessGuid
        - ParentImage

  - question: What data collection or file access activities preceded the FTP authentication?
    context: Duptwux/Ganelp malware typically harvests system information and user data before exfiltration.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size

  - question: Were there successful file uploads following the authentication attempt?
    context: Successful authentication may lead to data exfiltration activities using the compromised FTP credentials.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: ftp
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          ftp.command: 'STOR'
        condition: selection
      fields:
        - ftp.filename
        - ftp.file_size
        - ftp.response_code

  # Type 4: Impact Assessment
  - question: Did the malware successfully authenticate and establish data exfiltration capabilities?
    context: Successful FTP authentication indicates active data theft capabilities and ongoing compromise.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: ftp
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          ftp.user: 'onthelinux'
          ftp.response_code: '230'
        condition: selection
      fields:
        - ftp.response_text
        - ftp.working_directory

  - question: What types of files or data were uploaded to the attacker's FTP server?
    context: Understanding exfiltrated data helps assess breach impact and regulatory notification requirements.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: ftp
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          ftp.command: 'STOR'
        condition: selection
      fields:
        - ftp.filename
        - ftp.file_size
        - ftp.transfer_type

  # Type 5: Forensic Deep-Dive
  - question: What specific Duptwux/Ganelp variant is present on the compromised system?
    context: Different malware variants have varying data collection capabilities and persistence mechanisms.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - 'duptwux'
            - 'ganelp'
            - '.exe'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.hash.sha256
        - file.size

  - question: What persistence mechanisms has the malware established for continued operation?
    context: Understanding persistence helps ensure complete malware removal and prevents reinfection.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - 'Run'
            - 'RunOnce'
            - 'Services'
        condition: selection
      fields:
        - TargetObject
        - Details

  - question: Are there indicators of additional malware components or C2 communications?
    context: Duptwux/Ganelp infections may include multiple components with different communication methods.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.protocol
        - network.bytes_sent

  - question: What system information or credentials were potentially harvested by the malware?
    context: This malware family is known for collecting system details, passwords, and application data.
    range: -3h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - 'password'
            - 'credential'
            - 'config'
            - '.log'
        condition: selection
      fields:
        - TargetFilename
        - file.mime_type
        - file.size

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network showing similar Duptwux/Ganelp FTP activity?
    context: Malware campaigns often affect multiple systems through email attachments or exploit kits.
    range: -12h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: 'ET MALWARE W32.Duptwux/Ganelp FTP Username - onthelinux'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - ftp.user

  - question: Is this part of a broader malware distribution campaign targeting the organization?
    context: Understanding campaign scope helps identify attack vectors and implement appropriate countermeasures.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: ftp
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          ftp.user: 'onthelinux'
        condition: selection
      fields:
        - src_ip
        - ftp.response_code
        - ftp.filename