name: ET WEB_SPECIFIC_APPS pfile file.php id Parameter SELECT FROM SQL Injection Attempt
id: 22014253
description: |
  Detects SQL injection attempts targeting the pfile application's file.php script via the id parameter using SELECT FROM statements.
  May trigger on legitimate database queries but context suggests exploitation of vulnerable web application.
type: detection
detection_id: 2014253
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete SQL injection payload in the HTTP request?
    context: Understanding the exact injection syntax reveals attacker intent and targeted database schema.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.uri
        - http.request.method
        - http.request.body.content
        - url.query

  - question: Is this pfile application legitimately deployed on the target server?
    context: Determining if the application exists helps distinguish between targeted attacks and scanning attempts.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains: '/file.php'
        condition: selection
      fields:
        - src_ip
        - http.response.status_code
        - url.path

  - question: What other SQL injection patterns has this source IP attempted?
    context: Multiple injection attempts indicate systematic exploitation rather than accidental triggering.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: 'SQL Injection'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - http.uri

  - question: What was the sequence of HTTP requests leading to this injection attempt?
    context: Understanding the attack progression reveals reconnaissance and exploitation phases.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - http.request.method
        - url.path
        - http.response.status_code
        - http.request.referrer

  - question: Did the SQL injection attempt return database content or error messages?
    context: Successful data extraction or error-based information disclosure indicates compromise severity.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - http.response.bytes

  - question: Are there signs of successful database access or data exfiltration?
    context: Large response sizes or multiple successful requests may indicate data theft.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains: '/file.php'
          http.response.status_code: 200
        condition: selection
      fields:
        - http.response.bytes
        - url.query
        - http.response.body.content

  - question: What database management system is likely targeted based on injection syntax?
    context: SQL syntax variations help identify the backend database and potential impact scope.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.uri
        - rule.name
        - alert.signature

  - question: Has this attacker attempted to access administrative or sensitive database tables?
    context: Targeting system tables or user credentials indicates advanced exploitation attempts.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.query|contains:
            - 'information_schema'
            - 'mysql.user'
            - 'sys.'
            - 'admin'
            - 'password'
        condition: selection
      fields:
        - url.query
        - url.path
        - http.response.status_code

  - question: Are other web servers in the environment experiencing similar pfile exploitation attempts?
    context: Coordinated attacks across multiple servers indicate broader campaign scope.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'pfile'
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - http.uri

  - question: What is the geographic origin and reputation of the attacking IP address?
    context: IP reputation and location context helps assess threat actor profile and response priority.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.bytes
        - network.protocol