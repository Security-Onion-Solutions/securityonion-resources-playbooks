name: ET WEB_SPECIFIC_APPS pfile file.php id Parameter UNION SELECT SQL Injection Attempt
id: 22014255
description: |
  Detects SQL injection attempts targeting the pfile application's file.php script via the id parameter using UNION SELECT statements.
  UNION-based injection typically aims to extract sensitive data from database tables.
type: detection
detection_id: 2014255
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What data columns were targeted in the UNION SELECT injection payload?
    context: Understanding the UNION structure reveals what sensitive information the attacker seeks to extract.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.uri
        - url.query
        - http.request.body.content
        - alert.signature

  - question: Is the pfile application accessible and responding to legitimate requests?
    context: Confirming application availability helps distinguish between targeted attacks and scanning attempts.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains: '/file.php'
          http.response.status_code: 200
        condition: selection
      fields:
        - src_ip
        - url.query
        - http.response.bytes

  - question: What was the complete attack sequence leading to this UNION injection?
    context: Understanding the progression from reconnaissance to exploitation reveals attack sophistication.
    range: -45m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains: '/file.php'
        condition: selection
      fields:
        - http.request.method
        - url.query
        - http.response.status_code
        - http.response.bytes

  - question: Did the UNION SELECT attempt successfully return database content?
    context: Successful data extraction indicates confirmed compromise and potential data theft.
    range: +3m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
          http.response.status_code: 200
        condition: selection
      fields:
        - http.response.body.content
        - http.response.bytes
        - url.query

  - question: Has the attacker attempted to enumerate database schema or table structure?
    context: Schema enumeration indicates advanced exploitation techniques and systematic data extraction.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.query|contains:
            - 'information_schema'
            - 'table_name'
            - 'column_name'
            - 'database()'
            - 'version()'
        condition: selection
      fields:
        - url.query
        - http.response.status_code
        - http.response.bytes

  - question: What sensitive data types might have been exposed through UNION injection?
    context: Identifying potential data exposure helps determine breach notification and remediation requirements.
    range: +10m
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.query|contains:
            - 'password'
            - 'user'
            - 'email'
            - 'credit'
            - 'ssn'
            - 'phone'
        condition: selection
      fields:
        - url.query
        - http.response.bytes
        - http.response.status_code

  - question: Are there indicators of automated SQL injection tool usage?
    context: Tool signatures help identify attack sophistication and potential for widespread exploitation.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.headers.user_agent|contains:
            - 'sqlmap'
            - 'havij'
            - 'python'
            - 'curl'
        condition: selection
      fields:
        - http.request.headers.user_agent
        - dst_ip
        - url.path

  - question: Has the attacker attempted to access administrative or system tables?
    context: System table access indicates attempts to gain administrative privileges or system information.
    range: +20m
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.query|contains:
            - 'mysql.user'
            - 'pg_user'
            - 'sysobjects'
            - 'master.dbo'
            - 'admin'
        condition: selection
      fields:
        - dst_ip
        - url.query
        - http.response.status_code

  - question: Are other pfile installations across the network under similar attack?
    context: Coordinated exploitation across multiple servers indicates organized threat actor campaign.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'pfile'
          alert.signature|contains: 'UNION'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - http.uri

  - question: What is the attack infrastructure and TTPs associated with this source IP?
    context: Understanding attacker infrastructure helps with attribution and blocking additional threats.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains: 'web-application-attack'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - alert.signature