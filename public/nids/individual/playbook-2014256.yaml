name: ET WEB_SPECIFIC_APPS pfile file.php id Parameter INSERT INTO SQL Injection Attempt
id: 22014256
description: |
  Detects SQL injection attempts targeting the pfile application's file.php script via the id parameter using INSERT INTO statements.
  INSERT-based injection can be used to add malicious data, create backdoor accounts, or plant persistent threats.
type: detection
detection_id: 2014256
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What data is being inserted through the SQL injection payload?
    context: Understanding insertion content reveals whether attacker is creating backdoors, planting data, or establishing persistence.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.uri
        - url.query
        - http.request.body.content
        - alert.signature

  - question: Has this attacker previously enumerated the pfile application structure?
    context: Prior reconnaissance indicates targeted exploitation rather than opportunistic scanning.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains: '/file.php'
        condition: selection
      fields:
        - http.request.method
        - url.query
        - http.response.status_code
        - http.response.bytes

  - question: Was the INSERT statement successfully executed by the database?
    context: Successful insertion confirms compromise and potential for persistent backdoor installation.
    range: +2m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - http.response.bytes

  - question: Are there attempts to create administrative or privileged user accounts?
    context: Account creation through injection indicates attempt to establish persistent unauthorized access.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.query|contains:
            - 'admin'
            - 'root'
            - 'user'
            - 'password'
            - 'privilege'
            - 'role'
        condition: selection
      fields:
        - dst_ip
        - url.query
        - http.response.status_code

  - question: What table structure is being targeted for data insertion?
    context: Understanding target tables helps assess the scope of potential data contamination or backdoor placement.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.uri
        - url.query
        - rule.name

  - question: Has the attacker attempted to verify successful data insertion?
    context: Verification attempts indicate sophisticated attack methodology and confirm malicious intent.
    range: +15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains: '/file.php'
        condition: selection
      fields:
        - url.query
        - http.response.status_code
        - http.request.method

  - question: Are there signs of web shell or backdoor deployment through INSERT injection?
    context: Malicious file insertion can establish persistent access mechanisms requiring immediate remediation.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.query|contains:
            - 'shell'
            - 'backdoor'
            - 'eval'
            - 'exec'
            - 'system'
            - 'cmd'
        condition: selection
      fields:
        - dst_ip
        - url.path
        - url.query
        - http.response.status_code

  - question: What other malicious SQL operations has this source attempted?
    context: Multiple injection types indicate comprehensive database compromise attempts.
    range: -12h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: 'SQL Injection'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - alert.signature
        - http.uri

  - question: Are there coordinated INSERT injection attempts across multiple pfile installations?
    context: Enterprise-wide insertion attempts suggest systematic backdoor deployment campaign.
    range: -8h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'pfile'
          alert.signature|contains: 'INSERT'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - http.uri

  - question: What is the attack timeline and persistence strategy of this threat actor?
    context: Understanding attack duration and methods helps assess ongoing threat and required containment measures.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains: 'web-application-attack'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - alert.signature