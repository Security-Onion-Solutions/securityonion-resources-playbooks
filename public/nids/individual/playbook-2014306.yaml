name: ET MALWARE W32/Backdoor.BlackMonay Checkin
id: 22014306
description: |
  Detects W32/Backdoor.BlackMonay malware performing checkin communications to command and control servers.
  The malware sends banking information via HTTP POST with specific parameters and Chinese language headers.
  May trigger on legitimate applications using similar parameter patterns, though the specific combination is highly suspicious.
type: detection
detection_id: 2014306
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete HTTP request containing the BlackMonay checkin parameters?
    context: Understanding the full request reveals the banking data being exfiltrated and malware communication pattern.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.body.content
        - http.request.method
        - url.full
        - http.request.headers

  - question: What specific banking information was transmitted in the UserName, Bank, and Money parameters?
    context: Analyzing the parameter values helps determine what financial data was compromised.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.request.body.content
        - url.query

  # Type 2: Triage Assessment
  - question: Is this system known to run legitimate Chinese language applications that might use similar parameters?
    context: The zh-cn language header combined with banking parameters could indicate legitimate Chinese banking software.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.headers.accept-language|contains: "zh-cn"
        condition: selection
      fields:
        - url.domain
        - http.request.method
        - user_agent.original

  - question: Has this source system exhibited normal web browsing patterns to legitimate sites?
    context: Understanding baseline behavior helps distinguish between infected systems and legitimate Chinese language usage.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.domain
        - http.response.status_code

  # Type 3: Activity Context
  - question: What process initiated this HTTP connection on the source system?
    context: Identifying the parent process helps determine if this is malware execution or legitimate application behavior.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains: "http"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ParentImage

  - question: What other network connections occurred from this system around the same time?
    context: Concurrent connections may reveal additional C2 communications or lateral movement attempts.
    range: +/-30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.bytes_sent
        - network.bytes_received

  # Type 4: Impact Assessment
  - question: What sensitive files were accessed on the infected system recently?
    context: BlackMonay malware typically harvests banking credentials and financial documents from infected systems.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - "bank"
            - "finance"
            - "password"
            - "credential"
        condition: selection
      fields:
        - TargetFilename
        - Image
        - User

  - question: Has the malware established persistence mechanisms on the infected system?
    context: Understanding persistence helps determine cleanup requirements and reinfection risk.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - "Run"
            - "RunOnce"
            - "Services"
        condition: selection
      fields:
        - TargetObject
        - Details
        - Image

  # Type 5: Forensic Deep-Dive
  - question: What is the complete communication protocol used by this BlackMonay variant?
    context: Analyzing the full C2 protocol helps understand malware capabilities and develop detection signatures.
    range: +/-2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - http.request.method
        - url.path
        - http.request.body.content
        - http.response.status_code

  - question: Are there indicators of additional malware families or tools deployed alongside BlackMonay?
    context: BlackMonay infections often involve multiple malware families for comprehensive system compromise.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - "temp"
            - "appdata"
            - "programdata"
        condition: selection
      fields:
        - Image
        - CommandLine
        - file.hash.md5

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network communicating with the same C2 server?
    context: BlackMonay campaigns often target multiple systems within an organization simultaneously.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - network.bytes_sent
        - network.bytes_received

  - question: Have similar banking parameter patterns been observed from other internal systems?
    context: Identifying the scope of BlackMonay infections across the enterprise is critical for containment.
    range: +/-7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          url.query|contains:
            - "UserName="
            - "Bank="
            - "Money="
        condition: selection
      fields:
        - src_ip
        - url.domain
        - http.request.body.content