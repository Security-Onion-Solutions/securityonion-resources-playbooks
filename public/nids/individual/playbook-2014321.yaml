name: ET WEB_SPECIFIC_APPS b2evolution inc_path Parameter Remote File inclusion Attempt
id: 22014321
description: |
  Detects remote file inclusion (RFI) attempts targeting the b2evolution inc_path parameter in default.php.
  The attack attempts to include malicious remote files via HTTP, HTTPS, FTP, or PHP protocols to execute arbitrary code.
  May trigger on legitimate applications using remote includes, though external protocol usage is highly suspicious.
type: detection
detection_id: 2014321
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact remote file inclusion URL specified in the inc_path parameter?
    context: Understanding the malicious URL reveals the attacker's payload location and intended code execution.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.full
        - url.query
        - http.request.body.content

  - question: What protocol was used for the remote file inclusion attempt?
    context: Analyzing the protocol (HTTP, HTTPS, FTP, PHP) helps understand the attack vector and payload delivery method.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - url.query
        - http.request.method
        - user_agent.original

  - question: What is the domain or IP address hosting the malicious include file?
    context: Identifying the malicious host helps with threat intelligence and blocking additional attack attempts.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - url.query
        - http.request.headers

  # Type 2: Triage Assessment
  - question: Is this system a known b2evolution blog installation with legitimate remote include functionality?
    context: Some b2evolution configurations might legitimately use remote includes for plugins or themes.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains: "/blogs/"
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.response.status_code

  - question: Has this source IP previously accessed the b2evolution application through normal usage patterns?
    context: Understanding user behavior helps distinguish between legitimate users and external attackers.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.request.method
        - http.response.status_code

  # Type 3: Activity Context
  - question: What web application reconnaissance preceded this RFI attack attempt?
    context: Attackers typically probe for vulnerabilities and file structure before launching targeted RFI attacks.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.request.method
        - http.response.status_code
        - user_agent.original

  - question: What other parameters were tested for file inclusion vulnerabilities during this session?
    context: Understanding the full parameter testing helps identify the exploitation methodology and other vulnerable endpoints.
    range: +/-30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.query|contains:
            - "include"
            - "path"
            - "file"
            - "page"
        condition: selection
      fields:
        - url.path
        - url.query
        - http.response.status_code

  - question: Were there attempts to access the malicious remote file directly?
    context: Attackers often test remote payloads before including them in RFI attacks.
    range: +/-15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.bytes_received

  # Type 4: Impact Assessment
  - question: Did the RFI attempt result in successful remote code execution on the b2evolution server?
    context: Analyzing response codes and content helps determine if the file inclusion was successful.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - network.bytes_received

  - question: What processes were executed on the target system following this attack?
    context: Successful RFI would result in new process creation on the b2evolution server.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ParentImage

  - question: Were any files created or modified on the target system after the attack?
    context: Successful RFI might result in file system changes for persistence or data exfiltration.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - Image
        - User

  # Type 5: Forensic Deep-Dive
  - question: What is the complete attack pattern used against the b2evolution application?
    context: Understanding the full exploitation methodology helps develop comprehensive protection measures.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains: "blogs"
        condition: selection
      fields:
        - url.path
        - url.query
        - http.request.method
        - http.response.status_code

  - question: Are there indicators of automated scanning tools or manual testing techniques?
    context: Identifying attack tools helps understand the threat actor's capabilities and methods.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - user_agent.original
        - http.request.method
        - url.path

  - question: What other file inclusion vulnerabilities were tested during this attack session?
    context: RFI attacks are often part of broader web application testing for multiple file inclusion types.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.query|contains:
            - "http://"
            - "https://"
            - "ftp://"
            - "php://"
        condition: selection
      fields:
        - dst_ip
        - url.path
        - url.query

  # Type 6: Enterprise Correlation
  - question: Are other web applications in the environment being targeted with similar RFI attacks?
    context: Attackers often test file inclusion vulnerabilities across multiple web applications in the same environment.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.query|contains:
            - "include="
            - "path="
            - "file="
        condition: selection
      fields:
        - dst_ip
        - url.path
        - url.query

  - question: Has this attacker IP targeted other PHP applications or file inclusion parameters across the organization?
    context: Understanding the broader attack campaign helps identify other vulnerable systems and attack patterns.
    range: +/-7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains: ".php"
        condition: selection
      fields:
        - dst_ip
        - url.path
        - url.query
        - http.response.status_code