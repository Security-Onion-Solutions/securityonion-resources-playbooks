name: ET MALWARE Possible Zeus .ru CnC Domain Generation Algorithm (DGA) Lookup Detected
id: 22014376
description: |
  Detects DNS queries characteristic of Zeus malware Domain Generation Algorithm (DGA) targeting .ru domains.
  Indicates potential Zeus malware infection attempting to locate command and control servers through algorithmic domain generation.
type: detection
detection_id: 2014376
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact domain name queried that matched the Zeus DGA pattern?
    context: The specific domain reveals the DGA algorithm variant and potential campaign timing.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.resolved_ip
        - payload_printable

  - question: What DNS server was queried for this suspicious domain lookup?
    context: Identifies the DNS infrastructure being used and potential DNS hijacking or tunneling.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - src_ip
        - src_port

  # Type 2: Triage Assessment
  - question: Has this system previously generated other DGA-style domain queries?
    context: Confirms persistent malware infection versus isolated DNS anomaly.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.query.name|contains: ".ru"
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  - question: Are these DNS queries part of normal business operations or system administration?
    context: Legitimate applications may occasionally query .ru domains for business purposes.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.resolved_ip

  # Type 3: Activity Context
  - question: What process initiated these suspicious DNS queries?
    context: Identifying the querying process helps confirm malware presence and infection vector.
    range: +/-15m
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ProcessGuid
        - ParentImage

  - question: What other DNS queries occurred in the same timeframe as this DGA lookup?
    context: Zeus often queries multiple DGA domains to find active C2 servers.
    range: +/-30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  - question: Were any successful connections made to resolved IP addresses from these DNS queries?
    context: Successful connections indicate active C2 communication following DNS resolution.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection_state
        - bytes_toclient

  # Type 4: Impact Assessment
  - question: Did any of the DGA domains resolve to active IP addresses?
    context: Active resolutions indicate potential successful C2 server contact.
    range: +5m
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.query.name|contains: ".ru"
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.response_code

  - question: What data was potentially exfiltrated through successful C2 connections?
    context: Assesses the scope of data theft following successful malware communication.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver
        - bytes_toclient

  # Type 5: Forensic Deep-Dive
  - question: What specific Zeus variant and DGA algorithm characteristics are evident?
    context: The domain pattern and timing help identify the exact Zeus family and campaign.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - signature_severity
        - confidence
        - malware_family

  - question: What persistence mechanisms has this Zeus infection established?
    context: Identifies all components requiring removal during incident response.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessGuid
        - file.mime_type

  - question: What registry modifications indicate Zeus configuration or persistence?
    context: Registry changes reveal malware configuration and startup mechanisms.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessGuid

  # Type 6: Enterprise Correlation
  - question: Are other systems in the organization generating similar DGA domain queries?
    context: Identifies the scope of Zeus infection across the enterprise network.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Zeus"
        condition: selection
      fields:
        - src_ip
        - dns.query.name
        - rule.name