name: ET INFO HTTP OPTIONS invalid method case outbound
id: 22014382
description: |
  Detects HTTP OPTIONS method with invalid casing in outbound traffic.
  While RFC 2616 specifies uppercase method names, some applications may use lowercase.
  Could indicate malware, custom tools, or misconfigured applications attempting HTTP communication.
type: detection
detection_id: 2014382
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact HTTP method casing detected in the request?
    context: The specific casing pattern helps differentiate between legitimate applications and potential malware.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - alert.signature
        - payload_printable
        - flow.bytes_toclient
        - flow.bytes_toserver

  - question: What was the complete HTTP request structure and destination?
    context: Understanding the full request helps determine if this is legitimate application behavior or suspicious activity.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_port
        - dst_port
        - proto

  # Type 2: Triage Assessment
  - question: Is this HTTP behavior normal for this source system?
    context: Consistent patterns from the same host may indicate legitimate application behavior rather than malware.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method|contains:
            - 'options'
            - 'OPTIONS'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - dst_ip

  - question: Does the destination server typically receive OPTIONS requests?
    context: Some web applications legitimately use OPTIONS for CORS preflight checks or API discovery.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|expand: '%dst_port%'
          http.request.method|contains:
            - 'OPTIONS'
            - 'options'
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.response.status_code

  # Type 3: Activity Context
  - question: What other HTTP methods were used in related requests from this host?
    context: The pattern of HTTP methods reveals if this is part of normal web application behavior or suspicious scanning.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - http.request.method
        - url.path
        - http.response.status_code
        - user_agent.original

  - question: Were there any DNS queries for the destination domain around this time?
    context: DNS lookups provide context about how the host discovered the target server.
    range: +/-30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  - question: What processes were responsible for this HTTP traffic?
    context: Process information helps distinguish between legitimate applications and malicious tools.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  # Type 4: Impact Assessment
  - question: Did the server respond successfully to these malformed requests?
    context: Server responses indicate if the malformed requests were processed, potentially revealing application vulnerabilities.
    range: +/-5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - http.request.method

  - question: Are there signs of web application scanning or enumeration?
    context: Multiple HTTP methods or paths may indicate reconnaissance activity against web applications.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.request.method
        - http.response.status_code

  # Type 5: Forensic Deep-Dive
  - question: What user agent strings were associated with these requests?
    context: User agent analysis helps identify the specific tool or application generating the malformed requests.
    range: +/-1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - user_agent.original
        - http.request.method
        - url.full

  - question: Were there any file downloads or uploads associated with this HTTP activity?
    context: File transfers may indicate malware communication or data exfiltration attempts.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size
        - file.mime_type

  # Type 6: Enterprise Correlation
  - question: Are other hosts exhibiting similar HTTP method anomalies?
    context: Widespread malformed HTTP requests may indicate malware propagation or coordinated scanning activity.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: 'OPTIONS invalid method case'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature

  - question: What is the pattern of HTTP anomalies across the enterprise?
    context: Understanding HTTP protocol violations helps identify potential security tools or malware families.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.category: 'bad-unknown'
          alert.signature|contains: 'HTTP'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature