name: ET WEB_SPECIFIC_APPS Joomla com_phocadownload folder Parameter Remote File inclusion Attempt
id: 22014388
description: |
  Detects remote file inclusion (RFI) attacks targeting the Joomla Phocadownload component.
  Monitors for attempts to include malicious remote files through the folder parameter.
  May trigger on legitimate file operations that reference external resources.
type: detection
detection_id: 2014388
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact remote file URL being included in the folder parameter?
    context: Analyzing the malicious URL reveals the attacker's infrastructure and intended payload.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - url.query
        - http.request.body.content

  - question: What were the complete Joomla component parameters in this attack?
    context: Understanding all parameters helps determine attack sophistication and potential for code execution.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - url.path
        - url.query
        - http.request.headers
        - user_agent.original

  # Type 2: Triage Assessment
  - question: Is this normal Joomla administration activity for this user or system?
    context: Legitimate Joomla operations may involve file management but rarely reference external URLs.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains: 'com_phocadownload'
        condition: selection
      fields:
        - url.query
        - http.request.method
        - http.response.status_code

  - question: Does the timing align with documented Joomla maintenance windows?
    context: Administrative activities typically occur during scheduled maintenance periods.
    range: -2h/+2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains: 'joomla'
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.request.method

  # Type 3: Activity Context
  - question: What reconnaissance activities preceded this RFI attempt?
    context: RFI attacks often follow directory enumeration and vulnerability scanning of Joomla installations.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.category|contains:
            - 'attempted-recon'
            - 'web-application-attack'
        condition: selection
      fields:
        - rule.name
        - url.path
        - http.request.method

  - question: What was the sequence of Joomla component access attempts?
    context: Understanding attack progression reveals methodology and helps identify other vulnerable components.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains: 'com_'
        condition: selection
      fields:
        - url.path
        - url.query
        - http.response.status_code

  # Type 4: Impact Assessment
  - question: Did the remote file inclusion attack succeed in executing malicious code?
    context: HTTP response analysis helps determine if the malicious file was successfully included and executed.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes
        - http.response.headers

  - question: Are there signs of web shell deployment or persistent access?
    context: Successful RFI attacks often result in web shell installation for continued access.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains:
            - '.php'
            - 'shell'
            - 'cmd'
        condition: selection
      fields:
        - src_ip
        - url.path
        - url.query
        - http.request.method

  # Type 5: Forensic Deep-Dive
  - question: What malicious files or payloads were hosted on the attacker's infrastructure?
    context: Analyzing the remote file source helps identify attack tools and potential secondary payloads.
    range: -1h/+1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.question.name
        - dns.resolved_ip
        - dns.question.type

  - question: What other Joomla vulnerabilities were exploited on this system?
    context: Attackers often chain multiple vulnerabilities for comprehensive system compromise.
    range: -24h/+24h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: 'Joomla'
        condition: selection
      fields:
        - src_ip
        - rule.name
        - url.path
        - url.query

  # Type 6: Enterprise Correlation
  - question: Are other Joomla installations in the network being targeted?
    context: Attackers often scan for and exploit the same vulnerability across multiple systems.
    range: -24h/+24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'Joomla'
            - 'Remote File'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - url.domain

  - question: What other web applications are experiencing similar RFI attacks?
    context: RFI attack campaigns often target multiple CMS platforms and web applications.
    range: -7d/+1d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: 'Remote File'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - url.domain
        - url.path