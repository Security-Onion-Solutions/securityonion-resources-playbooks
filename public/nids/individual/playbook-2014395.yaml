name: ET WEB_SPECIFIC_APPS PHP Address Book from Parameter Cross Site Scripting Attempt
id: 22014395
description: |
  Detects cross-site scripting (XSS) attacks targeting the PHP Address Book application through the from parameter.
  Monitors for malicious script injection attempts in preference configuration requests.
  May trigger on legitimate form submissions containing HTML-like content or encoded data.
type: detection
detection_id: 2014395
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact XSS payload injected in the from parameter?
    context: Analyzing the malicious script content reveals attack intent and potential impact on address book users.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - url.query
        - http.request.body.content

  - question: What were the complete preference configuration parameters in this request?
    context: Understanding all parameters helps determine if this is a targeted attack or automated scanning.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - url.path
        - url.query
        - http.request.headers
        - user_agent.original

  # Type 2: Triage Assessment
  - question: Is this normal PHP Address Book usage for this user or system?
    context: Legitimate preference updates may contain encoded data but rarely include script elements.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains: 'preferences.php'
        condition: selection
      fields:
        - url.query
        - http.request.method
        - http.response.status_code

  - question: Does this activity align with normal business hours and user patterns?
    context: Legitimate preference changes typically occur during normal usage periods by authenticated users.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains: 'addressbook'
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.request.method

  # Type 3: Activity Context
  - question: What reconnaissance or scanning activities preceded this XSS attempt?
    context: XSS attacks often follow application enumeration and vulnerability identification activities.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.category|contains:
            - 'attempted-recon'
            - 'web-application-attack'
        condition: selection
      fields:
        - rule.name
        - url.path
        - http.request.method

  - question: What was the sequence of PHP Address Book access attempts?
    context: Understanding attack progression helps identify methodology and other potential vulnerabilities exploited.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains: '.php'
        condition: selection
      fields:
        - url.path
        - url.query
        - http.response.status_code

  # Type 4: Impact Assessment
  - question: Did the XSS attack succeed in executing malicious script content?
    context: HTTP response analysis helps determine if the malicious script was processed and potentially executed.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes
        - http.response.headers

  - question: Are there signs of session hijacking or credential theft following this attack?
    context: Successful XSS attacks may lead to session token theft or credential harvesting from other users.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          http.request.headers|contains: 'Cookie'
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.request.method
        - user_agent.original

  # Type 5: Forensic Deep-Dive
  - question: What other PHP Address Book vulnerabilities were exploited on this system?
    context: Attackers often chain multiple vulnerabilities for comprehensive application compromise.
    range: -24h/+24h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: 'PHP Address Book'
        condition: selection
      fields:
        - src_ip
        - rule.name
        - url.path
        - url.query

  - question: Are there indicators of persistent access or backdoor installation?
    context: Compromised address book applications may be used to establish ongoing access to contact data.
    range: +24h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains:
            - 'shell'
            - 'backdoor'
            - 'upload'
        condition: selection
      fields:
        - src_ip
        - url.path
        - url.query
        - http.request.method

  # Type 6: Enterprise Correlation
  - question: Are other PHP applications experiencing similar XSS attacks?
    context: XSS campaigns often target multiple PHP applications with similar vulnerability patterns.
    range: -24h/+24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'Cross Site Scripting'
            - 'XSS'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - url.domain

  - question: What other web applications are being targeted by this attacker?
    context: Understanding the broader attack scope helps identify campaign patterns and additional compromised systems.
    range: -7d/+1d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category: 'web-application-attack'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - url.domain
        - url.path