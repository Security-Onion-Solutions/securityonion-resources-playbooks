name: ET WEB_SPECIFIC_APPS EJBCA issuer Parameter Cross Site Scripting Attempt
id: 22014397
description: |
  Detects cross-site scripting (XSS) attempts targeting the EJBCA certificate authority web interface.
  Specifically monitors for malicious script injection in the issuer parameter of certificate distribution requests.
  May trigger on legitimate certificate requests containing similar patterns in certificate data.
type: detection
detection_id: 2014397
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact XSS payload injected in the issuer parameter?
    context: Analyzing the specific script content reveals attack intent and potential impact on certificate authority operations.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - url.query
        - http.request.body.content

  - question: What were the complete certificate distribution request parameters?
    context: Understanding all parameters helps determine if this is targeted exploitation or reconnaissance.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - url.path
        - url.query
        - http.request.headers
        - user_agent.original

  # Type 2: Triage Assessment
  - question: Is this normal certificate request activity for this user or system?
    context: Legitimate certificate operations may contain encoded data that resembles XSS patterns.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains: '/publicweb/webdist/certdist'
        condition: selection
      fields:
        - url.query
        - http.request.method
        - http.response.status_code

  - question: Does the timing align with normal certificate authority operations?
    context: Legitimate certificate requests typically follow business hours and administrative schedules.
    range: -1h/+1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 80
            - 443
            - 8080
            - 8443
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.request.method

  # Type 3: Activity Context
  - question: What other web application attacks preceded this XSS attempt?
    context: XSS attacks often follow reconnaissance or other exploitation attempts against the same target.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.category|contains:
            - 'web-application-attack'
            - 'attempted-recon'
        condition: selection
      fields:
        - rule.name
        - url.path
        - http.request.method

  - question: What was the sequence of requests leading to this attack?
    context: Understanding the attack progression helps identify reconnaissance patterns and attack methodology.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.request.method
        - http.response.status_code
        - user_agent.original

  # Type 4: Impact Assessment
  - question: Did the XSS attack succeed in executing malicious script?
    context: HTTP response codes and content help determine if the certificate authority processed the malicious request.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes
        - http.response.headers

  - question: Are there signs of session hijacking or credential theft following this attack?
    context: Successful XSS attacks may lead to administrator session compromise or certificate authority abuse.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          http.request.headers|contains: 'Cookie'
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.request.method
        - user_agent.original

  # Type 5: Forensic Deep-Dive
  - question: What certificate authority functions were targeted or accessed?
    context: Determining specific EJBCA modules accessed helps assess potential certificate infrastructure compromise.
    range: -1h/+1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains:
            - '/ejbca'
            - '/publicweb'
            - '/adminweb'
        condition: selection
      fields:
        - url.path
        - url.query
        - http.request.method
        - http.response.status_code

  - question: Are there indicators of certificate abuse or unauthorized issuance?
    context: Compromised certificate authorities may be used to issue fraudulent certificates for man-in-the-middle attacks.
    range: +24h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains:
            - 'certreq'
            - 'certdist'
            - 'certificate'
        condition: selection
      fields:
        - src_ip
        - url.query
        - http.request.method
        - http.response.status_code

  # Type 6: Enterprise Correlation
  - question: Are other certificate authorities or PKI infrastructure being targeted?
    context: PKI attacks often target multiple certificate authorities to maximize impact and persistence.
    range: -24h/+24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'EJBCA'
            - 'certificate'
            - 'PKI'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - url.domain

  - question: What other web applications are experiencing similar XSS attacks?
    context: Coordinated XSS campaigns may target multiple applications to establish broader network access.
    range: -7d/+1d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: 'Cross Site Scripting'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - url.domain
        - url.path