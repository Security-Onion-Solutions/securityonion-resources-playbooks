name: ET WORM W32/Rimecud wg.txt Checkin
id: 22014402
description: |
  Detects W32/Rimecud worm attempting to retrieve the wg.txt configuration file.
  This worm spreads through removable media and network shares, using HTTP to download updates.
  May trigger on legitimate applications accessing files named wg.txt.
type: detection
detection_id: 2014402
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete HTTP request pattern for the wg.txt file retrieval?
    context: Understanding the exact request structure helps identify the Rimecud worm variant and its C2 communication protocol.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - url.path
        - user_agent.original

  - question: What HTTP headers and connection details were used in the wg.txt request?
    context: Analyzing HTTP headers reveals the worm's communication characteristics and helps distinguish from legitimate traffic.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.request.headers
        - http.version
        - http.request.referrer

  # Type 2: Triage Assessment
  - question: Are there legitimate applications on this system that might access wg.txt files?
    context: Eliminates false positives from legitimate software that might use similar file naming conventions.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains: "wg.txt"
        condition: selection
      fields:
        - TargetFilename
        - Image
        - User

  - question: Is this system known to have removable media or network share access?
    context: Rimecud spreads through removable media and shares, helping validate the infection vector.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - "\\\\*"
            - "E:\\"
            - "F:\\"
            - "G:\\"
        condition: selection
      fields:
        - TargetFilename
        - EventType
        - Image

  # Type 3: Activity Context
  - question: What process initiated this HTTP request for the wg.txt configuration file?
    context: Identifying the requesting process helps determine how the worm executed and its persistence mechanism.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - "wg.txt"
            - "http"
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - User
        - ProcessGuid

  - question: What network activity preceded this worm checkin attempt?
    context: Understanding prior network connections helps identify the initial infection vector and worm propagation.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 80
            - 443
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - protocol
        - connection.state

  # Type 4: Impact Assessment
  - question: Did the C2 server successfully provide the wg.txt configuration update?
    context: Determines if the worm received new instructions or configuration updates from its command and control server.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes
        - http.response.body.content

  - question: Are there signs of worm propagation to other systems or removable media?
    context: Assesses whether the worm is actively spreading to other systems or devices on the network.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - "autorun.inf"
            - "*.exe"
          EventType: "FileCreate"
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size

  # Type 5: Forensic Deep-Dive
  - question: What is the complete behavioral pattern of this Rimecud worm variant?
    context: Provides comprehensive analysis of the worm's capabilities, propagation methods, and persistence mechanisms.
    range: -12h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "Rimecud"
            - "Worm"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - url.domain

  - question: What registry modifications or autorun entries were created by the worm?
    context: Identifies the worm's persistence mechanisms and system modifications for complete remediation.
    range: +/-2h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - "Run"
            - "RunOnce"
            - "Policies"
        condition: selection
      fields:
        - TargetObject
        - Details
        - EventType

  # Type 6: Enterprise Correlation
  - question: Are other systems showing similar Rimecud worm activity or wg.txt requests?
    context: Determines the scope of the worm infection across the organization and identifies propagation patterns.
    range: +/-6h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          url.path|contains: "/wg.txt"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - url.domain

  - question: Is this part of a broader worm outbreak affecting multiple network segments?
    context: Assesses the enterprise-wide impact and helps prioritize containment efforts for the worm infection.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - "Worm"
            - "Rimecud"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name