name: ET MALWARE OSX/Flashback.K/I reporting successful infection
id: 22014522
description: |
  Detects OSX/Flashback malware variants K and I reporting successful system infection to command and control servers.
  This specific URI pattern indicates the malware has successfully established persistence on a Mac system.
type: detection
detection_id: 2014522
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What system information is being transmitted in the successful infection report?
    context: Flashback typically sends system details, user information, and infection status to the C2 server.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.body.content
        - url.full
        - http.request.method
        - user_agent.original

  - question: What specific Flashback variant is indicated by the communication pattern?
    context: Different Flashback variants use slightly different C2 protocols and capabilities.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|endswith: "/stat_d/"
        condition: selection
      fields:
        - http.request.headers.user-agent
        - http.request.body.content
        - http.request.headers.accept

  # Type 2: Triage Assessment
  - question: Is this communication from a Mac system that should be in the environment?
    context: Confirms whether the infected system is a legitimate corporate Mac or unauthorized device.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          user_agent.original|contains: "Mac"
        condition: selection
      fields:
        - user_agent.original
        - dst_ip
        - url.path

  - question: Has this Mac system shown previous signs of compromise or suspicious activity?
    context: Determines if this is a new infection or ongoing compromise that was previously undetected.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains: "malware"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.category

  # Type 3: Activity Context
  - question: What was the infection vector that led to this successful Flashback compromise?
    context: Flashback commonly spreads through malicious Java applets or PDF exploits.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.response.mime_type|contains:
            - "application/pdf"
            - "application/java"
            - "application/x-java-applet"
        condition: selection
      fields:
        - url.full
        - http.response.mime_type
        - http.request.headers.referer

  - question: What web browsing activity preceded the successful infection?
    context: Understanding user behavior helps identify the attack vector and potential patient zero.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method: "GET"
        condition: selection
      fields:
        - url.full
        - http.request.headers.referer
        - user_agent.original

  # Type 4: Impact Assessment
  - question: What commands or additional payloads has the C2 server delivered post-infection?
    context: Successful infection reports often trigger delivery of additional malware components or commands.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - http.response.body.content
        - http.response.status_code
        - url.path

  - question: Has the infected Mac system attempted to download additional malware components?
    context: Flashback often downloads additional modules for data theft, keylogging, or system manipulation.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method: "GET"
        condition: selection
      fields:
        - dst_ip
        - url.full
        - http.response.mime_type
        - http.response.body.bytes

  # Type 5: Forensic Deep-Dive
  - question: What files and processes are associated with the Flashback infection on this system?
    context: Identifies the complete malware installation for effective remediation and forensic analysis.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - file.name
        - file.path
        - file.hash.md5
        - process.name

  - question: What persistence mechanisms has Flashback established on the infected Mac?
    context: Understanding persistence helps ensure complete malware removal and prevents reinfection.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          process.name|contains:
            - "launchd"
            - "cron"
            - "bash"
        condition: selection
      fields:
        - process.command_line
        - process.parent.name
        - user.name
        - process.working_directory

  - question: What data has been accessed or potentially exfiltrated by the Flashback malware?
    context: Flashback variants are known to steal browser data, credentials, and system information.
    range: +24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method: "POST"
        condition: selection
      fields:
        - dst_ip
        - url.path
        - http.request.body.bytes

  # Type 6: Enterprise Correlation
  - question: Are other Mac systems in the environment infected with Flashback variants?
    context: Identifies the scope of the Flashback campaign and potential lateral movement.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Flashback"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: What other Mac-specific threats are active in the environment alongside Flashback?
    context: Helps identify if this is part of a broader Mac-targeted campaign or isolated incident.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "OSX"
          rule.category|contains: "malware"
        condition: selection
      fields:
        - src_ip
        - rule.name
        - dst_ip