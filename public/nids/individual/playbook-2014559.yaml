name: ET WEB_SPECIFIC_APPS Free PHP photo gallery script path parameter Remote File inclusion Attempt
id: 22014559
description: |
  Detects Remote File Inclusion (RFI) attempts targeting the Free PHP photo gallery script via the 'path' parameter in adodb.inc.php.
  May trigger on legitimate remote file operations or CDN references using HTTP/HTTPS/FTP protocols.
type: detection
detection_id: 2014559
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What remote URL was specified in the path parameter for file inclusion?
    context: The target URL reveals the attacker's payload source and intended malicious file to include.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.body.content
        - url.full
        - url.query

  - question: What protocol scheme was used in the RFI attempt?
    context: Different protocols (HTTP, HTTPS, FTP, PHP) indicate varying attack sophistication and payload delivery methods.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - url.query
        - http.request.method
        - url.path

  # Type 2: Triage Assessment
  - question: Is the Free PHP photo gallery script legitimately installed on this server?
    context: Confirms if the targeted application exists and could be vulnerable to this specific attack.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains: '/jadro/libs/adodb/'
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.response.status_code

  - question: Are there legitimate file operations or includes on this web application?
    context: Normal application behavior helps distinguish between malicious RFI and legitimate remote file operations.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains: '.php'
          url.query|contains: 'path='
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.response.status_code

  # Type 3: Activity Context
  - question: What reconnaissance activity preceded this RFI attempt?
    context: Attackers often perform directory traversal or application fingerprinting before RFI attacks.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.request.method
        - http.response.status_code

  - question: Were there other file inclusion attempts or directory traversal attacks from this source?
    context: Multiple inclusion attempts suggest systematic exploitation or automated vulnerability scanning.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.query|contains:
            - 'path='
            - 'file='
            - 'include='
        condition: selection
      fields:
        - dst_ip
        - url.path
        - url.query

  # Type 4: Impact Assessment
  - question: Did the server successfully process the RFI request?
    context: A successful response may indicate the malicious file was included and executed on the server.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes
        - http.response.body.content

  - question: Are there signs of code execution or system compromise following the RFI attempt?
    context: Successful RFI often leads to web shell deployment or further system compromise activities.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.request.method
        - user_agent.original

  # Type 5: Forensic Deep-Dive
  - question: What specific malicious payload or web shell was the attacker attempting to include?
    context: Analyzing the remote file URL helps identify the attack payload and potential threat actor tools.
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          dns.query.name|expand: '%extracted_domain%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  - question: Are there indicators of automated RFI scanning tools or manual exploitation?
    context: User agent patterns and request timing help distinguish between automated tools and manual attacks.
    range: -15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - user_agent.original
        - url.path
        - http.request.headers

  # Type 6: Enterprise Correlation
  - question: Are other web applications in the environment being targeted with RFI attacks?
    context: Identifies if this is part of a broader RFI campaign against multiple web applications.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'Remote File'
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - url.path

  - question: Is this source IP conducting similar attacks against other targets in the network?
    context: Reveals the scope of the attack campaign and helps prioritize incident response efforts.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: 'WEB_SPECIFIC_APPS'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - url.path