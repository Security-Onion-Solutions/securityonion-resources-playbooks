name: ET MALWARE Mac Flashback Checkin 2
id: 22014598
description: |
  Detects Mac Flashback malware command and control communication via base64-encoded user agent strings.
  May trigger on legitimate applications using base64 user agents but highly suspicious pattern.
type: detection
detection_id: 2014598
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What does the base64-encoded user agent string decode to?
    context: Flashback malware uses encoded user agents to communicate system information to C2 servers.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.user_agent
        - url.full
        - http.request.method

  - question: What specific C2 server and path is being contacted?
    context: Identifying C2 infrastructure helps track Flashback campaign scope and takedown efforts.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.domain
        - dst_ip
        - url.path

  - question: Is this Mac system showing other signs of Flashback infection?
    context: Flashback creates multiple persistence mechanisms and network communications.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "Flashback"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - url.domain

  - question: What was the frequency and timing of these C2 communications?
    context: Regular beacon intervals indicate active malware infection requiring immediate response.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains: "/scheck/"
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - http.response.status_code

  - question: Did the C2 server respond with commands or updates?
    context: C2 responses may contain additional malware payloads or bot commands.
    range: +2m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - http.response.body.bytes

  - question: What processes are associated with this malicious network activity?
    context: Identifying the malware process helps with containment and removal efforts.
    range: -5m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: Are there signs of Flashback persistence mechanisms on this system?
    context: Flashback modifies system files and creates launch agents for persistence.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - "LaunchAgents"
            - ".plist"
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size

  - question: Has this system downloaded additional malware components?
    context: Flashback may download additional payloads or updates from C2 servers.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.mime_type|contains:
            - "application/octet-stream"
            - "application/x-executable"
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size

  - question: What sensitive data or credentials might be at risk on this Mac?
    context: Flashback can steal credentials and personal information from infected systems.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - "keychain"
            - "password"
            - "credential"
        condition: selection
      fields:
        - TargetFilename
        - User
        - file.size

  - question: Are other Mac systems in the network showing similar C2 communication?
    context: Flashback spreads through Java vulnerabilities and may infect multiple Mac systems.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains: "/scheck/"
        condition: selection
      fields:
        - src_ip
        - http.user_agent
        - http.response.status_code

  - question: Is this C2 infrastructure being used for other malware campaigns?
    context: C2 servers often host multiple malware families and campaigns simultaneously.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.category|contains: "command-and-control"
        condition: selection
      fields:
        - rule.name
        - src_ip
        - url.path