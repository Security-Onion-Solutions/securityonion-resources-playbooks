name: ET EXPLOIT_KIT Incognito Exploit Kit Java Request
id: 22014609
description: |
  Detects Incognito Exploit Kit Java exploitation attempts via requests to images.php with numeric parameters.
  Indicates drive-by download attacks targeting Java vulnerabilities through compromised or malicious websites.
type: detection
detection_id: 2014609
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the exact numeric parameter value in the images.php request?
    context: The numeric parameter may encode specific exploit payloads or target system fingerprinting data.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.full
        - url.query
        - http.request.method

  - question: Is this legitimate Java application traffic to a known business application?
    context: Corporate Java applications may legitimately access image resources with similar URL patterns.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.request.method: "GET"
        condition: selection
      fields:
        - url.domain
        - url.path
        - http.request.headers

  - question: What Java version and browser combination initiated this request?
    context: Specific Java versions have known vulnerabilities that exploit kits target for successful exploitation.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.headers
        - user_agent.original
        - http.request.body.content

  - question: What was the referring website that led to this exploit kit landing page?
    context: Referrer analysis reveals the infection vector, whether through malicious ads, compromised sites, or direct links.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method: "GET"
        condition: selection
      fields:
        - url.full
        - http.request.referrer
        - http.response.status_code

  - question: Did the exploit kit successfully deliver a malicious payload?
    context: Response analysis determines if the Java exploit executed and delivered malware to the victim system.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
          http.response.status_code: 200
        condition: selection
      fields:
        - http.response.body.content
        - network.bytes_received
        - http.response.mime_type

  - question: Are there signs of malware execution following the exploit attempt?
    context: Successful exploitation typically results in process creation, file writes, or network connections from malware.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - "java.exe"
            - "javaw.exe"
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  - question: What other exploit kit components were accessed during this session?
    context: Exploit kits typically serve multiple components including landing pages, exploits, and payload delivery mechanisms.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.domain|expand: '%dst_domain%'
        condition: selection
      fields:
        - url.path
        - http.request.method
        - http.response.status_code

  - question: Has this system shown other exploit kit or malware indicators?
    context: Systems targeted by exploit kits may be vulnerable to multiple attack vectors or already compromised.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - "exploit-kit"
            - "trojan-activity"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - alert.signature

  - question: What file downloads or modifications occurred after the exploit attempt?
    context: Successful exploitation often results in malware file creation, configuration changes, or additional payload downloads.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.extension|contains:
            - "exe"
            - "dll"
            - "jar"
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size

  - question: Are other enterprise systems being targeted by the same exploit kit infrastructure?
    context: Exploit kits often target multiple systems within an organization through various infection vectors.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.category: "exploit-kit"
        condition: selection
      fields:
        - src_ip
        - rule.name
        - url.domain

  - question: Is this part of a broader drive-by download campaign targeting Java vulnerabilities?
    context: Coordinated exploit kit campaigns may target specific software vulnerabilities across multiple organizational assets.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.category: "exploit-kit"
          alert.signature|contains: "Java"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name