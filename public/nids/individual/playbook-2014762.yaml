name: ET MALWARE W32/SpyBanker Infection Confirmation Email 2
id: 22014762
description: |
  Detects SpyBanker malware sending infection confirmation emails via SMTP.
  This banking trojan sends status updates to attackers confirming successful infections.
  Legitimate applications do not typically send emails with 'Infected' in the From field.
type: detection
detection_id: 2014762
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete email content that contained the infection confirmation?
    context: The full email reveals the malware variant and may contain system information sent to attackers.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - src_ip
        - dst_ip
        - smtp.from
        - smtp.to

  - question: What SMTP server was used to send this malicious confirmation email?
    context: Identifying the mail server helps understand the malware's communication infrastructure.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - smtp.server
        - community_id

  # Type 2: Triage Assessment
  - question: Is this system authorized to send emails through external SMTP servers?
    context: Many corporate environments restrict direct SMTP to prevent malware communications.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 25
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - connection_state

  - question: Does this system normally send emails or is this unusual behavior?
    context: Unexpected email activity from workstations often indicates malware infection.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 25
            - 587
            - 465
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver

  # Type 3: Activity Context
  - question: What process was responsible for sending this malicious email?
    context: Identifying the sending process helps determine the malware executable and infection vector.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: What other network activity occurred around the time of this email transmission?
    context: SpyBanker may perform additional malicious activities like credential theft or C&C communication.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver
        - bytes_toclient

  - question: Were there any banking or financial websites accessed before this email?
    context: SpyBanker targets banking credentials and may send confirmations after successful theft.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - url.domain

  # Type 4: Impact Assessment
  - question: Did the malware successfully send the confirmation email to the attacker?
    context: Successful transmission confirms active malware communication and potential data theft.
    range: +/-5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 25
        condition: selection
      fields:
        - connection_state
        - bytes_toserver
        - duration

  - question: What sensitive data might have been included in this confirmation email?
    context: Banking trojans often include system information, credentials, or financial data in status emails.
    range: +/-10m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.size
        - ProcessGuid

  # Type 5: Forensic Deep-Dive
  - question: What files were created or accessed that might contain stolen banking credentials?
    context: SpyBanker creates temporary files to store harvested credentials before transmission.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.hash.sha256
        - ProcessGuid

  - question: Are there registry modifications indicating banking trojan persistence or configuration?
    context: Banking malware often modifies registry keys to maintain persistence and store configuration.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessGuid
        - Image

  # Type 6: Enterprise Correlation
  - question: Are other systems showing similar SpyBanker infection confirmation activity?
    context: Banking trojans often spread through email campaigns affecting multiple users.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'SpyBanker'
            - 'Banking'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is this email server being used by other compromised systems in the network?
    context: Shared malicious infrastructure may indicate coordinated campaign or botnet activity.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 25
        condition: selection
      fields:
        - src_ip
        - bytes_toserver
        - connection_state