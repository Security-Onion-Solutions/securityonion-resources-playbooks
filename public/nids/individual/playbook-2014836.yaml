name: ET WEB_SPECIFIC_APPS DynPG CMS PathToRoot Parameter Remote File inclusion Attempt
id: 22014836
description: |
  Detects remote file inclusion (RFI) attempts targeting the DynPG CMS PathToRoot parameter.
  Attackers attempt to include malicious remote files to execute arbitrary code on the server.
  Legitimate usage would not include external URLs in this parameter.
type: detection
detection_id: 2014836
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What remote file URL was specified in the PathToRoot parameter?
    context: Identifies the malicious payload location and potential attacker infrastructure.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.full
        - url.query
        - http.request.method
        - http.user_agent

  - question: What protocol scheme was used in the remote file inclusion attempt?
    context: Determines the attack vector and helps identify the malicious file hosting method.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.query
        - http.request.body.content
        - http.request.referrer

  # Type 2: Triage Assessment
  - question: Is this a legitimate administrator configuring the DynPG CMS system?
    context: Determines if this could be authorized configuration activity rather than an attack.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains: 'admin'
        condition: selection
      fields:
        - url.path
        - http.user_agent
        - http.response.status_code

  - question: Does the source IP have a history of legitimate access to this CMS?
    context: Helps distinguish between authorized users and potential attackers.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.response.status_code
        - http.user_agent

  # Type 3: Activity Context
  - question: What reconnaissance or scanning activity preceded this RFI attempt?
    context: Identifies if the attacker performed enumeration to discover the vulnerable parameter.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.response.status_code
        - http.user_agent

  - question: Were there multiple RFI attempts or other web application attacks from this source?
    context: Reveals if this is part of a broader web application attack campaign.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains: 'web-application-attack'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - url.path

  # Type 4: Impact Assessment
  - question: Did the server successfully process the remote file inclusion request?
    context: Determines if the RFI attack was successful and code execution occurred.
    range: +2m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes
        - http.response.headers

  - question: Are there signs of code execution or system compromise following this attempt?
    context: Identifies if the RFI led to successful remote code execution on the server.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  # Type 5: Forensic Deep-Dive
  - question: What is hosted at the remote URL specified in the PathToRoot parameter?
    context: Identifies the malicious payload and its potential capabilities.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains: 'guestbookaction.php'
        condition: selection
      fields:
        - url.full
        - http.response.body.content
        - file.mime_type

  - question: Has this remote file inclusion vulnerability been exploited against other systems?
    context: Determines if this is part of a campaign targeting multiple DynPG CMS installations.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'DynPG'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - url.query

  # Type 6: Enterprise Correlation
  - question: Are other web applications in the organization being targeted with RFI attacks?
    context: Identifies scope of the attack campaign across enterprise web infrastructure.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'Remote File'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - host.hostname