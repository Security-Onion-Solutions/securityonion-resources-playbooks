name: ET EXPLOIT_KIT Likely TDS redirecting to exploit kit
id: 22014854
description: |
  Detects Traffic Direction System (TDS) redirection patterns commonly used to funnel victims to exploit kits.
  May trigger on legitimate URL shorteners but suspicious when using single-digit parameters.
type: detection
detection_id: 2014854
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the exact TDS redirection URL and parameter value?
    context: TDS systems use specific URL patterns to categorize and redirect victims to exploit kits.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.full
        - url.query
        - http.request.method

  - question: What domain is hosting this suspected TDS infrastructure?
    context: Identifying TDS domains helps track exploit kit distribution networks.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.domain
        - dst_ip
        - tls.server.certificate.subject

  - question: Is this user frequently accessing URL shorteners or redirect services?
    context: Legitimate users may access shorteners, but frequent TDS access suggests compromise.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains: ".php"
        condition: selection
      fields:
        - url.domain
        - url.path
        - http.response.status_code

  - question: What was the HTTP response and did it contain redirect instructions?
    context: TDS systems typically return 302 redirects or JavaScript redirects to exploit kits.
    range: +2m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - http.response.headers.location

  - question: Did the user follow the redirect to a secondary malicious site?
    context: Successful TDS redirection leads victims to exploit kit landing pages.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.domain
        - url.path
        - http.request.referrer

  - question: Are there signs of exploit kit activity following this TDS contact?
    context: TDS redirection typically leads to exploit kit exploitation attempts.
    range: +15m
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - "exploit-kit"
            - "malware"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - url.domain

  - question: What browser and plugins were exposed during this TDS interaction?
    context: TDS systems fingerprint browsers to determine appropriate exploit kit payloads.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.user_agent
        - http.request.headers.accept
        - http.request.headers.accept_language

  - question: Has malware been downloaded following this TDS redirection?
    context: Successful exploit kit delivery results in malware payload downloads.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.mime_type|contains:
            - "application/x-msdownload"
            - "application/octet-stream"
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size

  - question: Are there indicators of post-exploitation activity on this system?
    context: Successful exploit kit compromise leads to malware execution and persistence.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: What other systems have contacted this TDS infrastructure?
    context: TDS systems typically serve multiple victims across the network.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains: ".php"
        condition: selection
      fields:
        - src_ip
        - url.query
        - http.response.status_code

  - question: Is this TDS domain part of a larger malicious infrastructure?
    context: TDS domains often share hosting or registration patterns with other malicious sites.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          url.domain|expand: '%url.domain%'
        condition: selection
      fields:
        - rule.category
        - rule.name
        - src_ip