name: ET SQL MySQL mysql.user Dump (Used in Metasploit Auth-Bypass Module)
id: 22014910
description: |
  Detects attempts to dump MySQL user credentials using queries targeting the mysql.user table.
  This pattern is commonly used in Metasploit authentication bypass modules and SQL injection attacks.
  Legitimate database administration may occasionally query this table for user management.
type: detection
detection_id: 2014910
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete SQL query attempting to access the mysql.user table?
    context: The full query reveals the attack methodology and specific information the attacker is trying to extract.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - mysql.query

  - question: What authentication method was used to connect to the MySQL server?
    context: Understanding the authentication bypass technique helps identify the vulnerability being exploited.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 3306
        condition: selection
      fields:
        - mysql.username
        - mysql.auth_method
        - connection_state
        - bytes_in

  # Type 2: Triage Assessment
  - question: Is this connection from a known database administrator or application server?
    context: Legitimate database administration may require querying user tables for account management.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 3306
        condition: selection
      fields:
        - dst_ip
        - connection_count
        - mysql.username
        - bytes_exchanged

  - question: Are there scheduled maintenance windows or database administration tasks?
    context: Legitimate user management activities might explain the mysql.user table access.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'mysql'
            - 'mysqladmin'
            - 'phpmyadmin'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  # Type 3: Activity Context
  - question: What other database queries or operations preceded this user table access?
    context: Understanding the sequence of database operations reveals the attack progression and intent.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 3306
        condition: selection
      fields:
        - mysql.query
        - mysql.command
        - bytes_in
        - bytes_out

  - question: Were there any web application requests that might have triggered SQL injection?
    context: MySQL user dumps often result from SQL injection attacks through web applications.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.request.body.content
        - user_agent.original

  # Type 4: Impact Assessment
  - question: Was the mysql.user query successful and what data was returned?
    context: Successful queries indicate credential exposure and potential system compromise.
    range: -5m/+5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 3306
        condition: selection
      fields:
        - mysql.response_code
        - mysql.rows_affected
        - bytes_out
        - connection_state

  - question: What other database tables or schemas were accessed during this session?
    context: Attackers often enumerate multiple tables after gaining access to extract sensitive data.
    range: -1h/+1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 3306
        condition: selection
      fields:
        - mysql.query
        - mysql.database
        - mysql.table
        - bytes_out

  # Type 5: Forensic Deep-Dive
  - question: What is the source IP reputation and geolocation?
    context: Malicious database attacks often originate from known bad actors or suspicious geographic locations.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - src_ip
        - geoip.country_name
        - threat_intel.category
        - asn.organization

  - question: Are there signs of Metasploit framework usage or other penetration testing tools?
    context: The alert specifically mentions Metasploit modules, so identifying tool signatures is important.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'Metasploit'
            - 'Exploit'
            - 'Scanner'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - severity
        - user_agent.original

  - question: What MySQL server version and configuration details are exposed?
    context: Understanding the target system helps assess vulnerability and potential for further exploitation.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 3306
        condition: selection
      fields:
        - mysql.version
        - mysql.capabilities
        - mysql.charset
        - server.banner

  # Type 6: Enterprise Correlation
  - question: Are other MySQL servers in the network experiencing similar attack attempts?
    context: Database attacks often target multiple systems in coordinated campaigns.
    range: -4h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'MySQL'
            - 'SQL'
            - 'mysql.user'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - severity

  - question: Have there been other SQL injection or database exploitation attempts?
    context: MySQL user dumps often occur as part of broader SQL injection or database compromise campaigns.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'SQL'
            - 'Injection'
            - 'Database'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - rule.category