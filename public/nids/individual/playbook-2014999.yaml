name: ET MALWARE Zbot CnC POST /common/timestamps.php
id: 22014999
description: |
  Detects Zbot banking trojan command and control communication via POST to timestamps.php.
  This specific URI pattern is characteristic of Zbot malware beaconing to its C2 infrastructure.
type: detection
detection_id: 2014999
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete POST request sent to the Zbot C2 server?
    context: Understanding the full request reveals the malware's communication protocol and data exchange.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.full
        - http.request.body.content
        - http.request.headers

  - question: What data was transmitted in the POST body to timestamps.php?
    context: Analyzing the payload reveals stolen credentials, system information, or malware status updates.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.request.body.content
        - http.request.body.bytes
        - http.request.headers

  # Type 2: Triage Assessment
  - question: Is this system known to be infected with banking malware?
    context: Determines if this is a confirmed infection requiring immediate containment.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "Zbot"
            - "banking"
            - "trojan"
        condition: selection
      fields:
        - rule.name
        - dst_ip

  - question: Are there legitimate reasons for this system to contact the destination IP?
    context: Helps distinguish between malware C2 and legitimate business communications.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - network.bytes_sent
        - network.bytes_received

  # Type 3: Activity Context
  - question: What malware installation or execution preceded this C2 communication?
    context: Understanding the infection vector reveals how the Zbot malware was initially deployed.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  - question: What other C2 communication patterns occurred around this timestamp request?
    context: Reveals the full scope of the malware's communication with its command infrastructure.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.request.method: "POST"
        condition: selection
      fields:
        - url.path
        - http.request.body.bytes

  # Type 4: Impact Assessment
  - question: What sensitive data was potentially exfiltrated in this C2 session?
    context: Determines the scope of data compromise and regulatory notification requirements.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.request.method: "POST"
        condition: selection
      fields:
        - http.request.body.bytes
        - http.response.body.bytes
        - url.path

  - question: Did the infected system receive new commands or updates from the C2?
    context: Identifies if the malware received instructions for additional malicious activities.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - http.response.body.content
        - http.response.body.bytes
        - url.path

  # Type 5: Forensic Deep-Dive
  - question: What banking or financial applications were accessed by this infected system?
    context: Reveals the malware's target applications and potential financial fraud scope.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - "chrome.exe"
            - "firefox.exe"
            - "iexplore.exe"
        condition: selection
      fields:
        - User
        - CommandLine
        - ProcessGuid

  - question: What persistence mechanisms were established by the Zbot malware?
    context: Identifies how the malware maintains presence on the infected system.
    range: -48h
    query: |
      aggregation: true
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - "Run"
            - "RunOnce"
            - "Services"
        condition: selection
      fields:
        - TargetObject
        - Details

  - question: What credentials or certificates were potentially harvested by the malware?
    context: Determines the scope of credential compromise requiring password resets.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - "cookies"
            - "passwords"
            - "certificates"
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network showing similar Zbot C2 communications?
    context: Identifies the scope of the banking trojan infection across the enterprise.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Zbot CnC"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name