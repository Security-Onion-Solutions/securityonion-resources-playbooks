name: ET INFO PTUNNEL INBOUND
id: 22016146
description: |
  Detects inbound PTUNNEL traffic which uses ICMP packets to create covert tunnels.
  PTUNNEL can be used legitimately for network testing but is commonly abused for data exfiltration and bypassing firewalls.
type: detection
detection_id: 2016146
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What is the complete ICMP packet structure and payload that triggered this PTUNNEL detection?
    context: Analyzing the ICMP packet details reveals if this is legitimate ping traffic or covert tunneling activity.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - icmp.type
        - icmp.code
        - payload
        - packet.size

  - question: What is the frequency and pattern of ICMP traffic from this source IP?
    context: PTUNNEL creates distinctive patterns of ICMP traffic that differ from normal ping operations.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          protocol: icmp
        condition: selection
      fields:
        - dst_ip
        - bytes_sent
        - bytes_received

  # Type 2: Triage Assessment
  - question: Is this ICMP traffic part of legitimate network diagnostics or monitoring?
    context: Normal ping operations have different characteristics than tunneling attempts.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          protocol: icmp
        condition: selection
      fields:
        - src_ip
        - connection_count

  - question: Does this source IP have a history of normal network administration activities?
    context: Legitimate administrators may use various network tools including tunneling software.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - protocol

  # Type 3: Activity Context
  - question: What other network connections were established by this source IP around the same time?
    context: PTUNNEL usage often accompanies other network reconnaissance or data transfer activities.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - protocol
        - bytes_transferred

  - question: Are there any DNS queries from this source that might indicate tunneling preparation?
    context: Attackers often perform reconnaissance before establishing covert channels.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.resolved_ip

  # Type 4: Impact Assessment
  - question: How much data has been transferred through this potential ICMP tunnel?
    context: Data volume indicates whether this is reconnaissance, command and control, or active data exfiltration.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          protocol: icmp
        condition: selection
      fields:
        - total_bytes
        - connection_count

  - question: Are there signs of successful data exfiltration or command execution following this tunnel establishment?
    context: Successful tunneling often leads to further malicious activities on the compromised system.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  # Type 5: Forensic Deep-Dive
  - question: What specific PTUNNEL variant or configuration is being used based on packet analysis?
    context: Different PTUNNEL implementations have distinct signatures that help identify the tool and intent.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: PTUNNEL
        condition: selection
      fields:
        - rule.name
        - payload_hex
        - packet_info

  - question: Are there any file transfers or process executions on the target system that correlate with tunnel activity?
    context: Successful tunneling often results in file drops or process execution on the target system.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessName

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network showing similar PTUNNEL or ICMP tunneling activity?
    context: Attackers often establish multiple tunnel endpoints for redundancy and broader access.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: PTUNNEL
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert_count