name: ET SNMP missing community string attempt 1
id: 22016178
description: |
  Detects SNMP requests with missing community strings, indicating potential reconnaissance or exploitation attempts.
  This pattern may occur during SNMP enumeration attacks or misconfigured SNMP clients.
type: detection
detection_id: 2016178
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What is the complete SNMP packet structure that triggered this missing community string detection?
    context: Analyzing the malformed SNMP packet reveals the specific enumeration technique being used.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - packet.size
        - snmp.version

  - question: What SNMP operations were being attempted in these malformed requests?
    context: Understanding the intended SNMP operation helps determine if this is reconnaissance or exploitation.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 161
        condition: selection
      fields:
        - bytes_sent
        - bytes_received
        - protocol

  # Type 2: Triage Assessment
  - question: Is this source IP authorized to perform SNMP management operations?
    context: Legitimate network management systems should have proper SNMP community strings configured.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 161
        condition: selection
      fields:
        - dst_ip
        - connection_count

  - question: Are there successful SNMP connections from this source IP with valid community strings?
    context: Comparing failed attempts with successful connections helps distinguish misconfiguration from attacks.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 161
          bytes_received: '>100'
        condition: selection
      fields:
        - dst_ip
        - total_bytes
        - connection_count

  # Type 3: Activity Context
  - question: What other network scanning or enumeration activities preceded this SNMP attempt?
    context: SNMP enumeration often follows port scanning and service discovery activities.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - protocol
        - connection_state

  - question: Are there DNS queries for SNMP-related hostnames or MIB lookups from this source?
    context: Attackers often perform DNS reconnaissance before targeting SNMP services.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.resolved_ip

  # Type 4: Impact Assessment
  - question: How many SNMP-enabled devices has this source IP attempted to contact?
    context: The scope of SNMP enumeration indicates whether this is targeted or broad network reconnaissance.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 161
        condition: selection
      fields:
        - dst_ip
        - unique_destinations

  - question: Were any SNMP devices compromised or did they respond with sensitive information?
    context: Successful SNMP enumeration can reveal network topology and device configurations.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 161
          bytes_received: '>500'
        condition: selection
      fields:
        - dst_ip
        - bytes_received
        - response_data

  # Type 5: Forensic Deep-Dive
  - question: What specific SNMP enumeration tools or techniques are being used based on packet patterns?
    context: Different SNMP scanning tools have distinctive packet structures and timing patterns.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: SNMP
        condition: selection
      fields:
        - rule.name
        - alert_count
        - dst_ip

  - question: Are there any successful authentications or data retrievals following these failed attempts?
    context: Attackers may eventually find valid community strings or exploit SNMP vulnerabilities.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 161
          bytes_received: '>1000'
        condition: selection
      fields:
        - dst_ip
        - bytes_received
        - session_duration

  # Type 6: Enterprise Correlation
  - question: Are other systems showing similar SNMP enumeration attempts from different source IPs?
    context: Coordinated SNMP scanning may indicate a broader network reconnaissance campaign.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - "SNMP missing community"
            - "SNMP"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert_count

  - question: What is the geographic or network distribution of SNMP enumeration sources?
    context: Understanding attack distribution helps identify if this is part of automated scanning or targeted attacks.
    range: -48h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_port: 161
        condition: selection
      fields:
        - src_ip
        - unique_sources
        - connection_count