name: ET MALWARE Win32/Enchanim C2 Injection Download
id: 22016771
description: |
  Detects Win32/Enchanim malware receiving injection payloads from command and control server.
  The specific data injection markers indicate active payload delivery for web injection attacks.
  Legitimate applications would not use these specific injection control sequences.
type: detection
detection_id: 2016771
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete injection payload delivered in this C2 communication?
    context: Understanding the injection data reveals target websites and attack methodology.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - tcp.payload

  - question: What URL was specified in the set_url command for injection targeting?
    context: The target URL identifies which websites or services are being attacked through injection.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - http.request.body.content

  - question: What are the specific data injection markers and their sequence in this payload?
    context: Injection markers reveal the malware's web modification capabilities and attack structure.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - tcp.payload

  # Type 2: Triage Assessment
  - question: Is this inbound connection from a known malicious C2 infrastructure?
    context: Confirming C2 server reputation helps validate the malicious nature of this communication.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - orig_bytes
        - resp_bytes

  # Type 3: Activity Context
  - question: What process on the infected host established this C2 connection?
    context: Identifying the malware process helps understand infection vector and system compromise scope.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid

  - question: What other C2 communications occurred before this injection download?
    context: Previous communications reveal the full attack sequence and data exfiltration activities.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - orig_bytes
        - resp_bytes
        - duration
        - conn_state

  - question: Were there DNS queries for the C2 server domain before this connection?
    context: DNS resolution timing helps establish the complete attack timeline and infrastructure usage.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dns.resolved_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.resolved_ip

  # Type 4: Impact Assessment
  - question: Has the infected host subsequently accessed financial or banking websites?
    context: Post-infection web activity reveals if the injection payload has been deployed against targets.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.domain
        - url.path
        - http.request.method

  - question: What volume of data was transferred in this injection download session?
    context: Data transfer size indicates the complexity and scope of the injection payload received.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - orig_bytes
        - resp_bytes
        - duration
        - conn_state

  # Type 5: Forensic Deep-Dive
  - question: What files were created or modified after receiving this injection payload?
    context: File system changes reveal payload persistence and configuration storage locations.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.mime_type

  - question: Are there browser process modifications indicating web injection activation?
    context: Browser process changes confirm successful injection payload deployment and active web attacks.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - 'iexplore.exe'
            - 'firefox.exe'
            - 'chrome.exe'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid

  # Type 6: Enterprise Correlation
  - question: Are other hosts receiving similar injection payloads from this C2 server?
    context: Multiple infected hosts indicate widespread Enchanim campaign requiring coordinated response.
    range: -24h/+2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - orig_bytes
        - resp_bytes
        - conn_state