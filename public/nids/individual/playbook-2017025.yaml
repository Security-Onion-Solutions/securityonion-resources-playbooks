name: ET ATTACK_RESPONSE Net User Command Response
id: 22017025
description: |
  Detects responses from 'net user' command execution indicating successful user enumeration.
  May trigger on legitimate administrative activities but often indicates reconnaissance.
  The specific format suggests remote command execution or lateral movement attempts.
type: detection
detection_id: 2017025
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete net user command response captured in network traffic?
    context: Full response content reveals which users were enumerated and system configuration details.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - rule.name

  - question: What network protocol carried this command response?
    context: Protocol analysis helps determine if this was SMB, RDP, or other remote administration method.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - proto
        - app_proto
        - dst_port

  # Type 2: Triage Assessment
  - question: Is this user enumeration part of documented administrative activity?
    context: Legitimate system administration may involve user account auditing during business hours.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - 'net.exe'
            - 'net1.exe'
        condition: selection
      fields:
        - User
        - CommandLine
        - Image

  - question: Does the timing align with scheduled maintenance or audit procedures?
    context: Authorized user enumeration typically occurs during planned maintenance windows.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - bytes_toserver
        - bytes_toclient

  # Type 3: Activity Context
  - question: What preceded this user enumeration command execution?
    context: Prior activity reveals attack progression and initial compromise vector.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - bytes_toserver
        - bytes_toclient
        - duration

  - question: What authentication events occurred before this command execution?
    context: Authentication patterns indicate whether this represents lateral movement or authorized access.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - 'winlogon.exe'
            - 'lsass.exe'
        condition: selection
      fields:
        - User
        - CommandLine
        - ProcessGuid

  # Type 4: Impact Assessment
  - question: What additional reconnaissance commands were executed after user enumeration?
    context: Follow-up commands indicate attacker intent and scope of information gathering.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - 'net.exe'
            - 'whoami.exe'
            - 'ipconfig.exe'
        condition: selection
      fields:
        - CommandLine
        - User
        - ProcessGuid

  - question: Were any privilege escalation attempts made following user discovery?
    context: User enumeration often precedes privilege escalation or account compromise attempts.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          CommandLine|contains:
            - 'runas'
            - 'elevate'
            - 'admin'
        condition: selection
      fields:
        - CommandLine
        - User
        - Image

  # Type 5: Forensic Deep-Dive
  - question: What user accounts were specifically enumerated in this reconnaissance?
    context: Targeted user analysis reveals attacker interest in specific privileged accounts.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - rule.name

  - question: What remote administration tools or sessions were active during this period?
    context: Concurrent remote sessions indicate potential unauthorized access methods.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 3389
            - 5985
            - 22
        condition: selection
      fields:
        - src_ip
        - dst_port
        - bytes_toserver
        - bytes_toclient

  # Type 6: Enterprise Correlation
  - question: Are other systems showing similar user enumeration activity?
    context: Coordinated reconnaissance across multiple systems indicates broader attack campaign.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'Net User Command'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: What other reconnaissance indicators are present enterprise-wide?
    context: User enumeration is typically part of broader discovery phase requiring comprehensive analysis.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'reconnaissance'
            - 'enumeration'
            - 'discovery'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name