name: ET MALWARE OSX/Leverage.A Checkin
id: 22017525
description: |
  Detects OSX/Leverage.A malware command and control communication containing system information.
  Triggers on specific binary patterns followed by RAM usage data being transmitted to external servers.
  Legitimate system monitoring tools may generate similar patterns but are uncommon in this format.
type: detection
detection_id: 2017525
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete payload containing the RAM usage information?
    context: Understanding the full system data being transmitted reveals the extent of information disclosure.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - alert.signature

  - question: What specific RAM usage pattern was detected in the transmission?
    context: The malware sends system memory information in a specific format that can reveal system specifications.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - flow.bytes_toserver
        - flow.bytes_toclient

  # Type 2: Triage Assessment
  - question: Is this system known to run legitimate system monitoring software?
    context: Authorized monitoring tools might generate similar network patterns but typically use different protocols.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 80
            - 443
            - 8080
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto

  - question: Has this source system exhibited normal administrative activity recently?
    context: Legitimate system administration might involve system information gathering but through different channels.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - system_profiler
            - top
            - ps
            - vm_stat
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  # Type 3: Activity Context
  - question: What network activity preceded this malware checkin?
    context: Understanding the infection vector or trigger event helps establish the attack timeline.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto
        - bytes_toserver

  - question: What processes were running on the infected system during the checkin?
    context: Active processes can reveal the malware's execution context and potential persistence mechanisms.
    range: +/-15m
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ProcessGuid
        - ParentImage

  # Type 4: Impact Assessment
  - question: What system information was successfully transmitted to the command server?
    context: Determining data exfiltration helps assess the scope of information compromise.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - flow.bytes_toserver
        - flow.bytes_toclient
        - tcp.flags

  - question: Are there signs of additional data exfiltration beyond system information?
    context: The malware may be transmitting more than just RAM usage data in subsequent communications.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - bytes_toserver
        - bytes_toclient
        - duration

  # Type 5: Forensic Deep-Dive
  - question: What file system artifacts indicate OSX/Leverage.A persistence?
    context: This malware family typically establishes persistence through specific file locations and launch mechanisms.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - LaunchAgents
            - LaunchDaemons
            - .plist
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessName

  - question: What command and control infrastructure is being used?
    context: Identifying C2 servers helps understand the threat actor's infrastructure and enables blocking.
    range: +/-30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  # Type 6: Enterprise Correlation
  - question: Are other macOS systems in the environment showing similar malware communication patterns?
    context: OSX/Leverage.A may spread laterally or be part of a broader campaign targeting macOS systems.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: "OSX/Leverage"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature

  - question: Is this part of a coordinated attack against macOS systems in the organization?
    context: Multiple infected systems may indicate a targeted campaign or lateral movement within the network.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains:
            - "MALWARE"
            - "OSX"
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - alert.signature
        - alert.category