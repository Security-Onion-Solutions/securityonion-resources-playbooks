name: ET MALWARE W32/Kegotip CnC Beacon
id: 22017627
description: |
  Detects W32/Kegotip malware command and control beacon communications.
  Triggers on specific base64-encoded beacon patterns used by Kegotip for C2 communication.
  Legitimate applications would not use this specific encoded beacon pattern.
type: detection
detection_id: 2017627
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete base64-encoded beacon content that triggered this detection?
    context: The specific base64 pattern reveals the Kegotip communication protocol and potential command structure.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - rule.name
        - alert.signature

  - question: What are the network connection characteristics for this Kegotip C2 session?
    context: Connection metadata helps identify the malware's communication patterns and data transfer volumes.
    range: -5m/+5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_port
        - dst_port
        - proto
        - bytes_toserver
        - bytes_toclient
        - duration

  # Type 2: Triage Assessment
  - question: Is this system authorized to communicate with the destination on high ports?
    context: Some legitimate applications may use high port numbers for communication, requiring validation.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port|gte: 1024
        condition: selection
      fields:
        - dst_port
        - count
        - first_seen
        - last_seen

  - question: Does this beacon activity occur during expected operational hours?
    context: Malware C2 beacons often operate continuously, unlike legitimate applications with business hour patterns.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - hour_of_day
        - day_of_week
        - count

  # Type 3: Activity Context
  - question: What process initiated this Kegotip beacon connection?
    context: Identifying the parent process helps distinguish between legitimate applications and malware infections.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - User
        - ProcessGuid

  - question: What DNS queries preceded this C2 connection?
    context: DNS resolution patterns reveal the infrastructure being contacted and potential domain generation algorithms.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  - question: What other network connections were established around this beacon?
    context: Kegotip malware may establish multiple connections for different purposes during infection and operation.
    range: -10m/+10m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto
        - connection_state
        - bytes_toserver

  # Type 4: Impact Assessment
  - question: What volume of data has been transmitted through this C2 channel?
    context: Large data transfers may indicate data exfiltration or payload downloads from the C2 server.
    range: -2h/+2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - sum_bytes_toserver
        - sum_bytes_toclient
        - max_bytes_toserver
        - connection_count

  - question: Are there signs of persistent Kegotip beacon activity?
    context: Regular beacon intervals and persistent connections indicate successful malware installation and ongoing C2.
    range: -6h/+6h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - connection_state
        - avg_duration
        - count
        - beacon_interval

  # Type 5: Forensic Deep-Dive
  - question: Are there file system artifacts associated with Kegotip malware installation?
    context: File analysis reveals malware persistence mechanisms and additional payload components.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - 'kegotip'
            - 'temp'
            - 'appdata'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.hash.sha256
        - file.size

  - question: What registry modifications were made during the infection timeframe?
    context: Registry changes reveal malware persistence mechanisms and system configuration modifications.
    range: -1h/+1h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetObject
        - Details
        - EventType

  # Type 6: Enterprise Correlation
  - question: Are other systems showing similar Kegotip malware activity?
    context: Identifying campaign scope helps understand the extent of compromise and prioritize response efforts.
    range: -24h/+24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'Kegotip'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - count