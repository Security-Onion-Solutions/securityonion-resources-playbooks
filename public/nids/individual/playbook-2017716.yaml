name: ET MALWARE Athena Bot Nick in IRC
id: 22017716
description: |
  Detects Athena DDoS botnet IRC communication through characteristic nickname patterns.
  Triggers on IRC NICK commands with specific encoded system information format.
  Legitimate IRC clients use different nickname patterns and don't encode system details.
type: detection
detection_id: 2017716
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete IRC NICK command and encoded system information?
    context: The nickname contains encoded system details that reveal the bot's configuration and target system specs.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - alert.signature
        - flow.bytes_toserver

  - question: What system architecture and OS version is encoded in the nickname?
    context: Athena bots encode Windows version and architecture information that helps classify the infected system.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - src_ip
        - dst_ip

  # Type 2: Triage Assessment
  - question: Is this system authorized to use IRC for legitimate business purposes?
    context: Most corporate environments restrict IRC usage, making any IRC traffic potentially suspicious.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 6667
            - 6668
            - 6669
            - 194
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver

  - question: Has this user or system been approved for IRC client usage?
    context: Legitimate IRC usage should be documented and approved through IT policies.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - irc
            - mirc
            - hexchat
            - pidgin
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  # Type 3: Activity Context
  - question: What network activity led to the IRC connection establishment?
    context: Understanding how the bot connected helps identify the infection vector or trigger mechanism.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto
        - duration

  - question: What processes initiated the IRC communication?
    context: Identifying the parent process helps understand how the malware was executed and maintains persistence.
    range: +/-30m
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid

  - question: What DNS queries preceded the IRC server connection?
    context: DNS lookups can reveal the C2 infrastructure and help identify additional malicious domains.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  # Type 4: Impact Assessment
  - question: What DDoS capabilities has the bot registered with the IRC server?
    context: Athena bots typically announce their attack capabilities during IRC registration.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 6667
        condition: selection
      fields:
        - bytes_toserver
        - bytes_toclient
        - duration

  - question: Are there signs of DDoS attack preparation or execution?
    context: The bot may have received commands to participate in distributed attacks against targets.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver
        - conn_state

  # Type 5: Forensic Deep-Dive
  - question: What file system artifacts indicate Athena bot installation?
    context: Athena malware typically drops specific files and creates persistence mechanisms on infected systems.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessName
        - file.size

  - question: What registry modifications support the malware's persistence?
    context: Athena bots often modify Windows registry for autostart and configuration storage.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - Run
            - RunOnce
            - CurrentVersion
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessName

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network showing Athena botnet activity?
    context: Botnets often spread laterally or infect multiple systems through the same attack vector.
    range: +/-6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: "Athena"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature

  - question: Is this part of a broader IRC-based malware campaign?
    context: Multiple IRC connections to the same server may indicate a coordinated botnet operation.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 6667
        condition: selection
      fields:
        - src_ip
        - bytes_toserver
        - duration