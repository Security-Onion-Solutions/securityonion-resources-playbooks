name: ET MALWARE PWS Win32/Lmir.BMQ checkin
id: 22017724
description: |
  Detects PWS:Win32/Lmir.BMQ password stealing malware using ICMP for command and control.
  Triggers on specific ICMP packets containing the signature text "This's Ping Packet!".
  Legitimate ICMP traffic does not contain this specific payload pattern.
type: detection
detection_id: 2017724
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete ICMP payload containing the malware signature?
    context: The specific payload reveals the malware's communication protocol and potential encoded data.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - icmp.type
        - icmp.code

  - question: What is the exact size and structure of the malicious ICMP packet?
    context: The 19-byte packet size is characteristic of this malware family and helps confirm the detection.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - packet.length
        - payload
        - ip.len

  # Type 2: Triage Assessment
  - question: Is this system authorized to send custom ICMP packets?
    context: Most systems only send standard ping requests, making custom ICMP payloads highly suspicious.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          proto: icmp
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - packets_toserver

  - question: Has this system exhibited normal network diagnostic activity recently?
    context: Legitimate network troubleshooting might involve ping utilities but with standard payloads.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - ping.exe
            - tracert.exe
            - pathping.exe
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  # Type 3: Activity Context
  - question: What network activity preceded the malicious ICMP communication?
    context: Understanding the infection vector helps identify how the password stealer was delivered.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto
        - bytes_toserver

  - question: What processes were active during the ICMP malware communication?
    context: Identifying concurrent processes helps understand the malware's execution context and capabilities.
    range: +/-15m
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ProcessGuid
        - ParentImage

  - question: What triggered the malware to initiate ICMP-based checkin?
    context: Password stealers often communicate after harvesting credentials or on scheduled intervals.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - password
            - credential
            - login
            - .dat
        condition: selection
      fields:
        - TargetFilename
        - ProcessName
        - file.size

  # Type 4: Impact Assessment
  - question: What credential harvesting activity occurred before the ICMP communication?
    context: PWS malware typically steals passwords before communicating with command servers.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - AppData
            - passwords
            - cookies
            - logins.json
        condition: selection
      fields:
        - TargetFilename
        - ProcessName
        - file.hash.md5

  - question: Are there signs of data exfiltration beyond the ICMP checkin?
    context: The malware may use multiple channels to transmit stolen credentials and system information.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 80
            - 443
            - 21
            - 25
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver

  # Type 5: Forensic Deep-Dive
  - question: What file system artifacts indicate Win32/Lmir.BMQ installation?
    context: This malware family creates specific files and registry entries for persistence and credential storage.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessName
        - file.mime_type

  - question: What registry modifications support the malware's persistence and configuration?
    context: Password stealers often modify registry keys for autostart and to store harvested credentials.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - Run
            - Software
            - CurrentVersion
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessName

  - question: What browser and application credential stores were accessed?
    context: Win32/Lmir variants target specific applications and browsers for credential harvesting.
    range: +/-3h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - Chrome
            - Firefox
            - Internet Explorer
            - Outlook
        condition: selection
      fields:
        - TargetFilename
        - ProcessName
        - file.size

  # Type 6: Enterprise Correlation
  - question: Are other systems showing similar ICMP-based malware communication?
    context: Password stealers may spread through the network or be part of a coordinated credential harvesting campaign.
    range: +/-12h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: "Lmir"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature

  - question: Is this part of a broader credential theft campaign targeting the organization?
    context: Multiple infected systems may indicate lateral movement or a coordinated attack on organizational credentials.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains:
            - "PWS"
            - "password"
            - "credential"
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - alert.signature
        - alert.category