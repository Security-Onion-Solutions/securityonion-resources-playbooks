name: ET MALWARE Possible SSH Linux.Fokirtor backchannel command
id: 22017727
description: |
  Detects Linux.Fokirtor backdoor using SSH for covert command and control communication.
  Triggers on base64-encoded commands sent through SSH connections from external sources.
  Legitimate SSH administration typically doesn't use this specific encoding pattern.
type: detection
detection_id: 2017727
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete base64-encoded command sent through the SSH connection?
    context: Decoding the base64 payload reveals the actual backdoor commands being executed on the compromised system.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - ssh.client.version
        - ssh.server.version

  - question: What specific covert communication protocol markers were detected?
    context: The ":!;." pattern indicates the backdoor's custom protocol for command transmission.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - flow.bytes_toserver
        - tcp.flags

  # Type 2: Triage Assessment
  - question: Is this external SSH connection authorized for this system?
    context: Legitimate SSH access should be documented and typically comes from known administrative networks.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 22
        condition: selection
      fields:
        - src_ip
        - bytes_toserver
        - duration

  - question: Has this external IP been previously authorized for SSH access?
    context: Checking historical SSH connections helps determine if this is a new unauthorized access attempt.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 22
        condition: selection
      fields:
        - dst_ip
        - duration
        - bytes_toclient

  # Type 3: Activity Context
  - question: What authentication method was used for this SSH session?
    context: Understanding how the attacker gained SSH access helps identify compromised credentials or vulnerabilities.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 22
        condition: selection
      fields:
        - duration
        - bytes_toserver
        - bytes_toclient

  - question: What processes were spawned during or after the SSH backdoor communication?
    context: Backdoor commands typically result in process execution that can reveal the attacker's objectives.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ProcessGuid
        - ParentImage

  - question: What network reconnaissance or lateral movement followed the backdoor access?
    context: Attackers often use backdoor access to explore the network and identify additional targets.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto
        - bytes_toserver

  # Type 4: Impact Assessment
  - question: What system commands were executed through the backdoor channel?
    context: Analyzing command execution helps determine the scope of system compromise and data access.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - /bin/bash
            - /bin/sh
            - /usr/bin/
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: Are there signs of data exfiltration through the SSH tunnel?
    context: SSH backdoors often facilitate data theft through encrypted channels that bypass network monitoring.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
          dst_port: 22
        condition: selection
      fields:
        - bytes_toserver
        - bytes_toclient
        - duration

  # Type 5: Forensic Deep-Dive
  - question: What file system modifications indicate Linux.Fokirtor persistence mechanisms?
    context: This backdoor typically installs persistence through modified system files and startup scripts.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetFilename|contains:
            - /etc/
            - /var/
            - /tmp/
            - .ssh/
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessName

  - question: What SSH configuration changes support the backdoor's access?
    context: Backdoors often modify SSH configurations to maintain persistent access and avoid detection.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetFilename|contains:
            - sshd_config
            - authorized_keys
            - known_hosts
        condition: selection
      fields:
        - TargetFilename
        - ProcessName
        - file.size

  - question: What log tampering or anti-forensic activities occurred?
    context: Advanced backdoors often attempt to hide their presence by modifying or deleting system logs.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetFilename|contains:
            - /var/log/
            - auth.log
            - secure
            - wtmp
        condition: selection
      fields:
        - TargetFilename
        - ProcessName
        - file.size

  # Type 6: Enterprise Correlation
  - question: Are other Linux systems showing similar SSH backdoor activity?
    context: Linux.Fokirtor may spread laterally using compromised credentials or exploit additional vulnerabilities.
    range: +/-6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: "Fokirtor"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature

  - question: Is this part of a coordinated attack against SSH infrastructure?
    context: Multiple SSH compromise attempts may indicate a campaign targeting organizational Linux systems.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 22
        condition: selection
      fields:
        - dst_ip
        - duration
        - bytes_toserver