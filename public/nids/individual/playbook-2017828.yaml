name: ET WEB_SERVER Perl/Mambo.WebShell Spreader IRC Scanning Message
id: 22017828
description: |
  Detects Perl/Mambo webshell spreading malware through IRC communication about port scanning.
  Triggers on IRC PRIVMSG containing "Scanning for open ports" indicating automated spreading activity.
  Legitimate IRC usage does not typically involve automated port scanning announcements.
type: detection
detection_id: 2017828
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete IRC message about port scanning activity?
    context: The full message reveals the scope and targets of the automated scanning being performed by the webshell.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - alert.signature
        - flow.bytes_toserver

  - question: What specific IRC channel or target received the scanning notification?
    context: Understanding the communication channel helps identify the threat actor's infrastructure and coordination methods.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - dst_ip
        - dst_port

  # Type 2: Triage Assessment
  - question: Is this web server authorized to make outbound IRC connections?
    context: Web servers typically should not initiate IRC communications, making this activity highly suspicious.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 6667
            - 6668
            - 6669
            - 194
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - duration

  - question: Has this web server exhibited normal administrative activity recently?
    context: Legitimate web server maintenance should not involve IRC clients or port scanning tools.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - httpd
            - apache
            - nginx
            - iis
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  # Type 3: Activity Context
  - question: What web application compromise preceded the IRC communication?
    context: Understanding the initial compromise vector helps identify vulnerable applications and attack methods.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.request.method
        - http.response.status_code

  - question: What processes were spawned on the web server during the compromise?
    context: Webshell execution typically involves spawning system processes for reconnaissance and spreading.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ProcessGuid
        - ParentImage

  - question: What port scanning activity was performed before the IRC notification?
    context: The webshell likely conducted actual port scans before announcing the results through IRC.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - duration
        - conn_state

  # Type 4: Impact Assessment
  - question: What systems and ports were successfully identified during the scanning?
    context: Understanding scan results helps assess the potential for lateral movement and additional compromises.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          conn_state: SF
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - service

  - question: Are there signs of webshell spreading to other discovered systems?
    context: The malware may attempt to compromise additional systems identified through port scanning.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method: POST
        condition: selection
      fields:
        - dst_ip
        - url.path
        - http.request.body.content

  # Type 5: Forensic Deep-Dive
  - question: What webshell files were uploaded or modified on the compromised server?
    context: Identifying webshell artifacts helps understand the attack vector and enables cleanup efforts.
    range: +/-3h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - .php
            - .asp
            - .jsp
            - .pl
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessName

  - question: What IRC infrastructure is being used for command and control?
    context: Identifying C2 servers helps understand the threat actor's infrastructure and enables blocking.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  - question: What automated spreading tools were deployed by the webshell?
    context: Understanding the malware's spreading mechanisms helps predict and prevent additional compromises.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - nmap
            - nc
            - telnet
            - wget
            - curl
        condition: selection
      fields:
        - Image
        - CommandLine
        - ProcessGuid

  # Type 6: Enterprise Correlation
  - question: Are other web servers showing similar webshell and IRC activity?
    context: Webshell spreaders often target multiple servers using the same vulnerabilities and techniques.
    range: +/-8h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains:
            - "WebShell"
            - "Mambo"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature

  - question: Is this part of a coordinated campaign against web infrastructure?
    context: Multiple compromised web servers may indicate a broader attack targeting organizational web applications.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 6667
            - 6668
            - 6669
        condition: selection
      fields:
        - src_ip
        - duration
        - bytes_toserver