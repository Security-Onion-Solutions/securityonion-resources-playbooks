name: ET WEB_SERVER Perl/Mambo.WebShell Spreader IRC No Open Ports Message
id: 22017830
description: |
  Detects IRC communication from compromised web servers reporting no open ports found during network reconnaissance.
  This indicates webshell activity performing network scanning, even when no vulnerable services are discovered.
type: detection
detection_id: 2017830
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What network ranges did the webshell attempt to scan?
    context: Understanding scan targets reveals the scope of reconnaissance and potential lateral movement attempts.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - alert.signature
        - payload_printable
        - flow_id
  - question: Is this web server authorized to perform network scanning activities?
    context: Web servers typically should not conduct network reconnaissance unless part of authorized security testing.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto
        - conn_state
  - question: What scanning techniques were employed before this IRC report?
    context: Identifying scan methods helps understand the webshell's capabilities and detection evasion techniques.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.category|contains:
            - 'scan'
            - 'reconnaissance'
        condition: selection
      fields:
        - dst_ip
        - alert.signature
        - alert.severity
  - question: Has this compromised server reported successful scans to IRC previously?
    context: Comparing scan results helps understand the webshell's reconnaissance campaign and success rate.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains:
            - 'Open port'
            - 'Mambo'
            - 'WebShell'
        condition: selection
      fields:
        - dst_ip
        - alert.signature
        - alert.timestamp
  - question: What IRC channel is receiving these reconnaissance reports?
    context: IRC channel information helps identify the command and control infrastructure and other compromised systems.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port|expand: '%dst_port%'
        condition: selection
      fields:
        - bytes_toserver
        - bytes_toclient
        - duration
        - community_id
  - question: Are there signs of privilege escalation attempts on this server?
    context: Failed port scans may indicate the webshell is attempting to gain higher privileges for better network access.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'sudo'
            - 'su -'
            - 'runas'
            - 'whoami'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid
  - question: What webshell files are present on this compromised system?
    context: Identifying webshell artifacts helps with forensic analysis and ensures complete removal during remediation.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.name|contains:
            - 'mambo'
            - 'shell'
            - 'bot'
        condition: selection
      fields:
        - file.name
        - file.path
        - file.hash.md5
        - file.size
  - question: Has the IRC server issued new scanning commands after this report?
    context: Command and control responses may provide new targets or scanning instructions to the compromised server.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
          src_ip|expand: '%dst_ip%'
          src_port|expand: '%dst_port%'
        condition: selection
      fields:
        - bytes_toclient
        - bytes_toserver
        - duration
  - question: Are other compromised systems reporting similar scan failures?
    context: Multiple failed scans may indicate network segmentation is effective or targets are properly hardened.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature: 'ET WEB_SERVER Perl/Mambo.WebShell Spreader IRC No Open Ports Message'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.timestamp
  - question: What network security controls blocked the scanning attempts?
    context: Understanding which defenses were effective helps validate security architecture and identify gaps.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
          alert.action: 'blocked'
        condition: selection
      fields:
        - src_ip
        - alert.signature
        - alert.category
        - alert.action