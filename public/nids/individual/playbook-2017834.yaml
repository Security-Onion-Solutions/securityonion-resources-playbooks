name: ET WEB_SERVER Mambo.PerlBot Spreader IRC DDOS Mambo Scanning Message
id: 22017834
description: |
  Detects IRC communications from compromised web servers infected with Mambo.PerlBot malware scanning for vulnerable Mambo CMS installations.
  This indicates the server is compromised and participating in botnet activities.
type: detection
detection_id: 2017834
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete IRC message content containing the Mambo scanning notification?
    context: The full IRC PRIVMSG reveals the bot's communication pattern and target identification.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - alert.signature
        - src_ip
        - dst_ip

  - question: What IRC channel or target was receiving the scanning notifications?
    context: Understanding the IRC communication structure helps identify the botnet's command and control infrastructure.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_port
        - dst_port
        - proto

  # Type 2: Triage Assessment
  - question: Is this web server authorized to make outbound IRC connections?
    context: Web servers typically should not initiate IRC connections, indicating compromise.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 6667
            - 6697
            - 194
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto

  - question: Are there documented maintenance activities involving IRC protocols on this server?
    context: Legitimate IRC usage from web servers would be highly unusual and documented.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 6667
            - 6697
            - 194
        condition: selection
      fields:
        - dst_ip
        - timestamp
        - bytes_out

  # Type 3: Activity Context
  - question: What web application processes were running when the IRC communication occurred?
    context: Identifying the compromised web application helps understand the attack vector.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - httpd
            - apache
            - nginx
            - php
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: What network connections were established around the time of the IRC communication?
    context: Additional connections may reveal the full scope of botnet communication and malicious activity.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto
        - bytes_out
        - bytes_in

  # Type 4: Impact Assessment
  - question: Has the compromised server successfully identified vulnerable Mambo installations?
    context: Successful scanning indicates the bot is actively contributing to the botnet's reconnaissance efforts.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains:
            - mambo
            - administrator
            - components
        condition: selection
      fields:
        - dst_ip
        - url.full
        - http.response.status_code

  - question: What data has been transmitted through the IRC channel since compromise?
    context: Volume of IRC traffic indicates the extent of botnet participation and data exfiltration.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 6667
            - 6697
            - 194
        condition: selection
      fields:
        - dst_ip
        - bytes_out
        - bytes_in

  # Type 5: Forensic Deep-Dive
  - question: What Mambo.PerlBot variant is installed on the compromised server?
    context: Identifying the specific malware variant helps understand capabilities and persistence mechanisms.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - .pl
            - .php
            - bot
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size

  - question: How is the malware maintaining persistence on the web server?
    context: Understanding persistence mechanisms is crucial for complete remediation.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - cron
            - perl
            - php
            - wget
            - curl
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  # Type 6: Enterprise Correlation
  - question: Are other web servers in the network showing similar IRC communication patterns?
    context: Botnet infections often spread across multiple systems in the same network.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_port|contains:
            - 6667
            - 6697
            - 194
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - bytes_out