name: ET WEB_SERVER Mambo.PerlBot Spreader IRC DDOS Exploited Message
id: 22017835
description: |
  Detects IRC communications from compromised web servers infected with Mambo.PerlBot malware reporting successful exploitation of target systems.
  This indicates active botnet participation and successful compromise of additional systems.
type: detection
detection_id: 2017835
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete IRC message reporting successful exploitation?
    context: The full IRC PRIVMSG reveals the bot's success metrics and target information.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - alert.signature
        - src_ip
        - dst_ip

  - question: How many systems were reported as successfully exploited in this message?
    context: The count of exploited boxes indicates the scale of the botnet expansion.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_port
        - dst_port
        - bytes_out

  # Type 2: Triage Assessment
  - question: Is this web server authorized to participate in distributed computing activities?
    context: Legitimate distributed computing would be documented and not use IRC protocols.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 6667
            - 6697
            - 194
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto

  - question: Are there any legitimate security testing activities that could generate this traffic?
    context: Authorized penetration testing might generate similar patterns but would be documented.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - bytes_in

  # Type 3: Activity Context
  - question: What exploitation activities preceded this success notification?
    context: Understanding the attack sequence helps identify the exploitation method used.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method: POST
        condition: selection
      fields:
        - dst_ip
        - url.full
        - http.request.body.content
        - http.response.status_code

  - question: What processes were spawned during the exploitation timeframe?
    context: New processes may indicate successful payload execution on compromised systems.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - perl
            - php
            - sh
            - bash
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  # Type 4: Impact Assessment
  - question: What is the scope of systems compromised by this botnet member?
    context: The number of exploited systems indicates the botnet's growth and impact.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto
        - bytes_out

  - question: Are the newly compromised systems now participating in botnet activities?
    context: Successful exploitation should result in new botnet members becoming active.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains:
            - Mambo.PerlBot
            - IRC
            - botnet
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature

  # Type 5: Forensic Deep-Dive
  - question: What exploitation techniques were used to compromise the reported systems?
    context: Understanding attack methods helps improve defensive measures and threat hunting.
    range: -4h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains:
            - mambo
            - admin
            - upload
            - shell
        condition: selection
      fields:
        - dst_ip
        - url.full
        - http.request.method
        - http.response.status_code

  - question: What malware payloads were delivered to the exploited systems?
    context: Identifying payloads helps understand the full impact and required remediation steps.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - .pl
            - .php
            - bot
            - shell
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size

  - question: How is the botnet coordinating distributed attacks across compromised systems?
    context: Understanding coordination mechanisms helps predict and prevent future attacks.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 6667
            - 6697
            - 194
        condition: selection
      fields:
        - dst_ip
        - bytes_out
        - bytes_in

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network reporting similar exploitation success?
    context: Multiple compromised systems indicate a broader network compromise requiring coordinated response.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains:
            - Exploited
            - botnet
            - IRC
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature