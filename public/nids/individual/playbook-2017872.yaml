name: ET COINMINER W32/BitCoinMiner.MultiThreat Stratum Protocol Mining.Notify Initial Connection Server Response
id: 22017872
description: |
  Detects initial server response in Stratum mining protocol indicating cryptocurrency mining activity.
  May indicate unauthorized mining malware or legitimate mining operations depending on context.
type: detection
detection_id: 2017872
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete Stratum protocol mining.notify message received?
    context: The full Stratum message reveals mining pool details and work assignment parameters.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - alert.signature
        - src_ip
        - dst_ip

  - question: What mining pool server is providing the work assignments?
    context: Identifying the mining pool helps determine if this is legitimate or malicious mining activity.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_port
        - dst_port
        - proto

  - question: What specific cryptocurrency work is being assigned to the client?
    context: The mining.notify parameters indicate the type of cryptocurrency being mined and difficulty level.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 3333
            - 4444
            - 8332
            - 9332
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - bytes_in
        - bytes_out

  # Type 2: Triage Assessment
  - question: Is cryptocurrency mining authorized on this system?
    context: Many organizations prohibit cryptocurrency mining due to resource consumption and security risks.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 3333
            - 4444
            - 8332
            - 9332
            - 14444
        condition: selection
      fields:
        - src_ip
        - dst_port
        - bytes_out

  - question: Does this system have legitimate mining software installed?
    context: Authorized mining would typically involve documented software installations and configurations.
    range: -7d
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - miner
            - cgminer
            - bfgminer
            - xmrig
            - claymore
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  # Type 3: Activity Context
  - question: What process initiated the connection to the mining pool?
    context: Understanding the parent process helps determine if mining was user-initiated or automated.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid
        - ParentImage

  - question: What network activity preceded the mining pool connection?
    context: Previous network activity may reveal how the mining software was downloaded or installed.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto
        - bytes_in
        - bytes_out

  - question: Were there any file downloads or installations before mining activity began?
    context: Malicious miners are often downloaded from external sources or installed via exploit kits.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetFilename|contains:
            - .exe
            - miner
            - crypto
            - coin
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size

  # Type 4: Impact Assessment
  - question: What is the volume of mining traffic and resource consumption?
    context: High-volume mining traffic indicates significant resource hijacking and potential performance impact.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 3333
            - 4444
            - 8332
            - 9332
        condition: selection
      fields:
        - dst_ip
        - bytes_out
        - bytes_in

  - question: How long has the mining activity been ongoing?
    context: Duration of mining activity indicates the extent of resource hijacking and potential revenue loss.
    range: +24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          alert.signature|contains:
            - COINMINER
            - mining
            - stratum
        condition: selection
      fields:
        - src_ip
        - alert.signature
        - alert.severity

  # Type 5: Forensic Deep-Dive
  - question: What specific mining malware family is responsible for this activity?
    context: Identifying the malware family helps understand persistence mechanisms and removal procedures.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.hash.sha256
        - file.size

  - question: How is the mining malware maintaining persistence on the system?
    context: Understanding persistence mechanisms is crucial for complete malware removal.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetObject|contains:
            - Run
            - RunOnce
            - Service
            - Task
        condition: selection
      fields:
        - TargetObject
        - Details

  - question: What mining pools and wallet addresses are being used?
    context: Wallet addresses and mining pools can be used for threat intelligence and attribution.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 3333
            - 4444
            - 8332
            - 9332
        condition: selection
      fields:
        - dst_ip
        - dst_port

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network also performing cryptocurrency mining?
    context: Mining malware often spreads laterally or is part of coordinated campaigns affecting multiple systems.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains:
            - COINMINER
            - mining
            - stratum
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature