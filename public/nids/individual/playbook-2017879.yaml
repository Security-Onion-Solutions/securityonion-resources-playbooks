name: ET COINMINER W32/BitCoinMiner.MultiThreat Getblocktemplate Protocol Server Coinbasetxn Begin Mining Response
id: 22017879
description: |
  Detects Bitcoin mining protocol responses containing getblocktemplate with coinbasetxn data.
  May indicate cryptocurrency mining activity or legitimate Bitcoin node operations.
type: detection
detection_id: 2017879
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete Bitcoin mining protocol response payload?
    context: Understanding the full getblocktemplate response reveals mining pool configuration and target block data.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - alert.signature
        - flow_id

  - question: Is this system authorized to perform cryptocurrency mining operations?
    context: Legitimate mining operations should be documented and authorized by IT policy.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature
        - timestamp

  - question: What initiated the connection to this Bitcoin mining server?
    context: Understanding the connection origin helps determine if mining activity is user-initiated or malware-driven.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_port
        - dst_port
        - community_id

  - question: What processes are running on the source system that could initiate mining?
    context: Identifying mining software helps distinguish between legitimate tools and malicious miners.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: Are there other Bitcoin mining protocol communications from this host?
    context: Multiple mining connections may indicate persistent mining malware or mining pool participation.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains: 'COINMINER'
        condition: selection
      fields:
        - dst_ip
        - alert.signature
        - alert.severity

  - question: What is the network traffic volume to mining-related destinations?
    context: High bandwidth usage to mining pools indicates active mining operations affecting network performance.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 8332
            - 8333
            - 3333
            - 4444
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver
        - bytes_toclient

  - question: Are there signs of cryptocurrency wallet software or mining tools installed?
    context: Presence of mining software indicates intentional mining setup versus malware infection.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - 'bitcoin'
            - 'miner'
            - 'cgminer'
            - 'bfgminer'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessImage

  - question: Has this mining activity affected system performance or resource usage?
    context: Mining operations consume significant CPU and memory resources, impacting system performance.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  - question: Are other systems in the network showing similar mining activity?
    context: Widespread mining activity may indicate malware propagation or coordinated mining operations.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: 'COINMINER'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - alert.signature
        - alert.severity

  - question: What DNS queries were made for cryptocurrency-related domains?
    context: DNS lookups for mining pools or cryptocurrency services indicate mining infrastructure setup.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.query.name|contains:
            - 'pool'
            - 'mining'
            - 'bitcoin'
            - 'crypto'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name