name: ET HUNTING SUSPICIOUS SMTP EXE - EXE SMTP Attachment
id: 22017886
description: |
  Detects suspicious executable attachments in SMTP traffic containing specific binary patterns.
  May trigger on legitimate software distribution via email or encoded binary content.
type: detection
detection_id: 2017886
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete SMTP message containing the suspicious executable attachment?
    context: The full email context reveals sender, recipient, and attachment details for threat assessment.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - smtp.mail.from
        - smtp.rcpt.to
        - smtp.data
        - email.attachments.file.name

  - question: Is this sender authorized to distribute executable files to this recipient?
    context: Determines if this is legitimate business communication or potential malicious email campaign.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: smtp
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - smtp.mail.from
        - smtp.rcpt.to
        - email.subject

  - question: What is the reputation and geolocation of the sending mail server?
    context: External mail servers with poor reputation often indicate spam or malware distribution campaigns.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 25
        condition: selection
      fields:
        - dst_ip
        - connection_state
        - bytes_toserver

  - question: Are there other suspicious emails from this sender recently?
    context: Multiple suspicious emails from the same source indicate coordinated malicious campaign.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - hunting
            - suspicious
            - malware
        condition: selection
      fields:
        - rule.name
        - smtp.mail.from
        - dst_ip

  - question: What is the file type and characteristics of the suspicious attachment?
    context: Understanding attachment properties helps determine potential threat level and required response.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - email.attachments.file.mime_type
        - email.attachments.file.size
        - email.attachments.file.hash.md5
        - email.attachments.file.hash.sha256

  - question: Has this executable attachment been delivered to multiple recipients?
    context: Mass distribution suggests spam campaign while targeted delivery indicates spear-phishing attempt.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: smtp
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          email.attachments.file.hash.md5|expand: '%email.attachments.file.hash.md5%'
        condition: selection
      fields:
        - smtp.rcpt.to
        - dst_ip
        - email.subject

  - question: Are there signs that recipients have opened or executed the suspicious attachment?
    context: Post-delivery activity indicates successful compromise requiring immediate incident response.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: What email security controls were bypassed by this suspicious attachment?
    context: Understanding security control gaps helps improve email filtering and prevent similar attacks.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: smtp
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - smtp.mail.from
        - email.attachments.file.mime_type

  - question: Are there file system artifacts indicating attachment extraction or execution?
    context: File creation events may show if the attachment was saved and potentially executed by users.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          file.hash.md5|expand: '%email.attachments.file.hash.md5%'
        condition: selection
      fields:
        - TargetFilename
        - ProcessName
        - EventType

  - question: Has this attachment hash been seen in other security incidents or threat intelligence?
    context: Known malicious hashes indicate confirmed threat requiring immediate containment and remediation.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          file.hash.md5|expand: '%email.attachments.file.hash.md5%'
        condition: selection
      fields:
        - rule.name
        - src_ip
        - dst_ip
        - rule.category

  - question: Are other systems in the organization receiving similar suspicious email attachments?
    context: Enterprise-wide email campaigns require coordinated response and user awareness communications.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "SUSPICIOUS SMTP EXE"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - smtp.mail.from
        - smtp.rcpt.to