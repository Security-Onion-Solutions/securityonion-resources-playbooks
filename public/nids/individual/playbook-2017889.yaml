name: ET HUNTING SUSPICIOUS SMTP EXE - ZIP file with .scr filename inside
id: 22017889
description: |
  Detects ZIP files containing .scr (screensaver) executables transmitted via SMTP.
  While .scr files can be legitimate screensavers, they are commonly used by malware
  to masquerade as benign files while containing executable code.
type: detection
detection_id: 2017889
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete email message containing the suspicious ZIP attachment?
    context: Analyzing the full email reveals sender, subject, and social engineering tactics used.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - email.from.address
        - email.subject
        - email.attachments.file.name
        - email.message_id

  - question: What is the filename and structure of the .scr file within the ZIP archive?
    context: The actual filename and ZIP structure reveals the attacker's deception tactics.
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          community_id|expand: '%community_id%'
          file.mime_type: "application/zip"
        condition: selection
      fields:
        - file.name
        - file.hash.md5
        - file.size
        - file.path

  - question: Is this sender known to send legitimate attachments to this recipient?
    context: Historical communication patterns help distinguish targeted attacks from spam.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 25
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - network.bytes

  - question: What other email traffic occurred from this source around the same time?
    context: Attackers often send similar malicious emails to multiple targets in campaigns.
    range: -2h/+2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 25
        condition: selection
      fields:
        - dst_ip
        - network.bytes
        - network.packets

  - question: Has the recipient interacted with this or similar ZIP attachments?
    context: User interaction with malicious attachments indicates potential compromise.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          file.mime_type: "application/zip"
        condition: selection
      fields:
        - file.name
        - file.path
        - process.name
        - user.name

  - question: Are there signs of .scr file execution on the recipient system?
    context: Execution of screensaver files indicates successful malware deployment.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          process.executable|endswith: ".scr"
        condition: selection
      fields:
        - process.executable
        - process.command_line
        - process.parent.name
        - user.name

  - question: What network connections were initiated after the email was received?
    context: Post-delivery network activity may indicate command and control communication.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.protocol
        - network.bytes

  - question: Are there indicators of data exfiltration or lateral movement?
    context: Successful malware execution often leads to data theft or network propagation.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.bytes
        - network.direction

  - question: What is the reputation and geolocation of the sending mail server?
    context: Malicious emails often originate from compromised or suspicious infrastructure.
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          dns.resolved_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name

  - question: Are other systems in the organization receiving similar suspicious ZIP attachments?
    context: Email-based attacks often target multiple users within the same organization.
    range: -1d/+1d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "SUSPICIOUS SMTP EXE - ZIP"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature

  - question: Has this source IP been involved in other malicious email campaigns?
    context: Repeat offenders indicate persistent threat actors or compromised infrastructure.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.category|contains: "SMTP"
        condition: selection
      fields:
        - dst_ip
        - alert.signature
        - alert.severity