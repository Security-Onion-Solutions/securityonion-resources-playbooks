name: ET HUNTING SUSPICIOUS SMTP EXE - RAR file with .scr filename inside
id: 22017890
description: |
  Detects RAR archives containing .scr (screensaver) executables transmitted via SMTP.
  Similar to ZIP files, RAR archives with .scr files are commonly used by malware
  to bypass security controls and deliver malicious payloads via email.
type: detection
detection_id: 2017890
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete email message containing the suspicious RAR attachment?
    context: Full email analysis reveals sender information and social engineering techniques.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - email.from.address
        - email.subject
        - email.attachments.file.name
        - email.message_id

  - question: What is the structure and contents of the RAR archive?
    context: RAR file analysis reveals the hidden executable and compression techniques used.
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          community_id|expand: '%community_id%'
          file.mime_type: "application/x-rar-compressed"
        condition: selection
      fields:
        - file.name
        - file.hash.md5
        - file.size
        - file.path

  - question: Is this sender authorized to send compressed files to this recipient?
    context: Legitimate business communications rarely involve RAR files with executables.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 25
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - network.bytes

  - question: What other email activity originated from this source recently?
    context: Mass email campaigns often use similar attachment types across multiple targets.
    range: -4h/+4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 25
        condition: selection
      fields:
        - dst_ip
        - network.bytes
        - network.packets

  - question: Has the recipient extracted or accessed the RAR file contents?
    context: User interaction with malicious archives indicates potential system compromise.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          file.mime_type: "application/x-rar-compressed"
        condition: selection
      fields:
        - file.name
        - file.path
        - process.name
        - user.name

  - question: Are there signs of .scr file execution from the RAR archive?
    context: Execution of extracted screensaver files confirms successful malware deployment.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          process.executable|endswith: ".scr"
        condition: selection
      fields:
        - process.executable
        - process.command_line
        - process.parent.name
        - user.name

  - question: What network communications occurred after the email delivery?
    context: Post-infection network activity reveals command and control infrastructure.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.protocol
        - network.bytes

  - question: Are there indicators of persistence mechanisms or system changes?
    context: Malware often establishes persistence through registry modifications or file placement.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - registry.key
        - registry.value.name
        - registry.value.data
        - process.name

  - question: What is the reputation and infrastructure details of the sending server?
    context: Malicious emails often originate from compromised or bulletproof hosting services.
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          dns.resolved_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name

  - question: Are other systems receiving similar RAR-based email attacks?
    context: Coordinated campaigns often target multiple users with similar malicious attachments.
    range: -1d/+1d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "SUSPICIOUS SMTP EXE - RAR"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature

  - question: Has this attack vector been used by this source previously?
    context: Repeat use of RAR archives indicates persistent threat actor methodology.
    range: -14d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.category|contains: "SMTP"
        condition: selection
      fields:
        - dst_ip
        - alert.signature
        - alert.severity