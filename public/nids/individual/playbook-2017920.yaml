name: ET DOS Possible NTP DDoS Multiple MON_LIST Seq 0 Response Spanning Multiple Packets IMPL 0x02
id: 22017920
description: |
  Detects NTP servers sending large MON_LIST responses across multiple packets, indicating
  successful amplification attacks. This outbound traffic suggests the server is being
  abused to amplify DDoS attacks against external targets.
type: detection
detection_id: 2017920
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What is the size and structure of the NTP MON_LIST response being sent?
    context: Large fragmented responses indicate successful amplification that attackers exploit.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - network.bytes
        - network.packets
        - src_port
        - dst_port

  - question: What was the original MON_LIST request that triggered this response?
    context: Understanding the request helps identify the attack source and methodology.
    range: -5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
          dst_port: 123
        condition: selection
      fields:
        - network.bytes
        - network.packets
        - src_port

  - question: Is this NTP server properly configured to prevent amplification abuse?
    context: Misconfigured NTP servers become unwitting participants in DDoS attacks.
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          src_port: 123
        condition: selection
      fields:
        - dst_ip
        - network.bytes
        - network.packets

  - question: How frequently is this server sending amplified NTP responses?
    context: High-frequency amplified responses indicate ongoing abuse by attackers.
    range: -1h/+1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          src_port: 123
        condition: selection
      fields:
        - dst_ip
        - network.bytes
        - network.packets

  - question: What is the reputation and location of the request source?
    context: Attack requests often originate from compromised systems or malicious infrastructure.
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          dns.resolved_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name

  - question: Are multiple external sources requesting amplification from this server?
    context: Multiple request sources indicate the server is being widely abused for DDoS.
    range: -2h/+2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
          dst_port: 123
        condition: selection
      fields:
        - src_ip
        - network.bytes
        - network.packets

  - question: What is the amplification ratio being achieved by attackers?
    context: High amplification ratios make the server more attractive to DDoS attackers.
    range: -10m/+10m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - network.bytes
        - network.direction
        - src_ip
        - dst_ip

  - question: Are there signs of network congestion from the amplified traffic?
    context: Large amplified responses can impact local network performance and bandwidth.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - network.bytes
        - network.protocol

  - question: What legitimate NTP clients normally use this server?
    context: Baseline legitimate usage helps distinguish attacks from normal operations.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
          dst_port: 123
        condition: selection
      fields:
        - src_ip
        - network.bytes
        - network.packets

  - question: Are other NTP servers in the organization being similarly abused?
    context: Attackers often identify and abuse multiple NTP servers within the same network.
    range: -2h/+2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "NTP DDoS"
          alert.signature|contains: "Multiple Packets"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature

  - question: Has this server been used in previous amplification campaigns?
    context: Persistent abuse indicates the server needs immediate reconfiguration or blocking.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.category|contains: "DOS"
        condition: selection
      fields:
        - dst_ip
        - alert.signature
        - alert.severity