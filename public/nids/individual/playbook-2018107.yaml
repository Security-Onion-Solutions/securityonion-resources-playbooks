name: ET WEB_SPECIFIC_APPS JoomSocial AvatarUpload RCE
id: 22018107
description: |
  Detects remote code execution attempts against JoomSocial AvatarUpload functionality.
  Exploits PHP code injection vulnerabilities in the avatar upload feature.
  May trigger on legitimate file upload operations with similar parameter patterns.
type: detection
detection_id: 2018107
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete HTTP request containing the malicious avatar upload payload?
    context: Analyzing the full request reveals the specific PHP injection technique and malicious code.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.body.content
        - http.request.method
        - url.full
        - http.request.headers

  - question: What specific PHP code was injected through the CStringHelper escape parameter?
    context: The injected code reveals the attacker's intent and potential system compromise level.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.request.body.content
        - url.query
        - http.request.method

  - question: Is this legitimate JoomSocial avatar upload functionality being used normally?
    context: Normal avatar uploads may contain similar parameters but without malicious PHP injection.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains: 'ajaxUploadAvatar'
        condition: selection
      fields:
        - src_ip
        - user_agent.original
        - http.request.method

  - question: What was the server response to this remote code execution attempt?
    context: Response status and content indicate whether the PHP injection was successful.
    range: +2m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - http.response.headers

  - question: Were any files uploaded or created on the server following this exploit attempt?
    context: Successful RCE often results in webshell uploads or malicious file creation.
    range: +10m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.mime_type

  - question: Are there signs of command execution or system compromise on the target server?
    context: Successful PHP injection may lead to system command execution and further compromise.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  - question: What other JoomSocial or Joomla-related requests occurred from this source?
    context: Multiple CMS requests may indicate systematic exploitation or vulnerability scanning.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.request.method
        - http.response.status_code

  - question: Has this source attempted other web application attacks or vulnerability exploits?
    context: Multiple attack patterns suggest automated exploitation tools or persistent threat actor activity.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains: 'web-application-attack'
        condition: selection
      fields:
        - rule.name
        - dst_ip

  - question: Are there outbound connections from the web server indicating potential backdoor communication?
    context: Successful RCE often establishes reverse shells or downloads additional malicious payloads.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.bytes_sent
        - network.bytes_received

  - question: What user agent and client characteristics are associated with this attack?
    context: Client details help identify automated tools versus manual exploitation attempts.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - user_agent.original
        - http.request.headers
        - src_ip

  - question: Are other JoomSocial installations being targeted with similar RCE attempts?
    context: Multiple targets suggest a coordinated campaign against JoomSocial vulnerabilities.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'JoomSocial'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name