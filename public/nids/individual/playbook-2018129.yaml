name: ET MALWARE W32/Trojan-Gypikon Sending Data
id: 22018129
description: |
  Detects W32/Trojan-Gypikon malware sending system information to remote servers.
  This signature identifies the specific format used by Gypikon to transmit host details including IP, OS, CPU, and RAM information.
  Legitimate applications typically do not send system information in this specific format.
type: detection
detection_id: 2018129
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What specific system information was transmitted by the Gypikon trojan?
    context: The payload contains detailed host information that reveals the extent of system reconnaissance performed by the malware.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - http.request.body.content
        - src_ip
        - dst_ip

  - question: Is this system information transmission part of legitimate network monitoring or inventory tools?
    context: Some legitimate system monitoring tools may send similar information, requiring verification of authorized software.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection_count
        - process.name

  - question: What process initiated this data transmission?
    context: Identifying the source process helps determine infection vector and persistence mechanism.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - user.name

  - question: What other network communications occurred around the same time?
    context: Gypikon infections often involve multiple stages of communication including command reception and data exfiltration.
    range: +/-30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_in
        - bytes_out
        - protocol

  - question: Has the trojan successfully established persistent communication with its C2 server?
    context: Ongoing communication indicates active compromise requiring immediate containment and remediation.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - connection_count
        - total_bytes_out
        - duration

  - question: What files were created or modified during the infection timeframe?
    context: File system changes may indicate malware persistence, additional payload deployment, or data staging for exfiltration.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          event.action|contains:
            - 'created'
            - 'modified'
        condition: selection
      fields:
        - file.path
        - file.name
        - file.hash.md5
        - process.name

  - question: Are there signs of additional malware deployment or lateral movement attempts?
    context: Gypikon may be part of a larger attack campaign involving multiple malware families and lateral movement.
    range: +/-1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          process.name|contains:
            - 'powershell'
            - 'cmd'
            - 'wmic'
            - 'net'
        condition: selection
      fields:
        - process.command_line
        - process.parent.name
        - user.name

  - question: What DNS queries reveal additional C2 infrastructure?
    context: DNS activity may expose additional command and control servers used by the Gypikon campaign.
    range: +/-2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.question.name
        - dns.resolved_ip
        - dns.question.type

  - question: Has sensitive data been accessed or exfiltrated based on file access patterns?
    context: Large file reads or unusual access patterns may indicate data theft operations by the trojan.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          event.action: 'read'
        condition: selection
      fields:
        - file.path
        - file.size
        - process.name
        - user.name

  - question: Are other systems in the network infected with Gypikon or related malware?
    context: Trojan infections often spread through the network, requiring comprehensive threat hunting across the enterprise.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'Gypikon'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert_count

  - question: What is the infection timeline based on system and security events?
    context: Establishing the infection timeline helps determine the scope of compromise and required remediation efforts.
    range: -48h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - severity