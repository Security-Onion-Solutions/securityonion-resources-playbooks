name: ET SMTP EXE - ZIP file with .pif filename inside
id: 22018144
description: |
  Detects email attachments containing ZIP files with .pif executables inside, commonly used in malware campaigns.
  While legitimate software may use .pif files, their presence in email attachments is typically malicious.
type: detection
detection_id: 2018144
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What is the complete filename and structure of the ZIP attachment containing the .pif file?
    context: Understanding the file structure reveals social engineering tactics and potential payload naming conventions.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - email.attachments.file.name
        - email.attachments.file.size
        - email.attachments.file.hash.md5

  - question: What is the decoded content of the base64 encoded ZIP file?
    context: Decoding the attachment reveals the actual malicious payload and its characteristics.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - email.attachments.file.mime_type

  # Type 2: Triage Assessment
  - question: Is this email from a known legitimate sender with business justification for .pif files?
    context: Legitimate .pif usage is rare, helping distinguish between authorized software distribution and malware.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - email.from.address
        - email.to.address
        - email.subject
        - smtp.mail_from

  - question: Has this sender previously sent legitimate attachments to this recipient?
    context: Sender reputation helps identify compromised accounts or spoofed addresses in targeted attacks.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: smtp
      detection:
        selection:
          email.from.address|expand: '%email.from.address%'
          email.to.address|expand: '%email.to.address%'
        condition: selection
      fields:
        - email.subject
        - email.attachments.file.name
        - email.attachments.file.mime_type

  # Type 3: Activity Context
  - question: What is the email subject line and body content used for social engineering?
    context: Email content reveals the attack vector and social engineering techniques used to trick recipients.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - email.subject
        - email.body.content
        - email.message_id

  - question: What other emails were sent from this source around the same time?
    context: Concurrent emails from the same source may indicate a spam campaign or compromised account.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: smtp
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - email.from.address
        - email.to.address
        - email.subject
        - email.attachments.file.name

  - question: Are there signs of email account compromise or spoofing?
    context: Authentication failures or unusual sending patterns indicate compromised accounts used for malware distribution.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: smtp
      detection:
        selection:
          email.from.address|expand: '%email.from.address%'
        condition: selection
      fields:
        - src_ip
        - smtp.auth_result
        - email.authentication_results

  # Type 4: Impact Assessment
  - question: Was this malicious email successfully delivered to the recipient's inbox?
    context: Successful delivery indicates potential user exposure and need for immediate user notification.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: smtp
      detection:
        selection:
          email.message_id|expand: '%email.message_id%'
          smtp.response_code|contains:
            - "250"
            - "2"
        condition: selection
      fields:
        - smtp.response_code
        - smtp.response_message
        - email.to.address

  - question: Did the recipient open or interact with the malicious attachment?
    context: User interaction with .pif files leads to immediate system compromise requiring incident response.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          user.email|expand: '%email.to.address%'
          process.name|contains:
            - ".pif"
            - "temp"
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - host.name

  # Type 5: Forensic Deep-Dive
  - question: What is the malware family and capabilities of the .pif executable?
    context: Malware identification helps determine appropriate containment and remediation strategies.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - email.attachments.file.hash.md5
        - email.attachments.file.hash.sha256
        - email.attachments.file.size

  - question: Are there additional payloads or stages hidden within the ZIP archive?
    context: Multi-stage attacks may contain additional components requiring comprehensive analysis.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - email.attachments.file.name
        - payload
        - file.mime_type

  - question: What persistence mechanisms does the .pif malware employ if executed?
    context: Understanding persistence helps with complete malware removal and system hardening.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          registry.key|contains:
            - "Run"
            - "RunOnce"
            - "Services"
        condition: selection
      fields:
        - registry.key
        - registry.value
        - registry.data
        - process.name

  # Type 6: Enterprise Correlation
  - question: How many other recipients received similar malicious ZIP attachments with .pif files?
    context: Multiple recipients indicate a targeted campaign requiring coordinated response and user awareness.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: ".pif filename"
        condition: selection
      fields:
        - email.to.address
        - email.from.address
        - src_ip
        - email.attachments.file.hash.md5

  - question: Is this part of a broader malware campaign targeting the organization?
    context: Enterprise-wide .pif distribution suggests coordinated attack requiring organization-level security measures.
    range: +/-7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: smtp
      detection:
        selection:
          email.attachments.file.name|contains: ".pif"
        condition: selection
      fields:
        - email.from.address
        - email.to.address
        - email.subject
        - src_ip