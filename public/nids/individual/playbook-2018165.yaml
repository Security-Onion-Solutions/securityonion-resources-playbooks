name: ET MALWARE Gh0st Trojan CnC 3
id: 22018165
description: |
  Detects Gh0st RAT (Remote Access Trojan) command and control communication with specific "Gh0st" identifier.
  This is typically malicious as legitimate applications do not use this specific protocol signature.
type: detection
detection_id: 2018165
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What is the complete 14-byte payload containing the Gh0st identifier?
    context: The full payload structure reveals the RAT's communication protocol and potential command being executed.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - payload_len
        - flow_id

  - question: What is the destination C2 server IP and its geolocation?
    context: Identifying the command and control infrastructure helps understand the threat actor's operations and attribution.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - dest_ip
        - dest_port
        - geoip.destination.country_name
        - geoip.destination.city_name

  # Type 2: Triage Assessment
  - question: Is this system authorized to run remote administration tools?
    context: Legitimate remote access tools exist, but Gh0st RAT is exclusively used for malicious purposes.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          process.name|contains:
            - "TeamViewer"
            - "VNC"
            - "RDP"
            - "LogMeIn"
        condition: selection
      fields:
        - process.name
        - process.command_line
        - user.name

  - question: Has this host shown previous signs of compromise or suspicious activity?
    context: Prior malicious activity indicates persistent compromise requiring comprehensive remediation.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.category|contains:
            - "Malware"
            - "Trojan"
        condition: selection
      fields:
        - alert.signature
        - dest_ip
        - alert.severity

  # Type 3: Activity Context
  - question: What process initiated this Gh0st RAT communication?
    context: Identifying the malicious process helps understand the infection vector and establish containment procedures.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - process.executable
        - user.name

  - question: What other network connections were established around the same time?
    context: Concurrent connections may reveal additional C2 channels or lateral movement attempts by the RAT.
    range: +/-15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver
        - bytes_toclient
        - connection_state

  - question: Are there signs of initial infection or payload delivery preceding this C2 communication?
    context: Understanding the attack vector helps prevent similar infections and identifies the entry point.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          event.action: "created"
        condition: selection
      fields:
        - file.path
        - file.name
        - file.hash.md5
        - process.name

  # Type 4: Impact Assessment
  - question: Has the Gh0st RAT successfully established bidirectional communication with the C2 server?
    context: Active C2 communication indicates full compromise with potential for data theft and system control.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - bytes_toserver
        - bytes_toclient
        - connection_state
        - duration

  - question: Are there signs of data exfiltration or remote command execution?
    context: Large data transfers or process creation events indicate active RAT operation and data compromise.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          bytes_toserver: ">100000"
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver
        - protocol

  # Type 5: Forensic Deep-Dive
  - question: What files were created or modified by the Gh0st RAT after establishing C2 communication?
    context: Post-infection file activity reveals persistence mechanisms, downloaded payloads, and data staging.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - file.path
        - file.name
        - file.hash.md5
        - event.action
        - process.name

  - question: What registry modifications indicate Gh0st RAT persistence or configuration?
    context: Registry changes reveal how the RAT maintains persistence and stores configuration data.
    range: +/-30m
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - registry.key
        - registry.value
        - registry.data
        - event.action
        - process.name

  - question: Are there additional Gh0st RAT variants or modules being deployed?
    context: Multi-component RAT deployments require comprehensive removal of all related malware components.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          process.command_line|contains:
            - "Gh0st"
            - "PCRAT"
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.hash.md5
        - process.parent.name

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network communicating with the same Gh0st C2 infrastructure?
    context: Multiple infected hosts indicate lateral movement or coordinated deployment requiring enterprise-wide response.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - bytes_toserver
        - bytes_toclient

  - question: Is this Gh0st RAT activity part of a broader APT campaign targeting the organization?
    context: Enterprise-wide RAT deployment suggests advanced persistent threat requiring coordinated incident response.
    range: +/-7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains:
            - "Gh0st"
            - "PCRAT"
        condition: selection
      fields:
        - src_ip
        - dest_ip
        - alert.signature
        - alert.severity