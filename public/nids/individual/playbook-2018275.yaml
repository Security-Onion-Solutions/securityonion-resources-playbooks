name: ET MALWARE Linux/Onimiki DNS trojan activity long format (Outbound)
id: 22018275
description: |
  Detects outbound DNS queries characteristic of the Linux/Onimiki DNS trojan, part of Operation Windigo.
  This malware uses specially crafted DNS queries with specific patterns for command and control communication.
  Legitimate DNS queries would not match this specific pattern of alphanumeric strings.
type: detection
detection_id: 2018275
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact DNS query pattern that triggered this Onimiki detection?
    context: The specific query structure reveals the trojan's communication protocol and potential command being executed.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - rule.name

  - question: What is the complete DNS transaction structure for this malicious query?
    context: Understanding the full DNS packet helps confirm the trojan's communication method and data exfiltration.
    range: -5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - dns.query.name
        - dns.response_code
        - dns.resolved_ip

  # Type 2: Triage Assessment
  - question: Is this DNS query pattern consistent with normal application behavior from this host?
    context: Legitimate applications would not generate DNS queries matching Onimiki's specific alphanumeric pattern.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dst_ip

  # Type 3: Activity Context
  - question: What other DNS queries occurred from this host around the same time?
    context: Additional DNS activity may reveal the full scope of trojan communication or other malicious domains.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dst_ip

  - question: What network connections were established to the DNS server or resolved IPs?
    context: Following the DNS resolution to actual connections helps understand the trojan's communication flow.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - proto
        - conn_state

  - question: What processes were running on the affected host during this DNS activity?
    context: Identifying the parent process helps determine how the Onimiki trojan was executed and its persistence.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  # Type 4: Impact Assessment
  - question: Has this host established any suspicious outbound connections following the DNS query?
    context: Post-DNS connections may indicate successful trojan communication or data exfiltration attempts.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto
        - orig_bytes
        - resp_bytes

  - question: Are there signs of data exfiltration or command execution following this DNS activity?
    context: Large data transfers or process creation may indicate successful trojan operation.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - orig_bytes
        - resp_bytes

  # Type 5: Forensic Deep-Dive
  - question: What other Onimiki or Operation Windigo indicators are present on this host?
    context: Operation Windigo involves multiple malware families that may be present simultaneously.
    range: -7d
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'Onimiki'
            - 'Windigo'
            - 'Ebury'
        condition: selection
      fields:
        - rule.name
        - rule.category

  - question: What file system changes occurred on this host that might indicate trojan installation?
    context: File modifications may reveal how the trojan was installed and its persistence mechanisms.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.mime_type

  # Type 6: Enterprise Correlation
  - question: Are other hosts in the network showing similar Onimiki DNS patterns?
    context: Operation Windigo typically involves multiple compromised systems in coordinated campaigns.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'Onimiki'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: What is the scope of DNS queries to the same malicious domains across the enterprise?
    context: Multiple hosts querying the same malicious domains indicates campaign scope and coordination.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dns.query.name