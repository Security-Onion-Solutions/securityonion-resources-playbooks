name: ET MALWARE Linux/Onimiki DNS trojan activity long format (Inbound)
id: 22018276
description: |
  Detects inbound DNS responses characteristic of the Linux/Onimiki DNS trojan, part of Operation Windigo.
  This malware receives commands through specially crafted DNS responses with specific patterns.
  Legitimate DNS responses would not match this specific pattern of alphanumeric strings.
type: detection
detection_id: 2018276
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact DNS response pattern that triggered this Onimiki detection?
    context: The specific response structure reveals the trojan's command and control protocol and potential commands being delivered.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - rule.name

  - question: What is the complete DNS transaction for this malicious response?
    context: Understanding the full DNS exchange helps confirm the trojan's communication method and command delivery.
    range: -5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - dns.query.name
        - dns.response_code
        - dns.resolved_ip

  # Type 2: Triage Assessment
  - question: Is this DNS response pattern consistent with normal DNS server behavior?
    context: Legitimate DNS servers would not generate responses matching Onimiki's specific alphanumeric pattern.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dst_ip

  # Type 3: Activity Context
  - question: What other DNS responses were sent from this external server around the same time?
    context: Additional DNS activity may reveal the full scope of trojan command delivery or other malicious domains.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dst_ip

  - question: What network connections were established from the receiving host after this DNS response?
    context: Post-response connections may indicate successful command delivery and trojan activation.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto
        - conn_state

  - question: What processes were spawned on the target host following this DNS response?
    context: Process creation after DNS response may indicate successful trojan command execution.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  # Type 4: Impact Assessment
  - question: Has the target host exhibited any suspicious behavior following this DNS response?
    context: Changes in network behavior may indicate successful trojan command execution or data exfiltration.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - orig_bytes
        - resp_bytes

  - question: Are there signs of system compromise or data exfiltration from the target host?
    context: Large data transfers or suspicious connections may indicate successful trojan operation.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - orig_bytes
        - resp_bytes

  # Type 5: Forensic Deep-Dive
  - question: What other Onimiki or Operation Windigo indicators are present involving this target host?
    context: Operation Windigo involves multiple malware families that may be coordinating attacks.
    range: -7d
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - 'Onimiki'
            - 'Windigo'
            - 'Ebury'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - src_ip

  - question: What file system changes occurred on the target host that might indicate trojan activity?
    context: File modifications may reveal trojan installation, updates, or data staging for exfiltration.
    range: +24h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.mime_type

  # Type 6: Enterprise Correlation
  - question: Are other hosts in the network receiving similar Onimiki DNS responses?
    context: Operation Windigo typically involves coordinated attacks against multiple systems.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'Onimiki'
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - rule.name

  - question: What is the scope of this malicious DNS server's activity across the enterprise?
    context: Multiple hosts receiving responses from the same malicious server indicates campaign coordination.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dns.query.name
        - dns.resolved_ip