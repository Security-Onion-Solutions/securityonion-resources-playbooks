name: ET SCAN NMAP SIP Version Detect OPTIONS Scan
id: 22018317
description: |
  Detects NMAP SIP version detection scans using OPTIONS method with characteristic patterns.
  This indicates reconnaissance activity targeting SIP services to identify versions and capabilities.
  Legitimate SIP OPTIONS requests would not contain the specific "sip:nm" pattern used by NMAP.
type: detection
detection_id: 2018317
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact SIP OPTIONS request that triggered this NMAP detection?
    context: The specific request structure reveals the scanning tool's fingerprinting method and target information.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - http.request.body.content
        - url.full

  - question: What SIP headers and parameters were included in this scanning attempt?
    context: SIP headers reveal the scanner's capabilities and the information being gathered about the target service.
    range: -5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.request.headers
        - http.response.status_code
        - http.response.body.content

  # Type 2: Triage Assessment
  - question: Is this SIP scanning activity part of authorized security testing or network administration?
    context: Legitimate SIP administration would not typically use NMAP's characteristic scanning patterns.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 5060
            - 5061
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto

  # Type 3: Activity Context
  - question: What other scanning activity originated from this source IP around the same time?
    context: Additional scanning may indicate broader reconnaissance efforts or automated attack tools.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - 'attempted-recon'
            - 'scan'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - dst_port

  - question: What other ports or services were targeted by this scanning source?
    context: Multi-port scanning indicates systematic reconnaissance and potential follow-up attacks.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto
        - conn_state

  - question: What was the response from the target SIP service to this scanning attempt?
    context: Service responses reveal whether the scan was successful and what information was disclosed.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - http.response.headers

  # Type 4: Impact Assessment
  - question: Did this SIP scan successfully identify service versions or capabilities?
    context: Successful version detection provides attackers with information for targeted exploits.
    range: +10m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - orig_bytes
        - resp_bytes
        - conn_state

  - question: Has the scanning source attempted to exploit any discovered SIP vulnerabilities?
    context: Follow-up exploitation attempts indicate active threat progression beyond reconnaissance.
    range: +24h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.category|contains:
            - 'exploit'
            - 'attack'
        condition: selection
      fields:
        - rule.name
        - rule.category

  # Type 5: Forensic Deep-Dive
  - question: What specific NMAP scanning techniques and scripts were used against SIP services?
    context: Different NMAP scripts reveal the attacker's knowledge level and intended attack vectors.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: 'NMAP'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - dst_port

  - question: What user agent strings or scanning signatures were observed from this source?
    context: Tool signatures help identify the specific scanning software and potential attacker toolkit.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - http.request.headers
        - user_agent.original

  # Type 6: Enterprise Correlation
  - question: Are other SIP services in the network being scanned by this or related sources?
    context: Coordinated scanning across multiple SIP services indicates systematic reconnaissance.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'SIP'
          rule.category: 'attempted-recon'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port

  - question: What is the geographic and network origin of this SIP scanning activity?
    context: Source analysis helps determine if this is external reconnaissance or internal lateral movement.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_port|contains:
            - 5060
            - 5061
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - proto