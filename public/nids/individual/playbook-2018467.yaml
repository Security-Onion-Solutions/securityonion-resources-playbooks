name: ET MALWARE PandoraRat/Refroso.bsp Activity
id: 22018467
description: |
  Detects PandoraRAT (also known as Refroso.bsp) malware communication based on specific binary patterns.
  This signature identifies the characteristic byte sequence used by PandoraRAT for command and control communications.
  Legitimate applications rarely use this specific binary pattern combination.
type: detection
detection_id: 2018467
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the exact binary pattern that triggered this PandoraRAT detection?
    context: The specific byte sequence helps confirm RAT communication and distinguish from legitimate network traffic.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - src_ip
        - dst_ip
        - dst_port

  - question: Is this connection part of legitimate remote administration or monitoring software?
    context: Some legitimate remote access tools may generate similar traffic patterns, requiring verification of authorized usage.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection_count
        - bytes_out

  - question: What process initiated this PandoraRAT communication?
    context: Identifying the source process helps determine infection vector and establish persistence mechanisms used by the malware.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - user.name
        - process.pid

  - question: What other network connections were established around the same timeframe?
    context: RAT infections typically involve multiple communication channels for different functions like file transfer and command execution.
    range: +/-30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - protocol
        - bytes_in
        - bytes_out

  - question: Has the RAT established persistent communication with its command and control server?
    context: Ongoing communication indicates active compromise requiring immediate containment and incident response.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - connection_count
        - total_bytes_in
        - total_bytes_out
        - session_duration

  - question: What files were accessed, created, or modified during the RAT communication period?
    context: File system activity may reveal data theft, additional malware deployment, or persistence mechanism installation.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - file.path
        - file.name
        - event.action
        - process.name
        - file.hash.md5

  - question: Are there signs of remote command execution or system manipulation?
    context: PandoraRAT enables remote command execution, requiring analysis of suspicious process creation and system changes.
    range: +/-30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          process.name|contains:
            - 'cmd'
            - 'powershell'
            - 'wmic'
            - 'net'
            - 'reg'
            - 'sc'
        condition: selection
      fields:
        - process.command_line
        - process.parent.name
        - user.name

  - question: What DNS queries were performed that might reveal additional infrastructure?
    context: DNS activity can expose additional command and control servers or domains used by the PandoraRAT campaign.
    range: +/-1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.question.name
        - dns.resolved_ip
        - dns.question.type

  - question: Has sensitive data been accessed or prepared for exfiltration?
    context: RATs commonly steal sensitive data, requiring analysis of file access patterns and data staging activities.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          event.action: 'read'
        condition: selection
      fields:
        - file.path
        - file.size
        - process.name
        - user.name

  - question: Are other systems in the network showing PandoraRAT or related malware indicators?
    context: RAT infections may spread laterally or be part of coordinated attacks requiring enterprise-wide threat hunting.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'PandoraRat'
            - 'Refroso'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert_count

  - question: What is the complete timeline of this PandoraRAT infection and activity?
    context: Understanding the full infection timeline helps determine compromise scope and guide remediation efforts.
    range: -48h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - severity
        - dst_ip