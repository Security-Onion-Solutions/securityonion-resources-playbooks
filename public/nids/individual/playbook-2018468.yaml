name: ET MALWARE PandoraRat/Refroso.bsp Directory Listing Sent To Server
id: 22018468
description: |
  Detects PandoraRAT (Refroso.bsp) sending directory listing information to remote command and control servers.
  This signature identifies the specific format used by PandoraRAT to transmit file system information including directory structures.
  Legitimate applications do not typically send directory listings in this specific format to external servers.
type: detection
detection_id: 2018468
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What specific directory information was transmitted by PandoraRAT to the remote server?
    context: The directory listing content reveals what file system information the attacker has gathered from the compromised system.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - http.request.body.content
        - src_ip
        - dst_ip
        - dst_port

  - question: Is this directory listing transmission part of legitimate file synchronization or backup software?
    context: Some legitimate applications may send directory information, but the specific format indicates malicious RAT activity.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection_count
        - process.name

  - question: What process performed the directory enumeration and data transmission?
    context: Identifying the source process helps determine infection vector and establish how the RAT gained file system access.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          process.name|contains:
            - 'dir'
            - 'cmd'
            - 'powershell'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - user.name

  - question: What directories and files were accessed during the reconnaissance phase?
    context: File system access patterns reveal the scope of data discovery and potential targets for exfiltration.
    range: +/-30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          event.action|contains:
            - 'read'
            - 'list'
        condition: selection
      fields:
        - file.path
        - file.name
        - process.name
        - user.name

  - question: Has the RAT successfully established ongoing communication for file operations?
    context: Persistent communication indicates active data theft operations requiring immediate containment.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - connection_count
        - total_bytes_out
        - session_duration

  - question: What sensitive files or directories were potentially exposed in the directory listing?
    context: Directory listings may reveal sensitive data locations that could be targeted for subsequent exfiltration.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.path|contains:
            - 'Documents'
            - 'Desktop'
            - 'Downloads'
            - 'AppData'
        condition: selection
      fields:
        - file.path
        - file.name
        - file.size
        - event.action

  - question: Are there signs of subsequent file download or exfiltration activities?
    context: Directory listings often precede file theft operations, requiring analysis of data transfer patterns.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - bytes_out
        - protocol
        - dst_port

  - question: What other RAT capabilities have been utilized on this compromised system?
    context: PandoraRAT has multiple capabilities beyond directory listing, requiring comprehensive activity analysis.
    range: +/-1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'PandoraRat'
            - 'Refroso'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - severity

  - question: Has data been staged or compressed for exfiltration following directory discovery?
    context: Directory reconnaissance often leads to data staging and compression before exfiltration.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.extension|contains:
            - 'zip'
            - 'rar'
            - 'tar'
            - '7z'
        condition: selection
      fields:
        - file.path
        - file.name
        - file.size
        - process.name

  - question: Are other systems in the network showing similar PandoraRAT directory listing activity?
    context: RAT infections may spread across the network, requiring enterprise-wide analysis of similar reconnaissance activities.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'PandoraRat'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert_count

  - question: What is the progression timeline from initial infection to directory reconnaissance?
    context: Understanding the attack timeline helps determine compromise duration and scope of data exposure.
    range: -48h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - severity
        - dst_ip