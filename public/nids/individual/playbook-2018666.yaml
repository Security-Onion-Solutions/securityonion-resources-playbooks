name: ET MALWARE Possible Zeus P2P Variant DGA NXDOMAIN Responses July 11 2014
id: 22018666
description: |
  Detects Zeus P2P variant using Domain Generation Algorithm (DGA) based on NXDOMAIN responses.
  May trigger on legitimate DNS failures but specific pattern indicates malware behavior.
type: detection
detection_id: 2018666
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What are the specific DGA domains being queried?
    context: The generated domains reveal the algorithm pattern and potential C2 infrastructure.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - dns.question.name
        - dns.response_code
        - rule.name

  - question: How many DGA domains has this host queried recently?
    context: High volume of NXDOMAIN responses indicates active DGA behavior and bot activity.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.response_code: "NXDOMAIN"
        condition: selection
      fields:
        - dns.question.name
        - query_count

  - question: Is this normal DNS behavior for this host?
    context: Establishes baseline to distinguish between legitimate failures and malware activity.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.response_code
        - daily_query_count
        - unique_domains

  - question: What process is generating these DNS queries?
    context: Identifies the Zeus variant executable and helps trace infection source.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - User

  - question: Has any DGA domain successfully resolved to an IP?
    context: Successful resolution indicates active C2 server and potential data exfiltration.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.response_code: "NOERROR"
        condition: selection
      fields:
        - dns.question.name
        - dns.resolved_ip
        - dns.answers.ttl

  - question: Are there HTTP connections to resolved DGA domains?
    context: Confirms active C2 communication and potential data exfiltration or command receipt.
    range: +6h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 80
            - 443
            - 8080
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - bytes_in

  - question: What banking or financial sites has this host accessed?
    context: Zeus malware targets financial institutions, indicating potential credential theft.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.question.name|contains:
            - "bank"
            - "paypal"
            - "chase"
            - "wellsfargo"
        condition: selection
      fields:
        - dns.question.name
        - dns.resolved_ip

  - question: Are there signs of credential harvesting or form grabbing?
    context: Zeus variants steal credentials through form grabbing and keylogging capabilities.
    range: +12h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method: "POST"
        condition: selection
      fields:
        - url.full
        - http.request.body.content
        - user_agent.original

  - question: Has the malware attempted to spread to other systems?
    context: Zeus variants often include propagation mechanisms for lateral movement.
    range: +8h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 135
            - 139
            - 445
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out

  - question: Are other hosts showing similar DGA patterns?
    context: Identifies scope of Zeus botnet infection across the network.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Zeus"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert_count

  - question: What encrypted traffic patterns suggest data exfiltration?
    context: Zeus may use encrypted channels to exfiltrate stolen credentials and data.
    range: +24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 443
        condition: selection
      fields:
        - dst_ip
        - total_bytes_out
        - session_duration