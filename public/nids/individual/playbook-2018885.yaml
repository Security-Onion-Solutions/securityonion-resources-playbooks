name: ET MALWARE Windows Command Prompt OUTBOUND
id: 22018885
description: |
  Detects Windows command prompt output being transmitted outbound, indicating remote shell access.
  May trigger on legitimate remote administration but often indicates malicious backdoor activity.
type: detection
detection_id: 2018885
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What command prompt output is being transmitted?
    context: The exact output reveals what commands are being executed remotely.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - alert.payload
        - alert.payload_printable
        - rule.name

  - question: What remote system is receiving the command output?
    context: Identifies the attacker's command and control server or compromised system.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - src_ip
        - bytes_out

  - question: Is this authorized remote administration activity?
    context: Helps distinguish between legitimate IT support and malicious remote access.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 3389
            - 22
            - 5985
            - 5986
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection_count

  - question: What process is providing the remote shell access?
    context: Identifies the backdoor or remote access tool being used by the attacker.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          process.name|contains:
            - "cmd.exe"
            - "powershell.exe"
            - "nc.exe"
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - User

  - question: What commands have been executed through this remote shell?
    context: Reveals attacker objectives and potential damage from remote access.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          process.parent.name|contains:
            - "cmd.exe"
            - "powershell.exe"
        condition: selection
      fields:
        - process.name
        - process.command_line
        - User

  - question: Are there signs of data collection or exfiltration?
    context: Determines if the remote access is being used for data theft activities.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - file.path
        - file.name
        - file.size
        - process.name

  - question: Has the attacker established persistence mechanisms?
    context: Identifies if backdoors or scheduled tasks have been created for continued access.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          registry.path|contains:
            - "Run"
            - "RunOnce"
            - "Services"
        condition: selection
      fields:
        - registry.path
        - registry.value
        - process.name

  - question: What network reconnaissance has been performed?
    context: Reveals if the attacker is mapping the network for lateral movement.
    range: +6h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          process.name|contains:
            - "ping.exe"
            - "nslookup.exe"
            - "net.exe"
            - "ipconfig.exe"
        condition: selection
      fields:
        - process.command_line
        - User

  - question: Are there attempts at lateral movement to other systems?
    context: Determines if the compromise is spreading to additional network resources.
    range: +8h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 135
            - 139
            - 445
            - 3389
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out

  - question: How did the attacker initially gain access to this system?
    context: Understanding the attack vector helps prevent similar compromises.
    range: -4h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
          dst_port|contains:
            - 80
            - 443
            - 21
            - 22
            - 3389
        condition: selection
      fields:
        - src_ip
        - dst_port
        - bytes_in

  - question: Are other systems showing similar remote shell activity?
    context: Identifies if this is part of a broader attack campaign across the network.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Command Prompt"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert_count

  - question: What sensitive information has been accessed during this session?
    context: Assesses potential data exposure and helps prioritize incident response.
    range: +12h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.extension|contains:
            - ".doc"
            - ".pdf"
            - ".xls"
            - ".txt"
        condition: selection
      fields:
        - file.path
        - file.name
        - process.name