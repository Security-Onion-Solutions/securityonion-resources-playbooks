name: ET MALWARE Suspicious X-mailer Synapse
id: 22018936
description: |
  Detects suspicious email headers indicating use of Synapse Pascal TCP/IP library commonly used by malware for SMTP communication.
  May indicate spam bot activity or malware attempting to send emails through compromised systems.
type: detection
detection_id: 2018936
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete email header content including the suspicious X-mailer field?
    context: Analyzing the full email headers reveals the malware's email construction and potential campaign details.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - smtp.mail.from
        - smtp.rcpt.to

  - question: What destination email server was being used for this suspicious mail activity?
    context: Identifies the target mail infrastructure and potential abuse of legitimate services.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - src_ip
        - smtp.helo

  # Type 2: Triage Assessment
  - question: Is this email activity from a legitimate mail server or compromised system?
    context: Determines if this is authorized email infrastructure or indicates system compromise.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 25
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - connection_state

  - question: Has this system been configured as an authorized mail relay or SMTP client?
    context: Legitimate systems may have authorized SMTP configurations for business purposes.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 25
            - 587
            - 465
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver

  # Type 3: Activity Context
  - question: What process initiated this SMTP communication with the suspicious X-mailer?
    context: Identifying the sending process helps determine if this is malware or legitimate application.
    range: +/-15m
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ProcessGuid
        - ParentImage

  - question: What other network activity occurred around the time of this email transmission?
    context: Correlates email activity with other malware behaviors like C2 communication or data collection.
    range: +/-30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - service
        - bytes_toserver

  - question: Were there any file operations that could indicate email content preparation?
    context: Malware often creates temporary files or accesses data before sending emails.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.mime_type
        - ProcessGuid

  # Type 4: Impact Assessment
  - question: How many emails were sent using this suspicious X-mailer signature?
    context: Determines the scale of potential spam or malicious email campaign.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "Synapse"
        condition: selection
      fields:
        - dst_ip
        - smtp.rcpt.to
        - rule.name

  - question: What was the content and potential impact of the emails sent?
    context: Assesses whether this was spam, phishing, or other malicious email content.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 25
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - duration

  # Type 5: Forensic Deep-Dive
  - question: What specific malware family is associated with this Synapse library usage?
    context: The reference MD5 hash helps identify the exact malware variant and its capabilities.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - reference
        - malware_family
        - signature_severity
        - rule.category

  - question: Are there additional indicators of compromise related to this email malware?
    context: Identifies other artifacts that need to be investigated and remediated.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category: "trojan-activity"
        condition: selection
      fields:
        - rule.name
        - malware_family
        - dst_ip

  # Type 6: Enterprise Correlation
  - question: Are other systems in the organization showing similar suspicious email activity with Synapse signatures?
    context: Determines if this is an isolated incident or part of a broader malware campaign.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Synapse"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name