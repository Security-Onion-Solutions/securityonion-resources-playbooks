name: ET MALWARE Probable OneLouder downloader (Zeus P2P) exe download
id: 22018982
description: |
  Detects probable OneLouder downloader (Zeus P2P variant) executable downloads.
  Triggers when PE executable content follows established flowbit for OneLouder binary activity.
  May indicate Zeus P2P botnet payload delivery or legitimate software downloads with similar PE structure.
type: detection
detection_id: 2018982
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What is the complete PE file structure and headers of the downloaded executable?
    context: Analyzing PE headers confirms executable type and potential malware family characteristics.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - file.hash.md5
        - file.hash.sha256
        - file.size
        - file.mime_type

  - question: What was the complete download URL and HTTP transaction details?
    context: Understanding the delivery mechanism reveals infection vector and C2 infrastructure.
    range: -5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.response.status_code
        - http.response.body.bytes

  # Type 2: Triage Assessment
  - question: Is this download part of legitimate software installation or updates?
    context: Authorized software deployments may trigger similar PE detection patterns.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 80
            - 443
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.bytes_toserver
        - network.bytes_toclient

  - question: Does the source system regularly download executables from this location?
    context: Established download patterns may indicate legitimate software repositories.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - network.protocol
        - network.bytes_toserver
        - network.bytes_toclient

  # Type 3: Activity Context
  - question: What OneLouder binary activity preceded this executable download?
    context: The flowbit requirement indicates prior OneLouder detection that enabled this rule.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: 'OneLouder'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - alert.signature_id

  - question: What process initiated the network connection for this download?
    context: Identifying the requesting process reveals if user-initiated or automated malware behavior.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  # Type 4: Impact Assessment
  - question: Was the downloaded executable successfully written to disk and executed?
    context: Successful execution indicates active malware installation requiring immediate response.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.mime_type: 'application/x-dosexec'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size

  - question: Are there signs of Zeus P2P botnet communication following the download?
    context: Post-infection C2 communication confirms successful malware deployment.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          network.protocol: 'tcp'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.bytes_toserver
        - network.bytes_toclient

  # Type 5: Forensic Deep-Dive
  - question: What specific Zeus P2P variant characteristics are present in the executable?
    context: Zeus P2P variants have distinct behavioral patterns and configuration structures.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'Zeus'
            - 'P2P'
            - 'Banking'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - alert.signature_id

  - question: What persistence mechanisms were established after executable execution?
    context: Zeus variants typically establish registry persistence and scheduled tasks.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - 'Run'
            - 'RunOnce'
            - 'Services'
        condition: selection
      fields:
        - TargetObject
        - Details
        - EventType

  # Type 6: Enterprise Correlation
  - question: Are other systems showing similar OneLouder or Zeus P2P activity?
    context: Zeus P2P spreads through networks requiring enterprise-wide threat hunting.
    range: -1h/+1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'OneLouder'
            - 'Zeus'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - alert.signature_id