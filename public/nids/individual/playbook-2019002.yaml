name: ET MALWARE Windows systeminfo Microsoft Windows DOS prompt command exit OUTBOUND
id: 22019002
description: |
  Detects malware exfiltrating Windows system information via network connections.
  The systeminfo command output contains detailed host configuration data valuable for reconnaissance.
  May rarely trigger on legitimate remote administration or system inventory tools.
type: detection
detection_id: 2019002
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete systeminfo output being transmitted?
    context: Analyzing the full system information reveals what reconnaissance data was collected and exfiltrated.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - http.request.body.content

  - question: What specific system details were included in this data transmission?
    context: Understanding the scope of system information helps assess reconnaissance value to attackers.
    range: -5m/+5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_port
        - dst_port
        - tx_bytes
        - rx_bytes

  # Type 2: Triage Assessment
  - question: Is remote system administration or inventory collection authorized for this system?
    context: Determines if systeminfo transmission represents legitimate IT operations or malicious reconnaissance.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'systeminfo'
            - 'wmic'
            - 'powershell'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ParentImage

  - question: Are there legitimate remote administration tools active on this system?
    context: Establishes if authorized remote access tools could explain systeminfo data transmission.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'rdp'
            - 'vnc'
            - 'teamviewer'
            - 'anydesk'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine

  # Type 3: Activity Context
  - question: What process executed the systeminfo command that generated this output?
    context: Identifying the parent process helps distinguish between legitimate administration and malware reconnaissance.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains: 'systeminfo'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid

  - question: What other reconnaissance commands were executed around this time?
    context: Malware often runs multiple system enumeration commands during initial reconnaissance phase.
    range: -1h/+30m
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'whoami'
            - 'ipconfig'
            - 'net user'
            - 'tasklist'
            - 'dir'
        condition: selection
      fields:
        - CommandLine
        - Image
        - User
        - ParentImage

  - question: How was this systeminfo data transmitted to external systems?
    context: Understanding the transmission method reveals malware communication protocols and C2 infrastructure.
    range: -15m/+15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto
        - tx_bytes

  # Type 4: Impact Assessment
  - question: Has additional malware activity been detected on this compromised system?
    context: Confirms broader malware infection beyond reconnaissance, indicating full system compromise.
    range: -24h/+1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - 'trojan'
            - 'malware'
            - 'backdoor'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - dst_ip

  - question: What sensitive information was exposed through this system enumeration?
    context: Assesses the intelligence value of transmitted system information for further attacks.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'net group'
            - 'net localgroup'
            - 'query user'
            - 'wmic'
        condition: selection
      fields:
        - CommandLine
        - User
        - Image

  # Type 5: Forensic Deep-Dive
  - question: What malware family typically exfiltrates systeminfo data in this format?
    context: Specific formatting and transmission methods can identify the malware family and campaign.
    range: -2h/+1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'systeminfo'
            - 'reconnaissance'
            - 'enumeration'
        condition: selection
      fields:
        - rule.name
        - payload_printable
        - dst_ip

  - question: Are there signs of data staging before transmission?
    context: Malware often collects and stages reconnaissance data in temporary files before exfiltration.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - 'temp'
            - 'tmp'
            - '.txt'
            - '.log'
        condition: selection
      fields:
        - TargetFilename
        - Image
        - User

  # Type 6: Enterprise Correlation
  - question: Are other systems showing similar systeminfo reconnaissance and exfiltration?
    context: Determines if this is isolated compromise or coordinated reconnaissance across multiple systems.
    range: -24h/+1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: 'ET MALWARE Windows systeminfo Microsoft Windows DOS prompt command exit OUTBOUND'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.severity