name: ET DOS Likely NTP DDoS In Progress PEER_LIST Response to Non-Ephemeral Port IMPL 0x03
id: 22019011
description: |
  Detects NTP amplification DDoS attacks using PEER_LIST queries with implementation 0x03.
  Attackers exploit NTP servers to amplify traffic by sending small queries that generate large responses.
  Responses to non-ephemeral ports (0-1023) indicate spoofed source addresses in DDoS attacks.
type: detection
detection_id: 2019011
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact NTP PEER_LIST response packet structure and implementation details?
    context: Analyzing packet details for implementation 0x03 reveals specific amplification characteristics and attack patterns.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - packet_info.length
        - ntp.mode

  - question: What specific non-ephemeral port received this implementation 0x03 amplified response?
    context: Non-ephemeral destination ports combined with specific implementation indicate sophisticated DDoS attack vectors.
    range: -5m/+5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_port
        - dst_port
        - tx_bytes
        - rx_bytes

  # Type 2: Triage Assessment
  - question: Is this NTP server properly configured to prevent PEER_LIST amplification attacks?
    context: Determines if server has security misconfigurations that enable exploitation for DDoS attacks.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          src_port: 123
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - tx_bytes
        - rx_bytes

  - question: Are there legitimate time synchronization clients that should receive NTP responses?
    context: Establishes baseline NTP usage patterns to differentiate attacks from normal network time protocol operations.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
          dst_port: 123
        condition: selection
      fields:
        - src_ip
        - tx_bytes
        - rx_bytes

  # Type 3: Activity Context
  - question: What is the frequency and volume of implementation 0x03 PEER_LIST responses?
    context: High response rates indicate active exploitation and measure the server's contribution to DDoS attacks.
    range: -1h/+30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          src_port: 123
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - tx_bytes
        - rx_bytes

  - question: What sources are sending NTP queries that trigger these amplified responses?
    context: Identifying query sources helps determine attack attribution and coordination patterns.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
          dst_port: 123
        condition: selection
      fields:
        - src_ip
        - tx_bytes
        - rx_bytes

  - question: Are both implementation 0x02 and 0x03 being exploited simultaneously?
    context: Coordinated exploitation of multiple implementations indicates sophisticated DDoS attack campaigns.
    range: -2h/+1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'NTP DDoS'
            - 'PEER_LIST'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.severity

  # Type 4: Impact Assessment
  - question: What amplification factor is achieved through implementation 0x03 exploitation?
    context: Measures attack effectiveness and potential impact on targeted systems and network infrastructure.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          src_port: 123
        condition: selection
      fields:
        - dst_ip
        - tx_bytes
        - rx_bytes

  - question: Are there indicators of successful DDoS impact on target systems?
    context: Determines if amplification attacks are achieving intended disruption of target services.
    range: -2h/+30m
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.category|contains:
            - 'dos'
            - 'ddos'
            - 'network'
        condition: selection
      fields:
        - rule.name
        - src_ip
        - rule.severity

  # Type 5: Forensic Deep-Dive
  - question: What are the technical differences between implementation 0x02 and 0x03 exploits?
    context: Understanding implementation-specific vulnerabilities helps assess attack sophistication and mitigation strategies.
    range: -30m/+30m
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'NTP'
            - 'IMPL'
        condition: selection
      fields:
        - rule.name
        - payload_printable
        - dst_ip

  - question: Are there signs of automated tools or botnets conducting these NTP attacks?
    context: Automated exploitation patterns indicate coordinated DDoS campaigns rather than individual attacks.
    range: -2h/+1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
          dst_port: 123
        condition: selection
      fields:
        - src_ip
        - tx_bytes
        - rx_bytes

  # Type 6: Enterprise Correlation
  - question: Are multiple NTP servers across the network being exploited for DDoS amplification?
    context: Determines scope of infrastructure compromise and coordinated exploitation of NTP services.
    range: -2h/+1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'NTP DDoS'
            - 'PEER_LIST'
            - 'IMPL'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.severity