name: ET DOS Likely NTP DDoS In Progress GET_RESTRICT Response to Non-Ephemeral Port
id: 22019014
description: |
  Detects NTP amplification DDoS attacks using GET_RESTRICT responses to low-numbered ports.
  May trigger on legitimate NTP monitoring tools querying restriction lists.
  Indicates potential participation in distributed denial of service campaigns.
type: detection
detection_id: 2019014
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the exact NTP GET_RESTRICT response packet structure?
    context: Analyzing the NTP response reveals amplification factor and attack methodology.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - proto
        - bytes_in
        - bytes_out

  - question: Is this NTP server authorized to respond to restriction queries?
    context: Legitimate NTP monitoring may require restriction list access for network management.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
          dst_port: 123
        condition: selection
      fields:
        - src_ip
        - bytes_in
        - bytes_out

  - question: What is the amplification ratio of this NTP response?
    context: High amplification ratios indicate effective DDoS weaponization of NTP servers.
    range: +/-5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - bytes_in
        - bytes_out
        - duration

  - question: Are multiple low-numbered ports being targeted simultaneously?
    context: Systematic targeting of non-ephemeral ports indicates coordinated DDoS attack.
    range: +/-15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          src_port: 123
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out

  - question: What is the geographic and network distribution of targeted destinations?
    context: Attack target patterns reveal DDoS campaign scope and victim selection criteria.
    range: +/-30m
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "NTP"
        condition: selection
      fields:
        - dst_ip
        - dst_port

  - question: Has this NTP server been compromised or misconfigured for abuse?
    context: Compromised NTP servers may be intentionally weaponized for DDoS attacks.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - src_ip

  - question: What is the query rate and pattern from potential DDoS coordinators?
    context: High-frequency queries from few sources indicate DDoS botnet command infrastructure.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
          dst_port: 123
        condition: selection
      fields:
        - src_ip
        - bytes_in
        - bytes_out

  - question: Are other NTP servers in the network participating in this attack?
    context: Coordinated NTP amplification indicates widespread infrastructure abuse.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "NTP DDoS"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port

  - question: What network infrastructure changes preceded this DDoS activity?
    context: Configuration changes or compromises may have enabled NTP abuse.
    range: -48h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
          dst_port|contains:
            - 22
            - 23
            - 80
            - 443
        condition: selection
      fields:
        - src_ip
        - dst_port
        - duration

  - question: Has the DDoS attack caused service disruption for targeted systems?
    context: Understanding attack impact helps prioritize response and mitigation efforts.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - bytes_in

  - question: Are there command and control communications coordinating this DDoS?
    context: C2 traffic patterns reveal attack orchestration and potential attribution.
    range: +/-4h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - "trojan"
            - "malware"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - dst_port