name: ET DOS Possible NTP DDoS Inbound Frequent Un-Authed PEER_LIST Requests IMPL 0x03
id: 22019016
description: |
  Detects frequent unauthenticated NTP PEER_LIST requests targeting NTP servers, indicating potential DDoS amplification setup.
  Legitimate NTP peer queries are typically authenticated and infrequent from network monitoring systems.
type: detection
detection_id: 2019016
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the exact NTP PEER_LIST request packet structure detected?
    context: Understanding the NTP packet format confirms the PEER_LIST query pattern and implementation version.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - src_ip
        - dst_ip
        - src_port
        - dst_port

  - question: Is this source IP authorized to perform NTP monitoring on this server?
    context: Legitimate network monitoring tools may query NTP servers for peer information as part of infrastructure monitoring.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 123
        condition: selection
      fields:
        - dst_ip
        - connection_count
        - unique_dst_count

  - question: What is the frequency pattern of PEER_LIST requests from this source?
    context: Attack reconnaissance typically shows burst patterns while legitimate monitoring shows regular intervals.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 123
        condition: selection
      fields:
        - connection_count
        - bytes_in
        - bytes_out
        - first_seen
        - last_seen

  - question: How many different NTP servers is this source targeting?
    context: Scanning multiple NTP servers indicates reconnaissance for amplification attack infrastructure.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 123
        condition: selection
      fields:
        - dst_ip
        - connection_count
        - bytes_out

  - question: Are there signs of amplification potential in the NTP responses?
    context: Large responses to small requests indicate servers vulnerable to amplification abuse.
    range: -15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - bytes_in
        - bytes_out
        - packets_in
        - packets_out

  - question: What other reconnaissance activity has this source IP performed?
    context: Broader scanning patterns help determine if this is part of botnet reconnaissance or targeted attack preparation.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection_count
        - service_name

  - question: Has this NTP server been targeted for amplification attacks previously?
    context: Historical attack patterns help assess the server's vulnerability and exposure to abuse.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - 'NTP DDoS'
            - 'NTP amplification'
        condition: selection
      fields:
        - src_ip
        - rule.name
        - alert_count

  - question: Are there coordinated PEER_LIST requests from multiple sources?
    context: Distributed reconnaissance from multiple IPs indicates coordinated botnet activity for DDoS preparation.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: 'PEER_LIST'
        condition: selection
      fields:
        - src_ip
        - alert_count
        - unique_src_count

  - question: What is the geographic origin of these NTP reconnaissance attempts?
    context: Understanding source geography helps identify botnet infrastructure and attack coordination patterns.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 123
        condition: selection
      fields:
        - src_ip
        - connection_count
        - bytes_in

  - question: Are there indicators of follow-up exploitation attempts after reconnaissance?
    context: Successful reconnaissance often leads to actual amplification attacks or further exploitation attempts.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - 'attempted-dos'
            - 'trojan-activity'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - alert_count