name: ET DOS Possible NTP DDoS Inbound Frequent Un-Authed PEER_LIST Requests IMPL 0x02
id: 22019017
description: |
  Detects frequent unauthenticated NTP PEER_LIST requests using implementation 0x02, indicating potential DDoS amplification setup.
  Legitimate NTP peer queries are typically authenticated and infrequent from network monitoring systems.
type: detection
detection_id: 2019017
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the exact NTP PEER_LIST request packet with implementation 0x02 detected?
    context: Understanding the specific NTP implementation version helps identify the attack tools and techniques being used.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - src_ip
        - dst_ip
        - src_port
        - dst_port

  - question: Is this source IP part of legitimate NTP infrastructure monitoring?
    context: Some network monitoring solutions may use specific NTP implementations for peer discovery and health checks.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 123
        condition: selection
      fields:
        - dst_ip
        - connection_count
        - unique_dst_count
        - total_bytes_in

  - question: What is the timing pattern of these PEER_LIST requests?
    context: Attack reconnaissance shows irregular bursts while legitimate monitoring follows predictable schedules.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 123
        condition: selection
      fields:
        - connection_count
        - bytes_in
        - bytes_out
        - duration_avg

  - question: How many NTP servers is this source probing for PEER_LIST information?
    context: Widespread probing indicates reconnaissance for building amplification attack infrastructure.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 123
        condition: selection
      fields:
        - dst_ip
        - connection_count
        - bytes_out
        - unique_dst_count

  - question: What is the amplification potential of responses from this NTP server?
    context: High response-to-request ratios indicate servers suitable for DDoS amplification attacks.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - bytes_in
        - bytes_out
        - packets_in
        - packets_out
        - amplification_ratio

  - question: What other scanning or reconnaissance activity originates from this source?
    context: Broader attack patterns help determine if this is isolated probing or part of comprehensive infrastructure mapping.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - service_name
        - connection_count

  - question: Has this NTP server been exploited in amplification attacks before?
    context: Historical exploitation patterns indicate ongoing vulnerability and likelihood of future abuse.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - 'NTP DDoS'
            - 'NTP amplification'
            - 'PEER_LIST'
        condition: selection
      fields:
        - src_ip
        - rule.name
        - alert_count
        - first_seen

  - question: Are there coordinated PEER_LIST probes from multiple sources targeting this server?
    context: Distributed reconnaissance indicates botnet coordination for large-scale DDoS preparation.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: 'PEER_LIST'
        condition: selection
      fields:
        - src_ip
        - alert_count
        - unique_src_count
        - geographic_distribution

  - question: What is the source reputation and threat intelligence for this IP?
    context: Known malicious IPs indicate active botnet participation rather than legitimate monitoring.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - rule.category
        - rule.name
        - threat_score
        - reputation_category

  - question: Are there signs of actual amplification attacks following this reconnaissance?
    context: Successful reconnaissance typically leads to exploitation attempts using the discovered vulnerable servers.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.category: 'attempted-dos'
        condition: selection
      fields:
        - src_ip
        - rule.name
        - alert_count
        - bytes_out_total