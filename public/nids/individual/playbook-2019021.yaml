name: ET DOS Possible NTP DDoS Inbound Frequent Un-Authed GET_RESTRICT Requests IMPL 0x02
id: 22019021
description: |
  Detects potential NTP amplification DDoS attacks using GET_RESTRICT requests.
  Legitimate NTP monitoring may trigger this, but frequent requests indicate abuse.
  Attackers exploit NTP servers to amplify traffic toward victim systems.
type: detection
detection_id: 2019021
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What is the exact NTP packet structure and implementation code detected?
    context: The specific NTP implementation code reveals the attack tool and amplification method.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - alert.signature
        - proto

  - question: Is this legitimate NTP monitoring or administrative traffic?
    context: Network monitoring tools may send similar NTP queries for time synchronization checks.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 123
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - bytes_toclient

  - question: What is the frequency and pattern of these NTP requests?
    context: DDoS attacks show rapid, repeated requests while legitimate queries are periodic.
    range: -15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 123
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - bytes_toserver

  - question: What NTP servers are being targeted for amplification?
    context: Identifies vulnerable NTP servers that could be used in amplification attacks.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 123
        condition: selection
      fields:
        - dst_ip
        - src_ip
        - bytes_toclient

  - question: Are there signs of successful NTP amplification responses?
    context: Large response packets indicate successful amplification that could impact victims.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
          src_port: 123
        condition: selection
      fields:
        - bytes_toclient
        - bytes_toserver
        - community_id

  - question: What is the amplification ratio achieved in this attack?
    context: High amplification ratios indicate effective DDoS potential and server vulnerability.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - bytes_toserver
        - bytes_toclient
        - duration

  - question: Are multiple source IPs targeting the same NTP server?
    context: Coordinated attacks from multiple sources indicate a distributed DDoS campaign.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 123
        condition: selection
      fields:
        - src_ip
        - bytes_toserver

  - question: What other amplification protocols are being abused simultaneously?
    context: Attackers often combine multiple amplification vectors for maximum impact.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 53
            - 161
            - 389
            - 1900
        condition: selection
      fields:
        - dst_port
        - dst_ip
        - bytes_toserver
        - bytes_toclient

  - question: Are there DNS queries associated with NTP server discovery?
    context: Attackers may perform reconnaissance to identify vulnerable NTP servers.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.question.name|contains:
            - 'ntp'
            - 'time'
        condition: selection
      fields:
        - dns.question.name
        - dns.resolved_ip
        - dns.response_code

  - question: What enterprise systems are participating in or affected by this NTP abuse?
    context: Internal NTP servers may be compromised or targeted, affecting time synchronization.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains:
            - 'NTP'
            - 'amplification'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature

  - question: Are there indicators of a coordinated DDoS campaign across the network?
    context: Multiple amplification attacks may indicate enterprise-wide DDoS targeting.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains:
            - 'DDoS'
            - 'DOS'
            - 'amplification'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.category