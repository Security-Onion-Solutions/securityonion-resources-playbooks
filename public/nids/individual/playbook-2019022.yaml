name: ET DOS Likely NTP DDoS In Progress Multiple UNSETTRAP Mode 6 Responses
id: 22019022
description: |
  Detects active NTP amplification DDoS attacks via multiple UNSETTRAP Mode 6 responses.
  Legitimate NTP operations rarely generate multiple rapid responses.
  This indicates successful exploitation of NTP servers for traffic amplification.
type: detection
detection_id: 2019022
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What is the exact NTP Mode 6 UNSETTRAP response structure detected?
    context: The specific NTP response format reveals the amplification payload and server vulnerability.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - alert.signature
        - proto

  - question: Is this NTP server legitimately responding to authorized queries?
    context: Authorized NTP monitoring may generate similar responses from managed servers.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          src_port: 123
        condition: selection
      fields:
        - dst_ip
        - bytes_toclient
        - bytes_toserver

  - question: What is the volume and frequency of NTP responses being generated?
    context: High-frequency responses indicate active DDoS amplification rather than normal operation.
    range: -15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          src_port: 123
        condition: selection
      fields:
        - dst_ip
        - bytes_toclient

  - question: Who are the ultimate targets receiving these amplified responses?
    context: Identifies DDoS victims and helps understand the attack's intended impact.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          src_port: 123
        condition: selection
      fields:
        - dst_ip
        - bytes_toclient

  - question: What triggered the initial NTP requests that caused these responses?
    context: Understanding the attack initiation helps identify the DDoS orchestrator.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
          dst_port: 123
        condition: selection
      fields:
        - src_ip
        - bytes_toserver
        - community_id

  - question: What is the amplification factor achieved by this NTP server?
    context: High amplification ratios indicate severe DDoS potential and server misconfiguration.
    range: -5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          src_port: 123
        condition: selection
      fields:
        - bytes_toserver
        - bytes_toclient
        - community_id

  - question: Are multiple NTP servers participating in this amplification attack?
    context: Coordinated amplification from multiple servers indicates sophisticated DDoS infrastructure.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: 'NTP DDoS'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature

  - question: What other DDoS vectors are being employed alongside NTP amplification?
    context: Multi-vector attacks combine various amplification protocols for maximum impact.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          alert.category: 'attempted-dos'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature
        - alert.category

  - question: Are there signs of NTP server reconnaissance preceding this attack?
    context: Attackers often scan for vulnerable NTP servers before launching amplification attacks.
    range: -4h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
          dst_port: 123
        condition: selection
      fields:
        - src_ip
        - bytes_toserver
        - bytes_toclient

  - question: What is the geographic distribution of DDoS targets?
    context: Understanding target distribution helps assess campaign scope and motivation.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          src_port: 123
        condition: selection
      fields:
        - dst_ip
        - bytes_toclient

  - question: Are there enterprise systems being targeted by this amplification attack?
    context: Internal systems may be victims or unwitting participants in the DDoS campaign.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains:
            - 'DDoS'
            - 'DOS'
            - 'amplification'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature