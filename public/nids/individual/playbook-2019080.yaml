name: ET MALWARE Windows arp -a Microsoft Windows DOS prompt command exit OUTBOUND
id: 22019080
description: |
  Detects malware exfiltrating Windows ARP table information via network connections.
  May trigger on legitimate network diagnostics, but outbound transmission indicates data theft.
type: detection
detection_id: 2019080
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete ARP table data being transmitted?
    context: The ARP output reveals network topology and connected devices that malware is exfiltrating.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - rule.name

  - question: Is this authorized network diagnostic activity?
    context: Legitimate administrators may run ARP commands, but outbound transmission is suspicious.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains: "arp.exe"
        condition: selection
      fields:
        - User
        - CommandLine
        - ProcessGuid
        - ParentImage

  - question: What process initiated the ARP command and data transmission?
    context: Understanding the parent process reveals the malware family and infection vector.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains: "arp -a"
        condition: selection
      fields:
        - User
        - Image
        - ProcessGuid
        - ParentImage
        - ParentProcessGuid

  - question: What other system reconnaissance commands were executed?
    context: Malware typically runs multiple discovery commands to gather system intelligence.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - "ipconfig.exe"
            - "netstat.exe"
            - "whoami.exe"
            - "systeminfo.exe"
            - "tasklist.exe"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: Where is this reconnaissance data being transmitted?
    context: The destination reveals command and control infrastructure or data exfiltration endpoints.
    range: +15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - bytes_toclient
        - bytes_toserver
        - protocol

  - question: What malware family matches this reconnaissance pattern?
    context: The specific MD5 reference and behavior pattern helps identify the malware strain.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.hash.md5: "a22af4fc7fe011069704a15296634ca6"
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.hash.sha256
        - ProcessGuid

  - question: Has this malware established persistence mechanisms?
    context: Advanced malware creates persistence to maintain access after system reboots.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - "\\Run\\"
            - "\\RunOnce\\"
            - "\\Services\\"
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessGuid

  - question: What other data has been exfiltrated from this system?
    context: Malware often exfiltrates multiple types of system information and sensitive data.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "MALWARE"
            - "command exit"
            - "DOS prompt"
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - rule.category

  - question: Are other systems showing similar malware reconnaissance activity?
    context: Malware campaigns often target multiple systems with the same reconnaissance techniques.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "arp -a Microsoft Windows DOS prompt"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: What lateral movement attempts followed this reconnaissance?
    context: Network discovery often precedes lateral movement to other systems in the environment.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 445
            - 139
            - 3389
            - 22
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver
        - bytes_toclient