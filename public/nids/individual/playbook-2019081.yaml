name: ET MALWARE Windows set Microsoft Windows DOS prompt command exit OUTBOUND
id: 22019081
description: |
  Detects malware exfiltrating Windows environment variables via network connections.
  May trigger on legitimate system diagnostics, but outbound transmission indicates data theft.
type: detection
detection_id: 2019081
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete environment variable data being transmitted?
    context: Environment variables reveal system configuration, user context, and installed software.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - rule.name

  - question: Is this authorized system diagnostic activity?
    context: Legitimate administrators may query environment variables, but outbound transmission is suspicious.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains: "set"
        condition: selection
      fields:
        - User
        - CommandLine
        - ProcessGuid
        - ParentImage
        - Image

  - question: What process initiated the environment variable collection and transmission?
    context: Understanding the parent process reveals the malware family and infection method.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains: "cmd.exe"
        condition: selection
      fields:
        - User
        - CommandLine
        - ProcessGuid
        - ParentImage
        - ParentProcessGuid

  - question: What other system information gathering commands were executed?
    context: Malware typically runs multiple discovery commands to profile the target system.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - "systeminfo"
            - "whoami"
            - "net user"
            - "net group"
            - "tasklist"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: Where is this system intelligence being transmitted?
    context: The destination reveals command and control infrastructure or data collection endpoints.
    range: +15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - bytes_toclient
        - bytes_toserver
        - protocol

  - question: What malware family matches this system profiling behavior?
    context: The specific MD5 reference and environment variable exfiltration indicates known malware.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.hash.md5: "a22af4fc7fe011069704a15296634ca6"
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.hash.sha256
        - ProcessGuid

  - question: Has this malware modified system environment variables?
    context: Advanced malware may modify environment variables to alter system behavior or hide activity.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - "\\Environment\\"
            - "\\CurrentVersion\\Environment"
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessGuid

  - question: What sensitive information was exposed in the environment variables?
    context: Environment variables may contain credentials, paths, or configuration details useful to attackers.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - "PASSWORD"
            - "TOKEN"
            - "KEY"
            - "SECRET"
        condition: selection
      fields:
        - CommandLine
        - User
        - ProcessGuid

  - question: Are other systems showing similar environment variable exfiltration?
    context: Malware campaigns often use the same reconnaissance techniques across multiple targets.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "set Microsoft Windows DOS prompt"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: What follow-up malicious activity occurred after this system profiling?
    context: System reconnaissance typically precedes privilege escalation or lateral movement attempts.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "MALWARE"
            - "Privilege"
            - "Lateral"
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - rule.category