name: ET MALWARE Syrian Malware Checkin
id: 22019084
description: |
  Detects Syrian malware team BlackWorm communication patterns with command and control servers.
  This specific pattern indicates malware checking in with C2 infrastructure.
  Legitimate applications would not generate this specific byte pattern sequence.
type: detection
detection_id: 2019084
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete payload containing the Syrian malware signature pattern?
    context: The specific byte sequence and "[endof]" marker reveal the malware variant and communication protocol.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - http.request.body.content

  - question: What files or processes initiated this suspicious outbound connection?
    context: Identifying the source process helps determine infection vector and scope.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ProcessGuid
        - ParentImage

  # Type 2: Triage Assessment
  - question: Is this connection from a system that typically communicates externally?
    context: Determining if the source system normally makes external connections helps assess legitimacy.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|contains:
            - '!10.'
            - '!192.168.'
            - '!172.16.'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out

  # Type 3: Activity Context
  - question: What other network activity occurred from this host around the same time?
    context: Understanding concurrent network activity reveals the full scope of potential compromise.
    range: -30m/+30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_in
        - bytes_out
        - connection_state

  - question: Were there any file modifications or downloads preceding this communication?
    context: Malware often downloads additional payloads or modifies system files before establishing C2 communication.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size
        - ProcessGuid

  # Type 4: Impact Assessment
  - question: Has this malware established persistent communication with the C2 server?
    context: Multiple connections indicate successful malware installation and ongoing C2 communication.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - connection_count
        - first_seen
        - last_seen

  - question: What data has been transmitted to the external server?
    context: Understanding data exfiltration helps assess the impact and scope of the breach.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - bytes_out
        - bytes_in
        - duration

  # Type 5: Forensic Deep-Dive
  - question: What is the reputation and geolocation of the destination C2 server?
    context: C2 server analysis helps identify the threat actor and campaign infrastructure.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - geoip.country_name
        - threat_intel.category

  - question: Are there signs of additional malware families or tools on the infected system?
    context: Syrian malware teams often deploy multiple tools and backdoors for persistence.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - severity

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network communicating with this C2 infrastructure?
    context: Identifying additional compromised systems helps determine campaign scope.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - connection_count
        - bytes_out

  - question: Have similar Syrian malware indicators appeared elsewhere in the environment?
    context: Understanding the broader campaign helps with threat hunting and remediation planning.
    range: -30d
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'Syrian'
            - 'BlackWorm'
            - 'Malware'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - severity