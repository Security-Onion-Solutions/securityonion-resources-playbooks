name: ET DOS Possible SSDP Amplification Scan in Progress
id: 22019102
description: |
  Detects potential SSDP amplification attacks where attackers send M-SEARCH requests to port 1900.
  This can be part of DDoS amplification attacks or reconnaissance scanning.
  Legitimate UPnP devices may generate similar traffic during normal discovery processes.
type: detection
detection_id: 2019102
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact SSDP M-SEARCH request content and headers?
    context: The specific M-SEARCH parameters reveal whether this is legitimate UPnP discovery or malicious scanning.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - http.request.headers

  - question: How many SSDP requests were sent and what was the frequency pattern?
    context: High-frequency requests indicate scanning or amplification attacks rather than normal UPnP discovery.
    range: -5m/+5m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 1900
        condition: selection
      fields:
        - packet_count
        - dst_ip
        - bytes_out

  # Type 2: Triage Assessment
  - question: Is this source IP a known UPnP device or media server in the network?
    context: Legitimate UPnP devices regularly perform SSDP discovery, which could explain the activity.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 1900
            - 8080
            - 8200
        condition: selection
      fields:
        - dst_port
        - connection_count
        - user_agent

  - question: Does the timing align with normal UPnP device discovery patterns?
    context: Legitimate UPnP discovery typically occurs during device startup or at regular intervals.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 1900
        condition: selection
      fields:
        - timestamp
        - dst_ip
        - connection_state

  # Type 3: Activity Context
  - question: What other scanning or reconnaissance activity originated from this source?
    context: SSDP scanning often accompanies broader network reconnaissance or vulnerability scanning.
    range: -1h/+1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - connection_state

  - question: Were there any DNS queries for UPnP or media streaming services?
    context: Legitimate UPnP activity often involves DNS resolution for device discovery services.
    range: -30m/+30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.query.name|contains:
            - 'upnp'
            - 'ssdp'
            - 'dlna'
            - 'mediaserver'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.response_code

  # Type 4: Impact Assessment
  - question: How many unique targets were contacted during this scanning activity?
    context: Large numbers of targets indicate systematic scanning rather than normal device discovery.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 1900
        condition: selection
      fields:
        - unique_dst_ips
        - total_connections
        - bytes_out_total

  - question: Did any systems respond to the SSDP requests with device information?
    context: Successful responses reveal vulnerable UPnP devices that could be exploited for amplification.
    range: -15m/+15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
          src_port: 1900
        condition: selection
      fields:
        - src_ip
        - bytes_in
        - connection_state

  # Type 5: Forensic Deep-Dive
  - question: What is the source IP's reputation and geolocation?
    context: Known malicious IPs or suspicious geolocations help confirm malicious intent.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - src_ip
        - geoip.country_name
        - threat_intel.category
        - asn.organization

  - question: Are there indicators of DDoS amplification or botnet activity?
    context: SSDP amplification is commonly used in DDoS attacks and botnet operations.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - 'dos'
            - 'botnet'
            - 'amplification'
        condition: selection
      fields:
        - rule.name
        - severity
        - dst_ip

  # Type 6: Enterprise Correlation
  - question: Are other internal systems showing similar SSDP scanning patterns?
    context: Coordinated SSDP scanning from multiple sources indicates organized attack campaign.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_port: 1900
        condition: selection
      fields:
        - src_ip
        - unique_dst_ips
        - packet_count

  - question: Have there been other amplification or DDoS-related alerts in the environment?
    context: SSDP amplification often occurs alongside other DDoS techniques in coordinated attacks.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'Amplification'
            - 'DDoS'
            - 'DOS'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - severity