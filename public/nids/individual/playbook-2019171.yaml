name: ET MALWARE DoS.Linux/Elknot.E Checkin
id: 22019171
description: |
  Detects Linux Elknot malware variant E performing command and control communication.
  This malware family is known for DDoS capabilities and botnet functionality.
  The specific data size and byte pattern are unique to this malware variant.
type: detection
detection_id: 2019171
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact 401-byte payload containing the Elknot signature?
    context: The specific payload structure reveals malware configuration and C2 communication protocol.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - packet_length

  - question: What Linux processes were running at the time of this communication?
    context: Identifying the malware process helps understand infection method and persistence mechanisms.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ProcessGuid
        - User

  # Type 2: Triage Assessment
  - question: Is this a Linux server that normally runs network services?
    context: Elknot typically targets Linux servers, so understanding the system role helps assess impact.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
          dst_port|contains:
            - 22
            - 80
            - 443
            - 8080
        condition: selection
      fields:
        - src_ip
        - dst_port
        - connection_count

  - question: Are there legitimate administrative activities that could explain this traffic?
    context: Determining if this is part of normal system administration or monitoring.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          User|contains:
            - 'root'
            - 'admin'
            - 'sysadmin'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  # Type 3: Activity Context
  - question: What network connections were established before this malware checkin?
    context: Understanding the infection vector and initial compromise helps with incident response.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - bytes_in
        - connection_state

  - question: Were there any file downloads or modifications preceding the malware activity?
    context: Elknot often downloads additional components or modifies system files for persistence.
    range: -4h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size
        - ProcessGuid

  # Type 4: Impact Assessment
  - question: Has the malware established persistent communication with its C2 server?
    context: Regular communication indicates successful infection and ongoing botnet participation.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - connection_count
        - bytes_out_total
        - first_seen
        - last_seen

  - question: Are there signs of DDoS attack participation or malicious activity?
    context: Elknot is primarily used for DDoS attacks, so identifying attack traffic is critical.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - packets_out
        - connection_state

  # Type 5: Forensic Deep-Dive
  - question: What is the reputation and infrastructure details of the C2 server?
    context: C2 analysis helps identify the botnet operator and campaign infrastructure.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - geoip.country_name
        - threat_intel.category
        - asn.organization

  - question: What system files or directories have been modified by the malware?
    context: Understanding persistence mechanisms helps with complete malware removal.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - '/etc/'
            - '/bin/'
            - '/usr/bin/'
            - '/tmp/'
            - '/var/'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessImage
        - ProcessGuid

  - question: Are there signs of credential theft or lateral movement capabilities?
    context: Advanced Elknot variants may include additional backdoor and data theft functionality.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'ssh'
            - 'passwd'
            - 'shadow'
            - 'wget'
            - 'curl'
        condition: selection
      fields:
        - CommandLine
        - Image
        - User
        - ProcessGuid

  # Type 6: Enterprise Correlation
  - question: Are other Linux systems in the network showing similar Elknot indicators?
    context: Elknot often spreads through SSH brute force attacks and vulnerability exploitation.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'Elknot'
            - 'Linux'
            - 'Malware'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - alert_count

  - question: Have there been SSH brute force or vulnerability scanning attempts in the environment?
    context: Understanding the initial attack vector helps prevent further infections.
    range: -48h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'SSH'
            - 'Brute'
            - 'Scan'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - severity