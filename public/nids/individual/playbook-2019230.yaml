name: ET MALWARE Possible Tinba DGA NXDOMAIN Responses
id: 22019230
description: |
  Detects potential Tinba banking trojan Domain Generation Algorithm (DGA) activity through DNS NXDOMAIN responses.
  Identifies patterns of failed DNS queries to algorithmically generated domains used for C2 communication.
  May occasionally trigger on legitimate applications with similar DNS query patterns.
type: detection
detection_id: 2019230
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What were the specific algorithmically generated domain names being queried?
    context: DGA domains follow predictable patterns that help identify the malware variant and generation algorithm.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.response_code

  - question: What DNS query patterns and characteristics were observed in this DGA activity?
    context: Understanding query structure helps distinguish malicious DGA from legitimate DNS failures.
    range: +/-5m
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          dns.response_code: 'NXDOMAIN'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.response_code

  # Type 2: Triage Assessment
  - question: Is this host known to run applications that might generate similar DNS query patterns?
    context: Some legitimate applications may generate failed DNS queries that could mimic DGA behavior.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.response_code

  - question: Does the timing and frequency of DNS queries align with normal user activity?
    context: DGA activity often occurs at regular intervals or during non-business hours when users are inactive.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.response_code

  # Type 3: Activity Context
  - question: What process initiated these DNS queries on the infected host?
    context: Identifying the process helps determine how the Tinba malware was executed and its persistence mechanism.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ParentImage

  - question: What other network activity occurred from this host around the DGA queries?
    context: Malware often performs additional network operations like C2 communication or data exfiltration alongside DGA.
    range: +/-30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto
        - conn_state

  - question: Were there any successful DNS resolutions mixed with the NXDOMAIN responses?
    context: DGA algorithms eventually find active C2 domains, which would result in successful DNS resolutions.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          dns.response_code: 'NOERROR'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  # Type 4: Impact Assessment
  - question: Did any of the DGA domains successfully resolve to active C2 infrastructure?
    context: Successful domain resolution indicates active C2 communication and potential data exfiltration capability.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - orig_bytes
        - resp_bytes

  - question: Are there signs of banking or financial data access on this host?
    context: Tinba specifically targets banking credentials and financial information for theft.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          url.full|contains:
            - 'bank'
            - 'financial'
            - 'login'
            - 'account'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.response.status_code

  # Type 5: Forensic Deep-Dive
  - question: What specific Tinba variant characteristics are present in the DGA pattern?
    context: Different Tinba variants use distinct DGA algorithms that help identify the specific threat and its capabilities.
    range: +/-6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains:
            - 'Tinba'
            - 'DGA'
        condition: selection
      fields:
        - alert.signature
        - alert.category
        - dst_ip

  - question: What files were created or modified around the time of DGA activity?
    context: Understanding malware persistence and payload deployment helps with cleanup and forensic analysis.
    range: +/-1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessImage

  - question: Are there any registry modifications associated with this Tinba infection?
    context: Banking trojans often modify registry settings for persistence and to evade security controls.
    range: +/-1h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessImage

  # Type 6: Enterprise Correlation
  - question: Are other hosts in the network showing similar Tinba DGA activity?
    context: Banking trojans may spread laterally or be part of broader campaigns affecting multiple systems.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: 'Tinba DGA'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature

  - question: What other banking trojan or financial malware indicators appear across the enterprise?
    context: Tinba infections may be part of larger financial crime campaigns using multiple malware families.
    range: +/-7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains:
            - 'banking'
            - 'financial'
            - 'trojan'
        condition: selection
      fields:
        - src_ip
        - alert.signature
        - alert.category