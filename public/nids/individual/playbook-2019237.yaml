name: ET EXPLOIT Possible CVE-2014-6271 exploit attempt via malicious DHCP ACK
id: 22019237
description: |
  Detects potential Shellshock (CVE-2014-6271) exploitation attempts through malicious DHCP ACK responses.
  DHCP clients may be vulnerable if they execute shell commands based on DHCP option values.
  May trigger on legitimate DHCP traffic containing similar byte patterns.
type: detection
detection_id: 2019237
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete DHCP ACK payload that triggered this alert?
    context: Analyzing the full DHCP response reveals the exploitation method and payload.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - rule.name

  - question: What DHCP options were included in the malicious response?
    context: Shellshock DHCP attacks often target specific options like hostname or domain-name.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          src_port: 67
          dst_port: 68
          proto: UDP
        condition: selection
      fields:
        - bytes_toserver
        - bytes_toclient
        - duration

  # Type 2: Triage Assessment
  - question: Is the source IP a legitimate DHCP server for this network?
    context: Unauthorized DHCP servers indicate rogue infrastructure or compromised systems.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          src_port: 67
          proto: UDP
        condition: selection
      fields:
        - dst_ip
        - community_id

  - question: Has this client recently requested DHCP services normally?
    context: Understanding normal DHCP behavior helps distinguish attacks from legitimate traffic.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 68
          proto: UDP
        condition: selection
      fields:
        - src_ip
        - src_port

  # Type 3: Activity Context
  - question: What DHCP discovery or request preceded this ACK response?
    context: Legitimate DHCP follows DORA sequence; attacks may skip normal negotiation.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 68
          proto: UDP
        condition: selection
      fields:
        - src_ip
        - src_port
        - bytes_toserver

  - question: Are there signs of shell command execution on the target system?
    context: Successful Shellshock exploitation results in command execution and process creation.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  # Type 4: Impact Assessment
  - question: Did the target system exhibit signs of compromise after the DHCP response?
    context: Post-exploitation activity indicates successful Shellshock attack execution.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto

  - question: Are there network connections indicating payload download or C2 communication?
    context: Shellshock attacks often download additional payloads or establish backdoors.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          proto: TCP
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toclient

  # Type 5: Forensic Deep-Dive
  - question: What specific Shellshock payload pattern was embedded in the DHCP response?
    context: Analyzing the exact exploit code reveals attacker capabilities and intent.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'CVE-2014-6271'
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - payload_printable
        - rule.signature

  - question: Are there file system changes consistent with Shellshock exploitation?
    context: Successful attacks may create files, modify configurations, or install backdoors.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessName

  # Type 6: Enterprise Correlation
  - question: Are other systems receiving similar malicious DHCP responses?
    context: Coordinated DHCP attacks may target multiple systems simultaneously.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'CVE-2014-6271 exploit attempt via malicious DHCP'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.signature

  - question: Is this part of broader Shellshock exploitation campaign across the network?
    context: Attackers often use multiple vectors to exploit Shellshock vulnerabilities.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'CVE-2014-6271'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.category