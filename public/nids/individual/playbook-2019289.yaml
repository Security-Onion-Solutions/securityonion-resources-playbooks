name: ET EXPLOIT Possible CVE-2014-6271 Attempt Against SIP Proxy
id: 22019289
description: |
  Detects potential Shellshock (CVE-2014-6271) exploitation attempts targeting SIP proxies.
  SIP servers may be vulnerable if they process SIP headers through shell commands.
  May trigger on legitimate SIP traffic containing similar byte patterns in headers.
type: detection
detection_id: 2019289
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete SIP message containing the Shellshock payload?
    context: Analyzing the full SIP request reveals the exploitation vector and target headers.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - rule.name

  - question: Which SIP headers contained the malicious Shellshock pattern?
    context: Shellshock SIP attacks commonly target User-Agent, Via, or Contact headers.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 5060
            - 5061
          proto: UDP
        condition: selection
      fields:
        - bytes_toserver
        - bytes_toclient
        - community_id

  # Type 2: Triage Assessment
  - question: Is this source IP a known SIP client or gateway in the environment?
    context: Legitimate SIP endpoints help distinguish attacks from normal VoIP traffic.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 5060
            - 5061
        condition: selection
      fields:
        - dst_ip
        - proto
        - bytes_toserver

  - question: Does the target SIP server normally handle requests from this source?
    context: Unusual source patterns may indicate scanning or targeted exploitation.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 5060
            - 5061
        condition: selection
      fields:
        - src_ip
        - proto

  # Type 3: Activity Context
  - question: What SIP method was used to deliver the Shellshock payload?
    context: Different SIP methods (INVITE, REGISTER, OPTIONS) indicate attack sophistication.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 5060
            - 5061
        condition: selection
      fields:
        - bytes_toserver
        - duration
        - proto

  - question: Was there SIP scanning activity preceding this exploitation attempt?
    context: Attackers often scan for SIP services before launching targeted exploits.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 5060
            - 5061
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - duration

  # Type 4: Impact Assessment
  - question: Did the SIP server process exhibit signs of compromise after the request?
    context: Successful Shellshock exploitation results in command execution on the SIP server.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  - question: Are there outbound connections from the SIP server indicating payload execution?
    context: Compromised SIP servers may download additional payloads or establish C2 channels.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          proto: TCP
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toclient

  # Type 5: Forensic Deep-Dive
  - question: What specific Shellshock command was embedded in the SIP headers?
    context: Analyzing the exact payload reveals attacker intent and post-exploitation plans.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'CVE-2014-6271 Attempt Against SIP'
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - payload_printable
        - rule.signature

  - question: Were SIP configuration files or logs modified after the attack?
    context: Successful exploitation may result in configuration changes or log tampering.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetFilename|contains:
            - 'sip'
            - 'asterisk'
            - 'kamailio'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessName

  # Type 6: Enterprise Correlation
  - question: Are other SIP servers in the environment receiving similar attack attempts?
    context: Coordinated attacks may target multiple VoIP infrastructure components.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'CVE-2014-6271 Attempt Against SIP'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.signature

  - question: Is this part of broader VoIP infrastructure reconnaissance or attack campaign?
    context: SIP attacks often accompany broader telecommunications infrastructure targeting.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains: 'EXPLOIT'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - rule.name