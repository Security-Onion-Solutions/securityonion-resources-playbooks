name: ET MALWARE Likely Bot Nick in IRC (Country Code ISO 3166-1 alpha-2)
id: 22019326
description: |
  Detects IRC bot activity using country code patterns as nicknames, indicating automated malware communication.
  Legitimate IRC users typically don't use ISO country codes as nicknames in systematic patterns.
  This behavior is characteristic of botnets using geographic identifiers for organization.
type: detection
detection_id: 2019326
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What specific country code nickname pattern was detected in the IRC communication?
    context: The country code reveals the bot's geographic targeting or organizational scheme.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - src_ip
        - dst_ip

  - question: What was the complete IRC NICK command and associated metadata?
    context: Full IRC protocol analysis reveals bot capabilities and C2 communication patterns.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 6667
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - tx_bytes
        - rx_bytes
        - duration
        - connection_state

  # Type 2: Triage Assessment
  - question: Is this system authorized to use IRC for business purposes?
    context: Most corporate environments prohibit IRC usage, making any IRC traffic suspicious.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 6667
            - 6668
            - 6669
            - 194
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection_state

  - question: Has this user or system been approved for IRC client software?
    context: Legitimate IRC usage would typically involve approved client software and documented business need.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'irc'
            - 'mirc'
            - 'xchat'
            - 'hexchat'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  # Type 3: Activity Context
  - question: What initiated the IRC connection and bot registration sequence?
    context: Understanding the trigger helps identify the malware installation or activation method.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 6667
        condition: selection
      fields:
        - connection_state
        - orig_bytes
        - resp_bytes
        - duration

  - question: What other IRC protocol commands were sent during this session?
    context: Full IRC session analysis reveals bot capabilities and command structure.
    range: +/-15m
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: 'IRC'
        condition: selection
      fields:
        - rule.name
        - payload_printable

  # Type 4: Impact Assessment
  - question: Has the bot joined IRC channels or received commands from the C2?
    context: Channel joining and command reception indicate active bot participation in botnet operations.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'IRC'
            - 'JOIN'
            - 'PRIVMSG'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - payload_printable

  - question: What network resources has the infected system accessed since IRC registration?
    context: Post-infection activity reveals the bot's operational capabilities and potential damage.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - tx_bytes
        - connection_state

  # Type 5: Forensic Deep-Dive
  - question: What malware family or bot variant is responsible for this IRC activity?
    context: Identifying the specific malware helps understand capabilities and removal procedures.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - 'trojan'
            - 'malware'
            - 'bot'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - payload_printable

  - question: What processes are maintaining the IRC connection and bot functionality?
    context: Process analysis reveals the malware executable and helps with incident response.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - '6667'
            - 'irc'
            - 'connect'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ProcessGuid
        - ParentImage

  - question: Has the malware established persistence mechanisms for IRC connectivity?
    context: Understanding persistence helps ensure complete malware removal and system recovery.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - 'autostart'
            - 'startup'
            - 'cron'
            - 'init'
        condition: selection
      fields:
        - TargetFilename
        - ProcessName
        - file.hash.md5

  # Type 6: Enterprise Correlation
  - question: Are other systems showing similar IRC bot behavior with country code patterns?
    context: Coordinated botnet campaigns typically infect multiple systems using similar communication patterns.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: 'ET MALWARE Likely Bot Nick in IRC (Country Code ISO 3166-1 alpha-2)'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - payload_printable

  - question: What IRC servers are being used across the enterprise for potential botnet communication?
    context: Identifying C2 infrastructure helps with network-level blocking and threat intelligence.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_port|contains:
            - 6667
            - 6668
            - 6669
        condition: selection
      fields:
        - dst_ip
        - src_ip
        - connection_state