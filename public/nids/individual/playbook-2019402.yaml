name: ET EXPLOIT Possible CVE-2014-6271 malicious DNS response
id: 22019402
description: |
  Detects potential Shellshock (CVE-2014-6271) exploitation attempts via malicious DNS responses.
  DNS clients may be vulnerable if they process DNS response data through shell commands.
  May trigger on legitimate DNS traffic containing similar byte patterns in response data.
type: detection
detection_id: 2019402
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete DNS response containing the Shellshock payload?
    context: Analyzing the full DNS response reveals the exploitation vector and payload delivery method.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - rule.name

  - question: Which DNS record type and field contained the malicious pattern?
    context: Shellshock DNS attacks commonly target TXT records, CNAME responses, or PTR lookups.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          dns.resolved_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.response_code

  # Type 2: Triage Assessment
  - question: Is the responding DNS server legitimate for this domain query?
    context: Unauthorized DNS responses indicate DNS poisoning or rogue DNS infrastructure.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          dns.resolved_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name

  - question: Does the querying client normally perform DNS lookups for this domain?
    context: Understanding normal DNS behavior helps distinguish attacks from legitimate queries.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.resolved_ip

  # Type 3: Activity Context
  - question: What DNS query triggered this malicious response?
    context: The original query reveals whether this was targeted or opportunistic exploitation.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          dns.resolved_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.response_code

  - question: Was there DNS reconnaissance activity preceding this response?
    context: Attackers often perform DNS enumeration before delivering malicious responses.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.resolved_ip

  # Type 4: Impact Assessment
  - question: Did the DNS client system exhibit signs of compromise after receiving the response?
    context: Successful Shellshock exploitation results in command execution on the DNS client.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  - question: Are there network connections indicating payload execution from the DNS client?
    context: Compromised DNS clients may download additional payloads or establish C2 channels.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          proto: TCP
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toclient

  # Type 5: Forensic Deep-Dive
  - question: What specific Shellshock command was embedded in the DNS response data?
    context: Analyzing the exact payload reveals attacker intent and post-exploitation objectives.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'CVE-2014-6271 malicious DNS response'
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - payload_printable
        - rule.signature

  - question: Were DNS resolver configurations or cache files modified after the attack?
    context: Successful exploitation may result in DNS configuration tampering or cache poisoning.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetFilename|contains:
            - 'resolv.conf'
            - 'named.conf'
            - 'dns'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessName

  # Type 6: Enterprise Correlation
  - question: Are other systems receiving similar malicious DNS responses from this server?
    context: DNS poisoning attacks often target multiple clients simultaneously.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'CVE-2014-6271 malicious DNS response'
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - rule.signature

  - question: Is this part of broader DNS infrastructure compromise or poisoning campaign?
    context: Malicious DNS responses often indicate broader DNS infrastructure targeting.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.category|contains: 'EXPLOIT'
          dst_port: 53
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name