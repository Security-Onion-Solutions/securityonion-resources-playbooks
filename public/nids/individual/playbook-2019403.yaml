name: ET EXPLOIT Possible CVE-2014-6271 exploit attempt via malicious DNS
id: 22019403
description: |
  Detects potential Shellshock (CVE-2014-6271) exploitation attempts via malicious DNS over TCP.
  DNS clients may be vulnerable if they process DNS response data through shell commands.
  May trigger on legitimate DNS over TCP traffic containing similar byte patterns.
type: detection
detection_id: 2019403
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete DNS over TCP response containing the Shellshock payload?
    context: Analyzing the full TCP DNS response reveals the exploitation vector and payload structure.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - rule.name

  - question: Which DNS record field contained the malicious Shellshock pattern in the TCP response?
    context: TCP DNS allows larger payloads, enabling more complex Shellshock exploitation vectors.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          dns.resolved_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.response_code

  # Type 2: Triage Assessment
  - question: Is this DNS server authorized to respond for the queried domain?
    context: Unauthorized TCP DNS responses indicate DNS hijacking or rogue server activity.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          dns.resolved_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name

  - question: Does the client normally use DNS over TCP for queries?
    context: TCP DNS is less common and may indicate targeted exploitation or large response handling.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_port: 53
          proto: TCP
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - bytes_toclient

  # Type 3: Activity Context
  - question: What DNS query over TCP preceded this malicious response?
    context: TCP DNS queries often indicate large responses or specific record types being targeted.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
          dst_port: 53
          proto: TCP
        condition: selection
      fields:
        - bytes_toserver
        - bytes_toclient
        - duration

  - question: Was there DNS over UDP activity that triggered a TCP fallback?
    context: Large DNS responses often cause UDP to TCP fallback, creating exploitation opportunities.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_port: 53
          proto: UDP
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - bytes_toclient

  # Type 4: Impact Assessment
  - question: Did the DNS client show signs of compromise after receiving the TCP response?
    context: Successful Shellshock exploitation results in command execution on the client system.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  - question: Are there network connections indicating payload download or C2 establishment?
    context: Compromised DNS clients may establish backdoors or download additional malware.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          proto: TCP
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toclient

  # Type 5: Forensic Deep-Dive
  - question: What specific Shellshock command was embedded in the TCP DNS response?
    context: TCP DNS allows larger payloads, potentially containing more sophisticated exploit code.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'CVE-2014-6271 exploit attempt via malicious DNS'
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - payload_printable
        - rule.signature

  - question: Were DNS client applications or resolver libraries modified after the attack?
    context: Successful exploitation may target DNS resolver components or client applications.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetFilename|contains:
            - 'libresolv'
            - 'dnsmasq'
            - 'systemd-resolved'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessName

  # Type 6: Enterprise Correlation
  - question: Are other systems receiving similar malicious TCP DNS responses?
    context: Coordinated DNS attacks may target multiple clients with TCP-based exploitation.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'CVE-2014-6271 exploit attempt via malicious DNS'
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - rule.signature

  - question: Is this part of broader DNS infrastructure compromise targeting TCP responses?
    context: TCP DNS exploitation often indicates sophisticated DNS infrastructure targeting.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 53
          proto: TCP
        condition: selection
      fields:
        - dst_ip
        - bytes_toclient
        - duration