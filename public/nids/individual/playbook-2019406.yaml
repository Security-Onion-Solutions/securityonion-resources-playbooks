name: ET HUNTING SUSPICIOUS SMTP Attachment Inbound PPT with Embedded OLE Object
id: 22019406
description: |
  Detects inbound PowerPoint attachments containing embedded OLE objects that may harbor malicious content.
  May indicate targeted phishing campaigns or legitimate business documents with embedded objects.
type: detection
detection_id: 2019406
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the exact PowerPoint attachment pattern that triggered this OLE object detection?
    context: Understanding the embedded OLE structure helps determine if this contains malicious macros or legitimate business content.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - src_ip
        - dst_ip
  - question: Is this normal business communication for this email server?
    context: Legitimate business communications often include PowerPoint presentations with embedded objects.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 25
            - 587
            - 465
        condition: selection
      fields:
        - src_ip
        - bytes_sent
        - bytes_received
        - duration
  - question: What email activity preceded this suspicious PowerPoint attachment?
    context: Understanding the email session helps identify if this is part of a targeted phishing campaign.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 25
            - 587
            - 465
        condition: selection
      fields:
        - protocol
        - bytes_sent
        - bytes_received
        - connection_state
  - question: Has this source sent other suspicious email attachments recently?
    context: Correlating with other suspicious attachments helps identify persistent phishing campaigns.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "SMTP Attachment"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - community_id
  - question: What legitimate email services are running on the targeted server?
    context: Understanding legitimate email services helps distinguish between attacks and normal business communications.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 25
            - 587
            - 465
          connection_state: "established"
        condition: selection
      fields:
        - src_ip
        - bytes_sent
        - bytes_received
        - duration
  - question: Are there successful email deliveries from this source?
    context: Legitimate email senders may occasionally trigger attachment detections during normal business communications.
    range: -4h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 25
            - 587
            - 465
          connection_state: "established"
        condition: selection
      fields:
        - dst_ip
        - duration
        - bytes_sent
        - bytes_received
  - question: What domain reputation exists for the email sender?
    context: Analyzing sender domain reputation helps assess the likelihood of malicious intent.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name
  - question: Has this PowerPoint attachment been successfully delivered and opened?
    context: Determining delivery success helps assess immediate threat and potential system compromise.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 25
            - 587
            - 465
        condition: selection
      fields:
        - bytes_sent
        - bytes_received
        - duration
        - connection_state
  - question: Are there signs of macro execution following this email delivery?
    context: Malicious PowerPoint attachments often contain macros that execute upon opening.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          Image|contains:
            - "powerpnt.exe"
            - "winword.exe"
            - "excel.exe"
        condition: selection
      fields:
        - Image
        - CommandLine
        - ProcessGuid
        - User
  - question: Are other email servers in the network receiving similar suspicious PowerPoint attachments?
    context: Identifying enterprise-wide phishing campaigns helps understand attack scope and implement coordinated defenses.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "PPT attachment with Embedded OLE"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - community_id