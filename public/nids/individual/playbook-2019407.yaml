name: ET HUNTING SUSPICIOUS SMTP Attachment Inbound PPT attachment with Embedded OLE Object M2
id: 22019407
description: |
  Detects PowerPoint attachments with embedded OLE objects via SMTP traffic using base64 encoded patterns.
  May trigger on legitimate PowerPoint files with embedded objects or macros for business purposes.
type: detection
detection_id: 2019407
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete base64 encoded content that triggered this alert?
    context: Analyzing the full encoded payload reveals the actual PowerPoint structure and embedded OLE object type.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - smtp.data
        - smtp.content_type
        - smtp.attachment_name

  - question: Is this PowerPoint attachment expected from this sender?
    context: Legitimate business communications may include PowerPoint files with embedded objects.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 25
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - bytes_sent

  - question: What other SMTP traffic occurred from this source around the same time?
    context: Understanding email volume and patterns helps identify targeted attacks versus bulk campaigns.
    range: -1h/+1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 25
        condition: selection
      fields:
        - dst_ip
        - bytes_sent
        - duration

  - question: What is the complete email structure and headers for this message?
    context: Email metadata reveals sender reputation, routing, and potential spoofing indicators.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - smtp.mail_from
        - smtp.rcpt_to
        - smtp.subject
        - smtp.message_id

  - question: Has this attachment been successfully delivered and opened?
    context: Successful delivery indicates potential compromise requiring immediate response.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - 'powerpnt.exe'
            - 'POWERPNT.EXE'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  - question: Are there signs of OLE object execution or macro activity?
    context: OLE objects can execute malicious code, requiring analysis of post-delivery system behavior.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          CommandLine|contains:
            - 'wscript'
            - 'cscript'
            - 'powershell'
            - 'cmd.exe'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ParentImage

  - question: What file system activity occurred after potential PowerPoint execution?
    context: Malicious OLE objects often drop additional payloads or create persistence mechanisms.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetFilename|contains:
            - '.exe'
            - '.dll'
            - '.scr'
            - '.bat'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessGuid

  - question: Are there network connections initiated after PowerPoint activity?
    context: Malicious documents often establish command and control communications or download additional payloads.
    range: +6h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_sent
        - bytes_received

  - question: Has similar PowerPoint malware been detected on other systems?
    context: Coordinated email campaigns often target multiple recipients simultaneously.
    range: -2h/+2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'PPT attachment with Embedded OLE Object'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: What is the reputation and geolocation of the sending IP address?
    context: Malicious campaigns often originate from compromised or suspicious infrastructure.
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - geoip.country_name

  - question: Are there indicators of lateral movement from the targeted system?
    context: Successful compromise may lead to internal network reconnaissance and lateral movement.
    range: +24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 445
            - 139
            - 3389
            - 5985
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_sent