name: ET HUNTING SUSPICIOUS SMTP Attachment Inbound PPT attachment with Embedded OLE Object M3
id: 22019408
description: |
  Detects PowerPoint attachments with embedded OLE objects via SMTP traffic using base64 encoded patterns (variant M3).
  May trigger on legitimate PowerPoint files with embedded objects or macros for business purposes.
type: detection
detection_id: 2019408
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete base64 encoded content that triggered this M3 variant detection?
    context: Analyzing the specific M3 pattern reveals the PowerPoint structure and embedded OLE object characteristics.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - smtp.data
        - smtp.content_type
        - smtp.attachment_name

  - question: Is this sender known to send legitimate PowerPoint attachments?
    context: Establishing sender reputation helps distinguish between targeted attacks and normal business communications.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 25
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - bytes_sent

  - question: What other suspicious email attachments were sent from this source?
    context: Attackers often send multiple malicious attachments in coordinated campaigns.
    range: -24h/+24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: 'SMTP Attachment'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - smtp.attachment_name

  - question: What are the complete email headers and metadata for this message?
    context: Email routing and authentication headers reveal potential spoofing and campaign infrastructure.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - smtp.mail_from
        - smtp.rcpt_to
        - smtp.subject
        - smtp.helo

  - question: Was the PowerPoint attachment successfully opened on the target system?
    context: Successful opening indicates potential execution of embedded malicious content.
    range: +3h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - 'powerpnt.exe'
            - 'POWERPNT.EXE'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  - question: Are there signs of malicious macro or OLE object execution?
    context: Embedded OLE objects can execute code, requiring analysis of subsequent system activity.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - 'wscript.exe'
            - 'cscript.exe'
            - 'powershell.exe'
            - 'cmd.exe'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ParentImage

  - question: What files were created or modified after PowerPoint execution?
    context: Malicious documents often drop payloads or create persistence mechanisms on the file system.
    range: +6h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetFilename|contains:
            - '.exe'
            - '.dll'
            - '.vbs'
            - '.js'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessGuid

  - question: Did the system initiate suspicious network connections after document opening?
    context: Malicious documents commonly establish C2 communications or download additional malware.
    range: +8h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_sent
        - bytes_received

  - question: Are there similar M3 variant detections across other enterprise systems?
    context: Coordinated campaigns often target multiple users with the same malicious attachment variant.
    range: -4h/+4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: 'ET HUNTING SUSPICIOUS SMTP Attachment Inbound PPT attachment with Embedded OLE Object M3'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - smtp.rcpt_to

  - question: What is the infrastructure profile of the sending system?
    context: Understanding sender infrastructure helps identify compromised systems or malicious hosting.
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - geoip.country_name

  - question: Has the targeted system shown signs of compromise or lateral movement?
    context: Successful document-based attacks often lead to internal network reconnaissance and privilege escalation.
    range: +48h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 445
            - 139
            - 3389
            - 22
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_sent