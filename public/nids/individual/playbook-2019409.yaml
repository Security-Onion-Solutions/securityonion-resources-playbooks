name: ET HUNTING SUSPICIOUS SMTP Attachment Inbound PPT attachment with Embedded OLE Object M4
id: 22019409
description: |
  Detects PowerPoint attachments with embedded OLE objects via SMTP traffic using specific base64 pattern (M4 variant).
  May trigger on legitimate PowerPoint files with embedded objects or macros for business purposes.
type: detection
detection_id: 2019409
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What does the detected base64 string decode to in this M4 variant?
    context: The specific M4 pattern "cHB0L2VtYmVkZGluZ3Mvb2xlT2JqZWN0" decodes to reveal PowerPoint OLE object structure.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - smtp.data
        - smtp.content_type
        - smtp.attachment_name

  - question: Is this attachment from a trusted business partner or internal source?
    context: Legitimate PowerPoint files with OLE objects are common in business environments for presentations and reports.
    range: -14d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 25
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - bytes_sent

  - question: What is the timing pattern of this email relative to business hours?
    context: Malicious campaigns often occur outside normal business hours to avoid detection.
    range: -6h/+6h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 25
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - bytes_sent

  - question: What are the email sender details and authentication status?
    context: Analyzing sender authentication helps identify spoofed or compromised email accounts.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - smtp.mail_from
        - smtp.rcpt_to
        - smtp.subject
        - smtp.message_id

  - question: Did the recipient system execute PowerPoint to open this attachment?
    context: Successful execution indicates potential activation of embedded malicious content.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - 'powerpnt.exe'
            - 'POWERPNT.EXE'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  - question: Are there indicators of OLE object activation or macro execution?
    context: OLE objects can contain malicious code that executes when the document is opened.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          ParentImage|contains: 'powerpnt.exe'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ParentImage

  - question: What suspicious file system activity occurred after document opening?
    context: Malicious OLE objects often create files, modify registry, or establish persistence mechanisms.
    range: +6h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetFilename|contains:
            - '.exe'
            - '.dll'
            - '.scr'
            - '.bat'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessGuid

  - question: Did the system establish unusual network connections post-execution?
    context: Document-based malware commonly initiates C2 communications or downloads additional payloads.
    range: +8h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_sent
        - bytes_received

  - question: Are other systems receiving similar M4 variant attachments?
    context: Mass email campaigns often use the same malicious attachment across multiple targets.
    range: -2h/+2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: 'ET HUNTING SUSPICIOUS SMTP Attachment Inbound PPT attachment with Embedded OLE Object M4'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - smtp.rcpt_to

  - question: What is the geolocation and reputation of the sending infrastructure?
    context: Malicious campaigns often originate from compromised systems or suspicious hosting providers.
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - geoip.country_name

  - question: Has the targeted system exhibited signs of lateral movement or data exfiltration?
    context: Successful compromise via malicious documents often leads to broader network compromise.
    range: +72h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 445
            - 139
            - 3389
            - 5985
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_sent