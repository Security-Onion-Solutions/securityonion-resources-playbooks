name: ET HUNTING SUSPICIOUS SMTP Attachment Inbound PPT attachment with Embedded OLE Object M5
id: 22019410
description: |
  Detects PowerPoint attachments with embedded OLE objects via SMTP traffic using specific base64 pattern (M5 variant).
  May trigger on legitimate PowerPoint files with embedded objects or macros for business purposes.
type: detection
detection_id: 2019410
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What does the M5 variant base64 pattern decode to specifically?
    context: The pattern "cHQvZW1iZWRkaW5ncy9vbGVPYmplY3" reveals specific PowerPoint OLE object embedding structure.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - smtp.data
        - smtp.content_type
        - smtp.attachment_name

  - question: Is this sender authorized to send PowerPoint attachments to this recipient?
    context: Establishing legitimate business relationship helps distinguish between targeted attacks and normal communications.
    range: -21d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 25
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - bytes_sent

  - question: What is the frequency and volume of emails from this sender?
    context: Unusual email patterns may indicate compromised accounts or malicious campaign infrastructure.
    range: -7d/+1d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 25
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - bytes_sent

  - question: What are the complete email headers and routing information?
    context: Email authentication and routing details help identify spoofing attempts and malicious infrastructure.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - smtp.mail_from
        - smtp.rcpt_to
        - smtp.subject
        - smtp.helo

  - question: Was PowerPoint launched to open this suspicious attachment?
    context: Successful document opening indicates potential execution of embedded malicious OLE objects.
    range: +3h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - 'powerpnt.exe'
            - 'POWERPNT.EXE'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  - question: Are there signs of malicious OLE object execution or script activity?
    context: OLE objects can execute various types of malicious code including scripts and executables.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - 'wscript.exe'
            - 'cscript.exe'
            - 'powershell.exe'
            - 'mshta.exe'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ParentImage

  - question: What file system modifications occurred after PowerPoint execution?
    context: Malicious documents often drop additional payloads or modify system files for persistence.
    range: +6h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetFilename|contains:
            - '.exe'
            - '.dll'
            - '.vbs'
            - '.js'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessGuid

  - question: Did the system initiate suspicious outbound network connections?
    context: Document-based malware typically establishes command and control communications or downloads additional components.
    range: +12h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_sent
        - bytes_received

  - question: Are other enterprise systems being targeted with M5 variant attachments?
    context: Coordinated email campaigns often distribute the same malicious attachment variant to multiple recipients.
    range: -4h/+4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: 'ET HUNTING SUSPICIOUS SMTP Attachment Inbound PPT attachment with Embedded OLE Object M5'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - smtp.rcpt_to

  - question: What is the infrastructure profile and reputation of the email sender?
    context: Analyzing sender infrastructure helps identify compromised systems or malicious hosting environments.
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - geoip.country_name

  - question: Has the compromised system attempted lateral movement or privilege escalation?
    context: Successful document-based compromise often leads to internal network reconnaissance and further attacks.
    range: +96h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 445
            - 139
            - 3389
            - 5985
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_sent