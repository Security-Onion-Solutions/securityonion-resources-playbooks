name: ET HUNTING SUSPICIOUS SMTP Attachment Inbound PPT attachment with Embedded OLE Object M6
id: 22019411
description: |
  Detects PowerPoint attachments with embedded OLE objects via SMTP traffic using specific base64 pattern (M6 variant).
  May trigger on legitimate PowerPoint files with embedded objects or macros for business purposes.
type: detection
detection_id: 2019411
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What does the M6 variant base64 string decode to reveal?
    context: The pattern "BwdC9lbWJlZGRpbmdzL29sZU9iamVjd" provides insight into the PowerPoint OLE object structure and content.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - smtp.data
        - smtp.content_type
        - smtp.attachment_name

  - question: Is this email sender part of normal business communications?
    context: Legitimate PowerPoint attachments with OLE objects are common in business environments for presentations and embedded content.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 25
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - bytes_sent

  - question: What is the email delivery pattern and timing for this sender?
    context: Analyzing email timing patterns helps identify automated malicious campaigns versus legitimate business communications.
    range: -24h/+6h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 25
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - bytes_sent

  - question: What are the email authentication and sender verification details?
    context: Email header analysis reveals potential spoofing attempts and helps validate sender legitimacy.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - smtp.mail_from
        - smtp.rcpt_to
        - smtp.subject
        - smtp.message_id

  - question: Did the recipient successfully open the PowerPoint attachment?
    context: PowerPoint execution indicates potential activation of embedded malicious OLE objects requiring immediate analysis.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - 'powerpnt.exe'
            - 'POWERPNT.EXE'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  - question: Are there indicators of OLE object activation or embedded code execution?
    context: OLE objects can contain various types of malicious payloads that execute when the document is opened.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          ParentImage|contains: 'powerpnt.exe'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ParentImage

  - question: What file system changes occurred following PowerPoint document opening?
    context: Malicious OLE objects often create files, drop payloads, or establish persistence mechanisms on the system.
    range: +6h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetFilename|contains:
            - '.exe'
            - '.dll'
            - '.scr'
            - '.bat'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessGuid

  - question: Did the system establish suspicious network connections after document execution?
    context: Document-based malware commonly initiates command and control communications or downloads additional malicious components.
    range: +8h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_sent
        - bytes_received

  - question: Are multiple systems receiving similar M6 variant malicious attachments?
    context: Mass email campaigns often distribute identical malicious attachments to multiple targets simultaneously.
    range: -3h/+3h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: 'ET HUNTING SUSPICIOUS SMTP Attachment Inbound PPT attachment with Embedded OLE Object M6'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - smtp.rcpt_to

  - question: What is the geographic and infrastructure profile of the email sender?
    context: Understanding sender infrastructure helps identify compromised systems or malicious hosting providers used in campaigns.
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - geoip.country_name

  - question: Has the targeted system shown evidence of lateral movement or data theft?
    context: Successful document-based attacks often escalate to broader network compromise and data exfiltration activities.
    range: +120h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 445
            - 139
            - 3389
            - 5985
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_sent