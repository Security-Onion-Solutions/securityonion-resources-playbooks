name: ET MALWARE FrameworkPOS Covert DNS CnC Beacon 1
id: 22019454
description: |
  Detects FrameworkPOS malware using covert DNS channels for command and control communication.
  This POS malware exfiltrates payment card data through specially crafted DNS queries.
  May trigger on legitimate applications using similar DNS query patterns or hex-encoded data.
type: detection
detection_id: 2019454
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact DNS query structure and hex-encoded payload in the FrameworkPOS beacon?
    context: Analyzing the DNS query format reveals the data exfiltration method and potential payment card information.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - src_ip
        - dns.query.name
        - dns.query.type_name

  - question: What domain is being used for the covert DNS communication channel?
    context: Identifying the C2 domain helps understand the threat actor's infrastructure and block additional communications.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.response_code

  # Type 2: Triage Assessment
  - question: Is this system a known point-of-sale terminal or payment processing device?
    context: FrameworkPOS specifically targets POS systems, so confirming system type helps validate the threat.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_port
        - dst_ip
        - bytes_toserver

  - question: Does this system normally generate DNS queries with hex-encoded subdomains?
    context: Legitimate applications rarely use hex-encoded DNS queries, making this pattern highly suspicious.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.resolved_ip

  # Type 3: Activity Context
  - question: What processes were running on the system when this covert DNS beacon was generated?
    context: Identifying the malware process helps understand infection vector and persistence mechanisms.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid

  - question: Were there any payment processing or POS application activities before this DNS beacon?
    context: Understanding POS activity timing helps correlate data exfiltration with payment transactions.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - ProcessGuid
        - file.size

  # Type 4: Impact Assessment
  - question: How much data is being exfiltrated through these covert DNS channels?
    context: Quantifying data volume helps assess the scope of payment card data compromise.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.query.name|contains: 'beacon'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name

  - question: Are there successful DNS responses indicating active C2 communication?
    context: Successful DNS responses confirm active malware communication and potential command reception.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.response_code
        - dns.resolved_ip
        - dns.query.name

  # Type 5: Forensic Deep-Dive
  - question: What payment card data patterns can be decoded from the hex-encoded DNS queries?
    context: Analyzing encoded data may reveal PAN, track data, or other sensitive payment information.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.query.name|contains: 'dc'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name

  - question: What FrameworkPOS variant or version is indicated by the beacon structure?
    context: Different FrameworkPOS variants use distinct DNS encoding patterns and C2 protocols.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - dns.query.name
        - payload_printable

  - question: Are there additional malware components or persistence mechanisms on the infected POS system?
    context: FrameworkPOS may install multiple components for data collection, persistence, and exfiltration.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessGuid

  # Type 6: Enterprise Correlation
  - question: Are other POS systems or payment processing devices in the network infected with FrameworkPOS?
    context: FrameworkPOS campaigns often target multiple POS systems within retail environments.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'FrameworkPOS'
        condition: selection
      fields:
        - src_ip
        - dns.query.name
        - rule.name