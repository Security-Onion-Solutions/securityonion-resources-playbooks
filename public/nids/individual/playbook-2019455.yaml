name: ET MALWARE FrameworkPOS Covert DNS CnC Beacon 2
id: 22019455
description: |
  Detects FrameworkPOS malware variant using alternative covert DNS beacon pattern for C2 communication.
  This variant uses "alert" keyword in DNS queries for command and control signaling.
  May trigger on legitimate DNS queries containing similar hex patterns or alert-related domains.
type: detection
detection_id: 2019455
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the specific DNS query pattern and hex payload in this FrameworkPOS alert beacon?
    context: Analyzing the alert beacon structure helps identify the malware variant and potential command signaling.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - src_ip
        - dns.query.name
        - dns.query.type_name
        - payload_printable

  - question: How does this alert beacon differ from the standard FrameworkPOS beacon pattern?
    context: Understanding beacon variations helps identify different malware variants or campaign phases.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - dns.query.name
        - rule.name
        - dns.resolved_ip

  # Type 2: Triage Assessment
  - question: Is this system a legitimate POS terminal that should be generating payment-related DNS traffic?
    context: Confirming POS system role helps validate whether this represents actual malware infection.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_port
        - dst_ip
        - protocol

  - question: Does this system have any legitimate applications that use "alert" in DNS queries?
    context: Some monitoring or alerting systems may legitimately use alert-related DNS queries.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.query.name|contains: 'alert'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  # Type 3: Activity Context
  - question: What triggered this alert beacon - was it a scheduled communication or event-driven?
    context: Understanding beacon timing helps determine if this represents data exfiltration or command reception.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ProcessGuid

  - question: Were there any payment transactions or POS activities before this alert beacon?
    context: Correlating beacon timing with POS activity helps identify data exfiltration triggers.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.size
        - ProcessGuid

  # Type 4: Impact Assessment
  - question: Is the C2 server responding to these alert beacons with commands or acknowledgments?
    context: Active C2 responses indicate ongoing malware operation and potential for additional commands.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.response_code
        - dns.resolved_ip
        - dns.query.name

  - question: How frequently are these alert beacons being generated from the infected system?
    context: Beacon frequency indicates malware activity level and potential data collection volume.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.query.name|contains: 'alert'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name

  # Type 5: Forensic Deep-Dive
  - question: What specific FrameworkPOS variant is indicated by the dc978a97 signature in the DNS query?
    context: The hex signature helps identify the specific malware build and associated threat actor campaigns.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.query.name|contains: 'dc978a97'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip

  - question: Are there additional FrameworkPOS components or related malware families on this system?
    context: FrameworkPOS infections may include multiple components for comprehensive POS data theft.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: 'POS'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - dst_ip

  - question: What payment card data or sensitive information is being encoded in these DNS beacons?
    context: Decoding beacon content may reveal the scope and type of compromised payment data.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name

  # Type 6: Enterprise Correlation
  - question: Are other POS systems in the retail environment infected with this FrameworkPOS variant?
    context: FrameworkPOS campaigns typically target multiple POS systems for maximum payment data collection.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'FrameworkPOS'
        condition: selection
      fields:
        - src_ip
        - dns.query.name
        - rule.name

  - question: Is there evidence of a coordinated FrameworkPOS campaign across multiple retail locations?
    context: Understanding campaign scope helps assess the overall impact and required response coordination.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          dns.query.name|contains: 'dc978a97'
        condition: selection
      fields:
        - src_ip
        - dns.query.name
        - dns.resolved_ip