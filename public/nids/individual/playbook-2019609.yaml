name: ET MALWARE Possible Tinba DGA NXDOMAIN Responses
id: 22019609
description: |
  Detects Tinba banking trojan domain generation algorithm (DGA) activity through DNS NXDOMAIN responses to .ru domains.
  May indicate infected systems attempting to contact command and control infrastructure or legitimate failed DNS queries.
type: detection
detection_id: 2019609
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What were the specific DGA domains that generated these NXDOMAIN responses?
    context: Analyzing the generated domain patterns helps confirm Tinba DGA activity and identify the malware variant.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - src_ip
        - dst_ip
  - question: Is this normal DNS resolution behavior for this system?
    context: Legitimate applications may generate failed DNS queries that could resemble DGA patterns.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.response_code: "NXDOMAIN"
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.resolved_ip
  - question: What DNS query patterns preceded this DGA activity?
    context: Understanding the sequence of DNS queries helps distinguish between DGA behavior and legitimate failed lookups.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.response_code
        - dns.resolved_ip
  - question: Has this system successfully resolved any Tinba C2 domains?
    context: Successful DNS resolutions may indicate active C2 communication and system compromise.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.query.name|contains: ".ru"
          dns.response_code: "NOERROR"
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name
  - question: What network connections followed successful DNS resolutions?
    context: Analyzing post-resolution connections helps identify active C2 communication channels.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - protocol
        - bytes_sent
        - bytes_received
  - question: Are there signs of banking trojan activity on this system?
    context: Tinba targets banking credentials, so identifying web traffic to financial institutions helps assess impact.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.domain|contains:
            - "bank"
            - "credit"
            - "financial"
        condition: selection
      fields:
        - url.domain
        - url.path
        - http.request.method
  - question: What processes are generating these suspicious DNS queries?
    context: Identifying the source process helps confirm malware presence and plan remediation.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ProcessGuid
        - User
  - question: Has this system exhibited other malware indicators recently?
    context: Correlating with other malware alerts helps understand the full scope of system compromise.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "MALWARE"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - community_id
  - question: Are there file modifications consistent with Tinba infection?
    context: Tinba creates persistence mechanisms and modifies system files during infection.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.extension|contains:
            - "exe"
            - "dll"
        condition: selection
      fields:
        - file.name
        - file.path
        - file.hash.md5
        - file.size
  - question: Are other systems in the network showing similar DGA patterns?
    context: Identifying enterprise-wide Tinba infections helps understand campaign scope and implement coordinated response.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Tinba DGA"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - community_id