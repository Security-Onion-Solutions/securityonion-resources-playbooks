name: ET INFO Office Document Containing AutoOpen Macro Via smtp
id: 22019617
description: |
  Detects Office documents containing AutoOpen macros transmitted via SMTP using alternate encoding.
  AutoOpen macros execute automatically when documents are opened, commonly used for malware delivery.
  May trigger on legitimate business documents with automation features.
type: detection
detection_id: 2019617
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What is the complete email message containing the AutoOpen macro document?
    context: Analyzing the full email reveals sender, subject, and attachment details for threat assessment.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - email.from.address
        - email.subject
        - email.attachments.file.name
        - email.message_id
  - question: Is this sender known to regularly send Office documents to this recipient?
    context: Legitimate business communications often involve macro-enabled documents from trusted partners.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 25
        condition: selection
      fields:
        - src_ip
        - bytes_out
        - connection_count
  - question: What other email traffic occurred from this source around the same time?
    context: Attackers often send multiple malicious emails in campaigns, revealing broader threat patterns.
    range: -2h/+2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 25
            - 587
        condition: selection
      fields:
        - dst_ip
        - bytes_out
        - duration
  - question: What is the filename and hash of the attached Office document?
    context: Document metadata helps identify known malware samples and track campaign distribution.
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.hash.sha256
        - file.mime_type
  - question: Has this document hash been seen elsewhere in the environment?
    context: Widespread distribution indicates coordinated attack campaign requiring enterprise response.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          file.hash.md5|expand: '%file.hash.md5%'
        condition: selection
      fields:
        - host.ip
        - TargetFilename
        - User
  - question: Did any processes execute after this email was received?
    context: AutoOpen macros trigger immediate process execution, indicating successful exploitation.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid
  - question: Are there signs of macro execution or Office application activity?
    context: Macro execution creates distinctive process patterns and file system activity.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - 'winword.exe'
            - 'excel.exe'
            - 'powerpnt.exe'
        condition: selection
      fields:
        - CommandLine
        - ProcessGuid
        - ParentImage
  - question: Were any suspicious network connections initiated after document receipt?
    context: Malicious macros often establish C2 communications or download additional payloads.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_in
        - bytes_out
  - question: Did any registry modifications occur that could indicate persistence?
    context: Advanced macros establish persistence through registry keys for sustained access.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessGuid
  - question: Are other systems in the organization receiving similar emails?
    context: Mass email campaigns indicate broader organizational threat requiring coordinated response.
    range: -1h/+1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: "ET INFO Office Document Containing AutoOpen Macro Via smtp"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - email.from.address
        - email.subject