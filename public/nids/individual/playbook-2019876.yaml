name: ET SCAN SSH BruteForce Tool with fake PUTTY version
id: 22019876
description: |
  Detects SSH brute force attacks using tools that masquerade as legitimate PuTTY
  clients by spoofing the version string. Legitimate PuTTY connections would not
  trigger this pattern. This indicates automated credential stuffing or dictionary
  attacks against SSH services.
type: detection
detection_id: 2019876
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact fake PuTTY version string used in the SSH handshake?
    context: Analyzing the spoofed version reveals the specific brute force tool and campaign characteristics.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - ssh.client.software_version
        - ssh.server.software_version
        - payload

  - question: Which SSH service and authentication methods were targeted?
    context: Understanding the target service helps assess vulnerability and implement appropriate protections.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - src_ip
        - src_port

  # Type 2: Triage Assessment
  - question: Is this source IP known to perform legitimate SSH connections to this server?
    context: Distinguishing between legitimate users and attackers helps prioritize response efforts.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 22
        condition: selection
      fields:
        - connection_state
        - duration
        - bytes_toserver
        - bytes_toclient

  - question: Does this activity align with normal business hours or expected SSH usage patterns?
    context: Brute force attacks often occur outside business hours to avoid detection.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 22
        condition: selection
      fields:
        - src_ip
        - connection_state
        - duration

  # Type 3: Activity Context
  - question: What reconnaissance or port scanning preceded this SSH brute force attempt?
    context: Attackers typically scan for SSH services before launching brute force attacks.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 22
            - 23
            - 80
            - 443
            - 21
            - 25
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection_state
        - duration

  - question: How many SSH connection attempts has this source made against the target?
    context: High connection frequency indicates automated brute force rather than manual login attempts.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 22
        condition: selection
      fields:
        - connection_state
        - duration
        - bytes_toserver

  - question: What other SSH servers has this attacker targeted in the network?
    context: Understanding attack scope helps identify all targeted systems and potential compromises.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 22
        condition: selection
      fields:
        - dst_ip
        - connection_state
        - duration

  # Type 4: Impact Assessment
  - question: Were any SSH authentication attempts successful from this source?
    context: Successful authentication indicates potential account compromise requiring immediate response.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 22
        condition: selection
      fields:
        - connection_state
        - duration
        - bytes_toserver
        - bytes_toclient

  - question: What commands or file access occurred after any successful SSH login?
    context: Post-authentication activity reveals attacker intent and potential system compromise.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  # Type 5: Forensic Deep-Dive
  - question: What specific SSH brute force tool or botnet is being used based on behavioral patterns?
    context: Identifying the tool helps understand capabilities and implement targeted defenses.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - "scan"
            - "brute"
            - "attack"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - dst_port

  - question: What credential combinations or usernames are being attempted in the brute force attack?
    context: Understanding targeted accounts helps assess which credentials may be compromised.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 22
        condition: selection
      fields:
        - connection_state
        - duration
        - bytes_toserver

  # Type 6: Enterprise Correlation
  - question: Are other SSH servers across the organization under similar brute force attack?
    context: Coordinated attacks often target multiple SSH services simultaneously.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "SSH"
          rule.category: "scan"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is this source IP part of a larger botnet campaign targeting the organization?
    context: Understanding campaign scope helps implement network-wide protections and threat hunting.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - rule.category
        - rule.name
        - dst_ip
        - dst_port