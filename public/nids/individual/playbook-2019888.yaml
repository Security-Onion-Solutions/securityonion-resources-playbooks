name: ET MALWARE Possible Dyre DGA NXDOMAIN Responses (.tk)
id: 22019888
description: |
  Detects potential Dyre banking trojan Domain Generation Algorithm (DGA) activity through DNS NXDOMAIN responses for .tk domains.
  The rule identifies patterns of failed DNS lookups to algorithmically generated domains ending in .tk TLD.
  May trigger on legitimate applications performing bulk DNS queries or security tools testing domain availability.
type: detection
detection_id: 2019888
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What specific .tk domain names triggered the DGA detection?
    context: Analyzing the exact domain patterns helps confirm if they match known Dyre DGA algorithms versus legitimate domains.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - dns.query.name
        - dns.response_code
        - alert.signature

  - question: What is the DNS query pattern and response structure for this alert?
    context: Understanding the DNS packet structure confirms the NXDOMAIN response pattern characteristic of DGA behavior.
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.response_code
        - dns.resolved_ip

  # Type 2: Triage Assessment
  - question: Is this system known to perform legitimate bulk DNS queries?
    context: Some security tools, research applications, or network monitoring systems may generate similar DNS query patterns.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.response_code

  - question: Does the timing align with known business operations or security scanning?
    context: Legitimate DNS queries typically follow business hours or scheduled scanning patterns, unlike malware DGA activity.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.response_code: "NXDOMAIN"
        condition: selection
      fields:
        - dns.query.name
        - src_ip

  # Type 3: Activity Context
  - question: What process initiated these DNS queries on the affected system?
    context: Identifying the parent process helps distinguish between malware-generated queries and legitimate application behavior.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  - question: What other network activity occurred around the same time as these DNS queries?
    context: Malware often performs additional network communications after DGA domain resolution attempts.
    range: +/-30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - protocol
        - bytes_toserver

  - question: Are there signs of the system attempting to contact C2 infrastructure?
    context: Successful DGA resolution often leads to command and control communication attempts.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 80
            - 443
            - 8080
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver
        - bytes_toclient

  # Type 4: Impact Assessment
  - question: Has the affected system successfully resolved any suspicious domains?
    context: Successful resolution of DGA domains indicates potential C2 communication capability.
    range: +/-1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.response_code: "NOERROR"
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  - question: Are there indicators of data exfiltration or lateral movement from this system?
    context: Compromised systems often attempt to spread or exfiltrate data after establishing C2 communication.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver

  # Type 5: Forensic Deep-Dive
  - question: What is the frequency and volume of DGA queries from this system?
    context: Analyzing query patterns helps confirm malware behavior versus false positives and assess infection severity.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.response_code: "NXDOMAIN"
        condition: selection
      fields:
        - dns.query.name
        - dns.response_code

  - question: Are there file system artifacts indicating Dyre banking trojan presence?
    context: Dyre malware creates specific files and registry entries that can confirm the infection.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.mime_type

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network showing similar DGA behavior?
    context: Malware campaigns often affect multiple systems, indicating broader compromise or lateral movement.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Dyre DGA"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name