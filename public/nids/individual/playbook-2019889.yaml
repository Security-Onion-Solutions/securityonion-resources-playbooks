name: ET MALWARE Possible Dyre DGA NXDOMAIN Responses (.so)
id: 22019889
description: |
  Detects potential Dyre banking trojan domain generation algorithm (DGA) activity through DNS NXDOMAIN responses for .so domains.
  May trigger on legitimate failed DNS lookups for Somalia domains or applications using .so extensions.
type: detection
detection_id: 2019889
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What specific .so domains triggered the NXDOMAIN responses?
    context: Analyzing the domain patterns helps identify DGA characteristics and distinguish from legitimate Somalia domains.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - dns.query.name
        - dns.response_code
        - alert.signature
  - question: Is this system normally accessing Somalia (.so) domains or related services?
    context: Legitimate access to .so domains would indicate potential false positive rather than malware activity.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.query.name|contains: '.so'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.response_code
  - question: What DNS queries preceded these NXDOMAIN responses?
    context: Understanding the query pattern helps confirm DGA behavior versus legitimate DNS failures.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.response_code
  - question: Are there multiple rapid-fire DNS queries from this source?
    context: DGA malware typically generates many sequential domain queries in short timeframes.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.response_code
  - question: What process initiated these DNS queries?
    context: Identifying the requesting process helps determine if queries originate from legitimate applications or malware.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid
  - question: Are there successful DNS resolutions mixed with these failures?
    context: Successful DGA domain resolutions indicate active C2 communication and confirmed compromise.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.response_code: 'NOERROR'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
  - question: What network connections followed successful DNS resolutions?
    context: Post-resolution connections reveal C2 communication patterns and infrastructure.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - bytes_in
  - question: Has this system shown other banking trojan indicators?
    context: Dyre often exhibits multiple malicious behaviors including credential theft and financial fraud attempts.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains:
            - 'banking'
            - 'trojan'
            - 'credential'
        condition: selection
      fields:
        - alert.signature
        - alert.category
  - question: Are other systems in the network showing similar DGA patterns?
    context: Dyre infections often spread laterally, creating enterprise-wide DGA traffic patterns.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature: 'ET MALWARE Possible Dyre DGA NXDOMAIN Responses (.so)'
        condition: selection
      fields:
        - src_ip
        - dst_ip
  - question: What file downloads or email attachments preceded this activity?
    context: Identifying the initial infection vector helps prevent similar compromises and trace attack timeline.
    range: -4h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method: 'GET'
        condition: selection
      fields:
        - url.full
        - http.response.status_code
        - file.mime_type