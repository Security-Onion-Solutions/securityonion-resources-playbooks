name: ET MALWARE Possible Net Crawler SMB Share Access unicode (Operation Cleaver)
id: 22019929
description: |
  Detects Net Crawler malware attempting to access AutoShare$ SMB shares using unicode encoding, associated with Operation Cleaver campaign.
  May trigger on legitimate administrative tools or network discovery scripts accessing hidden shares.
type: detection
detection_id: 2019929
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the exact SMB command and share path accessed?
    context: The specific SMB request details reveal the malware's network reconnaissance and lateral movement intent.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - smb.command
        - smb.path
        - smb.tree
  - question: Is this system authorized to access administrative shares on the target?
    context: Legitimate administrative access would indicate potential false positive rather than malicious reconnaissance.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 139
            - 445
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - bytes_in
  - question: What process initiated this SMB connection?
    context: Identifying the connecting process helps distinguish between legitimate tools and malicious reconnaissance software.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid
  - question: Are there multiple SMB share access attempts from this source?
    context: Systematic share enumeration indicates automated reconnaissance typical of Operation Cleaver tools.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 139
            - 445
        condition: selection
      fields:
        - dst_ip
        - dst_port
  - question: What files were accessed or transferred via SMB?
    context: File access patterns reveal data exfiltration attempts and help assess compromise scope.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size
  - question: Are there authentication events associated with this SMB access?
    context: Authentication patterns reveal credential usage and potential account compromise.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'net.exe'
            - 'psexec'
            - 'wmic'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
  - question: What other Operation Cleaver indicators are present?
    context: Operation Cleaver uses multiple tools and techniques, requiring comprehensive threat hunting across the environment.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains:
            - 'Cleaver'
            - 'Net Crawler'
        condition: selection
      fields:
        - alert.signature
        - alert.category
  - question: Has this system shown lateral movement or privilege escalation attempts?
    context: Net Crawler is often used for lateral movement, requiring investigation of privilege escalation and persistence mechanisms.
    range: -4h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'powershell'
            - 'cmd'
            - 'wmic'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
  - question: Are there signs of data staging or exfiltration preparation?
    context: Understanding data collection helps assess breach impact and implement appropriate containment measures.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.extension|contains:
            - 'zip'
            - 'rar'
            - 'tar'
        condition: selection
      fields:
        - TargetFilename
        - file.size
        - file.hash.md5
  - question: Are multiple systems being targeted by similar SMB reconnaissance?
    context: Enterprise-wide SMB scanning indicates coordinated attack requiring immediate network segmentation and monitoring.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: 'Net Crawler SMB Share Access'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature