name: ET MALWARE Possible Net Crawler SMB Share Access ascii (Operation Cleaver)
id: 22019930
description: |
  Detects Net Crawler malware attempting to access AutoShare$ SMB shares using ASCII encoding, associated with Operation Cleaver campaign.
  May trigger on legitimate network administration tools or automated backup systems accessing administrative shares.
type: detection
detection_id: 2019930
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete SMB request including share name and authentication details?
    context: The SMB request structure reveals reconnaissance techniques and helps distinguish from legitimate administrative access.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - smb.command
        - smb.path
        - smb.tree
        - smb.auth.username
  - question: Is this source system authorized for administrative SMB access?
    context: Legitimate administrative access patterns would indicate potential false positive rather than malicious activity.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 139
            - 445
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
  - question: What process or service initiated this SMB connection?
    context: Identifying the connecting process helps determine if legitimate service or malicious tool created the connection.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid
  - question: Are there systematic SMB enumeration attempts across multiple targets?
    context: Automated share enumeration indicates Operation Cleaver reconnaissance tools rather than legitimate access.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 139
            - 445
        condition: selection
      fields:
        - dst_ip
        - dst_port
  - question: What credentials were used for SMB authentication?
    context: Credential analysis reveals potential account compromise and helps trace attack progression.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'net use'
            - 'psexec'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
  - question: Were any files accessed or transferred from the target share?
    context: File access patterns indicate data exfiltration attempts and help assess breach scope and impact.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size
  - question: Are there other Operation Cleaver campaign indicators present?
    context: Operation Cleaver uses coordinated multi-tool attacks requiring comprehensive threat hunting across all affected systems.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains:
            - 'Operation Cleaver'
            - 'Net Crawler'
        condition: selection
      fields:
        - alert.signature
        - alert.category
        - alert.severity
  - question: Has this system deployed additional malware or persistence mechanisms?
    context: Net Crawler often facilitates deployment of additional tools, requiring investigation of persistence and backdoor installation.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'schtasks'
            - 'sc.exe'
            - 'reg.exe'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
  - question: Are there signs of data collection and staging for exfiltration?
    context: Understanding data collection scope helps determine breach impact and implement appropriate containment measures.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.name|contains:
            - 'temp'
            - 'tmp'
            - 'data'
        condition: selection
      fields:
        - TargetFilename
        - file.size
        - file.hash.sha256
  - question: Are multiple systems across the network showing similar SMB reconnaissance activity?
    context: Enterprise-wide SMB scanning indicates coordinated Operation Cleaver campaign requiring immediate network-wide containment.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: 'Net Crawler SMB Share Access'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature