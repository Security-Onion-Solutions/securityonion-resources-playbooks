name: ET DOS MC-SQLR Response Outbound Possible DDoS Participation
id: 22020305
description: |
  Detects potential participation in MC-SQLR amplification DDoS attacks via SQL Server Browser service.
  Internal systems responding to external requests may indicate compromise or misconfiguration.
  May trigger on legitimate SQL Server browser responses in certain network topologies.
type: detection
detection_id: 2020305
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What specific SQL Server information was disclosed in the MC-SQLR response?
    context: The response content reveals exposed SQL Server instances and configuration details.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - src_ip
        - dst_ip
        - src_port

  - question: What was the original UDP request that triggered this response?
    context: Understanding the request helps determine if this is legitimate or malicious solicitation.
    range: -5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
          src_port: 1434
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - payload_printable

  # Type 2: Triage Assessment
  - question: Is this SQL Server system authorized to respond to external queries?
    context: Legitimate SQL Server browser services should typically not respond to external networks.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          src_port: 1434
        condition: selection
      fields:
        - dst_ip
        - bytes_out

  - question: Are these responses part of documented network architecture?
    context: Some network configurations may legitimately expose SQL Server browser services.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          src_port: 1434
        condition: selection
      fields:
        - dst_ip

  # Type 3: Activity Context
  - question: What triggered the high volume of MC-SQLR responses from this system?
    context: Identifies potential compromise or misconfiguration leading to DDoS participation.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
          dst_port: 1434
        condition: selection
      fields:
        - src_ip

  - question: Are there signs of system compromise that could enable DDoS participation?
    context: Compromised systems may be leveraged for amplification attacks.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  # Type 4: Impact Assessment
  - question: What is the amplification ratio and total traffic volume generated?
    context: Quantifies the DDoS impact and effectiveness of the amplification attack.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          src_port: 1434
        condition: selection
      fields:
        - dst_ip
        - bytes_out

  - question: How many different targets are receiving amplified responses?
    context: Determines the scope and distributed nature of the DDoS attack.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          src_port: 1434
        condition: selection
      fields:
        - dst_ip

  # Type 5: Forensic Deep-Dive
  - question: Are there SQL Server configuration changes that enabled this exposure?
    context: Identifies misconfigurations that allowed external MC-SQLR responses.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains: "SQL"
        condition: selection
      fields:
        - TargetObject
        - Details

  - question: What SQL Server services are running and their network bindings?
    context: Determines which SQL Server components are exposed to external networks.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains: "sql"
        condition: selection
      fields:
        - Image
        - CommandLine

  # Type 6: Enterprise Correlation
  - question: Are other SQL Server systems participating in similar DDoS activity?
    context: Identifies the enterprise-wide scope of MC-SQLR amplification exposure.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "MC-SQLR"
        condition: selection
      fields:
        - src_ip
        - dst_ip