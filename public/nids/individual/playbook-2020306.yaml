name: ET DOS MC-SQLR Response Inbound Possible DDoS Target
id: 22020306
description: |
  Detects incoming MC-SQLR amplification DDoS attacks targeting internal systems.
  High volume of SQL Server Browser responses indicates the organization is under attack.
  May trigger on legitimate SQL Server discovery in large environments.
type: detection
detection_id: 2020306
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What SQL Server information is being sent to the targeted system?
    context: The response content reveals what data attackers are using for amplification.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - src_ip
        - dst_ip
        - dst_port

  - question: What are the source systems participating in this amplification attack?
    context: Identifies compromised or misconfigured SQL Servers being used as amplifiers.
    range: -15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          src_port: 1434
        condition: selection
      fields:
        - src_ip

  # Type 2: Triage Assessment
  - question: Is this target system expected to receive SQL Server discovery traffic?
    context: Eliminates false positives from legitimate SQL Server browser queries.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          src_port: 1434
        condition: selection
      fields:
        - src_ip
        - bytes_in

  - question: Does the targeted system run SQL Server services that would justify this traffic?
    context: Systems without SQL Server receiving these responses indicate DDoS targeting.
    range: -7d
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains: "sql"
        condition: selection
      fields:
        - Image
        - CommandLine

  # Type 3: Activity Context
  - question: What initiated the high volume of MC-SQLR responses to this target?
    context: Understanding attack initiation helps identify the DDoS campaign source.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 1434
        condition: selection
      fields:
        - dst_ip

  - question: Are there other types of DDoS attacks targeting this same system?
    context: Reveals if this is part of a multi-vector DDoS campaign.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: "DOS"
        condition: selection
      fields:
        - rule.name
        - src_ip

  # Type 4: Impact Assessment
  - question: What is the total volume of amplified traffic hitting the target?
    context: Quantifies the DDoS attack intensity and potential service impact.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          src_port: 1434
        condition: selection
      fields:
        - src_ip
        - bytes_in

  - question: Is the targeted service experiencing degraded performance or outages?
    context: Determines if the DDoS attack is successfully impacting service availability.
    range: +/-30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - bytes_in

  # Type 5: Forensic Deep-Dive
  - question: What is the geographic distribution of amplification sources?
    context: Understanding attack infrastructure helps with attribution and blocking.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          src_port: 1434
        condition: selection
      fields:
        - src_ip

  - question: Are there patterns in the amplification timing that suggest automation?
    context: Identifies if this is an automated DDoS tool or manual attack.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          src_port: 1434
        condition: selection
      fields:
        - src_ip

  # Type 6: Enterprise Correlation
  - question: Are other systems in the organization being targeted by similar DDoS attacks?
    context: Identifies if this is a targeted attack against the entire organization.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "MC-SQLR"
        condition: selection
      fields:
        - dst_ip
        - src_ip

  - question: Is this part of a broader DDoS campaign affecting multiple services?
    context: Reveals the scope of coordinated DDoS attacks across the enterprise.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "DOS"
        condition: selection
      fields:
        - dst_ip
        - rule.name