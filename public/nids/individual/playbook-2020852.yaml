name: ET MALWARE TinyLoader.B1 Sending Processes
id: 22020852
description: |
  Detects TinyLoader.B1 malware transmitting process information including system processes like wininit and winlogon.
  This indicates the malware is performing system reconnaissance and sending process lists to command and control servers.
  Legitimate applications would not transmit these specific system process names in this format.
type: detection
detection_id: 2020852
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete process list being transmitted by TinyLoader?
    context: The full payload reveals what system information the malware is collecting and exfiltrating.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - proto
        - alert.signature

  - question: What specific system processes were identified in the transmission?
    context: The presence of wininit and winlogon indicates the malware is targeting critical Windows system processes.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - src_port
        - dst_port
        - flow_id
        - community_id

  # Type 2: Triage Assessment
  - question: Is this system authorized to transmit process information externally?
    context: Confirms whether this represents legitimate system monitoring or unauthorized data exfiltration.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          proto: udp
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver
        - bytes_toclient

  - question: Has this type of process enumeration activity been observed during normal operations?
    context: Legitimate system management tools may enumerate processes but typically not transmit them externally.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          proto: udp
        condition: selection
      fields:
        - dst_port
        - bytes_toserver
        - pkts_toserver

  # Type 3: Activity Context
  - question: What process initiated this system reconnaissance and data transmission?
    context: Identifies the source of the malware activity and whether it's running as a service or injected process.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          dest.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid
        - ParentImage

  - question: What other reconnaissance activities occurred around the same time?
    context: TinyLoader may perform multiple reconnaissance operations including file enumeration and network discovery.
    range: -30m/+30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto
        - bytes_toserver
        - bytes_toclient

  # Type 4: Impact Assessment
  - question: How much system information has been exfiltrated through these process transmissions?
    context: Large data volumes indicate comprehensive system profiling and intelligence gathering.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          proto: udp
        condition: selection
      fields:
        - dst_port
        - bytes_toserver
        - pkts_toserver

  - question: Are there signs of additional payload downloads following the reconnaissance?
    context: Process enumeration often precedes targeted payload deployment based on system characteristics.
    range: -1h/+4h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          bytes_toclient|gte: 10000
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto
        - bytes_toclient
        - duration

  # Type 5: Forensic Deep-Dive
  - question: What processes were actually running on the system when this enumeration occurred?
    context: Comparing transmitted process list with actual running processes reveals the malware's reconnaissance accuracy.
    range: -15m/+15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid
        - ParentImage

  - question: Are there file system artifacts related to TinyLoader's process enumeration capabilities?
    context: Identifies malware components responsible for system reconnaissance and data collection.
    range: -1h/+1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.hash.sha256
        - ProcessGuid

  - question: Are there registry access patterns indicating process enumeration techniques?
    context: Some malware uses registry queries to enumerate running processes and system information.
    range: -30m/+30m
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessGuid
        - EventType

  # Type 6: Enterprise Correlation
  - question: Are other systems transmitting similar process information to the same C2 server?
    context: Determines if this reconnaissance activity is part of a coordinated campaign across multiple systems.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          proto: udp
        condition: selection
      fields:
        - src_ip
        - dst_port
        - bytes_toserver
        - pkts_toserver

  - question: Have other TinyLoader reconnaissance activities been detected across the enterprise?
    context: Identifies the scope of TinyLoader's intelligence gathering operations throughout the organization.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains:
            - "TinyLoader"
            - "Sending Processes"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature
        - alert.severity