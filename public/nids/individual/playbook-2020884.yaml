name: ET MALWARE Kriptovor SMTP Traffic
id: 22020884
description: |
  Detects Kriptovor malware exfiltrating stolen data via SMTP email channels.
  The specific email field patterns indicate structured data theft including PC info, text, IP, and timestamps.
  Legitimate SMTP traffic would not contain these specific data exfiltration markers.
type: detection
detection_id: 2020884
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What specific data fields were being exfiltrated in this SMTP communication?
    context: Understanding the exfiltrated data structure reveals the scope of information theft and victim impact.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - tcp.payload

  - question: What email server and authentication details were used for this data exfiltration?
    context: SMTP server information helps identify the attacker's infrastructure and data destination.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - orig_bytes
        - resp_bytes

  - question: What is the complete email content structure used for data exfiltration?
    context: Email format analysis reveals the malware's data organization and potential victim identification methods.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - smtp.from
        - smtp.to

  # Type 2: Triage Assessment
  - question: Is this SMTP traffic from an authorized email client or server?
    context: Legitimate business email would not contain the specific Kriptovor data exfiltration patterns.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 25
            - 465
            - 587
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - orig_bytes
        - resp_bytes

  # Type 3: Activity Context
  - question: What process initiated this malicious SMTP connection?
    context: Identifying the malware process helps understand infection vector and system compromise scope.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid

  - question: What data collection activities occurred before this exfiltration attempt?
    context: Pre-exfiltration activity reveals the malware's data harvesting capabilities and target information.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.mime_type

  - question: Were there DNS queries for the SMTP server before this connection?
    context: DNS resolution timing helps establish the complete attack timeline and C2 infrastructure usage.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.resolved_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.resolved_ip

  - question: What other network connections were established around the time of this exfiltration?
    context: Concurrent connections may reveal additional C2 channels or multi-stage data theft operations.
    range: -30m/+30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto
        - conn_state

  # Type 4: Impact Assessment
  - question: How much sensitive data was transmitted in this exfiltration session?
    context: Data volume assessment helps determine the scope of information compromise and breach severity.
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port|expand: '%dst_port%'
        condition: selection
      fields:
        - orig_bytes
        - resp_bytes
        - duration
        - conn_state

  - question: Are there signs of credential harvesting or keylogging on the infected host?
    context: Additional data theft capabilities indicate comprehensive information compromise requiring expanded response.
    range: -4h/+1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'keylog'
            - 'credential'
            - 'password'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - dst_ip

  # Type 5: Forensic Deep-Dive
  - question: What registry modifications indicate Kriptovor persistence mechanisms?
    context: Registry analysis reveals how the malware maintains persistence and continues data theft operations.
    range: -4h/+1h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetObject
        - Details
        - EventType

  - question: What is the complete timeline of Kriptovor malware activity on this host?
    context: Full activity timeline helps understand attack progression and identify all compromised data.
    range: -24h/+2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - dst_ip

  # Type 6: Enterprise Correlation
  - question: Are other hosts in the network exhibiting similar SMTP exfiltration patterns?
    context: Multiple infected hosts indicate widespread Kriptovor campaign requiring coordinated incident response.
    range: -24h/+2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|expand: '%dst_port%'
        condition: selection
      fields:
        - src_ip
        - orig_bytes
        - resp_bytes
        - conn_state

  - question: Have other Kriptovor indicators been detected across the enterprise?
    context: Related malware activity helps understand campaign scope and prioritize containment efforts.
    range: -7d/+1d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'Kriptovor'
            - 'SMTP Traffic'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name