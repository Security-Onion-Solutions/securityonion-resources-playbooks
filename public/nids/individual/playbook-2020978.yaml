name: ET MALWARE DDoS.Win32.Agent.bay Variant Covert Channel (VERSONEX)
id: 22020978
description: |
  Detects communication from DDoS.Win32.Agent.bay malware variant using "VERSONEX" covert channel protocol.
  This malware establishes command and control channels for DDoS attacks and data exfiltration.
  May rarely trigger on legitimate applications using similar protocol patterns, though highly unlikely.
type: detection
detection_id: 2020978
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete VERSONEX protocol message sent by the infected system?
    context: Analyzing the full covert channel message reveals command structure and potential data being exfiltrated.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - packet

  - question: What is the destination server receiving the DDoS agent communications?
    context: Identifying the C2 server helps understand the botnet infrastructure and enables blocking.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - proto

  # Type 2: Triage Assessment
  - question: Is this system known to run legitimate software that might use VERSONEX protocol?
    context: Confirming no legitimate VERSONEX usage helps validate this is malware communication.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - service
        - bytes_toserver

  - question: What is the normal network behavior pattern for this infected system?
    context: Comparing current activity to baseline helps determine the scope of compromise.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto
        - service

  # Type 3: Activity Context
  - question: What process on the infected system initiated this DDoS agent communication?
    context: Identifying the malware process helps with containment and removal procedures.
    range: -15m
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: When did the DDoS agent first establish communication with the C2 server?
    context: Determining infection timeline helps understand attack progression and data at risk.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - conn_state
        - duration
        - bytes_toserver

  - question: What other network connections occurred around the time of this covert channel activity?
    context: Concurrent connections may reveal additional malware components or lateral movement.
    range: +/-5m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto
        - service

  # Type 4: Impact Assessment
  - question: Has this infected system participated in actual DDoS attacks following C2 communication?
    context: Outbound attack traffic confirms the DDoS capability is active and poses immediate threat.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver
        - conn_state

  - question: What data has been transmitted through the VERSONEX covert channel?
    context: Understanding data exfiltration scope helps assess information compromise impact.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "VERSONEX"
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - payload_printable
        - severity

  # Type 5: Forensic Deep-Dive
  - question: What specific DDoS.Win32.Agent.bay variant is present based on communication patterns?
    context: Different malware variants have distinct C2 protocols that reveal the specific threat family.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - "DDoS"
            - "Agent"
            - "VERSONEX"
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - severity

  - question: Are there file system artifacts indicating DDoS malware installation?
    context: File creation events help identify malware persistence mechanisms and cleanup requirements.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.mime_type

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network infected with the same DDoS botnet?
    context: Multiple infections indicate botnet spread and require coordinated incident response.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "VERSONEX"
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - rule.name
        - severity