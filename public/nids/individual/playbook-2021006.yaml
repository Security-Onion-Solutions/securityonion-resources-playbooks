name: ET MALWARE Email Contains InternetOpen WinInet API Call - Potentially Dridex MalDoc 1
id: 22021006
description: |
  Detects email containing base64-encoded "InternetOpen" WinInet API call, commonly associated with
  Dridex malicious documents. This pattern may indicate malicious Office documents with embedded
  macros that download additional payloads, though could occur in legitimate development emails.
type: detection
detection_id: 2021006
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete base64-encoded content containing the InternetOpen API call?
    context: Decoding the base64 content reveals the actual macro code and download functionality embedded in the document.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - alert.signature
        - flow_id

  - question: What email attachment or embedded content contained the malicious code?
    context: Identifying the specific attachment helps determine the delivery method and potential impact scope.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_port
        - dst_port
        - bytes_toserver

  # Type 2: Triage Assessment
  - question: Is this email from a trusted sender or domain?
    context: Legitimate development or technical emails may contain API references, though base64 encoding is suspicious.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 25
        condition: selection
      fields:
        - src_ip
        - bytes_toserver
        - conn_state

  - question: Does this recipient normally receive technical or development-related emails?
    context: Users who regularly receive programming content may legitimately encounter API references in emails.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          src_port: 25
        condition: selection
      fields:
        - src_ip
        - bytes_toclient
        - conn_state

  # Type 3: Activity Context
  - question: Was this email part of a targeted spear-phishing campaign?
    context: Dridex campaigns often use targeted emails with malicious Office documents to compromise specific organizations.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          src_port: 25
        condition: selection
      fields:
        - src_ip
        - bytes_toclient
        - conn_state

  - question: Were there multiple similar emails delivered around the same time?
    context: Mass email campaigns with similar malicious content indicate automated malware distribution.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: 'InternetOpen'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature

  - question: What was the email subject line and sender information?
    context: Email metadata helps identify the social engineering tactics used to entice recipients to open attachments.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - bytes_toserver
        - bytes_toclient

  # Type 4: Impact Assessment
  - question: Did any users open or interact with the malicious email attachment?
    context: User interaction with Dridex documents typically triggers macro execution and payload download.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - 'winword.exe'
            - 'excel.exe'
            - 'powerpnt.exe'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: Were there any subsequent network connections indicating payload download?
    context: Successful macro execution typically results in HTTP connections to download additional malware components.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 80
            - 443
            - 8080
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver
        - conn_state

  # Type 5: Forensic Deep-Dive
  - question: Are there indicators of Dridex banking trojan infection following email delivery?
    context: Dridex malware typically establishes persistence and begins credential harvesting after successful installation.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetFilename|contains:
            - '.exe'
            - '.dll'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessName

  - question: What persistence mechanisms were established after document execution?
    context: Dridex creates registry entries and scheduled tasks to maintain persistence across system reboots.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetObject|contains:
            - 'Run'
            - 'RunOnce'
            - 'CurrentVersion'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessName

  - question: Are there signs of credential harvesting or banking-related activity?
    context: Dridex specifically targets banking credentials and financial information from infected systems.
    range: +24h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - 'browser'
            - 'chrome.exe'
            - 'firefox.exe'
        condition: selection
      fields:
        - CommandLine
        - User
        - ProcessName

  - question: What command and control communications were established?
    context: Dridex maintains persistent communication with C2 servers for command execution and data exfiltration.
    range: +6h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver
        - bytes_toclient

  # Type 6: Enterprise Correlation
  - question: Are other users in the organization receiving similar Dridex-related emails?
    context: Dridex campaigns often target multiple users within the same organization for maximum impact.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: 'Dridex'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature