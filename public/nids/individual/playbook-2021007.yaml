name: ET MALWARE Email Contains InternetOpen WinInet API Call - Potentially Dridex MalDoc 2
id: 22021007
description: |
  Detects emails containing base64-encoded InternetOpen WinInet API calls, potentially indicating Dridex malicious documents.
  This pattern may appear in legitimate software documentation or technical emails discussing Windows API usage.
type: detection
detection_id: 2021007
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete base64-encoded content containing the InternetOpen API call?
    context: Understanding the full encoded payload reveals the exact malicious code structure and execution method.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - smtp.data
        - email.attachments.file.name

  - question: What email headers and metadata are associated with this suspicious message?
    context: Email metadata provides attribution and delivery path information for threat actor identification.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - smtp.mail_from
        - smtp.rcpt_to
        - email.from.address
        - email.subject
        - email.message_id

  # Type 2: Triage Assessment
  - question: Is this sender known to send legitimate technical documentation or API references?
    context: Legitimate software vendors or technical teams may discuss Windows API functions in documentation.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 25
        condition: selection
      fields:
        - src_ip
        - bytes_out
        - connection_count

  - question: Does the recipient typically receive technical emails or software-related communications?
    context: Understanding recipient context helps determine if this is targeted or mass distribution.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 25
        condition: selection
      fields:
        - src_ip
        - connection_count
        - bytes_in

  # Type 3: Activity Context
  - question: What other SMTP activity occurred from this source around the same time?
    context: Concurrent email activity may indicate mass malware distribution campaigns.
    range: -2h/+2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 25
        condition: selection
      fields:
        - dst_ip
        - connection_count
        - bytes_out

  - question: Are there any file downloads or web requests following this email delivery?
    context: Successful malware delivery often triggers subsequent download or C2 communication activity.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - url.full
        - http.request.method
        - user_agent.original

  # Type 4: Impact Assessment
  - question: Has any process execution occurred on the recipient system after email delivery?
    context: Successful exploitation would result in process creation from document opening or macro execution.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ParentImage

  - question: Are there signs of network connections to external IPs from the recipient system?
    context: Dridex typically establishes C2 communications after successful infection.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - bytes_in

  # Type 5: Forensic Deep-Dive
  - question: What specific Dridex variant or banking trojan indicators are present?
    context: Different Dridex variants have distinct behavioral patterns and target different financial institutions.
    range: +24h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - signature_id

  - question: Are there any file modifications or registry changes on the recipient system?
    context: Dridex establishes persistence through registry modifications and drops additional payloads.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.mime_type
        - ProcessName

  # Type 6: Enterprise Correlation
  - question: Are other systems in the organization receiving similar malicious emails?
    context: Understanding campaign scope helps determine if this is targeted or opportunistic mass distribution.
    range: -1h/+1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "InternetOpen WinInet API Call"
        condition: selection
      fields:
        - dst_ip
        - src_ip
        - alert_count

  - question: Is this part of a broader Dridex campaign affecting the enterprise?
    context: Coordinated analysis of related Dridex indicators helps understand attack timeline and scope.
    range: -24h/+24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.category: "trojan-activity"
          rule.name|contains: "Dridex"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - alert_count