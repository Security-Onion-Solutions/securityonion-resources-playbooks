name: ET HUNTING Suspicious X-mailer Synapse Inbound to SMTP Server
id: 22021135
description: |
  Detects suspicious X-mailer header indicating Synapse Pascal TCP/IP library usage in SMTP traffic.
  May indicate spam campaigns or malicious email activity, but could also be legitimate automated email systems.
type: detection
detection_id: 2021135
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete email header structure containing the Synapse X-mailer?
    context: Understanding the full email headers reveals sender patterns and potential campaign indicators.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - src_ip
        - dst_ip
        - dst_port
        - alert.signature

  - question: What specific email content and recipients were targeted in this SMTP session?
    context: Email content analysis helps determine if this is spam, phishing, or legitimate communication.
    range: +/-5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 25
            - 587
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - network.bytes
        - network.packets

  # Type 2: Triage Assessment
  - question: Is this sender IP authorized to send email to our SMTP servers?
    context: Legitimate email senders should be recognized or whitelisted in organizational records.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 25
            - 587
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port

  - question: Does this email activity align with normal business hours and patterns?
    context: Spam campaigns often occur outside business hours or in unusual volume patterns.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 25
            - 587
        condition: selection
      fields:
        - src_ip
        - dst_port
        - network.bytes

  # Type 3: Activity Context
  - question: What other network connections originated from this source IP around the same time?
    context: Malicious senders often attempt multiple connections or scan for open mail servers.
    range: +/-30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - network.transport

  - question: Are there DNS queries from this IP that might indicate reconnaissance activity?
    context: Attackers often perform DNS lookups to identify mail servers before sending spam.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - src_ip
        - dns.query.name
        - dns.query.type_name
        - dns.resolved_ip

  # Type 4: Impact Assessment
  - question: How many emails were successfully delivered using this Synapse mailer pattern?
    context: Volume analysis helps determine campaign scope and potential recipient impact.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 25
            - 587
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - network.bytes
        - network.packets

  # Type 5: Forensic Deep-Dive
  - question: Are there other alerts indicating malicious activity from this source IP?
    context: Multiple alert types from same source suggest coordinated malicious campaign.
    range: +/-6h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - src_ip
        - dst_ip
        - alert.severity

  - question: What is the reputation and geolocation of the sending IP address?
    context: Known malicious IPs or suspicious geographic origins indicate likely spam campaign.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - src_ip
        - source.geo.country_name
        - source.geo.city_name
        - network.direction

  # Type 6: Enterprise Correlation
  - question: Are other SMTP servers in the organization receiving similar Synapse mailer traffic?
    context: Widespread targeting suggests organized spam campaign requiring coordinated response.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Synapse"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - alert.signature

  - question: Is this part of a broader email-based attack campaign across the enterprise?
    context: Multiple email-related alerts indicate potential coordinated phishing or spam campaign.
    range: +/-12h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.category|contains:
            - "HUNTING"
            - "MALWARE"
          dst_port|contains:
            - 25
            - 587
        condition: selection
      fields:
        - rule.name
        - src_ip
        - dst_ip
        - rule.category