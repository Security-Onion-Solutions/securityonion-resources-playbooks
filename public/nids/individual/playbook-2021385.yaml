name: ET MALWARE Win32/Denisca.A CnC Beacon
id: 22021385
description: |
  Detects Win32/Denisca.A malware command and control beacon traffic over UDP.
  This signature identifies specific byte patterns in outbound UDP traffic that indicate malware communication.
  Legitimate applications rarely use these specific hex patterns in UDP communications.
type: detection
detection_id: 2021385
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact UDP payload content that triggered this alert?
    context: Understanding the beacon structure reveals malware variant and communication protocol.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - rule.name
        - alert.signature

  - question: What are the complete network connection details for this beacon?
    context: Connection metadata provides insight into the C2 infrastructure being used.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - proto
        - conn_state

  # Type 2: Triage Assessment
  - question: Is this system known to run legitimate applications that use UDP extensively?
    context: Some enterprise applications use UDP for legitimate purposes, though the specific hex patterns are suspicious.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          proto: udp
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - service

  - question: Has this source IP shown other suspicious network behavior recently?
    context: Multiple alerts from same source indicate compromised system rather than false positive.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - alert.category

  # Type 3: Activity Context
  - question: What process initiated this UDP communication?
    context: Process information helps determine if malware is running or if legitimate software is involved.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: What other network connections occurred from this host around the same time?
    context: C2 beacons often occur alongside other malicious network activity.
    range: +/-15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto
        - service

  # Type 4: Impact Assessment
  - question: Has data been exfiltrated through this communication channel?
    context: Denisca malware is known for data theft capabilities beyond just beaconing.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - orig_bytes
        - resp_bytes
        - duration

  - question: Are there signs of file system changes that could indicate malware persistence?
    context: Denisca variants often establish persistence mechanisms on infected systems.
    range: +/-1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.mime_type

  # Type 5: Forensic Deep-Dive
  - question: What is the frequency and timing pattern of these beacon communications?
    context: C2 beacon intervals reveal malware configuration and can help predict next communication.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: Denisca
        condition: selection
      fields:
        - rule.name
        - src_ip
        - dst_ip

  - question: Are there registry modifications associated with this malware family?
    context: Win32/Denisca variants typically modify registry for persistence and configuration.
    range: +/-2h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetObject
        - Details
        - EventType

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network communicating with the same C2 server?
    context: Denisca campaigns often involve multiple infected systems beaconing to same infrastructure.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: Denisca
        condition: selection
      fields:
        - src_ip
        - rule.name
        - alert.signature

  - question: Is this part of a broader malware campaign across the enterprise?
    context: Multiple Denisca detections indicate widespread compromise requiring coordinated response.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: Denisca
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name