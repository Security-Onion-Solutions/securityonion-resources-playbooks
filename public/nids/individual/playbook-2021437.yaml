name: ET MALWARE Tsyrval Panda CnC Beacon
id: 22021437
description: |
  Detects Tsyrval Panda malware command and control beacon traffic over TCP.
  This signature identifies specific byte patterns in established TCP connections to high ports.
  The hex pattern is unique to this malware family and indicates active C2 communication.
type: detection
detection_id: 2021437
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact TCP payload containing the Tsyrval Panda beacon pattern?
    context: The specific hex sequence reveals malware variant and communication protocol structure.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - rule.name
        - alert.signature

  - question: What are the TCP connection details for this C2 communication?
    context: Connection state and port information helps understand the C2 infrastructure setup.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - proto
        - conn_state
        - service

  - question: What is the timing and offset of the beacon pattern within the TCP stream?
    context: Pattern position in the stream reveals communication protocol structure and potential encryption.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - flow_id
        - tcp.seq
        - tcp.ack
        - payload_len

  # Type 2: Triage Assessment
  - question: Does this system normally establish TCP connections to high ports on external hosts?
    context: Legitimate applications rarely connect to ports above 1024 on external systems.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          proto: tcp
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - service

  - question: Is this host showing other indicators of malware activity?
    context: Multiple malware detections confirm compromise rather than false positive.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.category|contains:
            - malware
            - trojan
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - alert.severity

  # Type 3: Activity Context
  - question: What process initiated this TCP connection to the C2 server?
    context: Process information reveals infection vector and execution context.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid
        - ParentImage

  - question: What network activity occurred before this beacon transmission?
    context: Prior activity helps identify initial infection vector or triggering events.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto
        - service
        - orig_bytes

  - question: How was the C2 server domain resolved by this system?
    context: DNS resolution patterns reveal malware domain generation algorithms or hardcoded domains.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          dns.resolved_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.resolved_ip

  # Type 4: Impact Assessment
  - question: What is the data transfer volume in this C2 session?
    context: Transfer volumes indicate whether this is beaconing only or active data exfiltration.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port|expand: '%dst_port%'
        condition: selection
      fields:
        - orig_bytes
        - resp_bytes
        - duration
        - conn_state

  - question: Are there file system changes indicating malware persistence?
    context: File modifications reveal whether malware has established long-term presence.
    range: +/-1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - EventType

  # Type 5: Forensic Deep-Dive
  - question: What is the beacon frequency pattern for Tsyrval Panda communications?
    context: Beacon intervals reveal malware configuration and help predict future activity.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: Tsyrval
        condition: selection
      fields:
        - rule.name
        - dst_port

  - question: Are there registry modifications associated with Tsyrval Panda persistence?
    context: Registry changes confirm malware family and reveal persistence mechanisms.
    range: +/-2h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetObject
        - Details
        - EventType

  # Type 6: Enterprise Correlation
  - question: Are other systems communicating with this Tsyrval Panda C2 server?
    context: Multiple infections indicate campaign scope and coordinated threat actor activity.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: Tsyrval
        condition: selection
      fields:
        - src_ip
        - rule.name
        - dst_port

  - question: Is this part of a broader malware campaign targeting the organization?
    context: Multiple malware families from same source indicate sophisticated threat actor operations.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.category|contains: malware
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - alert.signature