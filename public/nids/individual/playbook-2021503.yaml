name: ET MALWARE Java/QRat Checkin
id: 22021503
description: |
  Detects Java/QRat remote access trojan checkin communications over TCP.
  This signature identifies specific serialized Java object patterns used by QRat malware.
  The "value" string in the payload is characteristic of QRat's communication protocol.
type: detection
detection_id: 2021503
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete TCP payload containing the QRat checkin pattern?
    context: The serialized Java object structure reveals QRat variant and communication protocol details.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - rule.name
        - alert.signature

  - question: What are the TCP connection characteristics for this QRat communication?
    context: Connection details help identify QRat C2 infrastructure and communication patterns.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - proto
        - conn_state
        - service

  - question: What Java serialization markers are present in the payload?
    context: Java serialization patterns confirm QRat's use of Java RMI or similar protocols.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - flow_id
        - payload_len
        - tcp.seq
        - tcp.ack

  # Type 2: Triage Assessment
  - question: Does this system normally run Java applications that use serialization?
    context: Legitimate Java applications may use serialization, but the specific pattern is suspicious.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - java.exe
            - javaw.exe
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  - question: Is this host exhibiting other malware-related network behavior?
    context: Multiple malware signatures confirm compromise rather than legitimate Java activity.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.category|contains:
            - malware
            - trojan
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - alert.severity

  # Type 3: Activity Context
  - question: What Java process initiated this QRat communication?
    context: Process identification reveals infection vector and execution context for the malware.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - java.exe
            - javaw.exe
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid
        - ParentImage

  - question: What network activity preceded this QRat checkin?
    context: Prior connections help identify initial infection vector or download activity.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto
        - service
        - orig_bytes

  - question: How was the QRat C2 server domain resolved?
    context: DNS activity reveals domain generation algorithms or hardcoded C2 domains.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          dns.resolved_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.resolved_ip

  # Type 4: Impact Assessment
  - question: What is the data transfer volume in this QRat session?
    context: Transfer volumes indicate whether this is just checkin or active remote control session.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port|expand: '%dst_port%'
        condition: selection
      fields:
        - orig_bytes
        - resp_bytes
        - duration
        - conn_state

  - question: Are there Java-related file system changes indicating malware persistence?
    context: JAR files or Java-related modifications reveal QRat installation and persistence.
    range: +/-1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - .jar
            - .class
            - java
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - EventType

  # Type 5: Forensic Deep-Dive
  - question: What is the checkin frequency pattern for this QRat instance?
    context: Checkin intervals reveal QRat configuration and help predict future communications.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: QRat
        condition: selection
      fields:
        - rule.name
        - dst_port

  - question: Are there registry modifications associated with Java malware persistence?
    context: Registry changes reveal QRat persistence mechanisms and startup configurations.
    range: +/-2h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - Java
            - CurrentVersion\Run
        condition: selection
      fields:
        - TargetObject
        - Details
        - EventType

  - question: What Java runtime environment is being exploited by QRat?
    context: JRE version information helps understand vulnerability exploitation and detection evasion.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains: java
        condition: selection
      fields:
        - Image
        - CommandLine
        - ProcessGuid

  # Type 6: Enterprise Correlation
  - question: Are other systems infected with QRat malware?
    context: Multiple QRat infections indicate campaign scope and potential lateral movement.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: QRat
        condition: selection
      fields:
        - src_ip
        - rule.name
        - dst_port

  - question: Is this QRat C2 server being used by other malware families?
    context: Shared C2 infrastructure indicates organized threat actor operations.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          alert.category|contains: malware
        condition: selection
      fields:
        - src_ip
        - rule.name
        - alert.signature