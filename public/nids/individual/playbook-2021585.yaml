name: ET MALWARE APT Lurker GET CnC Beacon
id: 22021585
description: |
  Detects APT Lurker malware command and control beacon traffic characterized by specific HTTP GET requests to PHP endpoints with minimal headers.
  May trigger on legitimate applications with similar HTTP request patterns.
type: detection
detection_id: 2021585
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the exact HTTP request structure that matched the APT Lurker beacon pattern?
    context: Understanding the specific HTTP headers and request format confirms malware communication patterns.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - http.request.headers
        - user_agent.original

  - question: Is this HTTP request pattern normal for this host?
    context: Legitimate applications may use similar minimal HTTP headers, requiring baseline comparison.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.request.method: 'GET'
        condition: selection
      fields:
        - url.path
        - user_agent.original
        - http.request.headers

  - question: What process initiated this suspicious HTTP connection?
    context: Identifying the source process helps determine if this is legitimate software or malware communication.
    range: -5m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ProcessGuid
        - User

  - question: Are there other hosts showing similar APT Lurker beacon patterns?
    context: APT campaigns typically involve multiple compromised systems with consistent C2 communication patterns.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'APT Lurker'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - url.full

  - question: What was the server's response to this beacon request?
    context: C2 server responses may contain commands, configuration updates, or confirmation of successful communication.
    range: +2m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - network.bytes

  - question: Has this host downloaded additional payloads recently?
    context: APT Lurker may download additional modules or tools after establishing C2 communication.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method|contains:
            - 'GET'
            - 'POST'
        condition: selection
      fields:
        - url.full
        - http.response.status_code
        - network.bytes

  - question: Are there signs of data exfiltration from this compromised host?
    context: APT Lurker is designed for data theft and may exfiltrate sensitive information through HTTP channels.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method: 'POST'
        condition: selection
      fields:
        - url.full
        - network.bytes
        - http.request.body.content

  - question: What files has the suspected malware process accessed?
    context: Understanding file access patterns helps identify malware persistence mechanisms and data targeting.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessGuid

  - question: Are there registry modifications indicating malware persistence?
    context: APT Lurker may modify registry keys to maintain persistence across system reboots.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - 'Run'
            - 'RunOnce'
            - 'Services'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessGuid

  - question: What other C2 domains or IPs is this host communicating with?
    context: APT campaigns often use multiple C2 infrastructure components for redundancy and operational security.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 80
            - 443
            - 8080
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.bytes

  - question: Are there DNS queries for suspicious domains from this host?
    context: APT malware often performs DNS lookups for C2 domains before establishing HTTP connections.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  - question: What is the reputation and infrastructure details of the C2 server?
    context: Understanding C2 infrastructure helps attribute the attack and identify related campaign components.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - dst_ip
        - geoip.country_name
        - threat.indicator.type
        - tls.server.certificate.subject