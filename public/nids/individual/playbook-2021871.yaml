name: ET MALWARE Hawkeye Keylogger SMTP Beacon
id: 22021871
description: |
  Detects Hawkeye keylogger malware sending stolen data via SMTP email with base64-encoded subject line.
  This malware exfiltrates keystrokes, screenshots, and credentials through email communications.
  May trigger on legitimate emails with similar base64 patterns, though the specific "SGF3a0V5ZSBLZXlsb2dnZXIg" string is unique to Hawkeye.
type: detection
detection_id: 2021871
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete SMTP message containing the Hawkeye keylogger beacon?
    context: Analyzing the full email reveals the stolen data being exfiltrated and victim information.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - smtp.mail.from
        - smtp.mail.to

  - question: What does the base64-encoded Hawkeye subject line decode to?
    context: Decoding "SGF3a0V5ZSBLZXlsb2dnZXIg" confirms the keylogger identification and may reveal victim details.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - smtp.mail.subject
        - payload_printable

  # Type 2: Triage Assessment
  - question: Is this system authorized to send emails through external SMTP servers?
    context: Unauthorized SMTP usage from workstations often indicates malware exfiltration rather than legitimate email.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 25
            - 587
            - 465
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - service
        - bytes_toserver

  - question: Does this system normally generate SMTP traffic to this destination?
    context: New or unusual SMTP destinations may indicate compromise and data exfiltration channels.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 25
            - 587
        condition: selection
      fields:
        - bytes_toserver
        - conn_state
        - duration

  # Type 3: Activity Context
  - question: What process initiated the SMTP connection for this Hawkeye exfiltration?
    context: Identifying the malware process helps with containment and reveals infection vector.
    range: -15m
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: When did the Hawkeye keylogger first begin exfiltrating data?
    context: Determining the initial exfiltration time helps assess the scope of data compromise.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Hawkeye"
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - severity

  - question: What other network activity occurred around the time of this keylogger beacon?
    context: Concurrent connections may reveal additional malware components or command and control channels.
    range: +/-10m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto
        - service

  # Type 4: Impact Assessment
  - question: How much data has been exfiltrated through Hawkeye SMTP beacons?
    context: Understanding exfiltration volume helps assess the scope of credential and data theft.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Hawkeye"
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - severity

  - question: Has the infected system accessed sensitive resources since the keylogger installation?
    context: Resource access during infection period indicates potential credential harvesting and data theft.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - service
        - bytes_toserver

  # Type 5: Forensic Deep-Dive
  - question: What files has the Hawkeye keylogger created or modified on the infected system?
    context: File system artifacts reveal persistence mechanisms and potential additional malware components.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.mime_type

  - question: Are there registry modifications indicating Hawkeye persistence mechanisms?
    context: Registry changes reveal how the keylogger maintains persistence across system reboots.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetObject
        - Details

  - question: What specific variant of Hawkeye keylogger is present based on behavioral patterns?
    context: Different Hawkeye variants have distinct exfiltration patterns that help identify the threat actor.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Hawkeye"
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - severity

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network infected with Hawkeye keylogger?
    context: Multiple infections indicate widespread compromise requiring coordinated incident response.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Hawkeye"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - severity