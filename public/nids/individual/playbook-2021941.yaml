name: ET WEB_CLIENT Proxy - OWASP Zed Attack Proxy Certificate Seen
id: 22021941
description: |
  Detects OWASP Zed Attack Proxy (ZAP) certificate in TLS traffic, indicating potential security testing or penetration testing activity.
  May represent legitimate security testing by authorized personnel or malicious reconnaissance by attackers.
  ZAP is commonly used for web application security assessments and vulnerability scanning.
type: detection
detection_id: 2021941
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What are the complete certificate details for this OWASP ZAP proxy connection?
    context: Certificate analysis reveals the specific ZAP configuration and helps determine if this is legitimate testing.
    query: |
      aggregation: false
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - tls.server.certificate.subject
        - tls.server.certificate.issuer
        - tls.server.certificate.not_valid_after
        - tls.server.certificate.serial_number

  - question: What was the specific TLS handshake pattern for this ZAP proxy session?
    context: Understanding the TLS negotiation helps confirm proxy interception and identify potential security testing scope.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - tls.version
        - tls.cipher_suite
        - payload_printable

  # Type 2: Triage Assessment
  - question: Is this ZAP proxy activity occurring during scheduled security testing windows?
    context: Legitimate security testing typically occurs during planned maintenance or assessment periods.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          tls.server.certificate.issuer|contains: "OWASP"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port

  - question: Is the source IP associated with authorized security testing personnel or tools?
    context: Helps distinguish between legitimate penetration testing and unauthorized reconnaissance activities.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto

  # Type 3: Activity Context
  - question: What web applications are being targeted by this ZAP proxy session?
    context: Identifies the scope of security testing or reconnaissance to assess potential impact.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.response.status_code
        - user_agent.original

  - question: What triggered the initiation of this proxy-intercepted connection?
    context: Understanding the connection origin helps determine if this is automated scanning or manual testing.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto
        - conn_state

  # Type 4: Impact Assessment
  - question: What sensitive web applications or data have been accessed through this ZAP proxy?
    context: Determines if critical systems were exposed to security testing or potential reconnaissance.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.path
        - http.request.method
        - http.response.status_code
        - http.response.body.bytes

  - question: Has this ZAP proxy session successfully established persistent connections?
    context: Successful proxy interception indicates potential for ongoing security assessment or malicious activity.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - duration
        - orig_bytes
        - resp_bytes

  # Type 5: Forensic Deep-Dive
  - question: What specific ZAP scanning techniques or payloads were used in this session?
    context: Detailed analysis of ZAP activity reveals whether this is basic reconnaissance or advanced penetration testing.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - http.request.body.content
        - user_agent.original
        - url.query

  - question: Are there indicators of ZAP software installation or execution on the source system?
    context: Confirms whether ZAP is running locally or if traffic is being routed through an external proxy.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          Hostname|expand: '%src_ip%'
          Image|contains: "zap"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ParentImage

  # Type 6: Enterprise Correlation
  - question: Are multiple systems in the network using OWASP ZAP proxies simultaneously?
    context: Coordinated ZAP usage across multiple systems may indicate organized penetration testing or widespread reconnaissance.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          tls.server.certificate.issuer|contains: "OWASP"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port

  - question: Is this part of a broader pattern of security testing tool usage across the enterprise?
    context: Helps determine if this is part of authorized security assessment or coordinated attack reconnaissance.
    range: +/-48h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - "Proxy"
            - "ZAP"
            - "BurpSuite"
            - "Fiddler"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name