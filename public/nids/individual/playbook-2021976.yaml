name: ET MALWARE NetWire Variant - Client Hello
id: 22021976
description: |
  Detects NetWire Remote Access Trojan establishing initial communication with command and control servers.
  This signature identifies the distinctive client hello pattern used by NetWire RAT variants.
  Legitimate applications would not use this specific communication pattern and packet structure.
type: detection
detection_id: 2021976
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact NetWire client hello packet structure and content?
    context: Understanding the specific packet format helps confirm RAT activity and identify the NetWire variant being used.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - flow.bytes_toserver
        - flow.bytes_toclient

  - question: What is the complete network flow pattern for this NetWire RAT communication?
    context: NetWire RAT follows specific communication patterns that help distinguish from legitimate network traffic.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_port
        - dst_port
        - proto
        - conn_state
        - duration

  # Type 2: Triage Assessment
  - question: Is this destination server associated with known legitimate services for this host?
    context: Helps eliminate false positives by verifying if the connection target represents expected business infrastructure.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto

  - question: Has this source host exhibited normal business communication patterns recently?
    context: Establishes baseline behavior to determine if RAT communication represents deviation from normal operations.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto

  # Type 3: Activity Context
  - question: What process initiated this NetWire RAT network connection on the source host?
    context: Identifying the parent process helps determine how the RAT was executed and its persistence mechanism.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          Hostname|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - User
        - ProcessGuid

  - question: What other network connections occurred from this host around the NetWire communication?
    context: RAT infections often involve multiple network connections for different malicious purposes including payload downloads.
    range: +/-30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto
        - conn_state

  # Type 4: Impact Assessment
  - question: Has the NetWire RAT successfully established ongoing C2 communication channels?
    context: Determines if the malware has successfully established persistent command and control for remote access capabilities.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - duration
        - conn_state

  - question: What data volumes have been transferred in subsequent NetWire RAT sessions?
    context: Large data transfers may indicate data exfiltration, screen captures, or additional malware payload downloads.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - orig_bytes
        - resp_bytes
        - duration

  # Type 5: Forensic Deep-Dive
  - question: Are there indicators of NetWire RAT file artifacts on the infected system?
    context: NetWire RAT typically drops specific configuration files and executables that confirm the infection scope.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          Hostname|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.hash.sha256

  - question: What registry modifications occurred that indicate NetWire RAT persistence mechanisms?
    context: NetWire RAT commonly modifies Windows registry for persistence, configuration storage, and system manipulation.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          Hostname|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetObject
        - Details
        - EventType

  - question: What specific NetWire RAT capabilities have been activated on this system?
    context: Different NetWire variants have varying capabilities including keylogging, screen capture, and file manipulation.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          Hostname|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage

  # Type 6: Enterprise Correlation
  - question: Are other hosts in the network communicating with the same NetWire C2 infrastructure?
    context: NetWire campaigns often target multiple systems, indicating broader compromise scope and coordinated attack.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - proto

  - question: Has this NetWire RAT campaign affected multiple enterprise systems?
    context: Identifies the scope of compromise and helps prioritize incident response efforts across the organization.
    range: +/-48h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "NetWire"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name