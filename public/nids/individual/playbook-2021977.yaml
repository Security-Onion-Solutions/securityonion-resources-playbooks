name: ET MALWARE NetWire / Ozone / Darktrack Alien RAT - Server Hello
id: 22021977
description: |
  Detects NetWire RAT family server hello response after initial connection.
  NetWire is a commercial remote access tool often used maliciously for surveillance.
  May trigger on legitimate remote administration tools with similar protocols.
type: detection
detection_id: 2021977
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact server hello response pattern that triggered this NetWire detection?
    context: Understanding the specific protocol handshake confirms RAT family and communication encryption.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - dsize
        - flow.state

  - question: What was the complete NetWire handshake sequence including client initiation?
    context: Full protocol analysis reveals RAT configuration and potential command capabilities.
    range: -5m/+5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - bytes_toserver
        - bytes_toclient
        - duration
        - flow.state

  # Type 2: Triage Assessment
  - question: Is this connection from an authorized remote administration session?
    context: Distinguishes between legitimate remote access tools and malicious RAT activity.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_port
        - dst_port
        - bytes_toserver
        - bytes_toclient

  - question: Are there legitimate remote access tools configured for this user or system?
    context: Validates if authorized remote administration explains the RAT-like traffic patterns.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - "teamviewer"
            - "vnc"
            - "rdp"
            - "remote"
        condition: selection
      fields:
        - User
        - Image
        - CommandLine

  # Type 3: Activity Context
  - question: What network activity preceded the NetWire server hello response?
    context: Understanding initial connection establishment reveals infection vector and timing.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_port
        - bytes_toserver
        - bytes_toclient
        - duration

  - question: What process initiated the outbound connection that received this server hello?
    context: Identifies the malware or compromised application establishing RAT communication.
    range: -15m
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  - question: Are there other NetWire protocol indicators around the same timeframe?
    context: Correlates multiple RAT communication phases to understand session lifecycle.
    range: -1h/+1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          alert.signature|contains:
            - "NetWire"
            - "Ozone"
            - "Darktrack"
        condition: selection
      fields:
        - src_ip
        - alert.signature
        - event_type

  # Type 4: Impact Assessment
  - question: Has the NetWire RAT established persistent command and control communication?
    context: Determines if attacker has active remote access capability for response prioritization.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - bytes_toserver
        - bytes_toclient
        - duration

  - question: What data or commands have been transmitted over the NetWire channel?
    context: Assesses potential data exfiltration or remote control activities performed via RAT.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - bytes_toserver
        - bytes_toclient
        - duration

  # Type 5: Forensic Deep-Dive
  - question: What specific NetWire RAT variant and configuration is indicated by the protocol signature?
    context: Variant identification reveals capabilities and potential attribution to specific threat actors.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - app_proto
        - proto

  - question: Are there file system artifacts indicating NetWire RAT installation or persistence?
    context: Identifies malware files, configuration, and persistence mechanisms for complete remediation.
    range: -2h/+2h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetFilename|contains:
            - ".exe"
            - ".dll"
            - ".dat"
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.hash.sha256

  - question: What registry modifications indicate NetWire RAT persistence or configuration?
    context: Registry analysis reveals persistence mechanisms and RAT configuration details.
    range: -2h/+2h
    query: |
      aggregation: true
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetObject|contains:
            - "Run"
            - "RunOnce"
            - "Service"
        condition: selection
      fields:
        - TargetObject
        - Details
        - EventType

  # Type 6: Enterprise Correlation
  - question: Are other systems showing NetWire RAT communication patterns?
    context: Identifies scope of RAT deployment and potential lateral movement across the enterprise.
    range: -24h/+24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains:
            - "NetWire"
            - "Ozone"
            - "Darktrack"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature

  - question: Is this NetWire activity part of a broader APT campaign or malware distribution?
    context: Correlates with other malware indicators to understand attack campaign scope and objectives.
    range: -7d/+1d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.category|contains:
            - "trojan-activity"
            - "command-and-control"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature