name: ET MALWARE Wrapper/Gholee/Wedex Checkin
id: 22022047
description: |
  Detects Wrapper/Gholee/Wedex malware checkin with "nocookie" parameter.
  Associated with Rocket Kitten APT campaign targeting various organizations.
  May rarely trigger on legitimate applications using similar HTTP parameters.
type: detection
detection_id: 2022047
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete Wrapper/Gholee/Wedex checkin payload?
    context: Analyzing the full payload reveals command structure and malware variant.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - payload
        - dsize
        - src_ip
        - dst_ip

  - question: What does the "nocookie" parameter indicate about this malware session?
    context: Understanding parameter usage reveals malware capabilities and communication protocol.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - flow_id
        - alert.signature

  # Type 2: Triage Assessment
  - question: Is this system authorized to communicate with external servers?
    context: Legitimate applications may use similar HTTP parameters for configuration.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method: 'POST'
        condition: selection
      fields:
        - url.full
        - http.request.body.content
        - dst_ip

  - question: Does this checkin timing align with normal system operations?
    context: Malware checkins often occur at regular intervals regardless of user activity.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - duration
        - bytes_toserver
        - conn_state

  # Type 3: Activity Context
  - question: What established the connection before this malware checkin?
    context: Understanding connection establishment reveals infection persistence and triggers.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - conn_state
        - history
        - service
        - duration

  - question: What other Rocket Kitten campaign activity occurred around this time?
    context: Multiple campaign indicators suggest coordinated APT operations.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains:
            - 'Wrapper'
            - 'Gholee'
            - 'Wedex'
            - 'Rocket Kitten'
        condition: selection
      fields:
        - alert.signature
        - alert.category
        - dst_ip

  # Type 4: Impact Assessment
  - question: What data was transmitted during this malware checkin?
    context: Checkin data may contain system information, credentials, or exfiltrated files.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - bytes_toserver
        - bytes_toclient
        - duration
        - packets_toserver

  - question: Has the infected system accessed sensitive resources since infection?
    context: Access to sensitive systems increases data breach risk and impact scope.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 445
            - 139
            - 389
            - 636
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - service
        - bytes_toclient

  # Type 5: Forensic Deep-Dive
  - question: What process initiated the Wrapper/Gholee/Wedex checkin?
    context: Identifying the host process reveals infection method and persistence mechanism.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'wrapper'
            - 'gholee'
            - 'wedex'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - User
        - ProcessGuid

  - question: Are there Rocket Kitten campaign artifacts on the infected system?
    context: Campaign artifacts reveal attack scope and persistence mechanisms.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - 'wrapper'
            - 'gholee'
            - 'wedex'
            - 'rocket'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessGuid

  # Type 6: Enterprise Correlation
  - question: Are other systems performing checkins to the same command server?
    context: Multiple infected systems indicate campaign scope and infrastructure reuse.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          alert.signature|contains:
            - 'Wrapper'
            - 'Gholee'
            - 'Wedex'
        condition: selection
      fields:
        - src_ip
        - alert.signature
        - alert.severity

  - question: What other APT campaign indicators are present in the environment?
    context: Multiple APT indicators suggest sophisticated threat actor presence.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains:
            - 'APT'
            - 'Rocket Kitten'
            - 'command-and-control'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature
        - alert.category