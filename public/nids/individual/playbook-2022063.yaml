name: ET MALWARE njrat ver 0.7d Malware CnC Callback (Get Passwords)
id: 22022063
description: |
  Detects njRAT malware command and control communication specifically for password retrieval operations.
  njRAT is a remote access trojan that can steal credentials and perform system reconnaissance.
  This signature identifies the specific "ret" command pattern used by njRAT version 0.7d.
type: detection
detection_id: 2022063
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact njRAT command pattern detected in the traffic?
    context: Understanding the specific command structure helps confirm njRAT variant and operation type.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - payload_printable
        - src_ip
        - dst_ip
        - dst_port

  - question: What connection details were involved in this malware communication?
    context: Connection metadata reveals the C2 infrastructure and communication pattern.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_port
        - dst_port
        - proto
        - conn_state

  # Type 2: Triage Assessment
  - question: Is this connection to a known legitimate service or suspicious external host?
    context: Distinguishing between legitimate remote access and malware C2 communication.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - proto

  - question: Has this source system established other suspicious connections recently?
    context: Multiple suspicious connections from same host indicates potential compromise.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - malware
            - trojan
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - dst_port

  # Type 3: Activity Context
  - question: What process initiated this network connection on the source system?
    context: Identifying the parent process helps determine infection vector and persistence.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - User

  - question: What other network activity occurred from this host around the same time?
    context: Understanding the sequence of network events reveals attack progression.
    range: +/-30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto
        - service

  # Type 4: Impact Assessment
  - question: Are there signs of credential theft or data exfiltration from this system?
    context: njRAT's password retrieval capability requires assessment of data compromise.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - credential-theft
            - data-exfiltration
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - event.severity

  - question: Has the infected system shown signs of lateral movement or privilege escalation?
    context: Assessing whether the compromise has spread beyond the initial infection point.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - lateral-movement
            - privilege-escalation
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - event.severity

  # Type 5: Forensic Deep-Dive
  - question: What files were created or modified on the infected system recently?
    context: Identifying malware artifacts and persistence mechanisms for complete remediation.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.hash.sha256
        - ProcessImage

  - question: Are there registry modifications indicating persistence mechanisms?
    context: njRAT typically establishes persistence through registry modifications.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - Run
            - RunOnce
            - Services
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessImage

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network showing similar njRAT activity?
    context: Determining if this is an isolated incident or part of a broader campaign.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: njrat
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: What other malware families or attack patterns are active in the environment?
    context: Understanding the broader threat landscape and potential coordinated attacks.
    range: +/-6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.category: malware
        condition: selection
      fields:
        - rule.name
        - src_ip
        - dst_ip