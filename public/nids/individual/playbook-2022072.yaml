name: ET MALWARE TinyLoader.B2 Checkin x64
id: 22022072
description: |
  Detects TinyLoader.B2 malware performing command and control checkin communications via UDP.
  Legitimate applications rarely use this specific 12-byte UDP pattern, making false positives unlikely.
type: detection
detection_id: 2022072
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact 12-byte UDP payload pattern detected?
    context: TinyLoader uses specific byte sequences for C2 communication that can reveal campaign variants.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - src_ip
        - dst_ip
        - dst_port
        - alert.signature

  - question: What was the timing and frequency of these UDP checkin communications?
    context: C2 beacon intervals reveal malware configuration and operational patterns.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          network.transport: "udp"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - network.bytes
        - network.packets

  # Type 2: Triage Assessment
  - question: Is this host authorized to communicate with the destination IP and port?
    context: Legitimate UDP communications should be documented in network access policies.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          network.transport: "udp"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port

  - question: Does this UDP traffic pattern match any legitimate applications on this host?
    context: Some legitimate software uses UDP for telemetry, but TinyLoader patterns are highly specific.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          network.transport: "udp"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - network.bytes

  # Type 3: Activity Context
  - question: What process initiated these UDP communications on the infected host?
    context: Identifying the parent process helps understand infection vector and persistence mechanisms.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid
        - ParentImage

  - question: Were there any file creation events associated with TinyLoader installation?
    context: TinyLoader typically creates specific files during installation that can reveal infection scope.
    range: -6h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size
        - User

  # Type 4: Impact Assessment
  - question: How long has this TinyLoader infection been active based on C2 communications?
    context: Duration of infection indicates potential data exposure and lateral movement risk.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          network.transport: "udp"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - network.bytes
        - network.packets

  - question: Are there signs of additional payload downloads or lateral movement?
    context: TinyLoader often serves as initial access for deploying additional malware or moving laterally.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - network.transport
        - network.bytes

  # Type 5: Forensic Deep-Dive
  - question: Are there other TinyLoader or related malware indicators on this host?
    context: TinyLoader campaigns often involve multiple malware families requiring comprehensive analysis.
    range: +/-12h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "TinyLoader"
        condition: selection
      fields:
        - rule.name
        - src_ip
        - dst_ip
        - alert.severity

  - question: What is the reputation and infrastructure details of the C2 server?
    context: C2 server analysis reveals campaign infrastructure and attribution indicators.
    range: +/-30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          dns.resolved_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - src_ip

  # Type 6: Enterprise Correlation
  - question: Are other hosts in the organization infected with TinyLoader.B2?
    context: TinyLoader campaigns often target multiple systems requiring coordinated incident response.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "TinyLoader"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - alert.signature

  - question: Is this part of a broader malware campaign affecting the enterprise?
    context: TinyLoader infections often indicate larger compromise requiring threat hunting activities.
    range: +/-48h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.category|contains:
            - "MALWARE"
            - "command-and-control"
        condition: selection
      fields:
        - rule.name
        - src_ip
        - dst_ip
        - rule.category