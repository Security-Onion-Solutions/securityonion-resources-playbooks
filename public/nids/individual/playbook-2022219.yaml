name: ET MALWARE Linux/KDefend Checkin
id: 22022219
description: |
  Detects Linux/KDefend malware performing system reconnaissance and check-in communication.
  KDefend is Linux malware that collects system information including CPU stats and memory usage.
  This signature identifies the specific data pattern used during system information gathering.
type: detection
detection_id: 2022219
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What specific system information was being transmitted by KDefend malware?
    context: Understanding the reconnaissance data reveals what system details the malware is collecting.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - payload_printable
        - src_ip
        - dst_ip
        - dst_port

  - question: What are the connection characteristics for this malware check-in?
    context: Connection metadata helps identify C2 infrastructure and communication frequency.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_port
        - dst_port
        - orig_bytes
        - resp_bytes
        - duration

  # Type 2: Triage Assessment
  - question: Are there legitimate system monitoring tools on this Linux system?
    context: Distinguishing between legitimate system monitoring and malware reconnaissance.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - top
            - htop
            - ps
            - vmstat
            - iostat
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  - question: Is this system authorized to transmit system statistics externally?
    context: System information should typically not be sent to external hosts without authorization.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - service

  # Type 3: Activity Context
  - question: What process initiated this system information collection and transmission?
    context: Identifying the parent process helps determine if this is malware or legitimate monitoring.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ProcessGuid
        - ParentImage
        - User

  - question: What system files were accessed for information gathering?
    context: KDefend accesses /proc/stat and other system files to collect reconnaissance data.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - /proc/stat
            - /proc/meminfo
            - /proc/cpuinfo
            - /proc/version
        condition: selection
      fields:
        - TargetFilename
        - ProcessImage

  - question: Are there signs of additional malware capabilities being deployed?
    context: System reconnaissance often precedes deployment of additional malware payloads.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category: malware
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - event.severity

  # Type 4: Impact Assessment
  - question: What sensitive system information was potentially exposed?
    context: Assessing what system details were transmitted to determine information disclosure impact.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - /etc/passwd
            - /etc/shadow
            - /etc/hosts
            - /proc/net
        condition: selection
      fields:
        - TargetFilename
        - ProcessImage

  - question: Are there signs of privilege escalation or credential theft?
    context: System reconnaissance often leads to privilege escalation attempts.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - privilege-escalation
            - credential-theft
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - event.severity

  - question: What network services or processes are running that could be targeted?
    context: Understanding attack surface based on the reconnaissance information gathered.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - service
        - proto

  # Type 5: Forensic Deep-Dive
  - question: How was the KDefend malware initially deployed on this system?
    context: Understanding infection vector helps prevent future compromises and assess campaign scope.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - exploit
            - trojan
            - malware-delivery
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - event.severity

  - question: What persistence mechanisms has the malware established?
    context: Linux malware uses various persistence methods including cron jobs and service files.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - crontab
            - /etc/systemd
            - /etc/init.d
            - /etc/rc.local
        condition: selection
      fields:
        - TargetFilename
        - ProcessImage

  - question: What other C2 communication patterns are associated with this malware?
    context: KDefend may use multiple communication methods or check-in frequencies.
    range: +/-6h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - orig_bytes
        - resp_bytes
        - service

  # Type 6: Enterprise Correlation
  - question: Are other Linux systems showing similar KDefend or reconnaissance activity?
    context: Determining if this is an isolated infection or part of a broader campaign.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - kdefend
            - reconnaissance
            - system-info
        condition: selection
      fields:
        - src_ip
        - rule.name
        - dst_ip

  - question: What related indicators of this threat appear across the network?
    context: Correlating C2 servers, malware signatures, and system reconnaissance for threat assessment.
    range: +/-12h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - rule.name
        - rule.category