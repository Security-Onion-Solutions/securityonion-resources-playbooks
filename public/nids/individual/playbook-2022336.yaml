name: ET MALWARE ELF.MrBlack DOS.TF Variant
id: 22022336
description: |
  Detects ELF.MrBlack DDoS malware variant communicating with command and control servers.
  The malware targets Linux systems to participate in distributed denial of service attacks.
  May trigger on legitimate applications with similar binary patterns or protocol signatures.
type: detection
detection_id: 2022336
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact binary signature pattern detected in the malware communication?
    context: The specific "Linux_" and "TF-" patterns identify the MrBlack variant and its capabilities.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - rule.name
        - alert.signature

  - question: What C2 server and port is the MrBlack malware connecting to?
    context: Identifying the command and control infrastructure helps understand the botnet operations.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - src_ip
        - bytes_toserver
        - bytes_toclient

  # Type 2: Triage Assessment
  - question: Is this network traffic from a legitimate Linux application or service?
    context: Some legitimate applications may generate similar binary patterns in network communications.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|expand: '%dst_port%'
        condition: selection
      fields:
        - dst_ip
        - connection_state
        - bytes_toserver
        - frequency

  - question: Does this system have authorized remote access or management tools?
    context: Remote administration tools on Linux systems may generate similar outbound connections.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 22
            - 443
            - 8080
            - 9090
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection_state

  # Type 3: Activity Context
  - question: What process initiated this malicious network communication?
    context: Identifying the parent process reveals how the malware was executed and its persistence.
    range: -30m/+15m
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid

  - question: What initial compromise vector led to this malware infection?
    context: Understanding the infection method helps prevent similar attacks and assess scope.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - "EXPLOIT"
            - "TROJAN"
            - "MALWARE"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.category

  - question: What file system changes occurred during malware deployment?
    context: File modifications reveal malware installation paths and potential persistence mechanisms.
    range: -2h/+30m
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessImage
        - file.mime_type

  # Type 4: Impact Assessment
  - question: Is the infected system actively participating in DDoS attacks?
    context: High-volume outbound traffic indicates active participation in denial of service attacks.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          bytes_toserver: ">10000000"
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver
        - connection_state

  - question: What other systems or services is this malware attempting to compromise?
    context: Lateral movement capabilities indicate the potential for network-wide compromise.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 22
            - 23
            - 80
            - 443
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection_state
        - bytes_toserver

  # Type 5: Forensic Deep-Dive
  - question: What specific DDoS attack commands has the malware received?
    context: Command analysis reveals the targets and methods of ongoing or planned attacks.
    range: -1h/+4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
          bytes_toclient: ">1000"
        condition: selection
      fields:
        - src_ip
        - bytes_toclient
        - connection_state
        - dst_port

  - question: Are there indicators of additional malware families or tools deployed?
    context: MrBlack infections often coincide with other malware for comprehensive system compromise.
    range: -2h/+2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - "MALWARE"
            - "TROJAN"
        condition: selection
      fields:
        - rule.name
        - rule.category
        - dst_ip

  - question: What persistence mechanisms has the malware established?
    context: Understanding persistence helps with complete malware removal and system recovery.
    range: -1h/+1h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - "/etc/init"
            - "/etc/cron"
            - "/etc/systemd"
            - ".bashrc"
        condition: selection
      fields:
        - TargetFilename
        - ProcessImage
        - file.hash.md5

  # Type 6: Enterprise Correlation
  - question: Are other Linux systems in the network infected with similar malware?
    context: DDoS botnets often target multiple systems within the same network for maximum impact.
    range: -4h/+4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - "MrBlack"
            - "DOS.TF"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is this part of a broader botnet recruitment campaign?
    context: Coordinated malware infections indicate organized cybercriminal operations.
    range: -24h/+4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.category|contains:
            - "MALWARE"
            - "BOTNET"
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - rule.name
        - rule.category