name: ET EXPLOIT Possible CVE-2016-0777 Client Sent Roaming Resume Request
id: 22022370
description: |
  Detects SSH clients sending roaming resume requests that may indicate CVE-2016-0777 exploitation attempts.
  This vulnerability allows information disclosure when connecting to malicious SSH servers.
  Legitimate SSH clients may send roaming requests but should not use suspicious resume addresses.
type: detection
detection_id: 2022370
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the exact SSH roaming resume request content sent by the client?
    context: The specific roaming request reveals exploitation attempt details and client vulnerability.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - ssh.client.software_version

  - question: Is this SSH client part of legitimate administrative activity?
    context: Determines if this is authorized SSH usage or potentially compromised client system.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 22
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - bytes_toclient
        - duration

  - question: What SSH server is this client attempting to connect to?
    context: Identifies potentially malicious SSH server designed to exploit CVE-2016-0777.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 22
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver
        - bytes_toclient

  - question: What user or process initiated this potentially vulnerable SSH connection?
    context: Identifies the user at risk and the application making the vulnerable SSH connection.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains: "ssh"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ParentImage

  - question: Was the SSH connection successful and what was exchanged?
    context: Determines if exploitation was successful and sensitive information may have been disclosed.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 22
        condition: selection
      fields:
        - duration
        - bytes_toserver
        - bytes_toclient
        - connection_state

  - question: What is the SSH client software version and configuration?
    context: Determines if client is vulnerable to CVE-2016-0777 and needs patching.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "SSH"
        condition: selection
      fields:
        - ssh.client.software_version
        - ssh.server.software_version
        - rule.name

  - question: Are there other systems making similar vulnerable SSH connections?
    context: Identifies scope of potential CVE-2016-0777 exploitation across the environment.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - "CVE-2016-0777"
            - "roaming"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Has sensitive information potentially been disclosed from this client system?
    context: CVE-2016-0777 can lead to disclosure of private keys and other sensitive data.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - "id_rsa"
            - "id_dsa"
            - "id_ecdsa"
            - ".ssh"
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessName

  - question: Are there follow-up connections or suspicious activity from this client?
    context: Identifies potential post-exploitation activity following SSH vulnerability exploitation.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver
        - bytes_toclient

  - question: Is this part of a broader SSH-based attack campaign targeting the organization?
    context: Determines if this is isolated incident or coordinated attack against SSH infrastructure.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - "SSH"
            - "EXPLOIT"
            - "CVE-2016-0777"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - rule.category