name: ET EXPLOIT Possible CVE-2015-7547 Malformed Server Response A/AAAA
id: 22022545
description: |
  Detects potential CVE-2015-7547 glibc DNS resolver buffer overflow exploitation via malformed DNS responses.
  This vulnerability allows remote code execution through crafted DNS responses containing oversized A/AAAA records.
  May trigger on legitimate DNS responses with unusual formatting or corrupted packets.
type: detection
detection_id: 2022545
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the malformed DNS response structure that triggered this alert?
    context: Analyzing the DNS packet structure reveals exploitation attempt characteristics and payload size.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - alert.signature

  - question: What DNS query preceded this malformed response?
    context: Understanding the original query helps determine if this was targeted exploitation or opportunistic scanning.
    range: -5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.resolved_ip

  # Type 2: Triage Assessment
  - question: Is this DNS server a known legitimate resolver for this network segment?
    context: Distinguishing between trusted DNS infrastructure and potentially malicious resolvers.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dns.query.name

  - question: Are there patterns of normal DNS resolution from this server?
    context: Establishing baseline DNS behavior to differentiate from exploitation attempts.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.type_name
        - dns.resolved_ip

  # Type 3: Activity Context
  - question: What DNS queries were made by the target host before receiving this response?
    context: Understanding the query sequence helps determine if this was a targeted response or broadcast attack.
    range: -10m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dns.query.name
        - dns.query.type_name

  - question: What network connections were established around the time of this DNS response?
    context: Identifying potential follow-up exploitation attempts or command and control connections.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - service

  # Type 4: Impact Assessment
  - question: Did any processes crash or exhibit unusual behavior on the target host after this DNS response?
    context: CVE-2015-7547 can cause segmentation faults or remote code execution in glibc-based applications.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine

  - question: Were there any suspicious network connections initiated from the target host after the DNS response?
    context: Successful exploitation may result in reverse shells or data exfiltration attempts.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - service

  # Type 5: Forensic Deep-Dive
  - question: What specific glibc-based applications were running on the target host?
    context: Identifying vulnerable applications helps assess exploitation success and required remediation.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - User

  - question: Are there indicators of successful code execution or persistence mechanisms?
    context: Analyzing for signs of successful exploitation including new processes or file modifications.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5

  # Type 6: Enterprise Correlation
  - question: Are other hosts receiving similar malformed DNS responses from this server?
    context: Determining if this is part of a broader DNS poisoning or exploitation campaign.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains: 'CVE-2015-7547'
        condition: selection
      fields:
        - dst_ip
        - alert.signature

  - question: Is this DNS server involved in other suspicious activities across the enterprise?
    context: Identifying if the DNS server is compromised or being used for multiple attack vectors.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - alert.signature
        - alert.category
        - dst_ip