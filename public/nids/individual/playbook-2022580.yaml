name: ET SCAN MySQL Malicious Scanning 2
id: 22022580
description: |
  Detects malicious MySQL scanning attempts using log_bin_trust_function_creators setting.
  This pattern indicates exploitation attempts to enable dangerous MySQL functions.
  May trigger on legitimate database configuration changes.
type: detection
detection_id: 2022580
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete MySQL configuration command detected?
    context: The log_bin_trust_function_creators setting enables dangerous function execution capabilities.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - src_ip
        - dst_ip
        - dst_port
        - payload_printable

  - question: Is this source authorized to perform MySQL administration?
    context: Helps distinguish between legitimate DBA activities and malicious exploitation.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 3306
        condition: selection
      fields:
        - bytes_toserver
        - bytes_toclient
        - duration

  - question: Are both MySQL exploitation patterns detected from this source?
    context: Multiple exploitation techniques indicate sophisticated attack methodology.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: 'MySQL Malicious Scanning'
        condition: selection
      fields:
        - rule.name
        - dst_port

  - question: What was the response from the MySQL server to this command?
    context: Server response indicates if the exploitation attempt was successful.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 3306
        condition: selection
      fields:
        - bytes_toserver
        - bytes_toclient
        - duration

  - question: Is this attacker targeting multiple MySQL servers?
    context: Indicates automated scanning tools or coordinated attack campaign.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 3306
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver

  - question: Are there signs of successful MySQL compromise after this attempt?
    context: Successful exploitation may lead to data access or additional malicious commands.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 3306
          bytes_toserver|gte: 1000
        condition: selection
      fields:
        - bytes_toserver
        - bytes_toclient
        - duration

  - question: What other database exploitation attempts originate from this source?
    context: Attackers often target multiple database types during reconnaissance campaigns.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'SQL'
            - 'database'
            - 'Oracle'
            - 'PostgreSQL'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - rule.name

  - question: Are there network reconnaissance activities from this attacker?
    context: MySQL exploitation is often preceded by port scanning and service enumeration.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: 'SCAN'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - rule.name

  - question: Is this MySQL server externally accessible from the internet?
    context: Internet-facing databases are higher risk targets for exploitation attempts.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 3306
        condition: selection
      fields:
        - src_ip
        - geoip.country_name

  - question: What domain infrastructure is associated with this attacker?
    context: May reveal command and control or attack infrastructure patterns.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          dns.resolved_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - src_ip

  - question: Are there similar MySQL exploitation attempts across the enterprise?
    context: Determines if this is part of a coordinated attack against organizational infrastructure.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'MySQL Malicious Scanning'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Has this MySQL server been accessed by other suspicious sources recently?
    context: Multiple attackers may target the same vulnerable database server.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 3306
        condition: selection
      fields:
        - src_ip
        - bytes_toserver
        - geoip.country_name