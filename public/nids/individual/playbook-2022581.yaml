name: ET SCAN MySQL Malicious Scanning 3
id: 22022581
description: |
  Detects MySQL exploitation attempts using SELECT UNHEX and INTO DUMPFILE commands to write binary payloads to disk.
  This technique is commonly used to deploy web shells or malicious executables via SQL injection.
  May trigger on legitimate database administration involving hexadecimal data export operations.
type: detection
detection_id: 2022581
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete SQL injection payload attempting to write to disk?
    context: Understanding the full payload reveals the attacker's intent and potential malware being deployed.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - alert.signature

  - question: What hexadecimal content was being decoded and written to the filesystem?
    context: Analyzing the UNHEX payload can reveal web shells, backdoors, or other malicious executables.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port

  # Type 2: Triage Assessment
  - question: Is this MySQL server configured for legitimate administrative file operations?
    context: Determining if INTO DUMPFILE operations are part of normal database maintenance procedures.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 3306
        condition: selection
      fields:
        - src_ip
        - service

  - question: Are there authorized database administrators connecting from this source IP?
    context: Distinguishing between legitimate DBA activities and unauthorized access attempts.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 3306
        condition: selection
      fields:
        - dst_ip
        - service

  # Type 3: Activity Context
  - question: What preceded this MySQL exploitation attempt on the same connection?
    context: Understanding the attack sequence helps identify the initial compromise vector and attack progression.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 3306
        condition: selection
      fields:
        - service
        - bytes_toserver
        - bytes_toclient

  - question: Were there web application requests that could have led to this SQL injection?
    context: Identifying the web application vulnerability that enabled database access.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.request.body.content

  # Type 4: Impact Assessment
  - question: Did the MySQL server successfully write files to the filesystem?
    context: Determining if the exploitation attempt was successful and malicious files were created.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.mime_type

  - question: Are there signs of web shell deployment or remote code execution?
    context: Assessing if the file write operation led to persistent access mechanisms.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine

  # Type 5: Forensic Deep-Dive
  - question: What MySQL user account was used for this exploitation attempt?
    context: Identifying compromised database credentials and assessing privilege escalation.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 3306
        condition: selection
      fields:
        - service
        - bytes_toserver

  - question: What file paths were targeted for the malicious file writes?
    context: Understanding target directories helps identify web-accessible locations and potential impact scope.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          alert.signature|contains: 'dumpfile'
        condition: selection
      fields:
        - payload
        - alert.signature

  # Type 6: Enterprise Correlation
  - question: Are other MySQL servers experiencing similar exploitation attempts from this source?
    context: Determining if this is part of a broader database compromise campaign.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 3306
          alert.signature|contains: 'MySQL'
        condition: selection
      fields:
        - dst_ip
        - alert.signature

  - question: Is this attacker targeting other database services or web applications?
    context: Understanding the full scope of the attack campaign and targeted infrastructure.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 3306
            - 5432
            - 1433
            - 80
            - 443
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - service