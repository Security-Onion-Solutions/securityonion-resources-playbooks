name: ET ATTACK_RESPONSE Possible CVE-2016-1287 Inbound Reverse CLI Shellcode
id: 22022819
description: |
  Detects potential CVE-2016-1287 Cisco ASA exploitation attempts via IKE packets containing reverse shell payloads.
  This vulnerability allows remote code execution through malformed IKE packets targeting Cisco ASA firewalls.
  May trigger on legitimate IKE traffic with unusual formatting or VPN client connection attempts.
type: detection
detection_id: 2022819
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the reverse shell payload embedded in the IKE packet?
    context: Analyzing the shellcode reveals the attacker's intended command and control infrastructure.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - alert.signature

  - question: What IP address and port was the reverse shell attempting to connect to?
    context: Identifying the command and control server helps track attacker infrastructure and block communications.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable

  # Type 2: Triage Assessment
  - question: Is this Cisco ASA device part of the organization's network perimeter?
    context: Determining if this is a critical security infrastructure component requiring immediate attention.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 500
        condition: selection
      fields:
        - src_ip
        - service

  - question: Are there legitimate VPN users connecting through this ASA device?
    context: Establishing baseline IKE/IPSec usage patterns to differentiate from exploitation attempts.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 500
            - 4500
        condition: selection
      fields:
        - src_ip
        - dst_port

  # Type 3: Activity Context
  - question: What IKE negotiation attempts preceded this exploitation payload?
    context: Understanding the VPN handshake sequence helps identify how the attacker reached the vulnerable code path.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 500
            - 4500
        condition: selection
      fields:
        - dst_port
        - service
        - bytes_toserver

  - question: Were there reconnaissance or scanning activities from this source IP?
    context: Identifying broader attack patterns that led to ASA device discovery and targeting.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - service

  # Type 4: Impact Assessment
  - question: Did the ASA device establish any outbound connections after receiving this payload?
    context: Determining if the reverse shell exploitation was successful and command and control was established.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - service

  - question: Are there signs of configuration changes or administrative access on the ASA device?
    context: Assessing if successful exploitation led to firewall rule modifications or credential theft.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 22
            - 23
            - 443
        condition: selection
      fields:
        - src_ip
        - dst_port
        - service

  # Type 5: Forensic Deep-Dive
  - question: What Cisco ASA software version is running on the targeted device?
    context: Confirming vulnerability status and determining if patches have been applied.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 443
            - 22
        condition: selection
      fields:
        - src_ip
        - service
        - bytes_toclient

  - question: What network traffic patterns changed after the exploitation attempt?
    context: Identifying potential network policy changes or unauthorized traffic flows through the compromised firewall.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - service

  # Type 6: Enterprise Correlation
  - question: Are other Cisco ASA devices receiving similar exploitation attempts from this source?
    context: Determining if this is part of a broader campaign targeting Cisco firewall infrastructure.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains: 'CVE-2016-1287'
        condition: selection
      fields:
        - dst_ip
        - alert.signature

  - question: Is this attacker targeting other network security appliances or VPN services?
    context: Understanding the full scope of network infrastructure targeting and potential compromise.
    range: +/-6h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 500
            - 4500
            - 1723
            - 443
            - 22
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - service