name: ET MALWARE PowerShell/Agent.A DNS File Transfer CnC Beacon
id: 22022837
description: |
  Detects DNS-based command and control communication used by PowerShell/Agent.A malware.
  May trigger on legitimate DNS tunneling tools or custom applications using DNS for data transfer.
type: detection
detection_id: 2022837
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact DNS query pattern and encoded data detected?
    context: The DNS query structure reveals the data exfiltration method and encoding scheme used by the malware.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - rule.name
        - alert.signature

  - question: What domain names were queried in this DNS tunneling communication?
    context: Domain analysis helps identify the command and control infrastructure and potential attribution.
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  # Type 2: Triage Assessment
  - question: Is this system authorized to use DNS tunneling or custom DNS applications?
    context: Some organizations use legitimate DNS tunneling for network troubleshooting or specialized applications.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name

  - question: Are there scheduled tasks or applications that could generate unusual DNS patterns?
    context: Legitimate applications may generate DNS queries that resemble tunneling behavior.
    range: -1d
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - "powershell.exe"
            - "nslookup.exe"
            - "dig.exe"
        condition: selection
      fields:
        - CommandLine
        - Image
        - User

  # Type 3: Activity Context
  - question: What PowerShell activity preceded this DNS tunneling detection?
    context: Understanding PowerShell execution context helps identify the malware deployment and activation method.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains: "powershell.exe"
        condition: selection
      fields:
        - CommandLine
        - User
        - ProcessGuid
        - Image

  - question: What network connections or file downloads occurred before this DNS activity?
    context: Initial infection vectors help understand how the PowerShell/Agent.A malware was delivered.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.bytes
        - network.protocol

  # Type 4: Impact Assessment
  - question: What data is being exfiltrated through these DNS queries?
    context: Understanding exfiltrated data helps assess the impact and sensitivity of compromised information.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.query.name|contains: "232A"
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name

  - question: Has the malware established persistence or created additional backdoors?
    context: Persistence mechanisms indicate the extent of system compromise and cleanup requirements.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - "Run"
            - "RunOnce"
            - "Services"
        condition: selection
      fields:
        - TargetObject
        - Details

  # Type 5: Forensic Deep-Dive
  - question: What specific PowerShell/Agent.A variant and capabilities are present?
    context: Malware variant analysis helps understand the threat actor's tools and potential future activities.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - "MALWARE"
            - "TROJAN"
        condition: selection
      fields:
        - rule.name
        - alert.signature_id
        - payload

  - question: What files were created or modified during the malware execution?
    context: File system changes reveal malware artifacts and potential data theft or system modifications.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.mime_type

  - question: What command and control servers are being contacted through DNS tunneling?
    context: C2 infrastructure analysis helps identify the threat actor's network and enables blocking measures.
    range: +24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip

  # Type 6: Enterprise Correlation
  - question: Are other systems showing similar PowerShell/Agent.A DNS tunneling activity?
    context: Multiple infections indicate a broader campaign requiring coordinated incident response.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "PowerShell/Agent.A DNS"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is this part of a larger data exfiltration campaign across the organization?
    context: Enterprise-wide correlation helps assess the total scope of data compromise and threat actor presence.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.category: "MALWARE"
          rule.name|contains:
            - "Exfiltration"
            - "DNS"
            - "PowerShell"
        condition: selection
      fields:
        - src_ip
        - rule.name