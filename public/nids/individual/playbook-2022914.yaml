name: ET INFO NBNS Name Query Response Possible WPAD Spoof BadTunnel
id: 22022914
description: |
  Detects NBNS name query responses that may indicate WPAD spoofing attacks.
  This technique can redirect web proxy autodiscovery to malicious servers.
  May trigger on legitimate network infrastructure responses.
type: detection
detection_id: 2022914
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the exact NBNS response pattern and target name queried?
    context: The response pattern and target name reveal the scope of the WPAD spoofing attempt.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - src_ip
        - dst_ip
        - payload_printable

  - question: Is this response from a legitimate network infrastructure device?
    context: Helps distinguish between malicious WPAD spoofing and legitimate network responses.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 53
            - 137
            - 138
            - 139
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver

  - question: Are there multiple WPAD-related queries from the target host?
    context: Multiple queries may indicate active WPAD spoofing exploitation attempts.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dns.query.name|contains: 'wpad'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  - question: What HTTP proxy configuration requests follow this NBNS response?
    context: WPAD spoofing leads to proxy configuration requests that reveal the attack success.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          url.path|contains: 'wpad.dat'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - dst_ip

  - question: Is the responding host configured as a legitimate WPAD server?
    context: Determines if this is authorized network infrastructure or malicious spoofing.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains: 'wpad.dat'
        condition: selection
      fields:
        - url.full
        - http.response.status_code

  - question: Are there other NetBIOS name resolution attacks from this source?
    context: Attackers often use multiple NetBIOS spoofing techniques for network compromise.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'NBNS'
            - 'NetBIOS'
            - 'SMB'
        condition: selection
      fields:
        - dst_ip
        - rule.name

  - question: What credentials are being captured through this WPAD attack?
    context: WPAD spoofing often leads to credential theft through proxy authentication.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          http.request.headers.authorization|exists: true
        condition: selection
      fields:
        - dst_ip
        - http.request.headers.authorization
        - url.full

  - question: Are there SMB authentication attempts following this NBNS response?
    context: WPAD attacks may be combined with SMB relay attacks for credential theft.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
          dst_port|contains:
            - 445
            - 139
        condition: selection
      fields:
        - dst_port
        - bytes_toserver
        - bytes_toclient

  - question: Is this part of a broader man-in-the-middle attack campaign?
    context: WPAD spoofing is often used as part of larger network compromise operations.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'Spoof'
            - 'MITM'
            - 'ARP'
        condition: selection
      fields:
        - dst_ip
        - rule.name

  - question: What legitimate proxy servers are configured in this network segment?
    context: Helps determine if the WPAD response conflicts with authorized proxy infrastructure.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 8080
            - 3128
            - 8888
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver

  - question: Are there DNS poisoning attempts targeting WPAD domains?
    context: Attackers may combine DNS and NBNS spoofing for comprehensive WPAD attacks.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          dns.query.name|contains: 'wpad'
          dns.resolved_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - src_ip

  - question: Has this attack technique been detected across multiple network segments?
    context: Determines the scope of the WPAD spoofing campaign within the organization.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: 'ET INFO NBNS Name Query Response Possible WPAD Spoof BadTunnel'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - community_id