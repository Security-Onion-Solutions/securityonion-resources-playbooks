name: ET DOS DNS Amplification Attack Possible Inbound Windows Non-Recursive Root Hint Reserved Port
id: 22023053
description: |
  Detects potential DNS amplification attacks targeting Windows systems on reserved ports.
  May trigger on legitimate DNS responses to applications using non-standard ports.
type: detection
detection_id: 2023053
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact DNS response pattern and root-servers content detected?
    context: Understanding the DNS response structure reveals amplification attack characteristics.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - dns.response_code
        - dns.flags

  - question: What is the size ratio between DNS query and response?
    context: DNS amplification attacks exploit large response-to-query ratios for DDoS impact.
    range: -5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - network.bytes
        - network.packets

  # Type 2: Triage Assessment
  - question: Is this system normally receiving DNS responses on reserved ports?
    context: Legitimate applications may use non-standard ports for DNS communication.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|expand: '%dst_port%'
          network.protocol: udp
        condition: selection
      fields:
        - src_ip
        - network.bytes
        - network.packets

  - question: Does the timing align with known maintenance or testing activities?
    context: DNS testing tools may generate similar traffic patterns during authorized activities.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dns.query.name
        - dns.query.type_name

  # Type 3: Activity Context
  - question: What triggered the initial DNS queries that led to these responses?
    context: Understanding the query origin helps distinguish between attack traffic and legitimate requests.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.response_code

  - question: What other network activity occurred around the same timeframe?
    context: Concurrent network activity may indicate coordinated attack or legitimate system behavior.
    range: -15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - network.protocol
        - network.bytes

  # Type 4: Impact Assessment
  - question: What is the volume and frequency of DNS amplification traffic?
    context: High volume indicates successful DDoS amplification requiring immediate mitigation.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - network.bytes
        - network.packets
        - dns.query.type_name

  - question: Are there signs of service degradation or resource exhaustion?
    context: DNS amplification attacks aim to overwhelm target systems with traffic volume.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - network.bytes
        - network.packets
        - network.protocol

  # Type 5: Forensic Deep-Dive
  - question: What specific DNS record types are being amplified?
    context: Different record types provide varying amplification ratios for attackers.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - network.bytes

  - question: Are there indicators of spoofed source addresses in the attack traffic?
    context: DNS amplification attacks typically use spoofed source IPs to redirect responses.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
          network.protocol: udp
          dst_port: 53
        condition: selection
      fields:
        - src_ip
        - network.bytes
        - network.packets

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network experiencing similar DNS amplification attacks?
    context: Coordinated attacks often target multiple systems simultaneously.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "DNS Amplification"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is this part of a broader DDoS campaign targeting the organization?
    context: DNS amplification may be one vector in a multi-vector DDoS attack.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.category|contains:
            - "DOS"
            - "DDoS"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - rule.category