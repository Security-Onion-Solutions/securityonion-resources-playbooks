name: ET MALWARE Windows dir Microsoft Windows DOS prompt command exit OUTBOUND
id: 22023205
description: |
  Detects Windows directory listing command output being transmitted outbound, indicating
  potential malware command and control communication or data exfiltration. May trigger
  on legitimate remote administration tools or automated system management.
type: detection
detection_id: 2023205
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete directory listing output being transmitted?
    context: Understanding the directory structure reveals what system information is being exfiltrated.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - alert.signature
        - network.transport
        - payload

  - question: What specific directories and file information were included in the outbound transmission?
    context: The directory listing content indicates what sensitive information may have been exposed.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - network.bytes_sent

  # Type 2: Triage Assessment
  - question: Is this system authorized to transmit directory listings to external destinations?
    context: Legitimate remote administration or backup systems may transmit directory information externally.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - network.protocol

  - question: Are there scheduled backup or system management activities that could explain this traffic?
    context: Distinguishing between legitimate system administration and malicious data exfiltration.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'backup'
            - 'robocopy'
            - 'xcopy'
            - 'powershell'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine

  # Type 3: Activity Context
  - question: What process executed the directory listing command that generated this output?
    context: Identifying the parent process helps determine if this is malware activity or legitimate administration.
    range: -15m
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'dir'
            - 'ls'
            - 'Get-ChildItem'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  - question: What network connection was established to transmit this directory information?
    context: Understanding the communication channel helps identify the command and control infrastructure.
    range: -5m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_port
        - dst_port
        - network.protocol
        - network.bytes_sent

  - question: Were there other system commands executed before this directory listing was transmitted?
    context: Malware often executes reconnaissance commands in sequence to gather system information.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'systeminfo'
            - 'whoami'
            - 'ipconfig'
            - 'netstat'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine

  # Type 4: Impact Assessment
  - question: What sensitive directories or system information was potentially exposed in the transmission?
    context: Assessing the scope of information disclosure to determine impact and response priority.
    range: +15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - network.bytes_sent
        - network.bytes_received
        - dst_port

  - question: Has additional data been exfiltrated following this directory listing transmission?
    context: Directory listings often precede bulk data exfiltration as attackers identify valuable files.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - network.bytes_sent
        - dst_port
        - network.protocol

  # Type 5: Forensic Deep-Dive
  - question: What malware family or remote access tool is responsible for this directory listing exfiltration?
    context: Identifying the specific malware helps understand capabilities and potential persistence mechanisms.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'cmd.exe'
            - 'powershell.exe'
            - 'wscript.exe'
            - 'cscript.exe'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  - question: Are there signs of persistent malware installation or scheduled tasks on the affected system?
    context: Systems transmitting directory listings may have persistent malware requiring remediation.
    range: +24h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'schtasks'
            - 'at.exe'
            - 'reg add'
            - 'startup'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine

  # Type 6: Enterprise Correlation
  - question: Are other systems in the environment transmitting similar directory listing information?
    context: Coordinated malware campaigns often affect multiple systems simultaneously.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: 'Windows dir'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature

  - question: Is this external destination receiving directory listings from multiple internal systems?
    context: Understanding the scope of the campaign helps assess the threat actor's reach within the organization.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          alert.signature|contains:
            - 'dir'
            - 'DOS prompt'
            - 'command'
        condition: selection
      fields:
        - src_ip
        - alert.signature
        - alert.category