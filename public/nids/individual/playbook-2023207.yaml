name: ET MALWARE Windows Microsoft Windows DOS prompt command Error not recognized
id: 22023207
description: |
  Detects Windows command prompt "not recognized" error messages being transmitted outbound,
  indicating malware attempting to execute invalid or missing commands. May trigger on
  legitimate remote administration tools with incorrect command syntax.
type: detection
detection_id: 2023207
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What specific command was not recognized that generated this error message?
    context: Understanding the failed command reveals the attacker's intended actions and potential malware capabilities.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - alert.signature
        - network.transport
        - payload

  - question: What was the complete error message content transmitted outbound?
    context: The full error message may reveal command arguments and execution context attempted by the malware.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - network.bytes_sent

  # Type 2: Triage Assessment
  - question: Is this system authorized to execute remote commands that might generate command errors?
    context: Legitimate remote administration may occasionally attempt invalid commands during troubleshooting.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - network.protocol

  - question: Are there scheduled administrative tasks or remote management sessions active on this system?
    context: Distinguishing between legitimate administration errors and malicious command execution attempts.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'mstsc.exe'
            - 'winrs.exe'
            - 'psexec'
            - 'teamviewer'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine

  # Type 3: Activity Context
  - question: What process attempted to execute the unrecognized command?
    context: Identifying the parent process helps determine if this is malware activity or legitimate tool usage.
    range: -15m
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'cmd.exe'
            - 'powershell.exe'
            - 'wscript.exe'
            - 'cscript.exe'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  - question: What network connection was established to transmit this command error?
    context: Understanding the communication channel helps identify command and control infrastructure.
    range: -5m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_port
        - dst_port
        - network.protocol
        - network.bytes_sent

  - question: Were there other command execution attempts before this unrecognized command error?
    context: Malware often attempts multiple commands in sequence, some of which may fail or be unrecognized.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'systeminfo'
            - 'whoami'
            - 'dir'
            - 'ipconfig'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine

  # Type 4: Impact Assessment
  - question: Despite the command error, was any system information or error details transmitted?
    context: Even failed commands may leak system information through error messages or partial execution.
    range: +15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - network.bytes_sent
        - network.bytes_received
        - dst_port

  - question: Has the malware attempted alternative commands or tools following this command failure?
    context: Command failures often prompt attackers to try different approaches or fallback mechanisms.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'cmd.exe'
            - 'powershell.exe'
            - 'wmic.exe'
            - 'net.exe'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine

  # Type 5: Forensic Deep-Dive
  - question: What malware family or remote access tool is responsible for these command execution attempts?
    context: Identifying the specific malware helps understand its command set and potential system impact.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          User|contains:
            - 'SYSTEM'
            - 'NETWORK SERVICE'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  - question: Are there signs of malware persistence mechanisms despite command execution failures?
    context: Command errors don't prevent malware installation; persistence may still be established successfully.
    range: +24h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - 'startup'
            - 'temp'
            - 'appdata'
            - '.exe'
        condition: selection
      fields:
        - TargetFilename
        - User
        - ProcessGuid

  # Type 6: Enterprise Correlation
  - question: Are other systems experiencing similar unrecognized command errors with the same external destination?
    context: Coordinated malware campaigns often show similar error patterns across infected systems.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: 'not recognized'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature

  - question: Is this external destination receiving command errors or output from multiple internal systems?
    context: Understanding the campaign scope helps assess the threat actor's operational success and organizational reach.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          alert.signature|contains:
            - 'DOS prompt'
            - 'command Error'
            - 'not recognized'
        condition: selection
      fields:
        - src_ip
        - alert.signature
        - alert.category