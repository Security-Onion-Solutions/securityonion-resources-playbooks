name: ET MALWARE Windows net statistics workstation Microsoft Windows DOS prompt command exit OUTBOUND
id: 22023209
description: |
  Detects Windows net statistics workstation command output being transmitted outbound.
  May indicate data exfiltration of system reconnaissance information by malware.
  Could be legitimate remote administration or monitoring tools.
type: detection
detection_id: 2023209
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete workstation statistics data being transmitted?
    context: Understanding the full payload reveals what system information was exfiltrated.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - http.request.body.content
        - rule.name

  - question: What process initiated this network connection?
    context: Identifying the source process helps determine if this is malware or legitimate administration.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_port
        - dst_port
        - proto
        - bytes_toserver

  - question: Is this system normally used for remote administration?
    context: Legitimate remote management tools may generate similar traffic patterns.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto

  - question: What triggered the net statistics command execution?
    context: Understanding the parent process chain reveals attack methodology.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains: 'net statistics'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ParentImage

  - question: What other reconnaissance commands were executed around this time?
    context: Attackers typically run multiple enumeration commands in sequence.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'net user'
            - 'net group'
            - 'whoami'
            - 'systeminfo'
            - 'tasklist'
        condition: selection
      fields:
        - CommandLine
        - Image
        - User

  - question: Has sensitive data been accessed following this reconnaissance?
    context: System enumeration often precedes data theft or privilege escalation.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - '.txt'
            - '.doc'
            - '.pdf'
            - '.xls'
        condition: selection
      fields:
        - TargetFilename
        - ProcessName
        - User

  - question: What is the reputation and geolocation of the destination IP?
    context: Malicious destinations often correlate with known threat infrastructure.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - dst_ip
        - geoip.country_name
        - threat.indicator.ip

  - question: Are there signs of data staging or compression before transmission?
    context: Attackers often prepare stolen data before exfiltration.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'rar'
            - 'zip'
            - '7z'
            - 'tar'
        condition: selection
      fields:
        - CommandLine
        - Image
        - User

  - question: What persistence mechanisms exist on this system?
    context: Understanding attacker foothold helps determine cleanup requirements.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - 'Run'
            - 'RunOnce'
            - 'Services'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessName

  - question: Are other systems in the network showing similar exfiltration patterns?
    context: Coordinated data theft often affects multiple systems simultaneously.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: 'ET MALWARE Windows net statistics workstation Microsoft Windows DOS prompt command exit OUTBOUND'
        condition: selection
      fields:
        - src_ip
        - dst_ip

  - question: What is the timing pattern of this data transmission?
    context: Understanding transmission timing helps identify automated vs manual exfiltration.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - bytes_toserver
        - duration