name: ET MALWARE Windows net statistics server Microsoft Windows DOS prompt command exit OUTBOUND
id: 22023210
description: |
  Detects Windows net statistics server command output being transmitted outbound.
  May indicate data exfiltration of server configuration information by malware.
  Could be legitimate server monitoring or remote administration.
type: detection
detection_id: 2023210
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete server statistics data being transmitted?
    context: Understanding the full payload reveals what server information was exfiltrated.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - http.request.body.content
        - rule.name

  - question: What server services and shares were enumerated?
    context: Server statistics reveal critical infrastructure information valuable to attackers.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'net share'
            - 'net use'
            - 'net view'
        condition: selection
      fields:
        - CommandLine
        - Image
        - User

  - question: Is this server normally monitored remotely?
    context: Legitimate server monitoring may generate similar network patterns.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 80
            - 443
            - 3389
            - 22
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto

  - question: What administrative privileges were used for this enumeration?
    context: Understanding privilege level reveals potential compromise scope.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains: 'net statistics server'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ParentCommandLine

  - question: What other server enumeration occurred in this timeframe?
    context: Attackers typically perform comprehensive server reconnaissance.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'net config'
            - 'net accounts'
            - 'net localgroup'
            - 'sc query'
        condition: selection
      fields:
        - CommandLine
        - Image
        - User

  - question: Has there been unauthorized access to server resources following this reconnaissance?
    context: Server enumeration often precedes lateral movement or data access.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - 'C:\Windows\System32\config'
            - 'C:\inetpub'
            - 'C:\Program Files'
        condition: selection
      fields:
        - TargetFilename
        - ProcessName
        - User

  - question: What network connections were established to the destination?
    context: Understanding connection patterns helps identify command and control activity.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_port
        - dst_port
        - proto
        - bytes_toserver
        - bytes_toclient

  - question: Are there indicators of credential harvesting on this server?
    context: Server compromise often involves credential theft for lateral movement.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'mimikatz'
            - 'procdump'
            - 'lsass'
            - 'sekurlsa'
        condition: selection
      fields:
        - CommandLine
        - Image
        - User

  - question: What registry modifications occurred around this activity?
    context: Attackers may modify registry for persistence or configuration changes.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - 'HKLM\SYSTEM\CurrentControlSet\Services'
            - 'HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessName

  - question: Are other servers in the environment showing similar compromise indicators?
    context: Server compromise often spreads through domain trust relationships.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: 'ET MALWARE Windows net statistics server Microsoft Windows DOS prompt command exit OUTBOUND'
        condition: selection
      fields:
        - src_ip
        - dst_ip

  - question: What is the data volume and frequency of transmissions to this destination?
    context: Understanding exfiltration patterns helps assess data loss scope.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - bytes_toserver
        - duration