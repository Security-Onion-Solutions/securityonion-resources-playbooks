name: ET MALWARE Windows driverquery -si Microsoft Windows DOS prompt command exit OUTBOUND
id: 22023212
description: |
  Detects Windows driverquery -si command output being transmitted outbound.
  May indicate detailed driver signature information collection for exploit development.
  Could be legitimate security auditing or system inventory processes.
type: detection
detection_id: 2023212
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete driver signature information being transmitted?
    context: Driver signature details reveal unsigned drivers vulnerable to exploitation.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - http.request.body.content
        - rule.name

  - question: What process initiated the detailed driver signature query?
    context: Understanding the source process helps determine legitimate vs malicious intent.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains: 'driverquery -si'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ParentImage
        - ParentCommandLine

  - question: Is this part of authorized security auditing or compliance checking?
    context: Security tools and compliance scanners may perform driver signature verification.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'driverquery'
            - 'sigverif'
            - 'audit'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine

  - question: What other security-focused enumeration occurred around this time?
    context: Attackers often gather comprehensive security information before exploitation.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'whoami /priv'
            - 'net localgroup administrators'
            - 'wmic qfe'
            - 'systeminfo'
        condition: selection
      fields:
        - CommandLine
        - Image
        - User

  - question: Are there attempts to exploit unsigned or vulnerable drivers?
    context: Driver signature information is often collected before driver-based exploits.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'exploit'
            - 'payload'
            - 'shellcode'
        condition: selection
      fields:
        - CommandLine
        - Image
        - User

  - question: What network communication patterns exist with the destination?
    context: Understanding data flow helps identify command and control relationships.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_port
        - dst_port
        - proto
        - bytes_toserver
        - bytes_toclient

  - question: Has there been kernel-level compromise following this reconnaissance?
    context: Driver vulnerabilities are commonly exploited for kernel-level access.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          User|contains: 'SYSTEM'
          CommandLine|contains:
            - 'cmd.exe'
            - 'powershell'
        condition: selection
      fields:
        - CommandLine
        - Image
        - User
        - ParentImage

  - question: Are there signs of driver file manipulation or replacement?
    context: Attackers may attempt to replace legitimate drivers with malicious versions.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - '.sys'
            - 'drivers'
            - 'system32\drivers'
        condition: selection
      fields:
        - TargetFilename
        - ProcessName
        - User

  - question: What registry modifications occurred related to driver loading?
    context: Driver exploitation often involves registry changes for persistence or loading.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - 'HKLM\SYSTEM\CurrentControlSet\Services'
            - 'HKLM\SYSTEM\CurrentControlSet\Control'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessName

  - question: Are other systems in the environment being similarly profiled?
    context: Systematic driver enumeration may indicate preparation for widespread exploitation.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: 'ET MALWARE Windows driverquery -si Microsoft Windows DOS prompt command exit OUTBOUND'
        condition: selection
      fields:
        - src_ip
        - dst_ip

  - question: What is the geolocation and reputation of the data destination?
    context: Driver signature data transmitted to suspicious locations indicates potential threat.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - dst_ip
        - geoip.country_name
        - threat.indicator.ip

  - question: Has there been subsequent deployment of rootkits or kernel-mode malware?
    context: Driver vulnerability assessment often precedes rootkit deployment.
    range: +6h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'rootkit'
            - 'bootkit'
            - 'kernel'
        condition: selection
      fields:
        - CommandLine
        - Image
        - User