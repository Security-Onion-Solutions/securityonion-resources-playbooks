name: ET MALWARE Windows qwinsta Microsoft Windows DOS prompt command exit OUTBOUND
id: 22023213
description: |
  Detects Windows qwinsta (query session) command output being transmitted outbound.
  May indicate reconnaissance of active user sessions and terminal server information.
  Could be legitimate remote desktop administration or session monitoring.
type: detection
detection_id: 2023213
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete session information being transmitted?
    context: Session data reveals active users, session types, and potential targets for lateral movement.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - http.request.body.content
        - rule.name

  - question: What process executed the qwinsta command?
    context: Understanding the source process helps determine if this is legitimate administration or malware.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains: 'qwinsta'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ParentImage
        - ParentCommandLine

  - question: Is this system normally used as a terminal server or for remote access?
    context: Legitimate terminal servers may have frequent session queries for administration.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'qwinsta'
            - 'rwinsta'
            - 'tscon'
            - 'tsdiscon'
        condition: selection
      fields:
        - User
        - Image

  - question: What other session manipulation or RDP-related activity occurred?
    context: Session enumeration often precedes session hijacking or unauthorized access attempts.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'rwinsta'
            - 'tscon'
            - 'tsdiscon'
            - 'logoff'
            - 'mstsc'
        condition: selection
      fields:
        - CommandLine
        - Image
        - User

  - question: Are there signs of unauthorized session access or hijacking?
    context: Session enumeration may be followed by attempts to connect to or hijack active sessions.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'tscon'
            - 'rwinsta'
            - 'net use'
        condition: selection
      fields:
        - CommandLine
        - Image
        - User

  - question: What network connections were established to the destination?
    context: Understanding communication patterns helps identify data exfiltration or C2 activity.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_port
        - dst_port
        - proto
        - bytes_toserver
        - duration

  - question: Has there been credential harvesting targeting the identified user sessions?
    context: Active session information helps attackers target credential theft efforts.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'mimikatz'
            - 'procdump'
            - 'lsass'
            - 'sekurlsa'
        condition: selection
      fields:
        - CommandLine
        - Image
        - User

  - question: Are there indicators of lateral movement to other systems?
    context: Session information helps attackers identify targets for lateral movement.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 3389
            - 22
            - 445
            - 135
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto

  - question: What registry modifications occurred related to terminal services?
    context: Attackers may modify terminal services configuration for persistence or access.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - 'Terminal Services'
            - 'TermService'
            - 'RDP'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessName

  - question: Are other systems showing similar session enumeration activity?
    context: Coordinated session reconnaissance may indicate preparation for widespread lateral movement.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: 'ET MALWARE Windows qwinsta Microsoft Windows DOS prompt command exit OUTBOUND'
        condition: selection
      fields:
        - src_ip
        - dst_ip

  - question: What is the reputation and geographic location of the destination?
    context: Session data transmitted to suspicious locations indicates potential threat activity.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - dst_ip
        - geoip.country_name
        - threat.indicator.ip

  - question: Has there been subsequent privilege escalation or persistence establishment?
    context: Session enumeration often precedes attempts to gain higher privileges or maintain access.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - 'Run'
            - 'RunOnce'
            - 'Services'
            - 'Winlogon'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessName