name: ET MALWARE Windows quser Microsoft Windows DOS prompt command exit OUTBOUND
id: 22023214
description: |
  Detects Windows quser command output being transmitted outbound, indicating potential data exfiltration.
  The quser command displays user session information and is commonly used by malware for reconnaissance.
  May trigger on legitimate remote administration tools or system monitoring software.
type: detection
detection_id: 2023214
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete quser command output being transmitted?
    context: Analyzing the full command output reveals what user session information was collected and exfiltrated.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - http.request.body.content
        - rule.name

  - question: What network protocol and destination was used for data transmission?
    context: Understanding the transmission method helps identify the communication channel and potential C2 infrastructure.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - protocol
        - bytes_toserver

  # Type 2: Triage Assessment
  - question: Is this system normally used for remote administration or monitoring?
    context: Legitimate system administration tools may transmit quser output for session management purposes.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 22
            - 3389
            - 5985
            - 5986
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - count

  - question: Does this activity align with scheduled maintenance or monitoring windows?
    context: Authorized remote access tools may collect user session data during maintenance periods.
    range: -1d
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'quser.exe'
            - 'query.exe'
        condition: selection
      fields:
        - User
        - CommandLine
        - ParentImage

  # Type 3: Activity Context
  - question: What process executed the quser command on the source system?
    context: Identifying the parent process helps determine if this was manual execution or automated malware behavior.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|endswith: 'quser.exe'
        condition: selection
      fields:
        - User
        - ParentImage
        - CommandLine
        - ProcessGuid

  - question: What other reconnaissance commands were executed around the same time?
    context: Malware often executes multiple reconnaissance commands in sequence to gather system information.
    range: +/-30m
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'whoami.exe'
            - 'net.exe'
            - 'ipconfig.exe'
            - 'systeminfo.exe'
            - 'tasklist.exe'
        condition: selection
      fields:
        - Image
        - CommandLine
        - count

  # Type 4: Impact Assessment
  - question: What sensitive user session information was potentially exposed?
    context: Understanding what session data was collected helps assess the privacy and security impact.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: 'quser'
        condition: selection
      fields:
        - payload
        - rule.name

  - question: Are there signs of credential harvesting or privilege escalation attempts?
    context: Attackers may use session information to identify high-privilege users for targeted attacks.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'mimikatz.exe'
            - 'procdump.exe'
            - 'lsass.exe'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  # Type 5: Forensic Deep-Dive
  - question: What malware family or tool is associated with this reconnaissance pattern?
    context: Specific reconnaissance command sequences can indicate known malware families or attack tools.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains: 'MALWARE'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - count

  - question: Is there evidence of data staging or preparation for exfiltration?
    context: Attackers may collect reconnaissance data into files before transmitting to avoid detection.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - '.txt'
            - '.log'
            - 'temp'
        condition: selection
      fields:
        - TargetFilename
        - ProcessImage
        - file.size

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network showing similar reconnaissance activity?
    context: Coordinated reconnaissance across multiple systems indicates a broader compromise or lateral movement.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'quser'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - count

  - question: Is this part of a broader data exfiltration campaign?
    context: Multiple systems transmitting reconnaissance data suggests organized data theft operations.
    range: +/-6h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          bytes_toserver|gte: 1000
        condition: selection
      fields:
        - src_ip
        - bytes_toserver
        - count