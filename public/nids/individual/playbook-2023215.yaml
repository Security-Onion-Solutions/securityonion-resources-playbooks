name: ET MALWARE Windows gpresult Microsoft Windows DOS prompt command exit OUTBOUND
id: 22023215
description: |
  Detects Windows gpresult command output being transmitted outbound, indicating potential policy reconnaissance.
  The gpresult command displays Group Policy information and is used by attackers to understand security controls.
  May trigger on legitimate system administration or compliance auditing tools.
type: detection
detection_id: 2023215
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What specific Group Policy information was captured in the gpresult output?
    context: Analyzing the policy data reveals what security controls and configurations were exposed to attackers.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - http.request.body.content
        - rule.name

  - question: What was the complete gpresult command syntax and parameters used?
    context: Different gpresult parameters reveal varying levels of detail, indicating attacker sophistication and intent.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|endswith: 'gpresult.exe'
        condition: selection
      fields:
        - CommandLine
        - User
        - ParentImage
        - ProcessGuid

  # Type 2: Triage Assessment
  - question: Is this system subject to regular Group Policy auditing or compliance checks?
    context: Legitimate compliance tools and security scanners may collect Group Policy information for assessment.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'gpresult.exe'
            - 'rsop.exe'
        condition: selection
      fields:
        - User
        - ParentImage
        - count

  - question: Does this activity correlate with authorized security assessment or penetration testing?
    context: Security teams may collect Group Policy data during authorized assessments to evaluate security posture.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 443
            - 8080
            - 8443
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver

  # Type 3: Activity Context
  - question: What process or user context executed the gpresult command?
    context: Understanding execution context helps determine if this was manual reconnaissance or automated tool behavior.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|endswith: 'gpresult.exe'
        condition: selection
      fields:
        - User
        - ParentImage
        - CommandLine
        - IntegrityLevel

  - question: What other policy or configuration reconnaissance occurred around the same time?
    context: Attackers often collect multiple types of configuration data to understand the security environment.
    range: +/-30m
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'reg.exe'
            - 'wmic.exe'
            - 'net.exe'
            - 'sc.exe'
        condition: selection
      fields:
        - Image
        - CommandLine
        - count

  - question: Was this reconnaissance followed by attempts to modify or bypass policies?
    context: Attackers may gather policy information to identify weaknesses or plan privilege escalation attacks.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'gpedit.exe'
            - 'secpol.exe'
            - 'secedit.exe'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  # Type 4: Impact Assessment
  - question: What sensitive security policy information was potentially exposed?
    context: Group Policy data can reveal security controls, password policies, and administrative configurations.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: 'gpresult'
        condition: selection
      fields:
        - payload
        - rule.name
        - severity

  - question: Are there signs of privilege escalation or security control bypass attempts?
    context: Knowledge of Group Policy settings can enable attackers to circumvent security controls or escalate privileges.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - 'POLICY_VIOLATION'
            - 'EXPLOIT'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - count

  # Type 5: Forensic Deep-Dive
  - question: What attack tools or malware families commonly use gpresult for reconnaissance?
    context: Specific reconnaissance patterns can indicate known threat actors or attack frameworks.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains: 'MALWARE'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - count

  - question: Is there evidence of automated reconnaissance or scripted information gathering?
    context: Rapid execution of multiple reconnaissance commands suggests automated tools or scripts.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          ParentImage|contains:
            - 'cmd.exe'
            - 'powershell.exe'
            - 'wscript.exe'
            - 'cscript.exe'
        condition: selection
      fields:
        - ParentImage
        - Image
        - count

  # Type 6: Enterprise Correlation
  - question: Are other systems showing similar Group Policy reconnaissance activity?
    context: Coordinated policy reconnaissance across multiple systems indicates systematic network mapping.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'gpresult'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - count

  - question: Is this part of a broader Active Directory reconnaissance campaign?
    context: Group Policy information is often collected as part of comprehensive Active Directory enumeration attacks.
    range: +/-6h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          Image|contains:
            - 'nltest.exe'
            - 'dsquery.exe'
            - 'ldifde.exe'
            - 'csvde.exe'
        condition: selection
      fields:
        - src_ip
        - Image
        - CommandLine
        - count