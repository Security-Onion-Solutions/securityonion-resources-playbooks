name: ET MALWARE Windows netsh advfirewall show allprofiles Microsoft Windows DOS prompt command exit OUTBOUND
id: 22023216
description: |
  Detects Windows netsh firewall profile enumeration commands being transmitted outbound.
  This activity is commonly associated with malware performing reconnaissance of firewall settings.
  May trigger on legitimate system administration or security tools performing firewall audits.
type: detection
detection_id: 2023216
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete netsh firewall command output being transmitted?
    context: Understanding the exact firewall profile information reveals what reconnaissance data was exfiltrated.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - alert.signature
        - flow.bytes_toserver

  - question: What specific firewall profile settings were enumerated?
    context: Identifying which profile settings were gathered helps understand the attacker's targeting strategy.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - alert.metadata

  # Type 2: Triage Assessment
  - question: Is this system regularly managed by administrators who would run firewall commands?
    context: Legitimate system administration may involve firewall configuration checks that could trigger this alert.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'netsh.exe'
            - 'cmd.exe'
            - 'powershell.exe'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine

  - question: Are there authorized security tools that perform firewall auditing on this system?
    context: Security scanning tools may legitimately enumerate firewall settings as part of compliance checks.
    range: -1d
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'firewall'
            - 'advfirewall'
            - 'netsh'
        condition: selection
      fields:
        - User
        - Image
        - ParentImage

  # Type 3: Activity Context
  - question: What process initiated the netsh firewall enumeration command?
    context: Understanding the parent process helps determine if this is malware reconnaissance or legitimate administration.
    range: -5m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains: 'netsh'
        condition: selection
      fields:
        - User
        - Image
        - ParentImage
        - CommandLine
        - ProcessGuid

  - question: What other reconnaissance commands were executed around the same time?
    context: Multiple reconnaissance commands indicate systematic information gathering typical of malware behavior.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'whoami'
            - 'systeminfo'
            - 'tasklist'
            - 'ipconfig'
            - 'net user'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  # Type 4: Impact Assessment
  - question: Has the firewall configuration been modified following this reconnaissance?
    context: Attackers often disable or modify firewall settings after enumerating current configurations.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'netsh advfirewall set'
            - 'netsh firewall set'
            - 'advfirewall off'
        condition: selection
      fields:
        - CommandLine
        - User
        - Image

  - question: Are there signs of data exfiltration following the firewall enumeration?
    context: Understanding network topology through firewall settings often precedes data theft operations.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          bytes_toclient|gt: 1000000
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toclient
        - proto

  # Type 5: Forensic Deep-Dive
  - question: What malware family typically exhibits this firewall reconnaissance behavior?
    context: Specific command patterns can help identify the malware family and predict next attack phases.
    range: +/-1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.category: 'A Network Trojan was detected'
        condition: selection
      fields:
        - alert.signature
        - dst_ip
        - dst_port

  - question: Are there persistence mechanisms established on this compromised system?
    context: Malware performing reconnaissance typically establishes persistence for continued access.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - 'Run'
            - 'RunOnce'
            - 'Services'
            - 'Winlogon'
        condition: selection
      fields:
        - TargetObject
        - Details
        - Image

  # Type 6: Enterprise Correlation
  - question: Are other systems showing similar firewall reconnaissance activity?
    context: Coordinated firewall enumeration across multiple systems indicates lateral movement or widespread compromise.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: 'netsh advfirewall'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature

  - question: Is this part of a broader malware campaign targeting the organization?
    context: Understanding campaign scope helps prioritize incident response and defensive measures.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.category: 'A Network Trojan was detected'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - alert.signature
        - alert.severity