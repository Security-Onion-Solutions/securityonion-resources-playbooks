name: ET MALWARE Windows WMIC OS get Microsoft Windows DOS prompt command exit OUTBOUND
id: 22023217
description: |
  Detects Windows WMIC OS information being transmitted outbound, indicating system reconnaissance data exfiltration.
  The WMIC OS command reveals detailed operating system information used by attackers for targeting and exploitation.
  May trigger on legitimate system inventory tools or remote management software.
type: detection
detection_id: 2023217
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What specific operating system details were captured in the WMIC output?
    context: Analyzing OS information reveals what system details were exposed, including version, build, and configuration data.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - http.request.body.content
        - rule.name

  - question: What was the complete WMIC command syntax and parameters used?
    context: Different WMIC parameters and output formats indicate the level of system information being collected.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|endswith: 'wmic.exe'
          CommandLine|contains: 'os'
        condition: selection
      fields:
        - CommandLine
        - User
        - ParentImage
        - ProcessGuid

  # Type 2: Triage Assessment
  - question: Is this system part of an automated inventory or asset management system?
    context: Legitimate IT management tools regularly collect OS information for inventory and patch management purposes.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|endswith: 'wmic.exe'
        condition: selection
      fields:
        - User
        - ParentImage
        - count

  - question: Does this activity align with scheduled system monitoring or compliance scanning?
    context: Security and compliance tools may collect OS information during regular assessment cycles.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 135
            - 445
            - 5985
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver

  # Type 3: Activity Context
  - question: What process initiated the WMIC OS reconnaissance command?
    context: Understanding the parent process helps determine if this was manual execution or part of automated malware behavior.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|endswith: 'wmic.exe'
          CommandLine|contains: 'os'
        condition: selection
      fields:
        - User
        - ParentImage
        - CommandLine
        - IntegrityLevel

  - question: What other WMIC reconnaissance commands were executed in sequence?
    context: Attackers often use multiple WMIC queries to gather comprehensive system information for targeting.
    range: +/-30m
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|endswith: 'wmic.exe'
          CommandLine|contains:
            - 'process'
            - 'service'
            - 'startup'
            - 'useraccount'
        condition: selection
      fields:
        - CommandLine
        - count

  - question: Was this reconnaissance followed by exploitation attempts targeting the identified OS?
    context: OS version information is often used to select appropriate exploits or attack techniques.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains: 'EXPLOIT'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - count

  # Type 4: Impact Assessment
  - question: What sensitive system configuration information was potentially exposed?
    context: OS details can reveal patch levels, service packs, and system vulnerabilities to attackers.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: 'WMIC OS'
        condition: selection
      fields:
        - payload
        - rule.name
        - severity

  - question: Are there signs of targeted exploitation based on the discovered OS information?
    context: Attackers may use OS version data to deploy specific exploits or payloads tailored to the target system.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'CVE'
            - 'EXPLOIT'
            - 'VULNERABILITY'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - count

  # Type 5: Forensic Deep-Dive
  - question: What malware families or attack frameworks commonly use WMIC for OS reconnaissance?
    context: Specific WMIC usage patterns can indicate known threat actors or automated attack tools.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains: 'MALWARE'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - count

  - question: Is there evidence of living-off-the-land techniques using legitimate Windows tools?
    context: WMIC is a legitimate Windows tool often abused by attackers to avoid detection while gathering intelligence.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'wmic.exe'
            - 'powershell.exe'
            - 'cmd.exe'
            - 'net.exe'
        condition: selection
      fields:
        - Image
        - CommandLine
        - count

  # Type 6: Enterprise Correlation
  - question: Are other systems showing similar WMIC OS reconnaissance activity?
    context: Coordinated OS reconnaissance across multiple systems indicates systematic network enumeration.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'WMIC OS'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - count

  - question: Is this part of a broader system profiling or vulnerability assessment campaign?
    context: OS information collection is often the first step in comprehensive network reconnaissance and targeting.
    range: +/-6h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          Image|contains:
            - 'systeminfo.exe'
            - 'whoami.exe'
            - 'hostname.exe'
            - 'ver.exe'
        condition: selection
      fields:
        - src_ip
        - Image
        - CommandLine
        - count