name: ET MALWARE Windows WMIC NETLOGIN get Microsoft Windows DOS prompt command exit OUTBOUND
id: 22023219
description: |
  Detects Windows WMIC NETLOGIN information being transmitted outbound, indicating network authentication reconnaissance.
  The WMIC NETLOGIN command reveals user account and authentication details used by attackers for credential analysis.
  May trigger on legitimate system administration tools or security auditing software.
type: detection
detection_id: 2023219
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What specific network login and authentication details were captured?
    context: Analyzing NETLOGIN output reveals what user account and authentication information was exposed to attackers.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - http.request.body.content
        - rule.name

  - question: What was the complete WMIC NETLOGIN command syntax and output format?
    context: Different WMIC parameters reveal varying levels of authentication detail, indicating attacker sophistication.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|endswith: 'wmic.exe'
          CommandLine|contains: 'netlogin'
        condition: selection
      fields:
        - CommandLine
        - User
        - ParentImage
        - ProcessGuid

  # Type 2: Triage Assessment
  - question: Is this system subject to regular authentication auditing or compliance monitoring?
    context: Legitimate security tools may collect network login information for compliance and security assessment purposes.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|endswith: 'wmic.exe'
          CommandLine|contains:
            - 'netlogin'
            - 'useraccount'
            - 'logon'
        condition: selection
      fields:
        - User
        - ParentImage
        - count

  - question: Does this activity correlate with authorized security assessment or penetration testing?
    context: Security teams may collect authentication data during authorized assessments to evaluate account security.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 389
            - 636
            - 3268
            - 3269
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver

  # Type 3: Activity Context
  - question: What process or user context executed the WMIC NETLOGIN reconnaissance?
    context: Understanding execution context helps determine if this was manual reconnaissance or automated credential harvesting.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|endswith: 'wmic.exe'
          CommandLine|contains: 'netlogin'
        condition: selection
      fields:
        - User
        - ParentImage
        - CommandLine
        - IntegrityLevel

  - question: What other credential or authentication reconnaissance occurred around the same time?
    context: Attackers often collect multiple types of authentication data to build comprehensive credential intelligence.
    range: +/-30m
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'net.exe'
            - 'whoami.exe'
            - 'nltest.exe'
          CommandLine|contains:
            - 'user'
            - 'group'
            - 'domain'
        condition: selection
      fields:
        - Image
        - CommandLine
        - count

  - question: Was this reconnaissance followed by credential harvesting or authentication attacks?
    context: Network login information is often used to identify targets for credential theft or brute force attacks.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - 'CREDENTIAL'
            - 'BRUTE_FORCE'
            - 'AUTH'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - count

  # Type 4: Impact Assessment
  - question: What sensitive authentication and user account information was potentially exposed?
    context: NETLOGIN data can reveal password policies, account flags, and authentication patterns valuable to attackers.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: 'NETLOGIN'
        condition: selection
      fields:
        - payload
        - rule.name
        - severity

  - question: Are there signs of credential stuffing or password spray attacks following this reconnaissance?
    context: Knowledge of user accounts and authentication details enables targeted credential attacks.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'BRUTE'
            - 'LOGIN'
            - 'AUTH_FAIL'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - count

  # Type 5: Forensic Deep-Dive
  - question: What attack tools or credential harvesting frameworks use WMIC NETLOGIN reconnaissance?
    context: Specific WMIC usage patterns can indicate known credential harvesting tools or attack frameworks.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains: 'MALWARE'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - count

  - question: Is there evidence of automated credential intelligence gathering or scripted enumeration?
    context: Rapid execution of authentication-related commands suggests automated credential harvesting tools.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          ParentImage|contains:
            - 'cmd.exe'
            - 'powershell.exe'
            - 'wscript.exe'
        condition: selection
      fields:
        - ParentImage
        - Image
        - CommandLine
        - count

  # Type 6: Enterprise Correlation
  - question: Are other systems showing similar network authentication reconnaissance activity?
    context: Coordinated authentication reconnaissance across multiple systems indicates systematic credential intelligence gathering.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'NETLOGIN'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - count

  - question: Is this part of a broader Active Directory enumeration or credential harvesting campaign?
    context: NETLOGIN reconnaissance is often part of comprehensive AD enumeration to map authentication infrastructure.
    range: +/-6h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          Image|contains:
            - 'dsquery.exe'
            - 'ldifde.exe'
            - 'csvde.exe'
            - 'net.exe'
          CommandLine|contains:
            - 'domain'
            - 'user'
            - 'group'
        condition: selection
      fields:
        - src_ip
        - Image
        - CommandLine
        - count