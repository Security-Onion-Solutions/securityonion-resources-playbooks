name: ET MALWARE Windows WMIC NIC get Microsoft Windows DOS prompt command exit OUTBOUND
id: 22023220
description: |
  Detects Windows WMIC NIC information being transmitted outbound, indicating network interface reconnaissance.
  The WMIC NIC command reveals network adapter details used by attackers for network mapping and lateral movement planning.
  May trigger on legitimate network management tools or system inventory software.
type: detection
detection_id: 2023220
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What specific network interface and adapter details were captured?
    context: Analyzing NIC output reveals what network configuration and hardware information was exposed to attackers.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - http.request.body.content
        - rule.name

  - question: What was the complete WMIC NIC command syntax and output parameters?
    context: Different WMIC parameters reveal varying levels of network detail, indicating reconnaissance scope and intent.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|endswith: 'wmic.exe'
          CommandLine|contains: 'nic'
        condition: selection
      fields:
        - CommandLine
        - User
        - ParentImage
        - ProcessGuid

  # Type 2: Triage Assessment
  - question: Is this system part of automated network inventory or asset management processes?
    context: Legitimate IT management tools regularly collect NIC information for network mapping and configuration management.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|endswith: 'wmic.exe'
          CommandLine|contains:
            - 'nic'
            - 'networkadapter'
        condition: selection
      fields:
        - User
        - ParentImage
        - count

  - question: Does this activity align with scheduled network monitoring or troubleshooting?
    context: Network administrators may collect NIC information during maintenance windows or network issue resolution.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 161
            - 162
            - 22
            - 23
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver

  # Type 3: Activity Context
  - question: What process initiated the WMIC NIC reconnaissance command?
    context: Understanding the parent process helps determine if this was manual network mapping or automated malware behavior.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|endswith: 'wmic.exe'
          CommandLine|contains: 'nic'
        condition: selection
      fields:
        - User
        - ParentImage
        - CommandLine
        - IntegrityLevel

  - question: What other network reconnaissance commands were executed in sequence?
    context: Attackers often use multiple network enumeration commands to build comprehensive network topology maps.
    range: +/-30m
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'ipconfig.exe'
            - 'netstat.exe'
            - 'arp.exe'
            - 'route.exe'
            - 'ping.exe'
        condition: selection
      fields:
        - Image
        - CommandLine
        - count

  - question: Was this network reconnaissance followed by lateral movement or network scanning attempts?
    context: Network interface information is often used to plan lateral movement and identify network segments for exploitation.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - 'SCAN'
            - 'LATERAL'
            - 'RECON'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - dst_ip
        - count

  # Type 4: Impact Assessment
  - question: What sensitive network configuration and topology information was potentially exposed?
    context: NIC details can reveal network segments, VLANs, and connectivity that enables lateral movement planning.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: 'NIC'
        condition: selection
      fields:
        - payload
        - rule.name
        - severity

  - question: Are there signs of network segmentation bypass or VLAN hopping attempts?
    context: Knowledge of network interfaces can enable attackers to identify and exploit network segmentation weaknesses.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'VLAN'
            - 'NETWORK'
            - 'SEGMENT'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - count

  # Type 5: Forensic Deep-Dive
  - question: What attack tools or frameworks commonly use WMIC NIC for network reconnaissance?
    context: Specific WMIC usage patterns can indicate known lateral movement tools or network mapping frameworks.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains: 'MALWARE'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - count

  - question: Is there evidence of automated network mapping or scripted infrastructure enumeration?
    context: Rapid execution of network-related commands suggests automated network discovery and mapping tools.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          ParentImage|contains:
            - 'cmd.exe'
            - 'powershell.exe'
            - 'wscript.exe'
        condition: selection
      fields:
        - ParentImage
        - Image
        - CommandLine
        - count

  # Type 6: Enterprise Correlation
  - question: Are other systems showing similar network interface reconnaissance activity?
    context: Coordinated NIC reconnaissance across multiple systems indicates systematic network topology mapping.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'NIC'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - count

  - question: Is this part of a broader network infrastructure mapping or lateral movement campaign?
    context: NIC information collection is often part of comprehensive network reconnaissance for lateral movement planning.
    range: +/-6h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          Image|contains:
            - 'nmap.exe'
            - 'masscan.exe'
            - 'netstat.exe'
            - 'arp.exe'
          CommandLine|contains:
            - 'scan'
            - 'discovery'
            - 'enum'
        condition: selection
      fields:
        - src_ip
        - Image
        - CommandLine
        - count