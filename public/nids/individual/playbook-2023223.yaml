name: ET MALWARE Windows WMIC SERVICE get Microsoft Windows DOS prompt command exit OUTBOUND
id: 22023223
description: |
  Detects Windows WMIC service enumeration command output being transmitted outbound.
  This activity is commonly associated with malware performing service reconnaissance.
  May trigger on legitimate system administration or security tools performing service audits.
type: detection
detection_id: 2023223
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete WMIC service enumeration output being transmitted?
    context: Understanding the exact service information reveals what reconnaissance data was exfiltrated.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - alert.signature
        - flow.bytes_toserver

  - question: Which specific Windows services were enumerated in the output?
    context: Identifying targeted services helps understand the attacker's focus and potential next steps.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - alert.metadata

  # Type 2: Triage Assessment
  - question: Is this system regularly managed by administrators who would enumerate services?
    context: Legitimate system administration may involve service enumeration that could trigger this alert.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'wmic.exe'
            - 'sc.exe'
            - 'services.msc'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine

  - question: Are there authorized security tools that perform service auditing on this system?
    context: Security scanning tools may legitimately enumerate services as part of compliance or vulnerability assessments.
    range: -1d
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'service'
            - 'wmic'
            - 'get-service'
        condition: selection
      fields:
        - User
        - Image
        - ParentImage

  # Type 3: Activity Context
  - question: What process initiated the WMIC service enumeration command?
    context: Understanding the parent process helps determine if this is malware reconnaissance or legitimate administration.
    range: -5m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'wmic service'
            - 'wmic.exe'
        condition: selection
      fields:
        - User
        - Image
        - ParentImage
        - CommandLine
        - ProcessGuid

  - question: What other system reconnaissance commands were executed around the same time?
    context: Multiple reconnaissance commands indicate systematic information gathering typical of malware behavior.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'whoami'
            - 'systeminfo'
            - 'tasklist'
            - 'net user'
            - 'qwinsta'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  # Type 4: Impact Assessment
  - question: Have any services been modified or stopped following this reconnaissance?
    context: Attackers often disable security services after enumerating current service configurations.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'sc stop'
            - 'sc config'
            - 'net stop'
            - 'wmic service'
        condition: selection
      fields:
        - CommandLine
        - User
        - Image

  - question: Are there signs of lateral movement tools being deployed after service enumeration?
    context: Service reconnaissance often precedes deployment of remote access tools or lateral movement utilities.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 445
            - 135
            - 3389
            - 5985
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver
        - proto

  # Type 5: Forensic Deep-Dive
  - question: What malware family typically exhibits this service reconnaissance pattern?
    context: Specific WMIC command patterns can help identify the malware family and predict attack progression.
    range: +/-1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.category: 'A Network Trojan was detected'
        condition: selection
      fields:
        - alert.signature
        - dst_ip
        - dst_port

  - question: Are there indicators of credential harvesting following service enumeration?
    context: Service information is often used to identify targets for credential extraction or privilege escalation.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'mimikatz'
            - 'sekurlsa'
            - 'lsass'
            - 'procdump'
        condition: selection
      fields:
        - CommandLine
        - Image
        - User

  - question: What persistence mechanisms were established on this compromised system?
    context: Malware performing service reconnaissance typically establishes persistence through service manipulation.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - 'Services'
            - 'Run'
            - 'RunOnce'
        condition: selection
      fields:
        - TargetObject
        - Details
        - Image

  # Type 6: Enterprise Correlation
  - question: Are other systems showing similar service reconnaissance activity?
    context: Coordinated service enumeration across multiple systems indicates lateral movement or widespread compromise.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: 'WMIC SERVICE'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature

  - question: Is this part of a broader reconnaissance campaign targeting the organization?
    context: Understanding campaign scope helps prioritize incident response and identify attack patterns.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.category: 'A Network Trojan was detected'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - alert.signature
        - alert.severity