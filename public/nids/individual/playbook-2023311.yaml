name: ET EXPLOIT Possible Cisco IKEv1 Information Disclosure Vulnerability CVE-2016-6415
id: 22023311
description: |
  Detects exploitation attempts targeting Cisco IKEv1 vulnerability CVE-2016-6415.
  This vulnerability allows remote attackers to obtain memory contents via crafted UDP packets.
  May trigger on legitimate IKE negotiations with specific packet structures.
type: detection
detection_id: 2023311
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact IKE packet structure and payload size that triggered this alert?
    context: Understanding the packet format reveals exploitation attempt characteristics and target vulnerability.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - src_ip
        - dst_ip
        - src_port
        - dst_port
        - payload_printable

  - question: What is the exact byte sequence and offset patterns in the UDP payload?
    context: CVE-2016-6415 exploitation requires specific byte patterns at defined offsets to trigger memory disclosure.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
          proto: UDP
          dst_port: 500
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_bytes
        - dst_bytes

  # Type 2: Triage Assessment
  - question: Is this normal IKE VPN negotiation traffic for this network segment?
    context: Legitimate IPSec VPN establishment uses port 500 and may contain similar packet structures.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 500
          proto: UDP
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_bytes
        - dst_bytes

  - question: Are there established VPN tunnels or IPSec policies configured for this destination?
    context: Authorized VPN infrastructure would show consistent IKE traffic patterns and established connections.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 500
            - 4500
        condition: selection
      fields:
        - src_ip
        - proto
        - dst_port
        - connection_state

  # Type 3: Activity Context
  - question: What network reconnaissance preceded this IKE exploitation attempt?
    context: Attackers typically scan for IKE services before attempting CVE-2016-6415 exploitation.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 500
            - 4500
            - 1701
            - 1723
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto
        - connection_state

  - question: What other Cisco network devices has this source IP targeted?
    context: CVE-2016-6415 affects multiple Cisco products; attackers may target entire infrastructure.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 22
            - 23
            - 80
            - 443
            - 500
            - 161
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto
        - src_bytes
        - dst_bytes

  # Type 4: Impact Assessment
  - question: Did the target device respond with oversized packets indicating memory disclosure?
    context: Successful CVE-2016-6415 exploitation results in memory contents being returned in response packets.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
          src_port: 500
          proto: UDP
        condition: selection
      fields:
        - src_bytes
        - dst_bytes
        - connection_state

  - question: Are there signs of successful information disclosure or follow-up exploitation?
    context: Memory disclosure may reveal sensitive configuration data enabling further attacks.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_port
        - dst_port
        - proto
        - src_bytes
        - dst_bytes

  # Type 5: Forensic Deep-Dive
  - question: What specific Cisco device model and IOS version is the target running?
    context: CVE-2016-6415 affects specific Cisco PIX, ASA, and IOS versions with different exploitation requirements.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 22
            - 23
            - 80
            - 443
        condition: selection
      fields:
        - src_ip
        - dst_port
        - proto
        - src_bytes
        - dst_bytes

  - question: What memory contents or configuration data may have been disclosed?
    context: Successful exploitation can reveal IPSec pre-shared keys, certificates, and network topology.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_bytes
        - dst_bytes
        - proto

  # Type 6: Enterprise Correlation
  - question: Are other Cisco devices in the network experiencing similar IKE exploitation attempts?
    context: Attackers often target multiple devices once CVE-2016-6415 vulnerability is identified in the environment.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "CVE-2016-6415"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name