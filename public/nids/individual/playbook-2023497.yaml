name: ET DOS Microsoft Windows LSASS Remote Memory Corruption (CVE-2017-0004)
id: 22023497
description: |
  Detects exploitation attempts targeting CVE-2017-0004, a remote memory corruption vulnerability in Windows LSASS.
  Triggers on specific SMB packet patterns that attempt to exploit NTLM authentication handling.
  Legitimate SMB authentication would not contain these specific exploit patterns.
type: detection
detection_id: 2023497
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete SMB packet structure that triggered this CVE-2017-0004 detection?
    context: The specific SMB packet format reveals the exploitation technique and potential payload delivery method.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - rule.name
        - alert.signature

  - question: What are the SMB connection details for this exploitation attempt?
    context: SMB connection metadata helps identify the attack vector and potential authenticated access.
    range: -5m/+5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_port
        - proto
        - bytes_toserver
        - bytes_toclient
        - duration

  # Type 2: Triage Assessment
  - question: Is the source IP authorized for SMB access to this system?
    context: Legitimate SMB access may be expected from domain controllers, file servers, or administrative systems.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - connection_state
        - count
        - first_seen
        - last_seen

  - question: Does this SMB activity align with normal administrative patterns?
    context: Legitimate SMB administration typically occurs during business hours with consistent source systems.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - src_ip
        - hour_of_day
        - count

  # Type 3: Activity Context
  - question: What other network scanning or exploitation attempts preceded this attack?
    context: CVE-2017-0004 exploitation often follows network reconnaissance and vulnerability scanning.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto
        - connection_state
        - bytes_toserver

  - question: Were there any authentication events around this exploitation attempt?
    context: SMB exploitation may trigger authentication failures or unusual authentication patterns.
    range: -15m/+15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains: 'lsass.exe'
        condition: selection
      fields:
        - CommandLine
        - User
        - ProcessGuid
        - ParentImage

  - question: What DNS queries were made by the attacking system?
    context: DNS resolution patterns may reveal the attacker's infrastructure and targeting methodology.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  # Type 4: Impact Assessment
  - question: Did the CVE-2017-0004 exploitation attempt cause system instability?
    context: Successful exploitation may cause LSASS crashes or system instability requiring immediate response.
    range: -15m/+30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: Are there signs of successful exploitation or follow-up activity?
    context: Successful exploitation may lead to credential theft, lateral movement, or additional payload delivery.
    range: -15m/+1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - proto
        - bytes_toserver
        - bytes_toclient
        - connection_state

  # Type 5: Forensic Deep-Dive
  - question: Are there memory dumps or crash artifacts from the target system?
    context: LSASS crashes or memory corruption may leave forensic artifacts indicating exploitation success.
    range: -30m/+2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetFilename|contains:
            - 'lsass'
            - 'memory.dmp'
            - 'crash'
        condition: selection
      fields:
        - TargetFilename
        - file.size
        - file.hash.md5

  - question: What registry modifications occurred during the exploitation timeframe?
    context: Successful exploitation may result in registry changes for persistence or system configuration modifications.
    range: -30m/+2h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetObject
        - Details
        - EventType

  # Type 6: Enterprise Correlation
  - question: Are other systems being targeted with similar CVE-2017-0004 exploitation attempts?
    context: Identifying campaign scope helps prioritize patching and incident response across the organization.
    range: -24h/+24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'CVE-2017-0004'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - count