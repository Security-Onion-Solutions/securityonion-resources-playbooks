name: ET MALWARE KeyBoy CnC Beacon
id: 22023527
description: |
  Detects KeyBoy malware command and control beacon traffic based on distinctive byte patterns.
  KeyBoy is sophisticated malware used in targeted attacks, often against government and political organizations.
  May rarely trigger on applications using similar binary protocols.
type: detection
detection_id: 2023527
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What is the exact byte sequence and protocol structure of this KeyBoy beacon?
    context: The distinctive 8-byte pattern identifies KeyBoy C2 communication and reveals protocol characteristics.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - src_ip
        - dst_ip
        - src_port
        - dst_port
        - payload_printable

  - question: What is the timing pattern and frequency of these C2 beacon transmissions?
    context: KeyBoy beacon intervals reveal malware configuration and operational security measures.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
          proto: TCP
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_port
        - dst_port
        - src_bytes
        - dst_bytes

  # Type 2: Triage Assessment
  - question: Is this legitimate application traffic that mimics KeyBoy beacon patterns?
    context: Some custom applications or protocols may coincidentally match the KeyBoy signature bytes.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          proto: TCP
        condition: selection
      fields:
        - src_port
        - dst_port
        - connection_state
        - src_bytes
        - dst_bytes

  - question: Does this infected system show signs of authorized remote management software?
    context: Legitimate remote access tools might be misidentified, requiring validation of authorized software inventory.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  # Type 3: Activity Context
  - question: What initial infection vector or compromise method preceded this KeyBoy deployment?
    context: KeyBoy is typically delivered through spear-phishing or watering hole attacks requiring investigation of entry point.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.response.status_code
        - user_agent.original

  - question: What suspicious process execution or file creation occurred before C2 communications began?
    context: Understanding the malware installation process helps identify attack timeline and persistence mechanisms.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  # Type 4: Impact Assessment
  - question: What data exfiltration or command execution has occurred through this C2 channel?
    context: KeyBoy is designed for data theft and system control, requiring assessment of compromised information.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          proto: TCP
        condition: selection
      fields:
        - src_port
        - dst_port
        - src_bytes
        - dst_bytes
        - connection_state

  - question: Are there signs of lateral movement or credential harvesting from this compromised system?
    context: KeyBoy often includes modules for network reconnaissance and credential theft enabling further compromise.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 22
            - 135
            - 139
            - 445
            - 3389
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto
        - connection_state

  # Type 5: Forensic Deep-Dive
  - question: What specific KeyBoy variant and configuration is deployed on this system?
    context: Different KeyBoy versions have distinct capabilities and IOCs requiring specific response procedures.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.hash.sha256
        - ProcessName

  - question: What persistence mechanisms has KeyBoy established on the compromised system?
    context: KeyBoy uses various persistence methods including registry modifications and scheduled tasks.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessName
        - User

  - question: What sensitive data or credentials has KeyBoy accessed or stolen?
    context: KeyBoy targets government and political data requiring assessment of compromised sensitive information.
    range: +6h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - ProcessName
        - User

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network infected with KeyBoy or related malware families?
    context: KeyBoy campaigns often target multiple systems requiring comprehensive threat hunting across the environment.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "KeyBoy"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is this part of a broader APT campaign targeting the organization or sector?
    context: KeyBoy is associated with advanced persistent threat groups requiring threat intelligence correlation and strategic response.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.category|contains:
            - "command-and-control"
            - "malware"
          mitre_tactic_name|contains: "Exfiltration"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - mitre_technique_name