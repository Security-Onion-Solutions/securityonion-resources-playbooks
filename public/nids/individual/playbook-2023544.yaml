name: ET MALWARE Win32/VB.SDB CnC Beacon
id: 22023544
description: |
  Detects Win32/VB.SDB malware command and control beacon traffic containing specific authentication patterns.
  This signature identifies malicious communication used to exfiltrate data over C2 channels.
  May rarely trigger on legitimate applications using similar authentication patterns.
type: detection
detection_id: 2023544
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete beacon payload and authentication sequence detected?
    context: Understanding the exact C2 beacon structure reveals malware variant and communication protocol.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - flow.bytes_toserver
        - flow.bytes_toclient

  - question: What TCP connection details were observed for this C2 communication?
    context: Connection metadata helps identify the malware's network footprint and C2 infrastructure.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - proto
        - conn_state

  # Type 2: Triage Assessment
  - question: Is this communication from a known administrative or development system?
    context: Legitimate systems may occasionally generate similar patterns during software testing or development.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port

  - question: Does this activity align with normal business hours for this host?
    context: Malware C2 beacons often occur outside business hours or at regular intervals.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port

  # Type 3: Activity Context
  - question: What process initiated this network connection on the source host?
    context: Identifying the parent process helps determine if the malware executed through exploitation or user action.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ParentImage

  - question: What other network connections occurred from this host around the same time?
    context: Malware often establishes multiple connections for different C2 functions or data exfiltration.
    range: +/-30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto
        - conn_state

  # Type 4: Impact Assessment
  - question: How much data was transmitted in this C2 session?
    context: Large data volumes may indicate successful data exfiltration rather than just beacon traffic.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - orig_bytes
        - resp_bytes
        - duration

  - question: Are there signs of data staging or collection on the infected host?
    context: Malware often collects sensitive files before exfiltration over C2 channels.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessImage

  # Type 5: Forensic Deep-Dive
  - question: What specific Win32/VB.SDB malware variant characteristics are present?
    context: Different variants have unique C2 patterns that help identify the specific threat and its capabilities.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains:
            - 'VB.SDB'
            - 'Win32'
        condition: selection
      fields:
        - alert.signature
        - alert.category
        - dst_ip

  - question: Are there any persistence mechanisms established by this malware?
    context: Understanding persistence helps determine cleanup requirements and reinfection risk.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - 'Run'
            - 'RunOnce'
            - 'Services'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessImage

  # Type 6: Enterprise Correlation
  - question: Are other hosts in the network showing similar Win32/VB.SDB C2 activity?
    context: This malware may be part of a broader campaign affecting multiple systems.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: 'Win32/VB.SDB'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature

  - question: What other indicators of this threat campaign appear across the enterprise?
    context: Correlating related IOCs helps understand the full scope of the compromise.
    range: +/-7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - proto