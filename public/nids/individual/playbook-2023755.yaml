name: ET EXPLOIT Possible Microsoft RDP Client for Mac RCE
id: 22023755
description: |
  Detects potential exploitation of CVE-2017-0016 in Microsoft RDP Client for Mac.
  This vulnerability allows remote code execution through malicious RDP server responses
  containing crafted drivestoredirect parameters. May trigger on legitimate RDP connections.
type: detection
detection_id: 2023755
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What is the complete RDP drivestoredirect payload being sent?
    context: The specific payload structure reveals exploitation intent and target configuration.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - src_ip
        - dst_ip
        - dst_port

  - question: Is this RDP connection from an authorized Mac client?
    context: Legitimate Mac RDP clients may generate similar traffic patterns during normal operation.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 3389
            - 3390
        condition: selection
      fields:
        - src_ip
        - bytes_toserver
        - bytes_toclient

  - question: What RDP server is responding with this potentially malicious content?
    context: Identifying the RDP server helps determine if this is a compromised internal system or external threat.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 3389
            - 3390
        condition: selection
      fields:
        - dst_ip
        - community_id
        - duration

  - question: Are there other suspicious RDP connections from this server?
    context: Multiple exploitation attempts may indicate an active attack campaign targeting Mac RDP clients.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: 'RDP'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - alert.severity

  - question: What Mac systems are connecting to this RDP server?
    context: Identifying affected Mac clients helps scope the potential impact of the exploitation attempt.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 3389
            - 3390
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - community_id

  - question: Has the target Mac client shown signs of compromise?
    context: Successful exploitation may result in process execution or file system changes on the Mac client.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: Are there DNS queries related to this RDP server?
    context: DNS lookups may reveal domain names associated with the malicious RDP server infrastructure.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          dns.resolved_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - src_ip

  - question: What files were created on the Mac client after this RDP session?
    context: Successful RCE exploitation often results in malware deployment or payload execution.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.mime_type

  - question: Are there other Mac RDP exploit attempts in the environment?
    context: Multiple Mac systems may be targeted by the same attack campaign or compromised RDP server.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: 'ET EXPLOIT Possible Microsoft RDP Client for Mac RCE'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.severity

  - question: What is the reputation and geolocation of the RDP server?
    context: External or suspicious RDP servers may indicate targeted attacks against Mac RDP clients.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto
        - app_proto

  - question: Are there network anomalies following this RDP exploitation attempt?
    context: Successful compromise may lead to additional network connections or data exfiltration.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - rule.name
        - src_ip
        - alert.category