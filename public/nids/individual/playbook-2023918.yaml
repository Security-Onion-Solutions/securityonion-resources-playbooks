name: ET MALWARE MiniDuke CnC Beacon (string1_slide_1_1)
id: 22023918
description: |
  Detects MiniDuke malware command and control beacon communications using specific
  encoded strings. MiniDuke is associated with APT29 and uses SMTP for C2 communications.
  This pattern indicates active malware infection and data exfiltration attempts.
type: detection
detection_id: 2023918
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What is the complete MiniDuke beacon payload being transmitted?
    context: The full beacon content reveals the specific variant and configuration of MiniDuke malware.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - src_ip
        - dst_ip
        - dst_port

  - question: Is this SMTP connection part of legitimate email traffic?
    context: MiniDuke uses SMTP for C2, but this could be normal email if the pattern is coincidental.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 25
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - bytes_toclient

  - question: What process initiated this MiniDuke C2 communication?
    context: Identifying the source process helps confirm malware infection and determine persistence mechanisms.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: Are there other MiniDuke beacon patterns from this infected system?
    context: MiniDuke uses multiple beacon variants, so additional patterns may confirm the infection.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: 'MiniDuke'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - alert.severity

  - question: What C2 server is receiving the MiniDuke beacons?
    context: The C2 infrastructure reveals the scope of the APT29 campaign and other potential targets.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 25
        condition: selection
      fields:
        - src_ip
        - community_id
        - duration

  - question: What files were created by the MiniDuke infection?
    context: MiniDuke deployment often involves dropping additional payloads or creating persistence files.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.mime_type

  - question: Are there DNS queries for the MiniDuke C2 infrastructure?
    context: DNS lookups may reveal domain names used by APT29 for MiniDuke command and control.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          dns.resolved_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - src_ip

  - question: What registry modifications occurred during MiniDuke infection?
    context: MiniDuke establishes persistence through registry modifications for autostart and configuration.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetObject
        - Details
        - User

  - question: Are other systems in the environment infected with MiniDuke?
    context: APT29 campaigns often involve lateral movement and multiple compromised systems.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'MiniDuke'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.severity

  - question: What data exfiltration activities are associated with this infection?
    context: MiniDuke is designed for data theft, so identifying exfiltration helps assess impact.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.category|contains:
            - 'Exfiltration'
            - 'Data Loss'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - alert.severity

  - question: Are there indicators of APT29 lateral movement from this system?
    context: Successful MiniDuke infections often lead to credential theft and lateral movement activities.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'Lateral Movement'
            - 'Credential'
            - 'Pass the Hash'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - alert.category