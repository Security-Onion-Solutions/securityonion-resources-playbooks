name: ET MALWARE MiniDuke CnC Beacon (string2_slide_2_2)
id: 22023927
description: |
  Detects MiniDuke malware command and control beacon traffic containing specific encoded patterns (variant 2_2).
  This APT29-associated malware uses SMTP protocol for C2 communications with distinctive string patterns.
  May rarely trigger on legitimate SMTP traffic containing similar character sequences.
type: detection
detection_id: 2023927
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete SMTP payload containing the MiniDuke beacon pattern N0VbcF?
    context: Analyzing the full SMTP message reveals the C2 communication structure and potential data exfiltration.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - smtp.helo
        - smtp.mail_from
        - smtp.rcpt_to

  - question: Is this SMTP traffic part of legitimate email operations for this host?
    context: Distinguishing between malicious C2 and normal email helps eliminate false positives.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 25
        condition: selection
      fields:
        - dst_ip
        - bytes_out
        - connection_count

  - question: What triggered this MiniDuke beacon transmission?
    context: Understanding the parent process or trigger event helps identify the infection vector.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid

  - question: What other network connections occurred around the same time as this beacon?
    context: MiniDuke often establishes multiple C2 channels and may perform reconnaissance activities.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_in
        - bytes_out

  - question: Has the MiniDuke payload successfully established persistence?
    context: Confirming malware installation helps assess the scope of compromise.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.extension|contains:
            - '.exe'
            - '.dll'
            - '.scr'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size

  - question: What data was potentially exfiltrated via this SMTP channel?
    context: MiniDuke uses SMTP for data exfiltration, analyzing traffic volume reveals potential data theft.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 25
        condition: selection
      fields:
        - dst_ip
        - bytes_out
        - connection_duration

  - question: Are there signs of MiniDuke lateral movement activities?
    context: APT29 typically moves laterally after initial compromise to access high-value targets.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 445
            - 139
            - 3389
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_in
        - bytes_out

  - question: What specific MiniDuke variant is indicated by this beacon pattern?
    context: Different MiniDuke variants use distinct beacon patterns, helping identify the specific threat.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: 'MiniDuke'
        condition: selection
      fields:
        - rule.name
        - rule.sid
        - alert.signature

  - question: Has this host shown other APT29-associated malware activity?
    context: APT29 often deploys multiple malware families in coordinated campaigns.
    range: -30d
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.metadata.malware_family|contains:
            - 'APT29'
            - 'CozyBear'
            - 'Hammertoss'
        condition: selection
      fields:
        - rule.name
        - alert.metadata.malware_family
        - alert.severity

  - question: Are other hosts in the network showing similar MiniDuke beacon activity?
    context: Identifying the campaign scope helps prioritize containment and remediation efforts.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'MiniDuke'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.sid
        - alert.severity

  - question: What is the geographic and organizational context of the C2 destinations?
    context: MiniDuke C2 infrastructure patterns help attribute the attack and assess threat level.
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 25
        condition: selection
      fields:
        - src_ip
        - connection_count
        - bytes_out