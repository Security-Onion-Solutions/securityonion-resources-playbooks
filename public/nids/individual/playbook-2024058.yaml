name: ET SHELLCODE Linux/x86-64 - Polymorphic Setuid(0) & Execve(/bin/sh) Shellcode
id: 22024058
description: |
  Detects polymorphic shellcode designed to escalate privileges to root and execute shell commands.
  This shellcode is commonly used for privilege escalation and establishing interactive access.
  May trigger on legitimate security tools or penetration testing frameworks using similar code patterns.
type: detection
detection_id: 2024058
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete privilege escalation shellcode payload detected?
    context: Understanding the exact shellcode reveals the specific privilege escalation technique and target commands.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - alert.signature

  - question: What specific system calls does this shellcode execute for privilege escalation?
    context: Identifying the exact system calls helps understand the attack's privilege escalation mechanism.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - alert.metadata
        - flow.bytes_toserver

  # Type 2: Triage Assessment
  - question: Is this target system a Linux server with legitimate administrative shell access?
    context: System administrators may use automated tools that could contain similar binary patterns for privilege management.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          User: 'root'
          Image|contains:
            - '/bin/sh'
            - '/bin/bash'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine

  - question: Are there authorized security assessments that could generate this shellcode pattern?
    context: Penetration testing tools may legitimately use privilege escalation shellcode for security validation.
    range: -1d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - bytes_toserver
        - proto

  # Type 3: Activity Context
  - question: What network service received this privilege escalation shellcode?
    context: Understanding the target service helps identify the vulnerability being exploited for privilege escalation.
    range: -5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - dst_port
        - proto
        - app_proto
        - bytes_toserver

  - question: What exploitation activity preceded this privilege escalation attempt?
    context: Understanding the attack chain helps identify the initial compromise vector and exploitation sequence.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - alert.signature
        - alert.category
        - dst_port

  # Type 4: Impact Assessment
  - question: Has root-level access been successfully obtained on the target system?
    context: Determining if the privilege escalation succeeded is critical for assessing compromise severity.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          User: 'root'
          Image|contains:
            - '/bin/sh'
            - '/bin/bash'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  - question: Are there signs of interactive shell access following the privilege escalation?
    context: Successful privilege escalation often leads to interactive command execution and system manipulation.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          User: 'root'
        condition: selection
      fields:
        - CommandLine
        - Image
        - User
        - ParentImage

  # Type 5: Forensic Deep-Dive
  - question: What exploitation framework generated this polymorphic privilege escalation shellcode?
    context: Identifying the shellcode source helps understand attacker sophistication and predict additional attack methods.
    range: +/-1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains: 'shellcode'
        condition: selection
      fields:
        - alert.signature
        - dst_ip
        - dst_port

  - question: What post-exploitation activities occurred after gaining root access?
    context: Understanding post-compromise activities reveals the attacker's objectives and impact scope.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          User: 'root'
          CommandLine|contains:
            - 'cat /etc/passwd'
            - 'ps aux'
            - 'netstat'
            - 'find /'
        condition: selection
      fields:
        - CommandLine
        - Image
        - User

  - question: What persistence mechanisms were established with root privileges?
    context: Attackers typically establish persistent access after successfully escalating to root privileges.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetFilename|contains:
            - '/etc/crontab'
            - '/root/.ssh/authorized_keys'
            - '/etc/passwd'
            - '/etc/sudoers'
        condition: selection
      fields:
        - TargetFilename
        - User
        - ProcessName

  - question: Are there indicators of data exfiltration using elevated privileges?
    context: Root access enables comprehensive data access and potential large-scale data theft.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          bytes_toclient|gt: 10000000
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toclient
        - proto

  # Type 6: Enterprise Correlation
  - question: Are other Linux systems showing similar privilege escalation shellcode attacks?
    context: Coordinated privilege escalation attempts indicate a broader campaign targeting Linux infrastructure.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: 'Setuid(0) & Execve'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature

  - question: Is this part of a systematic privilege escalation campaign across the organization?
    context: Understanding campaign scope helps prioritize response and identify additional compromised systems.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.category: 'Attempted Administrator Privilege Gain'
        condition: selection
      fields:
        - dst_ip
        - alert.signature
        - alert.severity