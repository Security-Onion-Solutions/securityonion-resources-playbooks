name: ET EXPLOIT ETERNALBLUE Exploit M2 MS17-010
id: 22024297
description: |
  Detects EternalBlue exploitation attempts targeting MS17-010 vulnerability on SMB port 445.
  This signature identifies the specific M2 exploit pattern used by various malware families.
  May trigger on legitimate SMB traffic with similar byte patterns, but highly indicative of attack.
type: detection
detection_id: 2024297
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact SMB exploit payload detected in the connection?
    context: The specific byte pattern reveals EternalBlue M2 exploit variant and target vulnerability.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - alert.signature

  - question: What SMB session details were captured during the exploit attempt?
    context: SMB connection metadata provides insight into exploitation method and target service.
    range: +/-5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - src_port
        - bytes_toserver
        - bytes_toclient
        - conn_state

  # Type 2: Triage Assessment
  - question: Is this connection from an authorized administrator or security tool?
    context: EternalBlue exploits are never legitimate, but security scanners may trigger similar patterns.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 445
        condition: selection
      fields:
        - dst_ip
        - conn_state

  # Type 3: Activity Context
  - question: What other SMB connections occurred from this source around the same time?
    context: EternalBlue attacks often involve reconnaissance and multiple target attempts.
    range: +/-30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 139
            - 445
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - conn_state

  - question: Were there any process executions on the target system following this connection?
    context: Successful EternalBlue exploitation typically results in code execution and process creation.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ParentImage

  # Type 4: Impact Assessment
  - question: Did the exploit attempt result in successful SMB authentication or file access?
    context: Successful exploitation may show authenticated SMB sessions or file system access.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
          conn_state: SF
        condition: selection
      fields:
        - bytes_toserver
        - bytes_toclient
        - duration

  - question: Are there signs of lateral movement or additional compromise from the target system?
    context: EternalBlue is often used as initial access for broader network compromise.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - service

  # Type 5: Forensic Deep-Dive
  - question: What malware family or tools were deployed following the exploit?
    context: EternalBlue exploitation often deploys ransomware, cryptocurrency miners, or remote access tools.
    range: +6h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - alert.signature
        - alert.category
        - alert.severity

  - question: What file modifications occurred on the target system post-exploitation?
    context: Successful attacks typically involve dropping payloads, creating persistence, or data manipulation.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.mime_type
        - event_type

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network showing similar EternalBlue exploitation attempts?
    context: EternalBlue attacks often target multiple systems in automated campaigns.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: "ETERNALBLUE"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature

  - question: Is this part of a broader SMB-based attack campaign across the enterprise?
    context: Coordinated attacks may show patterns across multiple internal systems and external sources.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains:
            - "SMB"
            - "MS17-010"
            - "ETERNALBLUE"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature
        - alert.category