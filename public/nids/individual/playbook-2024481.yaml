name: ET TFTP Outbound TFTP Data Transfer With Cisco Config 2
id: 22024481
description: |
  Detects outbound TFTP transfers containing Cisco NVRAM configuration data.
  Identifies potential unauthorized access to network device configurations containing sensitive network topology and credentials.
  May indicate legitimate backup operations or malicious configuration exfiltration for reconnaissance.
type: detection
detection_id: 2024481
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What specific NVRAM configuration data was transferred in this TFTP session?
    context: NVRAM config contains startup configurations with sensitive network settings and potential credentials.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - alert.signature

  - question: What was the size and duration of the TFTP configuration transfer?
    context: Transfer metrics indicate the scope of configuration data and potential impact of exposure.
    range: +/-10m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 69
        condition: selection
      fields:
        - bytes_toserver
        - bytes_toclient
        - duration
        - conn_state
        - src_port

  # Type 2: Triage Assessment
  - question: Is this transfer from an authorized network management system or administrator?
    context: Legitimate NVRAM backups should originate from known network management infrastructure.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 69
        condition: selection
      fields:
        - dst_ip
        - bytes_toclient

  - question: Does this TFTP activity align with scheduled maintenance windows?
    context: Network device configuration backups typically occur during planned maintenance periods.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: "TFTP"
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - alert.signature

  # Type 3: Activity Context
  - question: What network device management activity preceded this configuration transfer?
    context: Understanding the sequence helps determine if this was authorized administrative activity.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 22
            - 23
            - 80
            - 443
            - 161
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - conn_state
        - duration

  - question: Were there authentication attempts to Cisco devices before this transfer?
    context: Legitimate configuration access requires proper authentication to network equipment first.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 22
            - 23
            - 443
        condition: selection
      fields:
        - dst_port
        - conn_state
        - bytes_toserver
        - bytes_toclient

  # Type 4: Impact Assessment
  - question: What sensitive network infrastructure information was potentially compromised?
    context: NVRAM configurations contain network topology, VLANs, routing, and potentially embedded credentials.
    range: +/-5m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - alert.signature
        - payload_printable
        - alert.severity

  - question: Are there indicators of lateral movement or network reconnaissance following this access?
    context: Stolen network configurations enable attackers to map infrastructure and plan lateral movement.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - service
        - conn_state

  # Type 5: Forensic Deep-Dive
  - question: What processes or tools initiated this TFTP configuration retrieval?
    context: Process analysis reveals whether this was manual administration, automated backup, or malicious tooling.
    range: +/-30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - "tftp"
            - "copy"
            - "backup"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ParentImage
        - ProcessGuid

  - question: Where was the configuration data stored or processed after transfer?
    context: File operations reveal how the stolen configuration data was handled and potential exfiltration paths.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - ".cfg"
            - ".conf"
            - "config"
            - "nvram"
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - event_type
        - file.size

  - question: Were any network discovery or scanning tools used in conjunction with this activity?
    context: Configuration theft often accompanies network reconnaissance and scanning activities.
    range: +/-2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - "nmap"
            - "masscan"
            - "netcat"
            - "telnet"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  # Type 6: Enterprise Correlation
  - question: Are other network devices showing similar configuration access attempts?
    context: Coordinated attacks often target multiple network devices to map entire infrastructure.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains:
            - "TFTP"
            - "Cisco"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature

  - question: Is this part of broader network infrastructure targeting across the enterprise?
    context: Understanding campaign scope helps determine if this is isolated incident or coordinated attack.
    range: +/-6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.category: policy-violation
        condition: selection
      fields:
        - dst_ip
        - alert.signature
        - alert.category
        - alert.severity