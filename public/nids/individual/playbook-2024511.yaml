name: ET DOS SMBLoris NBSS Length Mem Exhaustion Attempt (PoC Based)
id: 22024511
description: |
  Detects SMBLoris denial of service attacks targeting SMB NetBIOS Session Service.
  Identifies attempts to exhaust server memory through malformed NBSS length fields.
  Legitimate SMB traffic should not contain these specific malformed length patterns.
type: detection
detection_id: 2024511
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the specific SMBLoris payload pattern detected in the attack?
    context: The malformed NBSS length field reveals the DoS technique and potential impact on target system.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - alert.signature
        - flow_id

  - question: How many SMBLoris packets were sent in this attack sequence?
    context: Packet count and frequency determine the intensity and potential impact of the DoS attack.
    range: +/-15m
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          alert.signature|contains: "SMBLoris"
        condition: selection
      fields:
        - alert.signature
        - src_ip
        - dst_ip

  # Type 2: Triage Assessment
  - question: Is this attack coming from an internal or external source?
    context: Internal sources may indicate compromised systems, while external suggests targeted attack.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - service

  - question: Has this source IP shown previous malicious activity?
    context: Historical analysis helps determine if this is part of ongoing attack campaign.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - alert.signature
        - alert.category

  # Type 3: Activity Context
  - question: What SMB reconnaissance activity preceded this DoS attack?
    context: Attackers often perform SMB enumeration before launching targeted DoS attacks.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 139
            - 445
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - conn_state
        - bytes_toserver
        - duration

  - question: Were there port scans or network discovery attempts from this source?
    context: DoS attacks often follow reconnaissance to identify vulnerable SMB services.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.category|contains:
            - "attempted-recon"
            - "network-scan"
        condition: selection
      fields:
        - dst_ip
        - alert.signature
        - alert.category

  # Type 4: Impact Assessment
  - question: Did the SMBLoris attack cause service disruption on the target system?
    context: Successful attacks may cause SMB service unavailability or system resource exhaustion.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 139
            - 445
          conn_state|contains:
            - "REJ"
            - "RSTO"
        condition: selection
      fields:
        - src_ip
        - dst_port
        - conn_state
        - duration

  - question: Are there signs of system performance degradation on the target?
    context: Memory exhaustion attacks may cause broader system instability beyond SMB service.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  - question: Were legitimate SMB connections to this system affected?
    context: DoS impact assessment requires understanding disruption to normal business operations.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 139
            - 445
        condition: selection
      fields:
        - src_ip
        - conn_state
        - duration

  # Type 5: Forensic Deep-Dive
  - question: What tools or methods were used to generate the SMBLoris attack?
    context: Understanding attack tools helps with attribution and defense planning.
    range: +/-30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - "smbloris"
            - "smb"
            - "netbios"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ParentImage

  - question: Were there any system logs or events indicating memory exhaustion on the target?
    context: Successful SMBLoris attacks should show evidence of resource exhaustion on target systems.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          alert.category|contains:
            - "system"
            - "performance"
        condition: selection
      fields:
        - alert.signature
        - alert.severity
        - alert.category

  - question: What network traffic patterns emerged during the attack duration?
    context: DoS attacks create distinctive traffic patterns that help understand attack methodology.
    range: +/-30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - conn_state
        - bytes_toserver

  # Type 6: Enterprise Correlation
  - question: Are other SMB servers in the network being targeted with similar DoS attacks?
    context: Coordinated SMBLoris attacks may target multiple systems to maximize disruption.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: "SMBLoris"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature

  - question: Is this part of a broader denial of service campaign against the enterprise?
    context: SMBLoris may be one component of multi-vector DoS attacks targeting different services.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.category|contains:
            - "dos"
            - "trojan-activity"
        condition: selection
      fields:
        - dst_ip
        - alert.signature
        - alert.category
        - alert.severity