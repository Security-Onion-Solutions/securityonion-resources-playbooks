name: ET DOS Potential CLDAP Amplification Reflection
id: 22024585
description: |
  Detects potential CLDAP amplification reflection attacks via objectclass queries.
  CLDAP queries with objectclass0 pattern indicate DDoS amplification abuse.
  May trigger on legitimate LDAP directory searches but volume threshold suggests abuse.
type: detection
detection_id: 2024585
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact objectclass query pattern detected in the CLDAP traffic?
    context: Understanding the specific LDAP search filter reveals amplification technique and potential data exposure.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - dsize
        - app_proto

  - question: What is the query structure and expected response size for this CLDAP request?
    context: CLDAP amplification effectiveness depends on query complexity and response size ratio.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - flow.bytes_toserver
        - flow.bytes_toclient
        - src_port
        - dst_port

  # Type 2: Triage Assessment
  - question: Is this source performing legitimate LDAP directory searches?
    context: Distinguishes between authorized directory clients and spoofed amplification sources.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 389
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - bytes_toclient
        - duration

  - question: Are there authorized applications that perform objectclass queries on this system?
    context: Validates if the target system legitimately serves LDAP directory queries.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 389
        condition: selection
      fields:
        - src_ip
        - bytes_toserver
        - bytes_toclient

  # Type 3: Activity Context
  - question: What triggered the 200+ packet threshold detection within 60 seconds?
    context: High-volume threshold indicates coordinated amplification attack rather than normal queries.
    range: -15m/+15m
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature_id: 2024585
        condition: selection
      fields:
        - dst_ip
        - alert.signature
        - event_type

  - question: What network reconnaissance preceded this potential amplification attack?
    context: Identifies scanning or discovery activities that located vulnerable CLDAP services.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 389
            - 636
            - 3268
        condition: selection
      fields:
        - dst_ip
        - proto
        - bytes_toserver

  - question: Are there multiple source IPs targeting the same CLDAP service simultaneously?
    context: Coordinated targeting suggests distributed amplification attack campaign.
    range: -30m/+30m
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          alert.signature_id: 2024585
        condition: selection
      fields:
        - src_ip
        - alert.signature

  # Type 4: Impact Assessment
  - question: What is the bandwidth amplification ratio achieved by these CLDAP queries?
    context: Quantifies the DDoS multiplication factor to assess attack severity and impact.
    range: -30m/+30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - bytes_toserver
        - bytes_toclient
        - duration

  - question: Are multiple internal LDAP servers being abused as amplification reflectors?
    context: Determines the scope of infrastructure compromise and amplification potential.
    range: -1h/+1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature_id|contains:
            - 2024584
            - 2024585
        condition: selection
      fields:
        - dst_ip
        - src_ip
        - alert.signature

  # Type 5: Forensic Deep-Dive
  - question: What specific directory attributes are being queried in the objectclass searches?
    context: Understanding query content reveals attacker knowledge and potential information disclosure.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - app_proto
        - proto

  - question: Are there indicators of LDAP service fingerprinting or enumeration?
    context: Identifies reconnaissance activities that preceded the amplification attack.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 389
            - 636
        condition: selection
      fields:
        - src_ip
        - bytes_toserver
        - bytes_toclient

  # Type 6: Enterprise Correlation
  - question: Are other systems experiencing similar CLDAP amplification patterns?
    context: Identifies enterprise-wide DDoS campaign using CLDAP amplification vectors.
    range: -2h/+2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature_id: 2024585
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature

  - question: Is this CLDAP amplification part of a multi-vector DDoS attack?
    context: Correlates with other DDoS indicators to understand attack coordination and scope.
    range: -1h/+1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.category|contains:
            - "attempted-dos"
            - "denial-of-service"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature