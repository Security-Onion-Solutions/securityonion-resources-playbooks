name: ET COINMINER CoinMiner Malicious Authline Seen After CVE-2017-10271 Exploit
id: 22025186
description: |
  Detects cryptocurrency mining malware communications following exploitation of
  CVE-2017-10271 (Oracle WebLogic Server deserialization vulnerability). The specific
  authentication string indicates Monero mining pool connections established by
  malware after successful server compromise. Legitimate mining would not follow
  this exploitation pattern.
type: detection
detection_id: 2025186
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete mining pool authentication payload containing the wallet address?
    context: Analyzing the mining credentials reveals the threat actor's wallet and mining pool infrastructure.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - flow.bytes_toserver
        - flow.bytes_toclient

  - question: Which mining pool server is being contacted for cryptocurrency mining?
    context: Identifying the mining pool helps map threat infrastructure and enables blocking.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - src_ip
        - src_port

  # Type 2: Triage Assessment
  - question: Is this system authorized to perform cryptocurrency mining activities?
    context: Legitimate mining operations would be documented and not follow exploitation patterns.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 3333
            - 4444
            - 8080
            - 14433
            - 14444
        condition: selection
      fields:
        - dst_ip
        - app_proto
        - bytes_toserver
        - bytes_toclient

  - question: Does this compromised system have access to sensitive data or critical services?
    context: Understanding system criticality helps prioritize incident response and assess data exposure risk.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - app_proto
        - connection_state

  # Type 3: Activity Context
  - question: What CVE-2017-10271 WebLogic exploitation activity preceded this coinminer installation?
    context: Understanding the initial compromise vector helps assess attack sophistication and timeline.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
          rule.name|contains:
            - "CVE-2017-10271"
            - "WebLogic"
            - "deserialization"
        condition: selection
      fields:
        - rule.name
        - src_ip
        - payload

  - question: What malware download or installation activity occurred after the WebLogic exploit?
    context: Coinminers are typically downloaded as secondary payloads after initial system compromise.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 80
            - 443
            - 8080
        condition: selection
      fields:
        - dst_ip
        - bytes_toclient
        - app_proto
        - connection_state

  - question: What processes were created on the system around the time of coinminer installation?
    context: Identifying the mining process helps understand persistence mechanisms and system impact.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  # Type 4: Impact Assessment
  - question: How much system resources are being consumed by the cryptocurrency mining activity?
    context: Coinminers can severely impact system performance and increase operational costs.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - bytes_toserver
        - bytes_toclient
        - duration
        - connection_state

  - question: What additional malware or backdoors were installed alongside the coinminer?
    context: Coinminers often come with additional malware for persistence and data theft.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - "malware"
            - "trojan"
            - "backdoor"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - dst_port

  # Type 5: Forensic Deep-Dive
  - question: What specific coinminer malware family and variant infected the system?
    context: Different coinminer families have varying capabilities and persistence mechanisms.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category: "coin-mining"
        condition: selection
      fields:
        - rule.name
        - malware_family
        - dst_ip
        - dst_port

  - question: What persistence mechanisms has the coinminer established on the compromised system?
    context: Understanding persistence helps ensure complete malware removal and prevents reinfection.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetObject
        - Details
        - Image

  - question: What configuration files or scripts were dropped by the coinminer?
    context: Analyzing coinminer configuration reveals mining parameters and potential lateral movement capabilities.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size

  # Type 6: Enterprise Correlation
  - question: Are other WebLogic servers in the organization showing similar CVE-2017-10271 exploitation?
    context: Attackers often target all vulnerable WebLogic instances in an environment.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "CVE-2017-10271"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is this part of a broader cryptojacking campaign targeting the organization's infrastructure?
    context: Understanding campaign scope helps implement network-wide protections and assess total impact.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.category: "coin-mining"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - malware_family