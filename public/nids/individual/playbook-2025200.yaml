name: ET MALWARE OSX/Mami Possible DNS Query to Evil DNS Server
id: 22025200
description: |
  Detects DNS queries to known malicious DNS servers associated with OSX/Mami malware.
  This macOS malware hijacks DNS settings to redirect traffic through attacker-controlled
  servers for traffic interception and credential theft. Legitimate applications would
  not query these specific malicious DNS servers.
type: detection
detection_id: 2025200
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What specific DNS queries were made to the malicious DNS servers?
    context: Understanding queried domains reveals what traffic the malware is attempting to intercept.
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.resolved_ip|contains:
            - "82.163.143.135"
            - "82.163.142.137"
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.resolved_ip
        - dns.response_code

  - question: Which macOS system is making DNS queries to the evil DNS servers?
    context: Identifying the infected system helps prioritize containment and remediation efforts.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_port
        - dst_port

  # Type 2: Triage Assessment
  - question: Is this macOS system configured to use these DNS servers legitimately?
    context: Legitimate DNS configuration would not include these known malicious servers.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.resolved_ip
        - dns.query.name
        - dns.query.type_name

  - question: Does this system typically perform DNS queries to external servers?
    context: Understanding normal DNS behavior helps distinguish between legitimate and malicious activity.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.resolved_ip
        - dns.query.name
        - dns.response_code

  # Type 3: Activity Context
  - question: What suspicious downloads or installations preceded the DNS hijacking?
    context: OSX/Mami typically spreads through malicious downloads or software installers.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 80
            - 443
        condition: selection
      fields:
        - dst_ip
        - bytes_toclient
        - app_proto
        - connection_state

  - question: What system configuration changes occurred around the time of infection?
    context: OSX/Mami modifies DNS settings and potentially other system configurations.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: What processes are currently running that might be associated with the malware?
    context: Identifying malicious processes helps understand persistence mechanisms and system impact.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - "dns"
            - "network"
            - "system"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  # Type 4: Impact Assessment
  - question: What sensitive domains or credentials might have been intercepted through DNS hijacking?
    context: DNS hijacking can redirect banking, email, and other sensitive traffic to attacker servers.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.query.name|contains:
            - "bank"
            - "paypal"
            - "gmail"
            - "apple"
            - "microsoft"
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  - question: What HTTP/HTTPS traffic has been redirected through the malicious DNS infrastructure?
    context: Understanding redirected traffic helps assess potential credential theft and data exposure.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.response.status_code

  # Type 5: Forensic Deep-Dive
  - question: What specific OSX/Mami variant and capabilities are present on the infected system?
    context: Different Mami variants have varying capabilities for data theft and system persistence.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "Mami"
        condition: selection
      fields:
        - rule.name
        - malware_family
        - dst_ip
        - dst_port

  - question: What system files or configurations has the malware modified for persistence?
    context: Understanding persistence mechanisms helps ensure complete malware removal.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - "/etc/"
            - "/Library/"
            - "/System/"
            - ".plist"
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size

  - question: What additional malware or backdoors were installed alongside OSX/Mami?
    context: Mami infections often include additional malware components for comprehensive system compromise.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - "malware"
            - "trojan"
            - "backdoor"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - dst_port

  # Type 6: Enterprise Correlation
  - question: Are other macOS systems in the organization making queries to these malicious DNS servers?
    context: OSX/Mami campaigns may target multiple macOS systems within an organization.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          dns.resolved_ip|contains:
            - "82.163.143.135"
            - "82.163.142.137"
        condition: selection
      fields:
        - src_ip
        - dns.query.name
        - dns.resolved_ip

  - question: Is this part of a broader malware campaign targeting macOS systems in the organization?
    context: Understanding campaign scope helps implement network-wide protections and threat hunting.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "OSX"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - malware_family