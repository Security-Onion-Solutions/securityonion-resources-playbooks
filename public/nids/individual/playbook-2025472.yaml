name: ET EXPLOIT Possible CVE-2018-0171 Exploit (PoC based)
id: 22025472
description: |
  Detects potential exploitation attempts against Cisco Smart Install protocol vulnerability CVE-2018-0171.
  May trigger on legitimate Smart Install traffic or proof-of-concept exploit attempts targeting port 4786.
type: detection
detection_id: 2025472
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What is the exact payload content that triggered this CVE-2018-0171 detection?
    context: Understanding the specific exploit payload reveals the attack methodology and potential impact.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_port
        - dst_port
        - payload
        - rule.name

  - question: What are the connection characteristics of this Smart Install exploitation attempt?
    context: Connection metadata helps determine if this is a targeted attack or automated scanning.
    range: -5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 4786
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - connection_state
        - bytes_sent
        - bytes_received

  # Type 2: Triage Assessment
  - question: Is the target device a legitimate Cisco network device with Smart Install enabled?
    context: Legitimate Smart Install traffic may trigger false positives on authorized network equipment.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 4786
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - connection_state

  - question: Is this source IP authorized to manage network infrastructure?
    context: Network administrators may legitimately connect to Smart Install services for device management.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 22
            - 23
            - 161
            - 4786
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port

  # Type 3: Activity Context
  - question: What other network infrastructure ports is this source targeting?
    context: Multi-port scanning of network management services indicates infrastructure reconnaissance.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 22
            - 23
            - 80
            - 161
            - 443
            - 4786
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection_state

  - question: What triggered this exploitation attempt against the Smart Install service?
    context: Understanding the attack vector helps determine if this is opportunistic or targeted.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - connection_state

  - question: What is the geographic origin and reputation of the attacking source?
    context: CVE-2018-0171 exploits often originate from known malicious infrastructure or compromised hosts.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - src_ip
        - geoip.country_name
        - threat_intel.indicator_type

  # Type 4: Impact Assessment
  - question: Was the CVE-2018-0171 exploitation attempt successful?
    context: Successful exploitation may result in remote code execution on the target Cisco device.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 4786
          connection_state: established
          bytes_received|gt: 500
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - connection_duration
        - bytes_sent
        - bytes_received

  - question: Are there signs of device compromise or configuration changes?
    context: Successful Smart Install exploitation can lead to device reconfiguration or backdoor installation.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 22
            - 23
            - 80
            - 443
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - connection_state

  # Type 5: Forensic Deep-Dive
  - question: What specific CVE-2018-0171 exploit variant was used?
    context: Different exploit variants target specific Smart Install protocol weaknesses and have distinct signatures.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "CVE-2018-0171"
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - payload

  - question: Are there indicators of post-exploitation activity on the target device?
    context: Successful exploitation may lead to configuration changes, backdoor installation, or lateral movement.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - bytes_sent
        - connection_state

  - question: What is the attack pattern and timing of the exploitation attempt?
    context: Automated exploit tools show distinct patterns compared to manual exploitation attempts.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 4786
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - connection_state

  # Type 6: Enterprise Correlation
  - question: Are other Cisco devices experiencing similar CVE-2018-0171 exploitation attempts?
    context: Coordinated attacks against multiple network devices indicate a targeted infrastructure campaign.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "CVE-2018-0171"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is this source IP part of a broader network infrastructure attack campaign?
    context: Attackers often target multiple network management protocols in coordinated campaigns.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 22
            - 23
            - 161
            - 4786
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection_state