name: ET EXPLOIT Cisco Smart Install Exploitation Tool - Update Ios and Execute
id: 22025520
description: |
  Detects Smart Install exploitation attempts using tools like SIET to update IOS and execute commands.
  This specific pattern indicates malicious use of Smart Install protocol for device compromise.
  Legitimate Smart Install operations use different command structures and authorized management systems.
type: detection
detection_id: 2025520
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete Smart Install exploitation payload structure?
    context: Analyzing the full payload reveals the specific exploitation technique and target commands.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - flow_id

  - question: What URL or file path was referenced in the Smart Install exploitation attempt?
    context: The URL pattern reveals the source of malicious firmware or configuration being deployed.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - http.url
        - dst_ip
        - dst_port

  # Type 2: Triage Assessment
  - question: Is this targeting a legitimate Cisco device under our management?
    context: Confirms whether this is an attack on our infrastructure or scanning of external devices.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 4786
        condition: selection
      fields:
        - src_ip
        - bytes_toserver
        - duration

  - question: Has this source IP previously engaged in legitimate network management activities?
    context: Distinguishes between authorized network administrators and malicious actors.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 22
            - 23
            - 161
            - 443
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - duration

  # Type 3: Activity Context
  - question: What reconnaissance activity preceded this Smart Install exploitation attempt?
    context: Attackers typically scan for vulnerable devices before launching specific exploits.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 4786
            - 80
            - 443
            - 23
            - 22
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver

  - question: What DNS resolution activity occurred before targeting this device?
    context: DNS queries may reveal how the attacker identified or enumerated the target device.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  # Type 4: Impact Assessment
  - question: Did the Smart Install exploitation result in successful device compromise?
    context: Successful exploitation may lead to device configuration changes or unauthorized access.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_port
        - bytes_toserver
        - duration

  - question: Are there signs of malicious firmware or configuration being downloaded to the device?
    context: Large data transfers to the device may indicate firmware replacement or configuration injection.
    range: +15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 4786
        condition: selection
      fields:
        - src_ip
        - bytes_toclient
        - duration

  # Type 5: Forensic Deep-Dive
  - question: What specific SIET or Smart Install exploitation tool signatures are present?
    context: Different exploitation tools have unique patterns that help identify the attack methodology.
    range: +/-5m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          alert.signature|contains:
            - 'Smart Install'
            - 'SIET'
            - 'Cisco'
        condition: selection
      fields:
        - alert.signature
        - alert.category
        - payload

  - question: What commands or configuration changes were attempted on the target device?
    context: Understanding the payload reveals the attacker's intent and potential device modifications.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - payload_printable
        - http.request.body.content
        - alert.signature

  # Type 6: Enterprise Correlation
  - question: Are other Cisco devices in the network being targeted with similar exploitation attempts?
    context: Coordinated attacks often target multiple devices to establish persistent network access.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: 'Smart Install'
          alert.signature|contains: 'SIET'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature

  - question: Is this Smart Install exploitation part of a broader network infrastructure attack campaign?
    context: Smart Install attacks often occur alongside other network device exploitation techniques.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.category|contains:
            - 'exploit'
            - 'malware'
            - 'trojan'
        condition: selection
      fields:
        - dst_ip
        - alert.signature
        - alert.category