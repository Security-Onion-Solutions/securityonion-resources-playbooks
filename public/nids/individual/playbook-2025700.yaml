name: ET INFO SMB NT Create AndX Request For an Executable File
id: 22025700
description: |
  Detects SMB requests to create or access executable files (.exe) on remote systems.
  This can indicate legitimate software deployment or malicious malware staging activities.
  SMB file operations are common in enterprise environments for software distribution.
type: detection
detection_id: 2025700
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What specific executable file was being accessed via SMB?
    context: Understanding the target executable reveals whether this is legitimate software or potential malware.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_port
        - dst_port
        - rule.name

  - question: What was the SMB share and path being accessed for the executable?
    context: The file location and share name help determine if this is authorized software deployment.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - network.bytes
        - network.packets
        - network.protocol

  # Type 2: Triage Assessment
  - question: Is this SMB executable access part of routine software deployment?
    context: Enterprise environments regularly deploy software via SMB shares during maintenance windows.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: "SMB"
        condition: selection
      fields:
        - rule.name
        - event.count

  - question: Does the source system have authorized access to deploy software on the target?
    context: Legitimate software deployment typically originates from designated deployment servers or admin workstations.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - network.bytes
        - event.count

  # Type 3: Activity Context
  - question: What SMB authentication preceded this executable file access?
    context: Understanding authentication patterns helps determine if legitimate credentials were used.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - network.bytes
        - network.packets

  - question: What other file operations occurred during this SMB session?
    context: Malicious activity often involves multiple file operations beyond just executable access.
    range: +/-15m
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: "SMB"
        condition: selection
      fields:
        - rule.name
        - event.count

  # Type 4: Impact Assessment
  - question: Was the executable file successfully transferred and executed on the target system?
    context: Successful malware deployment via SMB results in process execution on the target system.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains: ".exe"
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ParentImage

  - question: What network connections were established after the executable access?
    context: Malware often establishes command and control connections after successful deployment.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.protocol
        - network.bytes

  # Type 5: Forensic Deep-Dive
  - question: What files were created or modified after the SMB executable access?
    context: Malware deployment often results in additional file creation for persistence or payload staging.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          file.extension: "exe"
        condition: selection
      fields:
        - file.path
        - file.name
        - file.hash.md5
        - User

  - question: Are there signs of the executable establishing persistence mechanisms?
    context: Malware often creates registry entries, services, or scheduled tasks for persistence.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetObject|contains:
            - "\\Run"
            - "\\RunOnce"
            - "\\Services\\"
        condition: selection
      fields:
        - TargetObject
        - Details
        - User

  - question: What process lineage resulted from the SMB-delivered executable?
    context: Understanding process relationships reveals the full impact of malware execution.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          ParentImage|contains: ".exe"
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid
        - ParentProcessGuid

  # Type 6: Enterprise Correlation
  - question: Are other systems receiving similar SMB executable deployments from this source?
    context: Malware campaigns often target multiple systems with the same deployment method.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name: "ET INFO SMB NT Create AndX Request For an Executable File"
        condition: selection
      fields:
        - dst_ip
        - event.count