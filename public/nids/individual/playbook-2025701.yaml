name: ET INFO SMB2 NT Create AndX Request For an Executable File
id: 22025701
description: |
  Detects SMB2 protocol requests to create or access executable files (.exe) on remote systems.
  This can indicate legitimate software deployment or malicious malware staging via SMB2.
  SMB2 provides improved performance and security over SMB1 but similar attack vectors exist.
type: detection
detection_id: 2025701
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What specific executable file was being accessed via SMB2 protocol?
    context: Understanding the target executable and SMB2 specifics reveals deployment method and potential threat.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_port
        - dst_port
        - rule.name

  - question: What SMB2 session characteristics were involved in the executable access?
    context: SMB2 protocol details help distinguish between legitimate enterprise traffic and malicious activity.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - network.bytes
        - network.packets
        - network.protocol

  # Type 2: Triage Assessment
  - question: Is this SMB2 executable access consistent with enterprise software deployment patterns?
    context: Modern enterprises typically use SMB2/3 for software distribution due to improved security features.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: "SMB"
        condition: selection
      fields:
        - rule.name
        - event.count

  - question: Does the timing align with scheduled maintenance or deployment windows?
    context: Legitimate software deployment typically occurs during designated maintenance periods.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - network.bytes
        - event.count

  # Type 3: Activity Context
  - question: What SMB2 negotiation and authentication preceded the executable access?
    context: SMB2 protocol negotiation patterns help identify legitimate versus malicious connections.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - network.bytes
        - network.packets

  - question: What other SMB2 file operations occurred in this session?
    context: Understanding the complete SMB2 session reveals whether this is isolated access or part of broader activity.
    range: +/-15m
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: "SMB"
        condition: selection
      fields:
        - rule.name
        - event.count

  # Type 4: Impact Assessment
  - question: Was the SMB2-delivered executable successfully executed on the target system?
    context: Successful malware deployment results in process creation that can be correlated with SMB2 activity.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains: ".exe"
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ParentImage

  - question: What outbound network activity originated from the target after executable access?
    context: Malware often establishes command and control communications after successful SMB2 deployment.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.protocol
        - network.bytes

  # Type 5: Forensic Deep-Dive
  - question: What executable files were created on the target system following SMB2 activity?
    context: Malware deployment often involves staging multiple executables for different attack phases.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          file.extension: "exe"
        condition: selection
      fields:
        - file.path
        - file.name
        - file.hash.md5
        - User

  - question: Are there indicators of the SMB2-delivered executable establishing system persistence?
    context: Malware typically creates persistence mechanisms to survive system reboots and maintain access.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetObject|contains:
            - "\\Run"
            - "\\RunOnce"
            - "\\Services\\"
        condition: selection
      fields:
        - TargetObject
        - Details
        - User

  - question: What child processes were spawned by the SMB2-delivered executable?
    context: Understanding process lineage reveals the full scope of malware functionality and impact.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          ParentImage|contains: ".exe"
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid
        - ParentProcessGuid

  # Type 6: Enterprise Correlation
  - question: Are multiple systems receiving similar SMB2 executable deployments from this source?
    context: Coordinated malware campaigns often use SMB2 to deploy payloads across multiple enterprise systems.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name: "ET INFO SMB2 NT Create AndX Request For an Executable File"
        condition: selection
      fields:
        - dst_ip
        - event.count

  - question: Is this SMB2 activity part of a broader lateral movement campaign?
    context: Understanding campaign scope helps prioritize incident response and identify additional compromised systems.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "SMB"
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - event.count