name: ET INFO SMB NT Create AndX Request For a Powershell .ps1 File
id: 22025704
description: |
  Detects SMB requests to create or access PowerShell script files (.ps1) on remote systems.
  This can indicate legitimate PowerShell script deployment or malicious payload staging.
  PowerShell scripts are commonly used for both administration and attack scenarios.
type: detection
detection_id: 2025704
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What specific PowerShell script file was being accessed via SMB?
    context: Understanding the target .ps1 file reveals whether this is legitimate administration or potential malware staging.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_port
        - dst_port
        - rule.name

  - question: What was the SMB share path and filename for the PowerShell script?
    context: The script location and naming convention help determine if this is authorized deployment or attack staging.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - network.bytes
        - network.packets
        - network.protocol

  # Type 2: Triage Assessment
  - question: Is this PowerShell script deployment part of documented administrative procedures?
    context: Enterprise environments regularly deploy PowerShell scripts for automation and configuration management.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: "Powershell"
        condition: selection
      fields:
        - rule.name
        - event.count

  - question: Does the source system have authorized access for PowerShell script deployment?
    context: Legitimate PowerShell deployment typically originates from designated management servers or admin workstations.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - network.bytes
        - event.count

  # Type 3: Activity Context
  - question: What SMB authentication activity preceded the PowerShell script access?
    context: Understanding authentication patterns helps determine if legitimate credentials were used for script deployment.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - network.bytes
        - network.packets

  - question: What other file operations occurred during this SMB session?
    context: Malicious PowerShell deployment often involves multiple file operations including payloads and supporting files.
    range: +/-15m
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: "SMB"
        condition: selection
      fields:
        - rule.name
        - event.count

  # Type 4: Impact Assessment
  - question: Was the PowerShell script successfully executed on the target system?
    context: Successful malicious PowerShell deployment results in script execution that can be detected through process monitoring.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - "powershell.exe"
            - "pwsh.exe"
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ParentImage

  - question: What network connections were established after the PowerShell script access?
    context: Malicious PowerShell scripts often establish command and control connections or download additional payloads.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.protocol
        - network.bytes

  # Type 5: Forensic Deep-Dive
  - question: What PowerShell script files were created or modified after the SMB access?
    context: Malicious campaigns often deploy multiple PowerShell scripts for different attack phases and persistence.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          file.extension: "ps1"
        condition: selection
      fields:
        - file.path
        - file.name
        - file.hash.md5
        - User

  - question: Are there signs of PowerShell-based persistence mechanisms being established?
    context: Attackers often use PowerShell scripts in registry run keys or scheduled tasks for persistence.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Details|contains:
            - "powershell"
            - ".ps1"
        condition: selection
      fields:
        - TargetObject
        - Details
        - User

  - question: What PowerShell execution patterns emerged after the script deployment?
    context: Understanding PowerShell usage patterns reveals the scope and nature of script-based attacks.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          CommandLine|contains:
            - "-ExecutionPolicy"
            - "-EncodedCommand"
            - "-WindowStyle Hidden"
        condition: selection
      fields:
        - User
        - CommandLine
        - Image
        - ProcessGuid

  # Type 6: Enterprise Correlation
  - question: Are other systems receiving similar PowerShell script deployments from this source?
    context: PowerShell-based attacks often target multiple systems with the same script deployment method.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name: "ET INFO SMB NT Create AndX Request For a Powershell .ps1 File"
        condition: selection
      fields:
        - dst_ip
        - event.count

  - question: Is this PowerShell script deployment part of a broader SMB-based attack campaign?
    context: Understanding campaign scope helps identify the full extent of PowerShell-based compromise across the enterprise.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "SMB"
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - event.count