name: ET INFO SMB2 NT Create AndX Request For a DLL File - Possible Lateral Movement
id: 22025709
description: |
  Detects SMB2 requests to create or access DLL files, potentially indicating lateral movement.
  May represent legitimate software deployment or malicious DLL-based attack techniques.
type: detection
detection_id: 2025709
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What is the specific DLL filename and destination path in this SMB2 request?
    context: DLL names and paths can reveal whether this is legitimate software or malicious lateral movement tools.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - smb.filename
        - smb.path
        - smb.command

  - question: Is this DLL transfer consistent with scheduled software deployment or updates?
    context: Legitimate DLL transfers often occur during maintenance windows or software rollouts.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 445
        condition: selection
      fields:
        - dst_ip
        - bytes_in
        - bytes_out

  - question: What authentication credentials were used for this lateral DLL transfer?
    context: Authentication details help determine if this represents authorized deployment or credential compromise.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - smb.auth.username
        - smb.auth.domain
        - smb.share_name

  - question: What sequence of lateral movement activities preceded this DLL transfer?
    context: Understanding the attack chain helps identify the scope and progression of lateral movement.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 445
            - 139
            - 135
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_in
        - bytes_out

  - question: Was the transferred DLL successfully executed on the target system?
    context: DLL execution confirms successful lateral movement and potential system compromise.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - 'rundll32.exe'
            - 'regsvr32.exe'
        condition: selection
      fields:
        - User
        - CommandLine
        - ProcessGuid

  - question: Are there indicators of DLL sideloading or injection techniques?
    context: Malicious DLLs often use advanced techniques to evade detection and maintain persistence.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ParentImage

  - question: What persistence mechanisms were established following DLL deployment?
    context: Attackers often establish persistence after successful lateral movement to maintain access.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetObject|contains:
            - 'Run'
            - 'Service'
            - 'DLL'
        condition: selection
      fields:
        - TargetObject
        - Details
        - User

  - question: How many other systems have been targeted with similar DLL-based lateral movement?
    context: Multiple targets indicate coordinated campaign scope and help prioritize incident response.
    range: -4h/+4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'DLL'
          rule.name|contains: 'Lateral Movement'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: What command and control communications were established post-compromise?
    context: C2 connections reveal the attack infrastructure and enable threat hunting across the network.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_in
        - bytes_out

  - question: What additional tools or payloads were deployed following successful DLL transfer?
    context: Secondary payload deployment indicates advanced persistent threat activity and expanded compromise.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetFilename|contains:
            - '.exe'
            - '.dll'
            - '.bat'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - User

  - question: Is this source IP part of a broader lateral movement campaign across the enterprise?
    context: Enterprise-wide correlation reveals campaign scope and helps identify patient zero.
    range: -24h/+24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: 'Lateral Movement'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - rule.category