name: ET INFO SMB Remote AT Scheduled Job Pipe Creation
id: 22025714
description: |
  Detects SMB communication to the AT service pipe (atsvc) used for scheduling remote tasks.
  This can indicate legitimate remote administration or malicious lateral movement attempts.
  The AT service allows scheduling commands to run at specified times on remote systems.
type: detection
detection_id: 2025714
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What SMB session details were involved in the AT service pipe access?
    context: Understanding the SMB session context reveals authentication methods and user accounts involved.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_port
        - dst_port
        - rule.name

  - question: What was the complete SMB communication pattern for this AT service interaction?
    context: Analyzing SMB traffic reveals the scope and nature of remote task scheduling attempts.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - network.bytes
        - network.packets
        - network.protocol

  # Type 2: Triage Assessment
  - question: Is this SMB AT service usage part of documented administrative procedures?
    context: Legitimate system administration often uses AT service for scheduled maintenance tasks.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: "SMB"
        condition: selection
      fields:
        - rule.name
        - event.count

  - question: Does the source system have authorized administrative access to the target?
    context: Regular administrative connections help distinguish legitimate from malicious activity.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - network.protocol
        - event.count

  # Type 3: Activity Context
  - question: What SMB authentication activity preceded the AT service pipe access?
    context: Understanding authentication patterns reveals whether legitimate credentials were used.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - network.bytes
        - network.packets

  - question: What other SMB services were accessed during this session?
    context: Lateral movement often involves accessing multiple SMB services beyond just AT scheduling.
    range: +/-15m
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: "SMB"
        condition: selection
      fields:
        - rule.name
        - event.count

  # Type 4: Impact Assessment
  - question: Were any scheduled tasks successfully created on the target system?
    context: Successful AT service usage results in scheduled task creation that could execute malicious commands.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - "at.exe"
            - "schtasks.exe"
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ParentImage

  - question: What processes were spawned by the Task Scheduler service after this activity?
    context: Scheduled tasks executing malicious payloads indicate successful compromise via AT service.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          ParentImage|contains:
            - "taskeng.exe"
            - "svchost.exe"
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  # Type 5: Forensic Deep-Dive
  - question: What files were accessed or created through scheduled task execution?
    context: Malicious scheduled tasks often deploy additional malware or access sensitive files.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          file.path|contains:
            - "\\Windows\\Tasks\\"
            - "\\Windows\\System32\\Tasks\\"
        condition: selection
      fields:
        - file.path
        - file.name
        - User
        - file.hash.md5

  - question: Are there signs of persistence mechanisms being established via scheduled tasks?
    context: Attackers often use scheduled tasks to maintain persistent access to compromised systems.
    range: +24h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          CommandLine|contains:
            - "schtasks"
            - "/create"
            - "/sc"
        condition: selection
      fields:
        - User
        - CommandLine
        - Image
        - ProcessGuid

  # Type 6: Enterprise Correlation
  - question: Are other systems showing similar AT service pipe access from the same source?
    context: Lateral movement campaigns often target multiple systems using the same scheduling techniques.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name: "ET INFO SMB Remote AT Scheduled Job Pipe Creation"
        condition: selection
      fields:
        - dst_ip
        - event.count

  - question: Is this part of a broader SMB-based lateral movement campaign?
    context: Understanding campaign scope helps prioritize response and identify additional compromised systems.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "SMB"
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - event.count