name: ET WEB_SPECIFIC_APPS ELF file magic encoded ASCII Inbound Web Servers Likely Command Execution 4
id: 22025732
description: |
  Detects encoded ELF file magic bytes in web traffic, indicating potential command execution attempts.
  May trigger on legitimate file uploads or encoded content, but often indicates web shell deployment or exploitation.
type: detection
detection_id: 2025732
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete encoded payload containing the ELF magic bytes?
    context: Decoding the full payload reveals the actual binary content and exploitation method.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.body.content
        - http.request.method
        - url.full
        - http.request.headers

  - question: What specific web application endpoint was targeted?
    context: Understanding the target endpoint helps identify vulnerable applications and attack vectors.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.path
        - url.query
        - http.request.method
        - dst_port

  # Type 2: Triage Assessment
  - question: Is this normal file upload activity for this web application?
    context: Legitimate applications may handle binary files, but ELF uploads are unusual for most web services.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|expand: '%dst_port%'
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.request.method
        - http.response.status_code

  - question: Does this align with documented maintenance or deployment activities?
    context: Scheduled deployments might involve binary uploads, but should be from authorized sources.
    range: -1d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|expand: '%dst_port%'
        condition: selection
      fields:
        - src_ip
        - bytes_toserver
        - bytes_toclient

  # Type 3: Activity Context
  - question: What preceded this upload attempt on the same connection?
    context: Understanding the attack sequence helps identify the initial compromise vector.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.response.status_code
        - http.request.body.content

  - question: Were there reconnaissance activities from this source IP?
    context: Attackers often scan for vulnerabilities before exploitation attempts.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - url.path
        - http.response.status_code
        - http.request.method

  # Type 4: Impact Assessment
  - question: Did the web server successfully process this upload?
    context: HTTP response codes indicate whether the malicious payload was accepted and processed.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - bytes_toclient

  - question: Are there signs of command execution or web shell activity after this upload?
    context: Successful uploads may be followed by command execution attempts or web shell access.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.request.method
        - http.request.body.content

  # Type 5: Forensic Deep-Dive
  - question: What type of ELF binary was being uploaded based on the decoded content?
    context: Different ELF types indicate various attack purposes - backdoors, privilege escalation tools, or cryptominers.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.body.content
        - http.request.headers.content-type
        - http.request.headers.content-length

  - question: Are there other encoded payloads or obfuscation techniques in use?
    context: Sophisticated attacks often use multiple encoding layers or obfuscation methods.
    range: +/-1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.full
        - http.request.body.content
        - http.request.method

  # Type 6: Enterprise Correlation
  - question: Are other web servers receiving similar encoded ELF uploads?
    context: Coordinated attacks often target multiple systems with the same payload or technique.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: "*ELF file magic encoded*"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name