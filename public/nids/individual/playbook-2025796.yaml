name: ET EXPLOIT Generic system shell command to php base64 encoded Remote Code Execution 2
id: 22025796
description: |
  Detects base64 encoded system shell commands being passed to PHP for execution (variant 2).
  The pattern "N5c3RlbSgiIHBoc" decodes to system commands targeting PHP execution.
  May trigger on legitimate applications that execute system commands through PHP interfaces.
type: detection
detection_id: 2025796
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What is the complete base64 encoded system command payload in this variant?
    context: This variant may use different encoding patterns to evade detection while executing system commands.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.body.content
        - http.request.method
        - url.full
        - rule.name

  - question: What system commands are revealed after decoding this specific variant pattern?
    context: Different encoding variants may reveal different command structures or execution methods.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.request.body.content
        - http.request.headers
        - url.path

  - question: How does this variant differ from other encoded command injection patterns?
    context: Understanding pattern variations helps identify the attack tool or technique being used.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "system shell command"
        condition: selection
      fields:
        - rule.name
        - dst_ip

  # Type 2: Triage Assessment
  - question: Is this the same attacker using different encoding variants for evasion?
    context: Multiple variants from the same source may indicate automated attack tools or persistence attempts.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.request.method
        - http.response.status_code

  - question: Does this variant target the same PHP application as previous attempts?
    context: Repeated targeting of the same application suggests focused exploitation attempts.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains: .php
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.request.method

  # Type 3: Activity Context
  - question: What attack progression led to using this encoding variant?
    context: Understanding the attack sequence reveals whether this is escalation or evasion.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.request.body.content

  - question: What defensive measures or blocks preceded this variant attempt?
    context: Attackers may switch variants after initial attempts are blocked or detected.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.response.status_code|contains:
            - 403
            - 404
            - 500
        condition: selection
      fields:
        - url.path
        - http.response.status_code

  # Type 4: Impact Assessment
  - question: Was this variant more successful than previous encoding attempts?
    context: Comparing response patterns helps determine which variants successfully bypassed defenses.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - bytes_toclient

  - question: Did this variant result in successful system command execution?
    context: Process creation events indicate whether the variant successfully executed system commands.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - cmd
            - bash
            - sh
            - system
        condition: selection
      fields:
        - User
        - CommandLine
        - ProcessGuid

  # Type 5: Forensic Deep-Dive
  - question: What persistence mechanisms were established using this variant technique?
    context: Successful variant exploitation may lead to establishing more sophisticated persistence.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetFilename|contains:
            - .php
            - .sh
            - .bat
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessGuid

  - question: What additional attack tools were deployed after successful variant execution?
    context: Variant success often leads to deploying additional tools or establishing command channels.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - protocol
        - bytes_toserver

  # Type 6: Enterprise Correlation
  - question: Are multiple encoding variants being used across different systems in the environment?
    context: Coordinated campaigns may use different variants to target various systems simultaneously.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Remote Code Execution"
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - rule.name