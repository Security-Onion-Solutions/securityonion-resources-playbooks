name: ET EXPLOIT php script double base64 encoded Remote Code Execution 3
id: 22025812
description: |
  Detects double base64 encoded PHP script execution in HTTP traffic targeting web servers.
  The pattern "MeW84UDNCb2ND" indicates multiple layers of encoding to evade detection.
  May trigger on legitimate applications using nested encoding for security or obfuscation.
type: detection
detection_id: 2025812
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What is the complete double base64 encoded payload detected in the HTTP traffic?
    context: Multiple encoding layers require careful decoding to reveal the actual malicious PHP script.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.body.content
        - http.request.method
        - url.full
        - rule.name

  - question: What PHP code is revealed after performing double base64 decoding?
    context: Double encoding is often used to hide malicious functions like eval, exec, or system calls.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.request.body.content
        - http.request.headers
        - url.path

  - question: Are there additional encoding layers or obfuscation techniques used?
    context: Sophisticated attacks may use multiple encoding methods to evade security controls.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.request.body.content
        - http.request.headers
        - url.query

  # Type 2: Triage Assessment
  - question: Is double base64 encoding part of this application's normal security mechanisms?
    context: Some applications use multiple encoding layers for legitimate security or data protection.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains:
            - .php
            - /secure
            - /encrypted
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.request.method

  - question: Does the source IP have authorized access to execute encoded scripts on this server?
    context: Legitimate administrators may use encoded scripts for secure remote management.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - protocol
        - bytes_toserver

  # Type 3: Activity Context
  - question: What attack vector or vulnerability enabled this double-encoded script injection?
    context: Understanding the exploitation method reveals the security weakness being leveraged.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.request.body.content

  - question: What reconnaissance or probing activity preceded this encoded attack?
    context: Attackers often perform reconnaissance to identify vulnerable PHP applications before exploitation.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.request.method
        - http.response.status_code

  # Type 4: Impact Assessment
  - question: Did the web server successfully process the double-encoded PHP payload?
    context: Server response patterns indicate whether the complex encoding was properly decoded and executed.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - bytes_toclient

  - question: Are there signs of successful code execution following the encoded script injection?
    context: Process creation events indicate whether the decoded PHP script successfully executed system commands.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - php
            - apache
            - nginx
        condition: selection
      fields:
        - User
        - CommandLine
        - ProcessGuid

  # Type 5: Forensic Deep-Dive
  - question: What persistent backdoors or web shells were deployed using the double-encoded technique?
    context: Sophisticated encoding methods often indicate advanced persistent threat deployment.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetFilename|contains:
            - .php
            - .phtml
            - shell
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessGuid

  - question: What data exfiltration or command and control activities followed the compromise?
    context: Advanced encoding techniques often precede sophisticated post-exploitation activities.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - protocol
        - bytes_toserver

  # Type 6: Enterprise Correlation
  - question: Are other systems being targeted with similar double-encoding attack techniques?
    context: Advanced encoding methods may indicate a sophisticated campaign targeting multiple assets.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "double base64 encoded"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name