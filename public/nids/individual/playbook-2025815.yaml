name: ET EXPLOIT php script double base64 encoded Remote Code Execution 6
id: 22025815
description: |
  Detects PHP scripts with double base64 encoded content that may contain remote code execution payloads.
  The specific pattern "4cVBEOXdhSEFn" indicates obfuscated malicious code targeting web applications.
  May trigger on legitimate applications using base64 encoding for data transmission.
type: detection
detection_id: 2025815
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete HTTP request containing the double base64 encoded payload?
    context: Understanding the full request reveals the attack vector and target application.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.body.content
        - http.request.method
        - url.full
        - http.request.headers

  - question: What does the base64 encoded content decode to when processed twice?
    context: Double base64 encoding is used to obfuscate malicious PHP code and evade detection.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.request.body.content
        - http.response.status_code
        - http.response.body.content

  - question: Is this web server known to legitimately use base64 encoded PHP content?
    context: Some applications may use base64 encoding for legitimate data processing or configuration.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|expand: '%dst_port%'
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.request.method

  - question: What other HTTP requests occurred from this source IP around the same time?
    context: Attackers often perform reconnaissance or multiple exploitation attempts in sequence.
    range: -15m/+15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - url.full
        - http.request.method
        - http.response.status_code

  - question: Did the web server execute the potentially malicious PHP code?
    context: Successful exploitation would result in code execution and potential system compromise.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - 'php'
            - 'apache'
            - 'nginx'
            - 'httpd'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  - question: Were any files created or modified on the web server after this request?
    context: Successful RCE often results in webshell creation or system file modification.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          file.extension|contains:
            - 'php'
            - 'jsp'
            - 'asp'
            - 'aspx'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size

  - question: Did the web server make any outbound connections after processing this request?
    context: Compromised servers often establish reverse shells or download additional payloads.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - bytes_in

  - question: What is the reputation and geolocation of the attacking IP address?
    context: Understanding attacker infrastructure helps assess threat level and attribution.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - src_ip
        - geoip.country_name
        - threat_intel.reputation

  - question: Are there signs of lateral movement from the potentially compromised web server?
    context: Successful web application compromise often leads to internal network reconnaissance.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 22
            - 23
            - 135
            - 139
            - 445
            - 3389
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out

  - question: Have other systems in the network received similar double base64 encoded attacks?
    context: Coordinated attacks often target multiple web applications simultaneously.
    range: -1h/+1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'double base64 encoded'
        condition: selection
      fields:
        - dst_ip
        - src_ip
        - rule.name

  - question: Is this attack pattern part of a broader campaign against the organization?
    context: Multiple exploitation attempts may indicate persistent threat actor activity.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains: 'EXPLOIT'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - rule.category