name: ET WEB_SPECIFIC_APPS ELF file magic encoded Base64 Hex Escape Inbound Web Servers Likely Command Execution 8
id: 22025865
description: |
  Detects Base64 encoded ELF file magic bytes in HTTP traffic to web servers.
  May indicate web shell upload or command injection attempts targeting Linux systems.
  Could also trigger on legitimate file uploads containing binary data.
type: detection
detection_id: 2025865
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete HTTP request containing the encoded ELF magic bytes?
    context: Understanding the full request reveals the attack vector and target application.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - http.request.body.content
        - user_agent.original

  - question: Is this a legitimate file upload to an authorized application?
    context: Some applications allow binary file uploads that could contain ELF headers legitimately.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          http.request.method: POST
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.request.body.bytes

  - question: What other suspicious activity occurred from this source IP around the same time?
    context: Command injection attempts often involve multiple reconnaissance or exploitation attempts.
    range: +/-2h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - dst_port

  - question: What processes were spawned on the target server after this request?
    context: Successful command injection would result in process execution on the target system.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  - question: Were any files written to the web server following this request?
    context: ELF file uploads often result in executable files being written to disk.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          file.mime_type|contains:
            - 'application/x-executable'
            - 'application/octet-stream'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size

  - question: What network connections were established from the target server after this alert?
    context: Successful exploitation often leads to reverse shells or data exfiltration connections.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.bytes_sent
        - network.bytes_received

  - question: Has this encoded pattern been seen targeting other web servers?
    context: Attackers often use the same payloads against multiple targets in campaigns.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: "ET WEB_SPECIFIC_APPS ELF file magic encoded Base64 Hex Escape*"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: What is the geolocation and reputation of the source IP address?
    context: External threat intelligence helps assess the likelihood of malicious intent.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - src_ip
        - geoip.country_name
        - threat.indicator.type

  - question: What web application or service was targeted by this request?
    context: Understanding the target application helps assess vulnerability and impact.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - dst_port
        - url.path
        - http.request.headers

  - question: Are there signs of successful command execution on the target system?
    context: Evidence of command execution confirms successful exploitation versus attempted attack.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - 'sh'
            - 'bash'
            - 'python'
            - 'perl'
        condition: selection
      fields:
        - CommandLine
        - ParentImage
        - User

  - question: Has this attack pattern been observed from other source IPs in the enterprise?
    context: Coordinated attacks often involve multiple source IPs targeting similar vulnerabilities.
    range: +/-7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "ELF file magic encoded"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name