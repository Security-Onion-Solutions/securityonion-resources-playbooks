name: ET WEB_SPECIFIC_APPS ELF file magic encoded Base64 Hex Escape Inbound Web Servers Likely Command Execution 9
id: 22025866
description: |
  Detects another variant of Base64 encoded ELF file magic bytes in HTTP traffic.
  Indicates potential web shell upload or command injection targeting Linux systems.
  May trigger on legitimate binary file transfers or encoded content.
type: detection
detection_id: 2025866
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the exact encoded payload and HTTP request details?
    context: Analyzing the specific encoding variant helps identify the attack tool or method used.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - http.request.body.content
        - http.request.headers

  - question: Is this part of normal application functionality for this destination?
    context: Some web applications legitimately handle encoded binary data in their operations.
    range: -14d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|expand: '%dst_port%'
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.request.method

  - question: What preceded this request in the same TCP session?
    context: Understanding the session context reveals if this is part of a multi-step attack.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.request.method
        - url.path
        - http.response.status_code

  - question: Did the target server execute any suspicious processes after this request?
    context: Successful command injection results in process spawning on the compromised system.
    range: +45m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - User

  - question: Were any executable files created on the target system?
    context: ELF payloads often result in malicious executables being written to disk.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.extension

  - question: What outbound network activity originated from the target server?
    context: Compromised systems often establish reverse connections or exfiltrate data.
    range: +3h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.protocol
        - network.bytes_sent

  - question: Are there other ELF magic byte detections from this source IP?
    context: Attackers often try multiple encoding variants when initial attempts fail.
    range: +/-6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "ELF file magic"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - dst_port

  - question: What is the threat intelligence profile of the attacking IP?
    context: External reputation data helps determine if this is a known malicious source.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - geoip.country_name
        - geoip.asn.organization
        - threat.indicator.type

  - question: What web application components were targeted in this attack?
    context: Identifying the target application helps assess vulnerability and required patches.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.path
        - url.query
        - http.request.referrer

  - question: Did the server respond with any error codes indicating exploitation attempts?
    context: HTTP response codes can indicate whether the attack succeeded or failed.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes
        - http.response.body.content

  - question: Are there similar attack patterns across other enterprise web servers?
    context: Coordinated attacks often target multiple systems with the same vulnerability.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: "ET WEB_SPECIFIC_APPS ELF file magic encoded*"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name