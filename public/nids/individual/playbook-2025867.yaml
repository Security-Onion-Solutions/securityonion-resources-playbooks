name: ET WEB_SPECIFIC_APPS ELF file magic encoded Base64 Hex Escape Inbound Web Servers Likely Command Execution 10
id: 22025867
description: |
  Detects a third variant of Base64 encoded ELF file magic bytes in web traffic.
  Suggests persistent attempts to upload malicious executables or exploit command injection.
  Could be triggered by legitimate encoded binary content in web applications.
type: detection
detection_id: 2025867
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What is the decoded content of this specific ELF magic byte variant?
    context: Decoding the payload reveals the exact binary being transmitted and its purpose.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.body.content
        - http.request.method
        - url.full
        - content_length

  - question: Is this web server authorized to receive binary file uploads?
    context: Understanding legitimate business use helps distinguish attacks from normal operations.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          http.request.method|contains:
            - POST
            - PUT
        condition: selection
      fields:
        - src_ip
        - url.path
        - user_agent.original

  - question: What sequence of requests led to this encoded payload transmission?
    context: Multi-stage attacks often involve reconnaissance followed by exploitation attempts.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - http.request.method
        - url.path
        - http.response.status_code
        - user_agent.original

  - question: What system processes were initiated following this request?
    context: Successful exploitation typically results in command execution on the target system.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentCommandLine
        - User
        - ProcessGuid

  - question: Were any suspicious files written to the web server filesystem?
    context: ELF payloads often result in malicious executables being dropped on the target system.
    range: +45m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.sha256
        - file.size
        - file.mime_type

  - question: What network connections were established by the compromised server?
    context: Post-exploitation activity often involves establishing command and control channels.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.protocol
        - network.bytes_sent
        - network.bytes_received

  - question: How many different ELF encoding variants has this attacker attempted?
    context: Persistent attackers often cycle through multiple encoding methods to bypass detection.
    range: +/-12h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "ELF file magic"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - alert.signature_id

  - question: What is the origin and reputation profile of the attacking source?
    context: Geolocation and threat intelligence data helps assess the threat actor profile.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - geoip.country_name
        - geoip.city_name
        - threat.indicator.confidence

  - question: Which specific web application endpoint was targeted?
    context: Understanding the target helps identify the vulnerable component requiring patching.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.path
        - url.query
        - url.fragment
        - dst_port

  - question: Did the target server exhibit signs of successful command execution?
    context: Evidence of shell activity confirms whether the exploitation attempt succeeded.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - 'bash'
            - 'sh'
            - 'cmd'
            - 'powershell'
        condition: selection
      fields:
        - CommandLine
        - ParentImage
        - User
        - ProcessId

  - question: Are there coordinated attacks against multiple enterprise web servers?
    context: Understanding campaign scope helps prioritize response and identify additional compromised systems.
    range: +/-48h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "ELF file magic encoded"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - alert.severity