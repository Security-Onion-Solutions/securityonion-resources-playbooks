name: ET WEB_SPECIFIC_APPS ELF file magic plain Inbound Web Servers Likely Command Execution 11
id: 22025868
description: |
  Detects plain (unencoded) ELF file magic bytes in HTTP traffic to web servers.
  Indicates direct binary upload attempts or command injection with raw ELF executables.
  May trigger on legitimate binary file uploads or software deployment activities.
type: detection
detection_id: 2025868
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What is the complete raw ELF binary being transmitted in this request?
    context: Analyzing the raw binary reveals the malware type and intended functionality.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.body.content
        - http.request.method
        - url.full
        - http.request.body.bytes

  - question: Is this a legitimate software deployment or file upload process?
    context: Some applications legitimately transfer binary executables as part of normal operations.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|expand: '%dst_port%'
          http.request.method: POST
        condition: selection
      fields:
        - src_ip
        - url.path
        - user_agent.original
        - http.request.body.bytes

  - question: What authentication context surrounds this binary upload attempt?
    context: Legitimate uploads typically occur within authenticated sessions with proper authorization.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - http.request.headers
        - http.response.status_code
        - url.path

  - question: What processes were spawned on the target server after this upload?
    context: Successful malware uploads typically result in immediate or delayed process execution.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - User
        - ProcessGuid

  - question: Where was this ELF binary written on the target filesystem?
    context: Understanding file placement helps assess persistence mechanisms and cleanup requirements.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          file.mime_type: 'application/x-executable'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.hash.sha256
        - file.size

  - question: What network connections were initiated from the compromised system?
    context: Malware often establishes command and control or data exfiltration connections post-infection.
    range: +6h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.protocol
        - network.bytes_sent
        - community_id

  - question: Has this attacker attempted other binary upload methods?
    context: Attackers often try multiple techniques when initial attempts are blocked or detected.
    range: +/-8h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "ELF file magic"
            - "Command Execution"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - alert.signature_id

  - question: What is the threat profile and geolocation of the attacking source?
    context: Source analysis helps determine if this is a targeted attack or opportunistic scanning.
    range: +/-6h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - geoip.country_name
        - geoip.asn.organization
        - threat.indicator.type
        - threat.indicator.confidence

  - question: Which web application component accepted this binary upload?
    context: Identifying the vulnerable endpoint helps prioritize patching and hardening efforts.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.path
        - url.query
        - dst_port
        - http.request.referrer

  - question: Are there indicators of successful malware execution on the target?
    context: Evidence of malicious activity confirms compromise and guides incident response priorities.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          CommandLine|contains:
            - 'wget'
            - 'curl'
            - 'nc'
            - '/bin/sh'
        condition: selection
      fields:
        - CommandLine
        - Image
        - ParentCommandLine
        - User

  - question: How widespread is this binary upload campaign across the enterprise?
    context: Understanding attack scope helps identify all compromised systems requiring remediation.
    range: +/-72h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "ELF file magic plain"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - alert.severity

  - question: What defensive measures successfully blocked or detected this attack?
    context: Understanding detection effectiveness helps improve security controls and response procedures.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - rule.name
        - alert.action
        - alert.signature_id