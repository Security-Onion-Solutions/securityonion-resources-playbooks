name: ET EXPLOIT Mikrotik Winbox RCE Attempt (CVE-2018-14847)
id: 22025972
description: |
  Detects exploitation attempts against Mikrotik RouterOS via Winbox protocol (CVE-2018-14847).
  This vulnerability allows unauthorized file access and remote code execution on network equipment.
  Often exploited for cryptojacking campaigns and network infrastructure compromise.
type: detection
detection_id: 2025972
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete Winbox exploit payload targeting the user.dat file?
    context: Analyzing the full payload reveals the file path traversal technique and target configuration files.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - flow_id
        - packet_info

  - question: What network connection was used for this Mikrotik router exploitation?
    context: Connection details help identify attack infrastructure targeting network equipment.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_port
        - dst_port
        - proto
        - conn_state
        - duration

  # Type 2: Triage Assessment
  - question: Is this a legitimate Mikrotik router with Winbox management enabled?
    context: Confirming router presence validates the exploitation attempt against network infrastructure.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 8291
            - 80
            - 443
        condition: selection
      fields:
        - src_ip
        - dst_port
        - orig_bytes
        - resp_bytes

  - question: Are there authorized administrative connections to this router?
    context: Legitimate network administration may access routers, but this exploit pattern is malicious.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 8291
        condition: selection
      fields:
        - src_ip
        - orig_bytes
        - resp_bytes
        - conn_state

  # Type 3: Activity Context
  - question: What network reconnaissance preceded this router exploitation attempt?
    context: Attackers typically scan for Mikrotik services before launching targeted exploits.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 8291
            - 80
            - 443
            - 22
            - 23
        condition: selection
      fields:
        - dst_port
        - conn_state
        - orig_bytes
        - resp_bytes

  - question: What other network equipment attacks occurred from this source?
    context: Router exploitation campaigns often target multiple network devices for infrastructure control.
    range: -4h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'Router'
            - 'Network'
            - 'Infrastructure'
            - 'Mikrotik'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - alert.signature

  - question: What was the timeline of network scanning before this targeted attack?
    context: Understanding reconnaissance patterns helps identify the attack methodology and scope.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          conn_state: 'SF'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - orig_bytes
        - resp_bytes

  # Type 4: Impact Assessment
  - question: Did the router respond with configuration data after the exploit attempt?
    context: Response patterns indicate whether sensitive router configuration was successfully accessed.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - orig_bytes
        - resp_bytes
        - conn_state
        - duration

  - question: Are there signs of router configuration changes after the exploit?
    context: Successful exploitation may result in unauthorized configuration modifications or backdoors.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 8291
            - 22
            - 23
        condition: selection
      fields:
        - src_ip
        - orig_bytes
        - resp_bytes
        - conn_state

  # Type 5: Forensic Deep-Dive
  - question: What exploitation tools were used to target this Mikrotik router?
    context: Identifying attack tools helps understand threat actor capabilities and router targeting methods.
    range: -4h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'mikrotik'
            - 'winbox'
            - 'routeros'
            - 'exploit'
            - '8291'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ParentImage

  - question: Has cryptomining or other malicious software been deployed to the router?
    context: Mikrotik exploits are commonly used for cryptojacking campaigns targeting network equipment.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 3333
            - 4444
            - 8080
            - 14444
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - orig_bytes
        - resp_bytes

  - question: What sensitive router files were accessed during the exploitation?
    context: Understanding accessed files reveals the scope of configuration data compromise.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - 'file'
            - 'access'
            - 'configuration'
        condition: selection
      fields:
        - rule.name
        - src_ip
        - alert.signature

  # Type 6: Enterprise Correlation
  - question: Are other Mikrotik routers in the network being targeted by this attacker?
    context: Router exploitation campaigns often target multiple network devices for infrastructure control.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: 'Mikrotik'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - alert.signature

  - question: Is this part of a broader network infrastructure compromise campaign?
    context: Understanding campaign scope helps assess risk to network security and operations.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 8291
            - 22
            - 23
            - 80
            - 443
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - orig_bytes
        - resp_bytes