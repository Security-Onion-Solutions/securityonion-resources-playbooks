name: ET MALWARE NCSC XAgent itwm beacon v1
id: 22026438
description: |
  Detects XAgent malware using specific itwm parameter beaconing pattern in HTTP requests.
  May trigger on legitimate web applications using similar parameter structures.
type: detection
detection_id: 2026438
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the exact itwm parameter value and complete URL structure?
    context: The itwm parameter contains encoded beacon data that reveals XAgent communication patterns.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.full
        - url.query
        - http.request.method
        - http.request.headers
  - question: Is this parameter pattern part of legitimate web application functionality?
    context: Some web applications may use similar parameter naming conventions for tracking or analytics.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.query|contains: 'itwm'
        condition: selection
      fields:
        - url.domain
        - url.path
        - http.request.headers.user_agent
  - question: What other HTTP requests with similar patterns occurred from this source?
    context: Multiple itwm parameter requests indicate sustained XAgent C2 communication rather than isolated event.
    range: -2h/+2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.query|contains: 'itwm'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.response.status_code
  - question: Has this destination received similar beacon requests from other internal hosts?
    context: Multiple internal sources using itwm beacons suggests widespread XAgent deployment across network.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.query|contains: 'itwm'
        condition: selection
      fields:
        - src_ip
        - url.domain
        - url.query
  - question: What process was responsible for generating the HTTP request with itwm parameter?
    context: Process identification distinguishes between XAgent malware and legitimate application requests.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          process.command_line|contains:
            - 'http'
            - 'curl'
            - 'wget'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - User
  - question: What was the server response to the itwm beacon request?
    context: XAgent C2 responses may contain commands or configuration data for the malware.
    range: -15m/+15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.query|contains: 'itwm'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes
        - http.response.headers
  - question: Are there file system changes indicating XAgent payload execution?
    context: XAgent may create temporary files or modify system files following successful C2 communication.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          event.action|contains:
            - 'created'
            - 'modified'
        condition: selection
      fields:
        - file.path
        - file.name
        - file.hash.md5
        - process.name
  - question: What registry modifications occurred around the time of itwm beacon activity?
    context: XAgent may update registry for persistence or configuration storage after C2 communication.
    range: -30m/+30m
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - registry.path
        - registry.value
        - registry.data
        - process.name
  - question: What DNS resolution occurred for the destination hosting the itwm beacon endpoint?
    context: DNS queries reveal XAgent C2 infrastructure and potential domain generation algorithms.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          dns.resolved_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.resolved_ip
  - question: Are other systems in the network showing XAgent itwm beacon patterns?
    context: Enterprise correlation reveals scope of XAgent deployment and APT28 campaign targeting.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'XAgent'
            - 'itwm'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
  - question: What additional APT28 indicators correlate with this XAgent itwm beacon activity?
    context: Cross-referencing with other APT28 TTPs provides complete picture of threat actor campaign.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'APT28'
            - 'targeted-activity'
            - 'NCSC'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - rule.category