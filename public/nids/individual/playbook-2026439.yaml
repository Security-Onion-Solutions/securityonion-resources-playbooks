name: ET MALWARE NCSC XAgent itwm beacon v2
id: 22026439
description: |
  Detects XAgent malware using itwm parameter in URL query string with ampersand prefix.
  May trigger on legitimate web applications with similar parameter naming conventions.
type: detection
detection_id: 2026439
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete URL with the itwm parameter and its encoded value?
    context: The itwm parameter value contains XAgent beacon identifier that reveals malware instance and campaign.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.full
        - url.query
        - http.request.method
        - url.path
  - question: Is this itwm parameter usage consistent with legitimate application behavior?
    context: Web applications may use similar tracking parameters, requiring analysis of context and frequency.
    range: -14d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.query|contains: 'itwm'
        condition: selection
      fields:
        - url.domain
        - url.path
        - http.request.headers.user_agent
        - http.response.status_code
  - question: What sequence of HTTP requests preceded and followed this itwm beacon?
    context: XAgent beacon timing and sequencing patterns distinguish malware C2 from legitimate web traffic.
    range: -1h/+1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.response.status_code
        - bytes_in
  - question: Are multiple internal hosts using similar itwm beacon patterns to this destination?
    context: Coordinated itwm beaconing across multiple hosts indicates enterprise-wide XAgent deployment.
    range: -48h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.query|contains: '&itwm'
        condition: selection
      fields:
        - src_ip
        - url.domain
        - url.query
  - question: What application or process generated the HTTP request containing the itwm parameter?
    context: Process analysis determines if XAgent malware or legitimate software initiated the beacon request.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - process.working_directory
  - question: What data was transmitted in the HTTP response to the itwm beacon?
    context: XAgent C2 server responses may contain tasking, configuration updates, or additional payloads.
    range: -15m/+15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.query|contains: '&itwm'
        condition: selection
      fields:
        - http.response.body.bytes
        - http.response.status_code
        - http.response.headers.content_type
  - question: Are there file modifications or creations following the itwm beacon communication?
    context: XAgent may execute received commands or drop additional files after successful C2 communication.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          event.action|contains:
            - 'created'
            - 'modified'
            - 'deleted'
        condition: selection
      fields:
        - file.path
        - file.name
        - file.size
        - process.name
  - question: What registry changes occurred in correlation with the itwm beacon activity?
    context: XAgent may modify registry for persistence, configuration storage, or execution tracking.
    range: -1h/+1h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - registry.path
        - registry.value
        - registry.data
        - event.action
  - question: What DNS queries resolved the destination IP for the itwm beacon endpoint?
    context: DNS resolution patterns reveal XAgent C2 infrastructure and potential domain rotation techniques.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          dns.resolved_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.resolved_ip
  - question: Are there other XAgent variant detections across the enterprise network?
    context: Multiple XAgent detection variants indicate comprehensive APT28 campaign with different beacon methods.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'XAgent'
            - 'itwm beacon'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
  - question: What broader APT28 campaign indicators correlate with this itwm beacon detection?
    context: Correlating XAgent activity with other APT28 TTPs reveals full scope of threat actor operations.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'APT28'
            - 'targeted-activity'
            - 'Exfiltration_Over_C2_Channel'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - mitre_technique_id