name: ET SCAN StarDotStar HELO, suspected AUTH LOGIN botnet
id: 22026463
description: |
  Detects suspicious SMTP HELO command with "*.*" pattern indicating potential botnet activity.
  May trigger on legitimate mail servers with unusual hostname configurations.
type: detection
detection_id: 2026463
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete SMTP HELO command and session details?
    context: The HELO "*.*" pattern is characteristic of botnet mail relay attempts with generic hostnames.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - src_ip
        - dst_ip
        - dst_port
  - question: Is this a legitimate mail server with unusual hostname configuration?
    context: Some mail servers may use generic or placeholder hostnames during testing or misconfiguration.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 25
            - 587
            - 465
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - duration
  - question: What other SMTP activity has originated from this external source?
    context: Additional SMTP connections reveal if this is isolated incident or sustained botnet mail relay activity.
    range: -24h/+24h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 25
            - 587
            - 465
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - protocol
  - question: Are multiple external IPs attempting similar HELO patterns to our mail servers?
    context: Coordinated botnet activity typically involves multiple source IPs using similar SMTP relay techniques.
    range: -48h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'StarDotStar HELO'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
  - question: What mail server processes handled the suspicious HELO connection?
    context: Mail server process analysis reveals if connection reached authentication or was blocked.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          process.name|contains:
            - 'sendmail'
            - 'postfix'
            - 'exim'
            - 'smtp'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
  - question: Were there successful SMTP authentication attempts following the HELO command?
    context: Successful authentication after suspicious HELO indicates compromised credentials or botnet success.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 25
            - 587
            - 465
        condition: selection
      fields:
        - bytes_out
        - bytes_in
        - duration
        - protocol
  - question: Are there mail delivery attempts or queued messages from this source?
    context: Actual mail delivery indicates successful botnet relay rather than just reconnaissance activity.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          file.path|contains:
            - 'mail'
            - 'queue'
            - 'spool'
        condition: selection
      fields:
        - file.path
        - file.name
        - file.size
        - event.action
  - question: What authentication logs show attempts from this external IP?
    context: Authentication attempts reveal if botnet is trying credential stuffing or brute force attacks.
    range: -1h/+1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          process.command_line|contains:
            - 'auth'
            - 'login'
            - 'smtp'
        condition: selection
      fields:
        - process.command_line
        - User
        - process.name
  - question: What DNS queries were made by the external IP before SMTP connection?
    context: DNS activity may reveal if botnet performed MX record lookups or targeted specific mail servers.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.query.type_name|contains:
            - 'MX'
            - 'A'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.resolved_ip
  - question: Are other mail servers in the organization experiencing similar botnet activity?
    context: Enterprise-wide SMTP scanning indicates coordinated botnet campaign targeting mail infrastructure.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'botnet'
            - 'SMTP'
            - 'HELO'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
  - question: What related botnet or spam indicators appear across the enterprise?
    context: Correlating SMTP botnet activity with other spam or botnet detections reveals campaign scope.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'botnet'
            - 'spam'
            - 'bad-unknown'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - rule.category