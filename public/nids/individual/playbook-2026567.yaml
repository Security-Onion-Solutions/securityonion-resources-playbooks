name: ET EXPLOIT Possible CVE-2018-4407 - Apple ICMP DoS PoC
id: 22026567
description: |
  Detects potential exploitation of CVE-2018-4407, a denial-of-service vulnerability in Apple's XNU kernel.
  The vulnerability allows remote attackers to cause kernel panic via malformed ICMP packets.
  May trigger on legitimate ICMP parameter problem messages containing similar patterns.
type: detection
detection_id: 2026567
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact ICMP payload content that triggered this alert?
    context: Analyzing the specific payload helps confirm if this matches known CVE-2018-4407 exploit patterns.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - icmp.type
        - icmp.code
        - packet_info.linktype

  - question: What are the source and destination details of this ICMP traffic?
    context: Understanding traffic flow helps determine if this is targeted exploitation or broadcast scanning.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_mac
        - dst_mac
        - vlan

  # Type 2: Triage Assessment
  - question: Is this source IP known to generate legitimate ICMP traffic in the environment?
    context: Legitimate network diagnostic tools may generate ICMP parameter problem messages.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          proto: ICMP
        condition: selection
      fields:
        - dst_ip
        - community_id

  - question: Are there any Apple devices on the target network segment that could be vulnerable?
    context: CVE-2018-4407 specifically affects Apple devices running vulnerable XNU kernel versions.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - proto

  # Type 3: Activity Context
  - question: What network activity preceded this ICMP exploit attempt?
    context: Attackers often perform reconnaissance before launching DoS attacks.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto
        - conn_state

  - question: Was this part of a larger ICMP flood or scanning campaign?
    context: CVE-2018-4407 exploits may be part of broader DoS campaigns targeting multiple hosts.
    range: -30m/+30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          proto: ICMP
        condition: selection
      fields:
        - dst_ip
        - community_id

  # Type 4: Impact Assessment
  - question: Did any target systems show signs of instability or crashes after this exploit attempt?
    context: Successful CVE-2018-4407 exploitation typically results in kernel panic and system restart.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  - question: Are there indicators of successful denial-of-service on the target network?
    context: Monitoring connection patterns helps assess if the DoS attack was effective.
    range: +15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - conn_state
        - proto

  # Type 5: Forensic Deep-Dive
  - question: What is the attack pattern signature in the ICMP packet structure?
    context: Detailed packet analysis helps confirm exploit variant and potential evasion techniques.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "CVE-2018-4407"
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - payload
        - packet_info.linktype
        - icmp.type
        - icmp.code

  - question: Are there other CVE-2018-4407 exploitation attempts from this source?
    context: Persistent exploitation attempts indicate coordinated attack campaigns.
    range: -24h/+2h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "CVE-2018-4407"
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - severity

  # Type 6: Enterprise Correlation
  - question: Are other network segments experiencing similar ICMP-based DoS attempts?
    context: Enterprise-wide correlation helps identify coordinated DoS campaigns.
    range: -1h/+1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "CVE-2018-4407"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name