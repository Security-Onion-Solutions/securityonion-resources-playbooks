name: ET MALWARE Perl/Shellbot.SM IRC CnC Checkin
id: 22026579
description: |
  Detects Perl/Shellbot.SM malware communicating with IRC command and control servers.
  The malware joins IRC channels and sends system information including processor details and user context.
  May rarely trigger on legitimate IRC bots that send similar system information patterns.
type: detection
detection_id: 2026579
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What specific IRC commands and system information was transmitted in this communication?
    context: Analyzing the complete IRC session reveals the malware's information gathering capabilities.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - http.request.body.content
        - flow.bytes_toserver

  - question: What system details did the Shellbot attempt to exfiltrate?
    context: Understanding exfiltrated data helps assess information disclosure impact.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - payload

  # Type 2: Triage Assessment
  - question: Is this IRC traffic part of legitimate administrative or development activities?
    context: Some environments use IRC for legitimate automation or monitoring purposes.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 6667
            - 6697
            - 7000
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto

  - question: Does this host typically communicate with IRC servers?
    context: Baseline IRC activity helps distinguish malware from legitimate IRC usage.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 6667
            - 6697
            - 7000
        condition: selection
      fields:
        - dst_ip
        - community_id

  # Type 3: Activity Context
  - question: What process initiated this IRC communication?
    context: Identifying the parent process helps determine infection vector and persistence mechanism.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  - question: What network connections were established before this IRC session?
    context: Previous connections may reveal initial infection vector or C2 infrastructure.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto
        - conn_state

  # Type 4: Impact Assessment
  - question: Has the infected system established additional command and control channels?
    context: Shellbot malware often maintains multiple C2 connections for redundancy.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 6667
            - 6697
            - 7000
            - 8080
            - 443
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - community_id

  - question: Are there signs of remote command execution following this IRC checkin?
    context: IRC bots typically receive and execute commands after successful checkin.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  # Type 5: Forensic Deep-Dive
  - question: What is the complete IRC session flow and commands exchanged?
    context: Full session analysis reveals bot capabilities and operator commands.
    range: -5m/+30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - flow.bytes_toserver
        - flow.bytes_toclient

  - question: Are there file system artifacts indicating Shellbot persistence mechanisms?
    context: Perl shellbots often create startup scripts or modify system configuration files.
    range: -1h/+1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.mime_type

  # Type 6: Enterprise Correlation
  - question: Are other systems in the environment infected with similar Shellbot variants?
    context: Shellbot campaigns often target multiple systems within the same network.
    range: -2h/+2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Shellbot"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is this IRC server being used by multiple infected systems as a C2 channel?
    context: Identifying shared C2 infrastructure helps scope the campaign impact.
    range: -24h/+2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|expand: '%dst_port%'
        condition: selection
      fields:
        - src_ip
        - community_id