name: ET MALWARE AveMaria Initial CnC Checkin
id: 22026736
description: |
  Detects AveMaria malware initial command and control checkin communication.
  This 12-byte signature indicates successful malware installation and C2 establishment.
  AveMaria is a stealer malware targeting credentials and system information.
type: detection
detection_id: 2026736
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact 12-byte checkin pattern sent to the C2 server?
    context: The specific hex pattern confirms AveMaria malware initial communication protocol.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - alert.signature
        - network.bytes
        - network.protocol

  - question: What is the complete C2 connection establishing this checkin?
    context: Understanding the full connection details helps identify AveMaria infrastructure.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_port
        - dst_port
        - network.bytes
        - network.packets

  # Type 2: Triage Assessment
  - question: Is this system typically used for activities requiring external connections?
    context: AveMaria targets endpoint systems, unusual for servers to show this activity.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          network.direction: "outbound"
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.protocol

  - question: Has this C2 server been contacted by other internal systems?
    context: AveMaria campaigns often involve multiple infected endpoints.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          network.direction: "outbound"
        condition: selection
      fields:
        - src_ip
        - dst_port
        - network.bytes

  # Type 3: Activity Context
  - question: What was the infection vector that led to this AveMaria checkin?
    context: Understanding how AveMaria was delivered helps prevent future infections.
    range: -4h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - user.name

  - question: What email or web activity preceded this malware execution?
    context: AveMaria is commonly delivered via phishing emails or malicious downloads.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.response.status_code
        - user_agent.original

  - question: What DNS queries were made before establishing the C2 connection?
    context: AveMaria may use domain generation algorithms or specific C2 domains.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.question.name
        - dns.resolved_ip
        - dns.question.type

  # Type 4: Impact Assessment
  - question: What credential harvesting activity occurred after the C2 checkin?
    context: AveMaria is a stealer malware that targets stored credentials and browser data.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.path|contains:
            - "AppData"
            - "Cookies"
            - "Login Data"
            - "Passwords"
        condition: selection
      fields:
        - file.path
        - file.name
        - event.action
        - process.name

  - question: What data exfiltration occurred following the initial checkin?
    context: AveMaria typically exfiltrates stolen data back to the C2 server.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          network.direction: "outbound"
        condition: selection
      fields:
        - dst_port
        - network.bytes
        - network.packets
        - network.protocol

  # Type 5: Forensic Deep-Dive
  - question: What AveMaria persistence mechanisms were established on the system?
    context: Understanding persistence helps with complete malware removal.
    range: +/-1h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          registry.path|contains:
            - "Run"
            - "RunOnce"
            - "CurrentVersion"
        condition: selection
      fields:
        - registry.path
        - registry.value
        - registry.data
        - process.name

  - question: What system information was collected by AveMaria?
    context: AveMaria gathers extensive system information for reconnaissance.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          process.name|contains:
            - "systeminfo"
            - "whoami"
            - "net"
            - "ipconfig"
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - user.name

  - question: What additional malware components were downloaded after checkin?
    context: AveMaria may download additional payloads or updates from the C2.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method: "GET"
        condition: selection
      fields:
        - url.full
        - http.response.status_code
        - http.response.body.bytes

  # Type 6: Enterprise Correlation
  - question: Are other systems showing AveMaria infections across the network?
    context: AveMaria campaigns often target multiple endpoints simultaneously.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: "AveMaria"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature

  - question: What related stealer malware activity appears enterprise-wide?
    context: AveMaria campaigns may involve multiple malware families.
    range: +/-7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.category: "trojan-activity"
          alert.signature|contains: "Stealer"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature