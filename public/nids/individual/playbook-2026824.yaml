name: ET MALWARE AtomLogger Exfil via FTP
id: 22026824
description: |
  Detects AtomLogger malware exfiltrating keylogger data and system information via FTP.
  The signature identifies specific data format including username, machine details, and keystroke logs.
  This indicates active credential theft and system monitoring.
type: detection
detection_id: 2026824
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete system information format being exfiltrated?
    context: The specific format with username, machine name, OS, IP, and keystrokes confirms AtomLogger data structure.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - alert.signature
        - network.protocol
        - network.bytes

  - question: What is the FTP server receiving the keylogger data?
    context: Identifying the exfiltration destination helps understand the threat infrastructure.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_port
        - dst_port
        - network.bytes
        - network.packets

  # Type 2: Triage Assessment
  - question: Is FTP usage normal for this user and system?
    context: Legitimate FTP usage helps distinguish between authorized and malicious activity.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 21
          network.direction: "outbound"
        condition: selection
      fields:
        - dst_ip
        - network.bytes
        - network.protocol

  - question: Does this system handle sensitive data that would attract keyloggers?
    context: Understanding system role helps assess the significance of keylogger deployment.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          process.name|contains:
            - "outlook"
            - "chrome"
            - "firefox"
            - "notepad"
        condition: selection
      fields:
        - process.name
        - user.name

  # Type 3: Activity Context
  - question: What processes were running when the keylogger data was exfiltrated?
    context: Identifying the malware process helps understand execution context.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - user.name

  - question: What system reconnaissance was performed before data collection?
    context: AtomLogger gathers system information for the exfiltration report.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          process.name|contains:
            - "systeminfo"
            - "whoami"
            - "ipconfig"
            - "hostname"
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - user.name

  - question: What files were accessed or created during the keylogging period?
    context: Understanding data collection helps assess the scope of information theft.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          event.action|contains:
            - "created"
            - "modified"
        condition: selection
      fields:
        - file.path
        - file.name
        - process.name
        - event.action

  # Type 4: Impact Assessment
  - question: How much keylogger data was exfiltrated during this session?
    context: Data volume helps assess the duration and scope of keystroke monitoring.
    range: +/-30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 21
        condition: selection
      fields:
        - network.bytes
        - network.packets
        - network.protocol

  - question: What applications were being monitored by the keylogger?
    context: AtomLogger captures keystrokes from various applications including browsers and email clients.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          process.name|contains:
            - "chrome"
            - "firefox"
            - "outlook"
            - "notepad"
            - "winword"
        condition: selection
      fields:
        - process.name
        - user.name

  # Type 5: Forensic Deep-Dive
  - question: What persistence mechanisms did AtomLogger establish?
    context: Understanding persistence helps with complete malware removal.
    range: +/-2h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          registry.path|contains:
            - "Run"
            - "RunOnce"
            - "Services"
        condition: selection
      fields:
        - registry.path
        - registry.value
        - registry.data
        - process.name

  - question: What keylogger files were created on the system?
    context: AtomLogger typically creates log files before exfiltration.
    range: +/-2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.extension|contains:
            - "log"
            - "txt"
            - "dat"
        condition: selection
      fields:
        - file.path
        - file.name
        - file.size
        - event.action

  - question: What credential harvesting occurred alongside keylogging?
    context: AtomLogger may also target stored passwords and browser credentials.
    range: +/-1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.path|contains:
            - "AppData"
            - "Passwords"
            - "Login Data"
            - "Cookies"
        condition: selection
      fields:
        - file.path
        - file.name
        - event.action
        - process.name

  - question: What network reconnaissance was performed by the malware?
    context: Keylogger malware often performs network discovery for additional targets.
    range: +/-1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          process.name|contains:
            - "ping"
            - "nslookup"
            - "arp"
            - "netstat"
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name

  # Type 6: Enterprise Correlation
  - question: Are other systems showing AtomLogger activity across the network?
    context: Keylogger malware campaigns often target multiple endpoints simultaneously.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: "AtomLogger"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature

  - question: What other keylogger or data exfiltration attempts appear enterprise-wide?
    context: Coordinated data theft campaigns may use multiple keylogger variants.
    range: +/-7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.category: "trojan-activity"
          alert.signature|contains:
            - "Logger"
            - "Keylog"
            - "Exfil"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature