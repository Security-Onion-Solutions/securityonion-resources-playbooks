name: ET MALWARE Py/MechaFlounder CnC Activity - Reporting Directory Change Command Success
id: 22027053
description: |
  Detects MechaFlounder malware reporting successful directory change command execution to C&C server.
  The hex pattern "2A2A6469726563746F7279206368616E6765642073756363657373" decodes to "**directory changed success".
  This indicates the malware has successfully navigated the file system and may be preparing for data collection.
type: detection
detection_id: 2027053
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact directory change success message sent to the C&C server?
    context: Understanding the complete payload reveals the malware's file system navigation capabilities and current location.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.body.content
        - http.response.body.content
        - rule.name

  - question: What directory paths was the malware attempting to access based on surrounding HTTP traffic?
    context: Directory change commands often include target paths, revealing what data the malware is seeking to access.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - http.request.body.content
        - url.path
        - http.request.method

  # Type 2: Triage Assessment
  - question: Is this system normally accessed for file system navigation or administration?
    context: Distinguishing between malicious directory traversal and legitimate system administration activities.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - cmd.exe
            - powershell
            - explorer.exe
        condition: selection
      fields:
        - User
        - CommandLine
        - ProcessId

  - question: Are there scheduled tasks or legitimate processes that perform directory operations?
    context: Regular system maintenance or backup processes might generate similar directory navigation patterns.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - cd
            - dir
            - ls
            - chdir
        condition: selection
      fields:
        - Image
        - User
        - CommandLine
        - ProcessGuid

  # Type 3: Activity Context
  - question: What directory-related commands preceded this successful directory change?
    context: Understanding the sequence of directory operations reveals the malware's exploration pattern and objectives.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - MechaFlounder
            - directory
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.category

  - question: What file system access occurred after this successful directory change?
    context: Directory changes typically precede file access attempts, revealing what data the malware targeted.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - ProcessName
        - file.size

  - question: What process executed the directory change command that generated this success message?
    context: Identifying the parent process helps determine if this is malware execution or legitimate system activity.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - python
            - py
            - cmd
        condition: selection
      fields:
        - CommandLine
        - ProcessGuid
        - User
        - ParentImage

  # Type 4: Impact Assessment
  - question: What sensitive directories or files were accessed following this directory change?
    context: Successful directory navigation may lead to access of confidential data, requiring impact assessment.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - Documents
            - Desktop
            - Downloads
            - AppData
        condition: selection
      fields:
        - TargetFilename
        - ProcessName
        - file.hash.md5

  - question: Are there signs of data collection or enumeration activities after directory access?
    context: Directory changes often precede data harvesting operations in malware attack chains.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - MALWARE
            - INFO
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.category

  # Type 5: Forensic Deep-Dive
  - question: What Python processes were running that could have executed directory change commands?
    context: MechaFlounder is Python-based, so identifying Python processes helps confirm malware execution context.
    range: +/-2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - python
            - py
        condition: selection
      fields:
        - CommandLine
        - ProcessGuid
        - User
        - ParentCommandLine

  - question: Are there any malicious Python scripts or files created around this timeframe?
    context: Directory navigation success may indicate malware deployment or script execution requiring forensic analysis.
    range: +/-4h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.extension|contains:
            - py
            - pyc
            - pyo
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessName

  - question: What registry changes occurred that might indicate persistence or configuration updates?
    context: Successful malware operations often involve registry modifications for persistence or operational configuration.
    range: +/-2h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessName

  # Type 6: Enterprise Correlation
  - question: Are other systems showing similar directory navigation patterns from MechaFlounder?
    context: Coordinated directory traversal across multiple systems suggests systematic network reconnaissance.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - MechaFlounder
            - directory
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is this part of a broader Chafer campaign showing file system reconnaissance across the enterprise?
    context: Directory changes may be part of systematic data discovery operations across multiple enterprise systems.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - Chafer
            - MechaFlounder
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.category