name: ET MALWARE [AV] EarthWorm/Termite IoT Agent Reporting Infection
id: 22027064
description: |
  Detects EarthWorm/Termite malware IoT agent reporting successful infection to C&C server.
  The binary pattern includes specific byte sequences and "agent" string indicating malware check-in.
  This malware targets IoT devices and establishes tunneling capabilities for lateral movement.
type: detection
detection_id: 2027064
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact binary payload that triggered this EarthWorm/Termite detection?
    context: Understanding the complete binary pattern reveals the malware's communication protocol and infection confirmation format.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - rule.name

  - question: What specific IoT device characteristics are revealed in the agent reporting?
    context: Agent reports often include device information that helps identify the compromised IoT system type and capabilities.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port|expand: '%dst_port%'
        condition: selection
      fields:
        - connection.bytes_sent
        - connection.bytes_received
        - src_port

  # Type 2: Triage Assessment
  - question: Is this IP address associated with known IoT devices in the network inventory?
    context: Confirming IoT device identity helps distinguish between legitimate device communications and malware infections.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection.protocol

  - question: Are there legitimate device management or monitoring systems that communicate with this device?
    context: IoT devices often have legitimate management traffic that could be confused with malware communications.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - connection.protocol

  # Type 3: Activity Context
  - question: What initial compromise or vulnerability exploitation preceded this agent infection?
    context: Understanding the attack vector helps identify how the IoT device was initially compromised and infected.
    range: -6h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - EXPLOIT
            - SCAN
            - ATTACK
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.severity

  - question: What network scanning or reconnaissance occurred before the infection report?
    context: IoT malware often performs network discovery before establishing agent communications with C&C servers.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - SCAN
            - RECON
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.category

  - question: Are there signs of lateral movement or tunneling setup after the agent report?
    context: EarthWorm/Termite specializes in creating network tunnels for lateral movement after initial infection.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection.bytes_sent
        - connection.bytes_received

  - question: What other IoT devices or internal systems were contacted after infection confirmation?
    context: Malware agent reports often trigger additional reconnaissance or lateral movement activities.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|contains: 192.168
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection.protocol

  # Type 4: Impact Assessment
  - question: What network segments or internal resources are accessible from this compromised IoT device?
    context: Compromised IoT devices can provide access to internal networks, requiring assessment of potential lateral movement paths.
    range: +6h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection.state

  - question: Are there signs of data exfiltration or command execution capabilities being established?
    context: Agent infections may lead to data theft or remote command execution, requiring impact assessment.
    range: +8h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - MALWARE
            - TROJAN
            - COMMAND
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.severity

  # Type 5: Forensic Deep-Dive
  - question: What specific EarthWorm/Termite malware variant is present based on communication patterns?
    context: Different variants have distinct capabilities and persistence mechanisms requiring targeted remediation approaches.
    range: +/-4h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - EarthWorm
            - Termite
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.category

  - question: Are there persistent connections or backdoor mechanisms established by the malware?
    context: IoT malware often establishes persistent backdoors requiring detailed analysis for complete removal.
    range: +/-8h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          connection.state: established
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection.duration

  - question: What tunneling or proxy capabilities has the malware established?
    context: EarthWorm/Termite creates network tunnels that require forensic analysis to understand full network impact.
    range: +/-6h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 1080
            - 8080
            - 3128
            - 9050
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection.bytes_sent
        - connection.bytes_received

  # Type 6: Enterprise Correlation
  - question: Are other IoT devices in the network showing similar infection patterns?
    context: IoT malware often spreads laterally to other vulnerable devices, requiring enterprise-wide assessment.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - EarthWorm
            - Termite
            - IoT
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is this part of a broader botnet or coordinated IoT compromise campaign?
    context: Multiple IoT infections may indicate botnet recruitment or systematic network compromise requiring coordinated response.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.category|contains:
            - MALWARE
            - TROJAN
        condition: selection
      fields:
        - src_ip
        - rule.name
        - rule.category