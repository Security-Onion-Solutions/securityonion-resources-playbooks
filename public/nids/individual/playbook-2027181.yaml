name: ET INFO WMIC WMI Request Over SMB - Likely Lateral Movement (wmic.exe string)
id: 22027181
description: |
  Detects the literal "wmic.exe" string transmitted over SMB protocol, indicating potential lateral movement attempts.
  This rule identifies unencoded references to the WMIC executable in SMB traffic, which may occur during
  remote command execution or legitimate administrative file transfers.
type: detection
detection_id: 2027181
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete SMB communication containing the literal wmic.exe string?
    context: The full SMB session context reveals whether this is file transfer, command execution, or other activity.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_port
        - dst_port
        - community_id
        - rule.name

  - question: What SMB operation type contained the wmic.exe reference?
    context: Different SMB operations (file access, execution, enumeration) indicate different attack vectors.
    range: +/-5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
          dst_port: 445
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - bytes_toserver
        - bytes_toclient

  # Type 2: Triage Assessment
  - question: Is this wmic.exe reference related to legitimate file operations?
    context: Administrators may legitimately copy or access WMIC executable files for system management.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetFilename|contains: 'wmic.exe'
        condition: selection
      fields:
        - User
        - TargetFilename
        - ProcessName

  - question: Does the source system typically perform administrative file transfers?
    context: Administrative workstations may legitimately transfer system tools via SMB.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 445
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver

  # Type 3: Activity Context
  - question: What preceded this SMB activity with wmic.exe references?
    context: Previous authentication or reconnaissance activity may indicate the attack progression.
    range: -20m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'net use'
            - 'copy'
            - 'xcopy'
            - 'robocopy'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  - question: What authentication context exists for this SMB session?
    context: The user context and authentication method help determine if this is authorized activity.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'net.exe'
            - 'psexec.exe'
            - 'wmic.exe'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine

  # Type 4: Impact Assessment
  - question: Was the wmic.exe file successfully transferred or executed on the target?
    context: Successful file operations indicate potential system compromise or legitimate administration.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetFilename|contains: 'wmic'
        condition: selection
      fields:
        - User
        - TargetFilename
        - ProcessName

  - question: Did WMIC execution occur on the target system after this SMB activity?
    context: Subsequent WMIC execution confirms successful lateral movement or tool deployment.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains: 'wmic.exe'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  # Type 5: Forensic Deep-Dive
  - question: What specific file paths were accessed during this wmic.exe SMB activity?
    context: File paths reveal the deployment strategy and persistence mechanisms used by attackers.
    range: +/-10m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetFilename|contains:
            - 'wmic'
            - 'temp'
            - 'system32'
        condition: selection
      fields:
        - User
        - TargetFilename
        - ProcessName

  - question: Are there signs of additional tool deployment alongside wmic.exe?
    context: Attackers often deploy multiple tools simultaneously for comprehensive system access.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetFilename|contains:
            - '.exe'
            - 'psexec'
            - 'mimikatz'
            - 'powershell'
        condition: selection
      fields:
        - User
        - TargetFilename
        - file.hash.md5

  # Type 6: Enterprise Correlation
  - question: Are other systems receiving similar wmic.exe file transfers?
    context: Multiple systems with similar file transfers indicate a coordinated deployment campaign.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'wmic.exe'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is this part of a broader SMB-based tool deployment across the network?
    context: Coordinated tool deployment often precedes large-scale lateral movement campaigns.
    range: +/-6h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 445
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - bytes_toclient