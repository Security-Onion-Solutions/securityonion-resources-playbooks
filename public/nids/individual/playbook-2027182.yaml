name: ET INFO WMIC WMI Request Over SMB - Likely Lateral Movement (wmic command)
id: 22027182
description: |
  Detects "wmic " command strings transmitted over SMB protocol, indicating potential lateral movement.
  This rule identifies WMIC command execution attempts in SMB traffic, which may indicate remote
  WMI command execution or legitimate administrative activities involving WMI queries.
type: detection
detection_id: 2027182
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete WMIC command detected in the SMB traffic?
    context: The full command reveals the specific WMI operation being performed and its intent.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_port
        - dst_port
        - community_id
        - rule.name

  - question: What SMB session context contained the WMIC command string?
    context: Understanding the SMB operation type helps determine if this is command execution or data transfer.
    range: +/-5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
          dst_port: 445
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - bytes_toserver
        - bytes_toclient

  # Type 2: Triage Assessment
  - question: Is this WMIC command part of documented administrative procedures?
    context: System administrators may legitimately use WMIC commands for remote system management.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains: 'wmic'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine

  - question: Does the source system have authorized administrative access to the target?
    context: Legitimate administrative relationships may explain authorized WMIC usage over SMB.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 445
            - 135
            - 139
        condition: selection
      fields:
        - dst_port
        - timestamp

  # Type 3: Activity Context
  - question: What process initiated the WMIC command on the source system?
    context: The parent process and execution context help distinguish between legitimate and malicious usage.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains: 'wmic'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid

  - question: What authentication or connection establishment preceded this activity?
    context: Recent authentication events may indicate credential compromise or legitimate administrative access.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'net use'
            - 'psexec'
            - '/user:'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine

  # Type 4: Impact Assessment
  - question: Did the WMIC command successfully execute on the target system?
    context: Successful execution indicates potential system compromise or completion of administrative tasks.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - 'wmic.exe'
            - 'WmiPrvSE.exe'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  - question: What additional processes were spawned after the WMIC command?
    context: Subsequent process creation may indicate successful remote code execution or administrative tasks.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ParentImage

  # Type 5: Forensic Deep-Dive
  - question: What specific WMI classes and methods were invoked by the command?
    context: Specific WMI operations reveal the attacker's intent and the scope of system access.
    range: +20m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          CommandLine|contains:
            - 'Win32_Process'
            - 'Win32_Service'
            - 'process call create'
            - 'get'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine

  - question: Are there indicators of persistence or credential harvesting activities?
    context: WMIC can be used to establish persistence mechanisms or gather system credentials.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          CommandLine|contains:
            - 'startup'
            - 'service create'
            - 'useraccount'
            - 'loggedonuser'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  # Type 6: Enterprise Correlation
  - question: Are other systems experiencing similar WMIC command activity over SMB?
    context: Multiple systems with similar patterns indicate a coordinated lateral movement campaign.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'WMIC'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is this part of a broader WMI-based attack campaign across the organization?
    context: Coordinated WMI attacks often involve multiple systems and various WMI-based techniques.
    range: +/-6h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          CommandLine|contains:
            - 'wmic'
            - 'Win32_'
            - 'WmiPrvSE'
        condition: selection
      fields:
        - host.ip
        - User
        - Image
        - CommandLine