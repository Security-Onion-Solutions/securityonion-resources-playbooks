name: ET INFO Ipconfig Command in SMB Traffic - Possible Lateral Movement
id: 22027186
description: |
  Detects Unicode-encoded ipconfig command execution over SMB protocol, indicating network configuration reconnaissance with obfuscation during lateral movement.
  May trigger on legitimate network troubleshooting but often indicates malicious network mapping with encoding to evade detection.
type: detection
detection_id: 2027186
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete Unicode-encoded ipconfig command and parameters?
    context: Unicode encoding may indicate obfuscation attempts to evade detection during network reconnaissance.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - smb.command
        - payload
        - smb.path

  - question: What network configuration information was gathered through the encoded command?
    context: Understanding reconnaissance scope reveals network topology knowledge and potential pivot points.
    range: -15m/+15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains: 'ipconfig.exe'
        condition: selection
      fields:
        - CommandLine
        - User
        - ProcessGuid
        - ParentImage

  # Type 2: Triage Assessment
  - question: Is this Unicode-encoded command execution part of legitimate administration?
    context: Unicode encoding in administrative tools is uncommon and may indicate advanced malicious activity.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - 'ipconfig.exe'
            - 'netsh.exe'
        condition: selection
      fields:
        - User
        - CommandLine
        - ParentImage
        - ProcessGuid

  - question: Does the source system have a history of Unicode-encoded SMB commands?
    context: Establishing encoding patterns helps distinguish legitimate tools from malicious obfuscation techniques.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: 'SMB Traffic'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - rule.category

  # Type 3: Activity Context
  - question: What SMB authentication and session establishment preceded this encoded command?
    context: Understanding session context reveals credential usage and sophisticated attack progression.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - src_port
        - network.bytes
        - network.duration
        - network.protocol

  - question: What process or advanced tool initiated the SMB session with Unicode encoding?
    context: Parent process identification helps determine if this is sophisticated malware or APT tool usage.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'psexec'
            - 'wmic'
            - 'powershell'
            - 'cobalt'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  # Type 4: Impact Assessment
  - question: What additional encoded or obfuscated reconnaissance commands followed ipconfig?
    context: Unicode encoding may be part of broader obfuscation strategy across multiple reconnaissance commands.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          CommandLine|contains:
            - 'netstat'
            - 'whoami'
            - 'net'
            - 'arp'
        condition: selection
      fields:
        - CommandLine
        - User
        - Image
        - ProcessGuid

  - question: Did the network reconnaissance lead to lateral movement to discovered network segments?
    context: Successful network mapping typically results in expansion to newly identified subnets and systems.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.bytes
        - network.protocol

  # Type 5: Forensic Deep-Dive
  - question: What specific network topology and IP ranges were discovered through encoded reconnaissance?
    context: Network configuration details reveal attack surface expansion and potential critical asset identification.
    range: -15m/+30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - 'ipconfig.exe'
            - 'netsh.exe'
            - 'route.exe'
        condition: selection
      fields:
        - CommandLine
        - ProcessGuid
        - ParentProcessGuid

  - question: Are there indicators of advanced persistent threat tools using Unicode obfuscation?
    context: Unicode encoding combined with network reconnaissance may indicate sophisticated threat actor techniques.
    range: -30m/+30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - 'powershell.exe'
            - 'cmd.exe'
        condition: selection
      fields:
        - CommandLine
        - User
        - ProcessGuid
        - ParentProcessGuid

  # Type 6: Enterprise Correlation
  - question: Are other systems experiencing similar Unicode-encoded network reconnaissance via SMB?
    context: Coordinated obfuscated reconnaissance indicates advanced threat actor campaign across the enterprise.
    range: -2h/+2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'Ipconfig Command in SMB Traffic'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is this Unicode obfuscation part of a broader advanced campaign from the same threat actor?
    context: Understanding campaign scope and sophisticated techniques helps attribute attacks and predict next phases.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'SMB'
            - 'Lateral Movement'
            - 'Command'
            - 'Unicode'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - rule.category