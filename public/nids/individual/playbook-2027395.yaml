name: ET MALWARE Linux/HiddenWasp CnC Request (set)
id: 22027395
description: |
  Detects Linux/HiddenWasp malware command and control communication patterns.
  This sophisticated Linux malware uses steganography and rootkit capabilities for persistence.
  May rarely trigger on legitimate applications using similar binary patterns.
type: detection
detection_id: 2027395
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact binary pattern that triggered the HiddenWasp detection?
    context: The specific byte sequence reveals the malware's communication protocol structure.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - rule.name
        - alert.signature

  - question: What process initiated this outbound connection to the external server?
    context: Identifying the source process helps determine infection vector and scope.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port|expand: '%dst_port%'
        condition: selection
      fields:
        - src_port
        - bytes_out
        - bytes_in
        - duration

  # Type 2: Triage Assessment
  - question: Is this connection from a system that normally communicates with external servers?
    context: Baseline network behavior helps distinguish malicious from legitimate outbound connections.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - count

  - question: Are there any scheduled tasks or cron jobs that could explain this activity?
    context: HiddenWasp often uses legitimate scheduling mechanisms for persistence.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'cron'
            - 'systemd'
            - 'at'
        condition: selection
      fields:
        - CommandLine
        - User
        - ParentImage

  # Type 3: Activity Context
  - question: What network activity preceded this CnC communication?
    context: Understanding the attack chain helps identify initial compromise vector.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_in
        - bytes_out

  - question: Were there any recent file modifications or downloads on this system?
    context: HiddenWasp deployment often involves downloading additional components.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          EventID: 11
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessName

  # Type 4: Impact Assessment
  - question: Has the malware established persistence mechanisms on the infected system?
    context: HiddenWasp uses various persistence techniques including service installation.
    range: -4h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'systemctl'
            - 'service'
            - 'chkconfig'
            - 'update-rc.d'
        condition: selection
      fields:
        - CommandLine
        - User
        - ProcessGuid

  - question: Are there signs of data collection or reconnaissance activity?
    context: HiddenWasp performs extensive system reconnaissance before data exfiltration.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'ps'
            - 'netstat'
            - 'lsof'
            - 'who'
            - 'w'
        condition: selection
      fields:
        - CommandLine
        - User
        - ParentImage

  # Type 5: Forensic Deep-Dive
  - question: What is the communication frequency and pattern with the CnC server?
    context: HiddenWasp's beacon pattern reveals operational status and command polling intervals.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - count
        - bytes_out
        - bytes_in

  - question: Are there any hidden files or directories created by the malware?
    context: HiddenWasp uses steganography and hidden file techniques for concealment.
    range: -6h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - '/tmp/.'
            - '/var/tmp/.'
            - '/dev/shm/.'
        condition: selection
      fields:
        - TargetFilename
        - file.size
        - ProcessName

  # Type 6: Enterprise Correlation
  - question: Are other Linux systems in the network showing similar CnC communication patterns?
    context: HiddenWasp campaigns often target multiple systems in the same environment.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'HiddenWasp'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - count

  - question: Is there evidence of lateral movement or privilege escalation attempts?
    context: Advanced persistent threats like HiddenWasp often expand their foothold across networks.
    range: -4h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'ssh'
            - 'scp'
            - 'sudo'
            - 'su'
        condition: selection
      fields:
        - CommandLine
        - User
        - ParentProcessGuid