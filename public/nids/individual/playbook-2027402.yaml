name: ET MALWARE Executable contained in DICOM Medical Image SMB File Transfer
id: 22027402
description: |
  Detects Windows executable files hidden within DICOM medical images transferred via SMB.
  This technique exploits trust in medical imaging systems to bypass security controls.
  Legitimate DICOM files should not contain executable code.
type: detection
detection_id: 2027402
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What is the complete file path and name of the malicious DICOM file?
    context: The filename and path reveal the attack vector and intended target system.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - smb.filename
        - smb.path
        - rule.name

  - question: What are the characteristics of the embedded executable within the DICOM file?
    context: PE header analysis helps identify malware family and capabilities.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - file.size
        - file.hash.md5

  # Type 2: Triage Assessment
  - question: Is this SMB share commonly used for legitimate medical imaging workflows?
    context: Understanding normal DICOM file transfer patterns helps distinguish malicious activity.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - src_ip
        - bytes_in
        - count

  - question: Does the source system typically handle medical imaging data?
    context: Legitimate DICOM transfers should originate from medical imaging equipment or PACS systems.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 445
            - 104
            - 2104
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - count

  # Type 3: Activity Context
  - question: What SMB authentication and session activity preceded this file transfer?
    context: Authentication patterns reveal if the transfer used legitimate or compromised credentials.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - bytes_in
        - bytes_out
        - duration

  - question: Were there any other file transfers or network activity from this source?
    context: Attackers often transfer multiple files or perform reconnaissance before delivering payloads.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - protocol

  # Type 4: Impact Assessment
  - question: Has the malicious DICOM file been accessed or executed on the target system?
    context: File access patterns indicate if the malware payload has been activated.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetFilename|contains: '.dcm'
        condition: selection
      fields:
        - TargetFilename
        - ProcessName
        - EventID

  - question: Are there signs of process execution from the target directory?
    context: Executable extraction and execution from DICOM files indicates successful compromise.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid

  # Type 5: Forensic Deep-Dive
  - question: What medical imaging applications are installed on the target system?
    context: Understanding DICOM viewer software helps assess attack vector feasibility.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - 'dicom'
            - 'radiologist'
            - 'imaging'
            - 'viewer'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  - question: Are there registry modifications related to DICOM file associations?
    context: Malware may modify file associations to ensure automatic execution when DICOM files are opened.
    range: +6h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetObject|contains:
            - '.dcm'
            - 'DICOM'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessName

  - question: What network connections were established after the file transfer?
    context: Post-infection network activity reveals command and control or data exfiltration attempts.
    range: +12h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - bytes_in

  # Type 6: Enterprise Correlation
  - question: Are other systems receiving similar malicious DICOM files from the same source?
    context: Medical malware campaigns often target multiple systems in healthcare environments.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'DICOM'
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - count

  - question: Is there evidence of compromise in the medical imaging network infrastructure?
    context: DICOM malware attacks may indicate broader compromise of medical systems and PACS networks.
    range: -48h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_port|contains:
            - 104
            - 2104
            - 22104
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - count