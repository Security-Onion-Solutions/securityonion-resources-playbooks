name: ET MALWARE Executable contained in DICOM Medical Image PACS DICOM Protocol Transfer
id: 22027403
description: |
  Detects Windows executable files embedded within DICOM medical images transferred via PACS DICOM protocol.
  This attack exploits trust in medical imaging workflows to deliver malware through DICOM ports.
  Legitimate DICOM files should never contain PE executable headers.
type: detection
detection_id: 2027403
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What is the structure and metadata of the malicious DICOM file containing the executable?
    context: DICOM header analysis reveals how the executable was embedded and the attack sophistication.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - file.size
        - rule.name

  - question: What are the PE executable characteristics found within the DICOM image?
    context: PE header analysis helps identify malware family and intended system architecture.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - file.hash.md5
        - file.hash.sha256
        - alert.signature

  # Type 2: Triage Assessment
  - question: Is this DICOM port communication part of normal medical imaging operations?
    context: Understanding baseline DICOM traffic patterns helps distinguish malicious from legitimate transfers.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 104
            - 2104
            - 22104
        condition: selection
      fields:
        - src_ip
        - bytes_in
        - count

  - question: Does the source system match known PACS or medical imaging equipment?
    context: Legitimate DICOM transfers should originate from registered medical imaging devices.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 104
            - 2104
            - 22104
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - count

  # Type 3: Activity Context
  - question: What DICOM protocol handshake and negotiation occurred before the malicious transfer?
    context: DICOM protocol analysis reveals if the connection used legitimate medical imaging workflows.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port|expand: '%dst_port%'
        condition: selection
      fields:
        - bytes_in
        - bytes_out
        - duration
        - packets

  - question: Were there multiple DICOM file transfers or just this single malicious instance?
    context: Attack patterns help distinguish targeted attacks from opportunistic malware distribution.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 104
            - 2104
            - 22104
        condition: selection
      fields:
        - dst_ip
        - bytes_out
        - count

  # Type 4: Impact Assessment
  - question: Has the target system processed or opened the malicious DICOM file?
    context: File access patterns indicate if the embedded executable has been extracted or executed.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetFilename|contains: '.dcm'
        condition: selection
      fields:
        - TargetFilename
        - ProcessName
        - EventID

  - question: Are there signs of executable extraction or execution from the DICOM file?
    context: Process creation events reveal if the malware payload has been successfully activated.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - User

  # Type 5: Forensic Deep-Dive
  - question: What DICOM viewing or processing software is installed on the target system?
    context: Understanding DICOM applications helps assess the attack vector and potential for automatic execution.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - 'dicom'
            - 'pacs'
            - 'viewer'
            - 'imaging'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: Were there any system modifications or persistence mechanisms established?
    context: Advanced medical malware often establishes persistence to maintain access to valuable healthcare data.
    range: +6h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessName

  - question: What network communication patterns emerged after the DICOM file transfer?
    context: Post-infection network activity reveals command and control or data exfiltration attempts.
    range: +12h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - protocol

  # Type 6: Enterprise Correlation
  - question: Are other medical imaging systems receiving similar malicious DICOM files?
    context: Healthcare-targeted attacks often spread across medical imaging networks and PACS systems.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'DICOM'
          alert.signature|contains: 'Executable'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - count

  - question: Is there evidence of broader compromise in the medical network infrastructure?
    context: DICOM malware may indicate targeted attacks against healthcare organizations and patient data.
    range: -48h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_port|contains:
            - 104
            - 2104
            - 22104
            - 445
            - 3389
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - count