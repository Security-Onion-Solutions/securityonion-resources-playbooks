name: ET MALWARE Executable contained in DICOM Medical Image Received from PACS DICOM Device
id: 22027404
description: |
  Detects Windows executable files embedded within DICOM medical images received from PACS devices.
  This attack vector exploits the trusted nature of medical imaging equipment to deliver malware.
  Legitimate DICOM images from medical devices should never contain executable code.
type: detection
detection_id: 2027404
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What medical device or PACS system is the source of this malicious DICOM file?
    context: Identifying the compromised medical equipment helps assess the scope of the healthcare security breach.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - src_ip
        - src_port
        - rule.name

  - question: What are the embedded executable characteristics within the DICOM medical image?
    context: PE header analysis reveals the malware payload and helps identify the threat actor's capabilities.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - file.hash.md5
        - file.size

  # Type 2: Triage Assessment
  - question: Is this PACS device known to legitimately transmit DICOM images to this workstation?
    context: Understanding normal medical imaging workflows helps distinguish malicious from legitimate DICOM transfers.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          src_port|contains:
            - 104
            - 2104
            - 22104
        condition: selection
      fields:
        - bytes_out
        - count
        - duration

  - question: Does the timing align with scheduled medical imaging procedures or workflows?
    context: Medical imaging transfers typically follow predictable schedules aligned with clinical operations.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          src_port|contains:
            - 104
            - 2104
            - 22104
        condition: selection
      fields:
        - dst_ip
        - bytes_out
        - count

  # Type 3: Activity Context
  - question: What DICOM protocol communication preceded this malicious image transfer?
    context: DICOM handshake patterns reveal if the transfer followed legitimate medical imaging protocols.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          src_port|expand: '%src_port%'
        condition: selection
      fields:
        - bytes_in
        - bytes_out
        - packets
        - duration

  - question: Were there other network activities or file transfers from this PACS device?
    context: Compromised medical devices often exhibit unusual network behavior beyond normal imaging operations.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - protocol

  # Type 4: Impact Assessment
  - question: Has the receiving workstation processed or opened the malicious DICOM file?
    context: File access events indicate if the embedded malware has been extracted or executed.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetFilename|contains: '.dcm'
        condition: selection
      fields:
        - TargetFilename
        - ProcessName
        - EventID
        - User

  - question: Are there signs of malware execution or system compromise on the target workstation?
    context: Process creation events reveal if the malicious payload has been successfully activated.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid

  # Type 5: Forensic Deep-Dive
  - question: What DICOM viewing applications are installed on the target medical workstation?
    context: Understanding medical imaging software helps assess attack vector feasibility and automatic execution risks.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - 'dicom'
            - 'pacs'
            - 'radiology'
            - 'imaging'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  - question: Were there any system modifications or persistence mechanisms established after the transfer?
    context: Medical malware often establishes persistence to maintain access to valuable healthcare data and systems.
    range: +6h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessName

  - question: What network connections were initiated from the target system after receiving the malicious DICOM?
    context: Post-infection network activity reveals command and control communication or data exfiltration attempts.
    range: +12h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - bytes_in

  # Type 6: Enterprise Correlation
  - question: Are other medical workstations receiving similar malicious DICOM files from PACS devices?
    context: Healthcare-targeted attacks often spread across medical imaging networks and multiple workstations.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'DICOM'
          alert.signature|contains: 'PACS'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - count

  - question: Is there evidence of compromise in the broader medical network infrastructure?
    context: PACS device compromise may indicate sophisticated attacks targeting healthcare organizations and patient data.
    range: -48h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_port|contains:
            - 104
            - 2104
            - 22104
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - bytes_out
        - count