name: ET ATTACK_RESPONSE Windows 64bit procdump Dump File Exfiltration
id: 22027435
description: |
  Detects exfiltration of Windows process memory dumps created by procdump64.exe.
  This indicates potential credential harvesting or sensitive data theft from system memory.
  May trigger on legitimate forensic analysis or authorized memory dump transfers.
type: detection
detection_id: 2027435
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What is the exact procdump command line and target process that was dumped?
    context: The command parameters reveal which process was targeted and the attacker's intent.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains: 'procdump'
        condition: selection
      fields:
        - CommandLine
        - ParentImage
        - User
        - ProcessGuid

  - question: What is the size and destination of the exfiltrated dump file?
    context: File size and transfer details indicate the scope of potential data compromise.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - bytes_out
        - dst_ip
        - dst_port
        - rule.name

  # Type 2: Triage Assessment
  - question: Is this procdump execution part of authorized forensic analysis or system administration?
    context: Legitimate procdump usage should be documented and performed by authorized personnel.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          User|expand: '%User%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - LogonType

  - question: Does the user account have legitimate reasons to perform memory dumping operations?
    context: Memory dumping should only be performed by IT staff, security teams, or authorized forensic analysts.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          User|expand: '%User%'
        condition: selection
      fields:
        - Image
        - count

  # Type 3: Activity Context
  - question: What process was targeted for memory dumping and why might it contain sensitive data?
    context: Understanding the target process helps assess the potential impact and attacker motivation.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'lsass.exe'
            - 'winlogon.exe'
            - 'csrss.exe'
        condition: selection
      fields:
        - Image
        - ProcessId
        - User
        - CommandLine

  - question: What events preceded the procdump execution on this system?
    context: Understanding the attack chain helps identify initial compromise and privilege escalation methods.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - User

  # Type 4: Impact Assessment
  - question: Was the LSASS process or other credential-containing processes targeted for dumping?
    context: LSASS dumps contain cached credentials and are high-value targets for attackers.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'lsass'
            - '-ma'
            - 'winlogon'
        condition: selection
      fields:
        - CommandLine
        - User
        - ProcessGuid

  - question: Were there any file creation events for the memory dump before exfiltration?
    context: Dump file creation patterns reveal the staging location and potential for local analysis.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains: '.dmp'
        condition: selection
      fields:
        - TargetFilename
        - file.size
        - ProcessName

  # Type 5: Forensic Deep-Dive
  - question: What credential extraction tools were used after the memory dump creation?
    context: Post-dump analysis tools like Mimikatz indicate credential harvesting intent.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'mimikatz'
            - 'pypykatz'
            - 'sekurlsa'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: Were there any attempts to access or modify security-related registry keys?
    context: Registry modifications may indicate attempts to disable security controls or extract stored credentials.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - 'SAM'
            - 'SECURITY'
            - 'LSA'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessName

  - question: What network connections were established after the memory dump exfiltration?
    context: Post-exfiltration network activity may reveal command and control communication or lateral movement.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - protocol

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network showing similar procdump or credential dumping activity?
    context: Coordinated credential harvesting campaigns often target multiple systems simultaneously.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'procdump'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - count

  - question: Is there evidence of lateral movement or privilege escalation using potentially harvested credentials?
    context: Successful credential theft often leads to lateral movement and privilege escalation across the network.
    range: +12h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          CommandLine|contains:
            - 'net use'
            - 'psexec'
            - 'wmic'
            - 'powershell'
        condition: selection
      fields:
        - host.ip
        - CommandLine
        - User
        - ProcessGuid