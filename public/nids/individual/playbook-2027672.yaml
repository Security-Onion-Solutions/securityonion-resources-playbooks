name: ET MALWARE Godlua Backdoor Stage-3 Client Heartbeat (Jun 2019- Dec 2019)
id: 22027672
description: |
  Detects Godlua backdoor client heartbeat communications from infected internal hosts to external command and control servers.
  This specific variant was active from June 2019 to December 2019. Legitimate applications do not use this specific binary pattern.
type: detection
detection_id: 2027672
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact binary payload pattern that triggered this Godlua heartbeat detection?
    context: Understanding the specific heartbeat signature helps confirm malware variant and communication protocol.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - payload
        - alert.signature
        - flow.bytes_toserver

  - question: What is the complete network connection context for this Godlua communication?
    context: Connection metadata reveals C2 infrastructure and communication patterns used by the backdoor.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - flow.bytes_toserver
        - flow.bytes_toclient

  # Type 2: Triage Assessment
  - question: Is this source host known for legitimate high-port outbound connections?
    context: Godlua uses high ports (1024+) which may be normal for some applications, requiring baseline comparison.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|gte: 1024
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - flow.bytes_toserver

  - question: Are there any documented maintenance or administrative activities from this host during the alert timeframe?
    context: Confirming whether this activity aligns with scheduled operations or represents unauthorized backdoor communication.
    range: -1h/+1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  # Type 3: Activity Context
  - question: What process initiated this outbound connection on the infected host?
    context: Identifying the parent process helps determine infection vector and persistence mechanism.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid
        - User

  - question: What other network activity occurred from this host around the same time as the heartbeat?
    context: Understanding concurrent network activity reveals the full scope of backdoor communications and potential data exfiltration.
    range: -30m/+30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - flow.bytes_toserver
        - flow.bytes_toclient

  # Type 4: Impact Assessment
  - question: Has the Godlua backdoor established persistent command and control communication?
    context: Multiple heartbeats indicate active C2 channel and potential for remote command execution.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains: 'Godlua'
        condition: selection
      fields:
        - alert.signature
        - dst_ip
        - alert.severity

  - question: Are there signs of data exfiltration or command execution following this heartbeat?
    context: Heartbeats often precede malicious activities like data theft or lateral movement commands.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          flow.bytes_toserver|gte: 1024
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - flow.bytes_toserver
        - flow.bytes_toclient

  # Type 5: Forensic Deep-Dive
  - question: What specific Godlua malware components are present on the infected system?
    context: File analysis reveals malware persistence mechanisms and additional backdoor capabilities.
    range: -1d
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.name|contains:
            - 'lua'
            - 'god'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.hash.sha256
        - ProcessGuid

  - question: Are there registry modifications indicating Godlua persistence mechanisms?
    context: Godlua often uses registry entries for persistence and configuration storage.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - 'Run'
            - 'RunOnce'
            - 'Service'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessGuid

  # Type 6: Enterprise Correlation
  - question: Are other hosts in the network showing similar Godlua heartbeat patterns?
    context: Godlua campaigns often involve multiple infected hosts communicating with the same C2 infrastructure.
    range: -24h/+24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: 'Godlua Backdoor Stage-3 Client Heartbeat'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature

  - question: Is this part of a broader campaign targeting our organization's infrastructure?
    context: Correlating with other malware alerts helps identify coordinated attack campaigns.
    range: -7d/+1d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          alert.category|contains: 'trojan-activity'
        condition: selection
      fields:
        - src_ip
        - alert.signature
        - alert.severity