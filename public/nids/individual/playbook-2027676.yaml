name: ET MALWARE Godlua Backdoor Stage-3 Server Heartbeat Reply (Sep 2020 - Nov 2023)
id: 22027676
description: |
  Detects Godlua backdoor server heartbeat replies from external command and control servers to infected internal hosts.
  This latest variant was active from September 2020 to November 2023. Requires prior client heartbeat detection.
type: detection
detection_id: 2027676
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact binary payload pattern in the server heartbeat reply?
    context: Understanding the server response signature confirms active C2 communication and latest backdoor protocol version.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - payload
        - alert.signature
        - flow.bytes_toclient

  - question: What is the complete network connection context for this C2 server response?
    context: Connection metadata reveals the established C2 channel and confirms bidirectional communication.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_port
        - flow.bytes_toserver
        - flow.bytes_toclient

  # Type 2: Triage Assessment
  - question: Was there a corresponding client heartbeat that preceded this server reply?
    context: Server replies should follow client heartbeats, confirming legitimate C2 handshake versus false positive.
    range: -5m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          alert.signature|contains: 'Godlua Backdoor Stage-3 Client Heartbeat'
        condition: selection
      fields:
        - alert.signature
        - src_ip
        - dst_ip

  - question: Is this destination host known for receiving legitimate inbound connections on high ports?
    context: Confirming whether inbound high-port connections are normal for this host or indicate compromise.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          src_port|gte: 1024
        condition: selection
      fields:
        - src_ip
        - src_port
        - flow.bytes_toclient

  # Type 3: Activity Context
  - question: What was the sequence of Godlua communications leading to this server reply?
    context: Understanding the complete handshake sequence reveals the maturity of the C2 relationship.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          alert.signature|contains: 'Godlua'
        condition: selection
      fields:
        - alert.signature
        - src_ip
        - dst_ip
        - flow.bytes_toserver
        - flow.bytes_toclient

  - question: What other network activity occurred on the infected host around the time of this C2 communication?
    context: Understanding concurrent activity reveals potential command execution or data exfiltration following successful C2 establishment.
    range: -30m/+30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - src_port
        - flow.bytes_toserver
        - flow.bytes_toclient

  # Type 4: Impact Assessment
  - question: Has the C2 server sent additional commands or data following this heartbeat reply?
    context: Post-heartbeat activity indicates active backdoor usage for malicious purposes with this latest variant.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          flow.bytes_toclient|gte: 100
        condition: selection
      fields:
        - src_port
        - dst_port
        - flow.bytes_toclient
        - flow.bytes_toserver

  - question: Are there signs of malicious payload execution on the infected host following C2 establishment?
    context: Successful C2 communication often leads to additional malware deployment or command execution.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid
        - User

  # Type 5: Forensic Deep-Dive
  - question: What is the reputation and infrastructure details of the C2 server?
    context: Understanding C2 infrastructure helps attribute the campaign and identify additional IOCs for this latest variant.
    range: -24h/+24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - flow.bytes_toclient

  - question: Are there DNS queries that preceded connections to this C2 server?
    context: DNS resolution patterns reveal domain-based C2 infrastructure and potential DGA usage in recent campaigns.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          dns.resolved_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.resolved_ip

  # Type 6: Enterprise Correlation
  - question: Are other hosts in the network receiving similar Godlua server heartbeat replies?
    context: Multiple infected hosts receiving C2 replies indicates widespread campaign impact using this latest variant.
    range: -24h/+24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: 'Godlua Backdoor Stage-3 Server Heartbeat Reply'
        condition: selection
      fields:
        - dst_ip
        - src_ip
        - alert.signature

  - question: Is this C2 server communicating with multiple hosts in our organization?
    context: Correlating C2 communications helps identify the full scope of the latest Godlua campaign.
    range: -7d/+1d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - flow.bytes_toclient