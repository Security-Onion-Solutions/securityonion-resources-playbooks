name: ET INFO Socks5 Proxy to Onion (set)
id: 22027703
description: |
  Detects SOCKS5 proxy connections to Tor onion services (.onion domains).
  May indicate legitimate privacy-focused browsing or malicious C2 communications.
type: detection
detection_id: 2027703
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What is the complete SOCKS5 handshake pattern and target onion address?
    context: Understanding the exact proxy negotiation reveals the destination service being accessed.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - alert.signature
        - flow.bytes_toserver
        - flow.bytes_toclient
        - payload_printable

  - question: What is the destination onion service being accessed?
    context: Identifying the specific .onion domain helps determine if this is a known malicious service.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto
        - conn_state

  # Type 2: Triage Assessment
  - question: Is this user known to legitimately use Tor or privacy tools?
    context: Some users may have authorized use of Tor for legitimate privacy needs.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 9050
            - 9051
            - 1080
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port

  - question: Does this occur during business hours or expected user activity?
    context: Timing analysis helps distinguish between legitimate and suspicious proxy usage.
    range: -1d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - proto

  # Type 3: Activity Context
  - question: What process initiated this SOCKS5 connection?
    context: Identifying the source application reveals whether this is browser-based or programmatic access.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'socks'
            - 'proxy'
            - 'tor'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  - question: What network activity preceded this SOCKS5 handshake?
    context: Understanding the connection sequence helps identify if this is part of automated malware behavior.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto
        - conn_state

  # Type 4: Impact Assessment
  - question: What data was transmitted through this SOCKS5 tunnel?
    context: Analyzing tunnel traffic volume and patterns indicates potential data exfiltration.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - flow.bytes_toserver
        - flow.bytes_toclient
        - duration
        - conn_state

  - question: Are there signs of successful onion service communication?
    context: Confirming established connections indicates successful C2 channel establishment.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - conn_state
        - flow.bytes_toserver
        - flow.bytes_toclient
        - duration

  # Type 5: Forensic Deep-Dive
  - question: What other SOCKS5 or proxy activity exists from this host?
    context: Multiple proxy connections may indicate systematic C2 infrastructure usage.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains:
            - 'SOCKS'
            - 'proxy'
            - 'onion'
        condition: selection
      fields:
        - alert.signature
        - dst_ip
        - dst_port

  - question: Are there indicators of ransomware or malware families associated with Tor usage?
    context: Many ransomware families use Tor for C2 communications and payment processing.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains:
            - 'ransomware'
            - 'crypt'
            - 'trojan'
        condition: selection
      fields:
        - alert.signature
        - alert.category
        - alert.severity

  # Type 6: Enterprise Correlation
  - question: Are other hosts in the network establishing similar onion service connections?
    context: Multiple hosts using Tor may indicate coordinated malware campaign or policy violations.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature: 'ET INFO Socks5 Proxy to Onion (set)'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature