name: ET MALWARE Possible ICMP Backdoor Tunnel Command - whoami
id: 22027763
description: |
  Detects potential ICMP tunneling backdoor executing 'whoami' command within ICMP packets.
  May indicate covert channel malware or legitimate network troubleshooting tools.
type: detection
detection_id: 2027763
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What is the complete ICMP packet structure containing the whoami command?
    context: Understanding the exact packet format reveals tunneling method and potential backdoor capabilities.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - icmp.type
        - icmp.code
        - payload_printable
        - packet_info.length

  - question: What other commands or data are embedded in ICMP packets from this source?
    context: Additional commands reveal the scope of ICMP tunneling and backdoor functionality.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          proto: 'icmp'
        condition: selection
      fields:
        - dst_ip
        - icmp.type
        - icmp.code
        - flow.bytes_toserver

  # Type 2: Triage Assessment
  - question: Is this ICMP traffic part of legitimate network diagnostics or monitoring?
    context: Distinguishing between authorized ping/traceroute tools and malicious tunneling is critical for triage.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          proto: 'icmp'
        condition: selection
      fields:
        - dst_ip
        - icmp.type
        - icmp.code

  - question: Does this user or system normally generate ICMP traffic?
    context: Historical ICMP patterns help identify anomalous tunneling behavior versus normal network operations.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          proto: 'icmp'
        condition: selection
      fields:
        - dst_ip
        - icmp.type
        - flow.bytes_toserver

  # Type 3: Activity Context
  - question: What process or application initiated this ICMP tunneling activity?
    context: Identifying the source process helps distinguish between legitimate tools and malicious backdoors.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'ping'
            - 'icmp'
            - 'tunnel'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid

  - question: What preceded this ICMP command execution - system compromise or administrative activity?
    context: Understanding the attack timeline helps determine if this is post-exploitation activity or legitimate use.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ParentCommandLine

  - question: Are there signs of lateral movement or reconnaissance associated with this ICMP activity?
    context: ICMP tunneling often accompanies network reconnaissance and lateral movement attempts.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 135
            - 139
            - 445
            - 3389
            - 22
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - conn_state
        - proto

  # Type 4: Impact Assessment
  - question: What system information was revealed through the whoami command execution?
    context: Command output analysis helps assess information disclosure and potential privilege escalation.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          proto: 'icmp'
        condition: selection
      fields:
        - icmp.type
        - icmp.code
        - flow.bytes_toclient
        - flow.bytes_toserver

  - question: Are there signs of successful command execution and data exfiltration via ICMP?
    context: Response traffic patterns indicate if the backdoor successfully executed commands and returned results.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          proto: 'icmp'
        condition: selection
      fields:
        - dst_ip
        - flow.bytes_toclient
        - icmp.type

  # Type 5: Forensic Deep-Dive
  - question: What other ICMP tunneling or backdoor indicators exist on this system?
    context: Multiple tunneling artifacts confirm sophisticated covert channel usage and help identify the malware family.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains:
            - 'ICMP'
            - 'tunnel'
            - 'backdoor'
        condition: selection
      fields:
        - alert.signature
        - alert.category
        - dst_ip

  - question: What files or registry modifications support this ICMP backdoor operation?
    context: Understanding persistence and configuration helps with complete malware removal.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - 'icmp'
            - 'ping'
            - 'tunnel'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessImage

  - question: Are there other covert channel techniques being used alongside ICMP tunneling?
    context: Sophisticated attackers often use multiple covert channels for redundancy and stealth.
    range: -4h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains:
            - 'DNS'
            - 'tunnel'
            - 'covert'
        condition: selection
      fields:
        - alert.signature
        - alert.category
        - dst_ip

  # Type 6: Enterprise Correlation
  - question: Are other hosts in the network showing similar ICMP tunneling behavior?
    context: Multiple systems using ICMP backdoors indicate coordinated attack or malware campaign.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains:
            - 'ICMP Backdoor'
            - 'ICMP tunnel'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature