name: ET MALWARE ELF/Emptiness v2 XOR CnC Checkin
id: 22027836
description: |
  Detects ELF/Emptiness v2 botnet command and control communication using XOR encryption with key b2bb01039307baa2.
  This is the most advanced version of the Linux botnet with encrypted communications. No legitimate use case exists.
type: detection
detection_id: 2027836
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What does the XOR-encrypted payload decrypt to using the known key?
    context: Decrypting the payload confirms the Emptiness v2 beacon and reveals command structure.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - alert.signature
        - alert.metadata

  - question: Is this system known to use XOR encryption for legitimate communications?
    context: Eliminates false positives from applications using similar encryption patterns.
    range: -14d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          bytes_toserver: 24
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver
        - connection_state

  - question: What binary executed to generate this encrypted communication?
    context: Identifying the malware executable is critical for containment and analysis.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid
        - file.hash.md5
        - User

  - question: What other encrypted communications occurred from this compromised host?
    context: Reveals additional C2 channels or different encryption keys being used.
    range: +/-2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          bytes_toserver|gte: 20
          bytes_toserver|lte: 30
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver
        - bytes_toclient
        - duration

  - question: Has the malware received encrypted commands or updates from the C2?
    context: Determines if the bot is actively participating in the botnet and receiving instructions.
    range: +6h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          bytes_toclient|gte: 1
        condition: selection
      fields:
        - bytes_toclient
        - bytes_toserver
        - connection_state
        - duration

  - question: What suspicious files were created during the infection timeframe?
    context: Identifies the malware binary, configuration files, and any downloaded payloads.
    range: -4h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          event_type: create
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.hash.sha256
        - file.size
        - file.mime_type
        - Image

  - question: Are there signs of coordinated DDoS attacks from this advanced botnet?
    context: Emptiness v2 represents a sophisticated DDoS threat with encrypted coordination.
    range: +24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection_state
        - bytes_toserver
        - protocol

  - question: What DNS queries were made to resolve the C2 infrastructure?
    context: Reveals the domain infrastructure and potential domain generation algorithms.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name
        - dns.response_code

  - question: Has this advanced Emptiness v2 variant spread to other systems?
    context: Determines the scope of the sophisticated botnet infection across the network.
    range: -72h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: 'Emptiness v2'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature
        - alert.severity

  - question: What is the threat intelligence profile of the C2 infrastructure?
    context: Provides context for blocking decisions and campaign attribution.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - geoip.country_name
        - geoip.asn
        - threat_intel.indicators
        - threat_intel.malware_family

  - question: Are there additional IOCs related to this XOR encryption key across the enterprise?
    context: Identifies other systems that may be using the same encryption key or variant.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: 'b2bb01039307baa2'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature