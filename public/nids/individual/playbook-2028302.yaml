name: ET JA3 Hash - Metasploit CCS Scanner
id: 22028302
description: |
  Detects Metasploit CCS (Custom Certificate Store) scanner based on unique JA3 TLS fingerprint.
  JA3 hash 950ccdd64d360a7b24c70678ac116a44 is specific to Metasploit certificate scanning modules.
  May occasionally trigger on other certificate analysis tools but typically indicates penetration testing or reconnaissance activity.
type: detection
detection_id: 2028302
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What TLS certificate information was being scanned or harvested?
    context: Understanding the certificate details reveals what cryptographic information the attacker is gathering.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - tls.version
        - tls.cipher_suites
        - tls.extensions
        - tls.server_name_indication

  - question: What specific certificate properties were being analyzed?
    context: Certificate scanning reveals information about target infrastructure and potential attack vectors.
    query: |
      aggregation: false
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - tls.server.certificate.subject
        - tls.server.certificate.issuer
        - tls.server.certificate.serial_number
        - tls.server.certificate.not_valid_after

  # Type 2: Triage Assessment
  - question: Is this authorized certificate security assessment activity?
    context: Certificate scanning may be legitimate if conducted during authorized security assessments or compliance audits.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - tls.server.certificate.issuer

  - question: Does this activity align with scheduled security testing?
    context: Legitimate certificate scanning often occurs during planned security assessments with proper authorization.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 443
            - 8443
            - 9443
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - connection.state

  # Type 3: Activity Context
  - question: What system is running the Metasploit certificate scanner?
    context: Identifying the source system helps determine if this is internal security tooling or external reconnaissance.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          process.name|contains:
            - 'msfconsole'
            - 'ruby'
            - 'openssl'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - User

  - question: What network reconnaissance preceded this certificate scanning?
    context: Certificate scanning typically follows initial network discovery and service enumeration.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection.protocol
        - connection.state

  - question: Are there patterns indicating systematic certificate enumeration?
    context: Understanding the scanning methodology helps assess the sophistication and intent of the reconnaissance.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - tls.server.certificate.subject
        - tls.server.certificate.issuer

  # Type 4: Impact Assessment
  - question: Were any certificate vulnerabilities or misconfigurations identified?
    context: Certificate scanning may reveal weak cryptography, expired certificates, or other security issues.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - 'policy-violation'
            - 'protocol-command-decode'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - dst_ip

  - question: What sensitive certificate information was exposed during scanning?
    context: Certificate details can reveal internal infrastructure, naming conventions, and potential attack targets.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - tls.server.certificate.subject
        - tls.server.certificate.subject_alternative_names
        - tls.server.certificate.issuer

  # Type 5: Forensic Deep-Dive
  - question: What specific Metasploit certificate scanning modules were executed?
    context: Different certificate scanning modules have varying capabilities and reveal different reconnaissance objectives.
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          process.command_line|contains:
            - 'auxiliary/scanner/ssl'
            - 'ssl_cert'
            - 'ssl_enum'
        condition: selection
      fields:
        - process.command_line
        - process.parent.command_line
        - User

  - question: Are there signs of certificate-based attack preparation?
    context: Certificate reconnaissance often precedes SSL/TLS attacks, certificate spoofing, or man-in-the-middle attempts.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'SSL'
            - 'TLS'
            - 'Certificate'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - dst_ip

  - question: Were any certificate files or cryptographic material accessed?
    context: Attackers may attempt to access certificate stores or private keys following reconnaissance.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.extension|contains:
            - 'crt'
            - 'pem'
            - 'p12'
            - 'pfx'
        condition: selection
      fields:
        - file.path
        - file.name
        - file.extension

  # Type 6: Enterprise Correlation
  - question: Are other systems showing similar certificate scanning activity?
    context: Coordinated certificate scanning across multiple targets may indicate a broader reconnaissance campaign.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'Metasploit CCS'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is this part of a comprehensive SSL/TLS security assessment campaign?
    context: Certificate scanning is often part of broader SSL/TLS security testing or attack preparation across the enterprise.
    range: -48h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'SSL'
            - 'TLS'
            - 'Certificate'
            - 'Metasploit'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.category
        - rule.name