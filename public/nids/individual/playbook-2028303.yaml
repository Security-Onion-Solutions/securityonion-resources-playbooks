name: ET JA3 Hash - Metasploit HeartBleed Scanner
id: 22028303
description: |
  Detects Metasploit HeartBleed vulnerability scanner based on unique JA3 TLS fingerprint.
  JA3 hash ee031b874122d97ab269e0d8740be31a is specific to Metasploit HeartBleed scanning modules.
  May occasionally trigger on other HeartBleed testing tools but typically indicates vulnerability scanning or exploitation attempts.
type: detection
detection_id: 2028303
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What TLS heartbeat extension parameters were used in the scan?
    context: Understanding the heartbeat request structure reveals the specific HeartBleed exploitation technique being used.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - tls.version
        - tls.extensions
        - tls.heartbeat_extension
        - tls.cipher_suites

  - question: What specific HeartBleed payload size and pattern was attempted?
    context: Different payload sizes and patterns indicate various HeartBleed exploitation methods and data extraction attempts.
    query: |
      aggregation: false
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - tls.heartbeat.payload_length
        - tls.heartbeat.message_type
        - tls.server.certificate.version

  # Type 2: Triage Assessment
  - question: Is this authorized HeartBleed vulnerability testing?
    context: HeartBleed scanning may be legitimate if conducted during authorized security assessments or compliance testing.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 443
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - tls.server.certificate.subject

  - question: Does this align with scheduled vulnerability scanning activities?
    context: Legitimate HeartBleed testing often occurs during planned security assessments with proper authorization.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 443
            - 993
            - 995
            - 465
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - connection.state

  # Type 3: Activity Context
  - question: What system is running the Metasploit HeartBleed scanner?
    context: Identifying the source system helps determine if this is internal security tooling or external attack activity.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          process.name|contains:
            - 'msfconsole'
            - 'ruby'
            - 'heartbleed'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - User

  - question: What SSL/TLS reconnaissance preceded this HeartBleed scanning?
    context: HeartBleed scanning typically follows SSL service discovery and version enumeration.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - tls.version
        - tls.server.certificate.subject

  - question: Are there patterns indicating systematic HeartBleed vulnerability assessment?
    context: Understanding the scanning methodology helps assess whether this is targeted exploitation or broad vulnerability discovery.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          tls.version|contains:
            - '1.0'
            - '1.1'
            - '1.2'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - tls.version
        - tls.extensions

  # Type 4: Impact Assessment
  - question: Were any HeartBleed vulnerabilities successfully exploited?
    context: Successful HeartBleed exploitation can expose private keys, passwords, and sensitive memory contents.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'HeartBleed'
            - 'TLS'
            - 'SSL'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - dst_ip

  - question: What sensitive services were targeted for HeartBleed exploitation?
    context: HeartBleed attacks against critical services pose higher risk due to potential exposure of sensitive data.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 443
            - 993
            - 995
            - 465
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - tls.server.certificate.subject
        - tls.server.certificate.issuer

  # Type 5: Forensic Deep-Dive
  - question: What specific Metasploit HeartBleed modules and payloads were used?
    context: Different HeartBleed modules have varying capabilities for memory extraction and data harvesting.
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          process.command_line|contains:
            - 'auxiliary/scanner/ssl/openssl_heartbleed'
            - 'heartbleed'
            - 'CVE-2014-0160'
        condition: selection
      fields:
        - process.command_line
        - process.parent.command_line
        - User

  - question: Were any private keys or sensitive data extracted via HeartBleed?
    context: Successful HeartBleed exploitation may result in extraction of cryptographic keys or sensitive memory contents.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.name|contains:
            - 'heartbleed'
            - 'memory_dump'
            - 'ssl_key'
        condition: selection
      fields:
        - file.path
        - file.name
        - file.size

  - question: Are there signs of post-exploitation activity following HeartBleed success?
    context: Successful HeartBleed exploitation may be followed by credential theft, lateral movement, or further attacks.
    range: +6h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          connection.state: 'established'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection.bytes_sent
        - connection.bytes_received

  # Type 6: Enterprise Correlation
  - question: Are other systems showing similar HeartBleed scanning activity?
    context: Coordinated HeartBleed scanning across multiple targets indicates a systematic vulnerability assessment or attack campaign.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'HeartBleed'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is this part of a broader SSL/TLS vulnerability exploitation campaign?
    context: HeartBleed scanning often occurs alongside other SSL/TLS attacks as part of comprehensive cryptographic assessments.
    range: -48h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'SSL'
            - 'TLS'
            - 'Metasploit'
            - 'HeartBleed'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.category
        - rule.name