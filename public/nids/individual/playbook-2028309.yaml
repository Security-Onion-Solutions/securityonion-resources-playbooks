name: ET JA3 Hash - mitmproxy
id: 22028309
description: |
  Detects TLS connections with JA3 fingerprint matching mitmproxy tool (alternate signature).
  May indicate man-in-the-middle attacks or legitimate traffic analysis, but could also be authorized security testing.
type: detection
detection_id: 2028309
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the exact JA3 hash and TLS connection details for this mitmproxy variant detection?
    context: Understanding the alternate TLS fingerprint confirms mitmproxy version or configuration differences.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - tls.ja3
        - tls.server.certificate.subject
        - src_port
        - dst_port

  - question: Is this alternate mitmproxy fingerprint part of legitimate security testing activities?
    context: Different mitmproxy versions or configurations may produce varying JA3 fingerprints.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_sent
        - bytes_received

  - question: What web applications were accessed during this mitmproxy session?
    context: Understanding targeted applications helps determine testing scope or attack objectives.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.response.status_code
        - user_agent.original

  - question: Are there SSL certificate anomalies associated with this mitmproxy variant?
    context: Different mitmproxy configurations may handle certificates differently during interception.
    range: +/-15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - tls.server.certificate.subject
        - tls.server.certificate.issuer
        - tls.server.certificate.not_valid_before
        - tls.server.certificate.not_valid_after

  - question: What HTTPS services were targeted by this mitmproxy configuration?
    context: Analyzing connection patterns reveals the scope of traffic interception activities.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 443
        condition: selection
      fields:
        - dst_ip
        - duration
        - bytes_sent
        - bytes_received
        - connection_state

  - question: What process execution indicates this specific mitmproxy variant is running?
    context: Process analysis helps identify mitmproxy version and configuration parameters.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - mitmproxy
            - mitmdump
            - mitmweb
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  - question: Are there configuration files or certificates specific to this mitmproxy setup?
    context: File operations reveal mitmproxy configuration and certificate management activities.
    range: +/-15m
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - mitmproxy-ca
            - .mitmproxy
            - proxy.pem
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessGuid

  - question: What DNS resolution patterns accompany this mitmproxy variant usage?
    context: DNS queries reveal which services are being targeted for traffic analysis.
    range: +/-30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.query.type_name: A
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  - question: Are both mitmproxy JA3 fingerprints observed from the same source systems?
    context: Multiple fingerprints from same source may indicate different tool versions or configurations.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          tls.ja3|contains:
            - "4d01f8b1afc22e138127611b62f1e6ec"
            - "8ef6a005eae3d51b652ffe41984f8869"
        condition: selection
      fields:
        - tls.ja3
        - dst_ip
        - dst_port

  - question: What HTTP header modifications are associated with this mitmproxy variant?
    context: Different mitmproxy configurations may modify HTTP headers in distinct ways.
    range: +/-15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.request.headers
        - http.response.headers

  - question: Have there been escalating proxy-related security alerts from this source?
    context: Progressive alert patterns may indicate evolving interception techniques or malicious intent.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - mitmproxy
            - proxy
            - ja3
            - ssl
        condition: selection
      fields:
        - rule.name
        - rule.category
        - dst_ip
        - dst_port