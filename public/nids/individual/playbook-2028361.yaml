name: ET JA3 Hash - Possible Malware - AnglerEK
id: 22028361
description: |
  Detects TLS connections with alternate JA3 fingerprint associated with Angler Exploit Kit malware.
  Indicates potential malware communication or exploit kit activity using different TLS configuration.
type: detection
detection_id: 2028361
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What is the exact JA3 hash and malware communication destination?
    context: Confirms the specific alternate TLS fingerprint and command and control server details.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - tls.ja3
        - dst_ip
        - dst_port
        - src_ip

  - question: Is this system showing multiple Angler EK JA3 variants?
    context: Determines if the malware is using different TLS configurations to evade detection.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          tls.ja3|contains:
            - "96eba628dcb2b47607192ba74a3b55ba"
            - "d55e755245ac118f2b1847c1c57b5e03"
        condition: selection
      fields:
        - tls.ja3
        - dst_ip
        - dst_port

  - question: What process initiated this variant TLS connection?
    context: Identifies the specific malware variant or compromised application making the connection.
    range: -15m
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - user.name

  - question: What data volume was exchanged with this malware variant?
    context: Assesses the communication pattern and data exfiltration potential of this variant.
    range: -15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port|expand: '%dst_port%'
        condition: selection
      fields:
        - network.bytes_sent
        - network.bytes_received
        - network.protocol

  - question: Are there signs of different payload delivery methods?
    context: Determines if this variant uses different infection or payload delivery techniques.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - file.name
        - file.path
        - file.hash.md5
        - process.name

  - question: What infrastructure overlap exists between JA3 variants?
    context: Identifies shared command and control infrastructure across malware variants.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  - question: Has this variant created different persistence mechanisms?
    context: Assesses if different malware variants use varying persistence techniques.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - registry.key
        - registry.value.name
        - registry.value.data
        - process.name

  - question: How widespread is this specific JA3 variant across the network?
    context: Identifies the distribution and impact of this particular malware variant.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          tls.ja3: "d55e755245ac118f2b1847c1c57b5e03"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port

  - question: What is the timeline relationship between different Angler variants?
    context: Determines if variants are used sequentially or simultaneously for evasion.
    range: -48h
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          tls.ja3|contains:
            - "96eba628dcb2b47607192ba74a3b55ba"
            - "d55e755245ac118f2b1847c1c57b5e03"
        condition: selection
      fields:
        - tls.ja3
        - dst_ip
        - dst_port

  - question: Are there behavioral differences between this and other variants?
    context: Identifies unique capabilities or targets of this specific malware variant.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.protocol

  - question: Is this variant part of the same campaign as other Angler EK activity?
    context: Assesses whether different JA3 variants represent coordinated attack evolution.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          tls.ja3|contains:
            - "96eba628dcb2b47607192ba74a3b55ba"
            - "d55e755245ac118f2b1847c1c57b5e03"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - network.community_id