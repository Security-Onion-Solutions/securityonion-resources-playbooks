name: ET JA3 Hash - Possible Malware - USPS Malspam
id: 22028393
description: |
  Detects TLS connections using alternate JA3 fingerprint associated with USPS-themed malspam campaigns.
  May trigger on legitimate applications using similar TLS configurations, but requires investigation.
type: detection
detection_id: 2028393
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete TLS handshake fingerprint that triggered this alert?
    context: The JA3 hash provides insight into the client's TLS configuration and potential malware family.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - tls.ja3
        - tls.ja3_hash
        - src_ip
        - dst_ip
        - dst_port

  - question: Is this TLS configuration normal for applications on this host?
    context: Legitimate applications typically have consistent TLS fingerprints over time.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - tls.ja3_hash
        - dst_ip
        - dst_port

  - question: What process initiated this TLS connection?
    context: Identifying the source process helps determine if this is malware or legitimate software.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: What was the destination of this suspicious TLS connection?
    context: Malspam campaigns often connect to specific C2 infrastructure or compromised websites.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_sent
        - bytes_received

  - question: Are there DNS queries preceding this connection that indicate malicious domains?
    context: USPS malspam often uses deceptive domains mimicking legitimate postal services.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  - question: Has this host downloaded suspicious files recently?
    context: USPS malspam typically delivers malicious attachments or payloads.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.mime_type

  - question: What other network connections occurred around the same time?
    context: Malware often establishes multiple connections for C2 communication and data exfiltration.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - protocol
        - bytes_sent

  - question: Are there signs of payload execution or system compromise?
    context: Successful malspam campaigns result in malware execution and potential system changes.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid

  - question: Has this JA3 fingerprint been observed on other hosts in the network?
    context: Malspam campaigns often target multiple users simultaneously across the organization.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          tls.ja3_hash: "6f702efe6480d2a1c9f85b73b8a4794a"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port

  - question: Are there email security alerts correlating with this network activity?
    context: USPS malspam campaigns are often detected by email security systems before network execution.
    range: -6h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "email"
            - "malspam"
            - "phishing"
        condition: selection
      fields:
        - rule.name
        - rule.category
        - event.severity

  - question: What is the reputation and geolocation of the destination IP?
    context: Malspam C2 infrastructure often uses suspicious hosting providers or geographic regions.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - geoip.country_name
        - threat_intel.reputation