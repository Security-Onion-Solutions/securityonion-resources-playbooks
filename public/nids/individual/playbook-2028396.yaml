name: ET JA3 Hash - Possible Malware - Various EK
id: 22028396
description: |
  Detects TLS connections using JA3 fingerprint associated with various exploit kit campaigns.
  May trigger on legitimate applications using similar TLS configurations, but requires investigation.
type: detection
detection_id: 2028396
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete TLS handshake fingerprint that triggered this alert?
    context: The JA3 hash provides insight into the client's TLS configuration and potential exploit kit activity.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - tls.ja3
        - tls.ja3_hash
        - src_ip
        - dst_ip
        - dst_port

  - question: Is this TLS configuration normal for browsers on this host?
    context: Exploit kits typically target web browsers, so comparing against normal browser fingerprints is crucial.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 80
            - 443
        condition: selection
      fields:
        - tls.ja3_hash
        - dst_ip
        - dst_port

  - question: What web browsing activity preceded this connection?
    context: Exploit kits are delivered through malicious web pages or compromised legitimate sites.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.response.status_code
        - http.request.referrer

  - question: What was the destination of this suspicious TLS connection?
    context: Exploit kit infrastructure often uses compromised websites or malicious hosting providers.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_sent
        - bytes_received

  - question: Are there DNS queries to suspicious domains before this connection?
    context: Exploit kits often use domain generation algorithms or compromised domains for payload delivery.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  - question: Has this host downloaded suspicious files recently?
    context: Successful exploit kit attacks result in malware payload downloads and execution.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.mime_type

  - question: What browser processes were active during this timeframe?
    context: Identifying the browser process helps determine the attack vector and potential compromise.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - "chrome.exe"
            - "firefox.exe"
            - "iexplore.exe"
            - "msedge.exe"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: Are there signs of exploit execution or system compromise?
    context: Exploit kits attempt to execute malicious code through browser vulnerabilities.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid

  - question: Has this JA3 fingerprint been observed on other hosts in the network?
    context: Exploit kit campaigns often target multiple users through drive-by downloads or malvertising.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          tls.ja3_hash: "51a7ad14509fd614c7bb3a50c4982b8c"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port

  - question: Are there web security alerts correlating with this network activity?
    context: Web security systems often detect exploit kit landing pages before payload delivery.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "exploit"
            - "web"
            - "malicious"
        condition: selection
      fields:
        - rule.name
        - rule.category
        - event.severity

  - question: What is the reputation and hosting details of the destination IP?
    context: Exploit kit infrastructure often uses bulletproof hosting or compromised legitimate websites.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - geoip.country_name
        - threat_intel.reputation