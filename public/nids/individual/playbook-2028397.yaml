name: ET JA3 Hash - Possible Malware - Various Malspam/RigEK
id: 22028397
description: |
  Detects TLS connections using JA3 fingerprint associated with malspam campaigns and RigEK exploit kit.
  May trigger on legitimate applications using similar TLS configurations, but requires investigation.
type: detection
detection_id: 2028397
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete TLS handshake fingerprint that triggered this alert?
    context: The JA3 hash provides insight into the client's TLS configuration and potential malware family or exploit kit.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - tls.ja3
        - tls.ja3_hash
        - src_ip
        - dst_ip
        - dst_port

  - question: Is this TLS configuration typical for applications on this host?
    context: Legitimate applications typically have consistent TLS fingerprints, while malware may use unusual configurations.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - tls.ja3_hash
        - dst_ip
        - dst_port

  - question: What process or application initiated this TLS connection?
    context: Identifying the source process helps distinguish between legitimate software and malware activity.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: What was the destination and data transfer characteristics of this connection?
    context: Malspam and exploit kit payloads often have distinctive communication patterns with C2 infrastructure.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_sent
        - bytes_received

  - question: Are there DNS queries to suspicious domains preceding this connection?
    context: Both malspam and RigEK campaigns use specific domains for payload delivery and C2 communication.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  - question: Has this host downloaded or executed suspicious files recently?
    context: Successful malspam and exploit kit attacks result in malware payload delivery and execution.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.mime_type

  - question: What web browsing or email activity occurred before this connection?
    context: RigEK targets browsers while malspam arrives via email, both leading to similar network behavior.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.response.status_code
        - http.request.referrer

  - question: Are there signs of post-exploitation activity or system compromise?
    context: Both malspam and exploit kits aim to establish persistence and execute secondary payloads.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid

  - question: Has this JA3 fingerprint been observed across multiple hosts?
    context: Both malspam and RigEK campaigns often target multiple users simultaneously in an organization.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          tls.ja3_hash: "3b483d0b34894548b602e8d18cdc24c5"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port

  - question: Are there email or web security alerts correlating with this activity?
    context: Security systems often detect malspam emails or exploit kit landing pages before network-level indicators.
    range: -6h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "malspam"
            - "exploit"
            - "rig"
            - "phishing"
        condition: selection
      fields:
        - rule.name
        - rule.category
        - event.severity

  - question: What is the reputation and infrastructure details of the destination?
    context: Malspam and RigEK infrastructure often uses compromised websites or bulletproof hosting providers.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - geoip.country_name
        - threat_intel.reputation