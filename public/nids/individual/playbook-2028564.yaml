name: ET MALWARE [TGI] BlackRAT Checkin
id: 22028564
description: |
  Detects BlackRAT malware performing check-in communications with command and control servers.
  This indicates an active infection with data exfiltration and remote access capabilities.
  Legitimate software rarely uses similar communication patterns.
type: detection
detection_id: 2028564
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete BlackRAT communication payload?
    context: Analyzing the full payload reveals malware version, configuration, and capabilities.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - http.request.body.content

  - question: What specific version information was transmitted in the checkin?
    context: Version strings help identify malware variant and potential additional capabilities.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - flow_id
        - community_id
        - app_proto

  # Type 2: Triage Assessment
  - question: Is this system known to run legitimate remote administration tools?
    context: Some legitimate software might have similar communication patterns, requiring verification.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'teamviewer'
            - 'vnc'
            - 'rdp'
            - 'remote'
        condition: selection
      fields:
        - User
        - Image
        - ProcessGuid

  - question: Are there scheduled maintenance activities that could explain this traffic?
    context: Understanding authorized remote access helps eliminate false positives.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          User|contains:
            - 'admin'
            - 'service'
            - 'system'
        condition: selection
      fields:
        - User
        - CommandLine
        - ProcessId

  # Type 3: Activity Context
  - question: What process initiated this BlackRAT communication?
    context: Identifying the parent process reveals infection vector and persistence mechanism.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid

  - question: What other network connections occurred around the same time?
    context: Understanding concurrent network activity reveals full scope of malware behavior.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver
        - bytes_toclient

  # Type 4: Impact Assessment
  - question: What data was transmitted to the command and control server?
    context: Understanding data exfiltration helps assess breach impact and scope.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - bytes_toserver
        - bytes_toclient
        - duration

  - question: Are there signs of lateral movement from this infected system?
    context: BlackRAT capabilities include network reconnaissance and lateral movement.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 445
            - 139
            - 3389
            - 22
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - service

  # Type 5: Forensic Deep-Dive
  - question: What BlackRAT modules or plugins are active on this system?
    context: Different BlackRAT variants have varying capabilities requiring specific response actions.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - '.dll'
            - '.exe'
            - 'temp'
        condition: selection
      fields:
        - TargetFilename
        - ProcessName
        - file.hash.md5

  - question: What persistence mechanisms has BlackRAT established?
    context: Understanding persistence helps ensure complete malware removal.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - 'Run'
            - 'RunOnce'
            - 'Services'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessName

  # Type 6: Enterprise Correlation
  - question: Are other systems communicating with this same command and control server?
    context: Identifying additional infected systems helps scope the incident response.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - bytes_toserver
        - first_seen

  - question: Is this part of a broader BlackRAT campaign across the organization?
    context: Understanding campaign scope helps prioritize containment and remediation efforts.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: 'BlackRAT'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature