name: ET MALWARE [TGI] BlackRAT Checkin Response
id: 22028565
description: |
  Detects command and control server responses to BlackRAT malware checkins.
  This indicates active C2 communication and potential command delivery to infected systems.
  Legitimate applications rarely exhibit similar bidirectional communication patterns.
type: detection
detection_id: 2028565
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What commands or data did the C2 server send in response?
    context: Analyzing C2 responses reveals attacker intentions and next-stage activities.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - http.response.body.content

  - question: What BlackRAT version information was confirmed in the response?
    context: Version confirmation helps identify specific malware capabilities and threat level.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - flow_id
        - community_id
        - app_proto

  # Type 2: Triage Assessment
  - question: Is this response part of known legitimate remote management traffic?
    context: Some enterprise tools have similar response patterns requiring verification.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - bytes_toserver
        - bytes_toclient
        - duration

  - question: Does the timing align with any scheduled system administration?
    context: Understanding authorized activities helps distinguish malicious from legitimate traffic.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          User|contains:
            - 'admin'
            - 'service'
        condition: selection
      fields:
        - User
        - CommandLine
        - ProcessId

  # Type 3: Activity Context
  - question: What was the initial BlackRAT checkin that triggered this response?
    context: Understanding the request-response pair reveals complete C2 communication flow.
    range: -5m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
          alert.signature|contains: 'BlackRAT Checkin'
        condition: selection
      fields:
        - alert.signature
        - payload
        - timestamp

  - question: What network session established this C2 communication channel?
    context: Analyzing the connection context reveals how the malware established communication.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - connection_state
        - proto
        - service

  # Type 4: Impact Assessment
  - question: Did the infected system execute commands after receiving this response?
    context: C2 responses often contain commands that result in immediate system changes.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: Was additional data exfiltrated following this C2 response?
    context: Commands from C2 servers often trigger data collection and exfiltration activities.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          bytes_toserver|gt: 10000
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver
        - duration

  # Type 5: Forensic Deep-Dive
  - question: What specific BlackRAT modules were activated by this C2 response?
    context: Different responses activate different malware capabilities requiring targeted remediation.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          EventType: 'FileCreate'
        condition: selection
      fields:
        - TargetFilename
        - ProcessName
        - file.hash.md5

  - question: Are there indicators of additional malware deployment via this C2 channel?
    context: C2 responses often deliver additional payloads or update existing malware.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - 'temp'
            - 'appdata'
            - 'programdata'
        condition: selection
      fields:
        - Image
        - CommandLine
        - file.hash.md5

  # Type 6: Enterprise Correlation
  - question: Are other systems receiving similar C2 responses from this server?
    context: Understanding campaign scope helps prioritize incident response across the organization.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains: 'BlackRAT'
        condition: selection
      fields:
        - dst_ip
        - alert.signature
        - count

  - question: Is this C2 server coordinating activities across multiple infected systems?
    context: Coordinated C2 responses indicate sophisticated threat actor operations.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - bytes_toclient
        - connection_count