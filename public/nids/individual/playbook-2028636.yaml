name: ET EXPLOIT Possible EXIM DoS (CVE-2019-16928)
id: 22028636
description: |
  Detects potential exploitation of CVE-2019-16928, a denial of service vulnerability in EXIM mail servers.
  Triggered by EHLO commands with excessively long hostnames. May trigger on legitimate but misconfigured clients.
type: detection
detection_id: 2028636
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the exact length and content of the EHLO command?
    context: Understanding the payload size and structure confirms exploitation attempt versus misconfiguration.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - alert.signature
        - smtp.helo

  - question: Is this client known to send legitimate SMTP traffic to this server?
    context: Distinguishes between attack attempts and legitimate but misconfigured mail clients.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 25
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - connection_state
        - bytes_toserver
        - bytes_toclient

  - question: What SMTP commands preceded this potentially malicious EHLO?
    context: Understanding the SMTP session flow helps determine if this is part of a legitimate email transaction.
    range: -5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 25
        condition: selection
      fields:
        - smtp.command
        - smtp.response
        - bytes_toserver
        - bytes_toclient

  - question: Did the EXIM server respond normally or show signs of resource exhaustion?
    context: Determines if the DoS attack was successful in degrading server performance.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 25
        condition: selection
      fields:
        - src_ip
        - connection_state
        - bytes_toclient
        - duration
        - smtp.response

  - question: Are there multiple attempts from the same source or related sources?
    context: Identifies coordinated DoS attacks or automated exploitation attempts.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: 'EXIM DoS'
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature
        - alert.severity

  - question: What is the version and configuration of the targeted EXIM server?
    context: Determines if the server is vulnerable to CVE-2019-16928 and needs patching.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 25
        condition: selection
      fields:
        - smtp.server_response
        - smtp.banner
        - tls.server.certificate.subject

  - question: Has this attack source targeted other SMTP servers in the network?
    context: Reveals if this is part of a broader campaign against mail infrastructure.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 25
        condition: selection
      fields:
        - dst_ip
        - connection_state
        - bytes_toserver
        - smtp.command

  - question: What is the geolocation and reputation of the attacking source?
    context: Provides threat intelligence context for blocking and attribution decisions.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - src_ip
        - geoip.country_name
        - geoip.asn
        - threat_intel.indicators
        - threat_intel.categories

  - question: Are there signs of successful mail server compromise or data exfiltration?
    context: Determines if the DoS was a precursor to more serious attacks or data theft.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 25
            - 587
            - 993
            - 995
        condition: selection
      fields:
        - src_ip
        - dst_port
        - bytes_toserver
        - bytes_toclient
        - connection_state

  - question: Have other CVE-2019-16928 exploitation attempts been detected enterprise-wide?
    context: Identifies if this is part of a coordinated campaign against mail infrastructure.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: 'CVE-2019-16928'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature
        - alert.severity