name: ET MALWARE Win32/Phoenix Keylogger SMTP Exfil - Passwords
id: 22028643
description: |
  Detects Win32/Phoenix keylogger exfiltrating stolen passwords via SMTP with distinctive subject line format.
  This is malicious activity with no legitimate use case. The specific subject format is unique to this malware family.
type: detection
detection_id: 2028643
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete SMTP message content including headers and body?
    context: Reveals the full extent of stolen credentials and victim system information.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - smtp.mail.from
        - smtp.mail.to
        - smtp.subject

  - question: Is this system authorized to send emails with sensitive credential information?
    context: Eliminates false positives from legitimate password management or security tools.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 25
            - 587
            - 465
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver
        - connection_state

  - question: What process initiated this malicious SMTP communication?
    context: Identifies the keylogger executable and its installation method.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid
        - file.hash.md5
        - User

  - question: What other suspicious network activity occurred from this infected system?
    context: Reveals additional C2 communications or data exfiltration channels.
    range: +/-2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver
        - bytes_toclient
        - protocol

  - question: How much credential data has been exfiltrated from this system?
    context: Determines the scope of the data breach and number of compromised accounts.
    range: +24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 25
            - 587
            - 465
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - connection_state

  - question: What files were created or modified during the keylogger installation?
    context: Identifies the malware binary, configuration files, and stolen data storage locations.
    range: -4h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          event_type|contains:
            - create
            - modify
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.hash.sha256
        - file.size
        - Image

  - question: Are there signs of keylogger persistence mechanisms on the system?
    context: Identifies how the malware maintains persistence for continued credential theft.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - 'Run'
            - 'RunOnce'
            - 'Services'
        condition: selection
      fields:
        - TargetObject
        - Details
        - Image
        - EventType

  - question: What credentials and applications were targeted by the keylogger?
    context: Determines which accounts and services need password resets and monitoring.
    range: -6h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'browser'
            - 'outlook'
            - 'mail'
            - 'ftp'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: Has this Phoenix keylogger variant been detected on other systems?
    context: Determines if this is an isolated infection or part of a broader campaign.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: 'Phoenix Keylogger'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature
        - alert.severity

  - question: What is the profile of the SMTP server receiving the stolen credentials?
    context: Provides threat intelligence for blocking and potential law enforcement referral.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 25
            - 587
            - 465
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - geoip.country_name
        - geoip.asn
        - threat_intel.indicators

  - question: Are there additional IOCs related to this AgentTesla/Phoenix campaign?
    context: Identifies related infrastructure and TTPs for comprehensive threat hunting.
    range: -14d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains:
            - 'AgentTesla'
            - 'Phoenix'
            - 'PSWD'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature
        - alert.metadata