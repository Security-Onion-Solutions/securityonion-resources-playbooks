name: ET MALWARE Win32/Phoenix Keylogger Exfil via SMTP - Generic
id: 22028644
description: |
  Detects Win32/Phoenix keylogger exfiltrating system information via SMTP.
  Triggers on specific client info patterns including IP, HWID, and OS platform data.
  May rarely false positive on legitimate system monitoring tools with similar formatting.
type: detection
detection_id: 2028644
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What specific client information was being exfiltrated in the SMTP message?
    context: Understanding the exact data being stolen reveals the keylogger's intelligence gathering capabilities.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - smtp.message.body
        - smtp.message.subject
        - smtp.message.to
        - smtp.message.from

  - question: What was the complete SMTP conversation structure for this exfiltration attempt?
    context: Analyzing the full SMTP flow reveals the communication protocol and potential command structure.
    range: -5m/+5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 25
        condition: selection
      fields:
        - network.bytes
        - network.packets
        - network.protocol

  # Type 2: Triage Assessment
  - question: Is this source IP authorized to send SMTP traffic externally?
    context: Legitimate mail servers may have similar patterns, requiring validation of authorized senders.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 25
        condition: selection
      fields:
        - dst_ip
        - network.bytes

  - question: Does this system normally generate SMTP traffic during this time period?
    context: Baseline analysis helps distinguish between normal operations and malicious exfiltration.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 25
        condition: selection
      fields:
        - dst_ip
        - network.community_id

  # Type 3: Activity Context
  - question: What process initiated this SMTP connection on the source system?
    context: Identifying the parent process reveals how the keylogger was executed and its persistence mechanism.
    range: -15m/+5m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - process.executable

  - question: What network connections preceded this SMTP exfiltration?
    context: Understanding the attack sequence helps identify initial compromise vectors and C2 communications.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.protocol
        - network.bytes

  # Type 4: Impact Assessment
  - question: What sensitive data was potentially captured by this keylogger?
    context: Assessing data exposure scope is critical for breach notification and remediation planning.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.name|contains:
            - '.log'
            - '.txt'
            - '.dat'
        condition: selection
      fields:
        - file.path
        - file.size
        - file.hash.md5

  - question: Are there signs of credential harvesting or authentication bypass?
    context: Keyloggers often target authentication systems, requiring immediate credential reset procedures.
    range: -2h/+30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains:
            - 'login'
            - 'auth'
            - 'signin'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.response.status_code

  # Type 5: Forensic Deep-Dive
  - question: What other Phoenix keylogger artifacts exist on this system?
    context: Complete malware enumeration ensures thorough cleanup and prevents reinfection.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.hash.md5: '1e3ea34762c6301233da7cb8c5e9c45f'
        condition: selection
      fields:
        - file.path
        - file.name
        - process.name

  - question: What persistence mechanisms has this keylogger established?
    context: Understanding persistence helps prevent reinfection and guides complete removal procedures.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          registry.path|contains:
            - 'Run'
            - 'RunOnce'
            - 'Services'
        condition: selection
      fields:
        - registry.path
        - registry.value
        - registry.data

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network exhibiting similar Phoenix keylogger behavior?
    context: Identifying campaign scope helps prioritize incident response and containment efforts.
    range: -24h/+2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'Phoenix Keylogger'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name