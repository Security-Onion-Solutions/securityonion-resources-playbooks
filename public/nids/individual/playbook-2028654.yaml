name: ET MALWARE Observed Malicious SSL Cert (AZORult CnC Server) corpcougar.com
id: 22028654
description: |
  Detects SSL certificate associated with AZORult malware command and control infrastructure.
  AZORult is an information stealer that harvests credentials, browser data, and cryptocurrency wallets.
  May trigger on legitimate certificates if domains are compromised or typosquatted.
type: detection
detection_id: 2028654
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What is the complete SSL certificate subject for the detected corpcougar.com connection?
    context: Full certificate details reveal the exact malicious infrastructure being contacted.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - tls.server.certificate.subject
        - tls.server.certificate.issuer
        - tls.server.certificate.serial_number
        - tls.server.certificate.fingerprint_sha1

  - question: What SSL certificate fingerprints match the known AZORult corpcougar.com infrastructure?
    context: Certificate fingerprints provide definitive identification of malicious SSL certificates.
    query: |
      aggregation: false
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - tls.server.certificate.fingerprint_md5
        - tls.server.certificate.fingerprint_sha256
        - tls.server.certificate.not_valid_after

  # Type 2: Triage Assessment
  - question: Is this SSL connection to corpcougar.com part of legitimate business operations?
    context: Corporate-sounding domain names are often used by malware to appear legitimate.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 443
            - 8443
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - bytes_in

  - question: Has this host contacted other malicious SSL certificates recently?
    context: Multiple malicious SSL connections indicate active malware infection requiring immediate response.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "Malicious SSL Cert"
            - "SSL_Malicious_Cert"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - alert.severity

  # Type 3: Activity Context
  - question: What process initiated the SSL connection to the malicious corpcougar.com certificate?
    context: Identifying the source process helps determine infection vector and malware persistence.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ProcessGuid
        - ParentImage

  - question: What network connections occurred immediately before this SSL alert?
    context: Prior network activity reveals infection chain and potential exploitation methods.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - protocol
        - bytes_out

  - question: Were there any DNS queries for corpcougar.com domain before the SSL connection?
    context: DNS resolution patterns help identify if malware is using domain generation algorithms or hardcoded domains.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          dns.query.name|contains:
            - "corpcougar.com"
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  # Type 4: Impact Assessment
  - question: Has the infected host transmitted significant data to the C2 server?
    context: Large data transfers indicate successful credential harvesting and data exfiltration.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - bytes_out
        - bytes_in
        - duration

  - question: Are there signs of credential harvesting or browser data theft?
    context: Malware typically accesses browser profiles and credential stores for data theft.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - "\\AppData\\Local\\Google\\Chrome\\User Data"
            - "\\AppData\\Roaming\\Mozilla\\Firefox\\Profiles"
            - "Login Data"
            - "cookies.sqlite"
        condition: selection
      fields:
        - TargetFilename
        - ProcessName
        - file.hash.md5

  # Type 5: Forensic Deep-Dive
  - question: What malware variant indicators are present on the infected system?
    context: Specific malware signatures help determine capabilities and required remediation steps.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - "schtasks"
            - "reg add"
            - "wmic"
        condition: selection
      fields:
        - Image
        - CommandLine
        - ProcessGuid
        - User

  - question: Has the malware established persistence mechanisms on the infected host?
    context: Malware often creates scheduled tasks or registry entries for persistence across reboots.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - "\\Software\\Microsoft\\Windows\\CurrentVersion\\Run"
            - "\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce"
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessName

  # Type 6: Enterprise Correlation
  - question: Are other hosts in the network communicating with similar malicious infrastructure?
    context: Multiple infections indicate widespread compromise requiring coordinated incident response.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - "Malicious SSL Cert"
            - "SSL_Malicious_Cert"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name