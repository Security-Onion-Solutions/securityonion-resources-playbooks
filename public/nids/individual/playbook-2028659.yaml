name: ET MALWARE Observed Malicious SSL Cert (AZORult CnC Server) in SNI 2019-09-27
id: 22028659
description: |
  Detects TLS Server Name Indication (SNI) containing "techxim.com" associated with AZORult malware command and control infrastructure.
  This domain has been observed in active AZORult campaigns and indicates outbound malware communication attempts.
type: detection
detection_id: 2028659
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete SNI value and TLS handshake details for this connection?
    context: SNI analysis reveals the exact domain requested and helps confirm malicious intent versus legitimate traffic.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - tls.sni
        - tls.version
        - tls.cipher_suite
        - dst_ip
        - dst_port

  - question: What was the source system and user context for this outbound connection attempt?
    context: Identifying the compromised endpoint and user helps scope the incident and determine containment needs.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - src_ip
        - src_port
        - user.name
        - host.hostname

  # Type 2: Triage Assessment
  - question: Does this source system normally make outbound HTTPS connections to external domains?
    context: Understanding normal network behavior helps distinguish between infected systems and legitimate business traffic.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - tls.sni
        - count

  - question: Is this connection attempt during normal business hours for this user?
    context: Off-hours malware communication often indicates automated C2 beaconing rather than user-initiated activity.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port:
            - 443
            - 8443
        condition: selection
      fields:
        - dst_ip
        - bytes_out
        - bytes_in

  # Type 3: Activity Context
  - question: What process initiated this TLS connection to the malicious domain?
    context: Identifying the parent process reveals infection vector and helps determine malware family characteristics.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - process.name
        - process.pid
        - process.command_line
        - process.parent.name

  - question: What DNS queries were made to resolve this malicious domain?
    context: DNS resolution patterns reveal how the malware discovered the C2 server and potential backup domains.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.query.name|contains: 'techxim.com'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.resolved_ip
        - dns.response_code

  - question: What other network activity occurred around the same time as this C2 attempt?
    context: Concurrent network activity helps identify related malware components and lateral movement attempts.
    range: +/-15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - bytes_in

  # Type 4: Impact Assessment
  - question: Was this TLS connection successfully established and what data was exchanged?
    context: Successful C2 communication indicates active compromise requiring immediate containment and analysis.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - connection_state
        - bytes_in
        - bytes_out
        - duration

  - question: Are there signs of credential theft or data staging on the compromised system?
    context: AZORult specializes in information theft, so file access patterns indicate what sensitive data was targeted.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - file.path
        - file.name
        - event.action
        - process.name

  # Type 5: Forensic Deep-Dive
  - question: What other AZORult-related network indicators are present on this system?
    context: AZORult campaigns often use multiple domains and C2 servers for redundancy and persistence.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: 'AZORult'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - tls.sni
        - alert.severity

  - question: What malware artifacts or persistence mechanisms are installed on this system?
    context: Complete malware analysis enables thorough remediation and prevents reinfection.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - file.hash.md5
        - process.parent.name

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network attempting to connect to this same malicious domain?
    context: Multiple infected endpoints indicate widespread compromise requiring coordinated incident response.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          tls.sni|contains: 'techxim.com'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - host.hostname

  - question: What is the scope of AZORult activity across the enterprise environment?
    context: Enterprise-wide threat assessment enables comprehensive response planning and resource allocation.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'AZORult'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - alert.severity