name: ET JA3 Hash - [Abuse.ch] Possible Trickbot
id: 22028757
description: |
  Detects TLS connections with JA3 hash associated with Trickbot malware.
  JA3 fingerprinting identifies TLS client behavior patterns. May trigger on legitimate applications using similar TLS configurations.
type: detection
detection_id: 2028757
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What is the complete TLS handshake fingerprint for this connection?
    context: JA3 hash identifies specific TLS client behavior patterns used by Trickbot.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - tls.ja3
        - tls.ja3_hash
        - tls.server.certificate.subject
        - tls.server.certificate.issuer

  - question: Is this TLS configuration normal for applications on this host?
    context: Legitimate applications may occasionally use similar TLS configurations.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - tls.ja3_hash
        - dst_ip
        - dst_port

  - question: What process initiated this TLS connection?
    context: Identifying the source process helps determine if connection is malicious or legitimate.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - process.name
        - process.pid
        - process.command_line

  - question: What domain or IP was contacted in this connection?
    context: Trickbot typically connects to command and control infrastructure.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - dst_ip
        - tls.server.certificate.subject
        - url.domain

  - question: Are there other suspicious network connections from this host?
    context: Trickbot often establishes multiple C2 connections and performs reconnaissance.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - bytes_in

  - question: Has this host made DNS queries for suspicious domains?
    context: Trickbot performs domain generation algorithm lookups and reconnaissance queries.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  - question: What files were created or modified around the time of this connection?
    context: Trickbot drops additional payloads and creates persistence mechanisms.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - file.path
        - file.hash.md5
        - file.mime_type
        - process.name

  - question: Are there signs of credential harvesting or data collection?
    context: Trickbot is known for stealing credentials and banking information.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          process.name|contains:
            - 'powershell.exe'
            - 'cmd.exe'
            - 'wmic.exe'
        condition: selection
      fields:
        - process.command_line
        - process.parent.name
        - User

  - question: Has this JA3 hash been observed on other hosts?
    context: Trickbot campaigns often target multiple systems within an organization.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          tls.ja3_hash: '1aa7bf8b97e540ca5edd75f7b8384bfa'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - tls.server.certificate.subject

  - question: Are there indicators of lateral movement from this host?
    context: Trickbot often spreads laterally using SMB and other protocols.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 445
            - 139
            - 3389
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out