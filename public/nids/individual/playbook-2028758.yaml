name: ET JA3 Hash - [Abuse.ch] Possible Quakbot
id: 22028758
description: |
  Detects TLS connections with JA3 hash associated with Quakbot malware.
  JA3 fingerprinting identifies TLS client behavior patterns. May trigger on legitimate applications using similar TLS configurations.
type: detection
detection_id: 2028758
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What is the complete TLS handshake fingerprint for this connection?
    context: JA3 hash identifies specific TLS client behavior patterns used by Quakbot.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - tls.ja3
        - tls.ja3_hash
        - tls.server.certificate.subject
        - tls.server.certificate.issuer

  - question: Is this TLS configuration typical for applications on this system?
    context: Legitimate software may occasionally use similar TLS client configurations.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - tls.ja3_hash
        - dst_ip
        - dst_port

  - question: What process established this TLS connection?
    context: Identifying the source process helps distinguish between malicious and legitimate connections.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - process.name
        - process.pid
        - process.command_line

  - question: What destination was contacted in this suspicious connection?
    context: Quakbot typically connects to command and control servers for instructions.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - dst_ip
        - tls.server.certificate.subject
        - url.domain

  - question: Are there other network connections indicating C2 communication?
    context: Quakbot establishes multiple connections for command and control and data exfiltration.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - bytes_in

  - question: Has this host performed suspicious DNS lookups?
    context: Quakbot uses domain generation algorithms and performs reconnaissance queries.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  - question: What files were created or accessed during the infection timeframe?
    context: Quakbot drops additional modules and creates persistence mechanisms.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - file.path
        - file.hash.md5
        - file.mime_type
        - process.name

  - question: Are there signs of email harvesting or credential theft?
    context: Quakbot is known for stealing email credentials and contact lists.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          process.name|contains:
            - 'outlook.exe'
            - 'powershell.exe'
            - 'rundll32.exe'
        condition: selection
      fields:
        - process.command_line
        - process.parent.name
        - User

  - question: Has this specific JA3 hash appeared on other systems?
    context: Quakbot campaigns often spread across multiple hosts in an organization.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          tls.ja3_hash: '3cda52da4ade09f1f781ad2e82dcfa20'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - tls.server.certificate.subject

  - question: Are there indicators of lateral movement or network spreading?
    context: Quakbot often spreads through network shares and remote access protocols.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 445
            - 139
            - 3389
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out