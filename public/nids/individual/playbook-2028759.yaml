name: ET JA3 Hash - [Abuse.ch] Possible Quakbot
id: 22028759
description: |
  Detects TLS connections with JA3 hash associated with Quakbot malware.
  JA3 fingerprinting identifies TLS client behavior patterns. May trigger on legitimate applications using similar TLS configurations.
type: detection
detection_id: 2028759
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What is the complete TLS handshake fingerprint for this connection?
    context: JA3 hash identifies specific TLS client behavior patterns used by Quakbot.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - tls.ja3
        - tls.ja3_hash
        - tls.server.certificate.subject
        - tls.server.certificate.issuer

  - question: Is this TLS configuration normal for this host's applications?
    context: Legitimate applications may occasionally use similar TLS client configurations.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - tls.ja3_hash
        - dst_ip
        - dst_port

  - question: What process initiated this TLS connection?
    context: Identifying the source process helps determine if connection is malicious or legitimate.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - process.name
        - process.pid
        - process.command_line

  - question: What destination server was contacted in this connection?
    context: Quakbot typically connects to command and control infrastructure.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - dst_ip
        - tls.server.certificate.subject
        - url.domain

  - question: Are there other suspicious network connections from this host?
    context: Quakbot establishes multiple C2 connections and performs data exfiltration.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - bytes_in

  - question: Has this host made DNS queries for suspicious domains?
    context: Quakbot uses domain generation algorithms and performs reconnaissance queries.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  - question: What files were created or modified around the infection time?
    context: Quakbot drops additional modules and establishes persistence mechanisms.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - file.path
        - file.hash.md5
        - file.mime_type
        - process.name

  - question: Are there signs of email credential harvesting or data theft?
    context: Quakbot is known for stealing email credentials and contact information.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          process.name|contains:
            - 'outlook.exe'
            - 'powershell.exe'
            - 'rundll32.exe'
        condition: selection
      fields:
        - process.command_line
        - process.parent.name
        - User

  - question: Has this JA3 hash been observed on other systems?
    context: Quakbot campaigns often target multiple hosts within an organization.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          tls.ja3_hash: '7dd50e112cd23734a310b90f6f44a7cd'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - tls.server.certificate.subject

  - question: Are there indicators of lateral movement from this host?
    context: Quakbot often spreads laterally using SMB and other network protocols.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 445
            - 139
            - 3389
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out