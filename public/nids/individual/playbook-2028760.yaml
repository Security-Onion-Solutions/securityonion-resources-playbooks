name: ET JA3 Hash - [Abuse.ch] Possible Troldesh Ransomware
id: 22028760
description: |
  Detects TLS connections with JA3 hash associated with Troldesh ransomware.
  JA3 fingerprinting identifies TLS client behavior patterns. May trigger on legitimate applications using similar TLS configurations.
type: detection
detection_id: 2028760
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What is the complete TLS handshake fingerprint for this connection?
    context: JA3 hash identifies specific TLS client behavior patterns used by Troldesh ransomware.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - tls.ja3
        - tls.ja3_hash
        - tls.server.certificate.subject
        - tls.server.certificate.issuer

  - question: Is this TLS configuration normal for applications on this system?
    context: Legitimate applications may occasionally use similar TLS client configurations.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - tls.ja3_hash
        - dst_ip
        - dst_port

  - question: What process established this suspicious TLS connection?
    context: Identifying the source process helps determine if connection is from ransomware or legitimate software.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - process.name
        - process.pid
        - process.command_line

  - question: What destination was contacted in this connection?
    context: Troldesh ransomware typically connects to payment servers or C2 infrastructure.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - dst_ip
        - tls.server.certificate.subject
        - url.domain

  - question: Are there signs of file encryption activity on this host?
    context: Troldesh ransomware encrypts files and may generate significant file system activity.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - file.path
        - file.extension
        - file.hash.md5
        - process.name

  - question: Have ransom notes or encrypted files been created?
    context: Troldesh creates ransom notes and renames encrypted files with specific extensions.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.path|contains:
            - 'README'
            - 'DECRYPT'
            - 'HELP'
        condition: selection
      fields:
        - file.path
        - file.name
        - process.name

  - question: Are there network connections to payment or cryptocurrency services?
    context: Ransomware often contacts payment processing or cryptocurrency services.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - bytes_in

  - question: What processes were executed around the time of encryption?
    context: Ransomware often uses specific tools and commands for file encryption and system modification.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - process.command_line
        - process.name
        - process.parent.name
        - User

  - question: Has this JA3 hash been observed on other systems?
    context: Ransomware campaigns often target multiple hosts within an organization.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          tls.ja3_hash: '1be3ecebe5aa9d3654e6e703d81f6928'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - tls.server.certificate.subject

  - question: Are there indicators of lateral movement or network spreading?
    context: Some ransomware variants attempt to spread to other systems before encryption.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 445
            - 139
            - 3389
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out

  - question: Have system recovery tools or shadow copies been disabled?
    context: Ransomware often disables system recovery mechanisms to prevent file restoration.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          process.name|contains:
            - 'vssadmin.exe'
            - 'wbadmin.exe'
            - 'bcdedit.exe'
        condition: selection
      fields:
        - process.command_line
        - process.parent.name
        - User