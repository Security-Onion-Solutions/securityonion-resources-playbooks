name: ET JA3 Hash - [Abuse.ch] Possible Adware
id: 22028768
description: |
  Detects TLS connections using JA3 fingerprint associated with adware applications.
  May trigger on legitimate applications sharing similar TLS client configurations.
type: detection
detection_id: 2028768
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What is the complete TLS handshake fingerprint for this adware connection?
    context: JA3 hash analysis reveals the exact TLS client configuration used by potential adware.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - tls.ja3
        - tls.ja3_hash
        - tls.server.certificate.subject
        - tls.server.certificate.issuer

  - question: Is this application legitimately installed and authorized on this system?
    context: Some legitimate software may share TLS configurations with adware, requiring verification of installation source.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - process.name
        - process.executable
        - process.command_line
        - user.name

  - question: What process is making connections with this adware TLS fingerprint?
    context: Identifying the source process helps distinguish between legitimate applications and unwanted adware.
    range: -5m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - process.pid

  - question: Does this connection pattern match typical adware behavior?
    context: Adware typically makes frequent connections to advertising networks and tracking services.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 80
            - 443
            - 8080
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.bytes_received

  - question: What triggered the installation or execution of this adware?
    context: Understanding how adware was installed helps identify attack vectors and prevent reinfection.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          process.name|contains:
            - "msiexec"
            - "setup"
            - "install"
            - "browser"
        condition: selection
      fields:
        - process.command_line
        - process.parent.name
        - user.name

  - question: What advertising or tracking domains is this adware contacting?
    context: Adware typically connects to advertising networks, analytics services, and tracking domains.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  - question: Are there signs of browser hijacking or unwanted modifications?
    context: Adware often modifies browser settings, installs extensions, or redirects search queries.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          process.name|contains:
            - "chrome"
            - "firefox"
            - "iexplore"
            - "msedge"
        condition: selection
      fields:
        - process.command_line
        - process.parent.name
        - user.name

  - question: What files were created or modified by this adware application?
    context: Adware creates configuration files, browser extensions, and tracking data on infected systems.
    range: +/-30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.extension|contains:
            - "exe"
            - "dll"
            - "crx"
            - "xpi"
            - "dat"
        condition: selection
      fields:
        - file.name
        - file.path
        - file.hash.md5
        - process.name

  - question: Is this adware part of a bundled software installation?
    context: Adware is often bundled with legitimate software and installed without explicit user consent.
    range: -6h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.extension|contains:
            - "msi"
            - "exe"
            - "zip"
        condition: selection
      fields:
        - file.name
        - file.path
        - file.size
        - process.name

  - question: Are other hosts showing similar adware JA3 fingerprints?
    context: Adware campaigns may target multiple users through software bundles or malicious websites.
    range: +/-12h
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          tls.ja3_hash: "fb58831f892190644fe44e25bc830b45"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - tls.server.certificate.subject

  - question: What is the impact on system performance and user experience?
    context: Adware can significantly impact system performance through resource consumption and unwanted advertisements.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 80
            - 443
        condition: selection
      fields:
        - dst_ip
        - network.bytes_sent
        - network.bytes_received

  - question: Are there registry modifications indicating adware persistence?
    context: Adware modifies registry entries to maintain persistence and control browser behavior.
    range: +/-1h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          registry.key|contains:
            - "Software\\Microsoft\\Internet Explorer"
            - "Software\\Google\\Chrome"
            - "Software\\Mozilla\\Firefox"
        condition: selection
      fields:
        - registry.key
        - registry.value.name
        - registry.value.data
        - process.name