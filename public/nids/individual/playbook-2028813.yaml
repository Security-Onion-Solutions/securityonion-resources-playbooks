name: ET JA3 Hash - [Abuse.ch] Possible Trickbot
id: 22028813
description: |
  Detects TLS connections using JA3 fingerprint associated with Trickbot banking trojan.
  May trigger on legitimate software but requires immediate investigation due to Trickbot's credential theft and lateral movement capabilities.
type: detection
detection_id: 2028813
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete TLS handshake fingerprint and destination details?
    context: Analyzing the full TLS connection details helps confirm the JA3 hash match and identify Trickbot C2 infrastructure.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - tls.client.ja3
        - dst_ip
        - dst_port
        - tls.server.certificate.subject
        - tls.server.certificate.issuer

  - question: Is this connection from authorized enterprise or banking software?
    context: Trickbot detection may false positive on legitimate enterprise applications using similar TLS libraries.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - "enterprise"
            - "corporate"
            - "bank"
            - "financial"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ParentImage

  - question: What process initiated this Trickbot-associated TLS connection?
    context: Identifying the source process is critical to confirm Trickbot infection and assess compromise scope.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ParentImage
        - ProcessGuid

  - question: Are there signs of credential harvesting or browser manipulation?
    context: Trickbot injects into browsers to steal banking credentials and manipulate financial transactions.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - "chrome.exe"
            - "firefox.exe"
            - "iexplore.exe"
            - "msedge.exe"
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid

  - question: Has Trickbot attempted lateral movement or network reconnaissance?
    context: Trickbot actively scans networks and attempts to spread to other systems using various techniques.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 445
            - 139
            - 135
            - 3389
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.protocol
        - network.bytes

  - question: What C2 communication patterns indicate active Trickbot infection?
    context: Trickbot maintains persistent C2 communication for command execution and data exfiltration.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.protocol
        - network.bytes

  - question: Are there signs of additional malware deployment or payload downloads?
    context: Trickbot often serves as a dropper for other malware including ransomware and additional banking trojans.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - ".exe"
            - ".dll"
            - "temp"
            - "download"
        condition: selection
      fields:
        - TargetFilename
        - Image
        - file.hash.md5
        - file.mime_type

  - question: Has Trickbot established persistence mechanisms on this system?
    context: Trickbot uses multiple persistence techniques including registry modifications and scheduled tasks.
    range: -4h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - "Run"
            - "RunOnce"
            - "Services"
            - "Task"
        condition: selection
      fields:
        - TargetObject
        - Details
        - Image

  - question: What banking and financial domains were accessed during the infection?
    context: Trickbot targets specific banking institutions and financial services for credential theft.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          dns.query.name|contains:
            - "bank"
            - "credit"
            - "paypal"
            - "financial"
            - "crypto"
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  - question: Are there indicators of domain admin or high-privilege account compromise?
    context: Trickbot actively targets domain administrators and high-privilege accounts for lateral movement.
    range: -8h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          User|contains:
            - "admin"
            - "domain"
            - "service"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: What other systems show Trickbot-related activity or similar JA3 fingerprints?
    context: Trickbot campaigns often target multiple systems simultaneously for maximum impact and credential harvesting.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "JA3 Hash"
          rule.name|contains: "Trickbot"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name