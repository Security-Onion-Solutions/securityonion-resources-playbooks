name: ET MALWARE Observed Malicious SSL Cert (AZORult CnC Server) 2019-10-08
id: 22028894
description: |
  Detects SSL certificate used by AZORult malware command and control servers.
  AZORult is an information stealer that harvests credentials, browser data, and cryptocurrency wallets.
  Legitimate traffic to cloudcitytechnologies.com would be rare but possible.
type: detection
detection_id: 2028894
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What is the exact SSL certificate subject that triggered this alert?
    context: Confirms the specific malicious certificate used by AZORult C2 infrastructure.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - tls.server.certificate.subject
        - tls.server.certificate.issuer
        - tls.server.certificate.fingerprint

  - question: Is this connection part of legitimate business operations?
    context: Determines if the SSL connection could be authorized administrative or business activity.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 443
        condition: selection
      fields:
        - src_ip
        - bytes_toserver
        - bytes_toclient

  - question: What initiated the SSL connection to this malicious certificate?
    context: Identifies the process or application that established the connection to AZORult C2.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: What other network connections occurred around the same time?
    context: Reveals the sequence of network activity that may indicate AZORult infection stages.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver
        - bytes_toclient

  - question: Has the AZORult malware successfully established persistence?
    context: Determines if the malware has created persistence mechanisms on the infected system.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - 'Run'
            - 'RunOnce'
            - 'Services'
        condition: selection
      fields:
        - TargetObject
        - Details
        - Image

  - question: What data exfiltration patterns are visible after the C2 connection?
    context: Identifies potential data theft activity following AZORult C2 communication.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          bytes_toserver|gte: 10000
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver

  - question: Are there signs of credential harvesting file access?
    context: Detects AZORult accessing browser profiles and credential stores for data theft.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - 'Login Data'
            - 'Cookies'
            - 'Web Data'
            - 'wallet.dat'
        condition: selection
      fields:
        - TargetFilename
        - Image
        - ProcessGuid

  - question: What specific AZORult variant or configuration is indicated?
    context: Determines the specific AZORult build and capabilities based on network behavior.
    range: +/-30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - http.request.method
        - http.request.body.content
        - url.path

  - question: Are cryptocurrency wallet files being accessed or modified?
    context: Identifies AZORult's cryptocurrency theft capabilities being utilized.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - 'wallet.dat'
            - 'Electrum'
            - 'Exodus'
            - 'Atomic'
        condition: selection
      fields:
        - TargetFilename
        - Image
        - file.hash.md5

  - question: Are other systems in the enterprise showing similar AZORult activity?
    context: Determines if this is part of a broader AZORult campaign across the organization.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          tls.server.certificate.subject|contains: 'cloudcitytechnologies.com'
        condition: selection
      fields:
        - src_ip
        - dst_ip

  - question: What related IOCs appear across enterprise systems?
    context: Identifies additional AZORult infrastructure and campaign indicators.
    range: +/-7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'AZORult'
            - 'cloudcitytechnologies'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name