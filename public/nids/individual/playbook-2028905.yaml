name: ET MALWARE Observed Malicious SSL Cert (CobInt CnC)
id: 22028905
description: |
  Detects SSL certificate used by CobInt malware command and control servers.
  CobInt is a banking trojan that targets financial institutions and payment systems.
  The domain fraud-bank.host is clearly malicious and designed to mimic legitimate banking infrastructure.
type: detection
detection_id: 2028905
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What is the complete SSL certificate information for this CobInt C2?
    context: Captures full certificate details to understand the CobInt infrastructure setup.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - tls.server.certificate.subject
        - tls.server.certificate.issuer
        - tls.server.certificate.fingerprint
        - tls.server.certificate.not_after

  - question: Is this SSL connection authorized for banking or financial operations?
    context: Eliminates false positives by checking if this could be legitimate financial system access.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 443
        condition: selection
      fields:
        - src_ip
        - bytes_toserver
        - bytes_toclient

  - question: What process initiated the connection to the CobInt C2 server?
    context: Identifies the malware process or infected application communicating with CobInt infrastructure.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid
        - ParentImage

  - question: What banking-related network activity preceded this C2 connection?
    context: Reveals if CobInt was triggered by banking website visits or financial application usage.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          dns.query.name|contains:
            - 'bank'
            - 'credit'
            - 'paypal'
            - 'financial'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip

  - question: Has CobInt injected into banking or browser processes?
    context: Determines if the banking trojan has successfully performed process injection for credential theft.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'chrome.exe'
            - 'firefox.exe'
            - 'iexplore.exe'
            - 'msedge.exe'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid

  - question: What financial data is being exfiltrated to the C2 server?
    context: Identifies data theft patterns characteristic of banking trojan operations.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          bytes_toserver|gte: 1000
        condition: selection
      fields:
        - bytes_toserver
        - bytes_toclient
        - dst_port

  - question: Are there signs of web form interception or keylogging?
    context: Detects CobInt's credential harvesting mechanisms targeting banking forms.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - 'keylog'
            - 'form'
            - 'credential'
            - '.log'
        condition: selection
      fields:
        - TargetFilename
        - Image
        - ProcessGuid

  - question: What banking websites or applications are being targeted?
    context: Identifies the specific financial institutions being targeted by this CobInt campaign.
    range: +/-1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.full|contains:
            - 'login'
            - 'signin'
            - 'account'
            - 'banking'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - dst_ip

  - question: Has CobInt established persistence for continued banking monitoring?
    context: Determines if the banking trojan has created mechanisms to survive reboots and continue operations.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - 'Run'
            - 'RunOnce'
            - 'StartupApproved'
        condition: selection
      fields:
        - TargetObject
        - Details
        - Image

  - question: Are other systems showing CobInt banking trojan indicators?
    context: Assesses the scope of CobInt infection across the enterprise financial environment.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          tls.server.certificate.subject|contains: 'fraud-bank.host'
        condition: selection
      fields:
        - src_ip
        - dst_ip

  - question: What related banking trojan IOCs appear enterprise-wide?
    context: Identifies additional CobInt campaign infrastructure and related banking malware.
    range: +/-7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'CobInt'
            - 'banking'
            - 'fraud-bank'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name