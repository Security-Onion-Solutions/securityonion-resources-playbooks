name: ET MALWARE Suspected Zebrocy Implant CnC Checkin
id: 22028906
description: |
  Detects suspected Zebrocy malware command and control communication patterns.
  This alert triggers on HTTP POST requests with specific parameter combinations used by Zebrocy implants for system reconnaissance data exfiltration.
  May occasionally trigger on legitimate applications using similar parameter names, but the specific combination and UTF-8 charset are highly indicative of Zebrocy activity.
type: detection
detection_id: 2028906
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What system reconnaissance data is being exfiltrated in this Zebrocy checkin?
    context: Understanding the specific data being sent reveals the scope of system compromise and intelligence gathering.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.body.content
        - http.request.method
        - url.full
        - http.content_type

  - question: Is this HTTP POST pattern consistent with normal application behavior on this host?
    context: Determines if this represents legitimate software or confirms malicious Zebrocy activity.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method: 'POST'
        condition: selection
      fields:
        - dst_ip
        - url.path
        - http.request.body.content

  - question: What process initiated this suspected Zebrocy communication?
    context: Identifies the malware executable and potential infection vector.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid
        - ParentImage

  - question: What additional C2 communication patterns are present from this host?
    context: Reveals the full scope of malware communication and potential multi-stage payloads.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - http.request.method
        - url.path
        - http.request.body.content
        - http.response.status_code

  - question: Has this host been compromised by other APT28/Zebrocy related malware?
    context: Determines if this is part of a broader APT28 campaign targeting this system.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'APT28'
            - 'Zebrocy'
            - 'Fancy Bear'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - rule.category

  - question: What files have been accessed or modified during this infection period?
    context: Identifies potential data theft targets and persistence mechanisms.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.mime_type
        - User

  - question: Are there signs of credential harvesting or authentication data theft?
    context: Zebrocy is known for credential theft and this reveals potential account compromise.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - 'password'
            - 'credential'
            - 'login'
            - 'browser'
            - 'cookie'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - User

  - question: What persistence mechanisms have been established on this system?
    context: Identifies how the Zebrocy implant maintains access for continued C2 communication.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - 'Run'
            - 'RunOnce'
            - 'Service'
            - 'Startup'
        condition: selection
      fields:
        - TargetObject
        - Details
        - User

  - question: Is this C2 server hosting other malware families or campaigns?
    context: Reveals the scope of threat actor infrastructure and potential multi-family operations.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.category|contains:
            - 'malware'
            - 'trojan'
            - 'command-and-control'
        condition: selection
      fields:
        - src_ip
        - rule.name
        - rule.category

  - question: Are other internal hosts communicating with this Zebrocy C2 server?
    context: Identifies the organizational scope of the APT28/Zebrocy campaign.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|expand: '%dst_port%'
        condition: selection
      fields:
        - src_ip
        - bytes_out
        - bytes_in

  - question: What additional reconnaissance or lateral movement activity has occurred?
    context: Assesses the broader impact of the Zebrocy infection beyond initial C2 communication.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - bytes_in