name: ET MALWARE Observed Malicious SSL Cert (MalDoc DL) 2019-10-24
id: 22028911
description: |
  Detects SSL certificate used for malicious document distribution infrastructure.
  The certificate for www.daftstone.top is associated with malware delivery campaigns.
  This domain is used to host and distribute weaponized documents containing malware payloads.
type: detection
detection_id: 2028911
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What is the complete SSL certificate information for this malicious document server?
    context: Captures full certificate details to understand the malware distribution infrastructure.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - tls.server.certificate.subject
        - tls.server.certificate.issuer
        - tls.server.certificate.fingerprint
        - tls.server.certificate.not_after

  - question: Could this be legitimate document sharing or cloud storage access?
    context: Eliminates false positives by checking if this could be authorized document repository access.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 443
        condition: selection
      fields:
        - src_ip
        - bytes_toserver
        - bytes_toclient
        - duration

  - question: What process or application initiated the connection to this malicious document server?
    context: Identifies how the user accessed the malicious document distribution site.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'chrome.exe'
            - 'firefox.exe'
            - 'iexplore.exe'
            - 'msedge.exe'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: What documents or files were downloaded from this malicious server?
    context: Identifies the specific malicious documents or payloads retrieved from the distribution site.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - 'Downloads'
            - 'Temp'
            - 'AppData'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size
        - Image

  - question: Have any Office documents been opened following this download?
    context: Determines if weaponized documents from the malicious server have been executed.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'winword.exe'
            - 'excel.exe'
            - 'powerpnt.exe'
            - 'acrord32.exe'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ProcessGuid
        - ParentImage

  - question: Are there signs of macro execution or document-based payload delivery?
    context: Detects if malicious documents have successfully executed their embedded payloads.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          ParentImage|contains:
            - 'winword.exe'
            - 'excel.exe'
            - 'powerpnt.exe'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ProcessGuid
        - User

  - question: What secondary malware has been downloaded after document execution?
    context: Identifies additional malware payloads retrieved following successful document exploitation.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port:
            - 80
            - 443
          bytes_toclient|gte: 50000
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toclient
        - duration

  - question: What specific malware family was distributed via this document server?
    context: Determines the type of malware payload delivered through the malicious document campaign.
    range: +6h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|endswith: '.exe'
          file.size|gte: 10000
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size
        - Image

  - question: Has the delivered malware established C2 communications?
    context: Identifies if the document-delivered payload has successfully contacted its command and control server.
    range: +8h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          bytes_toserver|gte: 100
          bytes_toserver|lte: 1000
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver
        - bytes_toclient

  - question: Are other enterprise users accessing this malicious document distribution site?
    context: Assesses the scope of potential document-based infections across the organization.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          tls.server.certificate.subject|contains: 'daftstone.top'
        condition: selection
      fields:
        - src_ip
        - dst_ip

  - question: What related malicious document campaign IOCs appear enterprise-wide?
    context: Identifies additional infrastructure and indicators associated with this document distribution campaign.
    range: +/-7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'MalDoc'
            - 'daftstone'
            - 'document'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name