name: ET EXPLOIT VMware VeloCloud Authorization Bypass (CVE-2019-5533)
id: 22028928
description: |
  Detects exploitation attempts targeting CVE-2019-5533, an authorization bypass vulnerability in VMware VeloCloud.
  Attackers can bypass authentication by manipulating JSON-RPC parameters to gain unauthorized access to enterprise user data.
  May trigger on legitimate JSON-RPC API calls with similar parameter structures.
type: detection
detection_id: 2028928
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete JSON-RPC payload structure in the exploitation attempt?
    context: Understanding the exact payload reveals the specific parameter manipulation used to bypass authorization.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.body.content
        - http.request.method
        - url.full

  - question: What specific getEnterpriseUser parameters were manipulated in the request?
    context: The vulnerability exploits parameter confusion in JSON-RPC calls to access unauthorized user data.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.request.body.content
        - http.request.headers
        - url.path

  # Type 2: Triage Assessment
  - question: Is this system a known VMware VeloCloud deployment requiring legitimate JSON-RPC access?
    context: Legitimate VeloCloud management may generate similar API calls during normal operations.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          http.request.method: "POST"
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.request.body.content

  - question: Does the source IP have authorized access to VMware VeloCloud management interfaces?
    context: Authorized administrators would typically access VeloCloud from known management networks.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 80
            - 443
            - 8080
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out

  # Type 3: Activity Context
  - question: What reconnaissance activity preceded this exploitation attempt?
    context: Attackers typically perform discovery scans before targeting specific CVEs.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.request.method
        - http.response.status_code

  - question: What was the sequence of JSON-RPC calls leading to this bypass attempt?
    context: Understanding the attack progression helps identify the exploitation methodology.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.request.method: "POST"
        condition: selection
      fields:
        - url.path
        - http.request.body.content
        - http.response.status_code

  # Type 4: Impact Assessment
  - question: Did the authorization bypass succeed and return enterprise user data?
    context: Successful exploitation would result in unauthorized access to sensitive user information.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - bytes_in

  - question: What sensitive data was potentially accessed through the unauthorized getEnterpriseUser calls?
    context: The vulnerability allows access to enterprise user configurations and potentially sensitive network data.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - bytes_in
        - bytes_out
        - duration

  # Type 5: Forensic Deep-Dive
  - question: What other VMware VeloCloud API endpoints were targeted by this attacker?
    context: Successful authorization bypass often leads to broader API enumeration and exploitation.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.request.method: "POST"
        condition: selection
      fields:
        - url.path
        - http.request.body.content
        - http.response.status_code

  - question: Are there indicators of automated exploitation tools or manual testing patterns?
    context: The timing and structure of requests can reveal whether this is automated scanning or targeted manual exploitation.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - url.path
        - http.request.headers

  # Type 6: Enterprise Correlation
  - question: Are other VMware VeloCloud systems in the environment being targeted with similar bypass attempts?
    context: Attackers often target multiple instances of vulnerable software across the enterprise.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "VeloCloud"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is this part of a broader campaign targeting VMware infrastructure vulnerabilities?
    context: CVE-2019-5533 exploitation may be part of larger VMware-focused attack campaigns.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - "VMware"
            - "vCenter"
            - "ESXi"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name