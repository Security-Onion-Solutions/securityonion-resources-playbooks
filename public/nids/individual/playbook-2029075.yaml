name: ET ADWARE_PUP Win32/Adware.Bang5mai.BB CnC Activity M1
id: 22029075
description: |
  Detects Win32/Adware.Bang5mai.BB command and control communication via specific HTTP GET request pattern.
  May trigger on legitimate web traffic with similar URL parameters, but typically indicates adware infection.
type: detection
detection_id: 2029075
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete HTTP request that triggered this Bang5mai adware detection?
    context: Understanding the full request reveals adware communication patterns and potential data exfiltration.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - http.request.headers
        - http.response.status_code

  - question: What specific parameters were included in the Bang5mai C2 communication?
    context: Analyzing URL parameters reveals what information the adware is transmitting to its C2 server.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - url.query
        - url.path
        - http.request.body.content
        - dst_ip

  - question: Is this HTTP traffic pattern normal for this user or system?
    context: Establishing baseline web behavior helps distinguish adware from legitimate application traffic.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains: '.gif'
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - http.request.method
        - request_count

  - question: What web browser or application initiated this Bang5mai communication?
    context: Identifying the source application helps understand infection vector and removal requirements.
    range: -15m/+15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'chrome.exe'
            - 'firefox.exe'
            - 'iexplore.exe'
            - 'edge.exe'
            - 'opera.exe'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - User
        - ProcessGuid

  - question: Are there other suspicious HTTP requests from this system around the same time?
    context: Adware often makes multiple requests and may communicate with several C2 servers.
    range: -30m/+30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.full
        - dst_ip
        - http.response.status_code
        - url.domain

  - question: Has this system recently downloaded any executable files or browser extensions?
    context: Understanding how Bang5mai was installed helps prevent reinfection and identify attack vectors.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - '.exe'
            - '.dll'
            - '.crx'
            - '.xpi'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size
        - ProcessName

  - question: What DNS queries were made to resolve the Bang5mai C2 domain?
    context: DNS resolution activity reveals the C2 infrastructure and timing of communications.
    range: -1h/+1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.resolved_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  - question: Are there signs of browser hijacking or modified browser settings?
    context: Bang5mai adware often modifies browser configurations to maintain persistence.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - 'Software\\Microsoft\\Internet Explorer'
            - 'Software\\Google\\Chrome'
            - 'Software\\Mozilla\\Firefox'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessName
        - EventType

  - question: What other network connections has this system made to external servers?
    context: Adware may communicate with multiple servers for ads, updates, or additional payload downloads.
    range: -2h/+2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - protocol
        - bytes_out
        - bytes_in

  - question: Are there other systems in the network showing similar Bang5mai activity?
    context: Adware can spread through shared files or network-based infection vectors.
    range: -6h/+6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'Bang5mai'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - alert_count

  - question: Has this system exhibited any performance issues or unusual browser behavior?
    context: Understanding user impact helps prioritize remediation and assess adware effectiveness.
    range: -4h/+4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.domain
        - http.response.status_code
        - request_count
        - dst_ip