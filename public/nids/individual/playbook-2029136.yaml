name: ET MALWARE AZORult v3.3 Server Response M1
id: 22029136
description: |
  Detects AZORult v3.3 malware command and control server response pattern M1.
  AZORult is an information stealer that harvests credentials, browser data, and system information.
  This signature identifies encrypted C2 communication from the malware server to infected endpoints.
type: detection
detection_id: 2029136
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete HTTP response containing the AZORult signature pattern?
    context: Analyzing the full server response reveals C2 communication structure and potential payload delivery.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.response.body.content
        - http.response.status_code
        - http.response.headers

  - question: What was the original HTTP request that triggered this C2 response?
    context: Understanding the client request helps identify the malware's communication protocol and timing.
    range: -5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.request.method: "GET"
        condition: selection
      fields:
        - http.request.method
        - url.full
        - http.request.headers

  # Type 2: Triage Assessment
  - question: Is this connection from a known legitimate application or service?
    context: Eliminates false positives from legitimate software that might use similar binary patterns.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - network.bytes

  # Type 3: Activity Context
  - question: What process initiated this HTTP connection on the infected system?
    context: Identifying the parent process helps determine infection vector and malware persistence.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - user.name

  - question: What other network connections occurred around the same time from this host?
    context: AZORult typically makes multiple C2 connections for data exfiltration and command retrieval.
    range: -30m/+30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.protocol
        - network.bytes

  # Type 4: Impact Assessment
  - question: Has the malware successfully established persistent C2 communication?
    context: Multiple successful responses indicate active infection requiring immediate containment.
    range: -2h/+2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.response.status_code: "200"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - http.response.status_code

  - question: What data volume has been transmitted in this C2 session?
    context: Large outbound transfers may indicate credential theft or system information exfiltration.
    range: -1h/+1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - network.bytes_sent
        - network.bytes_received
        - network.packets

  # Type 5: Forensic Deep-Dive
  - question: Are there signs of credential harvesting or browser data theft on this system?
    context: AZORult specifically targets stored credentials and browser profiles for theft.
    range: -1h/+1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.path|contains:
            - "\\AppData\\Local\\Google\\Chrome"
            - "\\AppData\\Roaming\\Mozilla\\Firefox"
            - "\\Login Data"
            - "\\Cookies"
        condition: selection
      fields:
        - file.path
        - file.name
        - process.name
        - user.name

  - question: What persistence mechanisms has the malware established?
    context: Understanding persistence helps with complete malware removal and prevents reinfection.
    range: -2h/+1h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          registry.path|contains:
            - "\\Run\\"
            - "\\RunOnce\\"
            - "\\Services\\"
        condition: selection
      fields:
        - registry.path
        - registry.value
        - process.name

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network communicating with this same C2 server?
    context: Identifies the scope of AZORult infection across the enterprise environment.
    range: -24h/+24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - network.bytes

  - question: What related AZORult IOCs are present enterprise-wide?
    context: Correlates with other AZORult signatures to understand campaign scope and infection timeline.
    range: -7d/+1d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "AZORult"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - rule.category