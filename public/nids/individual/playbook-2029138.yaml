name: ET MALWARE AZORult v3.3 Server Response M3
id: 22029138
description: |
  Detects AZORult v3.3 malware command and control server response pattern M3.
  AZORult is an information stealer that harvests credentials, browser data, and system information.
  This signature identifies another encrypted C2 communication pattern from the malware server.
type: detection
detection_id: 2029138
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete HTTP response containing the AZORult M3 signature pattern?
    context: Analyzing the full server response reveals C2 communication structure and potential command payload.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.response.body.content
        - http.response.status_code
        - http.response.headers

  - question: What was the HTTP request that triggered this M3 response pattern?
    context: M3 patterns may indicate specific malware commands or final data exfiltration phases.
    range: -5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.request.method: "GET"
        condition: selection
      fields:
        - http.request.method
        - url.full
        - http.request.body.content

  # Type 2: Triage Assessment
  - question: Is this M3 pattern from a known legitimate application?
    context: Eliminates false positives from software that might use similar binary communication protocols.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - network.bytes

  # Type 3: Activity Context
  - question: What process initiated this M3 pattern HTTP connection?
    context: Identifying the process helps understand the malware's execution context and infection method.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - user.name

  - question: What is the complete sequence of AZORult communications including this M3 pattern?
    context: Understanding the full communication sequence reveals malware operational phases and completion status.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: "AZORult"
        condition: selection
      fields:
        - rule.name
        - rule.category
        - src_ip
        - dst_ip

  # Type 4: Impact Assessment
  - question: Has the M3 pattern communication resulted in final data exfiltration?
    context: M3 patterns may indicate completion of data theft operations requiring immediate containment.
    range: -2h/+2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - network.bytes_sent
        - network.bytes_received
        - dst_port

  - question: What sensitive data was accessed during the M3 pattern timeframe?
    context: Correlates M3 pattern timing with potential final credential or system information theft.
    range: -30m/+30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.path|contains:
            - "\\AppData\\Local\\Google\\Chrome"
            - "\\AppData\\Roaming\\Mozilla\\Firefox"
            - "\\System32\\config"
            - "\\Login Data"
        condition: selection
      fields:
        - file.path
        - file.name
        - process.name

  # Type 5: Forensic Deep-Dive
  - question: What specific AZORult capabilities does this M3 pattern represent?
    context: Different patterns help identify specific malware functions and their execution success.
    range: -1h/+1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "AZORult v3.3"
        condition: selection
      fields:
        - rule.name
        - rule.category
        - src_ip
        - dst_ip

  - question: Are there signs of system information harvesting associated with this M3 pattern?
    context: AZORult collects system information, and M3 patterns may indicate system profiling completion.
    range: -1h/+1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          process.name|contains:
            - "systeminfo.exe"
            - "wmic.exe"
            - "tasklist.exe"
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - user.name

  # Type 6: Enterprise Correlation
  - question: Are other systems showing similar M3 pattern communications?
    context: Identifies the scope of AZORult v3.3 M3 variant infections across the enterprise.
    range: -24h/+24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: "ET MALWARE AZORult v3.3 Server Response M3"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: What is the progression of AZORult pattern infections (M1, M2, M3) enterprise-wide?
    context: Understanding pattern progression helps identify attack campaign phases and completion status.
    range: -7d/+1d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "AZORult v3.3 Server Response"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - rule.category