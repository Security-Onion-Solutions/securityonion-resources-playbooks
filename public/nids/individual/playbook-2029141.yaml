name: ET MALWARE AZORult v3.2 Server Response M3
id: 22029141
description: |
  Detects AZORult v3.2 malware command and control server responses based on specific binary patterns.
  AZORult is an information stealer that exfiltrates credentials, browser data, and system information.
  This signature identifies the malware receiving configuration or commands from its C2 server.
type: detection
detection_id: 2029141
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete HTTP response containing the AZORult binary signature?
    context: The specific binary pattern indicates AZORult C2 communication and may contain encoded configuration data.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.response_body
        - http.status_code
        - url.full
        - http.request.method

  - question: What is the size and structure of the malicious HTTP response?
    context: Response size and headers can indicate the type of payload being delivered by the C2 server.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.body.bytes
        - http.response.headers
        - http.response.mime_type

  # Type 2: Triage Assessment
  - question: Is this connection part of legitimate business traffic to this destination?
    context: Determines if the C2 communication is authorized or represents actual malware infection.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - proto

  - question: Has this source system established other suspicious connections recently?
    context: Multiple C2 connections from the same host indicate active malware infection requiring immediate response.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - malware
            - trojan
            - command-and-control
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - dst_port

  # Type 3: Activity Context
  - question: What process initiated the HTTP connection that received this C2 response?
    context: Identifying the infected process helps determine malware persistence and system compromise scope.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          ProcessGuid|expand: '%ProcessGuid%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ParentImage

  - question: What network activity preceded this C2 response?
    context: Understanding the initial infection vector helps identify how AZORult was delivered to the system.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto
        - bytes_toserver
        - bytes_toclient

  - question: Were there any file downloads or modifications around the time of C2 communication?
    context: AZORult often downloads additional payloads or updates its configuration after C2 contact.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size
        - ProcessGuid

  # Type 4: Impact Assessment
  - question: What sensitive data could AZORult have accessed on this system?
    context: AZORult targets browser credentials, cryptocurrency wallets, and system information for exfiltration.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - wallet
            - credential
            - password
            - cookie
            - login
        condition: selection
      fields:
        - TargetFilename
        - ProcessGuid
        - file.hash.md5

  - question: Has data exfiltration occurred following this C2 communication?
    context: Large outbound transfers after C2 contact indicate successful data theft requiring breach notification.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          bytes_toserver: ">10000"
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver
        - proto

  # Type 5: Forensic Deep-Dive
  - question: What is the complete AZORult infection timeline on this system?
    context: Full timeline analysis reveals persistence mechanisms and helps determine complete system compromise.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: AZORult
        condition: selection
      fields:
        - rule.name
        - rule.category
        - dst_ip
        - community_id

  - question: What registry modifications indicate AZORult persistence mechanisms?
    context: Registry changes reveal how AZORult maintains persistence and can guide remediation efforts.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - Run
            - RunOnce
            - Services
            - Startup
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessGuid

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network showing similar AZORult C2 activity?
    context: AZORult campaigns often target multiple systems simultaneously, requiring coordinated response.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: AZORult
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - rule.name
        - community_id