name: ET MALWARE Possible XServer Backdoor Certificate Observed
id: 22029190
description: |
  Detects SSL certificate patterns associated with XServer backdoor malware.
  The certificate contains specific ASN.1 structure with "US", "BA", and "Root" organizational fields.
  Legitimate certificates would not use this exact combination of certificate fields and values.
type: detection
detection_id: 2029190
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What is the complete ASN.1 structure of this suspicious certificate?
    context: Full certificate analysis reveals XServer backdoor infrastructure characteristics and campaign attribution.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - tls.server.certificate.subject
        - tls.server.certificate.issuer
        - tls.server.certificate.serial_number
        - tls.server.certificate.fingerprint

  - question: What is the destination IP and port for this XServer backdoor connection?
    context: Identifying C2 infrastructure helps with blocking and threat intelligence correlation.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - src_ip
        - src_port
        - protocol

  - question: What raw certificate data was transmitted in this connection?
    context: Raw certificate bytes help identify specific XServer backdoor variants and infrastructure reuse.
    query: |
      aggregation: false
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - tls.server.certificate.raw
        - tls.version
        - tls.cipher_suite

  # Type 2: Triage Assessment
  - question: Is this connection to a known legitimate service or application?
    context: XServer backdoor may masquerade as legitimate services but uses distinctive certificate patterns.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|expand: '%dst_port%'
        condition: selection
      fields:
        - dst_ip
        - bytes_sent
        - bytes_received
        - duration

  - question: Does this connection timing align with normal administrative activity?
    context: Backdoor connections often occur outside business hours or during maintenance windows.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - User
        - Image
        - ProcessGuid

  # Type 3: Activity Context
  - question: What process initiated this connection to the XServer backdoor?
    context: Identifying the source process helps determine infection vector and system compromise method.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - User
        - ProcessGuid

  - question: What other network activity occurred from this host around the same time?
    context: XServer backdoor often operates alongside other malware or reconnaissance tools.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - protocol
        - bytes_sent
        - bytes_received

  - question: What DNS queries preceded this backdoor connection?
    context: DNS resolution patterns help identify C2 infrastructure and domain generation algorithms.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  # Type 4: Impact Assessment
  - question: What data has been transmitted through this backdoor connection?
    context: Large data transfers may indicate system information gathering or data exfiltration.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port|expand: '%dst_port%'
        condition: selection
      fields:
        - bytes_sent
        - bytes_received
        - duration
        - connection_state

  - question: Are there signs of remote command execution or system manipulation?
    context: XServer backdoor provides remote access capabilities for system control and data theft.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: What files were accessed or modified after backdoor connection?
    context: Backdoor activity often involves file access, data collection, or payload deployment.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.mime_type
        - ProcessImage

  # Type 5: Forensic Deep-Dive
  - question: What persistence mechanisms has the XServer backdoor established?
    context: Backdoors typically create persistence to maintain access across system reboots.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetObject
        - Details
        - EventType
        - ProcessImage

  - question: What system information or credentials has been harvested?
    context: XServer backdoor often collects system details and user credentials for further exploitation.
    range: +6h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - 'temp'
            - 'log'
            - 'dump'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessImage

  # Type 6: Enterprise Correlation
  - question: Are other systems showing XServer backdoor certificate patterns?
    context: XServer campaigns often target multiple systems using consistent infrastructure.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          tls.server.certificate.subject|contains: 'Root'
          tls.server.certificate.issuer|contains: 'Root'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - tls.server.certificate.subject
        - tls.server.certificate.fingerprint

  - question: What is the scope of this XServer backdoor campaign across the enterprise?
    context: Understanding campaign breadth helps prioritize response and identify related infrastructure.
    range: -60d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'XServer'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - rule.category