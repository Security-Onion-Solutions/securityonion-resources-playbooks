name: ET MALWARE Kimsuky Operation Blue Estimate CnC Activity
id: 22029222
description: |
  Detects Kimsuky APT group Operation Blue Estimate command and control activity via HTTP POST with log file uploads.
  Legitimate applications would not send log files with this specific naming pattern and content structure.
type: detection
detection_id: 2029222
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What log file data was exfiltrated to the Kimsuky C2 server?
    context: The _log.txt filename pattern and binary content structure reveals the type of information being stolen by the APT group.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.body.content
        - http.request.method
        - url.full
        - http.content_type

  - question: What specific log file naming convention was used in the multipart upload?
    context: The filename parameter reveals the type of system logs being targeted by Kimsuky operators.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.request.body.content
        - src_ip
        - dst_ip
        - url.path

  # Type 2: Triage Assessment
  - question: Is this system authorized to upload log files to external PHP endpoints?
    context: Legitimate log management systems typically use secure protocols and authorized destinations, not arbitrary PHP scripts.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method: 'POST'
          url.path|endswith: '.php'
        condition: selection
      fields:
        - dst_ip
        - url.full
        - http.request.body.content

  - question: Has this endpoint been identified as a target in previous Kimsuky campaigns?
    context: Kimsuky often maintains long-term access to compromised systems across multiple operations.
    range: -90d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: 'Kimsuky'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - timestamp

  # Type 3: Activity Context
  - question: What process generated the log file being uploaded to the C2 server?
    context: Identifying the source process helps understand what system information is being compromised.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - ProcessId
        - User

  - question: What user or system activity preceded this data exfiltration?
    context: Understanding the trigger for log collection helps identify the scope of compromised information.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|endswith: '.log'
        condition: selection
      fields:
        - TargetFilename
        - Image
        - file.hash.md5

  - question: What other C2 communication has occurred from this compromised system?
    context: Kimsuky operations typically involve multiple stages of communication and data theft.
    range: +/-6h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method: 'POST'
        condition: selection
      fields:
        - dst_ip
        - url.full
        - http.request.body.content
        - http.content_type

  # Type 4: Impact Assessment
  - question: What sensitive information was contained in the exfiltrated log files?
    context: System logs may contain credentials, network topology, user activity, and other sensitive operational data.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - 'security'
            - 'system'
            - 'application'
            - 'auth'
        condition: selection
      fields:
        - TargetFilename
        - file.size
        - Image

  - question: Has the Kimsuky implant established persistence or lateral movement capabilities?
    context: APT groups typically establish multiple persistence mechanisms and explore network access for expanded operations.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - 'Run'
            - 'Services'
            - 'WinLogon'
        condition: selection
      fields:
        - TargetObject
        - Details
        - Image

  # Type 5: Forensic Deep-Dive
  - question: What specific Kimsuky malware family and tools are present on this system?
    context: Different Kimsuky tools have varying capabilities for espionage, data theft, and persistence.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.mime_type|contains: 'executable'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.hash.sha256
        - file.size

  - question: What command and control infrastructure is being used in this Operation Blue Estimate campaign?
    context: Understanding the full C2 infrastructure helps with attribution and network defense measures.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  # Type 6: Enterprise Correlation
  - question: Are other systems showing signs of Kimsuky compromise or Operation Blue Estimate activity?
    context: APT campaigns typically target multiple systems within an organization for comprehensive intelligence gathering.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'Kimsuky'
            - 'Blue Estimate'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - timestamp

  - question: What attack vectors are being used to establish initial access across the enterprise?
    context: Kimsuky commonly uses spear-phishing and watering hole attacks to gain initial system access.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          http.request.headers.user_agent|contains:
            - 'Outlook'
            - 'Mail'
          http.request.method: 'GET'
        condition: selection
      fields:
        - src_ip
        - url.full
        - http.request.headers.user_agent