name: ET MALWARE Observed Magecart CnC Domain in TLS SNI
id: 22029228
description: |
  Detects TLS connections to known Magecart command and control infrastructure using the domain "googlc-analytics.net".
  This domain mimics legitimate Google Analytics to evade detection while facilitating credit card skimming operations.
  Legitimate traffic would connect to "google-analytics.com" not this typosquatted variant.
type: detection
detection_id: 2029228
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact TLS SNI value that triggered this alert?
    context: Confirms the specific typosquatted domain used by Magecart operators to mimic Google Analytics.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - tls.server_name
        - dst_ip
        - dst_port

  - question: What certificate details were observed for this malicious domain?
    context: SSL certificate information can reveal infrastructure patterns and help identify additional malicious domains.
    range: +/-5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - tls.server.certificate.subject
        - tls.server.certificate.issuer
        - tls.server.certificate.serial_number
        - tls.server.certificate.fingerprint.sha1

  # Type 2: Triage Assessment
  - question: Has this system previously connected to legitimate Google Analytics domains?
    context: Establishes baseline behavior to differentiate between compromised systems and normal analytics traffic.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 443
        condition: selection
      fields:
        - dst_ip
        - dst_port

  - question: Is this connection occurring during normal business hours for this system?
    context: Magecart operations often occur outside business hours to avoid detection during active monitoring.
    range: -1d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 443
        condition: selection
      fields:
        - src_ip
        - dst_port

  # Type 3: Activity Context
  - question: What web traffic preceded this TLS connection?
    context: Understanding the web session context helps identify the compromised website or application triggering the connection.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - url.full
        - http.request.method
        - http.response.status_code

  - question: What process initiated this network connection?
    context: Identifies the application or browser process responsible for the malicious connection.
    range: -5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - process.name
        - process.pid
        - process.command_line

  # Type 4: Impact Assessment
  - question: What data was transmitted to the Magecart CnC server?
    context: Determines if credit card or personal information was exfiltrated during the connection.
    range: +/-5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - network.bytes_sent
        - network.bytes_received
        - network.packets_sent
        - network.packets_received

  - question: Are there signs of JavaScript injection or DOM manipulation?
    context: Magecart typically injects malicious JavaScript into payment forms to steal credit card data.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.response.status_code: 200
        condition: selection
      fields:
        - url.full
        - http.response.body.content
        - http.request.referrer

  # Type 5: Forensic Deep-Dive
  - question: What other Magecart-related domains has this system contacted?
    context: Magecart groups often use multiple typosquatted domains for redundancy and evasion.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          tls.server_name|contains:
            - "google-analytics"
            - "googIe-analytics"
            - "goog1e-analytics"
            - "analytics-google"
        condition: selection
      fields:
        - tls.server_name
        - dst_ip

  - question: What browser or application user agent patterns are associated with this activity?
    context: Helps identify if the connection originated from a legitimate browser or automated malware.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - http.request.headers.user_agent
        - url.domain

  # Type 6: Enterprise Correlation
  - question: Are other systems in the organization connecting to this Magecart domain?
    context: Identifies the scope of potential compromise across the enterprise environment.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          tls.server_name: "googlc-analytics.net"
        condition: selection
      fields:
        - src_ip
        - dst_ip

  - question: What related Magecart indicators are present across the enterprise?
    context: Correlates this detection with other Magecart campaign indicators to understand attack scope.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Magecart"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name