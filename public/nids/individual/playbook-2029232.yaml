name: ET USER_AGENTS Observed Suspicious UA (DxD)
id: 22029232
description: |
  Detects HTTP requests using the suspicious user agent "DxD" which is associated with malicious activity including ransomware communication.
  This extremely short and non-standard user agent is not used by legitimate applications or browsers.
  Often indicates automated malware communication or reconnaissance activity.
type: detection
detection_id: 2029232
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete HTTP request using the DxD user agent?
    context: The full HTTP request reveals the target URL, method, and any payload associated with this suspicious user agent.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.request.body.content
        - http.request.headers.user_agent

  - question: What HTTP response was received for this suspicious request?
    context: The server response indicates whether the malicious request was successful and what data was returned.
    range: +/-2m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - http.response.headers

  # Type 2: Triage Assessment
  - question: Has this system used legitimate user agents in recent web traffic?
    context: Establishes baseline behavior to differentiate between compromised systems and normal browser activity.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - http.request.headers.user_agent
        - url.domain

  - question: Is this suspicious user agent activity occurring during normal business hours?
    context: Malware often operates outside business hours to avoid detection during active monitoring periods.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.headers.user_agent: "DxD"
        condition: selection
      fields:
        - dst_ip
        - url.domain

  # Type 3: Activity Context
  - question: What process is responsible for generating this suspicious HTTP traffic?
    context: Identifies the specific application or malware executable using the DxD user agent.
    range: -5m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - User

  - question: What network activity preceded this suspicious user agent request?
    context: Understanding the sequence of network events helps identify the initial trigger or infection vector.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.transport
        - network.protocol

  - question: What file system activity is associated with this network communication?
    context: Correlates the suspicious HTTP request with potential malware execution or payload delivery.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - file.name
        - file.path
        - process.name
        - file.hash.md5

  # Type 4: Impact Assessment
  - question: What data was transmitted using this suspicious user agent?
    context: Determines if sensitive information was exfiltrated or malicious commands were received.
    range: +/-5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - network.bytes_sent
        - network.bytes_received
        - network.packets_sent
        - network.packets_received

  - question: Are there signs of command and control communication patterns?
    context: Identifies if this is part of ongoing CnC communication indicating active malware infection.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.headers.user_agent: "DxD"
        condition: selection
      fields:
        - dst_ip
        - url.path
        - http.request.method

  # Type 5: Forensic Deep-Dive
  - question: What malware family is associated with this DxD user agent pattern?
    context: Correlates with known malware signatures to identify the specific threat and its capabilities.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "MALWARE"
            - "Trojan"
            - "Ransomware"
        condition: selection
      fields:
        - rule.name
        - rule.category
        - dst_ip

  - question: What persistence mechanisms are associated with this suspicious activity?
    context: Identifies how the malware using this user agent maintains access to the compromised system.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - "\\Run"
            - "\\RunOnce"
            - "\\Services"
        condition: selection
      fields:
        - TargetObject
        - Details
        - process.name

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network using this same suspicious user agent?
    context: Determines the scope of potential compromise across the enterprise environment.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          http.request.headers.user_agent: "DxD"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - url.domain

  - question: What related malicious user agent patterns are present enterprise-wide?
    context: Identifies coordinated malware campaigns using similar or related suspicious user agent strings.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "USER_AGENTS"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name