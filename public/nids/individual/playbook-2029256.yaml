name: ET PHISHING Observed Malicious SSL Cert (Office365 Phish Landing Page 2020-01-09)
id: 22029256
description: |
  Detects SSL certificate associated with Office365 phishing landing pages.
  This certificate is used by attackers to create convincing phishing sites that mimic legitimate Office365 login pages.
  Legitimate Office365 services do not use certificates from this domain.
type: detection
detection_id: 2029256
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What is the complete SSL certificate information for this phishing site?
    context: Certificate details reveal the phishing infrastructure and help identify other malicious sites using similar certificates.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - tls.server.certificate.subject
        - tls.server.certificate.issuer
        - tls.server.certificate.serial_number
        - tls.server.certificate.fingerprint_sha1

  - question: What user attempted to access this Office365 phishing site?
    context: Identifying the targeted user helps assess credential compromise risk and initiate user notification procedures.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port

  - question: Has this user previously accessed legitimate Office365 services?
    context: Understanding normal Office365 usage patterns helps assess whether the user might have been confused by the phishing attempt.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          tls.server.certificate.subject|contains:
            - "outlook.com"
            - "office365.com"
            - "microsoft.com"
        condition: selection
      fields:
        - tls.server.certificate.subject
        - dst_ip

  - question: What web traffic preceded this connection to the phishing site?
    context: Understanding how the user reached the phishing site helps identify the attack vector and other potential victims.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.full
        - http.request.headers.referer
        - dst_ip

  - question: Did the user submit credentials to this phishing site?
    context: POST requests to phishing sites typically indicate credential submission, requiring immediate password reset procedures.
    range: +5m/+30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.request.method: "POST"
        condition: selection
      fields:
        - url.full
        - http.request.body.content
        - http.response.status_code

  - question: Are there signs of successful credential compromise following this phishing attempt?
    context: Successful phishing may lead to unauthorized account access, requiring analysis of authentication logs.
    range: +30m/+24h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.full|contains:
            - "outlook"
            - "office365"
            - "login.microsoft"
        condition: selection
      fields:
        - url.full
        - http.response.status_code
        - dst_ip

  - question: What email activity might have led this user to the phishing site?
    context: Phishing sites are typically accessed through malicious emails, which helps identify the attack campaign scope.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 25
            - 587
            - 993
            - 995
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_in
        - bytes_out

  - question: Has this phishing certificate been observed from other source IPs in the network?
    context: Multiple users accessing the same phishing site indicates a broader phishing campaign targeting the organization.
    range: -24h/+24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          tls.server.certificate.subject|contains: "lakeshoreemployeetestingservices.com"
        condition: selection
      fields:
        - src_ip
        - tls.server.certificate.subject

  - question: Are there other malicious certificates being used by this phishing infrastructure?
    context: Phishing operations often use multiple certificates and domains to evade detection and blocking.
    range: -24h/+24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - tls.server.certificate.subject
        - tls.server.certificate.issuer
        - src_ip

  - question: What DNS queries were made for this phishing domain?
    context: DNS queries reveal how users discovered the phishing site and help identify the attack delivery mechanism.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.query.name|contains: "lakeshoreemployeetestingservices.com"
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  - question: What is the scope of this Office365 phishing campaign across the organization?
    context: Understanding campaign scope helps prioritize user education and implement appropriate blocking measures.
    range: -24h/+24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - "PHISHING"
            - "Office365"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - tls.server.certificate.subject