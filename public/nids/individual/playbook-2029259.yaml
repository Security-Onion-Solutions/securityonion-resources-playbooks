name: ET MALWARE PowerTrick Task Request
id: 22029259
description: |
  Detects PowerTrick backdoor task request communication characterized by specific POST parameters "p=t&p1=" followed by encoded data.
  PowerTrick is a sophisticated fileless backdoor used by Russian organized cybercrime groups targeting high-value organizations.
  This pattern indicates an infected system requesting tasks from the PowerTrick command and control infrastructure.
type: detection
detection_id: 2029259
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete PowerTrick task request payload sent to the CnC server?
    context: The full POST body reveals the encoded system information and task request parameters sent by the backdoor.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.body.content
        - url.full
        - http.request.method
        - http.request.headers.content_type

  - question: What encoded data is contained in the p1 and p2 parameters?
    context: PowerTrick encodes system information and victim identification data in these parameters for CnC communication.
    range: +/-2m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.request.body.content
        - http.response.body.content
        - http.response.status_code

  # Type 2: Triage Assessment
  - question: Has this system shown previous PowerTrick backdoor activity?
    context: Determines if this is initial infection or ongoing PowerTrick campaign activity.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "PowerTrick"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.category

  - question: Is this PowerTrick communication occurring during expected system operation?
    context: PowerTrick often operates during business hours to blend with legitimate network traffic patterns.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method: "POST"
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - http.request.body.content

  # Type 3: Activity Context
  - question: What PowerShell or script execution preceded this network communication?
    context: PowerTrick is a fileless backdoor that operates through PowerShell and WMI, requiring script execution.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - "powershell"
            - "wmic"
            - "cscript"
            - "wscript"
        condition: selection
      fields:
        - CommandLine
        - process.name
        - process.parent.name
        - User

  - question: What WMI activity is associated with this PowerTrick communication?
    context: PowerTrick heavily utilizes WMI for persistence and execution, leaving distinctive WMI event traces.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          process.name: "WmiPrvSE.exe"
        condition: selection
      fields:
        - CommandLine
        - process.parent.name
        - User

  - question: What initial access vector preceded this PowerTrick activity?
    context: Identifies how PowerTrick gained initial access to the system for attribution and containment.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
          dst_port|contains:
            - 3389
            - 445
            - 443
            - 80
        condition: selection
      fields:
        - src_ip
        - dst_port
        - network.transport

  # Type 4: Impact Assessment
  - question: What sensitive data has been accessed by PowerTrick on this system?
    context: PowerTrick targets high-value organizations for data theft and espionage activities.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.extension|contains:
            - ".doc"
            - ".pdf"
            - ".xls"
            - ".ppt"
        condition: selection
      fields:
        - file.path
        - file.name
        - process.name
        - file.size

  - question: What credential harvesting activity is associated with PowerTrick?
    context: PowerTrick often performs credential dumping and lateral movement preparation activities.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - "lsass"
            - "mimikatz"
            - "procdump"
            - "sekurlsa"
        condition: selection
      fields:
        - CommandLine
        - process.name
        - process.parent.name

  # Type 5: Forensic Deep-Dive
  - question: What PowerTrick persistence mechanisms have been established?
    context: PowerTrick uses sophisticated WMI-based persistence that survives reboots and detection attempts.
    range: -4h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - "\\WMI"
            - "\\CIM"
            - "\\ROOT\\CIMV2"
        condition: selection
      fields:
        - TargetObject
        - Details
        - process.name

  - question: What PowerTrick command responses have been received from the CnC?
    context: Analyzes the tasks and commands sent by PowerTrick operators to understand attack objectives.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
          http.response.status_code: 200
        condition: selection
      fields:
        - http.response.body.content
        - http.response.headers.content_length

  - question: What lateral movement preparation has PowerTrick performed?
    context: PowerTrick often performs network reconnaissance and lateral movement preparation activities.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - "net view"
            - "net group"
            - "net user"
            - "nltest"
        condition: selection
      fields:
        - CommandLine
        - process.name
        - User

  # Type 6: Enterprise Correlation
  - question: Are other systems showing PowerTrick backdoor indicators?
    context: PowerTrick campaigns often target multiple high-value systems within an organization.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "PowerTrick"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: What coordinated PowerTrick campaign activity is present enterprise-wide?
    context: Identifies the scope and coordination of PowerTrick operations across the organization.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          http.request.body.content|contains:
            - "p=t&p1="
            - "p3=Qzpc"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - url.domain