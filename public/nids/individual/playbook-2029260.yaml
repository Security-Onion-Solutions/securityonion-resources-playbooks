name: ET MALWARE PowerTrick Task Checkin M1
id: 22029260
description: |
  Detects PowerTrick backdoor task completion checkin communication with the distinctive "p3=Qzpc" parameter and "p=ip" pattern.
  This signature indicates a PowerTrick-infected system reporting task completion or status back to the command and control server.
  The "Qzpc" parameter appears to be a Base64-encoded identifier specific to PowerTrick operations.
type: detection
detection_id: 2029260
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete PowerTrick checkin payload including all parameters?
    context: The full POST body reveals the encoded task results and system status information sent by the backdoor.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.body.content
        - url.full
        - http.request.method
        - http.request.headers.content_length

  - question: What does the "p3=Qzpc" parameter decode to reveal about the system?
    context: This encoded parameter likely contains system identification or task completion status information.
    range: +/-2m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.request.body.content
        - http.response.body.content
        - http.response.status_code
        - http.response.headers

  # Type 2: Triage Assessment
  - question: What PowerTrick task request preceded this checkin communication?
    context: Correlates the checkin with the original task request to understand the completed operation.
    range: -6h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "PowerTrick Task Request"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - http.request.body.content

  - question: Is this checkin part of regular PowerTrick beacon activity?
    context: Determines if this is routine status reporting or response to specific operator commands.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.body.content|contains: "p=ip"
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - http.request.body.content

  # Type 3: Activity Context
  - question: What PowerShell or WMI execution occurred before this checkin?
    context: PowerTrick executes tasks through PowerShell and WMI before reporting results to the CnC.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - "powershell"
            - "wmic"
            - "WmiPrvSE"
        condition: selection
      fields:
        - CommandLine
        - process.name
        - process.parent.name
        - User

  - question: What file system activity preceded this PowerTrick checkin?
    context: Identifies what files or data PowerTrick accessed or modified before reporting back to CnC.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - file.path
        - file.name
        - process.name
        - file.hash.md5

  - question: What network reconnaissance activity is associated with this checkin?
    context: PowerTrick often performs network discovery before reporting findings to operators.
    range: -3h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - "net view"
            - "ping"
            - "nslookup"
            - "ipconfig"
        condition: selection
      fields:
        - CommandLine
        - process.name
        - User

  # Type 4: Impact Assessment
  - question: What sensitive data was potentially exfiltrated before this checkin?
    context: PowerTrick often accesses sensitive files and reports data availability to operators.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.extension|contains:
            - ".doc"
            - ".pdf"
            - ".xls"
            - ".ppt"
            - ".txt"
        condition: selection
      fields:
        - file.path
        - file.name
        - file.size
        - process.name

  - question: What credential access attempts preceded this PowerTrick checkin?
    context: PowerTrick may have attempted credential harvesting before reporting success to operators.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - "lsass"
            - "SAM"
            - "SYSTEM"
            - "SECURITY"
        condition: selection
      fields:
        - CommandLine
        - process.name
        - process.parent.name

  # Type 5: Forensic Deep-Dive
  - question: What PowerTrick command execution artifacts remain on the system?
    context: Identifies the specific commands executed by PowerTrick operators and their forensic traces.
    range: -6h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          process.parent.name|contains:
            - "powershell"
            - "cmd"
            - "wmic"
        condition: selection
      fields:
        - CommandLine
        - process.name
        - process.parent.command_line
        - User

  - question: What WMI persistence mechanisms are active on this PowerTrick-infected system?
    context: PowerTrick uses sophisticated WMI-based persistence that may still be active after task completion.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - "\\ROOT\\CIMV2"
            - "\\WMI"
            - "__EventFilter"
        condition: selection
      fields:
        - TargetObject
        - Details
        - process.name

  - question: What data staging or compression activity preceded this checkin?
    context: PowerTrick may compress or stage data for exfiltration before reporting to operators.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - "rar"
            - "zip"
            - "7z"
            - "tar"
        condition: selection
      fields:
        - CommandLine
        - process.name
        - User

  # Type 6: Enterprise Correlation
  - question: Are other systems showing PowerTrick checkin activity?
    context: Identifies the scope of PowerTrick operations and coordinated activity across the enterprise.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "PowerTrick"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: What coordinated PowerTrick campaign indicators exist enterprise-wide?
    context: Correlates this checkin with broader PowerTrick campaign activity to understand attack scope.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          http.request.body.content|contains:
            - "p3=Qzpc"
            - "p=ip&p1="
            - "p=t&p1="
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - url.domain
        - http.request.body.content