name: ET MALWARE PowerTrick Task Checkin M2
id: 22029261
description: |
  Detects PowerTrick backdoor task checkin communication with command and control servers.
  This specific pattern indicates malware requesting tasks from C2 infrastructure.
  Legitimate applications do not use this specific parameter structure.
type: detection
detection_id: 2029261
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete HTTP POST request body containing the PowerTrick parameters?
    context: The specific parameter structure reveals the backdoor's communication protocol and potential victim identification.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.body.content
        - http.request.method
        - url.full
        - http.request.headers

  - question: What is the destination server receiving these PowerTrick communications?
    context: Identifying the C2 server helps understand the threat infrastructure and enables blocking.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - http.request.headers.host

  - question: Is this system known to legitimately communicate with the destination server?
    context: PowerTrick targets high-value systems, so understanding normal communication patterns helps confirm compromise.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - bytes_in
        - bytes_out

  - question: What other network activity occurred from this source around the same time?
    context: PowerTrick often performs reconnaissance and lateral movement after initial compromise.
    range: -15m/+15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_in
        - bytes_out

  - question: Has this system shown signs of PowerTrick persistence mechanisms?
    context: PowerTrick establishes persistence through various Windows mechanisms that would appear in process logs.
    range: -1h/+1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - "powershell"
            - "cmd.exe"
            - "schtasks"
            - "reg add"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: What data was transmitted in previous PowerTrick communications from this host?
    context: Understanding the volume and frequency of data transmission reveals the scope of potential data exfiltration.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.request.method: "POST"
        condition: selection
      fields:
        - http.request.body.content
        - url.path
        - bytes_out

  - question: Are there indicators of PowerTrick's fileless execution techniques on this system?
    context: PowerTrick operates fileless, using PowerShell and WMI for execution without dropping files to disk.
    range: -2h/+30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - "powershell.exe"
            - "wmiprvse.exe"
        condition: selection
      fields:
        - CommandLine
        - ParentImage
        - User
        - ProcessGuid

  - question: Has this PowerTrick infection attempted lateral movement to other systems?
    context: PowerTrick is designed for high-value targets and typically spreads to other systems in the network.
    range: -1h/+2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 445
            - 135
            - 3389
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_in
        - bytes_out

  - question: What files or credentials might have been accessed during this PowerTrick session?
    context: PowerTrick targets sensitive data and credentials, so file access patterns reveal the attacker's objectives.
    range: -30m/+30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - ".doc"
            - ".pdf"
            - ".xls"
            - "password"
            - "credential"
        condition: selection
      fields:
        - TargetFilename
        - Image
        - User

  - question: Are other systems in the network showing similar PowerTrick communication patterns?
    context: PowerTrick campaigns often target multiple high-value systems simultaneously.
    range: -1h/+1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          http.request.method: "POST"
          http.request.body.content|contains: "p3="
        condition: selection
      fields:
        - src_ip
        - http.request.body.content

  - question: What is the scope of PowerTrick infrastructure being used in this campaign?
    context: Understanding the full C2 infrastructure helps with comprehensive blocking and threat hunting.
    range: -24h/+1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "PowerTrick"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name