name: ET MALWARE PowerTrick Task Answer
id: 22029262
description: |
  Detects PowerTrick backdoor sending task execution results back to command and control servers.
  This pattern indicates the malware is actively executing commands and reporting results.
  Legitimate applications do not use this specific parameter structure.
type: detection
detection_id: 2029262
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete task answer payload being transmitted to the C2 server?
    context: The task answer reveals what commands were executed and their results, indicating the scope of compromise.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.body.content
        - http.request.method
        - url.full
        - http.request.headers

  - question: What PowerTrick task checkin preceded this answer transmission?
    context: Understanding the task request helps correlate what command was executed before this response.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.request.body.content|contains: "p=i&p1="
        condition: selection
      fields:
        - http.request.body.content
        - url.path

  - question: Is this part of an ongoing PowerTrick communication session?
    context: PowerTrick maintains persistent communication with C2 servers through regular checkin/answer cycles.
    range: -2h/+30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.request.method: "POST"
        condition: selection
      fields:
        - http.request.body.content
        - bytes_out

  - question: What process activity occurred on this system before the task answer was sent?
    context: The executed task would generate process activity that correlates with this answer transmission.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ParentImage
        - ProcessGuid

  - question: Has this PowerTrick instance successfully executed reconnaissance commands?
    context: PowerTrick often executes system reconnaissance commands whose results would be transmitted in task answers.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - "whoami"
            - "ipconfig"
            - "systeminfo"
            - "net user"
            - "tasklist"
        condition: selection
      fields:
        - CommandLine
        - Image
        - User
        - ProcessGuid

  - question: What sensitive data might have been collected and transmitted in this task answer?
    context: PowerTrick targets high-value data, so task answers may contain exfiltrated information.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - ".doc"
            - ".pdf"
            - ".xls"
            - "password"
            - "credential"
            - ".txt"
        condition: selection
      fields:
        - TargetFilename
        - Image
        - User

  - question: Are there signs of PowerTrick attempting to establish additional persistence?
    context: Task answers may confirm successful installation of additional persistence mechanisms.
    range: -30m/+15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - "schtasks"
            - "reg add"
            - "wmic"
            - "powershell"
        condition: selection
      fields:
        - CommandLine
        - Image
        - User
        - ProcessGuid

  - question: Has this PowerTrick infection attempted lateral movement following task execution?
    context: Successful task execution often leads to lateral movement attempts to other systems.
    range: +15m/+2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 445
            - 135
            - 3389
            - 5985
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_in
        - bytes_out

  - question: What registry modifications occurred that might be reported in this task answer?
    context: PowerTrick often modifies registry for persistence and configuration, with results reported to C2.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - "Run"
            - "RunOnce"
            - "Services"
            - "CurrentVersion"
        condition: selection
      fields:
        - TargetObject
        - Details
        - Image

  - question: Are other compromised systems sending similar task answers to the same C2 infrastructure?
    context: PowerTrick campaigns typically involve multiple compromised systems reporting to the same C2 servers.
    range: -1h/+1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          http.request.body.content|contains: "p=a&p1="
        condition: selection
      fields:
        - src_ip
        - http.request.body.content

  - question: What is the pattern of PowerTrick task execution across the enterprise?
    context: Understanding the broader campaign scope helps prioritize incident response efforts.
    range: -24h/+1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "PowerTrick"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name