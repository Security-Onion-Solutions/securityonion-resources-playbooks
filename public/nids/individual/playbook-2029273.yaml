name: ET MALWARE PowerTrick download ver2 bot
id: 22029273
description: |
  Detects PowerTrick malware version 2 bot download attempts via HTTP GET requests with specific URL parameters.
  This signature identifies an evolved version of the PowerTrick malware's payload retrieval mechanism.
  May trigger on legitimate applications using similar URL parameter structures.
type: detection
detection_id: 2029273
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What is the complete URL structure of the PowerTrick version 2 download request?
    context: Analyzing the URL parameters reveals the malware's communication protocol evolution.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.full
        - url.query
        - url.path

  - question: What data is encoded in the 'x' parameter of this PowerTrick request?
    context: The parameter content may contain system identification or configuration data.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - url.query
        - http.request.headers
        - http.request.method

  # Type 2: Triage Assessment
  - question: Is this system known to perform legitimate software downloads?
    context: Distinguishing between authorized downloads and malicious PowerTrick activity.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method: 'GET'
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - http.response.status_code

  - question: Does this download pattern match approved application behavior?
    context: Evaluating if the URL parameter structure aligns with known legitimate software.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.query|contains: '?a=irs'
        condition: selection
      fields:
        - dst_ip
        - url.full
        - http.response.body.bytes

  # Type 3: Activity Context
  - question: What process initiated this PowerTrick version 2 download?
    context: Identifying the parent process helps determine the infection vector and attack progression.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'powershell.exe'
            - 'cmd.exe'
            - 'wscript.exe'
        condition: selection
      fields:
        - User
        - CommandLine
        - ParentImage
        - ProcessGuid

  - question: What network activity preceded this version 2 download attempt?
    context: Understanding the attack chain leading to this evolved malware variant.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_in
        - bytes_out

  # Type 4: Impact Assessment
  - question: Was the PowerTrick version 2 payload successfully retrieved?
    context: Confirming successful malware delivery and assessing the payload characteristics.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.response.status_code: '200'
        condition: selection
      fields:
        - http.response.body.bytes
        - http.response.headers
        - url.path

  - question: What file system changes occurred after the download?
    context: Identifying where the malware payload was stored and what files were modified.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size

  # Type 5: Forensic Deep-Dive
  - question: What differences exist between version 1 and version 2 PowerTrick communications?
    context: Understanding the malware's evolution helps improve detection and response capabilities.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.query|contains:
            - '?a=irs'
            - '?a=ips'
        condition: selection
      fields:
        - url.query
        - dst_ip
        - http.response.status_code

  - question: What PowerShell execution patterns follow this version 2 download?
    context: Version 2 may have different execution and persistence mechanisms than version 1.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains: 'powershell.exe'
        condition: selection
      fields:
        - CommandLine
        - User
        - ParentImage

  - question: What persistence mechanisms does PowerTrick version 2 establish?
    context: Different versions may use varied persistence techniques requiring specific remediation.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - 'Run'
            - 'RunOnce'
            - 'Services'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessGuid

  # Type 6: Enterprise Correlation
  - question: Are other systems downloading PowerTrick version 2 from the same infrastructure?
    context: Identifying the scope of the version 2 campaign across the organization.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.query|contains: '?a=irs&x='
        condition: selection
      fields:
        - src_ip
        - url.full
        - http.response.status_code

  - question: What is the distribution of PowerTrick version 1 versus version 2 across the enterprise?
    context: Understanding variant distribution helps prioritize response efforts and threat assessment.
    range: -48h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'PowerTrick download'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name