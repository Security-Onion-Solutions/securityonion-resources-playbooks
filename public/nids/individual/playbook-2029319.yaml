name: ET MALWARE ELF/Muhstik - IRC CnC Checkin
id: 22029319
description: |
  Detects Muhstik botnet IRC command and control communication patterns.
  Muhstik targets IoT devices and routers to build botnets for DDoS attacks and cryptocurrency mining. May trigger on legitimate IRC usage with similar patterns.
type: detection
detection_id: 2029319
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete IRC registration sequence and bot identifier?
    context: Analyzing the full IRC handshake reveals bot naming patterns and C2 infrastructure details specific to Muhstik.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - src_ip
        - dst_ip
        - dst_port
        - flow_id

  - question: What specific IRC commands and responses were exchanged with the C2 server?
    context: IRC protocol analysis helps identify bot capabilities and received commands from the botnet operator.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
          dst_port|contains:
            - 6667
            - 6668
            - 6669
            - 7000
        condition: selection
      fields:
        - network.bytes_sent
        - network.bytes_received
        - network.protocol

  # Type 2: Triage Assessment
  - question: Is this device known to run legitimate IRC clients or services?
    context: Some network devices may legitimately use IRC for management, helping distinguish false positives.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 6667
            - 6668
            - 6669
            - 7000
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.bytes_sent

  - question: Does this system typically initiate outbound connections on IRC ports?
    context: Baseline network behavior helps identify if IRC communication is normal for this device.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 6667
            - 6668
            - 6669
        condition: selection
      fields:
        - dst_ip
        - network.bytes_sent
        - network.bytes_received

  # Type 3: Activity Context
  - question: What processes or services on this system could have initiated the IRC connection?
    context: Identifying the source process helps determine if malware or legitimate software made the connection.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: What network reconnaissance or scanning activity preceded this IRC communication?
    context: Muhstik spreads through exploitation of vulnerable devices, so prior scanning may indicate the infection vector.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
          dst_port|contains:
            - 22
            - 23
            - 80
            - 8080
            - 2323
        condition: selection
      fields:
        - src_ip
        - dst_port
        - network.bytes_sent

  # Type 4: Impact Assessment
  - question: Has this infected device been used for DDoS attacks or scanning other targets?
    context: Muhstik bots are commonly used for DDoS attacks, so evidence of attack traffic indicates active compromise.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.bytes_sent
        - network.packets_sent

  - question: Are there signs of cryptocurrency mining or other malicious payloads on this system?
    context: Muhstik often deploys cryptocurrency miners alongside botnet functionality.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'xmrig'
            - 'cpuminer'
            - 'stratum'
            - 'mining'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ProcessGuid

  # Type 5: Forensic Deep-Dive
  - question: What specific Muhstik variant or campaign is this infection associated with?
    context: Different Muhstik campaigns use distinct IRC servers and bot naming conventions.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'Muhstik'
            - 'IRC'
            - 'Botnet'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - dst_ip
        - dst_port

  - question: What persistence mechanisms has the Muhstik malware established on this system?
    context: Understanding persistence helps with complete malware removal and prevents reinfection.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - '/tmp/'
            - '/var/tmp/'
            - 'cron'
            - 'init'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessGuid

  # Type 6: Enterprise Correlation
  - question: Are other IoT devices or systems in the network showing similar Muhstik infection patterns?
    context: Muhstik spreads laterally through networks, so multiple infections may indicate a broader compromise.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: 'ET MALWARE ELF/Muhstik - IRC CnC Checkin'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port

  - question: Is there evidence of the initial exploitation vector used to compromise this device?
    context: Identifying the attack vector helps prevent similar compromises of other devices.
    range: -48h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
          dst_port|contains:
            - 22
            - 23
            - 80
            - 8080
        condition: selection
      fields:
        - src_ip
        - dst_port
        - network.bytes_sent