name: ET INFO GeoIP Lookup (nydus.battle.net)
id: 22029324
description: |
  Detects HTTP requests to Battle.net's GeoIP service endpoint for location-based services.
  This is typically legitimate traffic from Blizzard games but may indicate policy violations in restricted environments or potential abuse by malware.
type: detection
detection_id: 2029324
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete HTTP request made to the Battle.net GeoIP service?
    context: Analyzing the full request helps determine if this is legitimate game traffic or potential abuse.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - http.request.headers
        - http.user_agent

  - question: What response was received from the nydus.battle.net GeoIP endpoint?
    context: Response analysis reveals what location data was obtained and helps confirm legitimate usage.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
          url.path: '/geoip'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - http.response.headers

  # Type 2: Triage Assessment
  - question: Is this system authorized to run Blizzard games or Battle.net client software?
    context: In corporate environments, gaming software may violate acceptable use policies.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'Battle.net'
            - 'Blizzard'
            - 'Overwatch'
            - 'WorldOfWarcraft'
            - 'Diablo'
            - 'StarCraft'
        condition: selection
      fields:
        - Image
        - User
        - CommandLine

  - question: Does this GeoIP lookup align with normal gaming hours and user activity?
    context: Legitimate gaming traffic typically occurs during specific hours and correlates with user sessions.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 80
            - 443
            - 1119
            - 3724
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.bytes_sent
        - network.bytes_received

  # Type 3: Activity Context
  - question: What Blizzard game or Battle.net client activity preceded this GeoIP request?
    context: Understanding the gaming context helps confirm if this is legitimate game-related traffic.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.domain|contains:
            - 'battle.net'
            - 'blizzard.com'
            - 'battlenet'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.user_agent
        - url.domain

  - question: What user account and process initiated this Battle.net communication?
    context: Identifying the user and process helps determine if this is authorized gaming activity.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'battle'
            - 'blizzard'
            - 'launcher'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  # Type 4: Impact Assessment
  - question: Has this system been used for extensive gaming or non-business related activities?
    context: Excessive gaming traffic may indicate productivity issues or policy violations in corporate environments.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 1119
            - 3724
            - 6112
            - 6113
        condition: selection
      fields:
        - dst_ip
        - network.bytes_sent
        - network.bytes_received
        - dst_port

  - question: Are there signs this GeoIP service is being abused by malware for location detection?
    context: Some malware uses legitimate GeoIP services to determine victim location for targeted attacks.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains:
            - 'geoip'
            - 'location'
            - 'country'
            - 'ip'
        condition: selection
      fields:
        - url.full
        - http.user_agent
        - url.domain

  # Type 5: Forensic Deep-Dive
  - question: What specific Blizzard games or services are being accessed from this system?
    context: Understanding the full scope of gaming activity helps assess policy compliance and security risks.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.query.name|contains:
            - 'battle.net'
            - 'blizzard.com'
            - 'worldofwarcraft.com'
            - 'playoverwatch.com'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  - question: Are there any suspicious network patterns that might indicate malware using this GeoIP service?
    context: Malware may use legitimate services like Battle.net GeoIP to avoid detection while gathering location data.
    range: -4h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'Malware'
            - 'Trojan'
            - 'Suspicious'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - dst_ip
        - dst_port

  # Type 6: Enterprise Correlation
  - question: Are multiple users in the organization accessing Battle.net services during work hours?
    context: Widespread gaming activity may indicate policy enforcement issues or network abuse.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          dns.query.name: 'nydus.battle.net'
        condition: selection
      fields:
        - src_ip
        - dns.resolved_ip

  - question: Is there a pattern of GeoIP lookups that might indicate automated or malicious behavior?
    context: Legitimate gaming typically has sporadic GeoIP requests, while malware may show regular patterns.
    range: -48h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          url.path: '/geoip'
          url.domain: 'nydus.battle.net'
        condition: selection
      fields:
        - src_ip
        - http.user_agent
        - url.full