name: ET INFO TLS Handshake Failure
id: 22029340
description: |
  Detects TLS handshake failures between external and internal systems.
  May indicate network connectivity issues, SSL/TLS configuration problems, or potential security tool interference.
type: detection
detection_id: 2029340
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the specific TLS handshake failure pattern detected?
    context: Understanding the exact failure code helps determine if this is a configuration issue or potential attack.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - alert.signature
        - tls.version
        - tls.handshake_log
        - payload_printable

  - question: What TLS version and cipher suites were involved in the failed handshake?
    context: TLS version mismatches or weak ciphers can cause handshake failures and indicate security policy enforcement.
    range: -5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - tls.version
        - tls.cipher
        - tls.server_name_indication

  # Type 2: Triage Assessment
  - question: Is this TLS handshake failure part of normal application behavior for this service?
    context: Some applications may legitimately fail TLS handshakes due to version negotiation or certificate issues.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|expand: '%dst_port%'
        condition: selection
      fields:
        - src_ip
        - tls.established
        - tls.version

  - question: Are there successful TLS connections from this source to other destinations?
    context: Successful connections elsewhere suggest the issue is specific to this destination rather than client-side problems.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          tls.established: true
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - tls.server_name_indication

  # Type 3: Activity Context
  - question: What network activity preceded this TLS handshake failure?
    context: Previous DNS queries or connection attempts may reveal the application or process causing the failure.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_port
        - dst_port
        - proto
        - conn_state

  - question: What DNS queries were made before this connection attempt?
    context: DNS resolution patterns can identify the application or service attempting the TLS connection.
    range: -10m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  # Type 4: Impact Assessment
  - question: How many TLS handshake failures are occurring from this source?
    context: High frequency of failures may indicate systematic issues or potential security tool blocking.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains: "TLS Handshake Failure"
        condition: selection
      fields:
        - dst_ip
        - dst_port

  - question: Are applications or services impacted by these TLS failures?
    context: Understanding service impact helps prioritize remediation efforts.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  # Type 5: Forensic Deep-Dive
  - question: What certificate information was exchanged during the failed handshake?
    context: Certificate details can reveal if failures are due to expired, invalid, or suspicious certificates.
    range: -5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - tls.server.certificate.subject
        - tls.server.certificate.issuer
        - tls.server.certificate.not_valid_after
        - tls.server.certificate.serial_number

  - question: Are there patterns in the timing of these TLS handshake failures?
    context: Timing patterns may indicate automated tools, security controls, or scheduled processes causing failures.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains: "TLS Handshake Failure"
        condition: selection
      fields:
        - dst_ip
        - dst_port

  # Type 6: Enterprise Correlation
  - question: Are other internal systems experiencing similar TLS handshake failures?
    context: Widespread failures may indicate network infrastructure issues or security policy changes.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: "TLS Handshake Failure"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port

  - question: Is this part of a broader pattern of SSL/TLS related alerts?
    context: Multiple SSL/TLS alerts may indicate certificate issues, man-in-the-middle attacks, or security tool interference.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains:
            - "TLS"
            - "SSL"
            - "Certificate"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature