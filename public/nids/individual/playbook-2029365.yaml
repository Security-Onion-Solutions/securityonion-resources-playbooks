name: ET WEB_CLIENT Observed Malicious SSL Cert (Charming Kitten Phishing Domain yah00.site)
id: 22029365
description: |
  Detects SSL certificate containing the malicious domain "yah00.site" associated with Charming Kitten APT group phishing campaigns.
  This domain mimics legitimate Yahoo services to deceive victims. Legitimate traffic would not contain this typosquatted domain.
type: detection
detection_id: 2029365
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What is the complete SSL certificate subject containing the malicious domain?
    context: Examining the full certificate subject reveals the exact phishing domain and certificate details used by attackers.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - tls.server.certificate.subject
        - tls.server.certificate.issuer
        - tls.server.certificate.serial_number

  - question: What SSL certificate details were observed for this connection?
    context: Certificate metadata helps identify the infrastructure used by Charming Kitten for this phishing operation.
    query: |
      aggregation: false
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - tls.server.certificate.not_valid_before
        - tls.server.certificate.not_valid_after
        - tls.server.certificate.fingerprint_sha256
        - tls.server.certificate.subject_alternative_names

  # Type 2: Triage Assessment
  - question: Has this client previously connected to legitimate Yahoo services?
    context: Comparing with legitimate Yahoo connections helps distinguish between targeted phishing and normal user behavior.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 443
            - 80
        condition: selection
      fields:
        - dst_ip
        - server_name
        - connection_count

  - question: Is this connection during normal business hours for this user?
    context: Charming Kitten often targets users during work hours with fake interview or business-related phishing.
    range: -1d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 443
        condition: selection
      fields:
        - hour_of_day
        - connection_count
        - dst_ip

  # Type 3: Activity Context
  - question: What DNS queries preceded this SSL connection?
    context: DNS resolution patterns reveal how the user reached the malicious domain and potential DNS manipulation.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.query.name|contains:
            - 'yah00.site'
            - 'yahoo'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  - question: What web browsing activity occurred before this connection?
    context: Understanding the user's browsing context helps identify the attack vector used to reach the phishing site.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.response.status_code
        - http.request.referrer

  # Type 4: Impact Assessment
  - question: Was any credential data submitted to this phishing domain?
    context: POST requests to phishing domains often indicate credential harvesting attempts by the attacker.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.request.method: 'POST'
        condition: selection
      fields:
        - url.path
        - http.request.body.content
        - http.response.status_code

  - question: What data was transmitted over this SSL connection?
    context: Analyzing connection metadata reveals the scope of potential data exfiltration to the phishing infrastructure.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - bytes_sent
        - bytes_received
        - duration
        - connection_state

  # Type 5: Forensic Deep-Dive
  - question: What process initiated this connection to the phishing domain?
    context: Identifying the originating process helps determine if this was user-initiated or malware-driven activity.
    range: -5m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'browser'
            - 'chrome'
            - 'firefox'
            - 'edge'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: Are there indicators of credential theft or session hijacking?
    context: Charming Kitten campaigns often involve stealing authentication tokens and session cookies.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - 'cookies'
            - 'login'
            - 'credential'
            - 'token'
        condition: selection
      fields:
        - TargetFilename
        - ProcessGuid
        - file.hash.md5

  # Type 6: Enterprise Correlation
  - question: Are other hosts in the organization connecting to Charming Kitten infrastructure?
    context: APT campaigns often target multiple users within an organization simultaneously.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          tls.server.certificate.subject|contains: 'yah00.site'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - connection_count
        - unique_hosts

  - question: What other Charming Kitten IOCs appear across the enterprise?
    context: Correlating with known Charming Kitten indicators helps assess campaign scope and persistence.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'Charming Kitten'
            - 'APT34'
            - 'TONEDEAF'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - alert_count