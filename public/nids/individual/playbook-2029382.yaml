name: ET MALWARE APT34 TONEDEAF 2.0 Requesting Commands from CnC
id: 22029382
description: |
  Detects APT34 TONEDEAF 2.0 malware requesting commands from command and control servers via specific HTTP GET patterns.
  This backdoor uses distinctive URI patterns with Windows Phone OS user agent strings. Legitimate Windows Phone traffic would not use these specific patterns.
type: detection
detection_id: 2029382
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What is the complete HTTP request showing the TONEDEAF command request pattern?
    context: Examining the full HTTP request reveals the exact command and control communication pattern used by TONEDEAF malware.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - http.user_agent
        - http.request.headers

  - question: What specific URI parameter and user agent combination was detected?
    context: The combination of /dow?ser= URI pattern and Windows Phone OS user agent is distinctive to TONEDEAF 2.0 malware.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - url.path
        - url.query
        - http.user_agent
        - http.request.method

  # Type 2: Triage Assessment
  - question: Are there legitimate Windows Phone devices on this network segment?
    context: Genuine Windows Phone devices would help distinguish between legitimate traffic and TONEDEAF malware impersonation.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.user_agent|contains: 'Windows Phone'
        condition: selection
      fields:
        - http.user_agent
        - url.full
        - request_count

  - question: Is this host known to run Windows Phone OS applications?
    context: Understanding the host's typical operating system and applications helps assess if Windows Phone user agent is legitimate.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - User
        - process_count
        - CommandLine

  # Type 3: Activity Context
  - question: What process initiated this suspicious HTTP request to the C2 server?
    context: Identifying the originating process helps determine if this is malware-driven communication or legitimate application traffic.
    range: -5m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid
        - ParentImage

  - question: What network connections preceded this C2 communication attempt?
    context: Understanding the network activity context helps identify the malware's communication patterns and infrastructure.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 80
            - 443
            - 8080
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_sent
        - bytes_received

  # Type 4: Impact Assessment
  - question: What commands or data were received from the C2 server in response?
    context: Analyzing C2 responses reveals the scope of malware capabilities and potential follow-up malicious activities.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - url.full
        - bytes_received

  - question: What malicious activities occurred after this C2 communication?
    context: Post-communication activities reveal the impact and capabilities of TONEDEAF malware on the compromised system.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid
        - ParentProcessGuid

  # Type 5: Forensic Deep-Dive
  - question: What TONEDEAF malware artifacts exist on the compromised system?
    context: Identifying malware files and persistence mechanisms helps understand the full scope of the TONEDEAF infection.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.hash.md5: 'a0324fa4f2d9d2f04ea4edad41160da6'
        condition: selection
      fields:
        - TargetFilename
        - ProcessGuid
        - file.hash.md5
        - file.hash.sha256

  - question: What persistence mechanisms has TONEDEAF established on this system?
    context: Understanding persistence helps determine the malware's longevity and methods for maintaining access to the compromised host.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - 'Run'
            - 'RunOnce'
            - 'Services'
            - 'Winlogon'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessGuid

  # Type 6: Enterprise Correlation
  - question: Are other hosts in the organization infected with TONEDEAF malware?
    context: APT34 campaigns often involve multiple compromised systems within the same organization for lateral movement.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          url.path|contains: '/dow'
          url.query|contains: 'ser='
          http.user_agent|contains: 'Windows Phone OS'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - request_count
        - unique_hosts

  - question: What other APT34 indicators appear across the enterprise?
    context: Correlating with known APT34 indicators helps assess campaign scope and identify additional compromised systems.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'APT34'
            - 'TONEDEAF'
            - 'Charming Kitten'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - alert_count