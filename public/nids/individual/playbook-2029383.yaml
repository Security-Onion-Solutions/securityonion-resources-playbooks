name: ET MALWARE APT34 TONEDEAF 2.0 Uploading to CnC
id: 22029383
description: |
  Detects APT34 TONEDEAF 2.0 malware uploading data to command and control servers.
  Identifies specific POST requests with encoded parameters and Windows Phone user agent.
  Legitimate applications rarely use this specific URI pattern and user agent combination.
type: detection
detection_id: 2029383
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete POST request and encoded parameter sent to the CnC server?
    context: Understanding the exact payload reveals the type of data being exfiltrated and confirms TONEDEAF activity.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.body.content
        - http.request.method
        - url.full
        - http.user_agent

  - question: Is this legitimate Windows Phone application traffic from this source?
    context: Windows Phone OS is largely obsolete, making this user agent highly suspicious in modern environments.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.user_agent|contains: "Windows Phone OS"
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - http.request.method

  - question: What process initiated this HTTP connection on the source system?
    context: Identifying the parent process helps determine if this is malware execution or legitimate application behavior.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 80
        condition: selection
      fields:
        - process.name
        - process.pid
        - process.command_line

  - question: What other network connections occurred from this source around the same time?
    context: APT34 campaigns often involve multiple C2 communications and lateral movement attempts.
    range: -30m/+30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - bytes_in

  - question: Has the destination server been contacted by other internal systems?
    context: Determines if this is an isolated infection or part of broader campaign activity.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - bytes_out

  - question: Are there signs of data staging or collection on the source system?
    context: TONEDEAF typically collects files before uploading, leaving forensic artifacts.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.extension|contains:
            - "tmp"
            - "dat"
            - "log"
        condition: selection
      fields:
        - file.path
        - file.size
        - process.name

  - question: What files were accessed or modified before this upload activity?
    context: Understanding data access patterns reveals what information may have been exfiltrated.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          event.action|contains:
            - "read"
            - "copy"
            - "access"
        condition: selection
      fields:
        - file.path
        - file.size
        - process.name

  - question: Are there registry modifications indicating TONEDEAF persistence mechanisms?
    context: APT34 malware often establishes persistence through registry modifications.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          registry.path|contains:
            - "Run"
            - "RunOnce"
            - "Services"
        condition: selection
      fields:
        - registry.path
        - registry.data.strings
        - process.name

  - question: What processes were spawned on the system during the infection timeframe?
    context: Identifies the malware execution chain and any additional tools deployed.
    range: -4h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - User

  - question: Are other systems in the environment showing similar APT34 indicators?
    context: APT34 campaigns typically target multiple systems within an organization.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          http.user_agent|contains: "Windows Phone OS"
          url.path|contains: "/upl"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - url.domain

  - question: Have there been other APT34 TONEDEAF related alerts across the enterprise?
    context: Correlating with other detections provides campaign scope and attribution confidence.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - "APT34"
            - "TONEDEAF"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name