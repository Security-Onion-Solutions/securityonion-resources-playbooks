name: ET MALWARE Possible APT34 TONEDEAF 2.0 User-Agent Observed
id: 22029384
description: |
  Detects suspicious Windows Phone user agent associated with APT34 TONEDEAF malware.
  Triggers on specific user agent string rarely seen in legitimate traffic.
  Windows Phone OS is largely obsolete, making this user agent highly suspicious.
type: detection
detection_id: 2029384
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete HTTP request using this suspicious user agent?
    context: Analyzing the full request reveals the malware's communication pattern and target server.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.user_agent
        - http.request.method
        - url.full
        - http.request.body.content

  - question: Is this user agent pattern consistent with legitimate Windows Phone usage in the environment?
    context: Windows Phone OS is obsolete since 2017, making any current usage highly suspicious.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          http.user_agent|contains: "Windows Phone OS"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - url.domain

  - question: What application or process generated this HTTP traffic on the source system?
    context: Identifying the originating process helps distinguish between malware and legitimate applications.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - process.name
        - process.pid
        - process.command_line

  - question: What other HTTP requests were made by this source around the same time?
    context: APT34 malware typically makes multiple requests for C2 communication and data exfiltration.
    range: -1h/+1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - url.path
        - http.request.method
        - http.response.status_code

  - question: Are there network connections to known APT34 infrastructure from this source?
    context: Correlating with threat intelligence helps confirm APT34 attribution and campaign activity.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - bytes_in

  - question: Has malware been executed on the source system recently?
    context: Identifying malware execution confirms whether this is active compromise or benign activity.
    range: -4h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - process.hash.md5

  - question: Are there file system artifacts indicating TONEDEAF malware presence?
    context: TONEDEAF creates specific files and directories during operation and persistence.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          event.action|contains:
            - "create"
            - "modify"
        condition: selection
      fields:
        - file.path
        - file.hash.md5
        - process.name

  - question: What registry changes occurred on the system during the suspected infection period?
    context: APT34 malware often modifies registry for persistence and configuration storage.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - registry.path
        - registry.data.strings
        - process.name

  - question: Are there signs of credential harvesting or lateral movement from this system?
    context: APT34 campaigns typically involve credential theft and lateral movement to high-value targets.
    range: -24h/+24h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 445
            - 139
            - 3389
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out

  - question: Have other systems in the network exhibited similar suspicious user agent patterns?
    context: APT34 campaigns often target multiple systems, revealing campaign scope and persistence.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          http.user_agent|contains: "IEMoblie/9.0"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - url.domain

  - question: Are there other APT34 or TONEDEAF related alerts from across the enterprise?
    context: Correlating multiple detections provides comprehensive view of campaign activity and affected systems.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - "APT34"
            - "TONEDEAF"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - alert.severity