name: ET MALWARE Patchwork Backdoor - Requesting Task
id: 22029397
description: |
  Detects Patchwork backdoor communication when requesting tasks from command and control server.
  Uses specific JSON structure with host_identifier field in POST requests to /cnc/tasks/request.
  May trigger on legitimate applications using similar JSON API patterns.
type: detection
detection_id: 2029397
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete HTTP request body containing the host_identifier JSON structure?
    context: Analyzing the JSON payload reveals the backdoor's identification method and communication protocol.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.body.content
        - http.request.method
        - url.full
        - http.request.headers

  - question: What is the exact URI path and any additional parameters in this CnC request?
    context: Understanding the complete request structure helps identify the backdoor's command protocol.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.path
        - url.query
        - http.request.method

  - question: Is this destination server commonly accessed by this host for legitimate purposes?
    context: Distinguishing between normal application traffic and malicious CnC communication.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - bytes_sent
        - bytes_received

  - question: What process initiated this HTTP request to the external server?
    context: Identifying the source process helps determine if this is malware or legitimate software.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: What was the server's response to this task request?
    context: Analyzing the response reveals what commands or tasks the backdoor received.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - http.response.headers

  - question: Are there signs of payload execution or additional malicious activity following this request?
    context: Determining if the backdoor successfully received and executed commands from the CnC server.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid

  - question: What file operations occurred around the time of this CnC communication?
    context: Backdoors often download additional payloads or exfiltrate data after contacting CnC servers.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size
        - ProcessImage

  - question: Has this host made similar Patchwork backdoor requests to other external servers?
    context: Identifying the scope of infection and potential backup CnC infrastructure.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path: "/cnc/tasks/request"
        condition: selection
      fields:
        - dst_ip
        - url.full

  - question: Are there network connections to known Patchwork infrastructure from this host?
    context: Correlating with threat intelligence to confirm Patchwork campaign involvement.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_sent
        - bytes_received

  - question: What other hosts in the environment show similar Patchwork backdoor communication patterns?
    context: Assessing the scope of the Patchwork campaign across the enterprise.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Patchwork"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Are there indicators of lateral movement or credential harvesting from this compromised host?
    context: Determining if the Patchwork backdoor is being used for further network compromise.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 445
            - 139
            - 3389
            - 22
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_sent