name: ET MALWARE Mozart Loader CnC Checkin (getid)
id: 22029407
description: |
  Detects Mozart Loader malware performing initial checkin with command and control server using DNS tunneling.
  The malware uses DNS queries with specific binary patterns including "getid" command to establish communication.
  May trigger on legitimate DNS traffic containing similar binary patterns in rare cases.
type: detection
detection_id: 2029407
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete DNS query containing the Mozart Loader getid command pattern?
    context: Analyzing the full DNS query reveals the malware's communication protocol and encoding method.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.resolved_ip

  - question: What domain was queried in this Mozart Loader DNS tunneling attempt?
    context: Identifying the CnC domain helps track the malware infrastructure and block future communications.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - dns.query.name
        - dns.response_code

  - question: Is this host making normal DNS queries to legitimate domains alongside this suspicious activity?
    context: Distinguishing between compromised hosts and normal network behavior patterns.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name

  - question: What process initiated these DNS queries on the affected host?
    context: Identifying the Mozart Loader executable and its execution context for containment.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: Are there additional Mozart Loader DNS commands following this getid request?
    context: Mozart Loader typically follows getid with gettasks and other commands in sequence.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name

  - question: What DNS responses were received for these Mozart Loader queries?
    context: Analyzing responses reveals command and control instructions sent back to the malware.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.resolved_ip
        - dns.response_code
        - dns.answers

  - question: Has this host downloaded or executed additional payloads after the Mozart Loader checkin?
    context: Mozart Loader is typically used to download and execute secondary malware payloads.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size
        - ProcessImage

  - question: Are there network connections to IP addresses resolved from Mozart Loader DNS queries?
    context: Identifying direct connections to CnC infrastructure beyond DNS tunneling.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_sent
        - bytes_received

  - question: What other hosts in the environment show Mozart Loader DNS communication patterns?
    context: Assessing the scope of Mozart Loader infections across the enterprise network.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Mozart"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Are there signs of persistence mechanisms being established by Mozart Loader?
    context: Determining if the malware has established persistent access to the compromised system.
    range: +/-30m
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessImage

  - question: Has the infected host attempted to spread Mozart Loader to other systems?
    context: Identifying lateral movement attempts and the potential scope of network compromise.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 445
            - 139
            - 135
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_sent