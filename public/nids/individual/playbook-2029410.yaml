name: ET MALWARE Mozart Loader Command Request (reporttask)
id: 22029410
description: |
  Detects Mozart Loader malware reporting task completion status to command and control server via DNS tunneling.
  The reporttask command indicates the malware has executed received commands and is providing feedback.
  May trigger on legitimate applications using similar DNS communication patterns for status reporting.
type: detection
detection_id: 2029410
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete DNS query containing the Mozart Loader reporttask command pattern?
    context: Analyzing the report structure reveals what task was completed and the communication protocol used.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.resolved_ip

  - question: What tasks were previously requested by this host before this report?
    context: Understanding the task sequence helps identify what malicious activity was executed.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "Mozart"
        condition: selection
      fields:
        - rule.name
        - dst_ip

  - question: Is this reporttask communication part of normal operational patterns for this host?
    context: Distinguishing between malicious reporting and legitimate application status communications.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name

  - question: What process initiated this Mozart Loader task reporting communication?
    context: Identifying the malware executable and its current execution context.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: What malicious activities occurred on this host before the task report was sent?
    context: Identifying what tasks were executed that are now being reported back to the CnC server.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid

  - question: Were any files created, modified, or accessed before this task report?
    context: Task reports often follow data collection, file manipulation, or payload deployment activities.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size
        - ProcessImage

  - question: What network connections were made before this task completion report?
    context: Understanding what network activities were performed as part of the completed task.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_sent
        - bytes_received

  - question: What DNS response was received for this Mozart Loader task report?
    context: Analyzing the CnC server's acknowledgment or next instructions following the report.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.resolved_ip
        - dns.response_code
        - dns.answers

  - question: Are there signs of new tasks being requested after this report was submitted?
    context: Determining if the malware received additional commands following the task completion report.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "Mozart"
        condition: selection
      fields:
        - rule.name
        - dst_ip

  - question: What other hosts are showing Mozart Loader task reporting behavior?
    context: Assessing the scope of active Mozart Loader infections and coordinated campaign activity.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: "ET MALWARE Mozart Loader Command Request (reporttask)"
        condition: selection
      fields:
        - src_ip
        - dst_ip

  - question: Are there indicators of data exfiltration or lateral movement associated with reported tasks?
    context: Task reports may follow data theft or network compromise activities that need immediate response.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 445
            - 139
            - 3389
            - 22
            - 21
            - 80
            - 443
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_sent

  - question: Has this host established persistence mechanisms that might be reported in this task?
    context: Understanding if the reported task involved establishing persistent access to the compromised system.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessImage