name: ET MALWARE Mozart Loader Command Request (reportupdates)
id: 22029411
description: |
  Detects Mozart Loader malware DNS command requests containing "reportupdates" pattern.
  This specific DNS query pattern indicates malware attempting to communicate with command and control infrastructure.
  Legitimate DNS queries would not contain this specific binary pattern.
type: detection
detection_id: 2029411
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact DNS query pattern that triggered this Mozart Loader detection?
    context: Understanding the complete DNS query reveals the malware's communication protocol and C2 structure.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.query.class_name
        - rule.name

  - question: What DNS server was targeted for this malicious query?
    context: Identifying the DNS server helps understand the malware's network path and potential DNS infrastructure compromise.
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - dns.query.name

  # Type 2: Triage Assessment
  - question: Has this source system made other suspicious DNS queries recently?
    context: Multiple suspicious DNS queries from the same source indicate confirmed malware infection rather than isolated incident.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category: "Malware"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - dns.query.name

  - question: Is this system normally making DNS queries to external resolvers?
    context: Understanding normal DNS behavior helps distinguish between legitimate administration and malware activity.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dns.query.name
        - dns.query.type_name

  # Type 3: Activity Context
  - question: What process initiated this DNS query on the infected system?
    context: Identifying the parent process helps understand how Mozart Loader was executed and its persistence mechanisms.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid

  - question: What network connections were established around the time of this DNS query?
    context: Mozart Loader typically follows DNS queries with HTTP/HTTPS connections to download additional payloads.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - protocol
        - connection.state

  # Type 4: Impact Assessment
  - question: Did the malware successfully establish C2 communication after this DNS query?
    context: Successful C2 communication indicates active malware infection requiring immediate containment.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - "Command and Control"
            - "Malware"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - dst_port
        - alert.severity

  - question: What files were created or modified on the system after this DNS activity?
    context: Mozart Loader typically downloads and executes additional malware components after initial C2 contact.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.hash.sha256
        - ProcessGuid

  # Type 5: Forensic Deep-Dive
  - question: What other Mozart Loader indicators are present on this system?
    context: Mozart Loader has multiple detection signatures that help confirm the malware family and variant.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "Mozart"
        condition: selection
      fields:
        - rule.name
        - rule.category
        - dst_ip
        - alert.severity

  - question: Are there signs of additional payload downloads or lateral movement?
    context: Mozart Loader is typically used as a first-stage loader for more sophisticated malware and lateral movement tools.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method: "GET"
        condition: selection
      fields:
        - dst_ip
        - url.full
        - http.response.status_code
        - http.response.body.bytes

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network showing Mozart Loader activity?
    context: Mozart Loader infections often spread through network shares or email, affecting multiple systems simultaneously.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Mozart"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - alert.severity