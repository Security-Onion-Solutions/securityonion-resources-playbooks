name: ET MALWARE TA402/Molerats Pierogi CnC Activity (Upload)
id: 22029435
description: |
  Detects TA402/Molerats Pierogi backdoor command and control upload activity via specific multipart form data.
  This signature identifies data exfiltration attempts using the Pierogi backdoor's unique upload mechanism.
  Legitimate file uploads would not use this specific boundary and form field naming convention.
type: detection
detection_id: 2029435
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What data was being uploaded in this Pierogi backdoor communication?
    context: Understanding the upload content reveals what information the malware is exfiltrating from the compromised system.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.body.content
        - http.request.method
        - url.full
        - http.request.headers

  - question: What was the complete HTTP request structure used by the Pierogi backdoor?
    context: Analyzing the full HTTP request helps understand the malware's communication protocol and potential data being transmitted.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.request.method
        - url.path
        - http.request.headers
        - http.request.body.bytes
        - http.response.status_code

  # Type 2: Triage Assessment
  - question: Is this system authorized to upload data to external servers?
    context: Legitimate business operations may involve file uploads, but the specific form field pattern indicates malicious activity.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method: "POST"
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - http.request.body.bytes
        - url.path

  - question: Has this user account been involved in other suspicious upload activities?
    context: Multiple upload activities from the same user may indicate compromised credentials or insider threat.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  # Type 3: Activity Context
  - question: What process initiated this malicious upload activity?
    context: Identifying the parent process helps understand how Pierogi backdoor was executed and maintains persistence.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ParentImage
        - ParentCommandLine
        - ProcessGuid

  - question: What other network connections were made to this C2 server?
    context: Pierogi backdoor typically maintains persistent connections and may have multiple communication channels.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_port
        - dst_port
        - protocol
        - connection.state
        - connection.bytes_sent
        - connection.bytes_received

  # Type 4: Impact Assessment
  - question: What files were accessed prior to this upload activity?
    context: Understanding file access patterns reveals what sensitive data may have been exfiltrated by the Pierogi backdoor.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - ProcessGuid
        - file.extension
        - file.size

  - question: Did the C2 server respond with additional commands after this upload?
    context: Successful uploads often trigger additional malware commands or payload downloads from the C2 infrastructure.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - http.request.method
        - url.path
        - http.response.status_code
        - http.response.body.bytes

  # Type 5: Forensic Deep-Dive
  - question: What other TA402/Molerats indicators are present on this system?
    context: TA402/Molerats typically uses multiple tools and techniques, requiring comprehensive indicator analysis.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "Molerats"
            - "TA402"
            - "Pierogi"
        condition: selection
      fields:
        - rule.name
        - rule.category
        - dst_ip
        - alert.severity

  - question: Are there signs of credential harvesting or lateral movement tools?
    context: TA402/Molerats often combines data exfiltration with credential theft and network reconnaissance.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - "net.exe"
            - "ping.exe"
            - "nslookup.exe"
            - "whoami.exe"
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid

  # Type 6: Enterprise Correlation
  - question: Are other systems communicating with this Pierogi C2 infrastructure?
    context: TA402/Molerats campaigns often target multiple systems within an organization simultaneously.
    range: -12h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - protocol
        - connection.state

  - question: Are there other systems showing signs of TA402/Molerats activity?
    context: Understanding the campaign scope helps prioritize incident response and containment efforts.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - "Molerats"
            - "TA402"
            - "Pierogi"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - alert.severity