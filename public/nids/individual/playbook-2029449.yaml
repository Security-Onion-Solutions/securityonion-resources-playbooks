name: ET MALWARE Observed Malicious SSL Cert (FIN7/GRIFFON CnC)
id: 22029449
description: |
  Detects malicious SSL certificates associated with FIN7/GRIFFON command and control infrastructure.
  The specific certificate subject "landscapesboxdesign9.com" is known to be used by FIN7 threat actors.
  Legitimate SSL certificates would not use this specific domain pattern associated with known malware campaigns.
type: detection
detection_id: 2029449
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What are the complete details of this malicious FIN7/GRIFFON SSL certificate?
    context: Understanding certificate details helps identify the C2 infrastructure and potential certificate authority compromise.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - tls.server.certificate.subject
        - tls.server.certificate.issuer
        - tls.server.certificate.serial_number
        - tls.server.certificate.not_before
        - tls.server.certificate.not_after

  - question: What SSL/TLS connection parameters were used with this malicious certificate?
    context: SSL connection details reveal the malware's encryption capabilities and communication security measures.
    query: |
      aggregation: false
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - tls.version
        - tls.cipher
        - tls.server.certificate.fingerprint
        - tls.server.certificate.subject
        - src_ip
        - dst_ip
        - dst_port

  # Type 2: Triage Assessment
  - question: Is this system authorized to connect to external SSL services?
    context: Understanding normal SSL connection patterns helps distinguish between legitimate business traffic and malware C2.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - tls.server.certificate.subject
        - tls.server.certificate.issuer

  - question: Has this certificate been observed in legitimate business applications?
    context: Legitimate certificates would have established patterns of use and proper certificate authority chains.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          tls.server.certificate.subject|contains: "landscapesboxdesign9.com"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - tls.server.certificate.issuer

  # Type 3: Activity Context
  - question: What process initiated the connection to this malicious SSL server?
    context: Identifying the initiating process helps understand how FIN7/GRIFFON malware was executed and maintains persistence.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid

  - question: What other network activity occurred around this SSL connection?
    context: FIN7/GRIFFON typically combines SSL C2 with other network protocols for comprehensive malware functionality.
    range: +/-30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - protocol
        - connection.state
        - connection.bytes_sent
        - connection.bytes_received

  - question: Was there HTTP traffic to the same server before the SSL connection?
    context: Many malware families use HTTP reconnaissance before establishing encrypted C2 channels.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - http.request.method
        - url.path
        - http.user_agent
        - http.response.status_code

  # Type 4: Impact Assessment
  - question: Did the malware successfully establish encrypted C2 communication?
    context: Successful SSL handshake indicates active malware infection with encrypted command channel.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - "Command and Control"
            - "Malware"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - dst_port
        - alert.severity

  - question: What data volumes were transmitted over this encrypted connection?
    context: Large data transfers may indicate data exfiltration or additional payload downloads.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - connection.bytes_sent
        - connection.bytes_received
        - connection.duration
        - dst_port

  # Type 5: Forensic Deep-Dive
  - question: What other FIN7/GRIFFON indicators are present on this system?
    context: FIN7 is a sophisticated threat actor using multiple tools and techniques requiring comprehensive analysis.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "FIN7"
            - "GRIFFON"
        condition: selection
      fields:
        - rule.name
        - rule.category
        - dst_ip
        - alert.severity

  - question: Are there signs of financial malware or point-of-sale targeting?
    context: FIN7 is known for targeting financial institutions and retail point-of-sale systems.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - "pos"
            - "payment"
            - "card"
            - "financial"
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  # Type 6: Enterprise Correlation
  - question: Are other systems connecting to FIN7/GRIFFON SSL infrastructure?
    context: FIN7 campaigns often target multiple systems within financial and retail organizations.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          tls.server.certificate.subject|contains: "landscapesboxdesign9.com"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - tls.version

  - question: Are there other systems showing FIN7-related malware activity?
    context: Understanding campaign scope helps prioritize incident response for financial data protection.
    range: -12h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - "FIN7"
            - "GRIFFON"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - alert.severity