name: ET MALWARE Possible Kimsuky Related Download
id: 22029452
description: |
  Detects potential malware download by Kimsuky APT group via GET requests to IERinstal.a file.
  May trigger on legitimate software installations or updates using similar naming patterns.
type: detection
detection_id: 2029452
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What is the complete download URL and file being retrieved?
    context: Understanding the full download path helps identify the malware variant and C2 infrastructure.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.user_agent
        - dst_ip

  - question: Is this a legitimate software installation or update process?
    context: Some enterprise software may use similar naming conventions for installation files.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method: "GET"
          url.path|contains: "instal"
        condition: selection
      fields:
        - dst_ip
        - url.path
        - http.response.status_code

  - question: What process initiated this download request?
    context: Identifying the parent process helps determine if this is user-initiated or automated malware activity.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - "winhttp"
            - "urlmon"
            - "wininet"
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ParentImage

  - question: Was the download successful and what was the file size?
    context: Successful downloads indicate potential malware staging, while failed attempts may suggest blocked C2 communication.
    range: -5m/+5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.request.method: "GET"
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.bytes
        - url.path

  - question: Where was the downloaded file saved on the system?
    context: Understanding file placement helps identify staging locations and potential execution paths.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          event_type: "file_create"
          TargetFilename|contains:
            - "IERinstal"
            - ".a"
            - "Temp"
            - "Downloads"
        condition: selection
      fields:
        - TargetFilename
        - ProcessName
        - file.size
        - file.hash.md5

  - question: Has the downloaded file been executed or opened?
    context: File execution indicates successful malware deployment and active compromise.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - "IERinstal"
            - ".a"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: What other malicious files were downloaded from the same server?
    context: Kimsuky often hosts multiple malware variants on the same infrastructure.
    range: -24h/+24h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          http.request.method: "GET"
          url.path|contains:
            - ".exe"
            - ".scr"
            - ".bat"
            - ".vbs"
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.response.status_code
        - http.user_agent

  - question: Are there signs of anti-analysis or evasion techniques?
    context: Kimsuky malware often employs evasion methods to avoid detection and analysis.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - "sleep"
            - "timeout"
            - "ping -n"
            - "tasklist"
            - "netstat"
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - User

  - question: What network communications occurred after the download?
    context: Post-download communications may indicate successful malware installation and C2 establishment.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 80
            - 443
            - 8080
            - 53
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_sent
        - bytes_received

  - question: Has this malware sample been seen on other systems?
    context: Identifying campaign scope helps understand the breadth of Kimsuky's targeting within the organization.
    range: -7d/+7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          url.path|contains: "IERinstal.a"
          http.request.method: "GET"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - http.response.status_code

  - question: Are there related DNS queries to known Kimsuky infrastructure?
    context: DNS queries may reveal additional C2 domains and infrastructure used in this campaign.
    range: -1h/+1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          dns.query.type_name: "A"
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.response_code