name: ET MALWARE ObliqueRAT CnC Checkin
id: 22029530
description: |
  Detects ObliqueRAT malware command and control communication patterns.
  ObliqueRAT is a remote access trojan that uses specific byte patterns for C2 checkins.
  May trigger on legitimate applications using similar binary protocols.
type: detection
detection_id: 2029530
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete binary payload pattern that triggered this alert?
    context: The specific byte sequence reveals ObliqueRAT's communication protocol structure.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - payload
        - rule.name

  - question: What is the destination server involved in this C2 communication?
    context: Identifying the C2 server helps determine campaign infrastructure and scope.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - dest.geo.country_name

  - question: Is this communication pattern normal for the affected host?
    context: Legitimate software may use binary protocols that could resemble malware patterns.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port

  - question: What processes were running on the source host during this timeframe?
    context: Identifying the parent process helps confirm if ObliqueRAT is actively running.
    range: -15m/+15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  - question: Are there other network connections from this host to external IPs?
    context: ObliqueRAT may establish multiple C2 channels or perform data exfiltration.
    range: -1h/+1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out

  - question: Has this host downloaded any suspicious files recently?
    context: ObliqueRAT infections often involve initial payload delivery through malicious documents.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method: GET
        condition: selection
      fields:
        - url.full
        - http.response.mime_type
        - http.response.body.bytes

  - question: Are there signs of file system modifications on the infected host?
    context: ObliqueRAT creates persistence mechanisms and may drop additional payloads.
    range: -2h/+30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessImage

  - question: Has the malware established persistence on the system?
    context: ObliqueRAT typically creates registry entries or scheduled tasks for persistence.
    range: -2h/+30m
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessImage

  - question: Are there DNS queries to suspicious domains from this host?
    context: ObliqueRAT may resolve C2 domains or perform reconnaissance activities.
    range: -1h/+1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  - question: Are other hosts in the network showing similar ObliqueRAT activity?
    context: Determines if this is an isolated infection or part of a broader campaign.
    range: -24h/+2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: ObliqueRAT
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: What is the timeline of related malware alerts across the enterprise?
    context: Understanding the attack timeline helps identify patient zero and campaign scope.
    range: -48h/+2h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          rule.category|contains:
            - trojan-activity
            - malware
        condition: selection
      fields:
        - src_ip
        - rule.name
        - rule.category