name: ET ADWARE_PUP Win32/Adware.Bang5mai.BB CnC Activity M3
id: 22029531
description: |
  Detects communication with Bang5mai adware command and control servers.
  This potentially unwanted program (PUP) generates unwanted advertisements and may collect user data.
  May trigger on legitimate applications with similar URL patterns.
type: detection
detection_id: 2029531
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete HTTP request that triggered this alert?
    context: The specific URL parameters reveal the adware's data collection and communication patterns.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - http.user_agent

  - question: What data is being transmitted in the URL parameters?
    context: Understanding the parameter values helps identify what information the adware is collecting.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - url.query
        - http.request.headers
        - http.response.status_code

  - question: Is this normal browsing behavior for this user?
    context: Legitimate users may occasionally visit sites with similar URL patterns.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method: GET
        condition: selection
      fields:
        - url.domain
        - http.user_agent
        - url.path

  - question: What browser or application initiated this request?
    context: Identifying the source application helps determine if adware is installed or if it's browser-based.
    range: -15m/+15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - browser
            - chrome
            - firefox
            - iexplore
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  - question: Are there other suspicious HTTP requests from this host?
    context: Adware typically makes multiple requests to different advertising and tracking domains.
    range: -1h/+1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains:
            - .gif
            - .php
        condition: selection
      fields:
        - url.domain
        - url.path
        - http.response.mime_type

  - question: Has this host recently downloaded potentially unwanted software?
    context: Bang5mai adware is often bundled with legitimate software downloads.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.response.mime_type|contains:
            - application/x-msdownload
            - application/octet-stream
        condition: selection
      fields:
        - url.full
        - http.response.body.bytes
        - http.user_agent

  - question: Are there signs of adware installation on the system?
    context: Adware typically creates files in temporary directories or program folders.
    range: -24h/+30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - \Temp\
            - \AppData\
            - bang5mai
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessImage

  - question: Has the adware modified browser settings or registry entries?
    context: Adware often changes browser settings to inject advertisements or redirect traffic.
    range: -24h/+30m
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - \Software\Microsoft\Internet Explorer
            - \Software\Google\Chrome
            - \Software\Mozilla
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessImage

  - question: What DNS queries has this host made to advertising domains?
    context: Adware resolves multiple advertising and tracking domains for monetization.
    range: -2h/+1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  - question: Are other hosts showing similar adware activity?
    context: Determines if this is isolated or part of organization-wide adware infection.
    range: -24h/+2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.category|contains: pup-activity
        condition: selection
      fields:
        - src_ip
        - rule.name
        - dst_ip

  - question: What is the pattern of PUP alerts across the enterprise?
    context: Understanding PUP distribution helps identify infection vectors and affected systems.
    range: -7d/+1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - ADWARE
            - PUP
        condition: selection
      fields:
        - src_ip
        - rule.name
        - rule.category