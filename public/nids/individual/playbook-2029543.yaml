name: ET ADWARE_PUP Ads2Srv Bundle Installer Offer Request
id: 22029543
description: |
  Detects Ads2Srv bundle installer making offer requests for potentially unwanted programs.
  This activity indicates software bundling operations that may install unwanted applications.
  May trigger on legitimate software installers with similar URL patterns.
type: detection
detection_id: 2029543
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What specific bundle offers are being requested?
    context: The URL parameters reveal what potentially unwanted programs are being offered for installation.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.full
        - url.query
        - http.user_agent

  - question: What installer is making this bundle request?
    context: The NSISDL user agent indicates a Nullsoft installer is downloading bundled software.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.user_agent
        - http.request.method
        - http.response.status_code
        - http.response.body.bytes

  - question: What software installation is occurring on this host?
    context: Identifying the parent installation helps determine if this is legitimate software bundling.
    range: -30m/+30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - setup
            - install
            - .exe
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  - question: Has this host recently downloaded software installers?
    context: Understanding the download source helps identify potentially unwanted software distribution.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.response.mime_type|contains:
            - application/x-msdownload
            - application/octet-stream
        condition: selection
      fields:
        - url.full
        - http.response.body.bytes
        - http.user_agent

  - question: Are there other bundle installer requests from this host?
    context: Multiple bundle requests indicate extensive potentially unwanted program installation.
    range: -1h/+1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains: bundles.php
        condition: selection
      fields:
        - url.domain
        - url.query
        - http.response.status_code

  - question: What files are being created during this installation process?
    context: Bundle installers typically create multiple files for different potentially unwanted programs.
    range: -30m/+1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessImage

  - question: Are registry modifications being made during the installation?
    context: Bundle installers often modify registry settings for multiple applications and adware.
    range: -30m/+1h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessImage

  - question: What DNS queries are being made for bundle server domains?
    context: DNS resolution patterns help identify the bundle distribution infrastructure.
    range: -1h/+1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  - question: Are there subsequent adware or PUP activities from this host?
    context: Bundle installations often result in ongoing adware and potentially unwanted program activity.
    range: +1h/+24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - pup-activity
            - adware
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.category

  - question: Are other hosts showing similar bundle installer activity?
    context: Identifies if this is isolated or part of organization-wide potentially unwanted software distribution.
    range: -24h/+2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: Bundle Installer
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: What is the pattern of PUP installation alerts across the enterprise?
    context: Understanding bundle installer distribution helps identify affected systems and infection vectors.
    range: -7d/+1d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.category: pup-activity
        condition: selection
      fields:
        - src_ip
        - rule.name
        - dst_ip