name: ET MALWARE Win32/Qbot/Quakbot Downloader - Requesting Secondary Download
id: 22029551
description: |
  Detects Qbot/Quakbot malware requesting secondary payload downloads from command and control servers.
  This indicates active malware infection attempting to download additional components.
  Legitimate applications do not typically use the specific WebGL3D user agent pattern.
type: detection
detection_id: 2029551
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete Qbot download request URL and parameters?
    context: Understanding the full request reveals the specific payload being requested and campaign details.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.request.headers.user_agent

  - question: What unique identifier was transmitted in the uid parameter?
    context: The UID parameter often contains victim fingerprinting data for tracking infections.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - url.query
        - http.response.body.content
        - http.response.status_code

  # Type 2: Triage Assessment
  - question: Is this system known to be infected with Qbot malware?
    context: Confirming if this is a new infection or ongoing malware communication.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'Qbot'
            - 'Quakbot'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.category

  - question: Are there legitimate applications using WebGL3D user agent on this system?
    context: Determining if this could be false positive from legitimate WebGL applications.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.headers.user_agent|contains: 'WebGL3D'
        condition: selection
      fields:
        - url.domain
        - http.request.headers.user_agent
        - dst_ip

  # Type 3: Activity Context
  - question: What was the initial infection vector that led to this Qbot activity?
    context: Identifying how the malware initially compromised the system for threat intelligence.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - '.exe'
          CommandLine|contains:
            - 'temp'
            - 'downloads'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid

  - question: What email or web activity preceded this malware communication?
    context: Understanding the delivery mechanism helps prevent future infections.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method: 'GET'
        condition: selection
      fields:
        - url.full
        - http.request.headers.referer
        - http.response.mime_type

  # Type 4: Impact Assessment
  - question: Did the Qbot malware successfully download additional payloads?
    context: Determining if secondary infections occurred and what additional threats are present.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.response.status_code: 200
          http.response.body.bytes: '>1000'
        condition: selection
      fields:
        - url.full
        - http.response.body.bytes
        - http.response.mime_type

  - question: What sensitive data has been accessed since the infection?
    context: Assessing potential data theft and credential compromise from Qbot activity.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - '.txt'
            - '.doc'
            - '.pdf'
            - 'password'
        condition: selection
      fields:
        - TargetFilename
        - ProcessGuid
        - file.size

  # Type 5: Forensic Deep-Dive
  - question: What Qbot configuration and C2 servers are being contacted?
    context: Identifying the complete C2 infrastructure for threat intelligence and blocking.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 80
            - 443
            - 8080
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - bytes_in

  - question: What persistence mechanisms has Qbot established?
    context: Understanding how the malware maintains access for complete remediation.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - 'Run'
            - 'RunOnce'
            - 'Services'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessGuid

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network infected with Qbot malware?
    context: Determining the scope of the Qbot campaign across the organization.
    range: -1d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'Qbot'
            - 'Quakbot'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is this part of a broader malware campaign targeting the organization?
    context: Understanding if this is isolated or part of coordinated attack against multiple systems.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          http.request.headers.user_agent: 'WebGL3D'
        condition: selection
      fields:
        - src_ip
        - url.domain
        - http.response.status_code