name: ET MALWARE Baraka Ransomware CnC activity email SMTP
id: 22029552
description: |
  Detects Baraka ransomware communicating with command and control servers via SMTP.
  This indicates active ransomware infection attempting to exfiltrate system information.
  Legitimate applications do not typically send drive enumeration data via SMTP.
type: detection
detection_id: 2029552
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What system information was exfiltrated in the Baraka ransomware SMTP communication?
    context: Understanding the complete data payload reveals victim fingerprinting and encryption status.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - email.message.body.content
        - email.message.subject
        - email.to.address

  - question: What drive and key information was transmitted to the ransomware operators?
    context: Decoding the info parameter reveals encrypted drives and victim identification data.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - network.bytes
        - network.protocol
        - network.transport

  # Type 2: Triage Assessment
  - question: Is this system known to be infected with ransomware?
    context: Confirming if this is new ransomware activity or ongoing infection communication.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'ransomware'
            - 'Baraka'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - dst_ip

  - question: Are there legitimate reasons for this system to send drive information via SMTP?
    context: Determining if this could be authorized system monitoring or backup software.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'backup'
            - 'monitor'
            - 'admin'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  # Type 3: Activity Context
  - question: What was the initial ransomware infection vector?
    context: Identifying how Baraka ransomware initially compromised the system.
    range: -48h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - '.exe'
            - 'temp'
            - 'downloads'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessGuid
        - file.size

  - question: What processes were running when the ransomware activated?
    context: Understanding the execution chain and parent processes of the ransomware.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid

  # Type 4: Impact Assessment
  - question: What files have been encrypted by the Baraka ransomware?
    context: Assessing the scope of file encryption to determine recovery requirements.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - '.encrypted'
            - '.locked'
            - '.baraka'
        condition: selection
      fields:
        - TargetFilename
        - file.size
        - ProcessGuid

  - question: Has the ransomware successfully communicated with its command and control server?
    context: Determining if the attackers have been notified of successful encryption.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 25
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.bytes
        - network.protocol

  - question: What ransom notes or instructions have been created?
    context: Understanding the ransom demands and recovery instructions left by attackers.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - 'readme'
            - 'ransom'
            - 'decrypt'
            - '.txt'
        condition: selection
      fields:
        - TargetFilename
        - ProcessGuid
        - file.size

  # Type 5: Forensic Deep-Dive
  - question: What encryption algorithms and methods is Baraka ransomware using?
    context: Understanding the encryption implementation helps determine recovery possibilities.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - 'crypt'
            - 'encrypt'
            - 'cipher'
        condition: selection
      fields:
        - CommandLine
        - Image
        - ProcessGuid

  - question: What system and network discovery has the ransomware performed?
    context: Identifying reconnaissance activities to understand attack scope and lateral movement.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'net.exe'
            - 'whoami.exe'
            - 'ipconfig.exe'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ProcessGuid

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network showing Baraka ransomware activity?
    context: Determining if this is an isolated infection or part of broader ransomware campaign.
    range: -1d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'Baraka'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is there evidence of lateral movement or network propagation?
    context: Understanding if the ransomware is spreading to other systems in the organization.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 445
            - 139
            - 3389
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.bytes