name: ET INFO External IP Lookup (avast .com)
id: 22029575
description: |
  Detects systems performing external IP address lookups via Avast's IP information service.
  This is typically legitimate behavior for Avast antivirus products checking external connectivity.
  May indicate reconnaissance activity if observed from non-Avast processes.
type: detection
detection_id: 2029575
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete HTTP request to the Avast IP lookup service?
    context: Full request details reveal whether this is legitimate Avast software or potential reconnaissance.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - http.request.headers
        - http.user_agent

  - question: What response was received from the IP lookup service?
    context: Response content helps determine what information was gathered about the external IP.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - http.response.headers

  # Type 2: Triage Assessment
  - question: Is Avast antivirus software installed on this system?
    context: Legitimate Avast installations would explain this IP lookup behavior.
    range: -7d
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - "avast"
            - "AvastSvc"
            - "AvastUI"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  - question: How frequently does this system perform IP lookups?
    context: Regular patterns suggest legitimate software behavior versus one-off reconnaissance.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.host|contains: "ip-info.ff.avast.com"
        condition: selection
      fields:
        - http.host
        - url.path

  - question: Is this activity occurring during business hours?
    context: Timing patterns help distinguish between legitimate software updates and reconnaissance.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.host|contains: "avast.com"
        condition: selection
      fields:
        - http.host
        - url.path

  # Type 3: Activity Context
  - question: What processes were running when this IP lookup occurred?
    context: Identifying the source process helps determine if this is legitimate Avast activity.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid

  - question: What other network connections occurred around the same time?
    context: Concurrent network activity may reveal broader reconnaissance or legitimate software behavior.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection.state

  # Type 4: Impact Assessment
  - question: What information was potentially gathered about the network?
    context: Understanding exposed information helps assess reconnaissance value for attackers.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.body.content
        - src_ip
        - dst_ip

  - question: Are there follow-up connections to external services after IP lookup?
    context: Subsequent external connections may indicate use of gathered IP information.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection.state

  # Type 5: Forensic Deep-Dive
  - question: What user account initiated this IP lookup activity?
    context: User context helps determine if this is administrative activity or potential compromise.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - User
        - Image
        - LogonId

  - question: Are there other reconnaissance-related activities from this system?
    context: Multiple reconnaissance activities may indicate systematic information gathering.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name

  # Type 6: Enterprise Correlation
  - question: Are other systems performing similar IP lookups?
    context: Enterprise-wide IP lookup activity may indicate coordinated reconnaissance or legitimate software deployment.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          http.host|contains: "ip-info.ff.avast.com"
        condition: selection
      fields:
        - src_ip
        - http.user_agent