name: ET MALWARE Kimsuky Related Host Data Exfil
id: 22029576
description: |
  Detects data exfiltration patterns associated with Kimsuky APT group using specific URI patterns and parameters.
  May trigger on legitimate applications using similar parameter structures.
type: detection
detection_id: 2029576
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What specific data was being exfiltrated in the p1 and p2 parameters?
    context: Understanding the exfiltrated data reveals the scope and sensitivity of the compromise.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.body.content
        - url.full
        - url.query
  - question: Is this legitimate application traffic from authorized software?
    context: Some applications may use similar parameter patterns for legitimate data transmission.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - user_agent.original
        - http.request.method
  - question: What process initiated this network connection?
    context: Identifying the source process helps determine if malware is present on the system.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - user.name
  - question: Has the DROPPER identifier been detected in the exfiltration?
    context: The DROPPER suffix indicates initial infection stage and helps assess campaign maturity.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - url.query
        - http.request.body.content
  - question: What files were accessed or modified before this exfiltration attempt?
    context: File activity reveals what data may have been collected for exfiltration.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - file.path
        - file.name
        - process.name
        - event.action
  - question: Are there signs of successful data transmission to the external server?
    context: Successful transmission indicates data loss and helps assess breach impact.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - network.bytes
        - network.packets
        - network.transport
  - question: What malware family indicators match this Kimsuky campaign?
    context: Specific malware signatures help identify the exact threat variant and capabilities.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "MALWARE"
        condition: selection
      fields:
        - rule.name
        - rule.category
        - dst_ip
  - question: Has this system shown other signs of Kimsuky APT activity?
    context: Multiple Kimsuky indicators confirm APT presence and help assess campaign scope.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "Kimsuky"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - timestamp
  - question: What persistence mechanisms have been established on this host?
    context: Persistence mechanisms indicate long-term compromise and help guide remediation efforts.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - registry.key
        - registry.value
        - process.name
  - question: Are other systems in the network showing similar Kimsuky exfiltration patterns?
    context: Enterprise-wide correlation reveals the scope of the APT campaign and lateral movement.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Kimsuky"
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - rule.name
        - url.query