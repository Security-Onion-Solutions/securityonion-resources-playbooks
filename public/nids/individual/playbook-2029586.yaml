name: ET MALWARE Kimsuky Related Host Data Exfil
id: 22029586
description: |
  Detects HTTP requests associated with Kimsuky APT group data exfiltration patterns.
  The specific URI pattern and user agent string are consistent with Kimsuky malware.
  May trigger on legitimate applications using similar HTTP request patterns.
type: detection
detection_id: 2029586
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What is the complete HTTP request including headers and body?
    context: Full request analysis reveals the exact data being exfiltrated and communication protocol.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - http.request.headers
        - http.request.body.content

  - question: What specific data is being transmitted in the URI parameters?
    context: URI parameters often contain encoded victim information or exfiltrated data.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - url.query
        - url.path
        - http.request.body.content

  - question: What is the decoded content of the suspicious user agent string?
    context: The specific user agent pattern is a known Kimsuky indicator and may contain encoded information.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.user_agent
        - http.request.headers

  # Type 2: Triage Assessment
  - question: Is this system known to run legitimate applications with similar HTTP patterns?
    context: Some legitimate software may generate similar HTTP request patterns.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method: "GET"
        condition: selection
      fields:
        - url.domain
        - http.user_agent

  - question: Are there scheduled tasks or services that could explain this activity?
    context: Legitimate automated processes might generate similar outbound HTTP requests.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ParentImage

  # Type 3: Activity Context
  - question: What process initiated this HTTP request?
    context: Identifying the source process helps confirm malicious activity versus legitimate software.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ProcessGuid
        - ParentImage

  - question: What other network connections occurred before this exfiltration attempt?
    context: Previous connections may show the initial compromise or C2 communication.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection.state
        - network.bytes_sent

  - question: Were there any file access events before this data exfiltration?
    context: File access patterns reveal what data may have been collected for exfiltration.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - ProcessName
        - User

  # Type 4: Impact Assessment
  - question: What is the volume and frequency of data being exfiltrated?
    context: Understanding data volume helps assess the scope of information compromise.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - network.bytes_sent

  - question: Are there ongoing connections to the same destination?
    context: Persistent connections indicate active data exfiltration requiring immediate response.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - connection.state
        - dst_port

  # Type 5: Forensic Deep-Dive
  - question: What other Kimsuky APT indicators are present on this system?
    context: Kimsuky typically deploys multiple tools and persistence mechanisms.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.hash.sha256
        - ProcessName

  - question: Are there registry modifications associated with Kimsuky persistence?
    context: Kimsuky malware often creates registry entries for persistence and configuration.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetObject
        - Details
        - Image

  # Type 6: Enterprise Correlation
  - question: Are other systems showing similar Kimsuky exfiltration patterns?
    context: Kimsuky campaigns often target multiple systems within an organization.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          url.query|contains: "&p1="
          http.request.method: "GET"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - http.user_agent