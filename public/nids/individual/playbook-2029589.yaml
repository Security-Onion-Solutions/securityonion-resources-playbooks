name: ET HUNTING Generic IOT Downloader Malware in GET (Outbound)
id: 22029589
description: |
  Detects outbound HTTP GET requests containing command sequences typical of IoT malware downloaders.
  The pattern includes wget commands, shell execution, and file removal operations.
  May trigger on legitimate system administration or automated deployment scripts.
type: detection
detection_id: 2029589
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What is the complete command sequence in the HTTP GET request?
    context: Full command analysis reveals the exact malware download and execution chain.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - http.request.body.content
        - url.query

  - question: What URLs and file paths are referenced in the wget commands?
    context: Download URLs reveal malware distribution infrastructure and payload locations.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - url.path
        - url.query
        - http.request.headers

  - question: What shell commands are being executed after the download?
    context: Post-download commands reveal malware installation and persistence mechanisms.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - url.query
        - http.request.body.content

  # Type 2: Triage Assessment
  - question: Is this system an IoT device or Linux server with legitimate wget usage?
    context: Some IoT devices and Linux systems legitimately use wget for updates and downloads.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method: "GET"
        condition: selection
      fields:
        - url.domain
        - http.user_agent

  - question: Are there scheduled maintenance windows or deployment activities?
    context: Legitimate system administration might involve similar command patterns.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - "wget"
            - "curl"
            - "sh"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  # Type 3: Activity Context
  - question: What network services are running on this system?
    context: Understanding system role helps determine if this is expected behavior or compromise.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_port
        - src_ip
        - connection.state

  - question: What processes were executing before this HTTP request?
    context: Previous process activity may show the initial compromise vector.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - User

  - question: Were there any authentication events or login attempts?
    context: Recent authentication activity may indicate how the system was initially compromised.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - "ssh"
            - "telnet"
            - "login"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  # Type 4: Impact Assessment
  - question: What files were potentially downloaded and executed?
    context: Understanding payload delivery helps assess the scope of system compromise.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessName

  - question: Are there signs of successful malware execution or persistence?
    context: Post-exploitation activity indicates successful compromise requiring immediate response.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  # Type 5: Forensic Deep-Dive
  - question: What IoT malware family characteristics are present?
    context: Specific malware families have distinct behavioral patterns and file signatures.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.sha256
        - file.mime_type

  - question: Are there network scanning or lateral movement attempts?
    context: IoT malware often attempts to spread to other devices on the network.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection.state

  # Type 6: Enterprise Correlation
  - question: Are other IoT devices showing similar downloader patterns?
    context: IoT malware campaigns often target multiple devices with similar vulnerabilities.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          url.query|contains:
            - "wget+http"
            - "sh+/"
            - "rm+-rf"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - url.domain