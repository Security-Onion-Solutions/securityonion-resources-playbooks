name: ET HUNTING Generic IOT Downloader Malware in GET (Inbound)
id: 22029590
description: |
  Detects inbound HTTP GET requests containing command sequences typical of IoT malware downloaders.
  The pattern includes wget commands, shell execution, and file removal operations from external sources.
  May trigger on legitimate remote administration or automated deployment from external systems.
type: detection
detection_id: 2029590
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What is the complete inbound command sequence in the HTTP GET request?
    context: Full command analysis reveals the exact malware download and execution chain from external source.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - http.request.body.content
        - url.query

  - question: What external IP is sending these malicious commands?
    context: Source IP analysis helps identify the attacker infrastructure and potential botnet controllers.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - http.user_agent
        - http.request.headers

  - question: What URLs and payloads are being pushed to the target system?
    context: Download URLs reveal malware distribution infrastructure and payload characteristics.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - url.path
        - url.query
        - http.request.body.content

  # Type 2: Triage Assessment
  - question: Is this target system an IoT device or server with remote management?
    context: Some IoT devices and servers legitimately accept remote commands for management purposes.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - connection.state

  - question: Are there authorized remote administration sessions from this source?
    context: Legitimate remote administration might involve similar command execution patterns.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - "ssh"
            - "telnet"
            - "httpd"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  # Type 3: Activity Context
  - question: What services are exposed on the target system?
    context: Understanding exposed services helps determine the attack vector and system vulnerability.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - src_ip
        - connection.state

  - question: What was the initial connection method from the external source?
    context: Initial connection patterns reveal how the attacker gained access to execute commands.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - connection.state
        - network.bytes_sent

  - question: Are there authentication attempts from this external source?
    context: Authentication events help determine if this is unauthorized access or credential compromise.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - "login"
            - "auth"
            - "ssh"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  # Type 4: Impact Assessment
  - question: Did the target system execute the malicious commands?
    context: Command execution confirmation indicates successful compromise requiring immediate response.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          CommandLine|contains:
            - "wget"
            - "curl"
            - "rm -rf"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: What files were downloaded or modified on the target system?
    context: File changes indicate successful payload delivery and potential system compromise.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessName

  # Type 5: Forensic Deep-Dive
  - question: What IoT malware characteristics are present on the target system?
    context: Specific malware families exhibit distinct behavioral patterns and persistence mechanisms.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.sha256
        - file.mime_type

  - question: Is the compromised system attempting to spread malware?
    context: IoT malware often uses infected systems to attack other devices on the network.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection.state

  # Type 6: Enterprise Correlation
  - question: Are other systems receiving similar malicious commands from this source?
    context: Understanding attack scope helps identify all compromised systems in the environment.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.query|contains:
            - "wget+http"
            - "sh+/"
            - "rm+-rf"
        condition: selection
      fields:
        - dst_ip
        - url.domain

  - question: Is this external IP targeting multiple IoT devices in the network?
    context: Coordinated attacks against multiple IoT devices indicate botnet recruitment activity.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection.state