name: ET MALWARE Observed Malicious SSL Cert (Cobalt Strike CnC)
id: 22029639
description: |
  Detects SSL certificate associated with Cobalt Strike command and control infrastructure.
  Cobalt Strike is a legitimate penetration testing tool frequently abused by threat actors.
  May rarely trigger on legitimate penetration testing with similar certificate configurations.
type: detection
detection_id: 2029639
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What are the complete details of the malicious SSL certificate?
    context: Understanding certificate attributes helps identify the specific Cobalt Strike infrastructure and campaign.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - tls.server.certificate.subject
        - tls.server.certificate.issuer
        - tls.server.certificate.fingerprint
        - tls.server.certificate.serial_number

  - question: What is the full SSL handshake information for this Cobalt Strike connection?
    context: SSL handshake details reveal encryption capabilities and potential evasion techniques.
    query: |
      aggregation: false
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - tls.version
        - tls.cipher
        - tls.server.certificate.subject
        - tls.server.certificate.not_after

  # Type 2: Triage Assessment
  - question: Is this connection part of authorized penetration testing or red team exercises?
    context: Cobalt Strike is legitimate security software that may be used in authorized testing.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - protocol
        - bytes_toserver
        - bytes_toclient

  - question: Does the timing align with scheduled security assessments or testing?
    context: Legitimate Cobalt Strike usage should correlate with documented security testing activities.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  # Type 3: Activity Context
  - question: What process or service initiated the connection to this Cobalt Strike server?
    context: Identifying the initiating process helps determine infection vector and malware persistence.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 443
        condition: selection
      fields:
        - src_port
        - protocol
        - bytes_toserver
        - bytes_toclient

  - question: What other network activity occurred before this Cobalt Strike communication?
    context: Understanding the attack chain helps identify initial compromise and lateral movement.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - protocol
        - bytes_toserver

  # Type 4: Impact Assessment
  - question: Has the Cobalt Strike beacon established persistent communication?
    context: Successful beacon communication indicates active compromise and ongoing C2 capability.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - tls.server.certificate.subject
        - bytes_toserver
        - bytes_toclient

  - question: What data has been transmitted through this encrypted Cobalt Strike channel?
    context: Assessing data volume helps determine potential data exfiltration and command execution.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 443
        condition: selection
      fields:
        - bytes_toserver
        - bytes_toclient
        - protocol

  # Type 5: Forensic Deep-Dive
  - question: What Cobalt Strike payloads or artifacts are present on the compromised system?
    context: Identifying Cobalt Strike components helps understand attack capabilities and persistence mechanisms.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessName
        - file.size

  - question: Are there indicators of Cobalt Strike post-exploitation activities?
    context: Understanding post-exploitation helps assess damage and identify lateral movement attempts.
    range: -8h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - powershell
            - cmd.exe
            - rundll32
            - regsvr32
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ParentImage

  # Type 6: Enterprise Correlation
  - question: Are other systems showing connections to this Cobalt Strike infrastructure?
    context: Identifying campaign scope helps understand lateral movement and multi-system compromise.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Cobalt Strike"
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name