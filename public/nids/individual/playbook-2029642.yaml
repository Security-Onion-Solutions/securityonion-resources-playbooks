name: ET MALWARE Observed Malicious SSL Cert (Win32/SandCat CnC)
id: 22029642
description: |
  Detects SSL certificate associated with Win32/SandCat malware command and control infrastructure.
  SandCat is a malware family used for remote access and data theft operations.
  This certificate pattern is exclusively associated with malicious activity.
type: detection
detection_id: 2029642
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What are the complete SSL certificate details for this SandCat C2 server?
    context: Understanding certificate attributes helps identify the specific malware infrastructure and campaign timeline.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - tls.server.certificate.subject
        - tls.server.certificate.issuer
        - tls.server.certificate.fingerprint
        - tls.server.certificate.serial_number

  - question: What SSL/TLS configuration is the SandCat C2 server using?
    context: SSL configuration details reveal malware encryption capabilities and potential detection evasion methods.
    query: |
      aggregation: false
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - tls.version
        - tls.cipher
        - tls.server.certificate.not_before
        - tls.server.certificate.not_after

  # Type 2: Triage Assessment
  - question: Is this the first time this system has connected to SandCat infrastructure?
    context: Determining if this represents initial infection or ongoing compromise helps prioritize response.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          tls.server.certificate.subject|contains: hpphhpph.com
        condition: selection
      fields:
        - dst_ip
        - tls.server.certificate.subject
        - bytes_toserver
        - bytes_toclient

  - question: Does this connection pattern align with typical SandCat malware behavior?
    context: Understanding connection frequency helps distinguish between active infections and scanning attempts.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - protocol
        - bytes_toserver
        - bytes_toclient

  # Type 3: Activity Context
  - question: What process initiated the connection to this SandCat C2 server?
    context: Identifying the initiating process helps determine infection vector and malware persistence mechanism.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid

  - question: What suspicious network activity preceded this SandCat communication?
    context: Understanding the attack sequence helps identify initial compromise vector and lateral movement.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - protocol
        - bytes_toserver

  # Type 4: Impact Assessment
  - question: Has SandCat successfully established persistent command and control communication?
    context: Successful C2 communication indicates active compromise with potential for data theft and remote control.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - bytes_toserver
        - bytes_toclient
        - tls.server.certificate.subject

  - question: What volume of data has been transmitted through this encrypted SandCat channel?
    context: Data volume analysis helps assess potential data exfiltration and command execution scope.
    range: -12h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 443
        condition: selection
      fields:
        - bytes_toserver
        - bytes_toclient
        - protocol

  # Type 5: Forensic Deep-Dive
  - question: What SandCat malware artifacts are present on the infected system?
    context: Identifying malware components helps understand attack capabilities and persistence mechanisms.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessName
        - file.size

  - question: Are there signs of SandCat performing data collection or system reconnaissance?
    context: Understanding malware activities helps assess data theft risk and system compromise extent.
    range: -8h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - systeminfo
            - whoami
            - net user
            - tasklist
            - dir
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ParentImage

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network showing connections to SandCat infrastructure?
    context: Identifying campaign scope helps understand lateral movement and multi-system compromise patterns.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: SandCat
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name