name: ET MALWARE MSIL/Modi RAT CnC Checkin (DesktopPreview)
id: 22029698
description: |
  Detects Modi RAT command and control communication containing the DesktopPreview command.
  This indicates an active RAT infection attempting to capture desktop screenshots.
  No legitimate use cases for this specific pattern.
type: detection
detection_id: 2029698
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete payload containing the DesktopPreview command?
    context: Understanding the full RAT command structure reveals capabilities and communication protocol.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - app_proto

  - question: What is the size and structure of the network traffic?
    context: Modi RAT has specific traffic patterns that help confirm malicious activity.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - network.bytes
        - network.packets
        - network.protocol

  # Type 2: Triage Assessment
  - question: Is this system known to have legitimate remote administration tools?
    context: Eliminating authorized remote access software that might generate similar traffic.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'TeamViewer'
            - 'VNC'
            - 'RDP'
            - 'RemoteDesktop'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  # Type 3: Activity Context
  - question: What process initiated this network connection?
    context: Identifying the parent process helps determine infection vector and persistence.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - ParentImage
        - CommandLine
        - ProcessGuid

  - question: What other network connections occurred from this host around the same time?
    context: RATs typically establish multiple connections for different functions.
    range: +/-30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.bytes
        - network.protocol

  - question: Were there any DNS queries for the C2 domain before this connection?
    context: Understanding domain resolution patterns helps track infection timeline.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          dns.resolved_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.resolved_ip

  # Type 4: Impact Assessment
  - question: Has the RAT successfully executed desktop capture commands?
    context: Determines if sensitive information has been compromised via screenshot theft.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - '.bmp'
            - '.jpg'
            - '.png'
            - 'screenshot'
            - 'desktop'
        condition: selection
      fields:
        - TargetFilename
        - file.size
        - ProcessName

  - question: What data has been transmitted to the C2 server?
    context: Large outbound transfers may indicate data exfiltration or screenshot uploads.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - network.bytes_sent
        - network.bytes_received
        - dst_port

  # Type 5: Forensic Deep-Dive
  - question: What Modi RAT variant and configuration is present on the system?
    context: Different Modi RAT versions have varying capabilities and persistence mechanisms.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.hash.md5: 'ca075cb808eb6f69ab5ea82d7acb3f39'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.sha256
        - ProcessName

  - question: What persistence mechanisms has the RAT established?
    context: Understanding persistence helps with complete remediation planning.
    range: +/-2h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetObject|contains:
            - 'Run'
            - 'RunOnce'
            - 'Services'
            - 'Winlogon'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessName

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network communicating with the same C2 server?
    context: Modi RAT campaigns often target multiple systems within an organization.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - network.bytes