name: ET PHISHING Successful NHS Webmail Phish 2020-03-23
id: 22029701
description: |
  Detects successful credential submission to NHS webmail phishing sites.
  May trigger on legitimate NHS webmail usage but indicates potential credential compromise when targeting external servers.
type: detection
detection_id: 2029701
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What credentials were submitted to this suspected NHS phishing site?
    context: Understanding the credential format helps confirm phishing activity and assess compromise scope.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.body.content
        - url.full
        - http.request.method
        - src_ip

  - question: Is this a legitimate NHS webmail server or a malicious phishing site?
    context: Distinguishes between authorized NHS infrastructure and fraudulent credential harvesting operations.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          dns.resolved_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name

  - question: How did the user arrive at this NHS webmail login page?
    context: Traces the attack vector to identify phishing emails, malicious links, or compromised websites.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.request.headers.referer

  - question: What user agent and browser characteristics are associated with this submission?
    context: Helps identify if this is automated credential stuffing or human-driven phishing victim.
    range: +/-5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - http.request.headers.user_agent
        - http.response.status_code
        - url.path

  - question: Has this user submitted credentials to other suspicious healthcare-themed sites?
    context: Identifies if the user is repeatedly falling victim to healthcare sector phishing campaigns.
    range: -7d
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.body.content|contains:
            - "usr="
            - "pss="
            - "password"
        condition: selection
      fields:
        - url.full
        - dst_ip
        - http.request.headers.host

  - question: What response did the phishing site provide after credential submission?
    context: Determines if credentials were successfully harvested and what next steps the attackers took.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - url.full

  - question: Are there signs of credential validation attempts using the harvested information?
    context: Identifies if stolen credentials are being tested against legitimate NHS or other healthcare systems.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.body.content|contains:
            - "login"
            - "auth"
            - "signin"
        condition: selection
      fields:
        - url.full
        - dst_ip
        - http.response.status_code

  - question: Has this phishing infrastructure been used to target other users in the organization?
    context: Reveals the scope of the phishing campaign and identifies other potential victims.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          http.request.body.content|contains:
            - "usr="
            - "pss="
        condition: selection
      fields:
        - src_ip
        - url.path

  - question: What email or messaging activity preceded this credential submission?
    context: Links the phishing attempt to delivery mechanisms and identifies the initial attack vector.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - "outlook.exe"
            - "thunderbird.exe"
            - "chrome.exe"
            - "firefox.exe"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: Are there indicators of follow-up malware delivery or account compromise?
    context: Determines if the phishing attack progressed to secondary payload delivery or account takeover.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.mime_type

  - question: What SSL certificate details are associated with this phishing site?
    context: Provides infrastructure intelligence for blocking and attribution of the phishing operation.
    range: +/-1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - tls.server.certificate.subject
        - tls.server.certificate.issuer
        - tls.server.certificate.serial_number

  - question: Has this user's account shown signs of unauthorized access following credential theft?
    context: Confirms successful credential compromise and identifies unauthorized account usage patterns.
    range: +48h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          User|expand: '%User%'
        condition: selection
      fields:
        - host.ip
        - Image
        - CommandLine
        - ProcessGuid