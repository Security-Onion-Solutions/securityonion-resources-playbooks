name: ET MALWARE CoreDDRAT CnC Activity
id: 22029725
description: |
  Detects CoreDDRAT malware receiving command and control communications from external servers.
  This signature identifies the specific 18-byte response pattern used by CoreDDRAT C2 infrastructure.
type: detection
detection_id: 2029725
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What is the exact 18-byte command payload received from the C2 server?
    context: Understanding the specific command structure reveals CoreDDRAT's operational capabilities and current tasking.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - src_ip
        - dst_ip
        - src_port

  - question: Is this part of an established C2 session or a new connection?
    context: Determines if this is ongoing malware operation or initial compromise phase.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_port
        - dst_port
        - bytes_toserver
        - bytes_toclient

  - question: What process on the victim system is receiving these C2 commands?
    context: Identifies the CoreDDRAT malware process and its execution context on the compromised endpoint.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: How frequently are these C2 commands being received?
    context: Reveals the operational tempo and urgency of the CoreDDRAT campaign.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "CoreDDRAT CnC"
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - count

  - question: What actions did the malware take after receiving these commands?
    context: Determines if CoreDDRAT executed received commands and what operations were performed.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid

  - question: Are there signs of data collection or reconnaissance activities following this C2 communication?
    context: Identifies if CoreDDRAT began information gathering or system enumeration tasks.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - Image

  - question: Has this C2 server communicated with other systems in the network?
    context: Reveals the scope of CoreDDRAT infection across the enterprise environment.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toclient

  - question: What network infrastructure is supporting this C2 communication?
    context: Maps the CoreDDRAT command and control infrastructure for blocking and attribution.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          dns.resolved_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name

  - question: Are there indicators of privilege escalation or lateral movement attempts?
    context: Determines if CoreDDRAT is attempting to expand access within the compromised environment.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - "powershell.exe"
            - "cmd.exe"
            - "wmic.exe"
            - "net.exe"
        condition: selection
      fields:
        - CommandLine
        - User
        - IntegrityLevel
        - ProcessGuid

  - question: What is the timing pattern of these C2 communications?
    context: Reveals CoreDDRAT's operational schedule and helps predict future activity windows.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "CoreDDRAT"
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - rule.name
        - count

  - question: Has the infected system attempted to contact additional C2 infrastructure?
    context: Identifies backup or secondary command servers used by the CoreDDRAT operation.
    range: +/-6h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 1024
            - 1025
            - 1026
            - 1027
            - 1028
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver