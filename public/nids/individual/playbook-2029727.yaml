name: ET MALWARE CoreDDRAT Screenshot Exfil
id: 22029727
description: |
  Detects CoreDDRAT malware exfiltrating screenshot data containing JPEG image headers.
  This indicates active data theft operations targeting visual information from compromised systems.
type: detection
detection_id: 2029727
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What screenshot data is being exfiltrated in this transmission?
    context: Understanding the image content reveals what sensitive information CoreDDRAT is stealing from user desktops.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - src_ip
        - dst_ip
        - dst_port

  - question: Is this screenshot capture part of routine user activity or unauthorized surveillance?
    context: Distinguishes between legitimate screen sharing applications and malicious data theft operations.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - "TeamViewer"
            - "AnyDesk"
            - "Chrome"
            - "Zoom"
            - "Skype"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: What process captured and transmitted this screenshot data?
    context: Identifies the CoreDDRAT malware process responsible for screen capture and data exfiltration.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid

  - question: How much screenshot data has been exfiltrated from this system?
    context: Quantifies the scope of visual data theft and potential exposure of sensitive information.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "CoreDDRAT Screenshot"
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - count

  - question: Are screenshots being captured at regular intervals or triggered by specific events?
    context: Reveals CoreDDRAT's screenshot collection strategy and operational patterns.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "CoreDDRAT Screenshot"
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - count

  - question: What user activities were occurring when screenshots were captured?
    context: Determines what sensitive information may have been visible during screen capture operations.
    range: +/-30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - "outlook.exe"
            - "winword.exe"
            - "excel.exe"
            - "chrome.exe"
            - "firefox.exe"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: Has this C2 server received screenshot data from other compromised systems?
    context: Identifies the scope of CoreDDRAT's visual surveillance campaign across the enterprise.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "CoreDDRAT Screenshot"
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - count

  - question: Are there temporary screenshot files being created and deleted on the system?
    context: Reveals CoreDDRAT's file handling operations and potential forensic artifacts.
    range: +/-1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - ".jpg"
            - ".jpeg"
            - ".png"
            - ".bmp"
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size

  - question: What other data exfiltration activities are occurring alongside screenshot theft?
    context: Identifies additional CoreDDRAT data collection capabilities beyond visual surveillance.
    range: +/-2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          bytes_toserver: ">50000"
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver
        - bytes_toclient

  - question: Are there signs of keylogging or credential theft accompanying the screenshot capture?
    context: Determines if CoreDDRAT is conducting comprehensive information gathering beyond visual data.
    range: +/-1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - "password"
            - "credential"
            - "login"
            - "auth"
        condition: selection
      fields:
        - CommandLine
        - Image
        - User
        - ProcessGuid

  - question: What network bandwidth is being consumed by screenshot exfiltration?
    context: Assesses the network impact of CoreDDRAT's visual data theft operations.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - bytes_toserver
        - bytes_toclient

  - question: Are there indicators of real-time monitoring or live surveillance capabilities?
    context: Determines if CoreDDRAT provides real-time visual access to compromised systems.
    range: +/-30m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "CoreDDRAT"
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - rule.name
        - dst_ip