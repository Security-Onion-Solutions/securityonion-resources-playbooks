name: ET PHISHING Common Unhidebody Function Observed in Phishing Landing
id: 22029732
description: |
  Detects phishing pages using JavaScript unhideBody() function to bypass security scanners.
  This technique hides malicious content until page loads, evading automated detection.
  No legitimate use cases for this specific obfuscation pattern.
type: detection
detection_id: 2029732
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What is the complete JavaScript obfuscation code in the phishing page?
    context: Understanding the full obfuscation reveals the phishing technique and hidden content.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.body.content
        - http.response.body.content
        - file.data

  - question: What is the target URL and POST method configuration?
    context: Identifying where stolen credentials are sent helps track the threat actor infrastructure.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.request.body.content
        - url.domain

  # Type 2: Triage Assessment
  - question: Is this a known legitimate website using similar JavaScript patterns?
    context: Some legitimate sites may use body visibility controls for loading screens.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          url.domain|expand: '%url.domain%'
        condition: selection
      fields:
        - src_ip
        - http.request.referrer
        - user_agent.original

  - question: Does the user regularly visit this domain for business purposes?
    context: Determining if this is an expected business website or suspicious domain.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.domain|expand: '%url.domain%'
        condition: selection
      fields:
        - url.path
        - http.response.status_code
        - network.bytes

  # Type 3: Activity Context
  - question: How did the user arrive at this phishing page?
    context: Understanding the infection vector helps identify the attack campaign source.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - http.request.referrer
        - url.full
        - user_agent.original

  - question: What email or link led to this phishing attempt?
    context: Tracking the delivery mechanism helps identify the phishing campaign.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          dns.resolved_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name

  # Type 4: Impact Assessment
  - question: Did the user submit credentials or personal information to this phishing page?
    context: Determining if credential theft was successful guides incident response priority.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.domain|expand: '%url.domain%'
          http.request.method: 'POST'
        condition: selection
      fields:
        - http.request.body.content
        - http.response.status_code
        - network.bytes_sent

  - question: What sensitive data was potentially exposed in form submissions?
    context: Understanding data exposure helps determine breach notification requirements.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method: 'POST'
        condition: selection
      fields:
        - url.full
        - http.request.body.content
        - network.bytes_sent

  # Type 5: Forensic Deep-Dive
  - question: What other phishing indicators are present on this domain?
    context: Comprehensive analysis helps identify the full scope of the phishing infrastructure.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          url.domain|expand: '%url.domain%'
        condition: selection
      fields:
        - url.path
        - http.response.status_code
        - src_ip
        - user_agent.original

  - question: What is the SSL certificate information for this phishing domain?
    context: Certificate details help track threat actor infrastructure and identify related campaigns.
    query: |
      aggregation: false
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - tls.server.certificate.subject
        - tls.server.certificate.issuer
        - tls.server.certificate.serial_number

  # Type 6: Enterprise Correlation
  - question: Have other users in the organization accessed this phishing domain?
    context: Identifying multiple victims helps assess campaign scope and prioritize response.
    range: +/-7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          url.domain|expand: '%url.domain%'
        condition: selection
      fields:
        - src_ip
        - http.request.method
        - user_agent.original

  - question: Are there similar phishing attempts targeting other domains in the organization?
    context: Understanding campaign breadth helps identify coordinated phishing attacks.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'PHISHING'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name