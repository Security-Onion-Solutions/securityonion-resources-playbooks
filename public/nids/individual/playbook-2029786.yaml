name: ET MALWARE Linux/Agent.HX CnC Activity M1
id: 22029786
description: |
  Detects Linux/Agent.HX malware heartbeat communications to command and control servers.
  The "beatHeart" message indicates ongoing C2 connectivity from an infected Linux system.
  This follows the initial "onlineLinux" beacon and represents persistent malware activity.
type: detection
detection_id: 2029786
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What is the exact heartbeat payload and timing interval?
    context: Heartbeat patterns reveal C2 protocol details and malware configuration.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - bytes_out
        - rule.name

  - question: What are the complete connection details for this heartbeat communication?
    context: Connection metadata confirms the established C2 channel and infrastructure.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_port
        - dst_port
        - protocol

  # Type 2: Triage Assessment
  - question: Was the initial Agent.HX infection beacon detected from this same system?
    context: Confirming the infection sequence helps validate this is part of an ongoing compromise.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: 'Agent.HX'
          rule.name|contains: 'set'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - payload

  - question: Is this heartbeat pattern consistent with normal system operations?
    context: Legitimate Linux services do not generate this specific heartbeat pattern.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - bytes_out
        - bytes_in

  # Type 3: Activity Context
  - question: What is the frequency and pattern of these heartbeat communications?
    context: Heartbeat timing reveals C2 protocol behavior and potential for command reception.
    range: -2h/+2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: 'beatHeart'
        condition: selection
      fields:
        - rule.name
        - bytes_out

  - question: What other malicious activity is occurring on this infected system?
    context: Heartbeats indicate active C2, suggesting potential for additional malicious commands.
    range: -1h/+1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.category

  - question: What process is maintaining this persistent C2 connection?
    context: Identifying the infected process helps understand the malware's persistence mechanism.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          Hostname|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ProcessGuid
        - User
        - ProcessId

  # Type 4: Impact Assessment
  - question: Are there signs of command execution or data exfiltration via this C2 channel?
    context: Active C2 channels may be receiving commands or exfiltrating sensitive data.
    range: -1h/+1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - bytes_in
        - bytes_out
        - duration

  - question: What sensitive files or directories has the infected system accessed recently?
    context: File access patterns reveal potential data theft or system compromise scope.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          Hostname|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - ProcessName
        - User
        - file.hash.md5

  # Type 5: Forensic Deep-Dive
  - question: What commands or payloads are being received from the C2 server?
    context: Inbound C2 traffic reveals attacker objectives and active threat capabilities.
    range: -2h/+2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
          bytes_in|gt: 0
        condition: selection
      fields:
        - bytes_in
        - src_port
        - dst_port

  - question: What additional malware components have been deployed on this system?
    context: Agent.HX infections often serve as initial access for additional malware deployment.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          Hostname|expand: '%src_ip%'
          TargetFilename|endswith:
            - '.sh'
            - '.py'
            - '.elf'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessName
        - User

  - question: What persistence mechanisms are maintaining this ongoing C2 communication?
    context: Understanding persistence helps ensure complete malware removal during remediation.
    range: -7d
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          Hostname|expand: '%src_ip%'
          TargetFilename|contains:
            - '/etc/cron'
            - '/etc/init'
            - '/etc/systemd'
            - '/home/'
            - '/tmp/'
        condition: selection
      fields:
        - TargetFilename
        - ProcessName
        - User

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network infected with Agent.HX or communicating with this C2?
    context: Multiple infections indicate lateral movement or coordinated attack campaign.
    range: -24h/+24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - bytes_out
        - bytes_in