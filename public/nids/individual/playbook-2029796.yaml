name: ET MALWARE Suspected CHAOS CnC Inbound (upload command)
id: 22029796
description: |
  Detects CHAOS RAT command and control traffic containing base64-encoded "upload" commands.
  The payload "dXBsb2Fk" decodes to "upload" indicating data exfiltration instructions.
  Legitimate applications rarely use this specific base64 encoding for file uploads.
type: detection
detection_id: 2029796
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete base64-encoded upload command and parameters?
    context: Analyzing the full payload reveals file targets and exfiltration parameters for the upload operation.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - src_ip
        - dst_ip
        - src_port
        - dst_port

  - question: What network connection metadata supports this data exfiltration?
    context: Understanding connection characteristics helps identify CHAOS RAT's data transfer patterns.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - connection_state
        - orig_bytes
        - resp_bytes
        - duration

  # Type 2: Triage Assessment
  - question: Is this system authorized for external data uploads or backups?
    context: Legitimate backup and sync operations have different patterns than CHAOS RAT exfiltration.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - service
        - orig_bytes

  - question: Does this host normally perform scheduled file uploads during this timeframe?
    context: Understanding normal upload patterns helps distinguish malicious from legitimate file transfers.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          orig_bytes|gte: 1000000
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - orig_bytes
        - resp_bytes

  # Type 3: Activity Context
  - question: What process is executing the CHAOS RAT upload functionality?
    context: Identifying the malware process helps understand how it gained access and maintains persistence.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid

  - question: What file access activity preceded this upload command?
    context: CHAOS typically accesses and stages files before exfiltration, revealing targeted data types.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.size
        - file.mime_type

  # Type 4: Impact Assessment
  - question: What specific files were uploaded following this command?
    context: Understanding exfiltrated content helps assess data breach scope and notification requirements.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          orig_bytes|gte: 1000
        condition: selection
      fields:
        - orig_bytes
        - resp_bytes
        - duration
        - connection_state

  - question: What sensitive data types were accessed before the upload operation?
    context: Identifying accessed data helps determine breach impact and regulatory compliance requirements.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - '.doc'
            - '.pdf'
            - '.xls'
            - '.txt'
            - '.csv'
        condition: selection
      fields:
        - TargetFilename
        - file.size
        - file.hash.md5

  # Type 5: Forensic Deep-Dive
  - question: What CHAOS RAT capabilities and configuration are active on this system?
    context: Understanding the malware's full capabilities helps assess ongoing threats and remediation needs.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.mime_type|contains:
            - 'executable'
            - 'application'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.hash.sha256
        - file.mime_type

  - question: What command and control infrastructure is receiving the uploaded data?
    context: Mapping the data exfiltration infrastructure helps identify campaign scope and enables disruption.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network showing CHAOS RAT upload activity?
    context: Multiple systems with upload commands may indicate a coordinated data exfiltration campaign.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'CHAOS CnC'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is this part of a broader data theft campaign across the enterprise?
    context: Coordinated exfiltration across multiple systems requires enterprise-wide response and containment.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|expand: '%dst_port%'
          orig_bytes|gte: 100000
        condition: selection
      fields:
        - src_ip
        - orig_bytes
        - resp_bytes