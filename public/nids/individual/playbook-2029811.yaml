name: ET MOBILE_MALWARE Android/TrojanDropper.Agent.EQO Variant CnC Activity
id: 22029811
description: |
  Detects Android TrojanDropper.Agent.EQO malware communicating with command and control servers.
  This malware variant sends device information and receives commands via HTTP POST requests.
  May trigger on legitimate applications with similar JSON structure, but specific pattern indicates malicious activity.
type: detection
detection_id: 2029811
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What device information was transmitted in the malware's JSON payload?
    context: Understanding the data structure reveals what information the malware is exfiltrating from the infected device.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.body.content
        - http.request.method
        - url.full

  - question: What is the complete structure of the CC_GRABBER payload?
    context: Analyzing the full payload structure helps identify the malware's capabilities and data collection methods.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.request.method: "POST"
          url.path: "/_ping.php"
        condition: selection
      fields:
        - http.request.body.content
        - http.request.headers

  # Type 2: Triage Assessment
  - question: Is this mobile device known to connect to legitimate services?
    context: Determining if the source device typically engages in normal mobile traffic patterns versus suspicious activity.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - protocol

  - question: Does the timing align with typical mobile application usage patterns?
    context: Malware often communicates at regular intervals, unlike normal user-initiated mobile app traffic.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method: "POST"
        condition: selection
      fields:
        - url.path
        - dst_ip

  # Type 3: Activity Context
  - question: What other HTTP requests preceded this malware communication?
    context: Understanding the sequence of events helps identify the initial infection vector or trigger.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - http.request.body.content

  - question: What DNS queries were made to resolve the C2 server?
    context: DNS resolution patterns can reveal infrastructure and help identify related malicious domains.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  # Type 4: Impact Assessment
  - question: Has the malware received any commands from the C2 server?
    context: Identifying C2 responses helps assess what actions the malware may have been instructed to perform.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content

  - question: What sensitive data might be accessible on this mobile device?
    context: Understanding device access patterns helps assess potential data exposure risk.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 443
            - 993
            - 995
        condition: selection
      fields:
        - dst_ip
        - dst_port

  # Type 5: Forensic Deep-Dive
  - question: Are there indicators of additional malware families on this device?
    context: TrojanDropper variants often install additional malicious payloads that need identification.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - "MALWARE"
            - "TROJAN"
        condition: selection
      fields:
        - rule.name
        - dst_ip

  - question: What is the persistence mechanism for this malware variant?
    context: Understanding how the malware maintains presence helps with remediation efforts.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method: "POST"
        condition: selection
      fields:
        - url.path
        - http.request.body.content

  # Type 6: Enterprise Correlation
  - question: Are other mobile devices in the network exhibiting similar malware behavior?
    context: Identifying the scope of infection helps prioritize response and containment efforts.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Android/TrojanDropper.Agent"
        condition: selection
      fields:
        - src_ip
        - dst_ip