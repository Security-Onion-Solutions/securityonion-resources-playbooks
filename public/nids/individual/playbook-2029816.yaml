name: ET MALWARE Sarwent CnC Response (cmd_exec)
id: 22029816
description: |
  Detects Sarwent malware communicating with command and control servers via cmd_exec endpoint.
  This indicates an infected system receiving and potentially executing remote commands.
  May trigger on legitimate applications using similar URI patterns, but specific path suggests malicious activity.
type: detection
detection_id: 2029816
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What commands are being sent to the infected system via the cmd_exec endpoint?
    context: Understanding the command payload reveals the attacker's intent and potential system impact.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.body.content
        - http.request.method
        - url.full

  - question: What is the complete structure of the Sarwent C2 communication?
    context: Analyzing the full communication structure helps identify malware capabilities and data exfiltration.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.request.method: "POST"
          url.path|contains: "/gate/cmd_exec"
        condition: selection
      fields:
        - http.request.body.content
        - http.request.headers

  # Type 2: Triage Assessment
  - question: Is this system known to run legitimate applications with similar communication patterns?
    context: Some legitimate software may use gate-style endpoints, but cmd_exec specifically suggests malicious intent.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains: "/gate/"
        condition: selection
      fields:
        - dst_ip
        - url.path

  - question: Does the timing of this communication align with normal user activity?
    context: Malware often communicates at regular intervals or during off-hours, unlike typical user applications.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method: "POST"
        condition: selection
      fields:
        - url.path
        - dst_ip

  # Type 3: Activity Context
  - question: What activity preceded this C2 communication?
    context: Understanding the trigger for C2 communication helps identify the infection vector or user actions.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - http.request.body.content

  - question: How did the system initially connect to the Sarwent C2 infrastructure?
    context: DNS resolution patterns reveal the C2 infrastructure and potential domain generation algorithms.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  - question: Are there signs of the initial Sarwent infection or dropper activity?
    context: Identifying the infection vector helps understand the attack timeline and potential spread.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - "MALWARE"
            - "TROJAN"
        condition: selection
      fields:
        - rule.name
        - dst_ip

  # Type 4: Impact Assessment
  - question: What commands has the C2 server instructed the malware to execute?
    context: C2 responses reveal the specific actions being performed on the compromised system.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content

  - question: Has the malware established persistence or downloaded additional payloads?
    context: Sarwent often downloads additional malware components or establishes persistence mechanisms.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 80
            - 443
            - 8080
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - protocol

  # Type 5: Forensic Deep-Dive
  - question: What other Sarwent malware components are active on this system?
    context: Sarwent is often part of a larger malware ecosystem with multiple components and capabilities.
    range: -12h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "Sarwent"
        condition: selection
      fields:
        - rule.name
        - dst_ip

  - question: Are there indicators of data exfiltration or credential theft?
    context: Sarwent variants often include information stealing capabilities targeting sensitive data.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method: "POST"
        condition: selection
      fields:
        - url.path
        - dst_ip

  - question: What is the malware's communication frequency and pattern?
    context: Understanding C2 communication patterns helps with blocking and indicates malware sophistication.
    range: -48h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains: "/gate/"
        condition: selection
      fields:
        - url.path
        - http.request.method

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network infected with Sarwent malware?
    context: Identifying the scope of infection helps prioritize containment and remediation efforts.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Sarwent"
        condition: selection
      fields:
        - src_ip
        - dst_ip

  - question: Is this part of a broader malware campaign affecting the organization?
    context: Sarwent infections often occur alongside other malware families in coordinated campaigns.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.category|contains: "MALWARE"
        condition: selection
      fields:
        - src_ip
        - rule.name