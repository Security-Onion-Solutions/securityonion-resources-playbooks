name: ET MALWARE Sarwent CnC Response (powershell_exec)
id: 22029817
description: |
  Detects Sarwent malware receiving PowerShell execution commands from command and control servers.
  This indicates an infected Windows system being instructed to execute PowerShell commands remotely.
  May trigger on legitimate remote administration tools, but specific form-data structure suggests malicious activity.
type: detection
detection_id: 2029817
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What PowerShell commands are being transmitted to the infected system?
    context: Understanding the PowerShell payload reveals the attacker's specific objectives and potential system impact.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.body.content
        - http.request.method
        - url.full

  - question: What hardware ID (hwid) is being transmitted with the PowerShell command?
    context: The hwid parameter helps identify the specific infected system and track malware instances.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.request.method: "POST"
          url.path|contains: "/gate/powershell_exec"
        condition: selection
      fields:
        - http.request.body.content
        - http.request.headers

  # Type 2: Triage Assessment
  - question: Is this system authorized for remote PowerShell administration?
    context: Legitimate remote management tools may use PowerShell, but the specific form-data structure is suspicious.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains: "powershell"
        condition: selection
      fields:
        - dst_ip
        - url.path

  - question: Does PowerShell execution align with normal administrative activities?
    context: Authorized PowerShell usage typically occurs during business hours and follows established patterns.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains: "powershell"
        condition: selection
      fields:
        - User
        - CommandLine
        - ProcessGuid

  # Type 3: Activity Context
  - question: What preceded this PowerShell execution command from the C2 server?
    context: Understanding the sequence helps identify what triggered this specific command execution.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - http.request.body.content

  - question: How did the malware establish initial contact with the C2 infrastructure?
    context: DNS resolution patterns reveal the C2 infrastructure setup and potential domain rotation.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  - question: Are there other Sarwent C2 communications from this system?
    context: Multiple C2 endpoints indicate the full scope of malware capabilities and command types.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains: "/gate/"
        condition: selection
      fields:
        - url.path
        - dst_ip

  # Type 4: Impact Assessment
  - question: Did PowerShell actually execute the received commands on the system?
    context: Process creation logs confirm whether the malware successfully executed the PowerShell commands.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains: "powershell"
        condition: selection
      fields:
        - CommandLine
        - ProcessGuid
        - User

  - question: What was the C2 server's response to the PowerShell execution request?
    context: C2 responses indicate command success and may contain additional instructions or payloads.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content

  # Type 5: Forensic Deep-Dive
  - question: What specific PowerShell modules or cmdlets are being utilized?
    context: Understanding PowerShell usage patterns reveals the malware's capabilities and attacker techniques.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains: "powershell"
        condition: selection
      fields:
        - CommandLine
        - ProcessGuid

  - question: Are there signs of PowerShell-based persistence or credential theft?
    context: Sarwent often uses PowerShell for advanced techniques like credential harvesting and persistence.
    range: +6h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          CommandLine|contains:
            - "Invoke-"
            - "DownloadString"
            - "EncodedCommand"
        condition: selection
      fields:
        - CommandLine
        - User
        - ProcessGuid

  - question: What files were created or modified following PowerShell execution?
    context: File system changes reveal the impact of PowerShell commands and potential payload deployment.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.mime_type

  # Type 6: Enterprise Correlation
  - question: Are other systems receiving similar PowerShell execution commands?
    context: Coordinated PowerShell execution across multiple systems indicates campaign scope and priorities.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "powershell_exec"
        condition: selection
      fields:
        - src_ip
        - dst_ip

  - question: Is this PowerShell activity part of a broader Sarwent infection campaign?
    context: Understanding the relationship between different Sarwent components helps assess total campaign impact.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: "Sarwent"
        condition: selection
      fields:
        - src_ip
        - rule.name