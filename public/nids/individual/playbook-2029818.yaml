name: ET MALWARE Sarwent CnC Response (rdp_exec)
id: 22029818
description: |
  Detects Sarwent malware command and control communication for RDP execution commands.
  This indicates an infected system receiving remote desktop execution instructions from attackers.
  No legitimate use cases exist for this specific URI pattern.
type: detection
detection_id: 2029818
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete RDP execution command sent by the C2 server?
    context: The command parameter reveals the specific RDP instructions being executed on the compromised system.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - url.query
        - http.request.body.content

  - question: What status information was being reported back to the C2 server?
    context: The status parameter indicates execution results and system state information.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.query
        - http.response.status_code
        - http.response.body.content

  # Type 2: Triage Assessment
  - question: Is this system known to be infected with Sarwent malware?
    context: Previous Sarwent indicators help confirm this is ongoing malware activity rather than false positive.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "Sarwent"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - url.path

  # Type 3: Activity Context
  - question: What other C2 communication occurred around the same time?
    context: Sarwent typically uses multiple C2 endpoints and commands in sequence.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains: "/gate/"
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.response.status_code

  - question: What processes were running when this C2 communication occurred?
    context: Identifying the malware process helps understand infection vector and persistence.
    range: +/-5m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  # Type 4: Impact Assessment
  - question: Were any RDP connections established following this command?
    context: Successful RDP execution would result in network connections to remote systems.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 3389
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection.state
        - network.bytes_sent

  - question: What files were accessed or modified after the RDP command?
    context: RDP execution may result in file operations indicating successful compromise.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size
        - User

  # Type 5: Forensic Deep-Dive
  - question: What is the complete communication pattern with this C2 server?
    context: Full C2 communication reveals malware capabilities and attacker intentions.
    range: -1d
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.response.status_code
        - network.bytes_sent
        - network.bytes_received

  - question: Are there signs of credential harvesting or lateral movement?
    context: Sarwent often performs credential theft and attempts to spread to other systems.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - "net.exe"
            - "whoami.exe"
            - "ipconfig.exe"
            - "systeminfo.exe"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  # Type 6: Enterprise Correlation
  - question: Are other systems communicating with this C2 server?
    context: Sarwent infections often spread across multiple systems in the network.
    range: +/-1d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - connection.state

  - question: What other Sarwent-related indicators appear across the enterprise?
    context: Coordinated Sarwent campaign analysis helps understand scope and impact.
    range: +/-7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Sarwent"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - url.path