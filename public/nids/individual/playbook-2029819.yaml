name: ET MALWARE Sarwent CnC Response (update_exec)
id: 22029819
description: |
  Detects Sarwent malware command and control communication for update execution commands.
  This indicates an infected system receiving malware update instructions from attackers.
  No legitimate use cases exist for this specific URI pattern.
type: detection
detection_id: 2029819
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete update execution command sent by the C2 server?
    context: The command parameter reveals the specific update instructions being executed on the compromised system.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - url.query
        - http.request.body.content

  - question: What status information was being reported back during the update process?
    context: The status parameter indicates update execution results and potential errors.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.query
        - http.response.status_code
        - http.response.body.content

  # Type 2: Triage Assessment
  - question: Is this system showing other Sarwent malware indicators?
    context: Previous Sarwent activity confirms this is ongoing malware communication rather than false positive.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "Sarwent"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - url.path

  # Type 3: Activity Context
  - question: What other C2 gate endpoints were accessed around this time?
    context: Sarwent typically uses multiple gate endpoints for different malware functions.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains: "/gate/"
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.response.status_code

  - question: What processes were executing during this update communication?
    context: Identifying the malware process helps understand update mechanism and persistence.
    range: +/-5m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  # Type 4: Impact Assessment
  - question: Were any new files downloaded or created after the update command?
    context: Successful malware updates typically result in new file creation or modification.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size
        - User

  - question: Did the update command result in new network connections?
    context: Malware updates may establish new C2 channels or download additional payloads.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection.state
        - network.bytes_received

  # Type 5: Forensic Deep-Dive
  - question: What is the complete sequence of Sarwent update activities?
    context: Full update sequence reveals malware evolution and new capabilities.
    range: -1d
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains: "update_exec"
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.response.status_code
        - network.bytes_sent
        - network.bytes_received

  - question: Are there signs of new malware capabilities after the update?
    context: Updated malware may exhibit new behaviors or attack techniques.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  # Type 6: Enterprise Correlation
  - question: Are other systems receiving similar update commands?
    context: Coordinated malware updates across multiple systems indicate campaign scope.
    range: +/-1d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains: "update_exec"
        condition: selection
      fields:
        - src_ip
        - url.query
        - http.response.status_code

  - question: What is the enterprise-wide impact of this Sarwent campaign?
    context: Understanding campaign scope helps prioritize remediation efforts.
    range: +/-7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Sarwent"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - url.path