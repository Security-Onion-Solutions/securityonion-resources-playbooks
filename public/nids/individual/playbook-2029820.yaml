name: ET MALWARE Sarwent CnC Response (download_exec)
id: 22029820
description: |
  Detects Sarwent malware command and control communication for download execution commands.
  This indicates an infected system receiving instructions to download and execute additional payloads.
  No legitimate use cases exist for this specific URI pattern.
type: detection
detection_id: 2029820
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete download execution command sent by the C2 server?
    context: The command parameter reveals the specific download and execution instructions for additional payloads.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - url.query
        - http.request.body.content

  - question: What status information was reported back regarding the download execution?
    context: The status parameter indicates download success and execution results.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.query
        - http.response.status_code
        - http.response.body.content

  # Type 2: Triage Assessment
  - question: Is this system showing consistent Sarwent malware behavior?
    context: Previous Sarwent indicators confirm this is ongoing malware activity rather than false positive.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "Sarwent"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - url.path

  # Type 3: Activity Context
  - question: What other Sarwent C2 commands were executed in sequence?
    context: Sarwent typically uses multiple gate endpoints in coordinated attack sequences.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains: "/gate/"
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.response.status_code

  - question: What processes were active during this download execution command?
    context: Identifying the malware process helps understand payload delivery mechanism.
    range: +/-5m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  # Type 4: Impact Assessment
  - question: Were any files downloaded following this command?
    context: Successful download execution results in new malicious files being created on the system.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size
        - User

  - question: Did the download command result in additional network connections?
    context: Download execution may establish connections to download servers or new C2 infrastructure.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection.state
        - network.bytes_received

  - question: Were any new processes executed after the download command?
    context: Successful payload download and execution results in new malicious processes.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  # Type 5: Forensic Deep-Dive
  - question: What is the complete download and execution sequence?
    context: Full payload delivery sequence reveals attack progression and malware capabilities.
    range: -1d
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains: "download_exec"
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.response.status_code
        - network.bytes_sent
        - network.bytes_received

  - question: What additional malware capabilities were deployed?
    context: Downloaded payloads may introduce new attack techniques and persistence mechanisms.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  # Type 6: Enterprise Correlation
  - question: Are other systems receiving similar download execution commands?
    context: Coordinated payload distribution across multiple systems indicates campaign scope.
    range: +/-1d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains: "download_exec"
        condition: selection
      fields:
        - src_ip
        - url.query
        - http.response.status_code

  - question: What is the enterprise-wide impact of this Sarwent payload campaign?
    context: Understanding campaign scope helps prioritize incident response and containment efforts.
    range: +/-7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Sarwent"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - url.path