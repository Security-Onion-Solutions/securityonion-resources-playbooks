name: ET MALWARE Sorano Stealer CnC Checkin
id: 22029838
description: |
  Detects Sorano Stealer malware command and control checkin communication.
  This indicates an infected system reporting system information and stolen data to attackers.
  No legitimate use cases exist for this specific parameter pattern.
type: detection
detection_id: 2029838
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What system information was being exfiltrated in the checkin?
    context: The POST parameters reveal specific system details and potentially stolen data being transmitted.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - url.query
        - http.request.body.content

  - question: What hardware and system identifiers were collected?
    context: The hwid parameter contains unique system identifiers used for victim tracking.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.query
        - http.request.body.content

  # Type 2: Triage Assessment
  - question: Is this system showing other information stealer indicators?
    context: Previous stealer activity confirms this is ongoing data theft rather than false positive.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "Stealer"
            - "Sorano"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - url.path

  # Type 3: Activity Context
  - question: What processes were running when this data exfiltration occurred?
    context: Identifying the stealer process helps understand infection vector and data collection methods.
    range: +/-5m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: What files were accessed before this checkin communication?
    context: Stealer malware typically accesses browser profiles, cryptocurrency wallets, and credential stores.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - "Login Data"
            - "Cookies"
            - "wallet.dat"
            - "keystore"
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - User

  # Type 4: Impact Assessment
  - question: How much data was transmitted to the C2 server?
    context: Data volume indicates the scope of information theft and exfiltration.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - network.bytes_sent
        - network.bytes_received
        - connection.state

  - question: Were browser credential stores compromised?
    context: Stealer malware commonly targets browser saved passwords and authentication tokens.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - "Chrome"
            - "Firefox"
            - "Edge"
            - "Login Data"
            - "logins.json"
        condition: selection
      fields:
        - TargetFilename
        - file.size
        - User

  - question: Were cryptocurrency wallets accessed?
    context: Sorano Stealer specifically targets cryptocurrency wallet files for theft.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - "wallet.dat"
            - "Electrum"
            - "Exodus"
            - "keystore"
            - "MetaMask"
        condition: selection
      fields:
        - TargetFilename
        - file.size
        - User

  # Type 5: Forensic Deep-Dive
  - question: What is the complete pattern of C2 communication?
    context: Full C2 communication reveals stealer capabilities and data theft timeline.
    range: -1d
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.query|contains: "hwid="
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.response.status_code
        - network.bytes_sent

  - question: What system reconnaissance was performed?
    context: Stealer malware often performs system enumeration to collect valuable information.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - "systeminfo.exe"
            - "whoami.exe"
            - "ipconfig.exe"
            - "wmic.exe"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  # Type 6: Enterprise Correlation
  - question: Are other systems communicating with this Sorano C2 server?
    context: Coordinated stealer infections across multiple systems indicate campaign scope.
    range: +/-1d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - connection.state

  - question: What is the enterprise-wide impact of this stealer campaign?
    context: Understanding campaign scope helps assess data breach impact and prioritize response.
    range: +/-7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "Stealer"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - url.path