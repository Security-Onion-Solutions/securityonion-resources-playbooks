name: ET HUNTING Suspicious Zipped Filename in Outbound POST Request (CookiesList.txt)
id: 22029845
description: |
  Detects outbound POST requests containing zipped files with suspicious filenames like "CookiesList.txt".
  This pattern strongly suggests credential theft or browser data exfiltration attempts.
  Legitimate applications rarely transmit cookie data in this format to external services.
type: detection
detection_id: 2029845
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete POST request structure and destination for the cookie data transmission?
    context: Understanding the full request reveals the data structure and receiving infrastructure for stolen credentials.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.body.content
        - url.full
        - http.request.method
        - http.request.headers

  - question: What specific cookie data was contained within the CookiesList.txt file?
    context: Cookie content analysis reveals which websites and authentication tokens were compromised.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.request.body.content
        - http.request.body.bytes

  # Type 2: Triage Assessment
  - question: Is there any legitimate business justification for transmitting browser cookie data externally?
    context: Cookie transmission to external services is almost never legitimate and indicates credential theft.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method: POST
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - http.request.body.content

  - question: Does this activity correlate with any authorized security testing or penetration testing?
    context: Security assessments may involve cookie collection, but should be documented and authorized.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - timestamp
        - dst_ip
        - url.domain

  # Type 3: Activity Context
  - question: What malicious process or tool was responsible for collecting and transmitting the cookie data?
    context: Identifying the source process helps determine the attack vector and malware family involved.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: What browser or credential theft activities preceded this transmission?
    context: Browser data access events reveal how the cookies were harvested before transmission.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - cookies
            - Cookie
            - Login Data
            - Web Data
        condition: selection
      fields:
        - TargetFilename
        - Image
        - ProcessGuid

  # Type 4: Impact Assessment
  - question: How many authentication tokens and session cookies were potentially compromised?
    context: The volume and types of cookies determine the scope of account compromise and unauthorized access risk.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method: POST
        condition: selection
      fields:
        - dst_ip
        - http.request.body.bytes
        - url.domain

  - question: Did the credential theft operation complete successfully based on server responses?
    context: HTTP response analysis indicates whether the stolen credentials were successfully received by attackers.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - http.response.body.bytes

  # Type 5: Forensic Deep-Dive
  - question: Which specific websites and services had their authentication tokens compromised?
    context: Identifying compromised services helps prioritize incident response and user notification efforts.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.body.content
        - alert.metadata

  - question: What information stealer malware family was responsible for this cookie theft?
    context: Malware identification helps understand capabilities, persistence mechanisms, and additional compromise indicators.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - CookiesList.txt
            - cookies
        condition: selection
      fields:
        - TargetFilename
        - Image
        - ProcessGuid
        - file.hash.md5

  - question: Are there signs of unauthorized account access using the stolen authentication tokens?
    context: Subsequent malicious activity using stolen cookies indicates successful credential abuse.
    range: +24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - http.request.headers

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network showing similar cookie theft and exfiltration patterns?
    context: Multiple infected systems indicate a broader information stealer campaign requiring coordinated response.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          http.request.method: POST
        condition: selection
      fields:
        - src_ip
        - url.domain
        - http.request.body.content

  - question: Is this credential theft destination part of a larger malicious infrastructure observed enterprise-wide?
    context: The receiving server may be collecting credentials from multiple victims across the organization.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - rule.name
        - src_ip
        - rule.category