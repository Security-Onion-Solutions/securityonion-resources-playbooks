name: ET MALWARE MSIL/Agent.TRM Checkin Response
id: 22029853
description: |
  Detects MSIL/Agent.TRM malware command and control checkin response with distinctive cookie pattern.
  This indicates a C2 server responding to infected systems with session management cookies.
  No legitimate use cases exist for this specific cookie pattern and HTTP status combination.
type: detection
detection_id: 2029853
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact cookie value set by the C2 server?
    context: The dkv cookie contains a unique session identifier used for tracking infected systems.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.headers.set-cookie
        - http.response.body.content

  - question: What was the complete HTTP response from the C2 server?
    context: The full response reveals C2 server configuration and potential commands.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.headers
        - http.response.body.content

  # Type 2: Triage Assessment
  - question: Is this system showing other MSIL/Agent.TRM malware indicators?
    context: Previous Agent.TRM activity confirms this is ongoing malware communication rather than false positive.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - "Agent.TRM"
            - "MSIL"
        condition: selection
      fields:
        - rule.name
        - src_ip
        - url.path

  # Type 3: Activity Context
  - question: What was the initial request that triggered this C2 response?
    context: The original request reveals malware checkin behavior and system information being transmitted.
    range: -5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - http.request.body.content
        - http.request.headers

  - question: What processes were running when this C2 communication occurred?
    context: Identifying the malware process helps understand infection vector and persistence mechanisms.
    range: +/-5m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  # Type 4: Impact Assessment
  - question: What follow-up communication occurred after this checkin response?
    context: Successful C2 checkin typically results in command delivery or data exfiltration.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - http.request.headers.cookie
        - network.bytes_sent

  - question: Were any files created or modified after this C2 response?
    context: C2 responses may trigger payload downloads or configuration updates.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size
        - User

  # Type 5: Forensic Deep-Dive
  - question: What is the complete C2 communication session pattern?
    context: Full session analysis reveals malware capabilities and command sequences.
    range: -1d
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - http.request.method
        - url.full
        - http.response.status_code
        - http.request.headers.cookie
        - network.bytes_sent
        - network.bytes_received

  - question: What malware persistence mechanisms are in place?
    context: Agent.TRM typically establishes persistence through registry modifications or scheduled tasks.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetObject|contains:
            - "Run"
            - "RunOnce"
            - "Services"
        condition: selection
      fields:
        - TargetObject
        - Details
        - User

  - question: What system information was collected by the malware?
    context: Agent.TRM performs system reconnaissance to gather valuable information for attackers.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - "systeminfo.exe"
            - "whoami.exe"
            - "net.exe"
            - "wmic.exe"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  # Type 6: Enterprise Correlation
  - question: Are other systems communicating with this Agent.TRM C2 server?
    context: Coordinated malware infections across multiple systems indicate campaign scope.
    range: +/-1d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - connection.state

  - question: What is the enterprise-wide impact of this Agent.TRM campaign?
    context: Understanding campaign scope helps prioritize incident response and containment efforts.
    range: +/-7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - "Agent.TRM"
            - "MSIL"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - url.path