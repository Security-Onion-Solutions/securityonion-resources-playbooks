name: ET PHISHING OneDrive Phishing Landing 2020-04-10
id: 22029858
description: |
  Detects phishing pages impersonating OneDrive file viewer to steal credentials.
  These pages use obfuscated JavaScript and POST forms to capture user login information.
  Legitimate OneDrive pages use different title formats and official Microsoft domains.
type: detection
detection_id: 2029858
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete obfuscated JavaScript payload and credential harvesting form structure?
    context: Analyzing the deobfuscated code reveals the exact phishing techniques and data collection methods used.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.response.body.content
        - url.full
        - http.response.headers

  - question: What specific credential fields and personal information was this phishing page designed to capture?
    context: Understanding targeted data helps assess the scope of potential credential compromise and identity theft.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.body.content
        - url.domain

  # Type 2: Triage Assessment
  - question: Did the user submit credentials or personal information to this phishing page?
    context: Credential submission indicates successful phishing and requires immediate password reset and account monitoring.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.request.method: POST
        condition: selection
      fields:
        - http.request.body.content
        - url.full
        - http.request.headers

  - question: Was this phishing page accessed through legitimate email links or suspicious redirects?
    context: Access vector analysis helps determine if this was a targeted spear-phishing attack or opportunistic campaign.
    range: -10m
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.domain
        - http.request.referrer
        - http.request.headers

  # Type 3: Activity Context
  - question: What email or communication triggered the user to visit this phishing site?
    context: Understanding the initial attack vector helps identify the phishing campaign source and other potential victims.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.domain
        - http.request.referrer
        - timestamp

  - question: What browser session and user context was involved in this phishing attempt?
    context: User and session identification helps assess the potential impact and scope of credential compromise.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - chrome.exe
            - firefox.exe
            - msedge.exe
            - iexplore.exe
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  # Type 4: Impact Assessment
  - question: Were legitimate OneDrive or Microsoft accounts accessed using potentially compromised credentials?
    context: Subsequent legitimate service access indicates successful credential theft and unauthorized account usage.
    range: +24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.domain|contains:
            - onedrive.com
            - outlook.com
            - login.microsoftonline.com
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.response.status_code

  - question: Did the phishing operation successfully collect and transmit the stolen credentials?
    context: Successful data transmission to attackers confirms credential compromise and requires immediate response actions.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - http.response.body.bytes

  # Type 5: Forensic Deep-Dive
  - question: What specific Microsoft services and data access was this phishing campaign targeting?
    context: Understanding targeted services helps prioritize account security measures and data protection efforts.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.response.body.content
        - alert.metadata

  - question: Are there signs of follow-up malicious activity using the potentially compromised OneDrive account?
    context: Account abuse following credential theft may include data exfiltration, malware distribution, or lateral movement.
    range: +48h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.domain|contains:
            - onedrive
            - sharepoint
            - office365
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.request.body.bytes

  - question: What obfuscation techniques were used to evade detection in the phishing page JavaScript?
    context: Understanding evasion methods helps improve detection capabilities and threat intelligence sharing.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.body.content
        - url.full

  # Type 6: Enterprise Correlation
  - question: Are other users in the organization being targeted by similar OneDrive phishing campaigns?
    context: Multiple phishing attempts indicate a coordinated campaign targeting the organization's Microsoft 365 environment.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "OneDrive Phishing"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - url.domain

  - question: Is this phishing infrastructure part of a broader credential harvesting operation observed enterprise-wide?
    context: The phishing site may be one component of a larger campaign targeting multiple cloud services and applications.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - rule.name
        - src_ip
        - rule.category