name: ET WEB_SERVER WSO 2.6 Webshell Accessed on Internal Compromised Server
id: 22029860
description: |
  Detects access to WSO 2.6 webshell from internal compromised server to external network.
  Indicates successful webshell deployment and active command execution by attacker.
  No legitimate scenarios exist for this specific webshell interface.
type: detection
detection_id: 2029860
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What is the complete HTTP response containing the WSO 2.6 webshell interface?
    context: The full response reveals webshell capabilities and configuration details.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.response.body.content
        - http.response.status_code
        - url.full
        - http.request.method

  - question: What specific webshell functionality is being accessed in this session?
    context: Understanding the accessed features reveals attacker intent and capabilities.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - http.request.body.content
        - url.path
        - http.request.method

  # Type 2: Triage Assessment
  - question: Is this web server normally accessed by external clients?
    context: Determines if outbound connections from web server are anomalous.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out

  # Type 3: Activity Context
  - question: What was the initial compromise vector that led to this webshell deployment?
    context: Identifies the attack chain that resulted in webshell installation.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - dst_ip
        - dst_port

  - question: What commands or file operations preceded this webshell access?
    context: Reveals preparation activities and potential privilege escalation.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: What network connections were established during this webshell session?
    context: Identifies command and control channels and lateral movement attempts.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_in
        - bytes_out

  # Type 4: Impact Assessment
  - question: What sensitive files or directories were accessed through the webshell?
    context: Assesses data exposure and determines breach scope.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - User

  - question: Has the webshell been used to establish persistence mechanisms?
    context: Identifies additional backdoors or scheduled tasks for persistence.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetObject
        - Details
        - User

  # Type 5: Forensic Deep-Dive
  - question: What is the complete webshell file structure and associated artifacts?
    context: Provides forensic evidence of webshell deployment and modifications.
    range: -6h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - '.php'
            - '.asp'
            - '.jsp'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size
        - User

  - question: What authentication mechanisms were bypassed to access the webshell?
    context: Reveals compromise method and potential credential theft.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
          http.request.method: 'POST'
        condition: selection
      fields:
        - src_ip
        - http.request.headers
        - url.path

  # Type 6: Enterprise Correlation
  - question: Are other internal systems showing similar webshell activity?
    context: Identifies the scope of compromise across the enterprise.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'webshell'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: What related indicators of compromise appear across the network?
    context: Correlates this incident with broader attack campaign indicators.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - bytes_out