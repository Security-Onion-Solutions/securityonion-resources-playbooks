name: ET WEB_SERVER WSO 2.5 Webshell Accessed on Internal Compromised Server
id: 22029862
description: |
  Detects access to WSO 2.5 webshell from internal compromised server to external network.
  Indicates successful webshell deployment and active command execution by attacker.
  No legitimate scenarios exist for this specific webshell interface.
type: detection
detection_id: 2029862
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What is the complete HTTP response containing the WSO 2.5 webshell interface?
    context: The full response reveals webshell capabilities and version-specific features.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.response.body.content
        - http.response.status_code
        - url.full
        - http.request.method

  - question: What specific webshell commands or modules are being executed?
    context: Understanding the accessed functionality reveals attacker objectives and capabilities.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - http.request.body.content
        - url.path
        - http.request.method

  # Type 2: Triage Assessment
  - question: Is this web server normally configured for outbound connections?
    context: Determines if external communication from web server is anomalous behavior.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out

  - question: Are there any legitimate administrative tools that could generate similar traffic?
    context: Eliminates false positives from authorized remote administration tools.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'iexplore.exe'
            - 'chrome.exe'
            - 'firefox.exe'
        condition: selection
      fields:
        - User
        - CommandLine
        - ProcessGuid

  # Type 3: Activity Context
  - question: What was the initial attack vector that led to webshell installation?
    context: Identifies the compromise method and entry point for the attack.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - dst_ip
        - dst_port

  - question: What file operations preceded this webshell access?
    context: Reveals webshell installation and configuration activities.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - '.php'
            - '.asp'
            - '.jsp'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - User

  - question: What network connections were established during this webshell session?
    context: Identifies command and control channels and potential data exfiltration.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_in
        - bytes_out

  # Type 4: Impact Assessment
  - question: What sensitive data or system files were accessed through the webshell?
    context: Assesses data breach scope and system compromise extent.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - User

  - question: Has the webshell been used to establish additional persistence mechanisms?
    context: Identifies backdoors and scheduled tasks for maintaining access.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetObject
        - Details
        - User

  # Type 5: Forensic Deep-Dive
  - question: What is the complete webshell file structure and associated components?
    context: Provides forensic evidence of webshell deployment and modifications.
    range: -6h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - 'wso'
            - 'shell'
            - 'backdoor'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size
        - User

  - question: What authentication bypass techniques were used to access the webshell?
    context: Reveals compromise method and potential credential theft indicators.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
          http.request.method: 'POST'
        condition: selection
      fields:
        - src_ip
        - http.request.headers
        - url.path

  # Type 6: Enterprise Correlation
  - question: Are other internal servers showing similar webshell compromise indicators?
    context: Identifies the scope of compromise across the server infrastructure.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'webshell'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: What related attack indicators appear across the enterprise network?
    context: Correlates this incident with broader attack campaign patterns.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - bytes_out