name: ET WEB_CLIENT WSO 4.2.5 Webshell Accessed on External Compromised Server
id: 22029867
description: |
  Detects access to WSO 4.2.5 webshell hosted on external compromised servers.
  This indicates potential communication with attacker-controlled infrastructure.
  Legitimate scenarios are extremely rare as WSO is a known malicious webshell.
type: detection
detection_id: 2029867
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete HTTP response containing the WSO 4.2.5 webshell interface?
    context: Analyzing the full response reveals webshell capabilities and configuration.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.response.body.content
        - http.response.status_code
        - url.full
        - http.request.method

  - question: Is this connection part of authorized security testing or research?
    context: Legitimate access to webshells only occurs during authorized penetration testing.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_sent
        - bytes_received

  - question: What triggered the user to access this external webshell?
    context: Understanding the initial vector helps determine if this is targeted or opportunistic.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.request.referrer
        - user_agent.original

  - question: What commands or files were accessed through the webshell interface?
    context: Webshell interactions reveal attacker objectives and compromise scope.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - http.request.body.content
        - url.query
        - http.request.method

  - question: Has the client system been compromised or is this legitimate research?
    context: Determining if the source system shows signs of compromise or authorized testing.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - user.name

  - question: What data was potentially exfiltrated through the webshell connection?
    context: Analyzing traffic patterns helps assess data theft and impact.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - bytes_sent
        - bytes_received
        - duration
        - dst_port

  - question: What is the reputation and hosting details of the external webshell server?
    context: Understanding the threat infrastructure helps with attribution and blocking.
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          dns.resolved_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name

  - question: Are there signs of lateral movement from the affected client system?
    context: Webshell access often precedes internal network reconnaissance and movement.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_sent
        - bytes_received

  - question: What authentication or session management was used for webshell access?
    context: Understanding access methods reveals persistence and privilege escalation.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - http.request.headers
        - http.response.headers
        - http.request.cookies

  - question: Are other systems in the organization accessing similar webshell infrastructure?
    context: Identifying campaign scope and other potentially compromised systems.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - bytes_sent
        - bytes_received

  - question: What related malicious domains or IPs are associated with this webshell server?
    context: Expanding IOCs helps identify broader threat infrastructure and campaigns.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - src_ip