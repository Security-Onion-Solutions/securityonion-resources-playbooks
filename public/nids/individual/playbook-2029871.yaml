name: ET WEB_CLIENT Kageyama Webshell Accessed on External Compromised Server
id: 22029871
description: |
  Detects access to Kageyama webshell hosted on external compromised servers.
  This indicates potential communication with attacker-controlled infrastructure.
  Legitimate scenarios are extremely rare as Kageyama is a known malicious webshell.
type: detection
detection_id: 2029871
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete HTTP response containing the Kageyama webshell interface?
    context: Analyzing the full response reveals webshell capabilities and distinctive features.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.response.body.content
        - http.response.status_code
        - url.full
        - http.request.method

  - question: Is this connection part of authorized security testing or malware analysis?
    context: Legitimate access to webshells only occurs during authorized security research or testing.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_sent
        - bytes_received

  - question: What was the initial discovery method for this external Kageyama webshell?
    context: Understanding how users found the webshell helps determine attack progression.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.request.referrer
        - user_agent.original

  - question: What operations or commands were executed through the Kageyama webshell?
    context: Webshell interactions reveal attacker objectives and operational capabilities.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - http.request.body.content
        - url.query
        - http.request.method

  - question: Has the client system exhibited signs of compromise or malicious behavior?
    context: Determining if the source system is compromised or conducting legitimate research.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - user.name

  - question: What data was potentially accessed or downloaded through the webshell?
    context: Analyzing traffic patterns helps assess data theft and operational impact.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - bytes_sent
        - bytes_received
        - duration
        - dst_port

  - question: What is the hosting infrastructure and reputation of the Kageyama webshell server?
    context: Understanding threat infrastructure helps with attribution and blocking strategies.
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          dns.resolved_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name

  - question: Are there indicators of lateral movement from the affected client system?
    context: Webshell access often precedes internal network reconnaissance and compromise.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_sent
        - bytes_received

  - question: What authentication or access control was used for the Kageyama webshell?
    context: Understanding access methods reveals persistence mechanisms and security bypasses.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - http.request.headers
        - http.response.headers
        - http.request.cookies

  - question: Are other systems in the organization accessing similar webshell infrastructure?
    context: Identifying campaign scope and other potentially compromised systems.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - bytes_sent
        - bytes_received

  - question: What related malicious infrastructure is associated with this Kageyama webshell?
    context: Expanding IOCs helps identify broader threat infrastructure and related campaigns.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - src_ip