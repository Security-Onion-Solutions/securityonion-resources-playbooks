name: ET WEB_CLIENT Generic WSO Webshell Accessed on External Compromised Server
id: 22029873
description: |
  Detects internal clients accessing WSO webshells on external compromised servers.
  This indicates either internal compromise leading to external webshell access or
  legitimate security research. WSO webshells provide comprehensive system management capabilities.
type: detection
detection_id: 2029873
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What is the complete WSO webshell interface being accessed?
    context: The full response reveals webshell capabilities and current system information displayed.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.response.body.content
        - http.response.status_code
        - url.full

  - question: What specific WSO webshell functions are being utilized?
    context: Different URL paths and parameters reveal which webshell capabilities are being exploited.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - url.query
        - http.request.method
        - http.request.body.content

  - question: Is this access part of authorized security testing or research?
    context: Legitimate access would be documented and from authorized security personnel.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - url.domain
        - http.request.method

  - question: How did the internal client discover this external webshell?
    context: Prior activity may reveal reconnaissance, malware communication, or threat intelligence gathering.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.response.status_code
        - http.request.headers

  - question: What system information is the webshell revealing about the compromised server?
    context: Webshell responses contain valuable intelligence about the compromised external system.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.body.content
        - http.response.headers
        - url.full

  - question: Is the internal client compromised and being used for malicious purposes?
    context: Compromised internal systems may be used to access external webshells for cybercriminal activities.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ParentImage

  - question: What files or data are being transferred through the webshell?
    context: File operations reveal potential data theft, malware distribution, or system modification.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - network.bytes
        - network.packets
        - dst_port

  - question: Are there signs of malware communication or command and control activity?
    context: Webshell access may be part of broader malware infrastructure or botnet activity.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.protocol
        - network.bytes

  - question: What commands are being executed on the external compromised server?
    context: Command execution reveals attacker intentions and potential impact on the compromised system.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - http.request.body.content
        - url.query
        - http.response.body.content

  - question: Are other internal clients accessing external webshells?
    context: Multiple internal clients accessing webshells may indicate widespread compromise or coordinated attack.
    range: -1d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'WSO'
            - 'webshell'
            - 'WEB_CLIENT'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: What is the broader pattern of external webshell access across the organization?
    context: Enterprise-wide webshell access patterns reveal campaign scope and threat actor capabilities.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.category|contains:
            - 'web-application-attack'
            - 'trojan-activity'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - rule.severity