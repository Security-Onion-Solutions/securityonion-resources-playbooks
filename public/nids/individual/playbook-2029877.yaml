name: ET PHISHING OneDrive Phishing Landing 2020-04-10
id: 22029877
description: |
  Detects OneDrive-themed phishing pages attempting to steal credentials by mimicking SharePoint Online.
  May trigger on legitimate SharePoint sites with similar content patterns, though the specific combination of elements is typically malicious.
type: detection
detection_id: 2029877
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete phishing page content and URL structure?
    context: Analyzing the full page content reveals the phishing template and target service being impersonated.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.body.content
        - http.response.body.content
        - url.full
        - url.domain
        - url.path

  - question: What specific SharePoint/OneDrive elements are being spoofed?
    context: Understanding the impersonation techniques helps identify the phishing kit and potential victims.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.body.content
        - http.request.headers
        - http.response.headers

  # Type 2: Triage Assessment
  - question: Is this a legitimate SharePoint or OneDrive service?
    context: Verifying if the destination is an official Microsoft service helps eliminate false positives.
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          dns.resolved_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.response.data
        - dns.query.type_name

  - question: Has this user accessed legitimate OneDrive recently?
    context: Comparing with normal OneDrive usage patterns helps assess if the user is a likely target.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.domain|contains:
            - 'onedrive.live.com'
            - 'sharepoint.com'
            - 'office365.com'
        condition: selection
      fields:
        - url.domain
        - http.request.method

  # Type 3: Activity Context
  - question: What email or link led the user to this phishing site?
    context: Identifying the delivery mechanism reveals the initial attack vector and campaign scope.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - http.request.headers.referer
        - url.full
        - http.request.headers.user_agent

  - question: What other web activity occurred around the same time?
    context: Understanding the browsing session context helps determine if this was targeted or opportunistic.
    range: -30m/+30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.domain
        - http.request.method
        - http.response.status_code

  # Type 4: Impact Assessment
  - question: Did the user submit credentials to the phishing site?
    context: Determining if credentials were compromised is critical for incident response prioritization.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.request.method: 'POST'
        condition: selection
      fields:
        - http.request.body.content
        - url.path
        - http.response.status_code

  - question: What data was transmitted to the phishing server?
    context: Understanding what information was stolen helps assess the breach impact.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - network.bytes_sent
        - network.bytes_received
        - network.protocol

  # Type 5: Forensic Deep-Dive
  - question: What phishing kit or template is being used?
    context: Identifying the phishing framework helps link to known threat actors and campaigns.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - http.response.body.content
        - http.response.headers.server
        - url.path

  - question: Are there any embedded tracking or harvesting mechanisms?
    context: Advanced phishing sites may include additional malicious functionality beyond credential theft.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - http.response.body.content
        - http.request.headers
        - url.query

  # Type 6: Enterprise Correlation
  - question: Are other users in the organization accessing this phishing site?
    context: Identifying additional victims helps determine the campaign scope and prioritize response efforts.
    range: -24h/+24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - http.request.method
        - url.path

  - question: What other phishing domains are hosted on the same infrastructure?
    context: Mapping related phishing infrastructure helps identify the broader threat campaign.
    range: -7d/+7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - network.transport