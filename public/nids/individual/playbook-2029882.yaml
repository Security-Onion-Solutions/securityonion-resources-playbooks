name: ET WEB_CLIENT Generic WSO Webshell Password Prompt Accessed on External Compromised Server
id: 22029882
description: |
  Detects access to WSO webshell password prompts on external servers, indicating compromised web infrastructure.
  May trigger on legitimate admin panels with similar form structures, but the specific WSO pattern is typically malicious.
type: detection
detection_id: 2029882
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete webshell interface and form structure?
    context: Analyzing the full webshell interface reveals the specific variant and capabilities available to attackers.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.response.body.content
        - url.full
        - url.path
        - http.response.headers

  - question: What specific WSO webshell variant is being accessed?
    context: Identifying the webshell type helps understand attacker capabilities and potential system compromise level.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.body.content
        - http.response.headers.server
        - url.query

  # Type 2: Triage Assessment
  - question: Is this access from an authorized administrator or security team?
    context: Determining if this is legitimate security testing or unauthorized access is critical for response.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.domain
        - http.request.headers.user_agent
        - http.request.method

  - question: Is this part of documented penetration testing or security assessment?
    context: Verifying if this is authorized security testing helps eliminate false positives from legitimate activities.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.transport

  # Type 3: Activity Context
  - question: How did the user discover this webshell location?
    context: Understanding the discovery method reveals whether this was targeted reconnaissance or opportunistic scanning.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.request.method
        - http.response.status_code

  - question: What other web reconnaissance activity preceded this access?
    context: Identifying scanning or enumeration patterns helps understand the attack methodology.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - url.path
        - http.response.status_code

  # Type 4: Impact Assessment
  - question: Did the user successfully authenticate to the webshell?
    context: Determining if the attacker gained webshell access is critical for assessing compromise severity.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.request.method: 'POST'
        condition: selection
      fields:
        - http.request.body.content
        - http.response.status_code
        - url.path

  - question: What commands or operations were executed through the webshell?
    context: Understanding webshell usage reveals the extent of system compromise and attacker objectives.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - http.request.body.content
        - http.response.body.content
        - url.query

  # Type 5: Forensic Deep-Dive
  - question: What is the hosting infrastructure behind this compromised server?
    context: Analyzing the server infrastructure helps identify the compromise vector and potential other victims.
    query: |
      aggregation: false
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - tls.server.certificate.subject
        - tls.server.certificate.issuer
        - tls.server.certificate.serial_number

  - question: What other webshells or backdoors exist on this compromised server?
    context: Identifying additional persistence mechanisms reveals the full scope of the server compromise.
    range: -7d/+1d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.response.status_code
        - src_ip

  # Type 6: Enterprise Correlation
  - question: Are other users in the organization accessing this compromised server?
    context: Identifying additional connections helps determine if this server poses a broader threat to the organization.
    range: -24h/+24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - network.bytes_sent
        - network.bytes_received

  - question: What other compromised servers are being accessed from the same source?
    context: Mapping the attacker's infrastructure usage helps identify the broader campaign scope.
    range: -7d/+7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'webshell'
            - 'WEB_CLIENT'
            - 'compromised'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - url.domain