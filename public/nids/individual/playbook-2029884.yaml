name: ET WEB_CLIENT Generic WSO Webshell Password Prompt Accessed on External Compromised Server
id: 22029884
description: |
  Detects access to obfuscated WSO webshell password prompts on external servers using hex encoding.
  May trigger on legitimate applications using similar form encoding, but the specific pattern indicates webshell obfuscation techniques.
type: detection
detection_id: 2029884
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete obfuscated webshell form structure?
    context: Analyzing the hex-encoded form reveals the obfuscation technique and webshell sophistication level.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.response.body.content
        - url.full
        - url.path
        - http.response.headers

  - question: What does the hex-encoded content decode to reveal?
    context: Decoding the obfuscated elements helps understand the true webshell functionality and parameters.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.body.content
        - http.request.body.content
        - url.query

  # Type 2: Triage Assessment
  - question: Is this obfuscated access from an authorized security assessment?
    context: Determining if this is legitimate penetration testing using obfuscated tools helps eliminate false positives.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.domain
        - http.request.headers.user_agent
        - http.request.method

  - question: Does this match known legitimate application encoding patterns?
    context: Verifying if the hex encoding is used by legitimate applications helps assess false positive likelihood.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.response.headers.server
        - src_ip

  # Type 3: Activity Context
  - question: What reconnaissance led to discovering this obfuscated webshell?
    context: Understanding how the attacker found this hidden webshell reveals their methodology and tools.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.request.method
        - http.response.status_code

  - question: What other obfuscated or encoded content was accessed?
    context: Identifying patterns of obfuscated access helps understand the attacker's evasion techniques.
    range: -6h/+1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.path
        - url.query
        - http.request.body.content

  # Type 4: Impact Assessment
  - question: Did the user successfully bypass the obfuscated authentication?
    context: Determining if the attacker authenticated to the hidden webshell is critical for compromise assessment.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.request.method: 'POST'
        condition: selection
      fields:
        - http.request.body.content
        - http.response.status_code
        - http.response.body.content

  - question: What obfuscated commands or operations were executed?
    context: Understanding encoded webshell usage reveals the sophistication and objectives of the attack.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - http.request.body.content
        - http.response.body.content
        - url.query

  # Type 5: Forensic Deep-Dive
  - question: What obfuscation techniques are being used to evade detection?
    context: Analyzing the encoding methods helps improve detection capabilities and understand threat actor TTPs.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - http.response.body.content
        - http.response.headers
        - url.path

  - question: What other evasion techniques are present on this compromised server?
    context: Identifying additional obfuscation methods reveals the full scope of the attacker's stealth capabilities.
    range: -7d/+1d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.response.headers.content_encoding
        - src_ip

  # Type 6: Enterprise Correlation
  - question: Are other systems accessing this obfuscated webshell infrastructure?
    context: Identifying additional connections helps determine the campaign scope and potential lateral movement.
    range: -24h/+24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - network.bytes_sent
        - network.bytes_received

  - question: What other obfuscated webshells are being accessed by this attacker?
    context: Mapping the attacker's obfuscated infrastructure usage helps identify the broader evasion campaign.
    range: -7d/+7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'webshell'
            - 'WEB_CLIENT'
            - 'obfuscat'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - url.domain