name: ET WEB_CLIENT Anonymous Webshell Accessed on External Compromised Server
id: 22029886
description: |
  Detects access to Anonymous Shell (AnonyMous SHell) webshells on external compromised servers.
  May trigger on legitimate admin tools with similar interfaces, but the specific Anonymous Shell branding typically indicates malicious webshell deployment.
type: detection
detection_id: 2029886
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete Anonymous Shell interface and capabilities?
    context: Analyzing the full webshell interface reveals the specific functionality available to attackers.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.response.body.content
        - url.full
        - url.path
        - http.response.headers

  - question: What specific Anonymous Shell variant and version is deployed?
    context: Identifying the webshell variant helps understand attacker capabilities and potential system access level.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.body.content
        - http.response.headers.server
        - url.query

  # Type 2: Triage Assessment
  - question: Is this access from authorized security testing or administration?
    context: Determining if this is legitimate security assessment helps eliminate false positives from authorized activities.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.domain
        - http.request.headers.user_agent
        - http.request.method

  - question: Does this server normally host administrative interfaces?
    context: Understanding the server's legitimate purpose helps assess whether webshell presence is expected or malicious.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.response.headers.server
        - src_ip

  # Type 3: Activity Context
  - question: How was this Anonymous Shell webshell discovered or accessed?
    context: Understanding the discovery method reveals whether this was targeted or opportunistic access.
    range: -3h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.request.method
        - http.response.status_code
        - http.request.headers.referer

  - question: What web scanning or enumeration preceded this webshell access?
    context: Identifying reconnaissance patterns helps understand the attacker's methodology and tools used.
    range: -8h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - url.path
        - http.response.status_code

  # Type 4: Impact Assessment
  - question: What commands or operations were executed through the Anonymous Shell?
    context: Understanding webshell usage reveals the extent of system compromise and attacker objectives.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - http.request.body.content
        - http.response.body.content
        - url.query
        - http.request.method

  - question: What data was accessed or exfiltrated through the webshell?
    context: Determining data access helps assess the breach impact and compliance implications.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - network.bytes_sent
        - network.bytes_received
        - network.protocol

  # Type 5: Forensic Deep-Dive
  - question: What is the hosting infrastructure and server configuration?
    context: Analyzing the compromised server helps understand the attack vector and potential other victims.
    query: |
      aggregation: false
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - tls.server.certificate.subject
        - tls.server.certificate.issuer
        - tls.server.certificate.serial_number

  - question: What other Anonymous Shell instances or webshells exist on this server?
    context: Identifying additional persistence mechanisms reveals the full scope of the server compromise.
    range: -7d/+1d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.response.status_code
        - src_ip

  - question: What Anonymous Shell features and modules are available?
    context: Understanding the webshell's full functionality helps assess the potential for advanced attacks.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - http.response.body.content
        - url.path
        - http.response.headers

  # Type 6: Enterprise Correlation
  - question: Are other users accessing this Anonymous Shell webshell?
    context: Identifying additional connections helps determine if multiple attackers are using this infrastructure.
    range: -24h/+24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - http.request.method
        - url.path

  - question: What other Anonymous Shell or webshell infrastructure is being accessed?
    context: Mapping the attacker's webshell network helps identify the broader campaign scope and TTPs.
    range: -7d/+7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'webshell'
            - 'Anonymous'
            - 'WEB_CLIENT'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - url.domain