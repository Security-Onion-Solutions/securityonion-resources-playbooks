name: ET WEB_CLIENT Leaf PHPMailer Accessed on External Server
id: 22029904
description: |
  Detects access to Leaf PHPMailer interface on external servers.
  This tool is commonly used by attackers for spam campaigns and phishing attacks.
  May occasionally trigger on legitimate bulk email services with similar interfaces.
type: detection
detection_id: 2029904
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What is the complete Leaf PHPMailer interface structure detected?
    context: Analyzing the interface reveals configuration options and potential email campaign capabilities.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.response.body.content
        - url.full
        - http.request.method

  - question: What external server is hosting this PHPMailer interface?
    context: Identifying the hosting server helps determine threat actor infrastructure and campaign scope.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - url.domain
        - src_port

  # Type 2: Triage Assessment
  - question: Is this user authorized to access bulk email tools for business purposes?
    context: Some users may legitimately access email marketing platforms for business communications.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          url.domain|contains:
            - 'mailchimp'
            - 'sendgrid'
            - 'constantcontact'
        condition: selection
      fields:
        - url.domain
        - http.request.method

  - question: Does this access align with normal business hours and user behavior?
    context: Legitimate email marketing activities typically occur during business hours by authorized personnel.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out

  # Type 3: Activity Context
  - question: How did the user discover this PHPMailer interface?
    context: Understanding the discovery method reveals if this was targeted research or accidental access.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - url.full
        - http.request.referer
        - user_agent.original

  - question: What DNS queries preceded this PHPMailer access?
    context: DNS lookups may reveal how the user found this server or related malicious infrastructure.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  # Type 4: Impact Assessment
  - question: Did the user configure or use this PHPMailer for sending emails?
    context: POST requests indicate potential email campaign configuration or execution.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
          http.request.method: POST
        condition: selection
      fields:
        - url.full
        - http.request.body.content
        - http.response.status_code

  - question: What email-related network traffic originated from the client after this access?
    context: SMTP connections may indicate actual email sending using the accessed PHPMailer tool.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 25
            - 465
            - 587
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out

  # Type 5: Forensic Deep-Dive
  - question: What browser or application was used to access this PHPMailer interface?
    context: User agent analysis helps determine if access was manual or automated/scripted.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - user_agent.original
        - http.request.headers

  - question: Are there suspicious processes or tools running on the client system?
    context: Malware or hacking tools may have directed the user to this PHPMailer interface.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - file.hash.md5

  # Type 6: Enterprise Correlation
  - question: Are other users in the organization accessing similar PHPMailer interfaces?
    context: Multiple users accessing email tools may indicate coordinated campaign or training activity.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'PHPMailer'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: What other email-related suspicious activity is occurring enterprise-wide?
    context: PHPMailer access may be part of broader email-based attack campaign across the organization.
    range: -48h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'phishing'
            - 'spam'
            - 'email'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name