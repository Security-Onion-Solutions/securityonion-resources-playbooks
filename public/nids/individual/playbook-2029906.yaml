name: ET WEB_CLIENT Owl PHPMailer Accessed on External Server
id: 22029906
description: |
  Detects access to Owl PHPMailer interface on external servers.
  This advanced email tool is commonly used by attackers for sophisticated spam and phishing campaigns.
  May rarely trigger on legitimate bulk email services with similar JavaScript functionality.
type: detection
detection_id: 2029906
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What is the complete Owl PHPMailer interface with JavaScript functions detected?
    context: Analyzing the interface reveals advanced features like start/stop controls and campaign management capabilities.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.response.body.content
        - url.full
        - http.request.method

  - question: What external server is hosting this advanced PHPMailer interface?
    context: Identifying the hosting infrastructure helps map threat actor resources and campaign scope.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - url.domain
        - src_port

  # Type 2: Triage Assessment
  - question: Is this user authorized to access advanced email marketing platforms?
    context: Some marketing professionals may legitimately use sophisticated email tools for business campaigns.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          url.domain|contains:
            - 'marketing'
            - 'campaign'
            - 'email'
        condition: selection
      fields:
        - url.domain
        - http.request.method
        - user_agent.original

  - question: Does this access pattern match legitimate business email marketing activities?
    context: Legitimate email marketing typically involves scheduled campaigns during business hours.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - duration

  # Type 3: Activity Context
  - question: How did the user discover this advanced PHPMailer interface?
    context: Understanding discovery method reveals if this was targeted research, training, or malicious intent.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - url.full
        - http.request.referer
        - user_agent.original

  - question: What DNS queries were made before accessing this PHPMailer?
    context: DNS lookups may reveal how the user found this server or related attack infrastructure.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  # Type 4: Impact Assessment
  - question: Did the user interact with the start/stop sending controls in this PHPMailer?
    context: JavaScript function calls and POST requests indicate active email campaign management.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
          http.request.method: POST
        condition: selection
      fields:
        - url.full
        - http.request.body.content
        - http.response.status_code

  - question: What email-related network activity followed this PHPMailer access?
    context: SMTP connections and bulk traffic patterns indicate actual email campaign execution.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 25
            - 465
            - 587
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - duration

  # Type 5: Forensic Deep-Dive
  - question: What browser configuration and extensions were used to access this PHPMailer?
    context: Advanced PHPMailers may require specific browser settings or extensions for full functionality.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - user_agent.original
        - http.request.headers

  - question: Are there suspicious tools or malware on the client system that could facilitate email campaigns?
    context: Email campaign tools, proxies, or malware may complement PHPMailer usage for large-scale operations.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - file.hash.md5

  # Type 6: Enterprise Correlation
  - question: Are other users accessing similar advanced PHPMailer interfaces?
    context: Multiple users accessing sophisticated email tools may indicate coordinated campaign or training.
    range: -48h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'PHPMailer'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: What other advanced email or spam-related activity is occurring enterprise-wide?
    context: Owl PHPMailer access may be part of sophisticated email-based attack campaign across the organization.
    range: -72h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'spam'
            - 'phishing'
            - 'email'
            - 'bulk'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name