name: ET WEB_SERVER Owl PHPMailer Accessed on Internal Server
id: 22029907
description: |
  Detects access to Owl PHPMailer interface on internal servers. This tool can be used for legitimate email testing
  but is commonly abused by attackers for spam campaigns and phishing after compromising web servers.
type: detection
detection_id: 2029907
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What specific PHPMailer functions were accessed in the HTTP response?
    context: Examining the response content reveals which PHPMailer features were exposed to external clients.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.response.body.content
        - http.response.status_code
        - url.full

  - question: What was the complete HTTP request that triggered this alert?
    context: Understanding the request method and headers helps determine if this was intentional access or reconnaissance.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.request.method
        - http.request.headers
        - url.path

  # Type 2: Triage Assessment
  - question: Is this PHPMailer access from a known administrative source?
    context: Legitimate administrators may access PHPMailer for email configuration testing.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - bytes_in
        - bytes_out

  - question: Has this internal server been accessed by other external clients recently?
    context: Multiple external connections may indicate the server is compromised and being used for malicious purposes.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 80
        condition: selection
      fields:
        - src_ip
        - connection_count
        - bytes_transferred

  # Type 3: Activity Context
  - question: What web application activity preceded this PHPMailer access?
    context: Previous web requests may show how the attacker discovered or accessed the PHPMailer interface.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - url.path
        - http.request.method
        - http.response.status_code
        - user_agent.original

  - question: Are there signs of web shell or backdoor deployment on this server?
    context: Attackers often deploy web shells before accessing mail functionality for spam campaigns.
    range: -6h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.request.body.content
        - http.response.status_code

  # Type 4: Impact Assessment
  - question: Has email been sent through this PHPMailer instance?
    context: Successful email sending indicates potential spam or phishing campaign execution.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 25
            - 587
            - 465
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection_count

  - question: What data was uploaded or posted to this server during the session?
    context: Large POST requests may indicate bulk email list uploads or configuration changes.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          src_ip|expand: '%src_ip%'
          http.request.method: POST
        condition: selection
      fields:
        - http.request.body.bytes
        - url.path
        - http.response.status_code

  # Type 5: Forensic Deep-Dive
  - question: What files were accessed or modified on the web server during this timeframe?
    context: File modifications may reveal malicious script deployment or configuration changes.
    range: +/-1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - file.path
        - file.name
        - process.name
        - event.action

  - question: Are there indicators of automated scanning or brute force attempts?
    context: Rapid sequential requests may indicate automated tools scanning for vulnerable mail interfaces.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.response.status_code
        - request_count

  # Type 6: Enterprise Correlation
  - question: Are other internal web servers showing similar PHPMailer access patterns?
    context: Multiple compromised servers may indicate a broader campaign targeting the organization's web infrastructure.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "PHPMailer"
        condition: selection
      fields:
        - dst_ip
        - src_ip
        - alert_count

  - question: Have similar external IP addresses accessed other internal services?
    context: The same attacker may be targeting multiple internal services beyond web applications.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - service_name
        - connection_count