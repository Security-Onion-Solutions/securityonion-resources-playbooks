name: ET WEB_SERVER Generic Webshell Accessed on Internal Compromised Server
id: 22029917
description: |
  Detects generic webshell access on internal compromised servers responding to external clients.
  This critical alert indicates an internal web server has been compromised and is serving webshell content to external attackers.
  Represents active server compromise with potential for data exfiltration and lateral movement.
type: detection
detection_id: 2029917
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What webshell functionality is being served by this compromised internal server?
    context: Understanding webshell capabilities reveals the extent of server compromise and attacker access.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.response.body.content
        - http.response.status_code
        - url.full
        - http.request.method

  - question: Is this server authorized to communicate with external networks?
    context: Determines if external communication represents a policy violation or compromise indicator.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          src_port|expand: '%src_port%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - bytes_in

  - question: How was this webshell initially uploaded to the server?
    context: Identifies the initial compromise vector and potential vulnerabilities exploited.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
          http.request.method|contains:
            - 'POST'
            - 'PUT'
        condition: selection
      fields:
        - src_ip
        - http.request.body.content
        - url.path
        - http.request.method

  - question: What commands or files are being executed through this webshell?
    context: Reveals the scope of malicious activity and potential system impact.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.request.method: 'POST'
        condition: selection
      fields:
        - http.request.body.content
        - url.path
        - url.query

  - question: What processes are running on the compromised server?
    context: Identifies malicious processes spawned by webshell activity.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid
        - ParentImage

  - question: What files are being accessed or modified on the server?
    context: Reveals data access patterns and potential exfiltration targets.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.mime_type
        - User

  - question: Are there signs of lateral movement from this compromised server?
    context: Assesses whether the compromise has spread to other internal systems.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - bytes_in

  - question: What sensitive data directories are being accessed?
    context: Identifies potential data exfiltration targets and privacy impact.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - 'database'
            - 'backup'
            - 'config'
            - 'user'
            - 'password'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - User

  - question: Are there authentication bypass attempts on this server?
    context: Reveals how attackers are maintaining persistent access to the compromised server.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
          url.path|contains:
            - 'admin'
            - 'login'
            - 'auth'
        condition: selection
      fields:
        - src_ip
        - http.request.body.content
        - url.path
        - http.request.method

  - question: What external IPs are accessing this compromised webshell?
    context: Identifies the scope of external attacker access and potential threat actor infrastructure.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
          dst_port|expand: '%src_port%'
        condition: selection
      fields:
        - src_ip
        - bytes_out
        - bytes_in

  - question: Are other internal servers showing similar webshell activity?
    context: Determines if this is part of a broader compromise campaign across the organization.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'webshell'
            - 'WEB_SERVER'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name