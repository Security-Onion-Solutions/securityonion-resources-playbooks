name: ET WEB_SERVER Generic Webshell Accessed on Internal Compromised Server
id: 22029919
description: |
  Detects An0n 3xPloiTeR Mini Shell webshell access on internal compromised servers.
  This critical alert indicates an internal web server has been compromised with this specific webshell variant.
  Represents active server compromise with external attacker access to internal infrastructure.
type: detection
detection_id: 2029919
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What An0n 3xPloiTeR Mini Shell features are being served by this compromised server?
    context: Understanding the specific webshell variant reveals attacker capabilities and potential impact.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.response.body.content
        - http.response.status_code
        - url.full
        - http.request.method

  - question: Is this internal server authorized for external communication?
    context: Determines if external communication represents unauthorized access or policy violation.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          src_port|expand: '%src_port%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - bytes_in

  - question: How was this An0n 3xPloiTeR webshell uploaded to the server?
    context: Identifies the initial compromise vector and vulnerability exploited for webshell deployment.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
          http.request.method|contains:
            - 'POST'
            - 'PUT'
        condition: selection
      fields:
        - src_ip
        - http.request.body.content
        - url.path
        - http.request.method

  - question: What malicious commands are being executed through this Mini Shell?
    context: Reveals the scope of system compromise and attacker activities on the server.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.request.method: 'POST'
        condition: selection
      fields:
        - http.request.body.content
        - url.path
        - url.query

  - question: What processes have been spawned by webshell activity on this server?
    context: Identifies malicious processes and system-level compromise indicators.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid
        - ParentImage

  - question: What files are being accessed or exfiltrated through this webshell?
    context: Assesses data access patterns and potential information theft.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.mime_type
        - User

  - question: Are there signs of privilege escalation attempts on this server?
    context: Determines if attackers are attempting to gain higher-level system access.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'net.exe'
            - 'whoami.exe'
            - 'runas.exe'
            - 'powershell.exe'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  - question: What sensitive system information is being harvested?
    context: Identifies reconnaissance activities and potential intelligence gathering.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - 'SAM'
            - 'SYSTEM'
            - 'password'
            - 'config'
            - 'database'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - User

  - question: Which external threat actors are accessing this compromised server?
    context: Identifies the scope of external attacker access and potential attribution.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
          dst_port|expand: '%src_port%'
        condition: selection
      fields:
        - src_ip
        - bytes_out
        - bytes_in

  - question: Are other internal systems compromised with similar webshells?
    context: Determines if this is part of a broader An0n 3xPloiTeR campaign across the organization.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'An0n'
            - 'Mini Shell'
            - 'webshell'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is there evidence of lateral movement from this compromised server?
    context: Assesses whether the compromise has spread to other internal systems.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - bytes_in