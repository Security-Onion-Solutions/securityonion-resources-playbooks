name: ET MALWARE AgentTesla Exfil via FTP
id: 22029927
description: |
  Detects AgentTesla malware exfiltrating stolen data via FTP with specific file naming pattern.
  AgentTesla is a .NET-based information stealer that commonly uses FTP for data exfiltration.
type: detection
detection_id: 2029927
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the exact filename pattern used in the FTP STOR command?
    context: The specific naming convention reveals AgentTesla's data organization method.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - alert.signature
        - payload_printable
        - src_ip
        - dst_ip

  - question: Is this FTP server commonly used for legitimate file transfers?
    context: Distinguishing between authorized FTP usage and malicious exfiltration attempts.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 21
        condition: selection
      fields:
        - src_ip
        - connection_state
        - bytes_toserver

  - question: What other FTP activity occurred from this source around the same time?
    context: AgentTesla typically uploads multiple files containing different types of stolen data.
    range: -1h/+1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 21
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - duration

  - question: What processes were running on the source system during this timeframe?
    context: Identifying the AgentTesla process and any related malicious activity.
    range: -30m/+30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: Has the source system successfully uploaded data to the FTP server?
    context: Determining if sensitive data was actually exfiltrated or if the attempt failed.
    range: -15m/+15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 21
          bytes_toserver: '>1000'
        condition: selection
      fields:
        - bytes_toserver
        - bytes_toclient
        - duration

  - question: What type of data is typically stored in PW_ prefixed files?
    context: Understanding the nature of compromised information for impact assessment.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'AgentTesla'
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - rule.name
        - alert.signature
        - payload_printable

  - question: Are there signs of credential harvesting or keylogging on the source system?
    context: AgentTesla is known for stealing passwords and capturing keystrokes.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - 'password'
            - 'credential'
            - 'login'
        condition: selection
      fields:
        - TargetFilename
        - Image
        - ProcessGuid

  - question: What other external connections has this system made recently?
    context: Identifying command and control communications or additional exfiltration channels.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip: '!10.0.0.0/8'
          dst_ip: '!172.16.0.0/12'
          dst_ip: '!192.168.0.0/16'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver

  - question: Are there other systems in the network showing similar AgentTesla indicators?
    context: Determining if this is part of a broader malware campaign across the organization.
    range: -24h/+24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'AgentTesla'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Has this FTP server been used by other potentially compromised systems?
    context: Identifying the scope of the data exfiltration campaign.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 21
          bytes_toserver: '>1000'
        condition: selection
      fields:
        - src_ip
        - bytes_toserver
        - duration