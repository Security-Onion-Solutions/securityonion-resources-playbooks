name: ET WEB_CLIENT WSO 2.6 Webshell Accessed on External Compromised Server
id: 22029934
description: |
  Detects access to WSO 2.6 webshell hosted on external compromised servers.
  This indicates potential command and control infrastructure or compromised websites being used for malicious purposes.
  Legitimate access to WSO webshells is extremely rare and typically indicates compromise.
type: detection
detection_id: 2029934
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete URL and request method used to access the WSO 2.6 webshell?
    context: Understanding the access pattern helps identify the webshell's location and functionality being used.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.request.body.content
        - rule.name

  - question: What specific WSO 2.6 webshell features were accessed in the HTTP response?
    context: Analyzing the response content reveals which webshell capabilities the attacker utilized.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.body.content
        - http.response.status_code
        - network.bytes_sent

  # Type 2: Triage Assessment
  - question: Is this access part of authorized security testing or research?
    context: Determining if this represents legitimate security assessment before treating as malicious.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.request.method
        - user_agent.original

  - question: Has this internal system previously accessed this external server legitimately?
    context: Establishing baseline behavior to distinguish between normal and suspicious access patterns.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - network.protocol
        - network.bytes_sent

  # Type 3: Activity Context
  - question: What initial compromise or infection vector led to this webshell access?
    context: Understanding how the system became compromised helps identify the attack chain.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - 'trojan-activity'
            - 'malware-cnc'
            - 'exploit'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - alert.signature

  - question: What commands or data were exchanged with the webshell?
    context: Analyzing the communication reveals the attacker's objectives and actions performed.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - http.request.body.content
        - http.response.body.content
        - url.query

  # Type 4: Impact Assessment
  - question: What sensitive data was potentially exfiltrated through the webshell?
    context: Assessing data breach impact by analyzing outbound traffic patterns and content.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - network.bytes_sent
        - http.request.body.content
        - url.path

  - question: Are there signs of lateral movement or further system compromise?
    context: Determining if the webshell access was used to expand the attack within the network.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.protocol

  # Type 5: Forensic Deep-Dive
  - question: What other webshells or command and control infrastructure has this system accessed?
    context: Identifying the full scope of compromise and attacker infrastructure usage.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - 'web-application-attack'
            - 'malware-cnc'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - alert.signature

  - question: What persistence mechanisms were established on the compromised system?
    context: Understanding how the attacker maintains access helps with remediation planning.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name

  # Type 6: Enterprise Correlation
  - question: Are other systems in the organization accessing similar webshell infrastructure?
    context: Determining if this is part of a broader compromise affecting multiple systems.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'WSO'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - rule.name
        - alert.signature

  - question: Is this external server hosting webshells for other organizations?
    context: Understanding if this is shared criminal infrastructure affecting multiple victims.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 80
            - 443
        condition: selection
      fields:
        - src_ip
        - network.bytes_sent
        - network.protocol