name: ET WEB_CLIENT Generic PHP Mailer Accessed on External Compromised Server
id: 22029936
description: |
  Detects access to DRIV3R KR PRIV8 MAILER, a malicious PHP-based email sending tool hosted on external compromised servers.
  This indicates potential spam operations, phishing campaigns, or other malicious email activities.
  Legitimate access to such tools is extremely rare and typically indicates malicious intent.
type: detection
detection_id: 2029936
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete URL and request parameters used to access the malicious PHP mailer?
    context: Understanding the access pattern helps identify the mailer's configuration and intended usage.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.request.body.content
        - rule.name

  - question: What specific mailer functionality was accessed based on the HTTP response content?
    context: Analyzing the response reveals which email sending capabilities the attacker is utilizing.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.body.content
        - http.response.status_code
        - network.bytes_sent

  # Type 2: Triage Assessment
  - question: Is this access part of authorized security research or testing?
    context: Determining if this represents legitimate security assessment before treating as malicious.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.request.method
        - user_agent.original

  - question: Has this internal system previously accessed this external server for legitimate purposes?
    context: Establishing baseline behavior to distinguish between normal and suspicious access patterns.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - network.protocol
        - network.bytes_sent

  # Type 3: Activity Context
  - question: What initial compromise or malware infection led to this mailer access?
    context: Understanding how the system became compromised helps identify the attack vector.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - 'trojan-activity'
            - 'malware-cnc'
            - 'exploit'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - alert.signature

  - question: What email content or recipient lists were submitted to the mailer?
    context: Analyzing the communication reveals the scope and nature of the spam campaign.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - http.request.body.content
        - http.response.body.content
        - url.query

  # Type 4: Impact Assessment
  - question: What volume of spam or phishing emails were potentially sent through this mailer?
    context: Assessing the scale of the malicious email campaign and potential reputation damage.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - network.bytes_sent
        - http.request.body.content
        - url.path

  - question: Are there signs of the compromised system being used for other malicious activities?
    context: Determining if the mailer access is part of broader malicious operations.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.protocol

  # Type 5: Forensic Deep-Dive
  - question: What other malicious email infrastructure has this system accessed?
    context: Identifying the full scope of spam operations and related criminal infrastructure.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'Mailer'
            - 'Spam'
            - 'Phishing'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - alert.signature

  - question: What malware or botnet is controlling this system's malicious email activities?
    context: Understanding the threat actor and malware family behind the spam operations.
    range: -48h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name

  - question: What persistence mechanisms allow continued access to this compromised system?
    context: Identifying how the attacker maintains control for ongoing spam operations.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - file.name
        - file.path
        - file.hash.md5

  # Type 6: Enterprise Correlation
  - question: Are other systems in the organization accessing similar malicious mailer infrastructure?
    context: Determining if this is part of a broader botnet infection affecting multiple systems.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'Mailer'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - rule.name
        - alert.signature

  - question: Is this external mailer infrastructure being used by other organizations?
    context: Understanding if this is shared criminal infrastructure affecting multiple victims.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 80
            - 443
        condition: selection
      fields:
        - src_ip
        - network.bytes_sent
        - network.protocol