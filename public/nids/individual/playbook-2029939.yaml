name: ET WEB_SERVER Generic Webshell Accessed on Internal Compromised Server
id: 22029939
description: |
  Detects access to Mr.Rm19 webshell interface on internal servers responding to external clients.
  Indicates server compromise with webshell installation for remote command execution and system control.
  Rarely triggers on legitimate applications with similar HTML patterns.
type: detection
detection_id: 2029939
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What is the complete webshell interface served by the compromised internal server?
    context: Analyzing the full webshell response reveals available commands and server information exposed to attackers.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.response.body.content
        - http.response.status_code
        - url.full
        - http.request.method

  - question: Is this webshell interface part of any authorized administrative tools?
    context: Some legitimate web administration panels may have similar interface elements, requiring verification.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains:
            - 'admin'
            - 'manage'
            - 'control'
        condition: selection
      fields:
        - url.path
        - src_ip
        - user_agent.original

  - question: What external clients have accessed this webshell interface?
    context: Multiple external IPs accessing the webshell indicates widespread compromise or shared access among attackers.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|expand: '%url.path%'
        condition: selection
      fields:
        - src_ip
        - user_agent.original
        - http.request.method
        - http.request.referrer

  - question: What commands have been executed through this webshell?
    context: POST requests to webshells contain commands, revealing attacker activities and system modifications.
    range: +24h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|expand: '%url.path%'
          http.request.method: 'POST'
        condition: selection
      fields:
        - src_ip
        - http.request.body.content
        - http.response.status_code
        - user_agent.original

  - question: How was this webshell initially uploaded to the server?
    context: Understanding the upload method reveals the initial compromise vector and helps prevent recurrence.
    range: -7d
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          file.name|contains:
            - '.php'
            - 'shell'
            - 'cmd'
        condition: selection
      fields:
        - file.path
        - file.name
        - file.hash.md5
        - process.name
        - process.command_line

  - question: What other malicious files are hosted on this compromised server?
    context: Compromised servers often host multiple malicious tools, revealing the full scope of the breach.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains:
            - '.php'
            - 'upload'
            - 'backdoor'
            - 'shell'
        condition: selection
      fields:
        - url.path
        - src_ip
        - http.response.status_code

  - question: Has this compromised server been used for lateral movement?
    context: Webshells enable attackers to pivot to other systems, requiring analysis of outbound connections.
    range: +24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.protocol
        - network.bytes_sent

  - question: What web server processes are running on this compromised system?
    context: Identifying web server processes helps determine exploitation methods and containment strategies.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          process.name|contains:
            - 'apache'
            - 'nginx'
            - 'httpd'
            - 'iis'
            - 'php'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - user.name

  - question: Are there signs of data exfiltration from this compromised server?
    context: Webshells are commonly used for data theft, requiring analysis of unusual outbound data transfers.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          network.bytes_sent|gte: 1000000
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.bytes_sent
        - network.protocol

  - question: What authentication attempts were made against this server before compromise?
    context: Understanding failed authentication patterns helps identify brute force attacks or credential stuffing attempts.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains:
            - 'login'
            - 'admin'
            - 'wp-login'
            - 'administrator'
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.response.status_code
        - user_agent.original

  - question: Are other internal servers showing similar webshell installations?
    context: Attackers often deploy webshells across multiple compromised systems, indicating campaign scope.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'webshell'
            - 'Mr.Rm19'
            - 'Generic Webshell'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - url.path