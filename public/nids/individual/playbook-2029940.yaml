name: ET WEB_CLIENT Generic PHP Mailer Accessed on External Compromised Server
id: 22029940
description: |
  Detects access to Power Mailer Inbox PHP script on external servers by internal clients.
  Indicates potential interaction with compromised external infrastructure hosting malicious mailing tools.
  May trigger on legitimate email service interfaces with similar branding.
type: detection
detection_id: 2029940
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What is the complete Power Mailer interface accessed by the internal client?
    context: Analyzing the full mailer response reveals available features and configuration options exposed to the user.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.response.body.content
        - http.response.status_code
        - url.full
        - user_agent.original

  - question: Is this access to a legitimate email service or marketing platform?
    context: Some legitimate email services may have similar login interfaces, requiring verification of authorized usage.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains:
            - 'mail'
            - 'inbox'
            - 'email'
        condition: selection
      fields:
        - dst_ip
        - url.path
        - user_agent.original
        - http.request.referrer

  - question: How did the internal client discover this external mailer service?
    context: Understanding the referral path reveals whether access was direct, through links, or via search engines.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.full
        - http.request.method
        - http.request.referrer
        - user_agent.original

  - question: What authentication attempts were made to this mailer interface?
    context: Login attempts reveal whether the user has credentials for this service or is attempting unauthorized access.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          http.request.method: 'POST'
          url.path|contains:
            - 'login'
            - 'auth'
            - 'signin'
        condition: selection
      fields:
        - url.full
        - http.request.body.content
        - http.response.status_code

  - question: Has this internal client accessed other suspicious external email services?
    context: Multiple suspicious email service accesses may indicate compromised credentials or malicious intent.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'mailer'
            - 'email'
            - 'suspicious'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - url.path

  - question: What processes on the internal system initiated this mailer access?
    context: Identifying the source process helps determine if this was user-initiated or automated malware activity.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          process.name|contains:
            - 'browser'
            - 'chrome'
            - 'firefox'
            - 'edge'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - user.name

  - question: Are there signs of email campaign activity from this external server?
    context: Mailer services are used for bulk email operations, requiring analysis of SMTP connections and email traffic.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 25
            - 587
            - 465
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.bytes_sent

  - question: What files were accessed or downloaded during this mailer session?
    context: Mailer interfaces often provide file upload/download capabilities, revealing potential data theft or payload delivery.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - file.path
        - file.name
        - file.hash.md5
        - process.name

  - question: Are other internal systems accessing this same external mailer service?
    context: Multiple internal systems accessing the same suspicious mailer suggests coordinated activity or lateral movement.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|expand: '%url.path%'
        condition: selection
      fields:
        - src_ip
        - user_agent.original
        - http.request.method

  - question: What DNS queries were made for this external mailer domain?
    context: DNS resolution patterns help identify how the mailer URL was discovered and accessed.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.resolved_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.resolved_ip

  - question: Are there authentication events on the internal system around this mailer access?
    context: Unauthorized mailer access may coincide with credential compromise or unauthorized system access.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          process.name|contains:
            - 'login'
            - 'su'
            - 'sudo'
            - 'runas'
        condition: selection
      fields:
        - process.command_line
        - user.name
        - process.parent.name