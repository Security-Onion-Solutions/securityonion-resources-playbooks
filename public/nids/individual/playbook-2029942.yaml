name: ET WEB_CLIENT Generic PHP Mailer Accessed on External Compromised Server
id: 22029942
description: |
  Detects access to F. Mortolino PHP mailer interface from external compromised servers.
  This indicates potential spam operations or compromised web applications being used for malicious email campaigns.
  Legitimate use would be rare as this appears to be a known malicious mailer tool.
type: detection
detection_id: 2029942
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What is the complete HTML content and structure of the F. Mortolino mailer interface accessed?
    context: Analyzing the full response reveals the mailer's capabilities and configuration options.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.response.body.content
        - http.request.method
        - url.full
        - http.response.status_code

  - question: Is this connection part of legitimate web browsing or administrative access?
    context: Determines if this could be authorized access to a known tool or malicious activity.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.request.method
        - user_agent.original

  - question: What other web applications or tools has this source IP accessed recently?
    context: Identifies if the source is systematically accessing multiple compromised servers or mailer tools.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - url.path
        - http.request.method

  - question: What email-related or spam infrastructure has been accessed from this network?
    context: Correlates this activity with broader spam campaign infrastructure usage.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 25
            - 587
            - 465
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.bytes_sent

  - question: Are there signs of successful email transmission or SMTP connections from the target server?
    context: Determines if the mailer tool was actually used to send spam or malicious emails.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 25
            - 587
            - 465
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.bytes_sent

  - question: What file uploads or POST requests occurred during this session?
    context: Identifies potential configuration changes, recipient list uploads, or email content submission.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
          http.request.method: POST
        condition: selection
      fields:
        - url.path
        - http.request.body.bytes
        - http.response.status_code

  - question: Has this specific mailer interface been accessed from other source IPs?
    context: Reveals the scope of compromise and whether multiple attackers are using the same tool.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains: 'mortolino'
        condition: selection
      fields:
        - src_ip
        - user_agent.original
        - http.request.method

  - question: What authentication attempts or login activity preceded this access?
    context: Determines how the attacker gained access to the compromised server hosting the mailer.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains:
            - 'login'
            - 'admin'
            - 'auth'
        condition: selection
      fields:
        - src_ip
        - url.full
        - http.request.method
        - http.response.status_code

  - question: Are there indicators of web shell or backdoor usage on the compromised server?
    context: Identifies how the mailer tool was deployed and what other malicious tools may be present.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains:
            - '.php'
            - 'shell'
            - 'cmd'
        condition: selection
      fields:
        - url.path
        - src_ip
        - http.request.method

  - question: Is this part of a broader campaign targeting multiple internal systems?
    context: Assesses whether this represents isolated activity or coordinated campaign across the organization.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'PHP Mailer'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: What DNS queries were made to resolve the compromised server hosting this mailer?
    context: Identifies how the attacker discovered or was directed to this specific compromised server.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          dns.resolved_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.query.name
        - src_ip
        - dns.query.type_name