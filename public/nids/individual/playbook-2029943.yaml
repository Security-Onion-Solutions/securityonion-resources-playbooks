name: ET WEB_SERVER Generic PHP Mailer Accessed on Internal Compromised Server
id: 22029943
description: |
  Detects F. Mortolino PHP mailer interface being served from internal compromised servers to external clients.
  This indicates a compromised internal web server is hosting malicious spam tools and serving them to external attackers.
  This represents a critical security breach requiring immediate containment.
type: detection
detection_id: 2029943
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What is the complete mailer interface content being served from the compromised internal server?
    context: Understanding the full functionality reveals the extent of the compromise and spam capabilities.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.response.body.content
        - url.full
        - http.response.status_code
        - http.response.body.bytes

  - question: Is this server authorized to host web applications or serve external traffic?
    context: Determines if this represents unauthorized service deployment or legitimate but compromised application.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 80
            - 443
            - 8080
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.bytes_sent

  - question: How did external attackers discover and access this internal compromised server?
    context: Identifies the attack vector and whether the server was directly exposed or accessed through other compromised systems.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - network.protocol

  - question: What malicious files or web shells were uploaded to deploy this mailer tool?
    context: Traces the initial compromise method and identifies other potential backdoors on the system.
    range: -48h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
          http.request.method: POST
          http.request.body.bytes|gte: 1000
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.request.body.bytes
        - user_agent.original

  - question: Has this compromised server successfully sent spam emails to external recipients?
    context: Assesses the impact and determines if the server has been actively used for malicious email campaigns.
    range: +6h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 25
            - 587
            - 465
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.bytes_sent

  - question: What other malicious tools or backdoors are hosted on this compromised server?
    context: Identifies the full scope of compromise and other threats that need to be addressed.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains:
            - '.php'
            - 'shell'
            - 'upload'
            - 'cmd'
        condition: selection
      fields:
        - url.path
        - dst_ip
        - http.request.method

  - question: Are multiple external IPs accessing this mailer interface?
    context: Determines if this is being used by a single attacker or distributed among multiple threat actors.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains: 'mortolino'
        condition: selection
      fields:
        - dst_ip
        - user_agent.original
        - http.request.method

  - question: What processes are running on the compromised server that support this malicious activity?
    context: Identifies malicious processes that need to be terminated and systems that require forensic analysis.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'php'
            - 'apache'
            - 'nginx'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  - question: Has sensitive data been accessed or exfiltrated from this compromised server?
    context: Assesses potential data breaches beyond the spam operation that require additional incident response.
    range: -48h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - '.sql'
            - '.db'
            - 'config'
            - 'password'
        condition: selection
      fields:
        - TargetFilename
        - User
        - ProcessName

  - question: Are other internal systems showing similar compromise indicators?
    context: Determines if this represents isolated incident or broader network compromise requiring expanded response.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'PHP Mailer'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: What network segmentation failures allowed external access to this internal server?
    context: Identifies security control gaps that enabled this compromise and need immediate remediation.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
          src_ip|startswith:
            - '10.'
            - '172.'
            - '192.168.'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - network.protocol