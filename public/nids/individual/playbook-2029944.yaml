name: ET WEB_CLIENT Generic PHP Mailer Accessed on External Compromised Server
id: 22029944
description: |
  Detects access to GwEx Mailer PHP interface from external compromised servers.
  This indicates potential spam operations or compromised web applications being used for malicious email campaigns.
  GwEx Mailer is a known malicious bulk email tool used by cybercriminals.
type: detection
detection_id: 2029944
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What is the complete GwEx Mailer interface content and configuration accessed?
    context: Analyzing the full response reveals the mailer's capabilities and current configuration settings.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.response.body.content
        - http.request.method
        - url.full
        - http.response.status_code

  - question: Is this access part of legitimate security research or administrative activity?
    context: Determines if this could be authorized penetration testing or security analysis versus malicious usage.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - user_agent.original
        - http.request.method

  - question: What other malicious tools or compromised servers has this source IP accessed?
    context: Identifies if this is part of systematic reconnaissance of compromised infrastructure by threat actors.
    range: -12h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - url.path
        - http.request.method

  - question: Are there signs of email transmission or SMTP activity from the target server?
    context: Determines if the GwEx Mailer tool was actively used to send malicious emails or spam campaigns.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 25
            - 587
            - 465
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.bytes_sent

  - question: What POST requests or file uploads occurred during this GwEx Mailer session?
    context: Identifies potential recipient list uploads, email template submission, or configuration changes.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
          http.request.method: POST
        condition: selection
      fields:
        - url.path
        - http.request.body.bytes
        - http.response.status_code

  - question: Has this specific GwEx Mailer instance been accessed by multiple threat actors?
    context: Reveals the scope of compromise and whether the tool is shared among different attackers.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains: 'gwex'
        condition: selection
      fields:
        - src_ip
        - user_agent.original
        - http.request.method

  - question: What authentication or login attempts preceded access to the GwEx Mailer?
    context: Determines how the attacker gained access to the compromised server hosting the mailer tool.
    range: -45m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains:
            - 'login'
            - 'admin'
            - 'auth'
        condition: selection
      fields:
        - src_ip
        - url.full
        - http.request.method
        - http.response.status_code

  - question: Are there indicators of web shell deployment or backdoor installation on the target server?
    context: Identifies how the GwEx Mailer was deployed and what other malicious tools may be present.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains:
            - 'shell'
            - 'cmd'
            - 'upload'
        condition: selection
      fields:
        - url.path
        - src_ip
        - http.request.method

  - question: What DNS resolution activity led to discovery of this compromised server?
    context: Identifies how the attacker located this specific server hosting the GwEx Mailer tool.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          dns.resolved_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.query.name
        - src_ip
        - dns.query.type_name

  - question: Is this part of a coordinated campaign targeting multiple systems in the organization?
    context: Assesses whether this represents isolated activity or broader threat campaign across the network.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'PHP Mailer'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: What patterns of network traffic indicate successful spam email delivery?
    context: Correlates mailer access with actual email transmission to assess campaign success and impact.
    range: +6h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 25
            - 587
        condition: selection
      fields:
        - dst_ip
        - network.bytes_sent
        - network.packets_sent