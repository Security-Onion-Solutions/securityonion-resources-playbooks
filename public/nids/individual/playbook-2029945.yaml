name: ET WEB_SERVER Generic PHP Mailer Accessed on Internal Compromised Server
id: 22029945
description: |
  Detects GwEx Mailer PHP interface being served from internal compromised servers to external clients.
  This indicates a critical security breach where internal infrastructure is hosting malicious spam tools.
  Immediate containment is required as the server is actively serving malicious content to external threats.
type: detection
detection_id: 2029945
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What is the complete GwEx Mailer functionality being served from the compromised internal server?
    context: Understanding the full interface reveals the extent of compromise and spam operation capabilities.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.response.body.content
        - url.full
        - http.response.status_code
        - http.response.body.bytes

  - question: Is this internal server authorized to host web services or communicate externally?
    context: Determines if this represents unauthorized service deployment or legitimate but compromised infrastructure.
    range: -14d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 80
            - 443
            - 8080
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.bytes_sent

  - question: How did external attackers gain access to this internal server?
    context: Identifies the initial compromise vector and potential network security control failures.
    range: -48h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - network.protocol

  - question: What malicious files were uploaded to deploy the GwEx Mailer on this server?
    context: Traces the deployment method and identifies other potential malicious files requiring removal.
    range: -72h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
          http.request.method: POST
          http.request.body.bytes|gte: 5000
        condition: selection
      fields:
        - src_ip
        - url.path
        - http.request.body.bytes
        - user_agent.original

  - question: Has this server been actively used to send spam emails to external recipients?
    context: Assesses the operational impact and determines if the server participated in active spam campaigns.
    range: +12h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 25
            - 587
            - 465
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.bytes_sent

  - question: What other backdoors or malicious tools are hosted on this compromised server?
    context: Identifies the full extent of compromise and additional threats requiring immediate attention.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains:
            - 'shell'
            - 'upload'
            - 'cmd'
            - 'backdoor'
        condition: selection
      fields:
        - url.path
        - dst_ip
        - http.request.method

  - question: Are multiple external threat actors using this compromised GwEx Mailer instance?
    context: Determines if this represents single attacker usage or shared criminal infrastructure.
    range: -48h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          url.path|contains: 'gwex'
        condition: selection
      fields:
        - dst_ip
        - user_agent.original
        - http.request.method

  - question: What malicious processes are currently running on this compromised server?
    context: Identifies active threats that need immediate termination and systems requiring forensic preservation.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'php'
            - 'apache'
            - 'nginx'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  - question: Has sensitive data been compromised or exfiltrated from this server?
    context: Assesses potential data breaches beyond spam operations that require additional incident response measures.
    range: -96h
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          TargetFilename|contains:
            - '.sql'
            - '.db'
            - 'config'
            - 'credential'
        condition: selection
      fields:
        - TargetFilename
        - User
        - ProcessName

  - question: Are other internal systems showing similar compromise patterns?
    context: Determines if this represents isolated incident or broader network compromise requiring expanded containment.
    range: -48h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'PHP Mailer'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: What network security controls failed to prevent external access to this internal server?
    context: Identifies critical security gaps requiring immediate remediation to prevent similar compromises.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%src_ip%'
          src_ip|startswith:
            - '10.'
            - '172.'
            - '192.168.'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - network.protocol

  - question: What indicators suggest this server is part of a larger botnet or criminal infrastructure?
    context: Assesses whether this compromise is part of organized cybercrime operations requiring law enforcement coordination.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 6667
            - 443
            - 80
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.bytes_sent