name: ET EXPLOIT IBM Data Risk Manager Remote Code Execution via NMAP Scan
id: 22029985
description: |
  Detects exploitation attempts against IBM Data Risk Manager using NMAP script injection for remote code execution.
  The attack uses malicious form data containing NMAP scripts to execute arbitrary commands on the target system.
  May trigger on legitimate NMAP usage through the DRM interface, though the script injection pattern is highly suspicious.
type: detection
detection_id: 2029985
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete malicious NMAP script injection payload in the form data?
    context: Understanding the exact script content reveals the attacker's intended commands and exploitation technique.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - http.request.body.content
        - http.request.method
        - url.full

  - question: What specific NMAP script was referenced in the --script parameter?
    context: Analyzing the script parameter helps identify the attack vector and potential system compromise methods.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.request.body.content
        - url.query

  - question: What file paths were targeted in the pcre pattern matching?
    context: The file paths reveal the attacker's knowledge of IBM DRM directory structure and potential privilege escalation attempts.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.request.body.content
        - http.request.headers

  # Type 2: Triage Assessment
  - question: Is this system a known IBM Data Risk Manager server with legitimate NMAP scanning functionality?
    context: Legitimate DRM usage might involve network scanning, though script injection is always suspicious.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          url.path|contains: "/albatross/"
        condition: selection
      fields:
        - src_ip
        - http.request.method
        - user_agent.original

  - question: Has this source IP previously accessed IBM DRM through legitimate authentication?
    context: Understanding access patterns helps distinguish between authorized users and external attackers.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains: "login"
        condition: selection
      fields:
        - http.response.status_code
        - url.path
        - http.request.body.content

  # Type 3: Activity Context
  - question: What reconnaissance activity preceded this exploitation attempt?
    context: Attackers typically perform reconnaissance before targeting specific vulnerabilities in IBM DRM.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - url.path
        - http.request.method
        - http.response.status_code

  - question: What other IBM DRM endpoints were accessed during this attack session?
    context: Understanding the full attack sequence helps identify the exploitation methodology and potential data access.
    range: +/-30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains: "/albatross/"
        condition: selection
      fields:
        - url.path
        - http.request.method
        - http.response.status_code

  # Type 4: Impact Assessment
  - question: Did the exploitation attempt result in successful command execution on the IBM DRM server?
    context: Analyzing response codes and content helps determine if the RCE was successful.
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - http.response.status_code
        - http.response.body.content
        - network.bytes_received

  - question: What processes were executed on the target system following this attack?
    context: Successful RCE would result in new process creation on the IBM DRM server.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ParentImage

  - question: Were any files created or modified on the target system after the attack?
    context: Successful exploitation might result in file system changes for persistence or data exfiltration.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - Image
        - User

  # Type 5: Forensic Deep-Dive
  - question: What specific IBM DRM vulnerability was targeted in this attack?
    context: Understanding the exact vulnerability helps with patch management and system hardening.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          url.path|contains: "nmap"
        condition: selection
      fields:
        - url.path
        - http.request.body.content
        - http.response.status_code

  - question: Are there indicators of post-exploitation activity such as credential harvesting or lateral movement?
    context: Successful RCE on IBM DRM could lead to access of sensitive risk management data and network credentials.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          CommandLine|contains:
            - "net user"
            - "whoami"
            - "systeminfo"
            - "tasklist"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  # Type 6: Enterprise Correlation
  - question: Are other IBM DRM servers in the environment being targeted with similar attacks?
    context: Attackers often target multiple instances of vulnerable applications across the enterprise.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          url.path|contains: "/albatross/restAPI/v2/nmap/run/scan/"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - http.request.body.content

  - question: Has this attacker IP targeted other web applications in the environment?
    context: Understanding the broader attack campaign helps identify other compromised systems and attack patterns.
    range: +/-7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          http.request.method: "POST"
        condition: selection
      fields:
        - dst_ip
        - url.path
        - http.response.status_code