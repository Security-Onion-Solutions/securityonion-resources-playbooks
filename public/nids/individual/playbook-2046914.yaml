name: ET MALWARE NanoCore RAT CnC 7
id: 22046914
description: |
  Detects NanoCore Remote Access Trojan command and control communications.
  Triggers on specific binary patterns used by NanoCore for C2 protocol communication.
  Legitimate applications would not use this exact binary signature pattern.
type: detection
detection_id: 2046914
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete binary payload that matched the NanoCore signature?
    context: The specific binary pattern reveals the NanoCore communication protocol and potential command structure.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - rule.name

  - question: What are the connection characteristics for this NanoCore C2 session?
    context: Connection metadata helps identify the RAT's communication patterns and data transfer volumes.
    range: -5m/+5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_port
        - dst_port
        - proto
        - bytes_toserver
        - bytes_toclient
        - duration

  # Type 2: Triage Assessment
  - question: Is this system authorized to communicate with the destination IP?
    context: Some remote administration tools may be legitimately deployed in enterprise environments.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - count
        - first_seen
        - last_seen

  - question: Does this activity occur during normal business operations?
    context: Legitimate remote administration typically occurs during business hours with proper scheduling.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - hour_of_day
        - day_of_week
        - count

  # Type 3: Activity Context
  - question: What process initiated this NanoCore connection?
    context: Identifying the parent process helps distinguish between legitimate remote tools and malware.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - User
        - ProcessGuid

  - question: What DNS resolution occurred before this connection?
    context: DNS queries reveal the infrastructure being contacted and potential dynamic DNS usage.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  - question: What other network connections were established around this time?
    context: RATs often establish multiple connections for different functions like data exfiltration or payload delivery.
    range: -10m/+10m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto
        - connection_state
        - bytes_toserver

  # Type 4: Impact Assessment
  - question: What volume of data has been transmitted through this RAT connection?
    context: Large data transfers indicate potential data exfiltration or remote access session activity.
    range: -2h/+2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - sum_bytes_toserver
        - sum_bytes_toclient
        - max_bytes_toserver
        - connection_count

  - question: Are there signs of persistent RAT installation and activity?
    context: Ongoing connections and regular beacons indicate successful RAT deployment and active control.
    range: -6h/+6h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - connection_state
        - avg_duration
        - count
        - unique_ports

  # Type 5: Forensic Deep-Dive
  - question: Are there file system artifacts matching the NanoCore RAT hash?
    context: File analysis confirms RAT installation and reveals additional components or persistence mechanisms.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          file.hash.md5: '2815f2a23e7383ca7821a40739f088b6'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.sha256
        - file.size
        - file.mime_type

  - question: What system modifications were made during the RAT installation?
    context: Registry changes and file modifications reveal RAT persistence and system configuration changes.
    range: -1h/+1h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetObject
        - Details
        - EventType

  # Type 6: Enterprise Correlation
  - question: Are other systems showing similar NanoCore RAT activity?
    context: Identifying campaign scope helps understand the extent of compromise across the organization.
    range: -24h/+24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'NanoCore'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - count