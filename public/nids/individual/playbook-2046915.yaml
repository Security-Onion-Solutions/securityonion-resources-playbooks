name: ET MALWARE NanoCore RAT CnC 24
id: 22046915
description: |
  Detects NanoCore Remote Access Trojan communicating with command and control servers.
  The malware uses a distinctive 12-byte header pattern for C2 communication protocol.
  Legitimate remote administration tools may rarely generate similar binary patterns.
type: detection
detection_id: 2046915
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What is the exact 12-byte header signature detected in this NanoCore communication?
    context: Analyzing the specific byte pattern helps confirm NanoCore variant and protocol version.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - flow.bytes_toserver

  - question: What are the complete connection parameters for this C2 communication?
    context: Understanding connection details helps identify C2 infrastructure and communication patterns.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_port
        - dst_port
        - proto

  # Type 2: Triage Assessment
  - question: Is this system authorized to use remote access or administration tools?
    context: Legitimate remote access software may generate similar outbound connections.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - teamviewer
            - vnc
            - rdp
            - remotedesktop
            - anydesk
        condition: selection
      fields:
        - User
        - Image
        - CommandLine

  - question: Does this host regularly communicate with the destination server for business purposes?
    context: Established business relationships may explain connections to external servers.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - proto
        - community_id

  # Type 3: Activity Context
  - question: What processes were executing when this NanoCore communication was initiated?
    context: Identifying the parent process helps determine infection vector and persistence mechanism.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  - question: What network activity preceded this RAT communication?
    context: Previous connections may reveal initial infection vector or other C2 channels.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto
        - conn_state

  # Type 4: Impact Assessment
  - question: Has the infected system established persistent command and control channels?
    context: NanoCore RAT maintains persistent connections for remote control capabilities.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - flow.bytes_toserver
        - flow.bytes_toclient

  - question: Are there indicators of remote desktop or file system access following C2 establishment?
    context: NanoCore provides remote desktop and file management capabilities to attackers.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  # Type 5: Forensic Deep-Dive
  - question: What NanoCore variant and capabilities are indicated by the communication protocol?
    context: Different NanoCore versions use distinct protocols and feature sets.
    range: -1h/+1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "NanoCore"
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - severity

  - question: Are there NanoCore-related files or registry modifications indicating persistence?
    context: NanoCore often installs persistence mechanisms through files and registry changes.
    range: -2h/+1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.mime_type

  - question: What is the complete bidirectional communication pattern with the C2 server?
    context: Full session analysis reveals RAT capabilities and operator interaction patterns.
    range: -15m/+2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - flow.bytes_toserver
        - flow.bytes_toclient

  # Type 6: Enterprise Correlation
  - question: Are other Windows systems infected with NanoCore RAT variants?
    context: NanoCore campaigns often target multiple endpoints within the same organization.
    range: -4h/+4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "NanoCore"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is this C2 server managing multiple NanoCore RAT infections across the enterprise?
    context: Shared C2 infrastructure indicates coordinated campaign scope and attacker infrastructure.
    range: -24h/+2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|expand: '%dst_port%'
        condition: selection
      fields:
        - src_ip
        - community_id