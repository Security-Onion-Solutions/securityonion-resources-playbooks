name: GPL DNS named iquery attempt
id: 22100252
description: |
  Detects DNS iquery attempts targeting BIND name servers. The iquery feature was deprecated due to security vulnerabilities including information disclosure and potential denial of service. This could indicate reconnaissance activity against DNS infrastructure or legitimate monitoring tools.
type: detection
detection_id: 2100252
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact DNS iquery packet structure and content?
    context: Understanding the packet format confirms this is a genuine iquery attempt versus other DNS traffic.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - packet_info
        - dns.query.name

  - question: What DNS server and port was targeted by this iquery attempt?
    context: Identifies the specific DNS infrastructure being probed for vulnerabilities.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - src_ip
        - src_port

  # Type 2: Triage Assessment
  - question: Is this source IP authorized to perform DNS administration or monitoring?
    context: Legitimate network monitoring tools may use iquery for DNS server status checks.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 53
        condition: selection
      fields:
        - dst_ip
        - connection_state
        - bytes_toserver

  - question: Does this activity align with scheduled DNS maintenance windows?
    context: DNS administrators may use legacy tools during maintenance that trigger iquery alerts.
    range: -1d
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          dns.resolved_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - src_ip

  # Type 3: Activity Context
  - question: What other DNS reconnaissance activity preceded this iquery attempt?
    context: Attackers often perform DNS enumeration before attempting specific exploits like iquery.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.response_code

  - question: Were there any version.bind or hostname.bind queries from this source?
    context: DNS version queries often precede iquery attempts as part of service fingerprinting.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.query.name|contains:
            - 'version.bind'
            - 'hostname.bind'
            - 'authors.bind'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dst_ip

  # Type 4: Impact Assessment
  - question: Did the DNS server respond to the iquery request?
    context: A response indicates the server may be vulnerable or misconfigured to accept iquery requests.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
          src_port: 53
        condition: selection
      fields:
        - bytes_toclient
        - connection_state
        - community_id

  - question: Are there signs of successful DNS server information disclosure?
    context: Successful iquery exploitation may reveal server configuration or zone information.
    range: +10m
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dns.query.type_name|contains:
            - 'AXFR'
            - 'IXFR'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dst_ip

  # Type 5: Forensic Deep-Dive
  - question: What reconnaissance tools or frameworks match this iquery pattern?
    context: Specific tools like nmap, dnsrecon, or custom scripts have distinctive iquery implementations.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_port
        - bytes_toserver
        - connection_state
        - app_proto

  - question: Are there indicators of automated scanning or manual testing?
    context: Timing patterns help distinguish between automated tools and manual reconnaissance.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains: 'DNS'
        condition: selection
      fields:
        - alert.signature
        - dst_ip
        - alert.severity

  # Type 6: Enterprise Correlation
  - question: Are other DNS servers in the network receiving similar iquery attempts?
    context: Coordinated DNS reconnaissance suggests a broader network mapping campaign.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature: 'GPL DNS named iquery attempt'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - community_id

  - question: Is this part of a larger DNS infrastructure attack campaign?
    context: DNS attacks often target multiple servers and services as part of infrastructure compromise.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: 'DNS'
          alert.category: 'attempted-recon'
        condition: selection
      fields:
        - alert.signature
        - src_ip
        - dst_ip