name: GPL TFTP Put
id: 22100518
description: |
  Detects TFTP write operations (PUT) which can be used to upload files to TFTP servers. While TFTP PUT operations have legitimate uses for network device configuration and firmware updates, they can also indicate unauthorized file uploads, malware deployment, or data exfiltration attempts.
type: detection
detection_id: 2100518
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What file was being uploaded via TFTP PUT operation?
    context: Understanding the filename and content helps determine if this is legitimate network administration or malicious activity.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - packet_info
        - flow_bytes_toserver

  - question: What was the exact TFTP PUT packet structure and opcode?
    context: Analyzing the TFTP packet confirms this is a genuine write operation versus other UDP traffic.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_port
        - dst_port
        - community_id

  # Type 2: Triage Assessment
  - question: Is this source authorized to upload files to TFTP servers?
    context: Only authorized network administrators should perform TFTP write operations for device management.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 69
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - connection_state
        - app_proto

  - question: Does this TFTP activity align with scheduled network maintenance?
    context: Legitimate TFTP uploads often occur during maintenance windows for firmware updates or configuration backups.
    range: -1d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 69
        condition: selection
      fields:
        - src_ip
        - bytes_toserver
        - bytes_toclient
        - duration

  # Type 3: Activity Context
  - question: What network discovery preceded this TFTP PUT attempt?
    context: Attackers often scan for TFTP servers before attempting file uploads for malware deployment.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 69
        condition: selection
      fields:
        - dst_ip
        - connection_state
        - bytes_toserver
        - app_proto

  - question: Were there any TFTP GET operations from this source before the PUT?
    context: Attackers may download existing files before uploading malicious content to understand the environment.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains: 'TFTP'
        condition: selection
      fields:
        - alert.signature
        - dst_ip
        - community_id

  - question: What established the connection to the TFTP server?
    context: Understanding the initial connection helps determine if this is internal administration or external attack.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - connection_state
        - bytes_toserver
        - duration

  # Type 4: Impact Assessment
  - question: Was the TFTP PUT operation successful?
    context: A successful upload indicates potential malware deployment or unauthorized file modification.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 69
        condition: selection
      fields:
        - bytes_toserver
        - bytes_toclient
        - connection_state
        - duration

  - question: Are there signs of malware execution after the TFTP upload?
    context: Successful malware uploads may be followed by execution attempts on network devices or systems.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection_state
        - app_proto

  - question: Has the TFTP server behavior changed after this upload?
    context: Malicious uploads may alter normal TFTP server operations or enable backdoor access.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 69
        condition: selection
      fields:
        - src_ip
        - bytes_toserver
        - connection_state
        - duration

  # Type 5: Forensic Deep-Dive
  - question: What type of file was uploaded based on content analysis?
    context: File content analysis reveals if this is legitimate configuration data or malicious payload.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - flow_bytes_toserver

  - question: Are there indicators of known TFTP exploitation tools or techniques?
    context: Specific tools and techniques have distinctive patterns that help identify threat actor capabilities.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains:
            - 'TFTP'
            - 'file'
            - 'upload'
        condition: selection
      fields:
        - alert.signature
        - dst_ip
        - alert.severity

  # Type 6: Enterprise Correlation
  - question: Are other TFTP servers receiving similar unauthorized uploads?
    context: Coordinated TFTP attacks suggest systematic network compromise or malware distribution.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature: 'GPL TFTP Put'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - community_id

  - question: Is this part of a broader file transfer or data exfiltration campaign?
    context: TFTP uploads may be part of larger data theft operations or malware distribution networks.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains:
            - 'file'
            - 'transfer'
            - 'upload'
          alert.category: 'bad-unknown'
        condition: selection
      fields:
        - alert.signature
        - src_ip
        - dst_ip