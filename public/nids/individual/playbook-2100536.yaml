name: GPL NETBIOS SMB D$ share access
id: 22100536
description: |
  Detects access attempts to the administrative D$ share via SMB protocol.
  May indicate legitimate system administration or unauthorized lateral movement attempts. D$ share provides direct disk access.
type: detection
detection_id: 2100536
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact SMB tree connect request to the D$ share?
    context: Understanding the share access pattern reveals the specific administrative operation being attempted.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - smb.command
        - smb.tree.path
        - smb.share_name
        - smb.access_mask

  - question: What authentication credentials were used for D$ share access?
    context: The authentication context reveals whether this is authorized administrative access or credential abuse.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - smb.auth.username
        - smb.auth.domain
        - smb.auth.type
        - smb.session_id

  # Type 2: Triage Assessment
  - question: Is this user authorized to access administrative shares on this system?
    context: Legitimate administrators may access D$ for system maintenance, backup, or troubleshooting.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - smb.auth.username
        - admin_share_access
        - access_frequency

  - question: Is this D$ access occurring during normal business hours?
    context: Administrative share access outside business hours may indicate unauthorized activity.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - src_ip
        - connection_time
        - business_hours_flag

  # Type 3: Activity Context
  - question: What other administrative shares were accessed in this session?
    context: Multiple admin share access may indicate lateral movement or comprehensive system reconnaissance.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: "share access"
        condition: selection
      fields:
        - rule.name
        - share_accessed
        - access_pattern

  - question: What file operations occurred on the D$ share after connection?
    context: Understanding file access patterns reveals the purpose of the administrative share connection.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - smb.file.path
        - smb.file.action
        - bytes_transferred

  # Type 4: Impact Assessment
  - question: Were sensitive files accessed or modified via the D$ share?
    context: Administrative share access may lead to data theft, malware deployment, or system compromise.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          file.path|contains:
            - "D:\\"
            - "system32"
            - "Program Files"
        condition: selection
      fields:
        - file.path
        - file.action
        - file.hash.md5
        - User

  - question: Are there signs of malware deployment through the D$ share?
    context: Administrative shares are commonly used for lateral movement and malware distribution.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          alert.category|contains:
            - "trojan-activity"
            - "malware-cnc"
        condition: selection
      fields:
        - rule.name
        - malware_family
        - infection_vector

  # Type 5: Forensic Deep-Dive
  - question: What specific files or directories were targeted on the D$ share?
    context: File access patterns reveal attacker objectives such as credential harvesting or data exfiltration.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          file.path|contains: "D:\\"
        condition: selection
      fields:
        - file.path
        - file.action
        - access_count

  - question: Does this D$ access pattern match known lateral movement techniques?
    context: Specific access sequences and file operations can identify automated tools or manual techniques.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.category: "protocol-command-decode"
        condition: selection
      fields:
        - rule.name
        - lateral_movement_indicator
        - technique_classification

  # Type 6: Enterprise Correlation
  - question: Are other systems experiencing D$ share access from this source?
    context: Multiple targets may indicate systematic lateral movement or administrative tool usage.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name: "GPL NETBIOS SMB D$ share access"
        condition: selection
      fields:
        - dst_ip
        - target_count
        - geographic_spread

  - question: Is this part of broader administrative share abuse across the network?
    context: Coordinated admin share access may indicate compromised credentials or insider threat activity.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "share access"
          alert.category: "protocol-command-decode"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - share_type
        - campaign_scope