name: GPL RPC portmap nisd request UDP
id: 22100580
description: |
  Detects RPC portmap requests for the Network Information Service daemon (nisd).
  May indicate legitimate network service discovery or reconnaissance activity.
  NIS is often targeted for information gathering about network resources.
type: detection
detection_id: 2100580
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete RPC portmap request structure for nisd?
    context: Understanding the RPC call structure reveals the specific service being queried and potential reconnaissance intent.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - src_ip
        - dst_ip
        - src_port
        - dst_port

  - question: What is the source system attempting this RPC portmap query?
    context: Identifying the source helps determine if this is legitimate network administration or external reconnaissance.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - src_ip
        - geoip.country_name
        - src_port

  # Type 2: Triage Assessment
  - question: Is this RPC portmap activity normal for this network segment?
    context: Legitimate network administration may require RPC service discovery for NIS management.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 111
        condition: selection
      fields:
        - src_ip
        - bytes_toserver
        - bytes_toclient

  - question: Does this activity align with documented network administration schedules?
    context: RPC portmap queries during business hours from internal systems may be legitimate maintenance.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 111
        condition: selection
      fields:
        - dst_ip
        - proto
        - flow_id

  # Type 3: Activity Context
  - question: What other RPC services has this source queried recently?
    context: Multiple RPC service queries may indicate systematic reconnaissance of available network services.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 111
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - bytes_toclient

  - question: What preceded this RPC portmap request in the network session?
    context: Understanding the session context helps determine if this is part of a larger reconnaissance campaign.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_port
        - dst_port
        - proto

  # Type 4: Impact Assessment
  - question: Did the target system respond to the nisd portmap request?
    context: A successful response indicates the NIS service is available and potentially vulnerable to exploitation.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
          src_port: 111
        condition: selection
      fields:
        - bytes_toserver
        - bytes_toclient
        - flow_id

  - question: Are there signs of follow-up connections to discovered NIS services?
    context: Successful portmap queries often lead to direct connections to the discovered services for exploitation.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - bytes_toserver
        - bytes_toclient

  # Type 5: Forensic Deep-Dive
  - question: What specific NIS service information was requested in the portmap query?
    context: Detailed analysis of the RPC call reveals the exact NIS service version and capabilities being probed.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "nisd request"
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - payload_printable
        - rule.name
        - severity

  - question: Are there indicators of automated scanning tools in the traffic patterns?
    context: Automated reconnaissance tools often have distinctive timing and payload patterns.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 111
            - 135
            - 139
            - 445
        condition: selection
      fields:
        - dst_port
        - dst_ip
        - proto

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network experiencing similar RPC portmap probes?
    context: Widespread RPC scanning may indicate a coordinated reconnaissance campaign across the enterprise.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "portmap"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is this part of a broader pattern of network service discovery attempts?
    context: RPC portmap queries combined with other service discovery may indicate comprehensive network mapping.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - "rpc-portmap-decode"
            - "network-scan"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.category