name: GPL RPC portmap rstatd request UDP
id: 22100583
description: |
  Detects RPC portmap requests for the remote statistics daemon (rstatd).
  May indicate legitimate system monitoring or reconnaissance for system information gathering.
  Rstatd provides detailed system statistics and can reveal sensitive system configuration data.
type: detection
detection_id: 2100583
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete RPC portmap request structure for rstatd?
    context: Understanding the RPC call structure reveals the specific statistics service being queried and information disclosure potential.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - src_ip
        - dst_ip
        - src_port
        - dst_port

  - question: What is the source system attempting this rstatd portmap query?
    context: Identifying the source helps determine if this is legitimate system monitoring or external reconnaissance.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - src_ip
        - geoip.country_name
        - src_port

  # Type 2: Triage Assessment
  - question: Is remote statistics monitoring expected from this source?
    context: Legitimate network monitoring systems may query rstatd services for performance metrics collection.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 111
        condition: selection
      fields:
        - src_ip
        - bytes_toserver
        - bytes_toclient

  - question: Does this align with documented system monitoring infrastructure?
    context: Known monitoring solutions would generate expected rstatd portmap queries during regular data collection cycles.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 111
        condition: selection
      fields:
        - dst_ip
        - proto
        - flow_id

  # Type 3: Activity Context
  - question: What other system information services has this source queried recently?
    context: Multiple system information service queries may indicate systematic reconnaissance for system profiling.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 111
            - 161
            - 162
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver

  - question: What preceded this rstatd portmap request in the reconnaissance sequence?
    context: Understanding the session context helps determine if this is part of a larger information gathering campaign.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_port
        - dst_port
        - proto

  # Type 4: Impact Assessment
  - question: Did the target system respond with rstatd service information?
    context: A successful response indicates system statistics services are available and may expose sensitive system data.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
          src_port: 111
        condition: selection
      fields:
        - bytes_toserver
        - bytes_toclient
        - flow_id

  - question: Are there signs of follow-up connections to discovered rstatd services?
    context: Successful portmap queries often lead to direct system statistics collection attempts.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - bytes_toserver
        - bytes_toclient

  # Type 5: Forensic Deep-Dive
  - question: What specific rstatd service capabilities were probed in the request?
    context: Detailed RPC analysis reveals the exact statistics service version and data types being targeted.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "rstatd request"
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - payload_printable
        - rule.name
        - severity

  - question: Are there patterns suggesting automated system profiling tools?
    context: Automated reconnaissance often exhibits systematic patterns across multiple information disclosure services.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 111
            - 161
            - 162
            - 515
        condition: selection
      fields:
        - dst_port
        - dst_ip
        - proto

  # Type 6: Enterprise Correlation
  - question: Are other systems experiencing similar rstatd portmap probes?
    context: Widespread statistics service scanning may indicate a coordinated information gathering campaign.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "rstatd request"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is this part of a broader system information discovery campaign?
    context: Rstatd queries combined with other information disclosure probes may indicate comprehensive system profiling.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - "rpc-portmap-decode"
            - "misc-activity"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.category