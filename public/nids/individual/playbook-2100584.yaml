name: GPL RPC portmap rusers request UDP
id: 22100584
description: |
  Detects RPC portmap requests for the remote users daemon (rusers).
  May indicate legitimate user monitoring or reconnaissance for user enumeration.
  Rusers service exposes detailed user session information and is commonly targeted for reconnaissance.
type: detection
detection_id: 2100584
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete RPC portmap request structure for rusers?
    context: Understanding the RPC call structure reveals the specific user enumeration service being queried and privacy implications.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - src_ip
        - dst_ip
        - src_port
        - dst_port

  - question: What is the source system attempting this rusers portmap query?
    context: Identifying the source helps determine if this is legitimate user monitoring or external user enumeration attempts.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - src_ip
        - geoip.country_name
        - src_port

  # Type 2: Triage Assessment
  - question: Is remote user monitoring authorized from this source?
    context: Legitimate system administration tools may query rusers services for user session management.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 111
        condition: selection
      fields:
        - src_ip
        - bytes_toserver
        - bytes_toclient

  - question: Does this align with documented user monitoring procedures?
    context: Scheduled user monitoring tasks would generate expected rusers portmap queries during administrative operations.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 111
        condition: selection
      fields:
        - dst_ip
        - proto
        - flow_id

  # Type 3: Activity Context
  - question: What other user enumeration services has this source queried recently?
    context: Multiple user enumeration service queries may indicate systematic reconnaissance for user information gathering.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 111
            - 139
            - 445
            - 389
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver

  - question: What preceded this rusers portmap request in the enumeration sequence?
    context: Understanding the session context helps determine if this is part of a larger user reconnaissance campaign.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_port
        - dst_port
        - proto

  # Type 4: Impact Assessment
  - question: Did the target system respond with rusers service availability information?
    context: A successful response indicates user enumeration services are available and may expose sensitive user session data.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
          src_port: 111
        condition: selection
      fields:
        - bytes_toserver
        - bytes_toclient
        - flow_id

  - question: Are there signs of follow-up connections to discovered rusers services?
    context: Successful portmap queries often lead to direct user enumeration attempts against the discovered services.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - bytes_toserver
        - bytes_toclient

  # Type 5: Forensic Deep-Dive
  - question: What specific rusers service capabilities were probed in the request?
    context: Detailed RPC analysis reveals the exact user enumeration service version and data types being targeted.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "rusers request"
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - payload_printable
        - rule.name
        - severity

  - question: Are there indicators of known user enumeration tools or techniques?
    context: Specific attack patterns can indicate the use of known user enumeration exploits or reconnaissance tools.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 111
            - 139
            - 445
            - 389
            - 636
        condition: selection
      fields:
        - dst_port
        - dst_ip
        - proto

  # Type 6: Enterprise Correlation
  - question: Are other systems experiencing similar rusers portmap reconnaissance?
    context: Widespread user enumeration scanning may indicate a coordinated attack against user information infrastructure.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "rusers request"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is this part of a broader user enumeration campaign across the enterprise?
    context: Rusers queries combined with other user enumeration probes may indicate comprehensive user reconnaissance.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - "rpc-portmap-decode"
            - "policy-violation"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.category