name: GPL RPC portmap sadmind request UDP
id: 22100585
description: |
  Detects RPC portmap requests for the sadmind service, often used in Solaris exploitation.
  The sadmind service has known vulnerabilities that allow remote code execution.
  Legitimate administration may query RPC services, but sadmind queries are often malicious.
type: detection
detection_id: 2100585
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact RPC portmap request structure for sadmind?
    context: RPC request analysis reveals exploitation technique and target service version.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - rule.name

  - question: What RPC program and version numbers were requested?
    context: Specific RPC identifiers reveal targeted vulnerabilities and exploitation methods.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_port
        - dst_port
        - proto

  # Type 2: Triage Assessment
  - question: Does this system legitimately run Solaris RPC services?
    context: Non-Solaris systems are not vulnerable to sadmind exploits, helping prioritize response.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 111
          proto: UDP
        condition: selection
      fields:
        - src_ip
        - flow.bytes_toclient
        - flow.pkts_toclient

  - question: Is this normal RPC service discovery for this network?
    context: Regular RPC queries from administrators help distinguish legitimate from malicious activity.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 111
          proto: UDP
        condition: selection
      fields:
        - dst_ip
        - flow.start
        - flow.bytes_toserver

  # Type 3: Activity Context
  - question: What network reconnaissance preceded this RPC portmap query?
    context: Port scans often precede targeted RPC service exploitation attempts.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto
        - flow.pkts_toserver

  - question: Are there other RPC service queries from the same source?
    context: Multiple RPC queries indicate systematic service enumeration for exploitation.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 111
          proto: UDP
        condition: selection
      fields:
        - dst_ip
        - flow.bytes_toserver
        - flow.bytes_toclient

  # Type 4: Impact Assessment
  - question: Did the portmap query receive a successful response?
    context: Successful responses reveal active RPC services that may be vulnerable to exploitation.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
          src_port: 111
          proto: UDP
        condition: selection
      fields:
        - flow.bytes_toserver
        - flow.pkts_toserver
        - flow.duration

  - question: Are there follow-up connections to discovered RPC services?
    context: Direct service connections after portmap queries indicate exploitation attempts.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - proto
        - flow.bytes_toserver
        - flow.start

  # Type 5: Forensic Deep-Dive
  - question: What RPC services are actually running on the target system?
    context: Active RPC services determine actual vulnerability exposure and exploitation risk.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          process.name|contains:
            - rpcbind
            - portmap
            - sadmind
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.executable
        - user.name

  - question: Are there signs of successful sadmind exploitation?
    context: Process creation or system changes indicate successful RPC service compromise.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - user.name

  # Type 6: Enterprise Correlation
  - question: Are other Unix/Solaris systems receiving similar RPC portmap queries?
    context: Multiple targets indicate coordinated Unix exploitation campaign requiring system hardening.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: "GPL RPC portmap sadmind request UDP"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.timestamp

  - question: Is this part of a broader Unix/Linux exploitation campaign?
    context: Multiple Unix exploits indicate advanced persistent threat targeting enterprise infrastructure.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - RPC
            - Unix
            - Solaris
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - alert.category