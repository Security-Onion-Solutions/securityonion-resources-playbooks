name: GPL RPC portmap selection_svc request UDP
id: 22100586
description: |
  Detects RPC portmap selection_svc service requests from external sources.
  May indicate reconnaissance activity or legitimate RPC service discovery.
type: detection
detection_id: 2100586
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact RPC portmap selection_svc request payload?
    context: Understanding the RPC request structure reveals the specific service being queried.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - packet

  - question: What RPC program and version was requested in the portmap query?
    context: RPC requests contain program numbers that identify specific services being targeted.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rpc.program
        - rpc.version
        - rpc.procedure

  # Type 2: Triage Assessment
  - question: Is this source IP authorized to perform RPC discovery on this network?
    context: Legitimate system administrators may use RPC tools for service discovery and management.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 111
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - bytes_toclient

  - question: Does this activity align with normal business hours and operations?
    context: RPC service discovery during off-hours may indicate unauthorized reconnaissance.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature_id: 2100586
        condition: selection
      fields:
        - src_ip
        - dst_ip

  # Type 3: Activity Context
  - question: What other RPC portmap queries occurred from this source?
    context: Multiple portmap queries may indicate systematic service enumeration.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.category|contains:
            - "rpc-portmap-decode"
        condition: selection
      fields:
        - alert.signature
        - dst_ip
        - dst_port

  - question: What network connections preceded this RPC request?
    context: Understanding the connection sequence helps identify the attack vector or legitimate workflow.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - proto
        - conn_state
        - bytes_toserver

  # Type 4: Impact Assessment
  - question: Were any RPC services successfully contacted after this portmap query?
    context: Successful portmap queries may lead to direct service exploitation attempts.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - conn_state
        - service
        - bytes_toclient

  - question: Are there signs of successful RPC service exploitation?
    context: Portmap queries often precede attempts to exploit vulnerable RPC services.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.category|contains:
            - "rpc"
            - "exploit"
        condition: selection
      fields:
        - alert.signature
        - dst_ip
        - alert.severity

  # Type 5: Forensic Deep-Dive
  - question: What specific selection_svc functionality was being probed?
    context: The selection_svc service has specific vulnerabilities that attackers may target.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rpc.auth_type
        - rpc.auth_flavor
        - packet_info

  - question: Are there indicators of automated RPC scanning tools?
    context: Automated tools have specific timing patterns and request sequences.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.category: "rpc-portmap-decode"
        condition: selection
      fields:
        - alert.signature
        - dst_ip

  # Type 6: Enterprise Correlation
  - question: Are other systems receiving similar RPC portmap queries?
    context: Widespread RPC scanning may indicate a coordinated reconnaissance campaign.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature_id: 2100586
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature