name: GPL RPC portmap status request UDP
id: 22100587
description: |
  Detects RPC portmap status requests from external sources.
  May indicate reconnaissance activity or legitimate RPC service monitoring.
type: detection
detection_id: 2100587
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact RPC portmap status request payload?
    context: Status requests reveal information about available RPC services and their current state.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - packet

  - question: What RPC status information was being requested?
    context: Different status queries reveal varying levels of system information to attackers.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rpc.program
        - rpc.version
        - rpc.procedure

  # Type 2: Triage Assessment
  - question: Is this source authorized to query RPC service status?
    context: System administrators may legitimately check RPC service status for monitoring.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 111
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - bytes_toclient

  - question: Does this status check align with scheduled monitoring activities?
    context: Regular monitoring systems should show predictable patterns and timing.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature_id: 2100587
        condition: selection
      fields:
        - src_ip
        - dst_ip

  # Type 3: Activity Context
  - question: What other RPC portmap queries preceded this status request?
    context: Status requests often follow service discovery in reconnaissance phases.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.category: "rpc-portmap-decode"
        condition: selection
      fields:
        - alert.signature
        - dst_ip
        - dst_port

  - question: What network scanning activity occurred before this request?
    context: RPC status checks typically follow initial port discovery and enumeration.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - proto
        - conn_state

  # Type 4: Impact Assessment
  - question: What RPC services were revealed by the status response?
    context: Status responses expose available services that may become exploitation targets.
    range: +15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - service
        - bytes_toclient

  - question: Were any discovered RPC services subsequently targeted?
    context: Successful status queries often lead to direct service exploitation attempts.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.category|contains:
            - "rpc"
            - "exploit"
        condition: selection
      fields:
        - alert.signature
        - dst_ip
        - alert.severity

  # Type 5: Forensic Deep-Dive
  - question: What specific status information was extracted from the response?
    context: RPC status responses contain detailed service and version information valuable to attackers.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rpc.auth_type
        - rpc.call_id
        - packet_info

  - question: Are there patterns indicating automated RPC enumeration tools?
    context: Automated tools have characteristic timing and query sequences for RPC discovery.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.category: "rpc-portmap-decode"
        condition: selection
      fields:
        - alert.signature
        - dst_ip

  - question: What user-agent or tool signatures are present in the traffic?
    context: RPC scanning tools may leave identifying characteristics in network traffic.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - proto
        - service
        - conn_state

  # Type 6: Enterprise Correlation
  - question: Are other systems receiving similar RPC status queries?
    context: Widespread RPC status checking may indicate network-wide reconnaissance.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature_id: 2100587
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature