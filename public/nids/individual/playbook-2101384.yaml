name: GPL MISC UPnP malformed advertisement
id: 22101384
description: |
  Detects malformed UPnP NOTIFY advertisements that may exploit CVE-2001-0876 and CVE-2001-0877.
  These vulnerabilities in Windows UPnP can lead to denial of service or remote code execution.
  Legitimate UPnP devices should send properly formatted NOTIFY messages.
type: detection
detection_id: 2101384
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What specific malformation was detected in the UPnP NOTIFY message?
    context: Understanding the malformation type reveals the exploitation technique and vulnerability targeted.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - rule.name

  - question: What was the complete structure of the malformed NOTIFY packet?
    context: Full packet analysis reveals crafted headers and potential shellcode patterns.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - flow.bytes_toserver
        - flow.pkts_toserver
        - src_port
        - dst_port

  # Type 2: Triage Assessment
  - question: Are there legitimate UPnP devices on this network segment?
    context: Networks without UPnP devices make this clearly malicious rather than misconfigured equipment.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_port: 1900
          proto: UDP
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - flow.bytes_toserver

  - question: Is this source IP known to send legitimate UPnP traffic?
    context: Previous legitimate UPnP activity from same source suggests device misconfiguration vs attack.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 1900
          proto: UDP
        condition: selection
      fields:
        - dst_ip
        - flow.start
        - flow.bytes_toserver

  # Type 3: Activity Context
  - question: What network reconnaissance preceded this malformed advertisement?
    context: Port scans or service discovery often precede targeted UPnP exploitation attempts.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto
        - flow.pkts_toserver

  - question: Are there other malformed protocol messages from this source?
    context: Multiple protocol violations indicate systematic attack rather than equipment failure.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: malformed
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - alert.category

  # Type 4: Impact Assessment
  - question: Did the malformed advertisement cause service disruption?
    context: Successful denial of service attacks require immediate service restoration efforts.
    range: +15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 1900
        condition: selection
      fields:
        - src_ip
        - flow.bytes_toclient
        - flow.pkts_toclient

  - question: Are there signs of successful code execution on the target?
    context: Process creation following the attack indicates successful remote code execution.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - process.name
        - process.command_line
        - process.parent.name
        - user.name

  # Type 5: Forensic Deep-Dive
  - question: What Windows UPnP components are vulnerable on the target system?
    context: Identifying vulnerable components helps prioritize patching and containment efforts.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          process.name|contains:
            - svchost.exe
            - upnphost
            - ssdpsrv
        condition: selection
      fields:
        - process.command_line
        - process.executable
        - process.version

  - question: Are there system crashes or service failures following the attack?
    context: Service disruptions indicate successful denial of service requiring system recovery.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          process.name|contains:
            - werfault.exe
            - drwtsn32.exe
        condition: selection
      fields:
        - process.command_line
        - process.parent.name
        - user.name

  # Type 6: Enterprise Correlation
  - question: Are multiple Windows systems receiving similar malformed UPnP advertisements?
    context: Widespread targeting indicates coordinated attack requiring network-wide response.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: "GPL MISC UPnP malformed advertisement"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.timestamp

  - question: Is this part of a broader Windows vulnerability exploitation campaign?
    context: Multiple Windows exploits indicate advanced persistent threat requiring comprehensive response.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - Windows
            - Microsoft
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - alert.category