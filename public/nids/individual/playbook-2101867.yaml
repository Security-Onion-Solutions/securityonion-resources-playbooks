name: GPL RPC xdmcp info query
id: 22101867
description: |
  Detects XDMCP (X Display Manager Control Protocol) information queries on port 177.
  May indicate legitimate remote X11 display management or reconnaissance activity.
  XDMCP is commonly used for thin client environments but can expose system information.
type: detection
detection_id: 2101867
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact XDMCP query packet content detected?
    context: Understanding the specific XDMCP query type reveals the information being requested.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - rule.name
        - event.severity

  - question: What network connection details were involved in this XDMCP query?
    context: Connection metadata helps identify the source and target of the reconnaissance attempt.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_port
        - dst_port
        - network.protocol

  # Type 2: Triage Assessment
  - question: Is this XDMCP activity part of legitimate thin client operations?
    context: XDMCP is commonly used in enterprise environments for remote desktop access.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 177
        condition: selection
      fields:
        - dst_ip
        - network.bytes
        - network.packets

  - question: Does this source IP have a history of X11 or remote desktop activity?
    context: Legitimate XDMCP usage typically shows consistent patterns from known workstations.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 177
            - 6000
            - 6001
            - 6002
        condition: selection
      fields:
        - dst_ip
        - dst_port

  # Type 3: Activity Context
  - question: What other network reconnaissance occurred from this source around the same time?
    context: XDMCP queries are often part of broader network scanning campaigns.
    range: -15m/+15m
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - "attempted-recon"
            - "network-scan"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - dst_port

  - question: What was the sequence of network connections from this source?
    context: Understanding connection patterns helps identify if this is targeted reconnaissance.
    range: -30m/+30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.protocol
        - network.bytes

  # Type 4: Impact Assessment
  - question: Did the XDMCP server respond with system information?
    context: Successful XDMCP queries can reveal display manager details and available sessions.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
          src_port: 177
        condition: selection
      fields:
        - network.bytes
        - network.packets

  - question: Are there signs of successful X11 session establishment following this query?
    context: XDMCP queries may precede actual X11 display connections on ports 6000+.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 6000
            - 6001
            - 6002
            - 6003
        condition: selection
      fields:
        - dst_port
        - network.bytes

  # Type 5: Forensic Deep-Dive
  - question: What specific XDMCP display managers are running on the target system?
    context: Identifying the display manager type helps assess the potential information disclosure.
    range: -1h/+1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 177
        condition: selection
      fields:
        - src_ip
        - network.bytes
        - network.packets

  - question: Are there indicators of automated scanning tools in the traffic patterns?
    context: Automated tools often show distinctive timing and packet patterns.
    range: -1h/+1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.protocol

  # Type 6: Enterprise Correlation
  - question: Are other systems receiving similar XDMCP queries from this source?
    context: Widespread XDMCP scanning indicates a reconnaissance campaign across the network.
    range: -1h/+1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "xdmcp"
        condition: selection
      fields:
        - dst_ip
        - rule.name

  - question: Is this part of a broader RPC service enumeration campaign?
    context: XDMCP queries often accompany other RPC-based reconnaissance activities.
    range: -2h/+2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category: "rpc-portmap-decode"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - dst_port