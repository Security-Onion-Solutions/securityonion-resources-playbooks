name: GPL FTP SITE CPWD overflow attempt
id: 22101888
description: |
  Detects buffer overflow exploitation attempts against FTP servers via the SITE CPWD command.
  This targets CVE-2002-0826 which can lead to remote code execution through excessive parameter length.
  May trigger on legitimate FTP administration with unusually long directory paths.
type: detection
detection_id: 2101888
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact SITE CPWD command and parameter length?
    context: Understanding the command structure and parameter size reveals exploitation technique and payload characteristics.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - alert.signature

  - question: What FTP server software and version is running on the target?
    context: CVE-2002-0826 affects specific FTP server implementations, helping assess vulnerability exposure.
    range: -5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 21
        condition: selection
      fields:
        - src_ip
        - dst_port
        - proto
        - service_banner

  # Type 2: Triage Assessment
  - question: Is this user authorized to perform FTP SITE administration commands?
    context: SITE commands require administrative privileges, helping distinguish legitimate administration from attacks.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 21
        condition: selection
      fields:
        - proto
        - bytes_in
        - bytes_out
        - duration

  - question: Has this source IP successfully authenticated to the FTP server before?
    context: Previous successful FTP authentication may indicate legitimate administrative access versus external attack.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          alert.signature|contains:
            - FTP
            - login
        condition: selection
      fields:
        - alert.signature
        - dst_port

  # Type 3: Activity Context
  - question: What FTP authentication attempts preceded this SITE CPWD exploit?
    context: Understanding login patterns helps identify brute force attacks followed by exploitation attempts.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          alert.signature|contains:
            - FTP
        condition: selection
      fields:
        - alert.signature
        - dst_port

  - question: What was the sequence of FTP commands leading to the overflow attempt?
    context: Understanding command progression reveals automated tool usage versus manual exploitation attempts.
    range: -15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 21
        condition: selection
      fields:
        - proto
        - bytes_in
        - bytes_out
        - duration

  - question: What network scanning or service enumeration preceded this attack?
    context: FTP exploits often follow port scanning to identify vulnerable FTP server implementations.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.category|contains:
            - scan
            - recon
        condition: selection
      fields:
        - alert.signature
        - dst_ip
        - dst_port

  # Type 4: Impact Assessment
  - question: Did the FTP server respond normally after the overflow attempt?
    context: Server response patterns indicate if the exploit was successful or if the service crashed.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
          src_port: 21
        condition: selection
      fields:
        - bytes_in
        - bytes_out
        - duration
        - conn_state

  - question: Are there signs of successful code execution following the FTP exploit?
    context: Successful buffer overflow exploits may lead to shell access or file system manipulation.
    range: +15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 22
            - 23
            - 1234
            - 4444
            - 8080
        condition: selection
      fields:
        - src_ip
        - dst_port
        - proto
        - bytes_in
        - bytes_out

  # Type 5: Forensic Deep-Dive
  - question: What specific buffer overflow payload characteristics are present in the SITE CPWD command?
    context: CVE-2002-0826 exploits involve specific memory layout manipulation through excessive parameter length.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - flow_id

  - question: Are there additional FTP service exploitation attempts from this source?
    context: Attackers often target multiple FTP vulnerabilities once a server is identified as potentially vulnerable.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains:
            - FTP
            - overflow
            - exploit
        condition: selection
      fields:
        - alert.signature
        - dst_ip
        - dst_port

  # Type 6: Enterprise Correlation
  - question: Are other FTP servers in the network targeted with similar overflow exploits?
    context: Automated FTP exploitation tools often scan entire network ranges for vulnerable servers.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature: "GPL FTP SITE CPWD overflow attempt"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port