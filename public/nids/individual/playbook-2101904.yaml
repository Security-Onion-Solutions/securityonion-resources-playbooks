name: GPL IMAP find overflow attempt
id: 22101904
description: |
  Detects potential buffer overflow attempts against IMAP servers via the FIND command.
  This targets CVE-2000-0284, a vulnerability in various IMAP implementations where
  excessively long search parameters in FIND commands can cause buffer overflows.
  May trigger on legitimate IMAP search operations with very long search criteria.
type: detection
detection_id: 2101904
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact IMAP FIND command and search parameters that triggered the overflow detection?
    context: Analyzing the complete command reveals the exploitation attempt and search criteria used.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - rule.name

  - question: What is the length and content of the suspicious search parameter?
    context: Buffer overflow exploits require specific payload lengths and may contain shellcode.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - flow.bytes_toserver
        - alert.signature

  # Type 2: Triage Assessment
  - question: Is this user authenticated and authorized to perform IMAP FIND operations?
    context: Legitimate users may have complex searches, but unauthenticated attempts are suspicious.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 143
        condition: selection
      fields:
        - flow.bytes_toclient
        - flow.bytes_toserver
        - conn_state

  - question: Does this source IP have a history of legitimate IMAP search usage?
    context: Established email users rarely trigger buffer overflow conditions in normal searches.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 143
        condition: selection
      fields:
        - flow.bytes_toserver
        - flow.bytes_toclient
        - conn_state

  # Type 3: Activity Context
  - question: What IMAP authentication and session activity preceded this FIND attempt?
    context: Understanding the session context reveals if this follows normal IMAP workflow.
    range: -15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 143
        condition: selection
      fields:
        - flow.pkts_toserver
        - flow.pkts_toclient
        - conn_state

  - question: Were there reconnaissance attempts or other IMAP exploits from this source?
    context: IMAP exploits are often preceded by service enumeration and vulnerability probing.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - "misc-attack"
            - "protocol-command-decode"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - dst_port

  - question: What was the complete IMAP session flow and command sequence leading to FIND?
    context: Buffer overflow attempts often follow specific command sequences to prepare the target.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - flow.bytes_toserver
        - flow.bytes_toclient
        - flow.pkts_toserver
        - flow.pkts_toclient

  # Type 4: Impact Assessment
  - question: How did the IMAP server respond to the buffer overflow attempt?
    context: Server response patterns indicate if the vulnerability exists and was successfully exploited.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
          src_port: 143
        condition: selection
      fields:
        - flow.bytes_toclient
        - conn_state
        - flow.reason

  - question: Are there signs of successful code execution or system compromise?
    context: Successful buffer overflows may lead to shell access or backdoor installation.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - app_proto
        - conn_state

  # Type 5: Forensic Deep-Dive
  - question: Does the payload contain shellcode or executable content patterns?
    context: IMAP buffer overflow exploits typically include shellcode for remote code execution.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - flow.bytes_toserver

  - question: What is the source IP's attack profile and geolocation?
    context: IMAP exploits often originate from known malicious infrastructure or compromised systems.
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category: "misc-attack"
        condition: selection
      fields:
        - src_ip
        - geoip.country_name
        - rule.name

  - question: Is this a known CVE-2000-0284 exploit variant targeting FIND commands?
    context: Identifying the specific exploit helps determine the attacker's sophistication and tools.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "IMAP"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - alert.signature

  # Type 6: Enterprise Correlation
  - question: Are other IMAP servers being targeted with similar buffer overflow attempts?
    context: Coordinated IMAP attacks indicate a campaign targeting email infrastructure.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "IMAP"
          rule.category: "misc-attack"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is this part of broader email infrastructure reconnaissance or attack campaign?
    context: IMAP exploits are often part of campaigns targeting email servers and user credentials.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 25
            - 110
            - 143
            - 993
            - 995
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - dst_port