name: GPL RPC portmap proxy attempt UDP
id: 22101923
description: |
  Detects potential RPC portmapper proxy attempts via UDP on port 111.
  The portmapper service maps RPC program numbers to network ports. This alert
  triggers on specific RPC call patterns that may indicate reconnaissance or
  exploitation attempts. May trigger on legitimate RPC service discovery.
type: detection
detection_id: 2101923
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact RPC portmapper request structure detected?
    context: Analyzing the RPC call reveals the specific program being queried and potential malicious intent.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - rule.name

  - question: What RPC program number was being queried through the portmapper?
    context: The specific RPC program reveals what service the attacker is trying to locate.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - alert.signature
        - flow.bytes_toserver
        - proto

  # Type 2: Triage Assessment
  - question: Is RPC portmapper service legitimately configured on this system?
    context: Modern systems rarely run portmapper service, making this activity suspicious.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 111
          proto: UDP
        condition: selection
      fields:
        - src_ip
        - conn_state
        - flow.bytes_toclient

  - question: Are there legitimate RPC services running that would require portmapper queries?
    context: NFS, NIS, and other RPC services may generate legitimate portmapper traffic.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 111
            - 2049
            - 4045
        condition: selection
      fields:
        - src_ip
        - dst_port
        - app_proto

  # Type 3: Activity Context
  - question: What network reconnaissance activity preceded this portmapper query?
    context: Portmapper queries are often part of broader RPC service enumeration.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - proto
        - conn_state
        - flow.pkts_toserver

  - question: Were there port scans targeting RPC-related services from this source?
    context: Attackers often scan for RPC services before querying the portmapper.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - "scan"
            - "recon"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - dst_port

  - question: What was the sequence of RPC-related network activity?
    context: Understanding the attack progression helps determine the attacker's objectives.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.category: "rpc-portmap-decode"
        condition: selection
      fields:
        - rule.name
        - timestamp

  # Type 4: Impact Assessment
  - question: Did the portmapper service respond with RPC service mappings?
    context: Response data reveals what RPC services are exposed and potentially vulnerable.
    range: +2m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
          src_port: 111
          proto: UDP
        condition: selection
      fields:
        - flow.bytes_toclient
        - conn_state

  - question: Were any RPC services subsequently accessed after portmapper enumeration?
    context: Successful enumeration often leads to direct attacks on discovered RPC services.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 2049
            - 4045
            - 32771
        condition: selection
      fields:
        - dst_port
        - app_proto
        - flow.bytes_toserver

  # Type 5: Forensic Deep-Dive
  - question: What is the attack pattern and source IP reputation profile?
    context: RPC reconnaissance often originates from known malicious infrastructure.
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category: "rpc-portmap-decode"
        condition: selection
      fields:
        - src_ip
        - geoip.country_name
        - rule.name

  - question: Does this appear to be automated RPC service discovery or targeted reconnaissance?
    context: The timing and pattern of requests indicates whether this is automated scanning or focused attack.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 111
        condition: selection
      fields:
        - dst_ip
        - flow.pkts_toserver
        - conn_state

  # Type 6: Enterprise Correlation
  - question: Are other systems experiencing similar RPC portmapper reconnaissance?
    context: Coordinated RPC enumeration indicates a campaign targeting RPC services.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.category: "rpc-portmap-decode"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is this part of broader infrastructure reconnaissance targeting legacy services?
    context: RPC enumeration is often part of campaigns targeting older Unix/Linux systems.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - "rpc"
            - "misc-attack"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.category