name: GPL RPC tooltalk UDP overflow attempt
id: 22101964
description: |
  Detects potential buffer overflow attempts against the ToolTalk RPC service via UDP.
  ToolTalk is a legacy message passing service on Unix systems. This alert triggers on
  specific byte patterns indicating exploitation attempts. May trigger on legitimate
  ToolTalk communications with large message payloads.
type: detection
detection_id: 2101964
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete UDP payload that triggered the ToolTalk overflow detection?
    context: Analyzing the full payload reveals the exact exploitation attempt and target service.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - rule.name

  - question: What specific byte patterns were detected in the RPC call structure?
    context: The rule looks for specific RPC program identifiers and buffer size indicators.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - alert.signature
        - flow.bytes_toserver
        - flow.bytes_toclient

  # Type 2: Triage Assessment
  - question: Is ToolTalk service legitimately running on the target system?
    context: ToolTalk is a legacy service rarely used in modern environments, making this likely malicious.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          proto: UDP
        condition: selection
      fields:
        - src_ip
        - dst_port
        - app_proto

  - question: Has this source IP attempted similar RPC exploitation patterns recently?
    context: Multiple RPC exploit attempts indicate coordinated attack activity.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category: "RPC"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - dst_port

  # Type 3: Activity Context
  - question: What other network activity preceded this RPC exploitation attempt?
    context: Attackers often perform reconnaissance before targeting specific RPC services.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - proto
        - app_proto
        - conn_state

  - question: Were there any port scans or RPC enumeration attempts from this source?
    context: RPC exploits are often preceded by portmapper queries and service enumeration.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - "scan"
            - "recon"
            - "portmap"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - dst_port

  # Type 4: Impact Assessment
  - question: Did the target system respond to the ToolTalk exploitation attempt?
    context: Response patterns indicate if the service is running and potentially vulnerable.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
          proto: UDP
        condition: selection
      fields:
        - flow.bytes_toserver
        - flow.bytes_toclient
        - conn_state

  - question: Are there signs of successful RPC service compromise or code execution?
    context: Successful exploitation may lead to follow-up commands or backdoor installation.
    range: +15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - proto
        - app_proto

  # Type 5: Forensic Deep-Dive
  - question: What is the source IP's reputation and geolocation profile?
    context: ToolTalk exploits often originate from known malicious infrastructure.
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - src_ip
        - geoip.country_name
        - rule.category

  - question: Does the payload contain shellcode or executable content patterns?
    context: Buffer overflow exploits typically include shellcode for remote code execution.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - flow.bytes_toserver

  # Type 6: Enterprise Correlation
  - question: Are other internal systems being targeted with similar RPC exploits?
    context: Attackers often target multiple systems with the same exploit technique.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "RPC"
          rule.category: "misc-attack"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is this part of a broader campaign targeting legacy Unix services?
    context: ToolTalk exploits are often part of campaigns targeting older Unix/Linux systems.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - "rpc"
            - "misc-attack"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.category