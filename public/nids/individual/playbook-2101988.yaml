name: GPL CHAT MSN outbound file transfer accept
id: 22101988
description: |
  Detects MSN Messenger file transfer acceptance responses indicating successful file transfer initiation.
  May represent policy violations or successful data exfiltration via instant messaging.
type: detection
detection_id: 2101988
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the original file transfer request that was accepted?
    context: Understanding the initial request helps identify what data is being transferred.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          community_id|expand: '%community_id%'
          alert.signature: "GPL CHAT MSN outbound file transfer request"
        condition: selection
      fields:
        - alert.signature
        - src_ip
        - dst_ip
        - payload_printable

  - question: Is this file transfer acceptance from an authorized recipient?
    context: Verifying the recipient helps determine if the transfer violates data sharing policies.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          src_port: 1863
          proto: TCP
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - bytes_toserver
        - bytes_toclient

  - question: What is the current status of the file transfer session?
    context: Active transfers indicate ongoing data movement that may need to be blocked.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - bytes_toserver
        - bytes_toclient
        - proto

  - question: How much data has been transferred following the acceptance?
    context: Transfer volume helps assess the scope of potential data loss or policy violation.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
          proto: TCP
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - bytes_toserver
        - bytes_toclient

  - question: Are there multiple file transfers being accepted in this session?
    context: Multiple transfers may indicate bulk data exfiltration or systematic policy violations.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
          alert.signature|contains:
            - "MSN"
            - "file transfer"
        condition: selection
      fields:
        - alert.signature
        - src_ip
        - dst_ip
        - alert.severity

  - question: What applications are running on the system receiving the files?
    context: Understanding the recipient's environment helps assess data handling and security risks.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - "msnmsgr"
            - "messenger"
            - "msn"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessId

  - question: Are there signs of automated or scripted file transfer operations?
    context: Automated transfers may indicate malware exfiltration rather than manual user activity.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - "script"
            - "powershell"
            - "cmd"
            - "wscript"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessId

  - question: What other instant messaging activity is occurring on this connection?
    context: Understanding the full IM session helps determine if transfers are part of normal communication.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          alert.signature|contains: "MSN"
        condition: selection
      fields:
        - alert.signature
        - src_ip
        - dst_ip
        - alert.severity

  - question: Are there attempts to establish alternative transfer channels?
    context: Users may attempt multiple methods to ensure successful file transfer completion.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 80
            - 443
            - 21
            - 22
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - proto

  - question: What is the pattern of MSN file transfer activity across the organization?
    context: Enterprise-wide transfer patterns help identify coordinated data exfiltration campaigns.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains:
            - "MSN outbound file transfer request"
            - "MSN outbound file transfer accept"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature

  - question: Are there concurrent data loss prevention alerts for this user?
    context: DLP alerts may provide additional context about the sensitivity of transferred data.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains:
            - "DLP"
            - "data loss"
            - "sensitive"
        condition: selection
      fields:
        - alert.signature
        - src_ip
        - dst_ip
        - alert.severity