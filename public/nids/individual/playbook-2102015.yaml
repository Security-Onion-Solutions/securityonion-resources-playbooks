name: GPL RPC portmap UNSET attempt UDP 111
id: 22102015
description: |
  Detects RPC portmap UNSET attempts on UDP port 111 from external networks.
  May indicate reconnaissance or attempts to disable RPC services, but could also be legitimate administrative activity.
type: detection
detection_id: 2102015
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete RPC portmap UNSET request payload?
    context: Understanding the exact RPC call structure reveals the specific service being targeted for removal.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - src_ip
        - dst_ip
        - src_port
        - dst_port

  - question: Is this RPC UNSET request from an authorized administrator?
    context: Legitimate system administrators may need to remove RPC service mappings during maintenance.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 111
          proto: UDP
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - bytes_toserver
        - bytes_toclient

  - question: What other RPC portmap activity preceded this UNSET attempt?
    context: Attackers often enumerate RPC services before attempting to disable them.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 111
          proto: UDP
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - bytes_toserver
        - bytes_toclient
        - community_id

  - question: What RPC services are currently registered on this portmapper?
    context: Understanding available services helps assess the impact of UNSET operations.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          alert.signature|contains: "RPC"
        condition: selection
      fields:
        - alert.signature
        - src_ip
        - dst_ip
        - alert.severity

  - question: Has the portmapper service been successfully compromised?
    context: Successful UNSET operations may indicate service disruption or preparation for further attacks.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_port: 111
          proto: UDP
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - bytes_toserver
        - bytes_toclient

  - question: What processes are accessing RPC services on the target system?
    context: Understanding local RPC usage helps determine the impact of service disruption.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - "rpcbind"
            - "portmap"
            - "rpc"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessId

  - question: Are there signs of RPC-based lateral movement attempts?
    context: RPC services are commonly used for lateral movement in enterprise environments.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 135
            - 445
            - 2049
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - proto
        - community_id

  - question: What authentication attempts occurred around this RPC activity?
    context: Failed authentication may indicate brute force attempts following service enumeration.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains:
            - "authentication"
            - "login"
            - "brute"
        condition: selection
      fields:
        - alert.signature
        - src_ip
        - dst_ip
        - alert.severity

  - question: Has this source IP targeted other RPC services in the network?
    context: Widespread RPC scanning indicates reconnaissance for vulnerable services.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 111
            - 135
            - 2049
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - proto

  - question: Are other systems showing similar RPC portmap UNSET attempts?
    context: Coordinated attacks may target multiple RPC services across the enterprise.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature: "GPL RPC portmap UNSET attempt UDP 111"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature