name: GPL ATTACK_RESPONSE ISAKMP Login Failed
id: 22102043
description: |
  Detects ISAKMP (Internet Security Association and Key Management Protocol) login failure responses.
  May indicate failed VPN authentication attempts or legitimate authentication failures.
type: detection
detection_id: 2102043
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact ISAKMP payload that triggered this alert?
    context: Understanding the specific ISAKMP message structure reveals the nature of the authentication failure.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - alert.signature

  - question: What UDP port 500 traffic patterns exist between these hosts?
    context: ISAKMP uses UDP port 500 for key exchange negotiations and authentication.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 500
          proto: UDP
        condition: selection
      fields:
        - src_port
        - bytes_toserver
        - bytes_toclient

  # Type 2: Triage Assessment
  - question: Is this part of normal VPN authentication activity for this user?
    context: Legitimate VPN users may experience authentication failures due to credential issues.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 500
          proto: UDP
        condition: selection
      fields:
        - dst_ip
        - flow.start
        - duration

  - question: Are there successful ISAKMP negotiations from this source?
    context: Mixed success/failure patterns may indicate legitimate user issues versus attack attempts.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 500
          proto: UDP
        condition: selection
      fields:
        - dst_ip
        - flow.state
        - bytes_toserver

  # Type 3: Activity Context
  - question: What preceded this ISAKMP authentication failure?
    context: Understanding the sequence of ISAKMP exchanges reveals attack methodology.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 500
        condition: selection
      fields:
        - flow.start
        - bytes_toserver
        - bytes_toclient

  - question: What other network activity occurred from this source around the same time?
    context: Concurrent network activity may reveal broader reconnaissance or attack patterns.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - proto
        - app_proto

  # Type 4: Impact Assessment
  - question: Has this source successfully established any VPN connections?
    context: Successful connections after failures may indicate credential compromise or brute force success.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 500
          flow.state: established
        condition: selection
      fields:
        - dst_ip
        - duration
        - bytes_toserver
        - bytes_toclient

  - question: Are there signs of successful authentication or data transfer?
    context: Large data transfers after authentication attempts may indicate successful compromise.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - bytes_toclient
        - duration

  # Type 5: Forensic Deep-Dive
  - question: What is the frequency and pattern of these ISAKMP failures?
    context: High frequency failures may indicate automated brute force attacks against VPN infrastructure.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains: "isakmp login failed"
        condition: selection
      fields:
        - dst_ip
        - alert.signature_id

  - question: What geolocation and reputation data exists for this source?
    context: Geographic analysis helps determine if this is expected user behavior or external attack.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - src_ip
        - geoip.country_name
        - geoip.city_name

  # Type 6: Enterprise Correlation
  - question: Are other systems experiencing similar ISAKMP authentication failures?
    context: Multiple targets may indicate coordinated VPN infrastructure attacks.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: "isakmp login failed"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature_id

  - question: Is this part of broader VPN or authentication-related alerts across the enterprise?
    context: Correlating with other authentication failures reveals campaign scope and targets.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.category|contains:
            - "authentication"
            - "vpn"
            - "login"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature