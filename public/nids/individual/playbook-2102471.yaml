name: GPL NETBIOS SMB-DS C$ Share Access
id: 22102471
description: |
  Detects access attempts to the Windows C$ administrative share via SMB.
  May indicate legitimate administrative activity or potential lateral movement attempts.
  C$ provides access to the system drive root and is commonly targeted for file operations.
type: detection
detection_id: 2102471
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete SMB transaction attempting to access C$ share?
    context: Understanding the full SMB request reveals the specific access pattern and intended operations.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - smb.command
        - smb.path
        - smb.service
        - payload_printable

  - question: What source system initiated the C$ share access attempt?
    context: Identifying the source helps determine if this is authorized administrative activity or potential attack.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - src_port
        - dst_ip
        - dst_port

  # Type 2: Triage Assessment
  - question: Is this source IP authorized for C$ administrative share access?
    context: Legitimate C$ access typically comes from known backup systems, deployment tools, or admin workstations.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 445
        condition: selection
      fields:
        - dst_ip
        - connection_count

  - question: Does this activity align with scheduled backup or deployment operations?
    context: C$ access during maintenance windows may be legitimate system administration or backup operations.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - "SMB"
            - "share"
        condition: selection
      fields:
        - src_ip
        - rule.name

  # Type 3: Activity Context
  - question: What other administrative shares were accessed from this source?
    context: Multiple share access attempts reveal reconnaissance patterns or legitimate administrative workflows.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: "share"
        condition: selection
      fields:
        - rule.name
        - smb.path
        - smb.service

  - question: Was successful authentication established before C$ access attempt?
    context: Authentication context reveals whether access attempt follows legitimate logon or credential attack.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - "authentication"
            - "login"
            - "logon"
        condition: selection
      fields:
        - rule.name
        - event.outcome
        - user.name

  # Type 4: Impact Assessment
  - question: Did the C$ share access attempt succeed and what files were accessed?
    context: Successful C$ access allows full file system access and potential data exfiltration or malware deployment.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - "file"
            - "read"
            - "write"
        condition: selection
      fields:
        - rule.name
        - file.path
        - smb.response.status

  - question: Were any executables or sensitive files accessed through C$ share?
    context: Executable or sensitive file access indicates potential malware deployment or data theft.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetFilename|contains:
            - ".exe"
            - ".dll"
            - ".bat"
            - ".ps1"
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessName
        - file.size

  # Type 5: Forensic Deep-Dive
  - question: What specific directories were enumerated or accessed via C$ share?
    context: Directory access patterns reveal attacker objectives and reconnaissance activities.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - "directory"
            - "folder"
            - "enum"
        condition: selection
      fields:
        - rule.name
        - file.path
        - smb.path

  - question: Were any files transferred to or from the system via C$ share?
    context: File transfers through C$ share indicate potential data exfiltration or malware staging.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - bytes_toserver
        - bytes_toclient
        - duration

  - question: What processes were created after successful C$ share access?
    context: Process creation following share access reveals potential remote code execution or tool deployment.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          Hostname|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid
        - ParentImage

  # Type 6: Enterprise Correlation
  - question: Are other systems experiencing C$ share access attempts from this source?
    context: Multiple C$ access attempts indicate potential lateral movement or mass deployment campaign.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "C$"
        condition: selection
      fields:
        - dst_ip
        - rule.name

  - question: Is this part of a broader administrative share attack campaign?
    context: Coordinated administrative share attacks across systems indicate advanced persistent threat activity.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - "ADMIN$"
            - "C$"
            - "share"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name