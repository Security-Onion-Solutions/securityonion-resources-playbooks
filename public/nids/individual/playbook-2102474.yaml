name: GPL NETBIOS SMB-DS ADMIN$ Share Access
id: 22102474
description: |
  Detects access attempts to the Windows ADMIN$ administrative share via SMB.
  May indicate legitimate administrative activity or potential lateral movement attempts.
  ADMIN$ provides access to the Windows directory and is commonly targeted by attackers.
type: detection
detection_id: 2102474
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete SMB transaction attempting to access ADMIN$ share?
    context: Understanding the full SMB request reveals the specific access pattern and potential payload.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - smb.command
        - smb.path
        - smb.service
        - payload_printable

  - question: What source system initiated the ADMIN$ share access attempt?
    context: Identifying the source helps determine if this is authorized administrative activity.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - src_port
        - dst_ip
        - dst_port

  # Type 2: Triage Assessment
  - question: Is this source IP authorized for administrative SMB access to this system?
    context: Legitimate administrative access typically comes from known management systems or admin workstations.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 445
        condition: selection
      fields:
        - dst_ip
        - connection_count

  - question: Does this activity align with scheduled maintenance or administrative tasks?
    context: Administrative share access during business hours may be legitimate system management.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: "SMB"
        condition: selection
      fields:
        - src_ip
        - rule.name

  # Type 3: Activity Context
  - question: What other SMB activity preceded this ADMIN$ access attempt?
    context: Understanding the sequence of SMB operations reveals attack methodology or legitimate workflow.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: "SMB"
        condition: selection
      fields:
        - rule.name
        - smb.command
        - smb.path

  - question: Was authentication successful before this share access attempt?
    context: Failed authentication followed by share access attempts indicates potential credential attacks.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - "authentication"
            - "login"
            - "logon"
        condition: selection
      fields:
        - rule.name
        - event.outcome

  # Type 4: Impact Assessment
  - question: Did the ADMIN$ share access attempt succeed?
    context: Successful access to ADMIN$ allows full system control and file system access.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - "SMB"
            - "file"
        condition: selection
      fields:
        - rule.name
        - smb.response.status

  - question: What file operations occurred after the ADMIN$ access attempt?
    context: File access through ADMIN$ share indicates potential data access or malware deployment.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessName

  # Type 5: Forensic Deep-Dive
  - question: What specific files or directories were accessed through ADMIN$ share?
    context: File access patterns reveal attacker objectives and potential compromise scope.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: "file"
        condition: selection
      fields:
        - file.path
        - file.name
        - smb.path

  - question: Were any executables transferred or executed via ADMIN$ share?
    context: Executable transfer through administrative shares is a common lateral movement technique.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          Hostname|expand: '%dst_ip%'
          Image|contains:
            - ".exe"
            - ".bat"
            - ".ps1"
        condition: selection
      fields:
        - Image
        - CommandLine
        - ProcessGuid

  # Type 6: Enterprise Correlation
  - question: Are other systems experiencing similar ADMIN$ share access attempts from this source?
    context: Multiple systems targeted indicates potential lateral movement campaign.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "ADMIN$"
        condition: selection
      fields:
        - dst_ip
        - rule.name

  - question: Is this part of a broader SMB-based attack campaign across the network?
    context: Coordinated SMB attacks across multiple systems indicate advanced persistent threat activity.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "SMB"
          rule.name|contains: "share"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name