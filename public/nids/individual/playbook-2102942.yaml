name: GPL NETBIOS SMB InitiateSystemShutdown Attempt
id: 22102942
description: |
  Detects attempts to remotely shutdown Windows systems via SMB InitiateSystemShutdown RPC calls.
  This activity may indicate administrative actions but can also be used by attackers for denial of service.
  Legitimate use includes scheduled maintenance or emergency shutdown procedures.
type: detection
detection_id: 2102942
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact SMB RPC call structure for the InitiateSystemShutdown attempt?
    context: Understanding the RPC parameters reveals shutdown intent, timing, and potential message content.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - src_ip
        - dst_ip
        - dst_port
        - payload

  - question: What specific Windows Registry pipe was accessed for this shutdown command?
    context: The winreg pipe access pattern indicates the method used to invoke system shutdown functionality.
    range: -5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 139
        condition: selection
      fields:
        - src_port
        - protocol
        - bytes_toserver
        - bytes_toclient

  # Type 2: Triage Assessment
  - question: Is this a scheduled or authorized system shutdown from a known administrator?
    context: Legitimate shutdown commands are typically executed by authorized personnel during maintenance windows.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          Hostname|expand: '%dst_ip%'
          Image|contains:
            - 'shutdown.exe'
            - 'psshutdown.exe'
            - 'powershell.exe'
        condition: selection
      fields:
        - User
        - CommandLine
        - ProcessGuid

  - question: Does this activity align with documented maintenance schedules or emergency procedures?
    context: Comparing timing with maintenance windows helps distinguish legitimate operations from attacks.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 139
            - 445
        condition: selection
      fields:
        - src_ip
        - dst_port
        - duration

  # Type 3: Activity Context
  - question: What authentication and session establishment preceded this shutdown attempt?
    context: Understanding the complete SMB session reveals whether proper authentication was used.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: 'SMB'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - timestamp

  - question: What other administrative commands were executed in this SMB session?
    context: Multiple administrative commands in sequence may indicate legitimate management or malicious activity.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - 'SMB'
            - 'RPC'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - timestamp

  # Type 4: Impact Assessment
  - question: Did the target system actually shutdown following this command?
    context: Successful shutdown execution indicates the command was processed and system availability was impacted.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - protocol
        - state

  - question: Are there signs of system services stopping or processes terminating before shutdown?
    context: System shutdown preparation involves service termination and process cleanup activities.
    range: +10m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          Hostname|expand: '%dst_ip%'
          Image|contains:
            - 'services.exe'
            - 'wininit.exe'
            - 'csrss.exe'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ProcessGuid

  # Type 5: Forensic Deep-Dive
  - question: What specific privileges and credentials were used for this shutdown attempt?
    context: Shutdown commands require specific Windows privileges that reveal the access level achieved.
    range: -10m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: 'authentication'
        condition: selection
      fields:
        - rule.name
        - src_ip
        - dst_ip

  - question: Are there indicators of credential theft or privilege escalation preceding this command?
    context: Attackers may need to escalate privileges before executing system shutdown commands.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.category|contains:
            - 'credential'
            - 'privilege'
            - 'escalation'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - src_ip

  # Type 6: Enterprise Correlation
  - question: Are multiple systems receiving shutdown commands from this source simultaneously?
    context: Mass shutdown attempts indicate potential denial of service attacks or coordinated malicious activity.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: 'InitiateSystemShutdown'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - count

  - question: Is this part of a broader attack campaign targeting Windows administrative functions?
    context: Understanding campaign scope helps identify the full extent of malicious administrative activity.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'SMB'
            - 'RPC'
          rule.category|contains: 'protocol-command'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - count