name: GPL NETBIOS SMB InitiateSystemShutdown Little Endian Attempt
id: 22102943
description: |
  Detects little endian formatted attempts to remotely shutdown Windows systems via SMB InitiateSystemShutdown RPC calls.
  This specific byte order encoding may indicate automated tools or specific exploit frameworks.
  Legitimate administrative tools may also use little endian encoding depending on system architecture.
type: detection
detection_id: 2102943
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact little endian byte sequence in the InitiateSystemShutdown RPC call?
    context: The specific byte ordering reveals the tool or framework used to generate this shutdown command.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - src_ip
        - dst_ip
        - dst_port
        - payload

  - question: What SMB protocol version and RPC binding was used for this little endian shutdown attempt?
    context: Protocol details help identify the specific implementation and potential automation tools involved.
    range: -5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 139
        condition: selection
      fields:
        - src_port
        - protocol
        - bytes_toserver
        - bytes_toclient

  # Type 2: Triage Assessment
  - question: Is this little endian encoding consistent with known administrative tools used in this environment?
    context: Different administrative tools may use specific byte ordering based on their implementation or target architecture.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: 'SMB'
        condition: selection
      fields:
        - rule.name
        - src_ip
        - count

  - question: Are there documented system administration activities that would generate little endian RPC calls?
    context: Legitimate tools running on specific architectures may naturally generate little endian formatted commands.
    range: -1d
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          Hostname|expand: '%dst_ip%'
          Image|contains:
            - 'pstools'
            - 'wmic.exe'
            - 'powershell.exe'
        condition: selection
      fields:
        - User
        - CommandLine
        - ProcessGuid

  # Type 3: Activity Context
  - question: What SMB authentication and session negotiation preceded this little endian shutdown command?
    context: Understanding the complete session establishment reveals the authentication method and access level.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: 'SMB'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - timestamp

  - question: What other RPC commands with similar byte ordering were executed in this session?
    context: Multiple commands with consistent encoding patterns help identify the specific tool or framework being used.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - 'little endian'
            - 'RPC'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - timestamp

  # Type 4: Impact Assessment
  - question: Did this little endian formatted shutdown command successfully execute on the target system?
    context: Successful execution indicates the command was properly formatted and processed despite byte ordering.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - protocol
        - state

  - question: Are there signs of system shutdown preparation activities following this command?
    context: System shutdown involves specific process termination and service stopping sequences.
    range: +10m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          Hostname|expand: '%dst_ip%'
          Image|contains:
            - 'shutdown.exe'
            - 'services.exe'
            - 'winlogon.exe'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ProcessGuid

  # Type 5: Forensic Deep-Dive
  - question: What specific exploit framework or automated tool characteristics match this little endian encoding pattern?
    context: Byte ordering patterns can be signatures of specific hacking tools or exploit frameworks.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - 'exploit'
            - 'trojan'
            - 'malware'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - payload

  - question: Are there indicators of automated scanning or exploitation tools from this source?
    context: Little endian encoding may indicate automated tools that systematically target Windows systems.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - 'scan'
            - 'recon'
            - 'brute'
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - dst_port

  # Type 6: Enterprise Correlation
  - question: Are other systems receiving little endian formatted shutdown commands from this source?
    context: Consistent byte ordering across multiple targets suggests automated tool usage or coordinated attacks.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'InitiateSystemShutdown'
            - 'little endian'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - count

  - question: Is this part of a broader campaign using specific encoding patterns across the organization?
    context: Understanding encoding consistency helps identify campaign scope and tool signatures.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'little endian'
          rule.category|contains: 'protocol-command'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - count