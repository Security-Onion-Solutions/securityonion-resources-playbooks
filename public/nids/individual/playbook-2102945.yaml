name: GPL NETBIOS SMB InitiateSystemShutdown Unicode Little Endian Attempt
id: 22102945
description: |
  Detects unicode little endian formatted attempts to remotely shutdown Windows systems via SMB InitiateSystemShutdown RPC calls.
  This combination of unicode encoding and little endian byte ordering may indicate specific automated tools or advanced evasion techniques.
  Legitimate international administrative tools on specific architectures may generate this encoding pattern.
type: detection
detection_id: 2102945
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact unicode little endian byte sequence in the InitiateSystemShutdown RPC call?
    context: The specific combination of unicode and little endian encoding reveals sophisticated tool usage or evasion attempts.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - src_ip
        - dst_ip
        - dst_port
        - payload

  - question: What unicode pipe name structure was used with little endian encoding in this shutdown attempt?
    context: The combination of unicode characters and little endian byte ordering indicates specific implementation details.
    range: -5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 139
        condition: selection
      fields:
        - src_port
        - protocol
        - bytes_toserver
        - bytes_toclient

  # Type 2: Triage Assessment
  - question: Are unicode little endian encoded commands consistent with known legitimate administrative tools?
    context: This specific encoding combination is rare and may indicate specialized tools or attack frameworks.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - 'unicode'
            - 'little endian'
        condition: selection
      fields:
        - rule.name
        - src_ip
        - count

  - question: Is this encoding pattern documented for any authorized system administration tools in this environment?
    context: The rarity of this encoding combination makes it unlikely to be from standard administrative tools.
    range: -1d
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          Hostname|expand: '%dst_ip%'
          Image|contains:
            - 'pstools'
            - 'wmic.exe'
            - 'powershell.exe'
        condition: selection
      fields:
        - User
        - CommandLine
        - ProcessGuid

  # Type 3: Activity Context
  - question: What SMB session negotiation preceded this unicode little endian shutdown command?
    context: Understanding session establishment reveals the authentication and encoding negotiation process.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: 'SMB'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - timestamp

  - question: What other commands used this same unicode little endian encoding pattern in this session?
    context: Consistent encoding across multiple commands indicates systematic tool usage or framework implementation.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - 'unicode'
            - 'little endian'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - timestamp

  # Type 4: Impact Assessment
  - question: Did this complex encoded shutdown command successfully execute on the target system?
    context: Successful execution despite complex encoding indicates sophisticated attack tool capabilities.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - protocol
        - state

  - question: Are there signs of system shutdown initiation following this unicode little endian command?
    context: System shutdown confirmation indicates the complex encoding was properly processed by the target.
    range: +10m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          Hostname|expand: '%dst_ip%'
          Image|contains:
            - 'shutdown.exe'
            - 'services.exe'
            - 'winlogon.exe'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ProcessGuid

  # Type 5: Forensic Deep-Dive
  - question: What specific advanced persistent threat or sophisticated attack framework matches this encoding signature?
    context: The combination of unicode and little endian encoding suggests advanced tooling or specific threat actor signatures.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - 'apt'
            - 'advanced'
            - 'sophisticated'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - payload

  - question: Are there indicators of advanced evasion techniques or anti-forensics capabilities from this source?
    context: Complex encoding patterns may be part of broader evasion and anti-detection strategies.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - 'evasion'
            - 'obfuscation'
            - 'anti-forensics'
        condition: selection
      fields:
        - rule.name
        - rule.category
        - dst_ip

  # Type 6: Enterprise Correlation
  - question: Are other systems receiving unicode little endian encoded commands from this sophisticated source?
    context: Consistent complex encoding across targets indicates advanced automated tooling or coordinated campaign.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'unicode'
            - 'little endian'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - count

  - question: Is this part of a broader advanced campaign using sophisticated encoding techniques across the organization?
    context: Understanding advanced encoding usage patterns helps identify campaign scope and threat actor sophistication level.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'unicode'
            - 'little endian'
          rule.category|contains: 'protocol-command'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - count