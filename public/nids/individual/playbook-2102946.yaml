name: GPL NETBIOS SMB NDdeSetTrustedShareW little endian overflow attempt
id: 22102946
description: |
  Detects buffer overflow attempts in NDdeSetTrustedShareW function via CVE-2004-0206.
  This vulnerability allows remote code execution through malformed DDE share parameters.
  May trigger on legitimate Network DDE applications managing trusted shares.
type: detection
detection_id: 2102946
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What is the structure and size of the NDdeSetTrustedShareW overflow payload?
    context: Payload analysis reveals buffer overflow technique and potential shellcode.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - packet_info.length

  - question: What specific DDE share name and parameters triggered this overflow?
    context: Share parameters reveal exploitation target and potential legitimate usage.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - smb.named_pipe
        - rule.name

  # Type 2: Triage Assessment
  - question: Does this system legitimately use Network DDE for application integration?
    context: Network DDE is used by legacy applications for inter-process communication.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - "dde"
            - "netdde"
            - "nddeapi"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  - question: Are there authorized Network DDE client connections to this system?
    context: Regular DDE clients suggest legitimate business application usage.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 139
        condition: selection
      fields:
        - src_ip
        - bytes_toserver
        - connection_state

  # Type 3: Activity Context
  - question: What NDDEAPI RPC binding preceded this overflow attempt?
    context: RPC binding sequence reveals attack methodology and service enumeration.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: "nddeapi"
        condition: selection
      fields:
        - rule.name
        - smb.tree_id
        - smb.command

  - question: Were other DDE-related functions tested before the overflow attempt?
    context: Function enumeration indicates systematic vulnerability testing.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - "Ndde"
            - "DDE"
        condition: selection
      fields:
        - rule.name
        - rule.sid
        - payload

  # Type 4: Impact Assessment
  - question: Did the buffer overflow attempt cause service disruption or crash?
    context: Service crashes indicate successful buffer overflow exploitation.
    range: +10m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - connection_state
        - bytes_toclient
        - duration

  - question: Are there signs of code execution following the overflow attempt?
    context: Post-exploitation activity confirms successful buffer overflow exploitation.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  # Type 5: Forensic Deep-Dive
  - question: What shellcode patterns are present in the overflow payload?
    context: Shellcode analysis reveals exploitation intent and payload capabilities.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - rule.metadata

  - question: Does the payload size exceed normal NDdeSetTrustedShareW parameters?
    context: Oversized parameters confirm buffer overflow versus legitimate DDE usage.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - packet_info.length
        - smb.request.native_lan_man
        - rule.cve

  # Type 6: Enterprise Correlation
  - question: Are other systems targeted with NDdeSetTrustedShareW overflow attempts?
    context: Multiple targets indicate coordinated exploitation campaign.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.sid: 2102946
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is this source exploiting multiple CVE-2004-0206 related vulnerabilities?
    context: Multiple related exploits suggest comprehensive vulnerability exploitation toolkit.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.cve: "CVE_2004_0206"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.category