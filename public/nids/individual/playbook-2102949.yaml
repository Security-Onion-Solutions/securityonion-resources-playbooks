name: GPL NETBIOS SMB-DS NDdeSetTrustedShareW unicode little endian overflow attempt
id: 22102949
description: |
  Detects unicode little-endian buffer overflow attempts targeting Windows NetDDE service via SMB RPC.
  This targets CVE-2004-0206 with specific unicode encoding. Legitimate NetDDE unicode operations should not contain oversized buffers.
type: detection
detection_id: 2102949
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the unicode little-endian structure in the NetDDE RPC overflow?
    context: Understanding the unicode encoding and byte order reveals exploitation technique and target architecture.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rpc.function
        - unicode_parameters
        - byte_order
        - buffer_size

  - question: What specific NetDDE trusted share operation was being exploited?
    context: The NDdeSetTrustedShareW function parameters show the vulnerable operation being targeted.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - netdde.share_name
        - netdde.trusted_share
        - rpc.operation_code

  # Type 2: Triage Assessment
  - question: Is this system running NetDDE with unicode support vulnerable to CVE-2004-0206?
    context: The vulnerability affects Windows NT/2000/XP/2003 systems with NetDDE service enabled.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - src_ip
        - unicode_support
        - netdde_version

  - question: Are there legitimate unicode NetDDE operations from this source?
    context: Normal NetDDE unicode operations should not involve buffer overflow patterns or excessive data.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 445
        condition: selection
      fields:
        - dst_ip
        - unicode_operations
        - data_volume

  # Type 3: Activity Context
  - question: What SMB session setup enabled this unicode NetDDE attack?
    context: Understanding session negotiation reveals unicode capabilities and authentication context.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - smb.unicode_enabled
        - smb.capabilities
        - smb.dialect

  - question: What other unicode-based RPC attacks occurred in this session?
    context: Multiple unicode exploits may indicate systematic vulnerability exploitation or tool usage.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: "unicode"
        condition: selection
      fields:
        - rule.name
        - unicode_exploit_type
        - attack_progression

  # Type 4: Impact Assessment
  - question: Did the unicode NetDDE overflow result in successful code execution?
    context: Successful exploitation may spawn processes or modify NetDDE service behavior.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - "netdde.exe"
            - "nddeagnt.exe"
            - "svchost.exe"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: Are there indicators of NetDDE service compromise or data exfiltration?
    context: Compromised NetDDE may be used for data sharing or remote access establishment.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          alert.category|contains:
            - "trojan-activity"
            - "policy-violation"
        condition: selection
      fields:
        - rule.name
        - data_transfer
        - persistence_mechanism

  # Type 5: Forensic Deep-Dive
  - question: What unicode-encoded payload was delivered in the overflow buffer?
    context: Analyzing the unicode shellcode reveals exploitation sophistication and post-compromise objectives.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - unicode_payload
        - shellcode_analysis
        - payload_function

  - question: Does this unicode NetDDE exploit match known attack frameworks?
    context: Specific unicode handling and buffer layouts can identify automated exploitation tools.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "NDdeSetTrustedShareW"
        condition: selection
      fields:
        - rule.name
        - exploit_framework
        - unicode_variant

  # Type 6: Enterprise Correlation
  - question: Are other systems experiencing unicode NetDDE overflow attempts?
    context: Coordinated unicode exploits may indicate advanced persistent threat or worm propagation.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: "GPL NETBIOS SMB-DS NDdeSetTrustedShareW unicode little endian overflow attempt"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - unicode_campaign_scope

  - question: Is this part of broader unicode-based Windows exploitation?
    context: Multiple unicode vulnerabilities may be exploited simultaneously in sophisticated attacks.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.category: "attempted-admin"
          rule.name|contains: "unicode"
        condition: selection
      fields:
        - rule.name
        - unicode_vulnerability
        - attack_sophistication