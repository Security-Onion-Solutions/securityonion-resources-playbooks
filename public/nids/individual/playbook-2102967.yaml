name: GPL NETBIOS SMB NDdeSetTrustedShareW unicode little endian andx overflow attempt
id: 22102967
description: |
  Detects potential buffer overflow attempts targeting SMB NDdeSetTrustedShareW function via NetDDE.
  This exploits CVE-2004-0206 vulnerability in Windows NetDDE service through malformed SMB requests.
  May trigger on legitimate NetDDE operations but overflow patterns indicate malicious intent.
type: detection
detection_id: 2102967
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete SMB packet structure and overflow payload detected?
    context: Understanding the exact buffer overflow pattern reveals exploitation technique and payload size.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - payload
        - payload_printable
        - packet_info.length

  - question: What specific NetDDE pipe operations were attempted in the SMB session?
    context: NetDDE exploitation requires specific named pipe access patterns that indicate malicious intent.
    range: -5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 139
        condition: selection
      fields:
        - src_port
        - bytes_toserver
        - bytes_toclient
        - duration

  # Type 2: Triage Assessment
  - question: Is this connection from a known administrative source or domain controller?
    context: Legitimate NetDDE operations typically originate from specific administrative systems.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 139
            - 445
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - flow.bytes_toserver

  - question: Has this source IP established normal SMB sessions without exploit attempts?
    context: Attackers typically show different connection patterns compared to legitimate clients.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category: "trojan-activity"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - dst_port

  # Type 3: Activity Context
  - question: What SMB authentication and session setup preceded this overflow attempt?
    context: Understanding the attack sequence reveals if credentials were compromised or null sessions used.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.category: "protocol-command-decode"
        condition: selection
      fields:
        - rule.name
        - timestamp
        - alert.signature

  - question: What other NetBIOS or SMB-based attacks occurred from this source?
    context: CVE-2004-0206 exploitation often part of broader SMB enumeration and attack campaigns.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "SMB"
            - "NETBIOS"
            - "NetDDE"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - dst_port
        - alert.severity

  # Type 4: Impact Assessment
  - question: Did the overflow attempt succeed based on response patterns?
    context: Successful exploitation shows different response sizes and timing compared to failed attempts.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 139
        condition: selection
      fields:
        - bytes_toclient
        - duration
        - conn_state

  - question: Are there signs of follow-up exploitation or command execution?
    context: Successful NetDDE exploitation often followed by shell access or additional payload deployment.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.category|contains:
            - "shellcode"
            - "trojan-activity"
            - "successful-admin"
        condition: selection
      fields:
        - rule.name
        - alert.signature
        - dst_port

  # Type 5: Forensic Deep-Dive
  - question: What specific buffer overflow technique was used in the NDdeSetTrustedShareW call?
    context: Different overflow techniques indicate specific exploit tools or manual exploitation methods.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - alert.metadata
        - rule.category

  - question: Are there indicators of specific exploit frameworks or tools?
    context: CVE-2004-0206 exploits often contain signatures of Metasploit or other frameworks.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "Metasploit"
            - "exploit"
            - "framework"
        condition: selection
      fields:
        - rule.name
        - alert.signature
        - payload_printable

  # Type 6: Enterprise Correlation
  - question: Are other systems being targeted with similar NetDDE overflow attempts?
    context: Understanding campaign scope helps determine if this is targeted or opportunistic scanning.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "NDdeSetTrustedShareW"
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - alert.severity

  - question: Is this source IP part of broader SMB-based attack campaign across the enterprise?
    context: Coordinated SMB attacks often target multiple vulnerabilities and systems simultaneously.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 139
            - 445
          alert.severity|contains:
            - "Major"
            - "Critical"
        condition: selection
      fields:
        - dst_ip
        - rule.category
        - alert.signature