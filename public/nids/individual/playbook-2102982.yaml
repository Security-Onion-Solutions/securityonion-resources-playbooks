name: GPL NETBIOS SMB-DS ADMIN$ andx share access
id: 22102982
description: |
  Detects attempts to access the ADMIN$ administrative share via SMB over port 445.
  ADMIN$ provides access to the Windows system directory and is commonly targeted by attackers.
  May trigger on legitimate administrative activities but external access is typically suspicious.
type: detection
detection_id: 2102982
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete SMB ADMIN$ share access request structure?
    context: Understanding the exact SMB packet reveals authentication method and access intentions.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - payload_printable
        - alert.signature
        - packet_info.length

  - question: What SMB authentication credentials were used for ADMIN$ access?
    context: ADMIN$ access requires administrative privileges, revealing credential compromise or null sessions.
    range: -10m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: "SMB"
          dst_port: 445
        condition: selection
      fields:
        - rule.name
        - alert.signature
        - timestamp

  # Type 2: Triage Assessment
  - question: Is this ADMIN$ access from an authorized administrative workstation?
    context: Legitimate ADMIN$ access typically originates from specific IT management systems.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 445
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - bytes_toclient

  - question: Does this align with scheduled maintenance or administrative tasks?
    context: ADMIN$ access during business hours from internal sources may be legitimate administration.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.category: "protocol-command-decode"
          dst_port: 445
        condition: selection
      fields:
        - src_ip
        - rule.name
        - timestamp

  # Type 3: Activity Context
  - question: What SMB enumeration or reconnaissance preceded this ADMIN$ access?
    context: Attackers typically enumerate shares before accessing ADMIN$, revealing attack progression.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - "SMB"
            - "share"
            - "enumerate"
        condition: selection
      fields:
        - rule.name
        - alert.signature
        - timestamp

  - question: What other administrative shares were accessed from this source?
    context: Lateral movement often involves accessing multiple administrative shares across systems.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "C$"
            - "IPC$"
            - "ADMIN$"
            - "share"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - dst_port
        - alert.severity

  # Type 4: Impact Assessment
  - question: Was the ADMIN$ share access successful based on SMB response codes?
    context: Successful ADMIN$ access enables system-level file operations and potential persistence.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - bytes_toclient
        - duration
        - conn_state

  - question: Are there signs of file operations or system modifications via ADMIN$?
    context: ADMIN$ access often followed by file uploads, service installations, or registry modifications.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.category|contains:
            - "trojan-activity"
            - "policy-violation"
            - "successful-admin"
        condition: selection
      fields:
        - rule.name
        - alert.signature
        - alert.severity

  # Type 5: Forensic Deep-Dive
  - question: What specific files or directories were accessed through ADMIN$ share?
    context: Understanding accessed paths reveals attacker objectives and potential persistence mechanisms.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - "SMB"
            - "file"
            - "write"
        condition: selection
      fields:
        - rule.name
        - payload_printable
        - alert.signature

  - question: Are there indicators of credential harvesting or privilege escalation tools?
    context: ADMIN$ access commonly used to deploy credential dumping tools or escalation exploits.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - "credential"
            - "mimikatz"
            - "lsass"
            - "privilege"
        condition: selection
      fields:
        - rule.name
        - src_ip
        - alert.signature

  # Type 6: Enterprise Correlation
  - question: Are other systems experiencing ADMIN$ access attempts from this source?
    context: Understanding lateral movement scope helps determine campaign breadth and impact.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "ADMIN$"
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - alert.severity

  - question: Is this part of broader SMB-based attack campaign across the enterprise?
    context: Coordinated SMB attacks often target administrative shares across multiple systems.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 445
          alert.severity|contains:
            - "Major"
            - "Critical"
        condition: selection
      fields:
        - dst_ip
        - rule.category
        - rule.name