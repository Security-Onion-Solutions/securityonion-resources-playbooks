name: GPL NETBIOS SMB-DS ADMIN$ unicode andx share access
id: 22102983
description: |
  Detects attempts to access the ADMIN$ administrative share using Unicode encoding via SMB over port 445.
  Unicode encoding in SMB requests may indicate evasion attempts or specific exploitation tools.
  ADMIN$ provides system-level access and is a high-value target for attackers.
type: detection
detection_id: 2102983
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the Unicode-encoded ADMIN$ share access request pattern?
    context: Unicode encoding in SMB may indicate evasion techniques or specific exploitation frameworks.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - payload_printable
        - alert.signature
        - packet_info.length

  - question: What SMB dialect and authentication method was negotiated?
    context: Understanding SMB version and auth reveals client capabilities and potential vulnerabilities.
    range: -5m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: "SMB"
          dst_port: 445
        condition: selection
      fields:
        - rule.name
        - alert.signature
        - timestamp

  # Type 2: Triage Assessment
  - question: Is this Unicode SMB access from a known administrative system?
    context: Legitimate Unicode SMB usage is rare and typically indicates specific client configurations.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 445
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - bytes_toclient

  - question: Has this source previously used standard ASCII SMB requests?
    context: Switching to Unicode encoding may indicate escalation to evasion techniques.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "SMB"
          rule.name|contains: "ADMIN$"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - timestamp

  # Type 3: Activity Context
  - question: What SMB reconnaissance or enumeration preceded this Unicode access attempt?
    context: Unicode evasion often follows initial reconnaissance to avoid detection systems.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - "SMB"
            - "enumerate"
            - "scan"
        condition: selection
      fields:
        - rule.name
        - alert.signature
        - timestamp

  - question: What other Unicode-encoded SMB operations were attempted?
    context: Systematic Unicode usage indicates deliberate evasion strategy across multiple operations.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "unicode"
            - "SMB"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - alert.signature

  # Type 4: Impact Assessment
  - question: Did the Unicode-encoded ADMIN$ access bypass security controls?
    context: Unicode evasion success indicates potential gaps in security monitoring capabilities.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - bytes_toclient
        - duration
        - conn_state

  - question: Are there signs of successful system access or file operations?
    context: Successful ADMIN$ access enables critical system modifications and persistence installation.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.category|contains:
            - "successful-admin"
            - "trojan-activity"
            - "policy-violation"
        condition: selection
      fields:
        - rule.name
        - alert.signature
        - alert.severity

  # Type 5: Forensic Deep-Dive
  - question: What specific Unicode evasion technique was employed in the SMB request?
    context: Different Unicode encoding methods indicate specific tools or manual exploitation techniques.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - alert.metadata
        - rule.category

  - question: Are there indicators of advanced persistent threat tools or frameworks?
    context: Unicode SMB evasion often associated with sophisticated attack tools and APT campaigns.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "APT"
            - "Cobalt"
            - "Metasploit"
            - "framework"
        condition: selection
      fields:
        - rule.name
        - alert.signature
        - payload_printable

  # Type 6: Enterprise Correlation
  - question: Are other systems being targeted with Unicode SMB evasion techniques?
    context: Understanding campaign scope reveals whether this is targeted or opportunistic attack.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "unicode"
          rule.name|contains: "SMB"
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - alert.severity

  - question: Is this source IP part of broader evasion-focused attack campaign?
    context: Coordinated evasion techniques across multiple protocols indicate sophisticated threat actor.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "unicode"
            - "evasion"
            - "obfuscat"
        condition: selection
      fields:
        - dst_ip
        - rule.category
        - rule.name