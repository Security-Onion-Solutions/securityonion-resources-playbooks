name: GPL NETBIOS SMB InitiateSystemShutdown andx attempt
id: 22102992
description: |
  Detects attempts to initiate system shutdown via SMB NetBIOS using standard encoding.
  May trigger on legitimate remote administration or automated shutdown scripts.
  Often associated with malicious system disruption and denial of service attacks.
type: detection
detection_id: 2102992
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete SMB InitiateSystemShutdown command structure and parameters?
    context: Analyzing the SMB packet reveals shutdown timing, message, and force parameters.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - smb.command
        - smb.flags
        - rule.name

  - question: Is this shutdown request part of scheduled maintenance or authorized operations?
    context: Legitimate system administration may involve remote shutdown commands during maintenance windows.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 139
        condition: selection
      fields:
        - src_ip
        - connection_duration
        - bytes_in
        - bytes_out

  - question: What SMB session authentication preceded this shutdown attempt?
    context: Understanding authentication context helps determine if this is legitimate administrative access.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - "SMB"
            - "NTLM"
        condition: selection
      fields:
        - src_ip
        - rule.name
        - smb.user
        - smb.domain

  - question: What sequence of SMB commands led to this shutdown attempt?
    context: Attackers typically execute multiple SMB operations before attempting system shutdown.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: "SMB"
        condition: selection
      fields:
        - rule.name
        - smb.command
        - smb.tree_id

  - question: Did the shutdown command successfully execute on the target system?
    context: Confirming successful execution helps assess the immediate impact and system availability.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - connection_state

  - question: What Windows event logs show shutdown service activity on the target?
    context: System event logs provide definitive evidence of shutdown service invocation and success.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - "shutdown.exe"
            - "InitiateSystemShutdownEx"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessId

  - question: Are there indicators of privilege escalation before the shutdown attempt?
    context: InitiateSystemShutdown requires administrative privileges that attackers may need to obtain.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetObject|contains:
            - "SeShutdownPrivilege"
            - "HKLM\\SYSTEM\\CurrentControlSet\\Control"
        condition: selection
      fields:
        - TargetObject
        - Details
        - User

  - question: What malicious tools or payloads were deployed before the shutdown command?
    context: Attackers often establish persistence or execute reconnaissance before disrupting systems.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetFilename|contains:
            - "\\Windows\\Temp\\"
            - "\\Users\\Public\\"
            - ".exe"
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size

  - question: What remote command execution preceded this shutdown attempt?
    context: Understanding command execution patterns reveals attacker techniques and objectives.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          ParentImage|contains:
            - "services.exe"
            - "svchost.exe"
          CommandLine|contains:
            - "cmd"
            - "powershell"
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid

  - question: Are multiple systems experiencing coordinated shutdown attempts from this source?
    context: Mass shutdown attempts indicate a potential denial of service attack or ransomware campaign.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "InitiateSystemShutdown"
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - count

  - question: What lateral movement patterns connect this attack to other compromised systems?
    context: Tracing attack progression helps identify the full scope of network compromise.
    range: -4h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 135
            - 139
            - 445
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - protocol
        - bytes_in