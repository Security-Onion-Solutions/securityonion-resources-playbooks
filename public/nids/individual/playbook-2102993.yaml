name: GPL NETBIOS SMB InitiateSystemShutdown little endian andx attempt
id: 22102993
description: |
  Detects attempts to initiate system shutdown via SMB NetBIOS using little endian encoding.
  May trigger on legitimate remote administration or automated shutdown scripts.
  Often associated with malicious lateral movement and system disruption attacks.
type: detection
detection_id: 2102993
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete SMB packet structure and InitiateSystemShutdown payload?
    context: Analyzing the exact SMB command structure reveals the shutdown parameters and intent.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - smb.command
        - smb.tree_id
        - rule.name

  - question: Is this system shutdown activity authorized for this time period?
    context: Legitimate system maintenance may involve scheduled remote shutdowns.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 139
        condition: selection
      fields:
        - src_ip
        - bytes_in
        - bytes_out

  - question: What SMB authentication and session establishment preceded this shutdown attempt?
    context: Understanding the authentication context reveals if this is authorized administrative access.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - "SMB"
            - "NETBIOS"
        condition: selection
      fields:
        - src_ip
        - rule.name
        - smb.user

  - question: What other SMB administrative commands were executed in this session?
    context: Attackers often chain multiple administrative commands for lateral movement.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - "SMB"
            - "RPC"
        condition: selection
      fields:
        - rule.name
        - smb.command
        - rpc.procedure

  - question: Has the target system actually been shut down or disrupted?
    context: Confirming successful exploitation helps assess impact and response urgency.
    range: +2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - connection_state

  - question: What Windows Registry access patterns indicate shutdown privilege escalation?
    context: InitiateSystemShutdown requires specific privileges that may involve registry manipulation.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetObject|contains:
            - "HKLM\\SYSTEM\\CurrentControlSet\\Control\\Lsa"
            - "SeShutdownPrivilege"
        condition: selection
      fields:
        - TargetObject
        - Details
        - User

  - question: What process activity on the target system shows shutdown service interaction?
    context: Legitimate shutdowns involve specific system processes and service calls.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - "shutdown.exe"
            - "winlogon.exe"
            - "services.exe"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ParentImage

  - question: Are there signs of successful remote code execution before the shutdown attempt?
    context: Attackers may establish persistence or execute payloads before disrupting systems.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          CommandLine|contains:
            - "cmd.exe"
            - "powershell"
            - "wmic"
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid

  - question: What file system activity indicates malicious payload deployment?
    context: Attackers often drop tools or backdoors before attempting system disruption.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetFilename|contains:
            - ".exe"
            - ".bat"
            - ".ps1"
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size

  - question: Are other systems in the network experiencing similar SMB shutdown attempts?
    context: Coordinated shutdown attempts across multiple systems indicate a broader attack campaign.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "InitiateSystemShutdown"
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - count

  - question: What lateral movement indicators connect this shutdown attempt to other compromised systems?
    context: Understanding attack progression helps identify the full scope of compromise.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 135
            - 139
            - 445
            - 3389
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_in
        - bytes_out