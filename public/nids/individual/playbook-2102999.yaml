name: GPL NETBIOS SMB-DS InitiateSystemShutdown unicode little endian andx attempt
id: 22102999
description: |
  Detects attempts to remotely shutdown systems via SMB InitiateSystemShutdown RPC call.
  Triggers on SMB traffic containing Windows Registry service binding and shutdown command structures.
  May indicate legitimate remote administration or malicious system disruption attempts.
type: detection
detection_id: 2102999
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the exact SMB command structure and shutdown parameters specified?
    context: Understanding the complete SMB packet reveals shutdown timing, message, and force parameters.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - rule.name
        - src_ip
        - dst_ip
        - dst_port

  - question: Is this source IP authorized for remote system administration on the target?
    context: Legitimate shutdown operations would come from known administrative systems or service accounts.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 445
            - 139
        condition: selection
      fields:
        - dst_ip
        - bytes_in
        - bytes_out

  - question: What SMB authentication and session establishment preceded this shutdown attempt?
    context: Remote shutdown requires successful SMB authentication and proper privilege escalation.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 445
            - 139
        condition: selection
      fields:
        - src_port
        - duration
        - state

  - question: Are there other Windows Registry service RPC calls from this source?
    context: Multiple registry service operations suggest comprehensive system administration or reconnaissance.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "winreg"
            - "registry"
            - "SMB"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - dst_port

  - question: What is the shutdown message and timeout specified in the RPC call?
    context: Malicious shutdowns may have threatening messages or immediate timeouts, while legitimate ones provide warnings.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_length
        - flow_id
        - community_id

  - question: Did the target system actually shutdown or show signs of service disruption?
    context: Successful shutdown attempts would cause loss of network connectivity and service availability.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - state

  - question: Are there Windows event logs indicating shutdown initiation on the target system?
    context: Successful shutdown commands would generate system event logs with shutdown reasons and user context.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - "shutdown"
            - "wininit"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  - question: What other administrative activities occurred from this source IP?
    context: Legitimate administration would show patterns of authorized management activities and proper authentication.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "SMB"
            - "RPC"
            - "admin"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - dst_port

  - question: Are there coordinated shutdown attempts against multiple systems?
    context: Mass shutdown attempts suggest denial of service attack or coordinated infrastructure disruption.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name: "GPL NETBIOS SMB-DS InitiateSystemShutdown unicode little endian andx attempt"
        condition: selection
      fields:
        - dst_ip
        - dst_port

  - question: What network reconnaissance preceded this shutdown attempt?
    context: SMB enumeration and port scanning may indicate targeted attack preparation and system discovery.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 445
            - 139
            - 135
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - duration

  - question: Are there signs of privilege escalation or credential abuse enabling this shutdown attempt?
    context: Remote shutdown requires administrative privileges that may have been obtained through exploitation or credential theft.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User