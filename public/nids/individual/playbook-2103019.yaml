name: GPL NETBIOS SMB NT Trans NT CREATE AndX Oversized Security Descriptor Attempt
id: 22103019
description: |
  Detects potential exploitation attempts against CVE-2004-1154 using AndX chaining with oversized security descriptors.
  This variant uses SMB command chaining to deliver buffer overflow payloads through NT CREATE requests.
  May trigger on legitimate applications creating files with large security descriptors using command chaining.
type: detection
detection_id: 2103019
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the specific AndX command chaining structure used in this exploitation attempt?
    context: Understanding the SMB command chaining reveals how attackers bypass security controls through protocol manipulation.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - alert.signature
        - network.protocol
        - payload_printable

  - question: How large was the security descriptor that triggered this buffer overflow detection?
    context: The exact size of the security descriptor helps determine exploitation severity and potential impact.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.metadata
        - network.transport

  # Type 2: Triage Assessment
  - question: Is this AndX chaining pattern consistent with normal SMB client behavior?
    context: Some legitimate applications use SMB command chaining for performance optimization.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 139
        condition: selection
      fields:
        - src_ip
        - connection_state
        - bytes_toserver

  - question: Does this activity align with scheduled backup or file management operations?
    context: Backup software and file management tools may create files with complex security descriptors.
    range: -4h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'backup'
            - 'robocopy'
            - 'xcopy'
        condition: selection
      fields:
        - User
        - CommandLine
        - ParentImage

  # Type 3: Activity Context
  - question: What SMB session negotiation preceded this AndX exploitation attempt?
    context: Understanding the full SMB protocol negotiation helps identify if this follows legitimate authentication.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - connection_state
        - bytes_toserver

  - question: Are there other SMB protocol manipulation attempts from this source?
    context: Multiple protocol manipulation attempts may indicate systematic exploitation or advanced persistent threats.
    range: -2h/+2h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains:
            - 'SMB'
            - 'AndX'
            - 'NT Trans'
        condition: selection
      fields:
        - alert.signature
        - dst_ip
        - dst_port

  # Type 4: Impact Assessment
  - question: Did this AndX chaining attack achieve successful code execution?
    context: Successful exploitation through command chaining may enable remote code execution with elevated privileges.
    range: +45m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          User|contains:
            - 'SYSTEM'
            - 'LOCAL SERVICE'
        condition: selection
      fields:
        - User
        - CommandLine
        - Image
        - ParentImage

  - question: Are there signs of unauthorized file system access following this attempt?
    context: Successful buffer overflow may enable attackers to access or modify protected files and directories.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetFilename|contains:
            - 'system32'
            - 'windows'
            - 'program files'
        condition: selection
      fields:
        - TargetFilename
        - ProcessName
        - file.hash.md5

  # Type 5: Forensic Deep-Dive
  - question: What specific NT CREATE parameters were manipulated in this AndX attack?
    context: Understanding the exact parameter manipulation helps identify the attack technique and payload delivery method.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - alert.signature
        - alert.category
        - src_port
        - dst_port

  - question: Are there indicators of memory corruption or heap spray techniques?
    context: Advanced buffer overflow attacks may use heap spraying or ROP chains for reliable exploitation.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          CommandLine|contains:
            - 'rundll32'
            - 'regsvr32'
            - 'mshta'
        condition: selection
      fields:
        - CommandLine
        - Image
        - ParentImage
        - User

  - question: What network connections were established following successful exploitation?
    context: Successful compromise may result in command and control communications or lateral movement.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 80
            - 443
            - 8080
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection_state
        - bytes_toserver

  # Type 6: Enterprise Correlation
  - question: Are other systems experiencing similar AndX chaining exploitation attempts?
    context: Coordinated attacks may use consistent SMB command chaining techniques across multiple targets.
    range: -8h/+8h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature: 'GPL NETBIOS SMB NT Trans NT CREATE andx oversized Security Descriptor attempt'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - count

  - question: Is this part of a broader campaign targeting CVE-2004-1154 across the enterprise?
    context: Multiple exploitation variants may indicate sophisticated attackers using different SMB attack vectors.
    range: -24h/+24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.metadata|contains: 'CVE_2004_1154'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature
        - count