name: GPL NETBIOS SMB-DS NT Trans NT CREATE Unicode Oversized Security Descriptor Attempt
id: 22103024
description: |
  Detects exploitation attempts targeting CVE-2004-1154 via oversized security descriptors in SMB NT CREATE requests.
  This vulnerability allows buffer overflow in Windows SMB server when processing unicode security descriptors.
  May trigger on legitimate large security descriptors but oversized unicode patterns suggest exploitation.
type: detection
detection_id: 2103024
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact size and structure of the oversized security descriptor?
    context: Security descriptor size analysis reveals buffer overflow technique and target vulnerability.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - payload
        - smb.security_descriptor_size
        - smb.nt_create_parameters

  - question: What specific NT CREATE transaction parameters were manipulated in the exploit?
    context: NT CREATE parameter analysis confirms exploitation technique and target file operations.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - smb.transaction_type
        - smb.nt_create_disposition
        - smb.file_attributes
        - smb.access_mask

  # Type 2: Triage Assessment
  - question: Are large security descriptors normal for this system's file operations?
    context: Understanding typical security descriptor sizes helps distinguish legitimate from malicious activity.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - src_ip
        - smb.security_descriptor_size
        - smb.file_name
        - connection_state

  - question: Does this source typically perform file operations with complex security settings?
    context: Client security descriptor usage patterns help identify anomalous oversized descriptors.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 445
        condition: selection
      fields:
        - dst_ip
        - smb.security_descriptor_size
        - smb.nt_create_disposition
        - bytes_transferred

  # Type 3: Activity Context
  - question: What file path or share was targeted in the NT CREATE request?
    context: Target file path reveals attacker's objective and potential system compromise goals.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
          dst_port: 445
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - smb.file_name
        - smb.share_name
        - smb.tree_id

  - question: What other SMB file operations preceded this oversized security descriptor attempt?
    context: File operation sequence reveals attack methodology and reconnaissance activities.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - smb.command
        - smb.file_name
        - smb.nt_create_disposition
        - smb.access_mask

  # Type 4: Impact Assessment
  - question: Did the oversized security descriptor cause SMB server instability or crashes?
    context: SMB server crashes indicate successful buffer overflow exploitation.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          Hostname|expand: '%dst_ip%'
          Image|contains:
            - 'smss.exe'
            - 'csrss.exe'
            - 'services.exe'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  - question: Were any files successfully created or modified after the exploit attempt?
    context: Successful file operations following exploit indicate potential system compromise.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          Hostname|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.mime_type
        - ProcessName

  # Type 5: Forensic Deep-Dive
  - question: What specific security descriptor ACE entries were crafted in the overflow payload?
    context: ACE entry analysis reveals exploitation technique and potential privilege escalation attempts.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - smb.security_descriptor
        - smb.acl_entries

  - question: Are there indicators of shellcode embedded in the security descriptor structure?
    context: Shellcode patterns in security descriptors confirm exploitation versus legitimate large descriptors.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          Hostname|expand: '%dst_ip%'
          CommandLine|contains:
            - 'cmd.exe'
            - 'powershell.exe'
            - 'rundll32.exe'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ParentImage

  # Type 6: Enterprise Correlation
  - question: Are other systems showing similar oversized security descriptor exploitation attempts?
    context: Multiple targets indicate coordinated campaign against Windows file server infrastructure.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'Oversized Security Descriptor'
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - alert.severity

  - question: What related CVE-2004-1154 exploitation variants are appearing enterprise-wide?
    context: Multiple SMB exploitation techniques indicate sophisticated attacker with comprehensive Windows knowledge.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'NT Trans NT CREATE'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - alert.severity