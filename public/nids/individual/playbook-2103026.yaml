name: GPL NETBIOS SMB NT Trans NT CREATE SACL overflow attempt
id: 22103026
description: |
  Detects potential SMB buffer overflow attempts targeting CVE-2004-1154 in Windows SMB service.
  This vulnerability allows remote code execution through malformed NT CREATE requests with SACL parameters.
  May trigger on legitimate SMB traffic with unusual packet structures or legacy applications.
type: detection
detection_id: 2103026
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the exact SMB packet structure and payload that triggered this overflow detection?
    context: Understanding the malformed NT CREATE request reveals exploitation attempt specifics and potential payload.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - src_ip
        - dst_ip
        - dst_port
        - payload_printable

  - question: Is this SMB traffic part of normal file sharing operations for this system?
    context: Legitimate SMB file sharing may occasionally generate unusual packet patterns that could false positive.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 139
        condition: selection
      fields:
        - src_ip
        - bytes_toserver
        - bytes_toclient
        - duration

  - question: What SMB authentication and session activity preceded this overflow attempt?
    context: Successful exploitation often requires established SMB sessions or authentication bypass attempts.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 139
            - 445
        condition: selection
      fields:
        - src_port
        - dst_port
        - conn_state
        - duration

  - question: Are there signs of successful code execution or system compromise following this attempt?
    context: CVE-2004-1154 exploitation can lead to SYSTEM level access and immediate post-exploitation activity.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ParentImage

  - question: What other SMB-based attacks or reconnaissance occurred from this source IP?
    context: SMB overflow attempts are often part of broader Windows exploitation campaigns targeting multiple vulnerabilities.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - SMB
            - NETBIOS
            - Windows
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.category

  - question: Has this source IP attempted exploitation of other Windows services beyond SMB?
    context: Attackers often scan and exploit multiple Windows services as part of systematic network compromise.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 135
            - 445
            - 3389
            - 5985
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - conn_state

  - question: What file system changes occurred on the target system around the time of this attack?
    context: Successful SMB exploitation may result in malware deployment, backdoor installation, or data access.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size
        - action

  - question: Are there indicators of lateral movement or credential harvesting following this SMB attack?
    context: SMB compromise often leads to credential theft and movement to other systems in the network.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 139
            - 445
            - 3389
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver
        - conn_state

  - question: What registry modifications occurred that might indicate persistence mechanisms?
    context: Successful SMB exploitation often includes registry changes for persistence, service installation, or security bypass.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetObject
        - Details
        - action

  - question: Are other systems in the network showing similar SMB overflow attempts from different sources?
    context: CVE-2004-1154 exploits may be part of coordinated campaigns or worm-like propagation across the network.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: "GPL NETBIOS SMB NT Trans NT CREATE SACL overflow attempt"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - count

  - question: What DNS queries or external communications originated from the target system post-attack?
    context: Compromised systems often communicate with command and control infrastructure or download additional payloads.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name