name: GPL NETBIOS SMB NT Trans NT CREATE andx SACL overflow attempt
id: 22103027
description: |
  Detects potential SMB buffer overflow attempts targeting CVE-2004-1154 using NT CREATE AndX commands with SACL parameters.
  This variant combines AndX command chaining with SACL manipulation to exploit Windows SMB service vulnerabilities.
  May trigger on legitimate applications performing complex file security operations or advanced NTFS permissions management.
type: detection
detection_id: 2103027
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the exact AndX command sequence and SACL structure that triggered this overflow detection?
    context: AndX chaining with malformed SACL parameters reveals specific exploitation techniques and potential payload delivery.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - src_ip
        - dst_ip
        - payload_printable
        - community_id

  - question: Is this AndX SACL operation part of legitimate file security management for this system?
    context: Enterprise applications may use complex SACL operations for audit logging and security compliance requirements.
    range: -48h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 139
        condition: selection
      fields:
        - bytes_toserver
        - bytes_toclient
        - duration
        - conn_state

  - question: What SMB session establishment and protocol negotiation preceded this SACL overflow attempt?
    context: SACL-based AndX exploitation requires specific SMB capabilities and authenticated session context.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 139
            - 445
        condition: selection
      fields:
        - src_port
        - conn_state
        - duration
        - bytes_toserver

  - question: Are there signs of successful code execution or system compromise following this SACL attack?
    context: CVE-2004-1154 SACL exploitation can provide immediate administrative access and enable post-exploitation activities.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ParentImage
        - ProcessGuid

  - question: What other SMB security descriptor or permission-based attacks occurred from this source?
    context: SACL overflow attempts often accompany other Windows security bypass techniques and privilege escalation attempts.
    range: -4h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - SMB
            - SACL
            - DACL
            - security
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.category

  - question: Has this attacker performed reconnaissance or exploitation of other Windows authentication services?
    context: SACL-based SMB attacks typically follow comprehensive Windows service enumeration and vulnerability assessment.
    range: -8h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 88
            - 135
            - 389
            - 636
            - 3268
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - conn_state
        - bytes_toserver

  - question: What file system security changes or audit policy modifications occurred post-attack?
    context: Successful SACL exploitation may result in audit bypass, security policy changes, or stealth persistence mechanisms.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetObject|contains:
            - AuditPolicy
            - Security
            - LSA
        condition: selection
      fields:
        - TargetObject
        - Details
        - action

  - question: Are there indicators of credential theft or authentication token manipulation following this attack?
    context: SACL overflow success often enables access to security tokens, cached credentials, or authentication databases.
    range: +45m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - lsass.exe
            - winlogon.exe
            - services.exe
        condition: selection
      fields:
        - CommandLine
        - User
        - ParentImage
        - ProcessGuid

  - question: What suspicious network activity or lateral movement attempts originated from the compromised system?
    context: SACL exploitation success typically leads to network reconnaissance and attempts to compromise additional systems.
    range: +3h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 139
            - 445
            - 3389
            - 5985
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver
        - conn_state

  - question: Are multiple systems across the network experiencing similar SACL-based SMB attacks?
    context: SACL overflow exploits may indicate coordinated domain compromise attempts or automated exploitation tools.
    range: -3h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: "GPL NETBIOS SMB NT Trans NT CREATE andx SACL overflow attempt"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - count

  - question: What external command and control communications were established following this SACL attack?
    context: Compromised systems typically establish persistent communication channels for remote access and additional payload delivery.
    range: +8h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name