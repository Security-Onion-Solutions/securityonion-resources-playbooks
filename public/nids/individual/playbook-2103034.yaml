name: GPL NETBIOS SMB NT Trans NT CREATE DACL Overflow Attempt
id: 22103034
description: |
  Detects potential exploitation attempts against CVE-2004-1154 targeting DACL (Discretionary Access Control List) overflow vulnerabilities.
  This attack manipulates NT CREATE requests with oversized DACL structures to trigger buffer overflows in SMB processing.
  May trigger on legitimate applications creating files with complex access control lists.
type: detection
detection_id: 2103034
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the specific DACL structure and size that triggered this overflow detection?
    context: Understanding the DACL structure reveals how attackers manipulate access control lists to achieve buffer overflow.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - alert.signature
        - network.protocol
        - payload_printable
        - alert.metadata

  - question: How does this DACL overflow differ from standard security descriptor attacks?
    context: DACL-specific attacks target access control structures, revealing advanced knowledge of Windows security architecture.
    range: -1h/+1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains:
            - 'Security Descriptor'
            - 'DACL'
            - 'overflow'
        condition: selection
      fields:
        - alert.signature
        - dst_ip
        - alert.category

  # Type 2: Triage Assessment
  - question: Is this DACL manipulation part of normal access control management?
    context: System administrators may legitimately create complex DACLs for fine-grained access control.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 139
        condition: selection
      fields:
        - src_ip
        - connection_state
        - bytes_toserver

  - question: Does this activity correlate with documented security policy changes?
    context: Security policy updates may involve creating files or objects with complex access control structures.
    range: -4h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'secedit.exe'
            - 'gpupdate.exe'
            - 'dsacls.exe'
        condition: selection
      fields:
        - User
        - CommandLine
        - ParentImage

  # Type 3: Activity Context
  - question: What SMB authentication context preceded this DACL overflow attempt?
    context: Understanding the authentication context helps determine if this follows legitimate administrative access.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - connection_state
        - bytes_toserver

  - question: Are there other access control manipulation attempts from this source?
    context: Multiple access control attacks may indicate systematic privilege escalation or security bypass attempts.
    range: -2h/+2h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains:
            - 'DACL'
            - 'ACL'
            - 'access control'
        condition: selection
      fields:
        - alert.signature
        - dst_ip
        - dst_port

  # Type 4: Impact Assessment
  - question: Did this DACL overflow result in successful privilege escalation?
    context: Successful DACL manipulation may enable attackers to bypass access controls and gain elevated privileges.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          User|contains:
            - 'SYSTEM'
            - 'Administrator'
        condition: selection
      fields:
        - User
        - CommandLine
        - Image
        - ParentImage

  - question: Are there signs of unauthorized access to protected resources following this attempt?
    context: Successful DACL bypass may enable access to files, registry keys, or services normally protected by access controls.
    range: +3h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetFilename|contains:
            - 'SAM'
            - 'SECURITY'
            - 'SYSTEM'
        condition: selection
      fields:
        - TargetFilename
        - ProcessName
        - file.hash.md5

  # Type 5: Forensic Deep-Dive
  - question: What specific DACL entries were manipulated to trigger this overflow?
    context: Understanding the exact DACL manipulation helps identify the attack technique and intended privilege escalation.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - alert.signature
        - alert.category
        - network.transport

  - question: Are there indicators of ACL inheritance manipulation or privilege token abuse?
    context: Advanced attackers may manipulate ACL inheritance or abuse privilege tokens for persistent access.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetObject|contains:
            - 'Security'
            - 'Privileges'
            - 'TokenPrivileges'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessName

  - question: What security-related system modifications occurred following this attack?
    context: Successful DACL exploitation may result in security policy changes or access control modifications.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetObject|contains:
            - 'Policies'
            - 'LSA'
            - 'Security'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessName

  # Type 6: Enterprise Correlation
  - question: Are other systems experiencing similar DACL overflow exploitation attempts?
    context: Coordinated attacks may target multiple systems using consistent DACL manipulation techniques.
    range: -6h/+6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature: 'GPL NETBIOS SMB NT Trans NT CREATE DACL overflow attempt'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - count

  - question: Is this part of a comprehensive CVE-2004-1154 exploitation campaign targeting access controls?
    context: Multiple related vulnerabilities may be exploited to systematically bypass Windows security architecture.
    range: -24h/+24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.metadata|contains: 'CVE_2004_1154'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature
        - count