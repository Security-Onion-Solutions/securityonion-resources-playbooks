name: GPL NETBIOS SMB NT Trans NT CREATE andx DACL overflow attempt
id: 22103035
description: |
  Detects potential SMB buffer overflow attempts targeting CVE-2004-1154 using NT CREATE AndX commands with DACL parameters.
  This variant uses chained AndX commands to exploit buffer overflow vulnerabilities in Windows SMB service.
  May trigger on complex legitimate SMB operations or applications using advanced NT file system features.
type: detection
detection_id: 2103035
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the specific AndX command chain and DACL structure in this SMB overflow attempt?
    context: AndX command chaining with malformed DACL parameters indicates sophisticated SMB exploitation techniques.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - src_ip
        - dst_ip
        - payload_printable
        - community_id

  - question: Is this AndX command usage consistent with normal SMB file operations for this client?
    context: Legitimate applications may use chained AndX commands for efficient file operations, requiring baseline comparison.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 139
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - bytes_toclient
        - duration

  - question: What SMB negotiation and authentication preceded this AndX overflow attempt?
    context: AndX command exploitation requires successful SMB session establishment and specific protocol negotiation.
    range: -10m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 139
            - 445
        condition: selection
      fields:
        - src_port
        - conn_state
        - duration
        - bytes_toserver

  - question: Are there indicators of successful exploitation or privilege escalation following this AndX attack?
    context: CVE-2004-1154 AndX exploitation can provide immediate SYSTEM access and spawn privileged processes.
    range: +45m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ParentImage
        - ProcessGuid

  - question: What other SMB protocol anomalies or attacks originated from this source?
    context: AndX overflow attempts often accompany other SMB exploitation techniques as part of comprehensive Windows attacks.
    range: -3h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - SMB
            - NETBIOS
            - AndX
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.category
        - severity

  - question: Has this attacker attempted to exploit other Windows RPC or file sharing vulnerabilities?
    context: SMB AndX exploitation is often part of broader Windows service enumeration and exploitation campaigns.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 135
            - 139
            - 445
            - 593
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - conn_state
        - bytes_toserver

  - question: What suspicious file creation or modification activity occurred on the target system?
    context: Successful AndX exploitation may result in backdoor deployment, tool staging, or data manipulation.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.mime_type
        - action

  - question: Are there signs of credential harvesting or authentication bypass attempts post-exploitation?
    context: SMB AndX compromise often enables access to cached credentials, SAM database, or authentication tokens.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - lsass.exe
            - reg.exe
            - net.exe
            - whoami.exe
        condition: selection
      fields:
        - CommandLine
        - User
        - ParentImage
        - ProcessGuid

  - question: What network communications or data exfiltration occurred from the compromised system?
    context: AndX exploitation success may lead to command and control communications or sensitive data theft.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toclient
        - duration

  - question: Are other systems experiencing similar AndX-based SMB attacks from coordinated sources?
    context: AndX overflow exploits may indicate automated tools or coordinated campaigns targeting multiple Windows systems.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: "GPL NETBIOS SMB NT Trans NT CREATE andx DACL overflow attempt"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - count

  - question: What external DNS queries or suspicious domain communications followed this attack?
    context: Compromised systems typically establish command and control channels or download additional exploitation tools.
    range: +6h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name