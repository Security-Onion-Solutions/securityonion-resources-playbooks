name: GPL NETBIOS SMB NT Trans NT CREATE invalid SACL ace size dos attempt
id: 22103042
description: |
  Detects potential SMB denial of service attacks using malformed SACL ACE size parameters in NT CREATE requests.
  This attack attempts to crash or destabilize the Windows SMB service through invalid access control entry structures.
  May trigger on corrupted SMB traffic, network transmission errors, or legitimate applications with malformed security descriptors.
type: detection
detection_id: 2103042
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the specific malformed SACL ACE size and structure that triggered this DoS detection?
    context: Invalid ACE sizes can reveal intentional service disruption attempts versus accidental protocol errors.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - src_ip
        - dst_ip
        - payload_printable
        - community_id

  - question: Is this malformed SACL part of normal SMB operations or application behavior for this client?
    context: Some applications may generate invalid security descriptors due to programming errors rather than malicious intent.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 139
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - bytes_toclient
        - duration

  - question: What SMB service stability and performance impact occurred following this invalid ACE attack?
    context: DoS attacks aim to disrupt service availability and may cause connection drops or service restarts.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 139
        condition: selection
      fields:
        - src_ip
        - conn_state
        - duration
        - bytes_toserver

  - question: Are there multiple repeated invalid SACL attempts indicating sustained DoS attack patterns?
    context: Sustained DoS attacks typically involve repeated malformed requests to maximize service disruption impact.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: "invalid SACL ace size"
        condition: selection
      fields:
        - count
        - rule.name

  - question: What other SMB-based attacks or reconnaissance preceded this DoS attempt?
    context: DoS attacks often follow failed exploitation attempts or serve as cover for other malicious activities.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - SMB
            - NETBIOS
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.category

  - question: Has this source IP attempted DoS attacks against other Windows services or ports?
    context: Attackers often target multiple Windows services simultaneously to maximize network disruption impact.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 135
            - 445
            - 3389
            - 5985
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver
        - conn_state

  - question: What system performance or service availability issues manifested on the target server?
    context: DoS attacks may cause high CPU usage, memory exhaustion, or service instability requiring investigation.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - services.exe
            - svchost.exe
            - lsass.exe
        condition: selection
      fields:
        - CommandLine
        - User
        - ParentImage
        - ProcessGuid

  - question: Are there signs of service recovery, restart attempts, or administrative intervention following this DoS?
    context: Successful DoS attacks often trigger automated service recovery or manual administrative response actions.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - net.exe
            - sc.exe
            - powershell.exe
        condition: selection
      fields:
        - CommandLine
        - User
        - ParentImage

  - question: What network traffic patterns or connection anomalies occurred during the DoS attack timeframe?
    context: DoS attacks create distinctive network patterns including connection floods, timeouts, or bandwidth consumption.
    range: -30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 139
        condition: selection
      fields:
        - src_ip
        - conn_state
        - bytes_toserver
        - duration

  - question: Are other systems in the network experiencing similar invalid SACL DoS attacks from multiple sources?
    context: Coordinated DoS campaigns may target multiple systems simultaneously to maximize organizational impact.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: "GPL NETBIOS SMB NT Trans NT CREATE invalid SACL ace size dos attempt"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - count

  - question: What external reconnaissance or scanning activity preceded this targeted DoS attack?
    context: DoS attacks often follow network reconnaissance to identify vulnerable services and optimal attack vectors.
    range: -6h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver
        - duration