name: GPL NETBIOS SMB NT Trans NT CREATE unicode invalid SACL ace size dos attempt
id: 22103044
description: |
  Detects potential SMB denial of service attempts via malformed NT CREATE requests with invalid SACL ACE size parameters.
  May trigger on corrupted SMB packets or legitimate applications with malformed security descriptors.
type: detection
detection_id: 2103044
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the specific invalid SACL ACE size that triggered this denial of service detection?
    context: Understanding the malformed ACE structure reveals the attack technique and potential system impact.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - src_ip
        - dst_ip
        - dst_port
        - payload

  - question: Is this SMB traffic from a known legitimate client or administrative tool?
    context: Some SMB clients or administrative tools may generate malformed packets that trigger false positives.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 139
        condition: selection
      fields:
        - dst_ip
        - bytes_in
        - bytes_out
        - connection_state

  - question: What was the sequence of SMB commands leading to this invalid ACE size attempt?
    context: Understanding the command sequence helps determine if this is intentional DoS or accidental malformation.
    range: -5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 139
        condition: selection
      fields:
        - connection_state
        - bytes_in
        - bytes_out
        - duration

  - question: Has the target SMB service become unresponsive following this attempt?
    context: Successful DoS attacks would cause service disruption and connection failures for legitimate users.
    range: +15m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 139
        condition: selection
      fields:
        - src_ip
        - connection_state
        - duration

  - question: Are there multiple invalid ACE size attempts from this source?
    context: Repeated malformed requests indicate intentional DoS attacks rather than accidental corruption.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "invalid"
            - "ACE"
            - "SACL"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - dst_port

  - question: What other DoS techniques has this attacker employed against SMB services?
    context: Attackers often use multiple DoS vectors to maximize service disruption impact.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "dos"
            - "DoS"
            - "denial"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.category

  - question: Are legitimate users experiencing SMB connectivity issues during this timeframe?
    context: Successful DoS attacks would impact legitimate business operations and user productivity.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - "connection"
            - "timeout"
            - "failed"
        condition: selection
      fields:
        - rule.name
        - src_ip
        - rule.category

  - question: What system resources are being consumed during this DoS attempt?
    context: DoS attacks often consume excessive CPU, memory, or network resources on target systems.
    range: +20m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 139
        condition: selection
      fields:
        - src_ip
        - bytes_in
        - connection_state

  - question: Has this source launched similar DoS attacks against other systems?
    context: Distributed DoS campaigns target multiple systems to maximize network disruption.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "dos"
            - "invalid"
            - "overflow"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.category

  - question: Is this invalid SACL ACE DoS attempt part of a broader attack campaign?
    context: Coordinated DoS attacks across the enterprise indicate sophisticated threat actors or botnets.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: "GPL NETBIOS SMB NT Trans NT CREATE unicode invalid SACL ace size dos attempt"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - host.name