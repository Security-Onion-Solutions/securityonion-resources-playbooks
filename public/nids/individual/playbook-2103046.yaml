name: GPL NETBIOS SMB-DS NT Trans NT CREATE invalid SACL ace size dos attempt
id: 22103046
description: |
  Detects denial of service attempts targeting SMB NT CREATE operations through invalid SACL ACE size manipulation.
  This can cause SMB service crashes or resource exhaustion by sending malformed security descriptor data.
  May trigger on corrupted SMB traffic or legitimate applications with parsing errors.
type: detection
detection_id: 2103046
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the specific invalid SACL ACE size that triggered this denial of service attempt?
    context: Understanding the malformed ACE structure reveals the attack vector and potential impact on SMB parsing.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - src_ip
        - dst_ip
        - src_port
        - dst_port

  - question: What SMB connection pattern preceded this denial of service attempt?
    context: DoS attacks often follow specific connection patterns that distinguish them from legitimate traffic.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - src_port
        - bytes_sent
        - bytes_received
        - duration

  - question: Is this source IP part of normal SMB client activity for this network?
    context: Legitimate clients should have established patterns of SMB usage that differ from attack traffic.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 445
        condition: selection
      fields:
        - dst_ip
        - connection_count

  - question: Are there multiple denial of service attempts from this source targeting SMB services?
    context: Repeated DoS attempts indicate systematic attack rather than accidental malformed traffic.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "dos"
            - "DoS"
            - "SMB"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - dst_port

  - question: Did the SMB service on the target system become unresponsive after this attack?
    context: Successful DoS attacks may cause service crashes or performance degradation visible in connection patterns.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - src_ip
        - connection_count
        - bytes_received

  - question: Are there signs of SMB service restart or system instability following this attack?
    context: DoS attacks may trigger service restarts or system reboots that appear in process creation logs.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - "services.exe"
            - "svchost.exe"
            - "smss.exe"
        condition: selection
      fields:
        - Image
        - CommandLine
        - ProcessGuid

  - question: What other network services on the target system were affected during the attack window?
    context: SMB DoS attacks may impact other Windows services or cause broader system instability.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 135
            - 139
            - 3389
        condition: selection
      fields:
        - dst_port
        - src_ip
        - bytes_received

  - question: Were there any file system errors or corruption indicators during the DoS attack?
    context: SMB parsing errors from malformed packets may cause file system instability or corruption.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.mime_type
        - file.size

  - question: What DNS queries were made by the attacking source before the DoS attempt?
    context: Attackers may perform reconnaissance to identify SMB services before launching denial of service attacks.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  - question: Are other systems in the network experiencing similar SMB denial of service attacks?
    context: Distributed DoS campaigns may target multiple SMB servers simultaneously to maximize impact.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: "GPL NETBIOS SMB-DS NT Trans NT CREATE invalid SACL ace size dos attempt"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert_count

  - question: What is the attack pattern and reputation context for this source IP?
    context: Understanding the source's attack history helps determine if this is part of a larger campaign.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - rule.category
        - rule.name
        - dst_ip