name: GPL NETBIOS SMB-DS NT Trans NT CREATE unicode invalid SACL ace size dos attempt
id: 22103048
description: |
  Detects denial of service attempts targeting SMB NT Transaction NT CREATE commands with invalid SACL ACE sizes.
  This attack manipulates SACL Access Control Entry structures to cause system instability or crashes.
  May trigger on corrupted SMB traffic or legitimate applications with malformed SACL structures.
type: detection
detection_id: 2103048
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the specific invalid SACL ACE size that triggered this denial of service detection?
    context: Understanding the malformed ACE size reveals the attack's technical approach and potential impact.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - alert.signature
        - src_ip
        - dst_ip
        - flow_id

  - question: What SMB NT Transaction parameters were manipulated in this attack attempt?
    context: Analyzing the transaction structure helps identify the specific vulnerability being exploited.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - protocol
        - bytes_toserver
        - bytes_toclient
        - duration

  # Type 2: Triage Assessment
  - question: Is this source IP authorized to access SMB services on the target system?
    context: Legitimate administrators may cause false positives during complex file operations or system maintenance.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - service

  - question: Does this activity pattern match normal SMB usage for this network segment?
    context: DoS attempts often show unusual traffic patterns compared to legitimate file sharing operations.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - src_ip
        - bytes_toserver

  # Type 3: Activity Context
  - question: What SMB operations preceded this invalid SACL ACE size attempt?
    context: DoS attacks often follow reconnaissance or failed authentication attempts.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - src_port
        - bytes_toserver
        - bytes_toclient

  - question: Were there multiple connection attempts or SMB protocol violations from this source?
    context: DoS campaigns typically involve repeated malformed requests to overwhelm the target service.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.category: "protocol-command-decode"
        condition: selection
      fields:
        - alert.signature
        - dst_ip
        - dst_port

  # Type 4: Impact Assessment
  - question: Did the target SMB service show signs of instability or performance degradation after this attempt?
    context: Successful DoS attacks may cause service crashes or resource exhaustion on the target system.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - src_ip
        - duration
        - bytes_toserver

  - question: Were there system errors or service restarts on the target following this attack?
    context: Invalid SACL manipulation may cause SMB service crashes requiring restart or system reboot.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - "services.exe"
            - "svchost.exe"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  # Type 5: Forensic Deep-Dive
  - question: What specific SACL structure manipulation technique was used in this DoS attempt?
    context: Detailed analysis of the malformed SACL helps identify the attack tool and methodology.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - alert.metadata
        - flow_id

  - question: Are there patterns indicating automated tooling or manual exploitation techniques?
    context: Understanding attack automation helps assess threat actor sophistication and campaign scope.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.category: "protocol-command-decode"
        condition: selection
      fields:
        - alert.signature
        - dst_ip

  # Type 6: Enterprise Correlation
  - question: Are other systems experiencing similar SMB DoS attempts with invalid SACL structures?
    context: Coordinated DoS campaigns often target multiple systems simultaneously to maximize impact.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature_id: 2103048
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature

  - question: Is this part of a broader network-wide DoS campaign targeting SMB services?
    context: Understanding campaign scope helps prioritize defensive measures and incident response efforts.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 445
          alert.category|contains:
            - "attempted-dos"
            - "protocol-command-decode"
        condition: selection
      fields:
        - dst_ip
        - alert.signature