name: GPL NETBIOS SMB NT Trans NT CREATE invalid SACL ace size dos attempt
id: 22103050
description: |
  Detects potential SMB denial of service attacks using malformed SACL ACE size parameters in NT CREATE requests.
  This variant targets different SACL offset parameters to crash or destabilize the Windows SMB service.
  May trigger on corrupted SMB packets, network transmission errors, or applications with malformed security descriptors.
type: detection
detection_id: 2103050
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the specific malformed SACL ACE structure and offset that triggered this DoS detection?
    context: Different ACE offset variations can indicate specific DoS techniques or distinguish between intentional attacks and protocol errors.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - src_ip
        - dst_ip
        - payload_printable
        - community_id

  - question: Is this malformed SACL pattern consistent with previous SMB traffic from this client system?
    context: Legitimate applications with programming bugs may consistently generate invalid security descriptors versus one-time attacks.
    range: -72h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 139
        condition: selection
      fields:
        - bytes_toserver
        - bytes_toclient
        - duration
        - conn_state

  - question: What immediate SMB service response and connection handling occurred after this invalid ACE attempt?
    context: DoS attacks aim to disrupt service functionality and may cause immediate connection termination or service errors.
    range: +10m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 139
        condition: selection
      fields:
        - conn_state
        - duration
        - bytes_toserver
        - bytes_toclient

  - question: Are there patterns of repeated invalid SACL attacks indicating systematic DoS campaign?
    context: Coordinated DoS attacks involve multiple malformed requests to achieve maximum service disruption impact.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "invalid SACL ace size dos"
        condition: selection
      fields:
        - dst_ip
        - count
        - rule.name

  - question: What other Windows service disruption attempts occurred from this source IP address?
    context: DoS attackers often target multiple Windows services simultaneously to maximize organizational network impact.
    range: -6h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - dos
            - DoS
            - overflow
            - invalid
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.category

  - question: Has this attacker performed reconnaissance or port scanning before launching DoS attacks?
    context: DoS attacks typically follow network reconnaissance to identify vulnerable services and optimal attack vectors.
    range: -8h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver
        - duration

  - question: What system resource consumption or performance degradation occurred on the target server?
    context: Successful DoS attacks may cause CPU spikes, memory exhaustion, or service instability requiring monitoring.
    range: +45m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - services.exe
            - svchost.exe
            - System
        condition: selection
      fields:
        - CommandLine
        - User
        - ProcessGuid

  - question: Are there indicators of service restart, recovery, or administrative response to this DoS attack?
    context: DoS impact often triggers automated service recovery mechanisms or manual administrative intervention.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - net.exe
            - sc.exe
            - taskkill.exe
            - restart.exe
        condition: selection
      fields:
        - CommandLine
        - User
        - ParentImage

  - question: What network connectivity issues or service availability problems manifested during this attack?
    context: DoS attacks create network disruption patterns including connection failures, timeouts, or bandwidth saturation.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 139
          conn_state|contains:
            - timeout
            - reset
            - failed
        condition: selection
      fields:
        - src_ip
        - conn_state
        - duration

  - question: Are multiple network systems experiencing coordinated invalid SACL DoS attacks simultaneously?
    context: Distributed DoS campaigns may target multiple organizational systems to maximize disruption and complicate response.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: "GPL NETBIOS SMB NT Trans NT CREATE invalid SACL ace size dos attempt"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - count

  - question: What suspicious external communications or command infrastructure was contacted by the attacking system?
    context: DoS attacks may be coordinated through command and control infrastructure or part of broader malicious campaigns.
    range: -12h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name