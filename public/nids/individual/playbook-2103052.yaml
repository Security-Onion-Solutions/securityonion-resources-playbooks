name: GPL NETBIOS SMB NT Trans NT CREATE unicode invalid SACL ace size dos attempt
id: 22103052
description: |
  Detects potential SMB denial of service attempts via malformed NT CREATE requests with invalid SACL ACE size parameters using alternate detection logic.
  May trigger on corrupted SMB packets or applications with malformed security descriptor implementations.
type: detection
detection_id: 2103052
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the specific malformed SACL structure detected in this alternate DoS pattern?
    context: This rule uses different detection logic than SID 2103044, potentially catching additional DoS variants.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - src_ip
        - dst_ip
        - dst_port
        - payload

  - question: Is this source generating both SID 2103044 and 2103052 alerts simultaneously?
    context: Multiple rule triggers indicate sophisticated DoS attempts using various malformation techniques.
    range: -10m
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - "invalid SACL ace size dos"
        condition: selection
      fields:
        - rule.name
        - detection_id

  - question: What SMB client behavior patterns preceded this alternate DoS detection?
    context: Understanding client behavior helps distinguish between malicious DoS and buggy SMB implementations.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 139
        condition: selection
      fields:
        - connection_state
        - bytes_in
        - bytes_out
        - duration

  - question: Are there signs of SMB service instability following this DoS variant?
    context: Different DoS techniques may have varying impacts on service stability and performance.
    range: +20m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 139
        condition: selection
      fields:
        - src_ip
        - connection_state
        - duration
        - bytes_in

  - question: What other SMB protocol anomalies has this source generated?
    context: Attackers may test multiple protocol parsing vulnerabilities to find effective DoS vectors.
    range: -3h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "SMB"
            - "NETBIOS"
            - "protocol"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.category

  - question: Has this alternate DoS technique affected multiple SMB services simultaneously?
    context: Successful DoS variants may impact both NetBIOS (139) and direct SMB (445) services.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 139
            - 445
        condition: selection
      fields:
        - dst_port
        - src_ip
        - connection_state
        - bytes_in

  - question: What security descriptor parsing errors might this DoS technique exploit?
    context: Invalid ACE sizes can trigger parsing errors that consume excessive resources or crash services.
    range: -5m
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - "security descriptor"
            - "ACE"
            - "parsing"
        condition: selection
      fields:
        - rule.name
        - rule.category

  - question: Are there indicators of automated DoS tool usage in this attack pattern?
    context: Automated tools often generate consistent timing patterns and payload structures across attempts.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "dos"
            - "invalid"
            - "malformed"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.category

  - question: What is the scope of this DoS campaign across enterprise SMB services?
    context: Enterprise-wide DoS attacks indicate coordinated campaigns or worm-like propagation.
    range: -8h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: "GPL NETBIOS SMB NT Trans NT CREATE unicode invalid SACL ace size dos attempt"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - host.name
        - detection_id

  - question: Has this DoS technique resulted in service crashes or system instability?
    context: Effective DoS attacks may cause service crashes requiring manual intervention or system reboots.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          rule.name|contains:
            - "crash"
            - "restart"
            - "service"
        condition: selection
      fields:
        - rule.name
        - rule.category