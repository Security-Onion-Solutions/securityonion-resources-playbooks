name: GPL NETBIOS SMB-DS NT Trans NT CREATE invalid SACL ace size dos attempt
id: 22103054
description: |
  Detects denial of service attempts targeting SMB NT CREATE operations through invalid SACL ACE size manipulation.
  This variant targets different offset positions in the security descriptor to cause SMB service crashes.
  May trigger on corrupted SMB traffic or applications with security descriptor parsing issues.
type: detection
detection_id: 2103054
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the specific malformed SACL ACE structure that triggered this DoS detection?
    context: Different offset variants of this attack reveal specific exploitation techniques and parsing vulnerabilities.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - src_ip
        - dst_ip
        - src_port
        - dst_port

  - question: What SMB session establishment preceded this denial of service attack?
    context: Understanding the SMB handshake helps distinguish legitimate parsing errors from intentional DoS attacks.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - src_port
        - bytes_sent
        - bytes_received
        - duration

  - question: Is this source IP authorized for SMB access in this environment?
    context: Legitimate SMB clients should have documented access patterns that differ from attack sources.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 445
        condition: selection
      fields:
        - dst_ip
        - connection_count

  - question: Are there multiple variants of SMB DoS attacks from this source?
    context: Attackers may use multiple DoS techniques to find effective vectors against the target SMB service.
    range: -24h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "SACL"
            - "dos"
            - "SMB"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - dst_port

  - question: Did the target SMB service exhibit signs of instability after this attack?
    context: Successful DoS attacks cause measurable service degradation or unavailability in connection metrics.
    range: +30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - src_ip
        - connection_count
        - bytes_received

  - question: Were there any Windows service restarts or crashes following this DoS attempt?
    context: SMB parsing errors may trigger service restarts or system instability visible in process logs.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - "services.exe"
            - "svchost.exe"
            - "winlogon.exe"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: What impact did this attack have on other Windows network services?
    context: SMB DoS attacks may cause cascading failures in dependent Windows services and protocols.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 135
            - 139
            - 3389
            - 53
        condition: selection
      fields:
        - dst_port
        - src_ip
        - bytes_received
        - duration

  - question: Were any file operations disrupted during the SMB denial of service attack?
    context: SMB DoS attacks may interrupt file operations or cause file system instability on the target.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.size
        - file.mime_type

  - question: What reconnaissance activity preceded this denial of service attack?
    context: Attackers may perform DNS or port scanning to identify SMB services before launching DoS attacks.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name

  - question: Are multiple systems being targeted with this specific SMB DoS variant?
    context: Coordinated DoS campaigns may use the same attack variant against multiple vulnerable SMB servers.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: "GPL NETBIOS SMB-DS NT Trans NT CREATE invalid SACL ace size dos attempt"
          detection_id: "2103054"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert_count

  - question: What is the broader attack context and threat intelligence for this source?
    context: Understanding the source's attack history helps assess whether this is isolated or part of a campaign.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - rule.category
        - rule.name
        - dst_ip