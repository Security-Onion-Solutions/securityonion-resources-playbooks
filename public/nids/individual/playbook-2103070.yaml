name: GPL IMAP fetch overflow attempt
id: 22103070
description: |
  Detects potential buffer overflow attempts in IMAP FETCH commands with excessive length.
  May indicate exploitation attempts against IMAP servers or legitimate large email operations.
  Long FETCH commands can trigger vulnerabilities in poorly implemented IMAP servers.
type: detection
detection_id: 2103070
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact IMAP FETCH command and its length?
    context: Analyzing the command structure reveals if this is a legitimate operation or exploitation attempt.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - rule.name
        - event.severity

  - question: What IMAP connection details were involved in this overflow attempt?
    context: Connection metadata helps identify the attack source and target IMAP server.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_port
        - dst_port
        - network.bytes

  # Type 2: Triage Assessment
  - question: Is this source IP an authorized email client or administrator?
    context: Legitimate email clients may generate long FETCH commands for large mailboxes.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 143
            - 993
            - 110
            - 995
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - network.bytes

  - question: Does this IMAP server normally handle large FETCH operations?
    context: Some environments legitimately process large email attachments or bulk operations.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 143
        condition: selection
      fields:
        - src_ip
        - network.bytes
        - network.packets

  # Type 3: Activity Context
  - question: What IMAP authentication preceded this FETCH attempt?
    context: Understanding the authentication context helps determine if this is an authorized session.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: "IMAP"
        condition: selection
      fields:
        - rule.name
        - event.severity

  - question: What was the sequence of IMAP commands in this session?
    context: Command sequence analysis reveals if this follows normal email client behavior.
    range: -15m/+15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 143
        condition: selection
      fields:
        - network.bytes
        - network.packets

  - question: Were there multiple overflow attempts from this source?
    context: Repeated attempts suggest active exploitation rather than accidental oversized commands.
    range: -1h/+1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "overflow"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - dst_port

  # Type 4: Impact Assessment
  - question: Did the IMAP server respond abnormally to this FETCH command?
    context: Server crashes or error responses indicate successful exploitation attempts.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
          src_port: 143
        condition: selection
      fields:
        - network.bytes
        - network.packets

  - question: Are there signs of successful compromise following this attempt?
    context: Post-exploitation activity may include command execution or data exfiltration.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.category|contains:
            - "trojan-activity"
            - "successful-admin"
        condition: selection
      fields:
        - rule.name
        - event.severity

  # Type 5: Forensic Deep-Dive
  - question: What specific IMAP server software is running on the target?
    context: Different IMAP implementations have varying vulnerability profiles for buffer overflows.
    range: -1h/+1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 143
        condition: selection
      fields:
        - src_ip
        - network.bytes
        - network.packets

  - question: Are there indicators of exploit code or shellcode in the FETCH command?
    context: Malicious FETCH commands may contain encoded payloads for code execution.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          community_id|expand: '%community_id%'
          rule.category|contains:
            - "shellcode-detect"
            - "exploit-kit"
        condition: selection
      fields:
        - rule.name
        - payload

  # Type 6: Enterprise Correlation
  - question: Are other IMAP servers being targeted with similar overflow attempts?
    context: Coordinated attacks often target multiple email servers simultaneously.
    range: -2h/+2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "IMAP"
          rule.name|contains: "overflow"
        condition: selection
      fields:
        - dst_ip
        - rule.name

  - question: Is this part of a broader email infrastructure attack campaign?
    context: Email attacks often include SMTP, POP3, and IMAP targeting from the same source.
    range: -4h/+4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 25
            - 110
            - 143
            - 465
            - 587
            - 993
            - 995
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - rule.name