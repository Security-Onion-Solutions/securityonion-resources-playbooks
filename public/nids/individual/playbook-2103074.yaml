name: GPL IMAP subscribe overflow attempt
id: 22103074
description: |
  Detects potential buffer overflow attempts against IMAP servers via excessively long SUBSCRIBE commands.
  May trigger on legitimate IMAP clients with very long mailbox names, but typically indicates exploitation attempts targeting IMAP command parsing vulnerabilities.
type: detection
detection_id: 2103074
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact SUBSCRIBE command and payload length that triggered this overflow detection?
    context: Understanding the command structure and length helps determine if this is legitimate mailbox subscription or exploitation attempt.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - src_ip
        - dst_ip
        - dst_port
        - community_id

  - question: What mailbox name or pattern was specified in the SUBSCRIBE command?
    context: Analyzing the mailbox name structure reveals whether this is a legitimate nested folder or malicious overflow payload.
    range: -5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - bytes_toserver
        - bytes_toclient

  # Type 2: Triage Assessment
  - question: Is this source IP a known legitimate email client for this IMAP server?
    context: Authorized email clients may have legitimate reasons for subscribing to deeply nested folder structures.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 143
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - connection_count

  - question: Does this IMAP server normally handle SUBSCRIBE commands of this length?
    context: Some IMAP servers legitimately support very long mailbox names for complex folder hierarchies.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 143
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - connection_count

  # Type 3: Activity Context
  - question: What IMAP authentication and session setup occurred before this SUBSCRIBE attempt?
    context: Understanding the session context helps determine if this was part of normal email client operation or exploitation.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 143
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - connection_state
        - duration

  - question: Were there other IMAP commands with unusual lengths attempted from this source?
    context: Multiple oversized commands indicate systematic exploitation rather than client misconfiguration.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "IMAP"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - alert_count

  # Type 4: Impact Assessment
  - question: How did the IMAP server respond to this oversized SUBSCRIBE command?
    context: Server response patterns indicate whether the buffer overflow vulnerability was successfully triggered.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - bytes_toclient
        - connection_state

  - question: Are there signs of service disruption or abnormal behavior on the target IMAP server?
    context: Successful buffer overflow exploitation may cause service crashes or unexpected process behavior.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  # Type 5: Forensic Deep-Dive
  - question: What specific buffer overflow technique is being employed in this SUBSCRIBE attack?
    context: Different IMAP implementations have varying SUBSCRIBE parsing vulnerabilities with distinct exploitation patterns.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - community_id

  - question: Is there evidence of shellcode or payload injection through the SUBSCRIBE overflow?
    context: Successful buffer overflows often include payload delivery mechanisms for remote code execution.
    range: +10m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 143
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - bytes_toserver
        - bytes_toclient

  # Type 6: Enterprise Correlation
  - question: Are other IMAP servers in the environment experiencing similar SUBSCRIBE overflow attempts?
    context: Coordinated attacks against multiple IMAP servers indicate a broader campaign targeting email infrastructure.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "IMAP"
            - "subscribe"
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - alert_count

  - question: Is this part of a systematic attack pattern targeting IMAP command parsing vulnerabilities?
    context: Multiple IMAP overflow variants suggest sophisticated exploitation toolkit usage against email infrastructure.
    range: -48h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - "IMAP"
            - "overflow"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - alert_count