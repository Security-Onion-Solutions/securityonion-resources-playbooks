name: GPL IMAP unsubscribe literal overflow attempt
id: 22103075
description: |
  Detects potential buffer overflow attempts against IMAP servers via UNSUBSCRIBE commands with malicious literal values.
  May trigger on legitimate IMAP clients using large literal values, but typically indicates exploitation attempts targeting IMAP literal parsing vulnerabilities.
type: detection
detection_id: 2103075
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the literal value size specified in the UNSUBSCRIBE command that exceeded 256 bytes?
    context: IMAP literal values above normal thresholds often indicate buffer overflow exploitation attempts.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - src_ip
        - dst_ip
        - dst_port
        - community_id

  - question: What is the exact format of the UNSUBSCRIBE literal command structure?
    context: Understanding the literal syntax helps distinguish between legitimate large literals and malicious overflow attempts.
    range: -5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - bytes_toserver
        - bytes_toclient

  # Type 2: Triage Assessment
  - question: Does this IMAP client normally use literal values in UNSUBSCRIBE commands?
    context: Some legitimate IMAP clients use literals for special characters in mailbox names, but large literals are uncommon.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 143
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - connection_count

  - question: Is this source IP authorized to access this IMAP server?
    context: Unauthorized sources attempting literal overflow attacks indicate external exploitation attempts.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 143
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - connection_count

  # Type 3: Activity Context
  - question: What IMAP session state was established before this literal overflow attempt?
    context: Understanding the session context helps determine if this was part of normal operation or exploitation.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 143
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - connection_state
        - duration

  - question: Were there other IMAP literal commands attempted from this source?
    context: Multiple literal overflow attempts indicate systematic exploitation rather than client error.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "IMAP"
            - "literal"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - alert_count

  # Type 4: Impact Assessment
  - question: Did the IMAP server process or reject the oversized literal value?
    context: Server response patterns indicate whether the vulnerability was successfully exploited.
    range: +10m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - bytes_toclient
        - connection_state

  - question: Are there signs of memory corruption or service disruption on the IMAP server?
    context: Successful literal overflow exploitation may cause service instability or crashes.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  # Type 5: Forensic Deep-Dive
  - question: What specific literal parsing vulnerability is being targeted by this overflow attempt?
    context: Different IMAP implementations have varying literal parsing vulnerabilities with distinct exploitation signatures.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - community_id

  - question: Is there evidence of payload delivery through the literal overflow mechanism?
    context: Successful literal overflows may deliver shellcode or other malicious payloads to the target system.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 143
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - bytes_toserver
        - bytes_toclient

  # Type 6: Enterprise Correlation
  - question: Are other IMAP servers receiving similar literal overflow attempts from this source?
    context: Coordinated literal overflow attacks across multiple servers indicate a targeted campaign against email infrastructure.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "IMAP"
            - "overflow"
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - alert_count

  - question: Is this part of a broader attack pattern targeting IMAP literal parsing vulnerabilities?
    context: Multiple literal overflow variants may indicate sophisticated exploitation toolkit usage.
    range: -48h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - "IMAP"
            - "literal"
            - "overflow"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name
        - alert_count