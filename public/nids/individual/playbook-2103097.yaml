name: GPL NETBIOS SMB-DS llsrpc unicode andx create tree attempt
id: 22103097
description: |
  Detects SMB connection attempts to the llsrpc service using unicode encoding.
  This could indicate legitimate administrative access or potential lateral movement attempts.
  The llsrpc service is used for license logging and may be targeted for privilege escalation.
type: detection
detection_id: 2103097
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete SMB tree connect request structure and unicode payload?
    context: Understanding the exact SMB command structure reveals the nature of the llsrpc access attempt.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - src_ip
        - dst_ip
        - dst_port
        - community_id

  - question: What SMB session context preceded this llsrpc tree connect attempt?
    context: Previous SMB negotiations and authentication provide context for this service access.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - src_port
        - protocol
        - bytes_toserver
        - bytes_toclient

  # Type 2: Triage Assessment
  - question: Is this SMB connection from a known administrative workstation or server?
    context: Legitimate llsrpc access typically occurs from domain controllers or license servers.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 445
        condition: selection
      fields:
        - dst_ip
        - community_id

  - question: Does this activity align with normal business hours and administrative schedules?
    context: License logging typically occurs during business operations or scheduled maintenance windows.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "SMB"
        condition: selection
      fields:
        - dst_ip
        - rule.category

  # Type 3: Activity Context
  - question: What authentication events preceded this SMB llsrpc access attempt?
    context: Understanding the authentication context reveals whether this is part of legitimate domain activity.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - "net.exe"
            - "psexec"
            - "wmic.exe"
        condition: selection
      fields:
        - User
        - CommandLine
        - ProcessGuid

  - question: What other SMB services were accessed from this source around the same time?
    context: Multiple SMB service access attempts may indicate reconnaissance or lateral movement.
    range: +/-30m
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "SMB"
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - dst_port

  # Type 4: Impact Assessment
  - question: Did the llsrpc service connection succeed and what data was transferred?
    context: Successful connections with significant data transfer may indicate successful exploitation or data access.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - bytes_toserver
        - bytes_toclient
        - duration

  - question: Are there signs of privilege escalation or service manipulation following this access?
    context: Successful llsrpc exploitation may lead to license service abuse or privilege escalation.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - "sc.exe"
            - "net.exe"
            - "reg.exe"
        condition: selection
      fields:
        - User
        - CommandLine
        - ProcessGuid

  # Type 5: Forensic Deep-Dive
  - question: What specific license logging service functions were targeted in this request?
    context: Different llsrpc functions have varying security implications and exploitation potential.
    range: +/-5m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          community_id|expand: '%community_id%'
          rule.name|contains: "llsrpc"
        condition: selection
      fields:
        - rule.name
        - rule.category
        - src_ip
        - dst_ip

  - question: Are there indicators of known SMB exploitation tools or techniques?
    context: Specific tools like PsExec or Metasploit modules have characteristic SMB communication patterns.
    range: +/-1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "EXPLOIT"
            - "ATTACK"
            - "SHELLCODE"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.category

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network experiencing similar SMB llsrpc access attempts?
    context: Coordinated llsrpc access across multiple systems suggests automated attack tools or worm activity.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "llsrpc"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is this part of a broader SMB-based lateral movement campaign in the environment?
    context: Multiple SMB service access attempts may indicate advanced persistent threat activity.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "SMB"
          rule.category|contains: "NETBIOS"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name