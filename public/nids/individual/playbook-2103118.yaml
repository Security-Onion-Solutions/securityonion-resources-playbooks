name: GPL NETBIOS SMB llsrconnect AndX Overflow Attempt
id: 22103118
description: |
  Detects SMB llsrconnect overflow attempts targeting the License Logging Service RPC interface.
  May indicate exploitation attempts against Windows License Logging Service or legitimate RPC connections.
  Requires prior SMB tree binding to LLSRPC service.
type: detection
detection_id: 2103118
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the specific llsrconnect overflow payload structure?
    context: LLSRPC overflow details reveal exploitation techniques targeting Windows License Logging Service vulnerabilities.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - alert.signature
        - payload_printable
        - src_ip
        - dst_ip
        - dst_port
  - question: Is this system normally accessed for license management from this source?
    context: Legitimate license management access patterns help distinguish authorized RPC calls from attacks.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 139
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - bytes_toserver
        - bytes_toclient
  - question: What SMB tree binding to LLSRPC preceded this overflow attempt?
    context: Prior LLSRPC binding context reveals the complete attack chain targeting License Logging Service.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          alert.signature|contains: 'llsrpc'
        condition: selection
      fields:
        - alert.signature
        - src_ip
        - dst_ip
  - question: Are there other RPC-based overflow attempts from this source?
    context: Multiple RPC overflow attempts indicate systematic exploitation of Windows RPC services.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains:
            - 'RPC'
            - 'overflow'
            - 'PIPE'
        condition: selection
      fields:
        - alert.signature
        - dst_ip
        - dst_port
  - question: Has successful RPC communication occurred after this overflow attempt?
    context: Successful post-exploit RPC communication may indicate vulnerability exploitation success.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 139
          bytes_toclient|gt: 500
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - bytes_toserver
        - bytes_toclient
  - question: What License Logging Service processes are running on the target system?
    context: Understanding LLS service status helps assess exploitation potential and impact scope.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - 'llssrv.exe'
            - 'services.exe'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid
  - question: Are there signs of License Logging Service compromise?
    context: Successful LLSRPC exploitation may lead to service compromise and system access.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains: 'llssrv.exe'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid
  - question: What administrative access attempts followed this LLSRPC overflow?
    context: Post-exploitation administrative access indicates successful compromise and privilege escalation.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 139
            - 445
            - 135
            - 3389
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - bytes_toserver
  - question: Are other systems showing similar LLSRPC exploitation patterns?
    context: Enterprise-wide LLSRPC attacks may indicate coordinated exploitation targeting Windows license infrastructure.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains:
            - 'llsrconnect'
            - 'LLSRPC'
            - 'overflow'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature