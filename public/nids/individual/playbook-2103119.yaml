name: GPL NETBIOS SMB llsrconnect Little Endian AndX Overflow Attempt
id: 22103119
description: |
  Detects SMB llsrconnect overflow attempts with little endian encoding targeting the License Logging Service RPC interface.
  May indicate exploitation attempts against Windows License Logging Service or legitimate RPC connections.
  Requires prior SMB tree binding to LLSRPC service with little endian byte ordering.
type: detection
detection_id: 2103119
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the specific little endian llsrconnect overflow payload structure?
    context: Little endian LLSRPC overflow details reveal advanced exploitation techniques targeting Windows License Logging Service.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - alert.signature
        - payload_printable
        - src_ip
        - dst_ip
        - dst_port
  - question: Is this system normally accessed for license management with little endian encoding?
    context: Little endian license management patterns help distinguish legitimate RPC calls from sophisticated attacks.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 139
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - bytes_toserver
        - bytes_toclient
  - question: What little endian SMB tree binding to LLSRPC preceded this overflow?
    context: Prior little endian LLSRPC binding reveals sophisticated attack preparation targeting License Logging Service.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          alert.signature|contains:
            - 'llsrpc'
            - 'little endian'
        condition: selection
      fields:
        - alert.signature
        - src_ip
        - dst_ip
  - question: Are there other little endian RPC-based overflow attempts from this source?
    context: Multiple little endian RPC attacks indicate advanced exploitation techniques targeting Windows RPC services.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains:
            - 'little endian'
            - 'overflow'
            - 'RPC'
        condition: selection
      fields:
        - alert.signature
        - dst_ip
        - dst_port
  - question: Has successful little endian RPC communication occurred after this overflow?
    context: Successful post-exploit little endian RPC communication may indicate advanced vulnerability exploitation success.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 139
          bytes_toclient|gt: 500
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - bytes_toserver
        - bytes_toclient
  - question: What License Logging Service processes support little endian operations on the target?
    context: Understanding LLS little endian support helps assess advanced exploitation potential and impact scope.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - 'llssrv.exe'
            - 'services.exe'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid
  - question: Are there signs of advanced License Logging Service compromise?
    context: Successful little endian LLSRPC exploitation may lead to sophisticated service compromise and system access.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains: 'llssrv.exe'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid
  - question: What advanced administrative access attempts followed this little endian overflow?
    context: Post-exploitation administrative access with little endian techniques indicates sophisticated compromise methods.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 139
            - 445
            - 135
            - 3389
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - bytes_toserver
  - question: Are other systems showing similar little endian LLSRPC exploitation patterns?
    context: Enterprise-wide little endian LLSRPC attacks indicate advanced persistent threat targeting Windows license infrastructure.
    range: -4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains:
            - 'llsrconnect'
            - 'little endian'
            - 'overflow'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature