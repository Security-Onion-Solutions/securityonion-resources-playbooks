name: GPL NETBIOS SMB llsrconnect unicode andx overflow attempt
id: 22103120
description: |
  Detects potential buffer overflow attempts targeting the SMB llsrconnect service via unicode manipulation.
  May trigger on legitimate SMB administrative tools or malformed packets.
  This targets MS05-010 vulnerability in Windows SMB service.
type: detection
detection_id: 2103120
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact SMB packet structure and unicode payload in the overflow attempt?
    context: Analyzing the SMB packet reveals the specific exploitation technique and target service.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - rule.name
        - alert.signature

  - question: What SMB tree connection was established before this overflow attempt?
    context: Understanding the SMB session context helps identify the attack vector and target service.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 139
        condition: selection
      fields:
        - src_port
        - connection_state
        - bytes_toserver
        - bytes_toclient

  # Type 2: Triage Assessment
  - question: Is this source IP authorized for SMB administrative access to this system?
    context: Legitimate network administrators may use SMB tools that could trigger false positives.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 139
            - 445
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection_state

  - question: Does this activity align with scheduled maintenance or business operations?
    context: SMB administrative tools may be used during maintenance windows causing legitimate alerts.
    range: -1d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - "NETBIOS"
            - "SMB"
        condition: selection
      fields:
        - rule.name
        - alert.severity
        - dst_ip

  # Type 3: Activity Context
  - question: What other SMB-related activity occurred from this source around the same time?
    context: Buffer overflow attempts are often part of larger SMB exploitation campaigns.
    range: -30m/+30m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category: "NETBIOS"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - dst_port
        - alert.severity

  - question: What network reconnaissance preceded this overflow attempt?
    context: Attackers typically scan for SMB services before attempting exploitation.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 139
            - 445
            - 135
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection_state
        - bytes_toserver

  # Type 4: Impact Assessment
  - question: Did the SMB service crash or restart after this overflow attempt?
    context: Successful buffer overflows may cause service disruption or system instability.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 139
        condition: selection
      fields:
        - src_ip
        - connection_state
        - bytes_toserver
        - bytes_toclient

  - question: Are there signs of successful privilege escalation or code execution?
    context: Successful SMB exploits may lead to system compromise and lateral movement.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.category|contains:
            - "SHELLCODE"
            - "TROJAN"
            - "BACKDOOR"
        condition: selection
      fields:
        - rule.name
        - src_ip
        - alert.severity

  # Type 5: Forensic Deep-Dive
  - question: What specific MS05-010 exploitation technique was used in this attempt?
    context: Different exploit variants target specific Windows versions and service configurations.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - flow_id
        - proto

  - question: Are there indicators of exploit kit or automated tool usage?
    context: Automated tools leave specific patterns in SMB exploitation attempts.
    range: -1h/+1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - "EXPLOIT"
            - "SHELLCODE"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - alert.severity

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network experiencing similar SMB overflow attempts?
    context: Coordinated attacks often target multiple systems with the same vulnerability.
    range: -2h/+2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: "GPL NETBIOS SMB llsrconnect unicode andx overflow attempt"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.severity

  - question: Is this part of a broader campaign targeting Windows SMB services?
    context: SMB exploits are often part of larger campaigns targeting Windows infrastructure.
    range: -24h/+24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category: "NETBIOS"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - alert.severity