name: GPL NETBIOS SMB llsrconnect unicode little endian andx overflow attempt
id: 22103121
description: |
  Detects potential buffer overflow attempts targeting SMB llsrconnect service using little endian unicode encoding.
  May trigger on legitimate SMB administrative tools or malformed packets.
  This targets MS05-010 vulnerability with specific endianness exploitation.
type: detection
detection_id: 2103121
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the specific little endian unicode encoding pattern in this overflow attempt?
    context: Little endian encoding reveals targeted Windows architecture and exploitation technique.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - rule.name
        - alert.signature

  - question: How does this SMB packet structure differ from the standard unicode variant?
    context: Comparing endianness variants helps identify specific exploit tools and target systems.
    range: -1h/+1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: "llsrconnect unicode"
        condition: selection
      fields:
        - rule.name
        - payload
        - alert.signature

  # Type 2: Triage Assessment
  - question: Is this source IP known for legitimate SMB administrative activities?
    context: Network administrators using specific SMB tools may trigger endianness-specific alerts.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 139
            - 445
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection_state

  - question: Does the timing correlate with authorized maintenance or testing activities?
    context: Security testing or system maintenance may involve SMB protocol testing.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.category: "NETBIOS"
        condition: selection
      fields:
        - src_ip
        - rule.name
        - alert.severity

  # Type 3: Activity Context
  - question: What SMB enumeration or reconnaissance preceded this little endian attack?
    context: Attackers often probe SMB services to determine architecture before launching targeted exploits.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 139
            - 445
            - 135
        condition: selection
      fields:
        - dst_port
        - connection_state
        - bytes_toserver
        - bytes_toclient

  - question: What other endianness-specific exploits were attempted from this source?
    context: Sophisticated attackers may test multiple endianness variants to ensure exploitation success.
    range: -1h/+1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "endian"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - dst_port
        - alert.severity

  # Type 4: Impact Assessment
  - question: Did the target system exhibit signs of successful exploitation or compromise?
    context: Little endian exploits targeting specific architectures may achieve higher success rates.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.category|contains:
            - "SHELLCODE"
            - "TROJAN"
            - "BACKDOOR"
        condition: selection
      fields:
        - rule.name
        - src_ip
        - alert.severity

  - question: Are there indicators of SMB service disruption or system instability?
    context: Buffer overflow attempts may cause service crashes or system instability.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 139
        condition: selection
      fields:
        - src_ip
        - connection_state
        - bytes_toserver

  # Type 5: Forensic Deep-Dive
  - question: What specific MS05-010 exploit variant utilized little endian encoding?
    context: Different exploit tools use varying endianness approaches for Windows SMB exploitation.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - flow_id
        - proto

  - question: Are there signatures of known exploit frameworks or tools?
    context: Popular exploit frameworks have distinct patterns in SMB exploitation attempts.
    range: -30m/+30m
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - "EXPLOIT"
            - "SHELLCODE"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - alert.severity

  # Type 6: Enterprise Correlation
  - question: Are other Windows systems experiencing similar little endian SMB attacks?
    context: Targeted campaigns often use architecture-specific exploits against similar systems.
    range: -4h/+4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: "GPL NETBIOS SMB llsrconnect unicode little endian andx overflow attempt"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.severity

  - question: Is this attack part of a broader Windows infrastructure targeting campaign?
    context: Little endian exploits suggest specific Windows version targeting in coordinated attacks.
    range: -24h/+24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "MS05-010"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - alert.severity