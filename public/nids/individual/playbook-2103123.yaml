name: GPL NETBIOS SMB-DS llsrconnect Little Endian Overflow Attempt
id: 22103123
description: |
  Detects potential buffer overflow exploitation attempts in the License Logging Service (llsrconnect) via SMB with little endian encoding.
  May trigger on legitimate license server communications or administrative tools querying licensing information.
type: detection
detection_id: 2103123
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the specific llsrconnect overflow payload and buffer size?
    context: Understanding the overflow attempt reveals exploitation technique and target vulnerability (MS05-010).
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - alert.signature
        - rule.name

  - question: Is this legitimate License Logging Service communication?
    context: Windows License Logging Service handles legitimate license queries that may trigger this rule.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - src_ip
        - bytes_in
        - bytes_out

  - question: What SMB authentication and enumeration preceded this overflow attempt?
    context: License service exploitation typically follows SMB authentication and service enumeration.
    range: -45m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - 'SMB'
            - 'NETBIOS'
            - 'bind'
        condition: selection
      fields:
        - rule.name
        - alert.signature
        - community_id

  - question: Did this buffer overflow attempt result in code execution?
    context: Successful exploitation of MS05-010 vulnerability can lead to remote code execution as SYSTEM.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          Hostname|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: What network connections were established after this overflow attempt?
    context: Successful exploitation may result in reverse shells or callback connections to attacker infrastructure.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - community_id
        - bytes_out

  - question: Are there other buffer overflow attempts from this source?
    context: Multiple overflow attempts may indicate systematic exploitation of vulnerable services.
    range: -2h/+2h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: 'overflow'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - alert.signature_id

  - question: What system processes were affected following this attempt?
    context: License service exploitation may impact system licensing functionality or create persistence.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          Hostname|expand: '%dst_ip%'
          Image|contains:
            - 'llssrv.exe'
            - 'services.exe'
            - 'lsass.exe'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: Were there attempts to disable security services after exploitation?
    context: Attackers often disable antivirus or logging services following successful system compromise.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          Hostname|expand: '%dst_ip%'
          CommandLine|contains:
            - 'sc stop'
            - 'net stop'
            - 'taskkill'
            - 'disable'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: What files were created or modified after this overflow attempt?
    context: Successful exploitation may result in malware deployment or system file modification.
    range: +6h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.mime_type

  - question: Is this llsrconnect overflow part of a broader exploitation campaign?
    context: Understanding attack scope helps identify if this is targeted or opportunistic exploitation.
    range: -6h/+6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'llsrconnect'
            - 'overflow'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - alert.severity