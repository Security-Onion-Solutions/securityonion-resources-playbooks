name: GPL NETBIOS SMB CoGetInstanceFromFile andx overflow attempt
id: 22103180
description: |
  Detects buffer overflow attempts targeting CVE-2003-0995 in Windows DCOM via SMB CoGetInstanceFromFile.
  This vulnerability allows remote code execution through malformed DCOM requests over SMB.
  May trigger on legitimate applications using DCOM file instantiation over network shares.
type: detection
detection_id: 2103180
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact SMB AndX command structure in the overflow attempt?
    context: Analyzing the AndX command chain reveals exploitation technique and payload delivery method.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - alert.signature
        - rule.name

  - question: What file path was specified in the CoGetInstanceFromFile call?
    context: The target file path may reveal attacker intent and potential persistence mechanisms.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - smb.path
        - smb.filename

  - question: How large was the buffer overflow payload?
    context: Payload size indicates exploitation sophistication and potential shellcode presence.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - flow.bytes_toserver
        - payload_len
        - smb.request.native_os

  # Type 2: Triage Assessment
  - question: Is this normal DCOM file access for this user/system?
    context: Legitimate applications may use DCOM for remote file instantiation in enterprise environments.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 139
          app_proto: 'smb'
        condition: selection
      fields:
        - src_ip
        - flow.bytes_toserver
        - conn_state

  - question: Does this align with documented file sharing activities?
    context: DCOM file operations may be part of legitimate distributed application architectures.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - 'dllhost.exe'
            - 'svchost.exe'
            - 'wmiprvse.exe'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine

  # Type 3: Activity Context
  - question: What SMB session establishment preceded this exploit attempt?
    context: Understanding session context helps identify authentication methods and access patterns.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_port
        - app_proto
        - conn_state

  - question: What other DCOM interfaces were accessed in this session?
    context: Attackers often enumerate multiple DCOM interfaces before successful exploitation.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          alert.signature|contains: 'DCOM'
        condition: selection
      fields:
        - alert.signature
        - rule.name
        - alert.severity

  # Type 4: Impact Assessment
  - question: Did the buffer overflow result in code execution?
    context: Successful exploitation leads to arbitrary code execution with SYSTEM privileges.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          User|contains:
            - 'SYSTEM'
            - 'NETWORK SERVICE'
          ParentImage|contains: 'svchost.exe'
        condition: selection
      fields:
        - User
        - Image
        - ProcessGuid
        - CommandLine

  - question: Are there signs of malicious file creation or modification?
    context: Successful DCOM exploitation often involves dropping malicious files or backdoors.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          file.extension|contains:
            - 'exe'
            - 'dll'
            - 'bat'
            - 'vbs'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - User

  # Type 5: Forensic Deep-Dive
  - question: What specific CVE-2003-0995 exploitation technique was employed?
    context: Different exploitation methods indicate varying levels of attacker sophistication and tooling.
    range: +/-1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains:
            - 'CVE-2003-0995'
            - 'CoGetInstanceFromFile'
            - 'DCOM'
        condition: selection
      fields:
        - alert.signature
        - dst_ip
        - rule.name

  - question: Are there indicators of automated exploitation frameworks?
    context: Framework signatures help identify attack tools and predict follow-on activities.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains:
            - 'Metasploit'
            - 'exploit kit'
            - 'scanner'
        condition: selection
      fields:
        - alert.signature
        - dst_ip
        - alert.severity

  - question: What persistence mechanisms were established post-exploitation?
    context: Successful DCOM exploitation often leads to backdoor installation or service modification.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetObject|contains:
            - 'Run'
            - 'Service'
            - 'DCOM'
        condition: selection
      fields:
        - TargetObject
        - Details
        - User

  # Type 6: Enterprise Correlation
  - question: Are other systems experiencing similar DCOM exploitation attempts?
    context: Coordinated attacks often target multiple vulnerable systems simultaneously.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'CoGetInstanceFromFile'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature

  - question: Is this part of a broader SMB-based attack campaign?
    context: Understanding campaign scope helps prioritize defense and identify additional compromised systems.
    range: +/-6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains:
            - 'SMB'
            - 'NETBIOS'
            - 'overflow'
        condition: selection
      fields:
        - dst_ip
        - alert.signature
        - rule.name