name: GPL NETBIOS SMB-DS CoGetInstanceFromFile overflow attempt
id: 22103184
description: |
  Detects potential exploitation of CVE-2003-0995 in Microsoft RPC/DCOM service via SMB.
  This vulnerability allows remote code execution through buffer overflow in CoGetInstanceFromFile.
  May trigger on legitimate DCOM operations but suspicious when from external sources.
type: detection
detection_id: 2103184
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the exact SMB packet structure and overflow payload detected?
    context: Analyzing the specific byte patterns helps distinguish between legitimate DCOM usage and exploitation attempts.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - src_ip
        - dst_ip
        - dst_port
        - payload
        - flow_id

  - question: Is this external source authorized to access SMB services on this target?
    context: External DCOM access is rarely legitimate and indicates potential compromise or misconfiguration.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - bytes_toserver
        - bytes_toclient
        - duration
        - proto

  - question: What SMB authentication and negotiation preceded this overflow attempt?
    context: Understanding the authentication context helps determine if credentials were compromised.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          community_id|expand: '%community_id%'
          rule.name|contains:
            - "SMB"
            - "NETBIOS"
        condition: selection
      fields:
        - rule.name
        - timestamp
        - src_port
        - dst_port

  - question: Has the target system exhibited signs of successful code execution or compromise?
    context: CVE-2003-0995 allows remote code execution, so successful exploitation would manifest as new processes or system changes.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid
        - ParentImage

  - question: What other RPC/DCOM exploitation attempts occurred from this source IP?
    context: Multiple RPC attacks indicate systematic targeting of Windows RPC vulnerabilities.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "RPC"
            - "DCOM"
            - "CoGetInstanceFromFile"
            - "MS03-026"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - dst_port
        - timestamp

  - question: Are there network connections indicating lateral movement from the target system?
    context: Successful DCOM exploitation often enables further network compromise and lateral movement.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 445
            - 135
            - 139
            - 3389
            - 22
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver
        - duration

  - question: What specific DCOM binding and interface was targeted in this attack?
    context: Different DCOM interfaces have varying security implications and exploitation methods.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          flow_id|expand: '%flow_id%'
          rule.name|contains: "bind"
        condition: selection
      fields:
        - rule.name
        - src_ip
        - dst_ip
        - payload

  - question: Has this source IP demonstrated other Windows-specific attack patterns?
    context: Multiple Windows exploit attempts suggest targeted campaign against Windows infrastructure.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "CVE-2003"
            - "MS03"
            - "Windows"
            - "overflow"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.category

  - question: Are there file system modifications or registry changes indicating successful exploitation?
    context: Successful DCOM exploitation typically results in file system access and potential persistence mechanisms.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessName
        - User

  - question: What network services on the target could facilitate post-exploitation activities?
    context: Available services determine potential impact and paths for further compromise.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - src_ip
        - proto

  - question: Are other systems experiencing similar DCOM overflow attempts from this or related sources?
    context: Coordinated DCOM attacks may indicate worm propagation or organized campaign.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "CoGetInstanceFromFile"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name