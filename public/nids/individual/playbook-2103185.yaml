name: GPL NETBIOS SMB-DS CoGetInstanceFromFile little endian overflow attempt
id: 22103185
description: |
  Detects potential exploitation of CVE-2003-0995 in Microsoft RPC/DCOM service via SMB.
  This vulnerability allows remote code execution through buffer overflow in CoGetInstanceFromFile.
  May trigger on legitimate DCOM operations but suspicious when from external sources.
type: detection
detection_id: 2103185
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the exact SMB packet structure and payload that triggered this overflow detection?
    context: Understanding the specific byte patterns helps confirm exploitation attempt versus legitimate DCOM usage.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - src_ip
        - dst_ip
        - dst_port
        - payload
        - flow_id

  - question: Is this SMB connection part of normal administrative activity for this source IP?
    context: External sources attempting DCOM operations are highly suspicious unless part of documented remote administration.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 445
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - bytes_toclient
        - duration

  - question: What SMB authentication and session establishment preceded this overflow attempt?
    context: Successful authentication may indicate compromised credentials or insider threat.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.category|contains:
            - "NETBIOS"
            - "SMB"
        condition: selection
      fields:
        - rule.name
        - timestamp
        - src_port
        - dst_port

  - question: Has the target system shown signs of successful compromise or code execution?
    context: CVE-2003-0995 allows remote code execution, so successful exploitation would show process creation or system changes.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid
        - ParentImage

  - question: What other DCOM or RPC-related exploitation attempts occurred from this source?
    context: Attackers often probe multiple RPC vulnerabilities when targeting Windows systems.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "RPC"
            - "DCOM"
            - "CoGetInstanceFromFile"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - dst_port
        - timestamp

  - question: Are there indicators of lateral movement or privilege escalation following this attempt?
    context: Successful DCOM exploitation often leads to further compromise attempts within the network.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 445
            - 135
            - 139
            - 3389
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver
        - duration

  - question: What specific DCOM interface and method was being targeted in this overflow attempt?
    context: Different DCOM interfaces have varying exploitation complexity and impact.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          community_id|expand: '%community_id%'
          rule.name|contains: "bind"
        condition: selection
      fields:
        - rule.name
        - src_ip
        - dst_ip
        - payload

  - question: Has this source IP attempted other Windows-specific exploits recently?
    context: Multiple Windows exploit attempts indicate targeted attack against Windows infrastructure.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "MS03"
            - "MS04"
            - "MS05"
            - "CVE-2003"
            - "CVE-2004"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.category

  - question: Are there file system changes or new processes on the target indicating successful exploitation?
    context: CVE-2003-0995 exploitation typically results in arbitrary code execution with SYSTEM privileges.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessName
        - User

  - question: What network services are running on the target system that could be leveraged post-exploitation?
    context: Understanding available services helps assess potential impact and lateral movement paths.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - src_ip
        - proto

  - question: Are other systems in the network experiencing similar DCOM exploitation attempts?
    context: Widespread DCOM attacks may indicate worm activity or coordinated campaign.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "CoGetInstanceFromFile"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: What is the geographic and reputation profile of the attacking IP address?
    context: External threat intelligence helps determine if this is opportunistic scanning or targeted attack.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - rule.category
        - dst_ip
        - rule.name