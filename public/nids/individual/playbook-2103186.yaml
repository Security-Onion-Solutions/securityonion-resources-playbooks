name: GPL NETBIOS SMB-DS CoGetInstanceFromFile Unicode Overflow Attempt (CVE-2003-0995)
id: 22103186
description: |
  Detects potential exploitation attempts targeting CVE-2003-0995, a buffer overflow vulnerability in Microsoft's CoGetInstanceFromFile function via SMB.
  This vulnerability allows remote code execution through malformed SMB requests to port 445.
  May trigger on legitimate SMB traffic with specific byte patterns or administrative tools using named pipes.
type: detection
detection_id: 2103186
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete SMB packet structure and payload that triggered this alert?
    context: Understanding the exact SMB command sequence reveals exploitation intent and target service vulnerability.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - rule.name
        - rule.category
        - alert.signature

  - question: What specific named pipe and PIPE path was accessed in this SMB request?
    context: The vulnerability exploits specific named pipe access patterns that indicate CoGetInstanceFromFile targeting.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - smb.command
        - smb.path
        - smb.share

  # Type 2: Triage Assessment
  - question: Is this SMB connection from a known administrative system or domain controller?
    context: Legitimate domain administration may generate similar SMB patterns during normal operations.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 445
        condition: selection
      fields:
        - dst_ip
        - bytes_in
        - bytes_out

  - question: Does this source IP have a history of legitimate SMB administrative activity?
    context: Regular administrative SMB traffic patterns help distinguish between authorized access and exploitation attempts.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 445
        condition: selection
      fields:
        - dst_ip
        - connection_state
        - duration

  # Type 3: Activity Context
  - question: What SMB session establishment and authentication preceded this overflow attempt?
    context: Understanding the SMB session context reveals whether this is part of authenticated access or anonymous exploitation.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - connection_state
        - bytes_in
        - bytes_out
        - duration

  - question: What other SMB-related alerts or anomalies occurred around the same time from this source?
    context: Multiple SMB exploitation attempts often indicate systematic vulnerability scanning or active compromise.
    range: -30m/+30m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - "netbios"
            - "smb"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - alert.severity

  # Type 4: Impact Assessment
  - question: Did the target system respond with successful SMB responses indicating potential compromise?
    context: Successful exploitation may result in specific SMB response patterns or connection state changes.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_ip|expand: '%src_ip%'
          src_port: 445
        condition: selection
      fields:
        - bytes_in
        - bytes_out
        - connection_state
        - duration

  - question: Are there signs of follow-up malicious activity or lateral movement from the target system?
    context: Successful exploitation often leads to additional network activity as attackers establish persistence or move laterally.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - connection_state

  # Type 5: Forensic Deep-Dive
  - question: What process activity occurred on the target system around the time of this SMB exploit attempt?
    context: Successful exploitation may trigger specific process execution patterns or service crashes on the target system.
    range: -15m/+15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: Are there any file system changes or registry modifications on the target system following this attempt?
    context: Successful buffer overflow exploitation often results in file drops or registry changes for persistence.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.mime_type

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network experiencing similar SMB-based overflow attempts?
    context: CVE-2003-0995 exploitation is often part of broader network scanning or worm-like propagation campaigns.
    range: -1h/+1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "CoGetInstanceFromFile"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is there evidence of coordinated SMB vulnerability scanning across the enterprise?
    context: Multiple SMB-related alerts from the same source indicate systematic vulnerability assessment or attack campaign.
    range: -6h/+6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - "netbios"
            - "smb"
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - alert.severity