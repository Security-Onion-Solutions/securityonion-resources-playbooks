name: GPL NETBIOS SMB-DS CoGetInstanceFromFile unicode little endian overflow attempt
id: 22103187
description: |
  Detects potential exploitation of CVE-2003-0995 using unicode little endian encoding to trigger buffer overflow.
  This combines the DCOM vulnerability with sophisticated encoding to evade detection and exploit systems.
  May trigger on legitimate unicode DCOM operations but highly suspicious from external sources.
type: detection
detection_id: 2103187
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the exact unicode little endian overflow payload that triggered CVE-2003-0995 detection?
    context: Understanding the specific payload structure helps confirm exploitation attempt versus legitimate DCOM usage.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - src_ip
        - dst_ip
        - dst_port
        - payload
        - flow_id

  - question: Is this external source authorized to perform DCOM operations on this target system?
    context: External DCOM access with encoding techniques is extremely suspicious and likely indicates attack activity.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - bytes_toserver
        - bytes_toclient
        - duration
        - proto

  - question: What SMB authentication and DCOM binding sequence preceded this overflow attempt?
    context: Understanding the authentication context helps determine if credentials were compromised or if this is unauthenticated attack.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          community_id|expand: '%community_id%'
          rule.name|contains:
            - "SMB"
            - "bind"
            - "msqueue"
        condition: selection
      fields:
        - rule.name
        - timestamp
        - src_port
        - dst_port

  - question: Has the target system shown evidence of successful code execution or system compromise?
    context: CVE-2003-0995 allows remote code execution with SYSTEM privileges, so successful exploitation would be visible.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid
        - ParentImage

  - question: What other CVE-2003-0995 exploitation attempts occurred from this source using different encoding methods?
    context: Multiple encoding attempts suggest persistent targeting of this specific vulnerability.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "CoGetInstanceFromFile"
            - "CVE-2003-0995"
            - "overflow"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - dst_port
        - timestamp

  - question: Are there network connections indicating lateral movement or privilege escalation following this attempt?
    context: Successful DCOM exploitation with SYSTEM privileges enables extensive lateral movement and network compromise.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 445
            - 135
            - 139
            - 3389
            - 5985
            - 22
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver
        - duration

  - question: What specific DCOM interface and overflow method was being exploited with unicode encoding?
    context: Different DCOM interfaces have varying exploitation complexity and require different payloads.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          flow_id|expand: '%flow_id%'
          rule.name|contains:
            - "bind"
            - "msqueue"
        condition: selection
      fields:
        - rule.name
        - src_ip
        - dst_ip
        - payload

  - question: Has this source IP attempted other Windows RPC/DCOM vulnerabilities with similar sophistication?
    context: Multiple advanced RPC attacks indicate skilled attacker with comprehensive Windows exploit toolkit.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "RPC"
            - "DCOM"
            - "MS03"
            - "MS04"
            - "MS05"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.category

  - question: Are there file system changes, registry modifications, or new services indicating successful exploitation?
    context: CVE-2003-0995 exploitation typically results in file drops, registry changes, or service installation for persistence.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessName
        - User

  - question: What critical network services on the target could be compromised following successful exploitation?
    context: SYSTEM-level access enables compromise of all network services and potential for significant impact.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_port
        - src_ip
        - proto

  - question: Are other systems experiencing similar unicode-encoded CVE-2003-0995 exploitation attempts?
    context: Coordinated advanced DCOM attacks may indicate worm activity or sophisticated campaign targeting Windows infrastructure.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - "unicode"
            - "overflow"
            - "CoGetInstanceFromFile"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: What is the threat intelligence and attack history profile of this source IP address?
    context: Understanding attacker background helps assess threat level and potential for continued sophisticated attacks.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - rule.category
        - dst_ip
        - rule.name