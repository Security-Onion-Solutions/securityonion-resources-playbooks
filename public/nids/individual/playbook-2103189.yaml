name: GPL NETBIOS SMB-DS CoGetInstanceFromFile little endian andx overflow attempt
id: 22103189
description: |
  Detects potential buffer overflow attempts targeting DCOM CoGetInstanceFromFile using little endian encoding via CVE-2003-0995.
  May trigger on legitimate DCOM applications or malformed packets.
  This represents a critical overflow variant targeting Windows DCOM RPC interface.
type: detection
detection_id: 2103189
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact little endian buffer overflow payload in this DCOM attack?
    context: Analyzing the overflow payload reveals the specific exploitation technique and target architecture.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - rule.name
        - alert.signature

  - question: How does this overflow differ from the non-overflow CoGetInstanceFromFile variant?
    context: Comparing overflow and non-overflow variants helps identify exploitation intent and success probability.
    range: -1h/+1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: "CoGetInstanceFromFile"
        condition: selection
      fields:
        - rule.name
        - payload
        - alert.signature

  # Type 2: Triage Assessment
  - question: Is this source IP authorized for DCOM administrative or development activities?
    context: DCOM developers or system administrators may generate legitimate traffic that triggers overflow detection.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 445
            - 135
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection_state

  - question: Does this activity align with known DCOM application testing or deployment?
    context: Enterprise DCOM applications may undergo testing that could trigger overflow-like patterns.
    range: -1d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: "DCOM"
        condition: selection
      fields:
        - src_ip
        - rule.name
        - alert.severity

  # Type 3: Activity Context
  - question: What DCOM reconnaissance and interface enumeration preceded this overflow?
    context: Buffer overflow attacks typically follow reconnaissance to identify vulnerable DCOM interfaces.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 135
            - 445
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection_state
        - bytes_toserver

  - question: What other CVE-2003-0995 exploitation attempts occurred around the same time?
    context: Attackers often attempt multiple CVE-2003-0995 variants to ensure successful exploitation.
    range: -1h/+1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "2003-0995"
            - "CoGetInstanceFromFile"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - dst_port
        - alert.severity

  # Type 4: Impact Assessment
  - question: Did the DCOM service crash or exhibit signs of successful buffer overflow exploitation?
    context: Successful buffer overflows may cause immediate service disruption or enable code execution.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 445
            - 135
        condition: selection
      fields:
        - src_ip
        - connection_state
        - bytes_toserver
        - bytes_toclient

  - question: Are there indicators of successful code execution or system compromise?
    context: CVE-2003-0995 buffer overflow exploitation can lead to SYSTEM-level access and lateral movement.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.category|contains:
            - "SHELLCODE"
            - "TROJAN"
            - "BACKDOOR"
        condition: selection
      fields:
        - rule.name
        - src_ip
        - alert.severity

  # Type 5: Forensic Deep-Dive
  - question: What specific CVE-2003-0995 exploit variant and shellcode was used in this overflow?
    context: Different exploit variants have varying success rates and payload capabilities.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - flow_id
        - proto

  - question: Are there signatures of Blaster worm, Welchia, or other CVE-2003-0995 malware?
    context: This vulnerability was exploited by multiple worms with distinct behavioral patterns.
    range: -30m/+30m
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "Blaster"
            - "Welchia"
            - "2003-0995"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - alert.severity

  # Type 6: Enterprise Correlation
  - question: Are other Windows systems experiencing similar DCOM buffer overflow attacks?
    context: CVE-2003-0995 campaigns often target multiple systems simultaneously for maximum impact.
    range: -4h/+4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: "GPL NETBIOS SMB-DS CoGetInstanceFromFile little endian andx overflow attempt"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.severity

  - question: Is this part of a coordinated campaign targeting Windows DCOM infrastructure?
    context: Buffer overflow exploits are often part of larger campaigns targeting enterprise Windows environments.
    range: -24h/+24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "overflow"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - alert.severity