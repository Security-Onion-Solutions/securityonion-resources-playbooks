name: GPL NETBIOS SMB OpenKey little endian andx overflow attempt
id: 22103223
description: |
  Detects buffer overflow attempts targeting the SMB OpenKey AndX operation with little-endian byte ordering.
  This is a variant of CVE-2000-0377 targeting systems that process registry operations in little-endian format.
  May trigger on legitimate registry operations with large key names processed by little-endian systems.
type: detection
detection_id: 2103223
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the specific little-endian SMB OpenKey AndX operation that triggered this overflow detection?
    context: Understanding the little-endian byte ordering reveals the target system architecture and exploit variant.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - alert.signature
        - src_ip
        - dst_ip
        - flow_id

  - question: How does the little-endian byte ordering affect the registry key manipulation in this attack?
    context: Little-endian processing differences can reveal the specific target system type and vulnerability variant.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - protocol
        - bytes_toserver
        - bytes_toclient
        - duration

  # Type 2: Triage Assessment
  - question: Is this source IP authorized for remote registry access on little-endian systems in the network?
    context: Little-endian systems may have different administrative access patterns than big-endian systems.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 139
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - service

  - question: Does this activity pattern match normal registry operations for this system architecture?
    context: Little-endian systems may exhibit different SMB registry access patterns than standard systems.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 139
        condition: selection
      fields:
        - src_ip
        - bytes_toserver

  # Type 3: Activity Context
  - question: What registry service binding and tree connection preceded this little-endian overflow attempt?
    context: The rule requires winreg binding, indicating specific registry service targeting on little-endian systems.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          alert.signature|contains: "winreg"
        condition: selection
      fields:
        - alert.signature
        - dst_port
        - flow_id

  - question: Were there system architecture reconnaissance activities from this source before the attack?
    context: Attackers often probe system architecture to determine appropriate exploit variants and byte ordering.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.category|contains:
            - "attempted-recon"
            - "protocol-command-decode"
        condition: selection
      fields:
        - alert.signature
        - dst_ip
        - dst_port

  # Type 4: Impact Assessment
  - question: Did the little-endian target system show signs of successful exploitation or compromise?
    context: Little-endian CVE-2000-0377 exploitation could lead to architecture-specific code execution patterns.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: Were there registry modifications consistent with little-endian system compromise?
    context: Little-endian systems may show different registry modification patterns following successful exploitation.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetObject
        - Details
        - User

  # Type 5: Forensic Deep-Dive
  - question: What specific little-endian buffer overflow technique was employed in this OpenKey operation?
    context: Little-endian byte ordering affects exploit payload structure and shellcode delivery mechanisms.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - alert.metadata
        - flow_id

  - question: Are there indicators of architecture-specific shellcode or payload delivery methods?
    context: Little-endian exploits may use different shellcode encoding or payload delivery techniques.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          alert.category: "attempted-admin"
        condition: selection
      fields:
        - alert.signature
        - payload_printable

  # Type 6: Enterprise Correlation
  - question: Are other little-endian systems experiencing similar SMB OpenKey overflow attempts?
    context: Architecture-specific attacks may target systems with similar byte ordering characteristics.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature_id: 2103223
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature

  - question: Is this part of an architecture-aware attack campaign targeting specific system types?
    context: Understanding architecture targeting helps assess threat actor sophistication and campaign methodology.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.category: "attempted-admin"
          dst_port: 139
        condition: selection
      fields:
        - dst_ip
        - alert.signature