name: GPL NETBIOS SMB OpenKey Unicode Buffer Overflow Attempt
id: 22103224
description: |
  Detects potential buffer overflow exploitation attempts targeting SMB OpenKey functionality with unicode encoding.
  This targets CVE-2000-0377, a critical vulnerability in Windows NT/2000 Registry access via SMB.
  May trigger on legitimate registry access tools or administrative software using unicode SMB operations.
type: detection
detection_id: 2103224
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact SMB packet structure and unicode payload detected?
    context: Understanding the malformed SMB request reveals exploitation technique and target registry key.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - payload
        - payload_printable
        - src_ip
        - dst_ip
        - dst_port

  - question: What registry key path was being targeted in the overflow attempt?
    context: The PIPE path and registry access pattern indicates specific Windows components being exploited.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - smb.command
        - smb.tree_id

  # Type 2: Triage Assessment
  - question: Is this source IP known to perform legitimate SMB registry operations?
    context: Administrative tools and backup software may legitimately access Windows registry via SMB.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 139
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - bytes_toclient

  - question: Does this target system normally accept SMB registry connections from external sources?
    context: Most secure environments restrict external SMB registry access to authorized management systems.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 139
        condition: selection
      fields:
        - src_ip
        - community_id

  # Type 3: Activity Context
  - question: What SMB session establishment preceded this overflow attempt?
    context: Successful exploitation requires prior SMB authentication and tree connection to winreg service.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: "SMB"
        condition: selection
      fields:
        - rule.name
        - smb.command
        - smb.status

  - question: What network reconnaissance occurred before this SMB exploitation attempt?
    context: Attackers typically scan for SMB services and enumerate shares before attempting registry exploits.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 135
            - 139
            - 445
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver

  # Type 4: Impact Assessment
  - question: Did the buffer overflow attempt result in successful code execution?
    context: Successful exploitation may trigger additional alerts or unusual process creation on the target.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ParentImage

  - question: Are there signs of registry modification or system compromise on the target?
    context: Successful registry exploits often lead to persistence mechanisms or privilege escalation.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetObject
        - Details
        - User

  # Type 5: Forensic Deep-Dive
  - question: What specific buffer overflow technique was attempted in the SMB packet?
    context: Analysis of byte patterns and unicode encoding reveals exploitation methodology and potential success.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          community_id|expand: '%community_id%'
          rule.name|contains: "overflow"
        condition: selection
      fields:
        - rule.name
        - payload
        - severity

  - question: Are there indicators of shellcode or payload delivery following the overflow?
    context: Successful buffer overflows often deliver secondary payloads for remote access or persistence.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - "shellcode"
            - "backdoor"
            - "trojan"
        condition: selection
      fields:
        - rule.name
        - payload_printable

  # Type 6: Enterprise Correlation
  - question: Are other systems in the environment experiencing similar SMB registry overflow attempts?
    context: Coordinated attacks often target multiple systems with the same vulnerability.
    range: -2h/+2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: "GPL NETBIOS SMB OpenKey unicode andx overflow attempt"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is this part of a broader SMB-based attack campaign across the network?
    context: Registry overflow attempts often occur alongside other SMB exploits in targeted campaigns.
    range: -4h/+1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "SMB"
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - severity