name: GPL NETBIOS SMB-DS OpenKey andx overflow attempt
id: 22103230
description: |
  Detects potential exploitation attempts targeting CVE-2000-0377 via SMB-DS OpenKey interface buffer overflow.
  This vulnerability affects Windows Registry RPC services and can lead to remote code execution.
  May trigger on legitimate registry operations but unusual for external connections to registry services.
type: detection
detection_id: 2103230
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete SMB packet structure and OpenKey RPC call parameters?
    context: Understanding the registry key access attempt reveals target data and exploitation technique.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - rule.name
        - alert.signature

  - question: Is this registry access attempt part of legitimate administrative operations?
    context: Remote registry access is common for system administration but rarely originates externally.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 445
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - bytes_toclient
        - duration

  - question: What SMB authentication and registry service binding preceded this OpenKey attempt?
    context: Registry RPC exploitation requires prior SMB authentication and successful service binding.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.category|contains:
            - "NETBIOS"
            - "SMB"
            - "winreg"
        condition: selection
      fields:
        - rule.name
        - alert.signature
        - timestamp

  - question: Are there signs of successful OpenKey buffer overflow exploitation?
    context: CVE-2000-0377 exploitation can lead to code execution with SYSTEM privileges on vulnerable systems.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          User|contains:
            - "SYSTEM"
            - "NT AUTHORITY"
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  - question: What other registry or RPC exploitation attempts occurred from this source?
    context: Attackers often probe multiple RPC interfaces including registry services when targeting Windows systems.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category|contains:
            - "RPC"
            - "winreg"
            - "registry"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - alert.signature

  - question: Has the target system shown registry modifications or system compromise indicators?
    context: Successful registry RPC exploitation often leads to registry manipulation and system configuration changes.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetObject|contains:
            - "\\CurrentVersion\\Run"
            - "\\Services\\"
            - "\\Policies\\"
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessGuid

  - question: What file system changes occurred following this registry RPC exploitation attempt?
    context: Registry exploitation may be followed by malware installation or system tool deployment.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetFilename|contains:
            - "\\system32\\"
            - "\\temp\\"
            - ".exe"
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessGuid

  - question: Are there indicators of shellcode execution or memory manipulation following registry exploit?
    context: Buffer overflow exploits in registry services often involve shellcode injection and memory corruption.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          CommandLine|contains:
            - "rundll32"
            - "regsvr32"
            - "powershell"
            - "reg.exe"
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid

  - question: What network traffic patterns suggest successful compromise and lateral movement?
    context: Post-exploitation often involves command and control communications or credential theft for lateral movement.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 139
            - 445
            - 135
            - 3389
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toclient
        - bytes_toserver

  - question: Are other systems in the network experiencing similar registry RPC exploitation attempts?
    context: Attackers often target multiple systems with the same registry vulnerability across the network.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "OpenKey"
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - alert.signature

  - question: What DNS queries or command and control infrastructure support this registry-focused attack?
    context: Understanding attacker infrastructure helps identify campaign scope and registry-specific attack tools.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name