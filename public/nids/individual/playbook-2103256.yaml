name: GPL NETBIOS SMB IrotIsRunning attempt
id: 22103256
description: |
  Detects attempts to exploit CVE-2002-1561 via SMB IrotIsRunning function calls.
  This vulnerability allows remote code execution through malformed RPC requests.
  May trigger on legitimate DCOM applications using IrotIsRunning interface.
type: detection
detection_id: 2103256
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact SMB packet structure and RPC payload in this IrotIsRunning attempt?
    context: Understanding the packet format reveals exploitation method and payload size.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - rule.name

  - question: What specific PIPE interface was targeted in this SMB communication?
    context: The named pipe reveals which Windows service was being exploited.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - smb.command
        - smb.named_pipe
        - smb.tree_id

  # Type 2: Triage Assessment
  - question: Is this SMB traffic part of normal DCOM operations for this system?
    context: Legitimate distributed applications may use IrotIsRunning for object registration.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 139
        condition: selection
      fields:
        - src_ip
        - bytes_toserver
        - bytes_toclient

  - question: Does the source IP have established SMB sessions indicating legitimate file sharing?
    context: Regular file sharing activity suggests authorized network access.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 139
            - 445
        condition: selection
      fields:
        - dst_ip
        - duration
        - connection_state

  # Type 3: Activity Context
  - question: What preceded this IrotIsRunning attempt in the SMB session?
    context: Understanding session establishment reveals attack methodology.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.category: "protocol-command-decode"
        condition: selection
      fields:
        - rule.name
        - smb.command
        - smb.status

  - question: What other RPC interface bindings occurred from this source?
    context: Multiple RPC bindings indicate systematic service enumeration.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "bind"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - dst_port

  # Type 4: Impact Assessment
  - question: Did the IrotIsRunning request succeed or fail based on SMB response codes?
    context: Successful exploitation attempts show different response patterns than failed ones.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - bytes_toclient
        - connection_state
        - duration

  - question: Are there signs of successful code execution following this attempt?
    context: Post-exploitation activity indicates successful compromise.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  # Type 5: Forensic Deep-Dive
  - question: What is the payload size and does it exceed normal IrotIsRunning parameters?
    context: Oversized payloads indicate buffer overflow exploitation attempts.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - packet_info.length
        - smb.request.native_lan_man
        - smb.request.native_os

  - question: Are there indicators of shellcode or malicious payload in the RPC data?
    context: Shellcode patterns confirm malicious intent versus legitimate DCOM usage.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - rule.metadata

  # Type 6: Enterprise Correlation
  - question: Are other systems receiving similar IrotIsRunning exploitation attempts?
    context: Multiple targets indicate coordinated attack campaign.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.sid: 2103256
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is this part of broader SMB vulnerability scanning from the same source?
    context: Multiple SMB exploits suggest automated vulnerability scanning tools.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.category: "attempted-admin"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.cve