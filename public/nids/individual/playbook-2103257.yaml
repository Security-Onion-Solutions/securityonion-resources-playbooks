name: GPL NETBIOS SMB IrotIsRunning little endian attempt
id: 22103257
description: |
  Detects little endian variant of CVE-2002-1561 IrotIsRunning exploitation attempts.
  This specific encoding variation targets systems with little endian byte ordering.
  May trigger on legitimate DCOM applications using little endian RPC calls.
type: detection
detection_id: 2103257
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What is the byte ordering and endianness pattern in this RPC request?
    context: Little endian encoding reveals specific exploitation technique and target architecture.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - rule.name

  - question: How does this little endian variant differ from standard IrotIsRunning calls?
    context: Comparing variants helps identify exploitation sophistication and toolset.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: "IrotIsRunning"
        condition: selection
      fields:
        - rule.name
        - rule.sid
        - payload_printable

  # Type 2: Triage Assessment
  - question: Is little endian byte ordering normal for this client-server architecture?
    context: System architecture determines expected byte ordering in network communications.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 139
        condition: selection
      fields:
        - bytes_toserver
        - bytes_toclient
        - duration

  - question: Are there legitimate applications requiring little endian RPC on this system?
    context: Some distributed applications specifically require little endian encoding.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - "dcom"
            - "rpc"
            - "ole"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  # Type 3: Activity Context
  - question: What RPC interface binding preceded this little endian attempt?
    context: Understanding the binding sequence reveals attack progression.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: "bind"
        condition: selection
      fields:
        - rule.name
        - smb.tree_id
        - smb.command

  - question: Did the attacker attempt both big and little endian variants?
    context: Multiple endianness attempts indicate thorough exploitation methodology.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: "IrotIsRunning"
        condition: selection
      fields:
        - rule.name
        - rule.sid
        - payload

  # Type 4: Impact Assessment
  - question: Did the little endian encoding bypass any security controls?
    context: Different encodings may evade signature-based detection systems.
    range: +10m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - bytes_toclient
        - connection_state
        - duration

  - question: Are there signs of successful exploitation following this little endian attempt?
    context: Post-exploitation indicators confirm successful compromise.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          User: "SYSTEM"
        condition: selection
      fields:
        - Image
        - CommandLine
        - ProcessGuid

  # Type 5: Forensic Deep-Dive
  - question: What specific little endian markers are present in the payload?
    context: Endianness markers help identify exploitation tools and techniques.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - smb.request.native_lan_man
        - rule.metadata

  - question: Does the payload contain architecture-specific shellcode?
    context: Architecture-specific code confirms targeted exploitation attempt.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - packet_info.length
        - rule.cve

  # Type 6: Enterprise Correlation
  - question: Are other systems targeted with little endian IrotIsRunning attempts?
    context: Multiple targets suggest systematic exploitation campaign.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.sid: 2103257
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is this source using multiple CVE-2002-1561 exploitation variants?
    context: Multiple variants indicate sophisticated exploitation toolkit.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.cve: "CVE_2002_1561"
        condition: selection
      fields:
        - rule.name
        - rule.sid
        - dst_ip