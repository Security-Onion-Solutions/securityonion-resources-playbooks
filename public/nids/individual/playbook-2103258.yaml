name: GPL NETBIOS SMB IrotIsRunning unicode attempt
id: 22103258
description: |
  Detects unicode-encoded CVE-2002-1561 IrotIsRunning exploitation attempts via SMB.
  Unicode encoding may bypass certain security controls while exploiting the vulnerability.
  May trigger on legitimate applications using unicode RPC communications.
type: detection
detection_id: 2103258
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What unicode encoding pattern is used in this IrotIsRunning exploit attempt?
    context: Unicode encoding reveals evasion techniques and payload obfuscation methods.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - rule.name

  - question: How does the unicode PIPE path encoding compare to standard ASCII variants?
    context: Unicode pipe paths may indicate sophisticated evasion or legitimate internationalization.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: "IrotIsRunning"
        condition: selection
      fields:
        - rule.name
        - rule.sid
        - smb.named_pipe

  # Type 2: Triage Assessment
  - question: Does this system regularly process unicode SMB communications?
    context: Systems supporting international clients may legitimately use unicode encoding.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 139
            - 445
        condition: selection
      fields:
        - src_ip
        - bytes_toserver
        - connection_state

  - question: Are there authorized applications using unicode RPC on this target?
    context: Legitimate distributed applications may require unicode character support.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - "dcom"
            - "ole"
            - "rpc"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  # Type 3: Activity Context
  - question: What SMB negotiation and tree connect preceded this unicode attempt?
    context: SMB session establishment reveals unicode capability negotiation.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - "negotiate"
            - "tree"
        condition: selection
      fields:
        - rule.name
        - smb.command
        - smb.flags

  - question: Did the attacker test multiple encoding variants before using unicode?
    context: Sequential encoding attempts indicate systematic evasion methodology.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: "IrotIsRunning"
        condition: selection
      fields:
        - rule.name
        - rule.sid
        - payload_printable

  # Type 4: Impact Assessment
  - question: Did the unicode encoding successfully bypass security controls?
    context: Unicode evasion success indicates security control gaps.
    range: +10m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - bytes_toclient
        - connection_state
        - duration

  - question: Are there post-exploitation activities following this unicode attempt?
    context: Successful exploitation leads to system compromise indicators.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  # Type 5: Forensic Deep-Dive
  - question: What specific unicode characters and encoding scheme are used?
    context: Unicode analysis reveals exploitation sophistication and potential tool signatures.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - smb.request.native_lan_man
        - smb.request.native_os

  - question: Does the unicode payload contain recognizable shellcode patterns?
    context: Shellcode identification confirms malicious intent versus legitimate unicode usage.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - packet_info.length
        - rule.metadata

  # Type 6: Enterprise Correlation
  - question: Are other systems receiving unicode-encoded IrotIsRunning attempts?
    context: Multiple unicode targets indicate coordinated evasion campaign.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.sid: 2103258
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is this source systematically using unicode encoding across different exploits?
    context: Consistent unicode usage suggests specific evasion toolkit or methodology.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "unicode"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - rule.category