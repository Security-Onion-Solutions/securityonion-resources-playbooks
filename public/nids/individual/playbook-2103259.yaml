name: GPL NETBIOS SMB IrotIsRunning unicode little endian attempt
id: 22103259
description: |
  Detects unicode little endian variant of CVE-2002-1561 IrotIsRunning exploitation.
  Combines unicode encoding with little endian byte ordering for maximum evasion.
  May trigger on legitimate internationalized applications using specific architectures.
type: detection
detection_id: 2103259
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What is the combined unicode and little endian encoding structure?
    context: Dual encoding reveals sophisticated evasion techniques and exploitation complexity.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - rule.name

  - question: How does this variant compare to other IrotIsRunning encoding attempts?
    context: Comparing all variants reveals attacker methodology and tool capabilities.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: "IrotIsRunning"
        condition: selection
      fields:
        - rule.name
        - rule.sid
        - payload_printable

  # Type 2: Triage Assessment
  - question: Does this system architecture require unicode little endian RPC?
    context: Specific system configurations may legitimately use this encoding combination.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 139
        condition: selection
      fields:
        - src_ip
        - bytes_toserver
        - bytes_toclient

  - question: Are there legitimate international applications on this target system?
    context: Internationalized software may require unicode with specific byte ordering.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          CommandLine|contains:
            - "unicode"
            - "international"
            - "locale"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  # Type 3: Activity Context
  - question: What sequence of encoding variants did the attacker attempt?
    context: Understanding the progression reveals systematic evasion testing.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.cve: "CVE_2002_1561"
        condition: selection
      fields:
        - rule.name
        - rule.sid
        - payload

  - question: Did SMB capability negotiation indicate unicode support?
    context: SMB negotiation reveals whether unicode encoding was client-driven or forced.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: "negotiate"
        condition: selection
      fields:
        - rule.name
        - smb.flags
        - smb.command

  # Type 4: Impact Assessment
  - question: Did this most sophisticated encoding variant succeed?
    context: Success of complex encoding indicates advanced evasion capability.
    range: +10m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - bytes_toclient
        - connection_state
        - duration

  - question: Are there indicators of successful compromise after this attempt?
    context: Post-exploitation activity confirms successful evasion and exploitation.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          User|contains:
            - "SYSTEM"
            - "Administrator"
        condition: selection
      fields:
        - Image
        - CommandLine
        - ProcessGuid

  # Type 5: Forensic Deep-Dive
  - question: What exploitation toolkit signatures are present in the encoding?
    context: Specific encoding patterns may indicate known exploitation frameworks.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - smb.request.native_lan_man
        - rule.metadata

  - question: Does the payload contain architecture and locale-specific shellcode?
    context: Tailored shellcode confirms targeted exploitation versus automated scanning.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - packet_info.length
        - rule.cve

  # Type 6: Enterprise Correlation
  - question: Are other systems targeted with this sophisticated encoding variant?
    context: Multiple targets using complex encoding suggest advanced persistent threat.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.sid: 2103259
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is this the culmination of systematic encoding variant testing?
    context: Progressive encoding complexity indicates methodical evasion development.
    range: -6h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.cve: "CVE_2002_1561"
        condition: selection
      fields:
        - rule.name
        - rule.sid
        - dst_ip