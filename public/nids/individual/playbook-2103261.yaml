name: GPL NETBIOS SMB IrotIsRunning little endian andx attempt
id: 22103261
description: |
  Detects IrotIsRunning RPC attempts via SMB using little endian byte order, related to CVE-2002-1561.
  Similar to SID 2103260 but specifically for little endian systems.
  May indicate legitimate COM operations or RPC exploitation attempts.
type: detection
detection_id: 2103261
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the little endian IrotIsRunning RPC call structure?
    context: Understanding the byte order and RPC parameters reveals system architecture and exploitation technique.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - rule.name
        - alert.signature

  - question: Is this consistent with normal RPC operations on little endian Windows systems?
    context: Most Windows systems use little endian byte order for RPC communications.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 135
            - 139
            - 445
        condition: selection
      fields:
        - src_ip
        - dst_port
        - bytes_in
        - bytes_out

  - question: What IROT SMB tree binding preceded this little endian attempt?
    context: The flowbit indicates prior SMB tree binding to IROT, showing attack chain progression.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - "SMB"
            - "tree"
            - "bind"
            - "irot"
        condition: selection
      fields:
        - rule.name
        - alert.signature
        - src_port
        - dst_port

  - question: Are there indications of successful RPC code execution?
    context: Successful CVE-2002-1561 exploitation in little endian systems can lead to arbitrary code execution.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ParentImage
        - ProcessGuid

  - question: What is the pattern of little endian RPC exploitation attempts?
    context: Multiple little endian RPC attempts may indicate targeted exploitation of specific system architecture.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "little endian"
            - "IrotIsRunning"
            - "RPC"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - alert.signature_id

  - question: Are there network connections indicating successful RPC compromise?
    context: Successful RPC exploitation may result in reverse shells or command and control communications.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_in
        - bytes_out
        - community_id

  - question: What Windows RPC service behavior changed after this attempt?
    context: RPC exploitation attempts may cause service crashes, restarts, or unusual behavior.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - "rpcss"
            - "services.exe"
            - "svchost.exe"
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: Are there similar little endian RPC attempts across the enterprise?
    context: Multiple systems targeted with little endian RPC exploits may indicate campaign scope.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: "GPL NETBIOS SMB IrotIsRunning little endian andx attempt"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature_id

  - question: What file operations occurred consistent with RPC exploitation?
    context: Successful RPC exploitation may result in file creation, modification, or malware installation.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.mime_type
        - User

  - question: Are there registry modifications indicating RPC service compromise?
    context: RPC exploitation may result in registry changes for persistence or service reconfiguration.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetObject|contains:
            - "RPC"
            - "DCOM"
            - "Service"
            - "Interface"
        condition: selection
      fields:
        - TargetObject
        - Details
        - User
        - ProcessGuid