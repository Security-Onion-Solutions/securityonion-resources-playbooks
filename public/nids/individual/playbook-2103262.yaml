name: GPL NETBIOS SMB IrotIsRunning Unicode AndX Attempt
id: 22103262
description: |
  Detects potential exploitation attempts against CVE-2002-1561, a buffer overflow vulnerability in Windows RPC interface.
  This rule identifies SMB traffic with specific Unicode patterns that may indicate malicious DCOM exploitation attempts.
  May trigger on legitimate SMB operations with similar byte patterns.
type: detection
detection_id: 2103262
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete SMB command structure and Unicode payload in this traffic?
    context: Understanding the exact SMB AndX command and Unicode patterns reveals exploitation intent and payload structure.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - alert.signature
        - network.protocol
        - network.transport
        - payload_printable

  - question: What specific byte patterns and offsets were detected in the SMB traffic?
    context: Analyzing the exact byte sequences helps confirm if this matches known CVE-2002-1561 exploitation patterns.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - src_port
        - dst_port
        - alert.metadata

  # Type 2: Triage Assessment
  - question: Is this SMB traffic part of normal file sharing operations for this host?
    context: Legitimate SMB operations may occasionally trigger false positives with similar byte patterns.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 139
        condition: selection
      fields:
        - src_ip
        - connection_state
        - bytes_toserver
        - bytes_toclient

  - question: Does this activity align with documented administrative operations?
    context: System administrators may perform legitimate SMB operations that could trigger this signature.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%src_ip%'
          Image|contains:
            - 'net.exe'
            - 'psexec'
            - 'wmic.exe'
        condition: selection
      fields:
        - User
        - CommandLine
        - ParentImage

  # Type 3: Activity Context
  - question: What preceded this SMB exploitation attempt in the network session?
    context: Understanding the attack sequence helps identify if this is part of a broader compromise attempt.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - connection_state

  - question: What other SMB-related alerts occurred around the same time from this source?
    context: Multiple SMB exploitation attempts may indicate systematic vulnerability scanning or exploitation.
    range: -1h/+1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains: 'SMB'
        condition: selection
      fields:
        - alert.signature
        - dst_ip
        - dst_port

  # Type 4: Impact Assessment
  - question: Did this exploitation attempt result in successful authentication or file access?
    context: Successful exploitation may lead to unauthorized access and potential system compromise.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 139
            - 445
        condition: selection
      fields:
        - connection_state
        - bytes_toserver
        - bytes_toclient

  - question: Are there signs of lateral movement or privilege escalation following this attempt?
    context: Successful DCOM exploitation may enable attackers to execute code and move laterally within the network.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - 'cmd.exe'
            - 'powershell.exe'
            - 'wscript.exe'
        condition: selection
      fields:
        - User
        - CommandLine
        - ParentImage

  # Type 5: Forensic Deep-Dive
  - question: What specific RPC/DCOM services were targeted in this exploitation attempt?
    context: CVE-2002-1561 affects specific RPC interfaces, identifying the target helps understand attack scope.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - alert.signature
        - alert.category
        - alert.metadata

  - question: Are there indicators of successful code execution or payload deployment?
    context: Successful exploitation may result in malware installation or backdoor creation.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetFilename|contains:
            - '.exe'
            - '.dll'
            - '.bat'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessName

  # Type 6: Enterprise Correlation
  - question: Are other systems in the network experiencing similar SMB exploitation attempts?
    context: Coordinated attacks may target multiple systems using the same vulnerability.
    range: -2h/+2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature: 'GPL NETBIOS SMB IrotIsRunning unicode andx attempt'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - count