name: GPL NETBIOS SMB IrotIsRunning Unicode Little Endian AndX Attempt
id: 22103263
description: |
  Detects potential exploitation attempts against CVE-2002-1561 using little endian byte ordering in SMB traffic.
  This variant specifically targets the byte ordering used in Windows systems for DCOM exploitation.
  May trigger on legitimate SMB operations with similar Unicode patterns and byte ordering.
type: detection
detection_id: 2103263
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the specific little endian byte ordering pattern detected in this SMB traffic?
    context: Understanding the endianness and byte structure reveals platform-specific exploitation targeting Windows systems.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - alert.signature
        - network.protocol
        - payload_printable

  - question: How does this Unicode pattern differ from the standard big endian variant?
    context: Comparing byte ordering helps identify if attackers are specifically targeting Windows architecture.
    range: -1h/+1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains: 'IrotIsRunning unicode'
        condition: selection
      fields:
        - alert.signature
        - dst_ip
        - alert.metadata

  # Type 2: Triage Assessment
  - question: Is this little endian SMB traffic consistent with normal Windows client behavior?
    context: Windows systems naturally use little endian byte ordering, so this may be legitimate traffic.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 139
        condition: selection
      fields:
        - src_ip
        - connection_state
        - bytes_toserver

  - question: Does the source system typically generate Windows-compatible SMB traffic?
    context: Understanding the source system's normal behavior helps distinguish legitimate from malicious activity.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 139
            - 445
        condition: selection
      fields:
        - dst_ip
        - connection_state
        - count

  # Type 3: Activity Context
  - question: What SMB session establishment preceded this exploitation attempt?
    context: Understanding the full SMB session context helps identify if this is part of legitimate authentication or attack.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - connection_state
        - bytes_toserver

  - question: Are there other DCOM or RPC-related activities from this source?
    context: Multiple RPC exploitation attempts may indicate systematic vulnerability probing.
    range: -2h/+2h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains:
            - 'DCOM'
            - 'RPC'
            - 'SMB'
        condition: selection
      fields:
        - alert.signature
        - dst_ip
        - dst_port

  # Type 4: Impact Assessment
  - question: Did this little endian exploitation attempt achieve successful code execution?
    context: Successful exploitation may result in remote code execution with system privileges.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          User|contains:
            - 'SYSTEM'
            - 'NETWORK SERVICE'
        condition: selection
      fields:
        - User
        - CommandLine
        - Image
        - ParentImage

  - question: Are there signs of unauthorized file access or modification following this attempt?
    context: Successful DCOM exploitation may enable attackers to access or modify system files.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetFilename|contains:
            - 'system32'
            - 'windows'
            - 'program files'
        condition: selection
      fields:
        - TargetFilename
        - ProcessName
        - file.hash.md5

  # Type 5: Forensic Deep-Dive
  - question: What specific RPC endpoint was targeted in this little endian attack?
    context: Identifying the exact RPC interface helps understand the attack vector and potential system impact.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - alert.signature
        - alert.category
        - src_port
        - dst_port

  - question: Are there persistence mechanisms installed following successful exploitation?
    context: Attackers may install backdoors or scheduled tasks to maintain access after initial compromise.
    range: +6h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetObject|contains:
            - 'Run'
            - 'RunOnce'
            - 'Services'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessName

  # Type 6: Enterprise Correlation
  - question: Are other Windows systems experiencing similar little endian SMB exploitation attempts?
    context: Coordinated attacks may specifically target Windows systems using endian-specific payloads.
    range: -4h/+4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature: 'GPL NETBIOS SMB IrotIsRunning unicode little endian andx attempt'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - count

  - question: Is this part of a broader campaign targeting CVE-2002-1561 across the enterprise?
    context: Multiple exploitation variants may indicate sophisticated attackers using different payload encodings.
    range: -12h/+12h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.metadata|contains: 'CVE_2002_1561'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature
        - count