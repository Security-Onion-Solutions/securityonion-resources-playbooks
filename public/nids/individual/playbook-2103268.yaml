name: GPL NETBIOS SMB-DS IrotIsRunning andx attempt
id: 22103268
description: |
  Detects attempts to exploit SMB-DS IrotIsRunning functionality through DCOM interface.
  References CVE-2002-1561, a Windows DCOM vulnerability in the Interface Registration component.
  May trigger on legitimate DCOM operations but could indicate exploitation attempts.
type: detection
detection_id: 2103268
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the exact IrotIsRunning DCOM operation and parameter structure?
    context: IrotIsRunning operations reveal specific DCOM interface usage and potential exploitation patterns.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - rule.name
        - alert.signature

  - question: What IROT service binding and SMB tree connection preceded this attempt?
    context: CVE-2002-1561 exploitation requires specific IROT service bindings before triggering the vulnerability.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - 'smb.tree.bind.irot'
            - 'IROT'
            - 'DCOM'
        condition: selection
      fields:
        - rule.name
        - alert.signature
        - src_port
        - dst_port

  - question: Is this normal IROT or Interface Registration activity for this system?
    context: Legitimate applications may use IROT services but should follow predictable patterns.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - src_ip
        - bytes_in
        - bytes_out

  - question: What other CVE-2002-1561 or IROT exploitation attempts occurred from this source?
    context: Attackers often make multiple attempts against IROT vulnerabilities with different techniques.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'IrotIsRunning'
            - 'IROT'
            - 'Interface Registration'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - alert.signature

  - question: Did the IrotIsRunning attempt result in successful DCOM service execution?
    context: Successful CVE-2002-1561 exploitation can lead to elevated process creation and system access.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          User|contains:
            - 'SYSTEM'
            - 'NETWORK SERVICE'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: What DCOM interface or object registration activity followed this attempt?
    context: IROT exploitation may involve manipulating object registration for persistence or privilege escalation.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - 'DCOM'
            - 'Object'
            - 'Registration'
        condition: selection
      fields:
        - src_ip
        - rule.name
        - alert.signature

  - question: What network connections were established after the IROT exploitation attempt?
    context: Successful IROT exploitation may result in reverse shell connections or data exfiltration.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - community_id

  - question: Are there signs of COM object manipulation or DCOM persistence?
    context: IROT vulnerabilities may be used to establish persistent DCOM objects or backdoors.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetObject|contains:
            - 'CLSID'
            - 'AppID'
            - 'DCOM'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessGuid

  - question: What file system changes occurred after the IrotIsRunning attempt?
    context: Successful exploitation may involve dropping malware or creating persistence mechanisms.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetFilename|contains:
            - '.exe'
            - '.dll'
            - '.ocx'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessGuid

  - question: Has this CVE-2002-1561 IROT attack pattern been observed on other systems?
    context: DCOM vulnerabilities are often exploited across multiple systems in coordinated attacks.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'IrotIsRunning'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: What lateral movement activity used DCOM or IROT services from compromised systems?
    context: Compromised systems may use DCOM services for lateral movement and further exploitation.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 445
            - 135
            - 139
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - community_id