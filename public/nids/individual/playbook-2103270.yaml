name: GPL NETBIOS SMB-DS IrotIsRunning unicode andx attempt
id: 22103270
description: |
  Detects potential exploitation attempts targeting CVE-2002-1561 via SMB-DS IrotIsRunning interface using Unicode encoding.
  This vulnerability affects Windows RPC services and can lead to buffer overflow conditions.
  Unicode variant may bypass some security controls but indicates same exploitation intent.
type: detection
detection_id: 2103270
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the Unicode-encoded SMB packet structure and RPC call parameters?
    context: Unicode encoding in RPC calls may indicate evasion attempts or specific exploit variants.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - rule.name
        - alert.signature

  - question: Is this Unicode SMB traffic consistent with normal Windows operations?
    context: Unicode in SMB is common for internationalization but unusual for external RPC exploitation.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 445
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - bytes_toclient
        - duration

  - question: What SMB authentication and session setup preceded this Unicode RPC call?
    context: Understanding authentication context reveals whether attacker has valid credentials or exploiting null sessions.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.category|contains:
            - "NETBIOS"
            - "SMB"
        condition: selection
      fields:
        - rule.name
        - alert.signature
        - timestamp

  - question: Are there indicators of successful Unicode-based buffer overflow exploitation?
    context: Unicode variants of CVE-2002-1561 can still achieve code execution with SYSTEM privileges.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          User|contains:
            - "SYSTEM"
            - "NT AUTHORITY"
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  - question: What other Unicode-based or encoding evasion attempts occurred from this source?
    context: Attackers using Unicode encoding may employ other evasion techniques across multiple protocols.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "unicode"
            - "encoding"
            - "evasion"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - alert.signature

  - question: Has the target system exhibited signs of compromise following this Unicode exploit attempt?
    context: Successful exploitation leads to system compromise regardless of encoding method used.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 139
            - 445
            - 135
            - 3389
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver
        - duration

  - question: What file system modifications occurred after this Unicode RPC exploitation attempt?
    context: Post-exploitation file changes may include malware installation or system tool deployment.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetFilename|contains:
            - "\\system32\\"
            - "\\temp\\"
            - ".exe"
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessGuid

  - question: Are there signs of Unicode-aware shellcode or payload execution?
    context: Advanced exploits may use Unicode-compatible shellcode for broader system compatibility.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          CommandLine|contains:
            - "rundll32"
            - "regsvr32"
            - "powershell"
            - "wscript"
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid

  - question: What post-exploitation network communications suggest successful compromise?
    context: Command and control or data exfiltration activities indicate successful system compromise.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toclient
        - bytes_toserver

  - question: Are other network systems experiencing similar Unicode-based RPC exploitation attempts?
    context: Coordinated attacks often target multiple systems with similar Unicode evasion techniques.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "unicode"
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - alert.signature

  - question: What DNS infrastructure or command and control domains support this Unicode-based attack?
    context: Understanding attacker infrastructure helps identify campaign scope and blocking opportunities.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name