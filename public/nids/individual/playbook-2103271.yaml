name: GPL NETBIOS SMB-DS IrotIsRunning unicode little endian andx attempt
id: 22103271
description: |
  Detects potential exploitation attempts targeting CVE-2002-1561 via SMB-DS IrotIsRunning interface using Unicode with little endian encoding.
  This vulnerability affects Windows RPC services and can lead to buffer overflow conditions.
  Specific encoding variant may target particular system architectures or bypass detection mechanisms.
type: detection
detection_id: 2103271
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the specific Unicode little endian encoded payload structure in this RPC call?
    context: Little endian Unicode encoding reveals target architecture and exploitation technique sophistication.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - rule.name
        - alert.signature

  - question: Is this little endian Unicode SMB traffic part of legitimate system operations?
    context: Little endian encoding is standard for x86/x64 Windows systems but unusual for external exploitation.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 445
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - bytes_toclient
        - duration

  - question: What SMB authentication sequence preceded this endian-specific RPC exploitation attempt?
    context: Architecture-specific exploits require understanding of target system byte ordering and authentication state.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.category|contains:
            - "NETBIOS"
            - "SMB"
        condition: selection
      fields:
        - rule.name
        - alert.signature
        - timestamp

  - question: Are there signs of successful little endian buffer overflow exploitation?
    context: Architecture-specific exploits targeting little endian systems can achieve reliable code execution.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          User|contains:
            - "SYSTEM"
            - "NT AUTHORITY"
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  - question: What other architecture-specific or endian-aware exploitation attempts occurred from this source?
    context: Sophisticated attackers may use multiple endian-specific exploits to ensure compatibility across targets.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "endian"
            - "unicode"
            - "RPC"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - alert.signature

  - question: Has the target system shown compromise indicators following this endian-specific exploit?
    context: Successful architecture-specific exploitation often leads to reliable system compromise and persistence.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 139
            - 445
            - 135
            - 3389
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver
        - duration

  - question: What file system changes occurred after this little endian RPC exploitation attempt?
    context: Architecture-aware exploits may deploy specific payloads optimized for target system architecture.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetFilename|contains:
            - "\\system32\\"
            - "\\temp\\"
            - ".exe"
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessGuid

  - question: Are there indicators of architecture-specific shellcode or payload execution?
    context: Little endian exploits may use specialized shellcode optimized for x86/x64 Windows systems.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          CommandLine|contains:
            - "rundll32"
            - "regsvr32"
            - "powershell"
            - "cmd.exe"
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid

  - question: What network behavior patterns indicate successful system compromise?
    context: Post-exploitation communications may reveal command and control or lateral movement activities.
    range: +4h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toclient
        - bytes_toserver

  - question: Are other systems experiencing similar endian-specific RPC exploitation attempts?
    context: Targeted campaigns may use architecture-specific exploits across multiple similar systems.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: "endian"
          src_ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - alert.signature

  - question: What DNS queries or infrastructure support this architecture-specific attack campaign?
    context: Understanding attacker infrastructure helps identify campaign scope and technical sophistication level.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          host.ip|expand: '%src_ip%'
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
        - dns.query.type_name