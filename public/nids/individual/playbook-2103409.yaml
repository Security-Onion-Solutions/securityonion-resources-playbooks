name: GPL NETBIOS SMB RemoteActivation attempt
id: 22103409
description: |
  Detects potential SMB RemoteActivation attempts targeting DCOM IActivation interface.
  This may indicate attempts to execute remote code via DCOM activation or legitimate distributed component usage.
  May trigger on normal DCOM operations or malicious remote code execution attempts.
type: detection
detection_id: 2103409
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the exact DCOM RemoteActivation request structure detected?
    context: Understanding the specific DCOM activation request reveals target component and execution intent.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - src_ip
        - dst_ip
        - src_port
        - dst_port
        - payload

  - question: Is this system authorized to perform DCOM remote activations?
    context: Legitimate distributed applications may use DCOM activation, but external sources require verification.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 139
        condition: selection
      fields:
        - dst_ip
        - bytes_in
        - bytes_out

  - question: What DCOM interface binding preceded this activation attempt?
    context: DCOM exploits require specific interface binding before remote activation can occur.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 135
            - 139
            - 445
        condition: selection
      fields:
        - src_port
        - connection_state
        - duration

  - question: What DCOM components or CLSIDs were targeted for activation?
    context: Understanding target DCOM components reveals attacker objectives and potential system compromise vectors.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - 'DCOM'
            - 'RemoteActivation'
            - 'IActivation'
        condition: selection
      fields:
        - rule.name
        - rule.category

  - question: Did the DCOM RemoteActivation succeed in executing code?
    context: Successful DCOM activation may lead to remote code execution and require immediate containment.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ProcessGuid

  - question: What other DCOM-based attacks occurred from this source?
    context: Attackers often use multiple DCOM interfaces and activation methods to maximize compromise success.
    range: +/-2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: 'DCOM'
        condition: selection
      fields:
        - rule.name
        - dst_ip

  - question: Are there signs of lateral movement using DCOM activation?
    context: Successful DCOM exploitation often enables lateral movement to other systems in the network.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 135
            - 139
            - 445
        condition: selection
      fields:
        - dst_ip
        - bytes_in
        - bytes_out

  - question: What processes or services were spawned via DCOM activation?
    context: DCOM remote activation may spawn malicious processes or services on the target system.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - 'svchost.exe'
            - 'dllhost.exe'
            - 'wmiprvse.exe'
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ParentImage

  - question: Are other systems experiencing similar DCOM RemoteActivation attempts?
    context: Understanding DCOM attack campaign scope helps identify targeted systems and attack patterns.
    range: +/-4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: 'GPL NETBIOS SMB RemoteActivation attempt'
        condition: selection
      fields:
        - src_ip
        - dst_ip

  - question: What DCOM endpoint mapping and RPC calls preceded this attack?
    context: DCOM attacks require endpoint resolution and RPC communication that may indicate reconnaissance.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 135
            - 139
            - 445
        condition: selection
      fields:
        - dst_ip
        - connection_state