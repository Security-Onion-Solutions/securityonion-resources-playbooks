name: GPL NETBIOS SMB RemoteActivation DCOM Attempt
id: 22103413
description: |
  Detects attempts to exploit DCOM RemoteActivation functionality via SMB named pipes.
  This targets DCOM interfaces that can be abused for remote code execution and lateral movement.
  May trigger on legitimate DCOM applications or distributed computing frameworks using RemoteActivation.
type: detection
detection_id: 2103413
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact DCOM RemoteActivation request structure detected?
    context: Understanding the DCOM interface and activation parameters reveals target application and exploitation method.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - payload
        - payload_printable
        - src_ip
        - dst_ip

  - question: What specific DCOM interface GUID was being targeted for activation?
    context: The interface identifier reveals which Windows component or application is being exploited.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - dce_rpc.interface_uuid
        - dce_rpc.operation

  # Type 2: Triage Assessment
  - question: Is this source authorized to perform DCOM RemoteActivation on this target?
    context: Legitimate distributed applications may use DCOM RemoteActivation for component instantiation.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 139
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - duration

  - question: Does this target system normally accept external DCOM activation requests?
    context: Most secure environments restrict DCOM RemoteActivation to authorized systems within the domain.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: "RemoteActivation"
        condition: selection
      fields:
        - src_ip
        - rule.name

  # Type 3: Activity Context
  - question: What DCOM endpoint resolution preceded this RemoteActivation attempt?
    context: DCOM exploitation typically requires prior endpoint mapper queries to locate target interfaces.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - "DCOM"
            - "endpoint"
            - "DCE"
        condition: selection
      fields:
        - rule.name
        - dce_rpc.interface_uuid
        - dce_rpc.operation

  - question: What RPC authentication and binding occurred before this activation?
    context: Successful DCOM RemoteActivation requires proper RPC authentication and interface binding.
    range: -10m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 135
            - 139
            - 445
        condition: selection
      fields:
        - dst_port
        - bytes_toserver
        - bytes_toclient

  # Type 4: Impact Assessment
  - question: Did the DCOM RemoteActivation result in successful component instantiation?
    context: Successful DCOM exploitation often leads to process creation or service activation on the target system.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ParentImage

  - question: Are there signs of DCOM-based lateral movement or persistence?
    context: DCOM RemoteActivation is commonly used for lateral movement and establishing persistence in Windows environments.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - "lateral"
            - "persistence"
            - "backdoor"
        condition: selection
      fields:
        - rule.name
        - src_ip
        - severity

  # Type 5: Forensic Deep-Dive
  - question: What specific DCOM application or service was targeted for exploitation?
    context: Identifying the target DCOM component reveals attack objectives and potential system impact.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          community_id|expand: '%community_id%'
          rule.name|contains: "RemoteActivation"
        condition: selection
      fields:
        - rule.name
        - payload_printable
        - dce_rpc.interface_uuid

  - question: Are there indicators of custom DCOM exploits or known attack tools?
    context: DCOM RemoteActivation exploits may indicate use of specific attack frameworks or custom tools.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - "exploit"
            - "attack"
            - "malicious"
        condition: selection
      fields:
        - rule.name
        - payload_printable

  # Type 6: Enterprise Correlation
  - question: Are other systems experiencing similar DCOM RemoteActivation attempts?
    context: Coordinated DCOM attacks often target multiple systems for lateral movement campaigns.
    range: -2h/+2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: "GPL NETBIOS SMB RemoteActivation andx attempt"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is this part of a broader Windows-based attack campaign using multiple techniques?
    context: DCOM exploitation often occurs alongside other Windows attack techniques in advanced campaigns.
    range: -4h/+1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "SMB"
            - "DCOM"
            - "RPC"
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - severity