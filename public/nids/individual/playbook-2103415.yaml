name: GPL NETBIOS SMB RemoteActivation Unicode DCOM Attempt
id: 22103415
description: |
  Detects attempts to exploit DCOM RemoteActivation functionality using unicode encoding via SMB named pipes.
  This targets DCOM interfaces with unicode string parameters that can be manipulated for exploitation.
  May trigger on legitimate DCOM applications using unicode strings or internationalized component interfaces.
type: detection
detection_id: 2103415
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact unicode DCOM RemoteActivation payload structure detected?
    context: Understanding the unicode-encoded DCOM parameters reveals exploitation technique targeting string handling vulnerabilities.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - rule.name
        - payload
        - payload_printable
        - src_ip
        - dst_ip

  - question: What specific unicode strings or parameters were being manipulated in the DCOM request?
    context: The unicode content reveals target component interface and potential string-based exploitation vectors.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - dce_rpc.interface_uuid
        - dce_rpc.operation

  # Type 2: Triage Assessment
  - question: Is this source authorized to perform unicode DCOM operations on this target?
    context: Legitimate internationalized applications may use unicode DCOM RemoteActivation for component instantiation.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 139
        condition: selection
      fields:
        - dst_ip
        - bytes_toserver
        - duration

  - question: Does this target system normally handle unicode DCOM activation requests?
    context: Systems supporting internationalized applications may legitimately process unicode DCOM operations.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: "unicode"
        condition: selection
      fields:
        - src_ip
        - rule.name

  # Type 3: Activity Context
  - question: What DCOM interface discovery preceded this unicode-based activation attempt?
    context: Unicode DCOM exploits require prior enumeration of components supporting unicode string parameters.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - "DCOM"
            - "DCE"
            - "RPC"
        condition: selection
      fields:
        - rule.name
        - dce_rpc.interface_uuid
        - dce_rpc.operation

  - question: What unicode encoding reconnaissance occurred before this DCOM attack?
    context: Attackers using unicode DCOM exploits typically test encoding handling and string processing first.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 135
            - 139
            - 445
        condition: selection
      fields:
        - dst_port
        - bytes_toserver
        - bytes_toclient

  # Type 4: Impact Assessment
  - question: Did the unicode DCOM activation result in successful component instantiation or exploitation?
    context: Successful unicode DCOM exploitation often leads to process creation or service activation with elevated privileges.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ParentImage

  - question: Are there signs of unicode-based string exploitation or buffer manipulation?
    context: Unicode DCOM attacks may exploit string handling vulnerabilities leading to memory corruption or code execution.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - "overflow"
            - "buffer"
            - "corruption"
        condition: selection
      fields:
        - rule.name
        - src_ip
        - severity

  # Type 5: Forensic Deep-Dive
  - question: What specific unicode DCOM exploitation technique was employed?
    context: Detailed analysis of unicode patterns reveals advanced DCOM string exploitation methodology.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          community_id|expand: '%community_id%'
          rule.name|contains: "unicode"
        condition: selection
      fields:
        - rule.name
        - payload
        - dce_rpc.interface_uuid

  - question: Are there indicators of internationalization-based evasion or custom unicode exploits?
    context: Unicode DCOM exploits may use character encoding manipulation to evade detection or bypass protections.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - "evasion"
            - "bypass"
            - "encoding"
        condition: selection
      fields:
        - rule.name
        - payload_printable

  # Type 6: Enterprise Correlation
  - question: Are other systems experiencing similar unicode DCOM attacks?
    context: Coordinated use of unicode DCOM exploits indicates targeting of internationalized environments or specific applications.
    range: -4h/+4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: "GPL NETBIOS SMB RemoteActivation unicode andx attempt"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: Is this part of a targeted campaign using multiple DCOM string exploitation variants?
    context: Use of unicode alongside other DCOM exploits suggests comprehensive targeting of string handling vulnerabilities.
    range: -6h/+2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "RemoteActivation"
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - severity