name: GPL NETBIOS SMB RemoteActivation Unicode Little Endian AndX Attempt
id: 22103416
description: |
  Detects SMB RemoteActivation attempts with unicode little endian encoding targeting DCOM interfaces.
  May indicate DCOM exploitation attempts or legitimate remote activation requests.
  Requires prior DCE IActivation binding to trigger.
type: detection
detection_id: 2103416
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete SMB RemoteActivation payload structure?
    context: Understanding the payload reveals the specific DCOM interface being targeted and exploitation intent.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - alert.signature
        - payload_printable
        - src_ip
        - dst_ip
        - dst_port
  - question: Is this system normally accessed via SMB from this source?
    context: Legitimate SMB traffic patterns help distinguish authorized access from potential attacks.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 139
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - bytes_toserver
        - bytes_toclient
  - question: What DCE IActivation binding preceded this RemoteActivation attempt?
    context: Prior DCE binding context reveals the complete attack chain and targeted DCOM services.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          alert.signature|contains: 'IActivation'
        condition: selection
      fields:
        - alert.signature
        - src_ip
        - dst_ip
  - question: What other SMB-based exploitation attempts occurred from this source?
    context: Multiple SMB attack patterns indicate coordinated exploitation attempts against Windows services.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains:
            - 'SMB'
            - 'NETBIOS'
        condition: selection
      fields:
        - alert.signature
        - dst_ip
        - dst_port
  - question: Has successful SMB authentication occurred from this source?
    context: Successful authentication indicates potential credential compromise or insider threat.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 139
            - 445
          bytes_toclient|gt: 1000
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - bytes_toserver
        - bytes_toclient
  - question: What processes are listening on SMB ports on the target system?
    context: Understanding target services helps assess potential impact and exploitation success.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 139
            - 445
        condition: selection
      fields:
        - src_ip
        - dst_port
        - proto
        - bytes_toserver
  - question: Are there signs of successful DCOM object instantiation?
    context: Successful DCOM exploitation may lead to remote code execution and system compromise.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - 'dllhost.exe'
            - 'wmiprvse.exe'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid
  - question: What lateral movement attempts followed this RemoteActivation?
    context: DCOM exploitation often precedes lateral movement to other systems in the network.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 139
            - 445
            - 135
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - bytes_toserver
  - question: Are other systems showing similar DCOM exploitation patterns?
    context: Coordinated DCOM attacks may indicate advanced persistent threat activity across the enterprise.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature|contains: 'RemoteActivation'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature