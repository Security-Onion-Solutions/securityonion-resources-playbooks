name: GPL NETBIOS SMB-DS RemoteActivation attempt
id: 22103417
description: |
  Detects attempts to use DCOM RemoteActivation functionality via SMB.
  This can be used for legitimate remote object instantiation or malicious code execution.
  May trigger on normal DCOM operations or administrative tools using distributed COM objects.
type: detection
detection_id: 2103417
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the exact DCOM RemoteActivation request and object identifier detected?
    context: Understanding the specific DCOM object and activation parameters reveals legitimate usage vs malicious exploitation.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - smb.command
        - smb.request.payload
        - smb.pipe.function
        - smb.tree.service

  - question: Is this DCOM RemoteActivation consistent with normal distributed application usage in this environment?
    context: Legitimate enterprise applications frequently use DCOM for distributed object instantiation and remote procedure calls.
    range: -14d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - connection.state
        - network.bytes_total

  - question: What authentication context was established for this DCOM RemoteActivation attempt?
    context: Authentication details help distinguish between authorized distributed COM operations and unauthorized exploitation.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - smb.authentication.method
        - smb.session.username
        - smb.session.domain
        - smb.ntlm.response.version

  - question: What sequence of DCOM operations preceded this RemoteActivation request?
    context: Analyzing the DCOM session progression reveals normal application behavior vs malicious object manipulation.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - smb.command
        - smb.tree.path
        - smb.request.native_os
        - smb.response.status

  - question: Has the target system shown signs of successful DCOM object instantiation or code execution?
    context: Successful DCOM RemoteActivation may result in remote code execution or unauthorized object creation.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - 'dllhost.exe'
            - 'svchost.exe'
            - 'wmiprvse.exe'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: Are there indicators of malicious payload deployment through DCOM RemoteActivation?
    context: DCOM exploitation may enable remote code execution and malicious file deployment on target systems.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetFilename|contains:
            - '.exe'
            - '.dll'
            - 'dcom'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.size
        - ProcessGuid

  - question: What specific DCOM interface or application was targeted in this RemoteActivation attempt?
    context: Identifying the target DCOM interface helps assess legitimate application usage vs malicious exploitation.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - smb.tree.path
        - smb.request.path
        - smb.pipe.function
        - rule.description

  - question: Has this source demonstrated patterns of DCOM-based attacks across multiple targets?
    context: DCOM exploitation patterns may indicate advanced threat actors using legitimate Windows functionality for malicious purposes.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'DCOM'
            - 'RemoteActivation'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - rule.category
        - alert.severity

  - question: Are there signs of lateral movement or privilege escalation following this DCOM RemoteActivation?
    context: Successful DCOM exploitation may enable further network compromise and privilege escalation through distributed objects.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 445
            - 135
            - 1024
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - connection.state
        - network.protocol

  - question: What is the network and organizational context of this DCOM RemoteActivation source?
    context: DCOM usage patterns may correlate with specific business applications or threat actor methodologies.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - src_ip
        - source.geo.country_name
        - source.as.organization.name
        - network.direction

  - question: Are other systems experiencing coordinated DCOM RemoteActivation attacks or exploitation?
    context: DCOM-based campaigns may target distributed applications and enterprise COM infrastructure across the network.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: 'GPL NETBIOS SMB-DS RemoteActivation attempt'
        condition: selection
      fields:
        - dst_ip
        - src_ip
        - alert.severity
        - rule.category