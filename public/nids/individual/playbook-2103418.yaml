name: GPL NETBIOS SMB-DS RemoteActivation Little Endian Attempt
id: 22103418
description: |
  Detects potential DCOM RemoteActivation exploitation attempts via SMB with little endian encoding.
  May trigger on legitimate DCOM remote object activation or administrative tools using DCOM services.
type: detection
detection_id: 2103418
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete SMB-DS RemoteActivation payload structure?
    context: Understanding the DCOM activation request reveals the target service and potential exploitation intent.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - alert.signature
        - rule.name

  - question: Is this legitimate DCOM remote activation for this system?
    context: Many enterprise applications use DCOM for remote object instantiation and management.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - src_ip
        - bytes_in
        - bytes_out

  - question: What other SMB activity occurred from this source around the same time?
    context: DCOM exploitation often follows SMB enumeration and authentication attempts.
    range: -15m/+15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 445
        condition: selection
      fields:
        - dst_ip
        - community_id
        - duration

  - question: Are there signs of successful DCOM object instantiation?
    context: Successful exploitation may result in process creation or additional network connections.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          Hostname|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: What network connections followed this DCOM attempt?
    context: DCOM exploitation often leads to callback connections or lateral movement.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - community_id
        - duration

  - question: Has this source attempted DCOM attacks against other systems?
    context: Understanding attack scope helps determine if this is targeted or opportunistic scanning.
    range: -24h/+1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: 'RemoteActivation'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - alert.severity

  - question: Are there other DCOM-related alerts from this source?
    context: Multiple DCOM alerts may indicate systematic exploitation attempts or reconnaissance.
    range: -1h/+1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: 'DCOM'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - alert.signature_id

  - question: What authentication activity preceded this DCOM attempt?
    context: DCOM exploitation typically requires prior authentication or credential theft.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - 'NTLM'
            - 'Kerberos'
            - 'SMB'
        condition: selection
      fields:
        - rule.name
        - alert.signature
        - community_id

  - question: Are there indicators of remote code execution following this attempt?
    context: Successful DCOM exploitation may result in arbitrary code execution on the target system.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          Hostname|expand: '%dst_ip%'
          Image|contains:
            - 'cmd.exe'
            - 'powershell.exe'
            - 'wscript.exe'
            - 'cscript.exe'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: Is this part of a broader campaign across the enterprise?
    context: DCOM attacks are often part of lateral movement campaigns targeting multiple systems.
    range: -24h/+4h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'RemoteActivation'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name