name: GPL NETBIOS SMB-DS RemoteActivation Unicode Little Endian Attempt
id: 22103420
description: |
  Detects potential DCOM RemoteActivation exploitation attempts via SMB with Unicode and little endian encoding.
  May trigger on legitimate DCOM applications using Unicode strings with little endian byte ordering.
type: detection
detection_id: 2103420
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the specific Unicode little endian DCOM payload structure?
    context: Combined Unicode and little endian encoding may indicate sophisticated evasion or specific application requirements.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - alert.signature
        - rule.name

  - question: Is this encoding combination normal for applications on this system?
    context: Some Windows applications legitimately use Unicode with little endian byte ordering for DCOM.
    range: -14d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - src_ip
        - bytes_in
        - bytes_out

  - question: What reconnaissance activity preceded this encoded DCOM attempt?
    context: Complex encoding suggests targeted attack with prior system knowledge and enumeration.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - 'scan'
            - 'enum'
            - 'SMB'
        condition: selection
      fields:
        - rule.name
        - alert.signature
        - community_id

  - question: Did this sophisticated DCOM attempt achieve code execution?
    context: Advanced encoding techniques may indicate higher likelihood of successful exploitation.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          Hostname|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: What network communications followed this encoded DCOM attempt?
    context: Successful DCOM exploitation often establishes command and control or lateral movement connections.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - community_id
        - duration

  - question: Are there other advanced encoding techniques used by this attacker?
    context: Sophisticated encoding may be part of broader evasion strategy across multiple attack vectors.
    range: -4h/+4h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'unicode'
            - 'endian'
            - 'encoded'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - alert.signature_id

  - question: What credential access methods were employed before this attempt?
    context: Advanced DCOM attacks often require stolen credentials or authentication bypass techniques.
    range: -2h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'credential'
            - 'NTLM'
            - 'hash'
            - 'ticket'
        condition: selection
      fields:
        - rule.name
        - alert.signature
        - dst_ip

  - question: Are there indicators of advanced persistent threat techniques?
    context: Sophisticated encoding combined with DCOM exploitation may indicate APT-level capabilities.
    range: +6h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          Hostname|expand: '%dst_ip%'
          CommandLine|contains:
            - 'powershell'
            - 'encoded'
            - 'bypass'
            - 'hidden'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: What persistence mechanisms were established after this attempt?
    context: Advanced attackers often establish multiple persistence mechanisms following successful exploitation.
    range: +12h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetObject|contains:
            - 'Run'
            - 'Service'
            - 'Task'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessGuid

  - question: Is this part of a coordinated campaign using advanced DCOM techniques?
    context: Understanding enterprise-wide attack patterns helps identify sophisticated threat actor campaigns.
    range: -12h/+12h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - 'RemoteActivation'
            - 'unicode'
            - 'endian'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name