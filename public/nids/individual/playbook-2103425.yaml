name: GPL NETBIOS SMB CoGetInstanceFromFile Attempt
id: 22103425
description: |
  Detects SMB CoGetInstanceFromFile DCOM exploitation attempts via named pipes.
  May indicate legitimate DCOM operations or potential remote code execution attacks.
  CoGetInstanceFromFile allows instantiation of COM objects from remote files and is exploitable.
type: detection
detection_id: 2103425
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete DCOM CoGetInstanceFromFile request structure?
    context: Understanding the DCOM request reveals exploitation attempt details and target COM objects.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - dcom.interface_uuid
        - dcom.opnum
        - smb.path
        - payload_printable

  - question: What named pipe was used for the DCOM communication?
    context: Named pipe analysis reveals the specific DCOM service being targeted and attack vector.
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - smb.named_pipe
        - protocol

  # Type 2: Triage Assessment
  - question: Is DCOM CoGetInstanceFromFile usage normal for this system pair?
    context: Some applications legitimately use DCOM for distributed object instantiation.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: "CoGetInstanceFromFile"
        condition: selection
      fields:
        - rule.name
        - dcom.interface_uuid

  - question: Does this source system typically perform DCOM operations?
    context: DCOM usage patterns help distinguish between legitimate applications and exploitation attempts.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "DCOM"
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - dcom.interface_uuid

  # Type 3: Activity Context
  - question: What DCOM interface binding preceded this CoGetInstanceFromFile attempt?
    context: DCOM binding sequence reveals the complete exploitation chain and targeted interfaces.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - "DCOM"
            - "bind"
            - "ISystemActivator"
        condition: selection
      fields:
        - rule.name
        - dcom.interface_uuid
        - dcom.opnum

  - question: Was authentication successful before the DCOM exploitation attempt?
    context: Authentication context reveals whether attack follows credential compromise or uses null sessions.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - "authentication"
            - "login"
            - "NTLM"
        condition: selection
      fields:
        - rule.name
        - event.outcome
        - user.name

  # Type 4: Impact Assessment
  - question: Did the CoGetInstanceFromFile exploitation attempt succeed?
    context: Successful DCOM exploitation allows remote code execution with system privileges.
    range: +5m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - "DCOM"
            - "response"
            - "success"
        condition: selection
      fields:
        - rule.name
        - dcom.response_status
        - smb.response.status

  - question: What processes were created after the DCOM exploitation attempt?
    context: Process creation following DCOM exploitation indicates successful remote code execution.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          Hostname|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid
        - ParentImage

  # Type 5: Forensic Deep-Dive
  - question: What COM object was being instantiated via CoGetInstanceFromFile?
    context: COM object identification reveals the specific exploitation technique and potential payload.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains: "COM"
        condition: selection
      fields:
        - rule.name
        - dcom.clsid
        - dcom.interface_uuid
        - file.path

  - question: Were any files created or modified during the DCOM exploitation?
    context: File operations during DCOM exploitation indicate payload deployment or data access.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessName
        - file.size

  - question: What network connections were established after DCOM exploitation?
    context: Post-exploitation network activity reveals command and control or lateral movement attempts.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - protocol
        - bytes_toclient

  # Type 6: Enterprise Correlation
  - question: Are other systems experiencing DCOM CoGetInstanceFromFile exploitation attempts?
    context: Multiple DCOM exploitation attempts indicate coordinated attack campaign or worm activity.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains: "CoGetInstanceFromFile"
        condition: selection
      fields:
        - dst_ip
        - rule.name

  - question: Is this part of a broader DCOM-based attack campaign across the network?
    context: Coordinated DCOM attacks indicate advanced threat actor with knowledge of Windows internals.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains:
            - "DCOM"
            - "CoGetInstanceFromFile"
            - "ISystemActivator"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name