name: GPL NETBIOS SMB CoGetInstanceFromFile unicode little endian attempt
id: 22103428
description: |
  Detects unicode little-endian DCOM interface access attempts via SMB.
  This variant specifically handles little-endian unicode encoding in DCOM requests.
  May indicate legitimate unicode operations or advanced reconnaissance techniques.
type: detection
detection_id: 2103428
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the complete unicode little-endian DCOM request structure?
    context: Little-endian unicode encoding reveals specific platform targeting and exploitation sophistication.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - payload_printable
        - alert.signature

  - question: What specific endianness and unicode indicators were present in this DCOM binding?
    context: Little-endian unicode combination suggests Windows-specific targeting with internationalization support.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id|expand: '%community_id%'
          dst_port: 139
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - bytes_toserver
        - bytes_toclient

  # Type 2: Triage Assessment
  - question: Is little-endian unicode DCOM usage expected for this system's applications?
    context: Some Windows applications legitimately use little-endian unicode DCOM for international support.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          alert.category: 'protocol-command-decode'
          alert.signature|contains: 'unicode'
        condition: selection
      fields:
        - alert.signature
        - src_ip

  - question: Are there documented business processes requiring unicode DCOM interfaces?
    context: Understanding legitimate unicode DCOM requirements helps distinguish authorized operations.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - 'dllhost.exe'
            - 'ole'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  # Type 3: Activity Context
  - question: What SMB session establishment preceded this unicode DCOM attempt?
    context: Prior SMB negotiation reveals authentication context and session security settings.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          community_id|expand: '%community_id%'
          alert.category: 'protocol-command-decode'
        condition: selection
      fields:
        - alert.signature
        - src_ip
        - dst_ip

  - question: What sequence of DCOM operations followed this unicode interface binding?
    context: Sequential DCOM calls reveal attacker methodology and system functionality being accessed.
    range: +1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          alert.signature|contains: 'DCOM'
        condition: selection
      fields:
        - alert.signature
        - dst_port

  # Type 4: Impact Assessment
  - question: Did this unicode DCOM binding result in successful object instantiation?
    context: Successful DCOM object creation may enable unauthorized system access or data manipulation.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          Image|contains:
            - 'dllhost.exe'
            - 'wmiprvse.exe'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - User

  - question: Were there data transfers or file operations following this DCOM access?
    context: Successful DCOM operations may result in file access, data retrieval, or system modification.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          event_type|contains:
            - 'file_access'
            - 'file_create'
        condition: selection
      fields:
        - TargetFilename
        - ProcessImage
        - event_type

  # Type 5: Forensic Deep-Dive
  - question: What specific DCOM classes or interfaces were accessed via unicode methods?
    context: Detailed DCOM interface analysis reveals system functionality being exploited or accessed.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetObject|contains:
            - 'DCOM'
            - 'AppID'
            - 'CLSID'
        condition: selection
      fields:
        - TargetObject
        - Details
        - ProcessImage

  - question: Were there network communications indicating data exfiltration or C2 activity?
    context: Successful DCOM exploitation may establish covert channels or enable data theft.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toserver
        - bytes_toclient

  # Type 6: Enterprise Correlation
  - question: Are other Windows systems experiencing similar unicode DCOM interface attempts?
    context: Coordinated unicode DCOM access may indicate enterprise-wide exploitation or reconnaissance.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature: 'GPL NETBIOS SMB CoGetInstanceFromFile unicode little endian attempt'
        condition: selection
      fields:
        - dst_ip
        - src_ip

  - question: Is this part of systematic Windows DCOM enumeration across the network?
    context: Unicode DCOM attempts may indicate advanced persistent threat activity targeting Windows infrastructure.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains:
            - 'DCOM'
            - 'unicode'
            - 'endian'
        condition: selection
      fields:
        - alert.signature
        - dst_ip