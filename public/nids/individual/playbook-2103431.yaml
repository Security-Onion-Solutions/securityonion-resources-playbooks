name: GPL NETBIOS SMB CoGetInstanceFromFile unicode andx attempt
id: 22103431
description: |
  Detects attempts to use CoGetInstanceFromFile function via SMB with unicode encoding.
  This could indicate legitimate COM object instantiation or potential exploitation attempts.
  May trigger on normal Windows administration or malicious lateral movement activities.
type: detection
detection_id: 2103431
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete SMB command structure and unicode payload detected?
    context: Understanding the exact SMB command reveals whether this is legitimate COM usage or exploitation.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - rule.name
        - alert.signature

  - question: Is this part of normal Windows administration on this system?
    context: CoGetInstanceFromFile is used in legitimate Windows COM operations and system administration.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port: 139
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - bytes_in
        - bytes_out

  - question: What SMB session context preceded this CoGetInstanceFromFile attempt?
    context: Understanding the SMB session establishment helps determine if this is part of authorized access.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - "SMB"
            - "NETBIOS"
        condition: selection
      fields:
        - rule.name
        - alert.signature
        - src_port
        - dst_port

  - question: Are there signs of successful COM object instantiation or code execution?
    context: Successful exploitation would likely result in additional network activity or process creation.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: What is the pattern of SMB traffic from this source IP?
    context: Multiple SMB exploitation attempts may indicate automated scanning or targeted attack.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 139
            - 445
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_in
        - bytes_out

  - question: Are there related DCE/RPC binding attempts from this source?
    context: The flowbit indicates prior DCE ISystemActivator binding, suggesting coordinated COM exploitation.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "DCE"
            - "ISystemActivator"
            - "bind"
        condition: selection
      fields:
        - rule.name
        - alert.signature
        - dst_ip
        - dst_port

  - question: What file operations occurred on the target system during this timeframe?
    context: CoGetInstanceFromFile attempts may result in file creation or modification if successful.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.mime_type
        - User

  - question: Are there similar CoGetInstanceFromFile attempts across other systems?
    context: Multiple targets may indicate a coordinated campaign using COM exploitation techniques.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: "GPL NETBIOS SMB CoGetInstanceFromFile unicode andx attempt"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature_id

  - question: What authentication events occurred from this source IP?
    context: SMB access requires authentication, which may reveal compromise of legitimate credentials.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port|contains:
            - 139
            - 445
            - 88
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_in
        - bytes_out

  - question: Are there any Windows registry modifications following this SMB activity?
    context: Successful COM exploitation may result in registry changes for persistence or configuration.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetObject
        - Details
        - User
        - ProcessGuid