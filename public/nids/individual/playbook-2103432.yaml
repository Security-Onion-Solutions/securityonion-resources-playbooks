name: GPL NETBIOS SMB CoGetInstanceFromFile unicode little endian andx attempt
id: 22103432
description: |
  Detects CoGetInstanceFromFile attempts via SMB using little endian unicode encoding.
  Similar to SID 2103431 but specifically for little endian byte order systems.
  May indicate legitimate COM operations or potential exploitation attempts.
type: detection
detection_id: 2103432
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the little endian unicode payload structure detected?
    context: Understanding the byte order and encoding reveals system architecture and exploitation technique.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - rule.name
        - alert.signature

  - question: Is this consistent with normal COM operations on little endian systems?
    context: Most Windows systems use little endian byte order for COM operations.
    range: -24h
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 139
            - 445
        condition: selection
      fields:
        - src_ip
        - bytes_in
        - bytes_out
        - community_id

  - question: What DCE/RPC ISystemActivator binding preceded this attempt?
    context: The flowbit indicates prior DCE binding, showing the attack chain progression.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - "DCE"
            - "ISystemActivator"
            - "bind"
        condition: selection
      fields:
        - rule.name
        - alert.signature
        - src_port
        - dst_port

  - question: Are there indications of successful COM object instantiation?
    context: Successful COM operations may result in process creation or file access.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ParentImage
        - ProcessGuid

  - question: What is the pattern of little endian COM exploitation attempts?
    context: Multiple little endian attempts may indicate targeted exploitation of specific system architecture.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - "little endian"
            - "CoGetInstanceFromFile"
        condition: selection
      fields:
        - rule.name
        - dst_ip
        - alert.signature_id

  - question: Are there file operations consistent with COM object loading?
    context: CoGetInstanceFromFile operations involve loading files, which may be visible in file events.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - file.mime_type
        - User

  - question: What SMB authentication context exists for this connection?
    context: Understanding authentication helps determine if this is authorized access or credential compromise.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 139
            - 445
            - 88
        condition: selection
      fields:
        - dst_port
        - bytes_in
        - bytes_out
        - community_id

  - question: Are there similar little endian COM attempts across the enterprise?
    context: Multiple systems targeted with little endian exploits may indicate campaign scope.
    range: -1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name: "GPL NETBIOS SMB CoGetInstanceFromFile unicode little endian andx attempt"
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature_id

  - question: What Windows registry activity followed this COM attempt?
    context: COM operations may result in registry access for object registration or configuration.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetObject|contains:
            - "CLSID"
            - "COM"
            - "Interface"
        condition: selection
      fields:
        - TargetObject
        - Details
        - User
        - ProcessGuid

  - question: Are there network anomalies indicating successful exploitation?
    context: Successful COM exploitation may result in unusual network connections or data transfer.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_in
        - bytes_out
        - community_id