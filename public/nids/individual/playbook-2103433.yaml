name: GPL NETBIOS SMB-DS CoGetInstanceFromFile attempt
id: 22103433
description: |
  Detects SMB attempts to invoke CoGetInstanceFromFile through RPC.
  This DCOM method can be exploited for remote code execution. May trigger on legitimate DCOM operations.
type: detection
detection_id: 2103433
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact DCOM CoGetInstanceFromFile invocation structure?
    context: Understanding the DCOM call parameters reveals the exploitation technique and target file path.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - payload
        - alert.signature

  - question: What specific file path was referenced in the CoGetInstanceFromFile call?
    context: The file path indicates the target executable or DLL being instantiated remotely.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - smb.named_pipe
        - dce_rpc.request.opnum
        - flow_id

  # Type 2: Triage Assessment
  - question: Is this source IP authorized for DCOM operations on this system?
    context: Legitimate applications may use DCOM for distributed component instantiation.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 445
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - bytes_toserver

  - question: Does this DCOM activity align with known application deployments?
    context: Enterprise applications often use DCOM for component distribution and remote execution.
    range: -1d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - src_ip
        - duration
        - connection_state

  # Type 3: Activity Context
  - question: What DCOM authentication and binding preceded this CoGetInstanceFromFile call?
    context: Understanding the DCOM session establishment reveals authentication context and interface binding.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          alert.signature|contains: 'isystemactivator'
        condition: selection
      fields:
        - alert.signature
        - dce_rpc.request.opnum
        - smb.tree_id

  - question: What other DCOM-related activities occurred around the same time?
    context: Multiple DCOM calls may indicate systematic exploitation or legitimate distributed operations.
    range: -30m/+30m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains: 'DCOM'
        condition: selection
      fields:
        - alert.signature
        - dst_ip
        - dst_port

  - question: What SMB file operations followed this DCOM instantiation attempt?
    context: Successful DCOM exploitation may lead to file creation, modification, or execution.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          alert.signature|contains: 'SMB'
        condition: selection
      fields:
        - alert.signature
        - smb.command
        - smb.named_pipe

  # Type 4: Impact Assessment
  - question: Did the CoGetInstanceFromFile call result in successful remote code execution?
    context: DCOM exploitation can lead to arbitrary code execution with system privileges.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  - question: Are there signs of malicious file deployment or backdoor installation?
    context: DCOM attacks often involve deploying malicious executables or establishing persistence.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - User

  # Type 5: Forensic Deep-Dive
  - question: What specific DCOM interface and method were exploited?
    context: Different DCOM interfaces provide various attack vectors and system access levels.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - dce_rpc.request.opnum
        - dce_rpc.cn_flags
        - alert.metadata

  - question: Are there indicators of lateral movement or credential theft following this DCOM attack?
    context: Successful DCOM exploitation may be used as a pivot point for further network compromise.
    range: +6h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toclient

  # Type 6: Enterprise Correlation
  - question: Are other systems experiencing similar DCOM CoGetInstanceFromFile attempts?
    context: Coordinated DCOM attacks may indicate worm-like propagation or targeted campaign.
    range: -1h/+1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature: 'GPL NETBIOS SMB-DS CoGetInstanceFromFile attempt'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature

  - question: Is this part of a broader DCOM-based attack campaign across the enterprise?
    context: Multiple DCOM exploitation attempts may indicate advanced persistent threat or automated attack tools.
    range: -24h/+24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains: 'DCOM'
        condition: selection
      fields:
        - alert.signature
        - dst_ip
        - alert.severity