name: GPL NETBIOS SMB-DS CoGetInstanceFromFile little endian attempt
id: 22103434
description: |
  Detects SMB attempts to invoke CoGetInstanceFromFile through RPC with little endian encoding.
  This DCOM method can be exploited for remote code execution. May trigger on legitimate DCOM operations.
type: detection
detection_id: 2103434
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  # Type 1: Artifact Analysis
  - question: What was the exact little endian DCOM CoGetInstanceFromFile payload structure?
    context: Understanding the byte order and encoding reveals specific exploitation tools and techniques used.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload_printable
        - payload
        - alert.signature

  - question: What file path and parameters were specified in the little endian DCOM call?
    context: The target file and parameters indicate the malicious payload being instantiated remotely.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - smb.named_pipe
        - dce_rpc.request.opnum
        - flow_id

  # Type 2: Triage Assessment
  - question: Is this source IP known for legitimate DCOM administrative operations?
    context: System administrators may use DCOM for remote component management and deployment.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_port: 445
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - bytes_toserver

  - question: Does this DCOM activity correspond to scheduled deployment or maintenance tasks?
    context: Enterprise software deployment often uses DCOM for remote component installation.
    range: -1d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - src_ip
        - duration
        - connection_state

  # Type 3: Activity Context
  - question: What DCOM interface binding and authentication preceded this little endian call?
    context: Understanding the complete DCOM session reveals authentication bypass attempts and interface access.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          alert.signature|contains: 'isystemactivator'
        condition: selection
      fields:
        - alert.signature
        - dce_rpc.request.opnum
        - smb.tree_id

  - question: What concurrent DCOM exploitation attempts were detected?
    context: Multiple DCOM variants may indicate systematic exploitation or different attack tool usage.
    range: -30m/+30m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains: 'CoGetInstanceFromFile'
        condition: selection
      fields:
        - alert.signature
        - dst_ip
        - dst_port

  - question: What file system activity followed this DCOM instantiation attempt?
    context: Successful DCOM exploitation typically results in file creation, modification, or execution.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          alert.signature|contains: 'SMB'
        condition: selection
      fields:
        - alert.signature
        - smb.command
        - smb.named_pipe

  # Type 4: Impact Assessment
  - question: Did the little endian DCOM call achieve successful remote code execution?
    context: DCOM exploitation can result in arbitrary code execution with elevated privileges.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User

  - question: Are there indicators of malicious payload deployment or system compromise?
    context: DCOM attacks often involve installing backdoors or establishing persistent access mechanisms.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - User

  # Type 5: Forensic Deep-Dive
  - question: What specific DCOM exploitation technique was used with little endian encoding?
    context: Byte order analysis helps identify specific exploit tools and attack frameworks.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - dce_rpc.request.opnum
        - dce_rpc.cn_flags
        - alert.metadata

  - question: Are there signs of post-exploitation activity or network propagation?
    context: Successful DCOM compromise may lead to lateral movement and additional system infections.
    range: +6h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_toclient

  # Type 6: Enterprise Correlation
  - question: Are other systems showing similar little endian DCOM exploitation attempts?
    context: Coordinated DCOM attacks may indicate automated exploitation tools or targeted campaigns.
    range: -1h/+1h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          alert.signature: 'GPL NETBIOS SMB-DS CoGetInstanceFromFile little endian attempt'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - alert.signature

  - question: Is this part of a comprehensive DCOM-based attack strategy across the network?
    context: Multiple DCOM attack vectors may indicate advanced persistent threat or sophisticated attack framework.
    range: -24h/+24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          alert.signature|contains: 'DCOM'
        condition: selection
      fields:
        - alert.signature
        - dst_ip
        - alert.severity