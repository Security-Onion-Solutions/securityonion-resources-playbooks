name: GPL NETBIOS SMB-DS CoGetInstanceFromFile unicode little endian andx attempt
id: 22103440
description: |
  Detects little endian encoded attempts to exploit SMB-DS CoGetInstanceFromFile functionality.
  May trigger on legitimate DCOM operations or administrative tools using named pipes.
  Little endian encoding may indicate targeted exploitation attempts against specific architectures.
type: detection
detection_id: 2103440
detection_category:
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the little endian encoded payload structure and DCOM operation?
    context: Little endian encoding patterns reveal specific exploitation techniques and target architecture.
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          document_id|expand: '%document_id%'
        condition: selection
      fields:
        - payload
        - rule.name
        - alert.signature

  - question: What DCOM service binding and SMB session setup preceded this attempt?
    context: DCOM operations require specific service bindings and authentication before exploitation.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - 'dce.isystemactivator.bind'
            - 'SMB'
            - 'DCOM'
        condition: selection
      fields:
        - rule.name
        - alert.signature
        - src_port
        - dst_port

  - question: Is this normal little endian DCOM activity for this system architecture?
    context: Legitimate applications may use little endian encoding but should follow normal patterns.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          dst_port: 445
        condition: selection
      fields:
        - src_ip
        - bytes_in
        - bytes_out

  - question: What other little endian or architecture-specific attacks originated from this source?
    context: Targeted attacks often use architecture-specific encoding to bypass detection systems.
    range: -1h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          src_ip|expand: '%src_ip%'
          rule.name|contains:
            - 'little endian'
            - 'unicode'
            - 'CoGetInstanceFromFile'
        condition: selection
      fields:
        - dst_ip
        - rule.name
        - alert.signature

  - question: Did the little endian DCOM attempt result in successful service execution?
    context: Successful DCOM exploitation leads to process creation with elevated privileges.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          User|contains:
            - 'SYSTEM'
            - 'NETWORK SERVICE'
        condition: selection
      fields:
        - Image
        - CommandLine
        - User
        - ProcessGuid

  - question: What named pipe access patterns followed this DCOM exploitation attempt?
    context: DCOM attacks often involve specific named pipe operations for service communication.
    range: +15m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - 'PIPE'
            - 'Named Pipe'
        condition: selection
      fields:
        - src_ip
        - rule.name
        - alert.signature

  - question: What network connections were established using little endian protocols?
    context: Successful exploitation may establish reverse connections using architecture-specific protocols.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - bytes_out
        - community_id

  - question: Are there indicators of payload deployment or backdoor installation?
    context: Little endian exploits may deploy architecture-specific payloads or backdoors.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip|expand: '%dst_ip%'
          TargetFilename|contains:
            - '.exe'
            - '.dll'
            - '.scr'
        condition: selection
      fields:
        - TargetFilename
        - file.hash.md5
        - ProcessGuid

  - question: What lateral movement attempts used similar little endian encoding?
    context: Attackers may use consistent encoding techniques across multiple targets.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip|expand: '%dst_ip%'
          dst_port|contains:
            - 445
            - 135
            - 139
        condition: selection
      fields:
        - dst_ip
        - dst_port
        - community_id

  - question: Has this little endian DCOM attack pattern been observed on other systems?
    context: Coordinated attacks often use consistent encoding and exploitation techniques.
    range: -2h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          rule.name|contains: 'CoGetInstanceFromFile'
          alert.signature|contains: 'little endian'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - rule.name

  - question: What authentication or privilege escalation events coincided with the DCOM attempt?
    context: DCOM exploitation may involve authentication bypass or privilege escalation techniques.
    range: -15m
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          dst_ip|expand: '%dst_ip%'
          rule.name|contains:
            - 'Authentication'
            - 'Privilege'
            - 'Logon'
        condition: selection
      fields:
        - src_ip
        - rule.name
        - alert.signature