name: "ET MALWARE Category Playbook"
id: 7a2c4d8e-f9b3-4e5a-a1d2-987654321abc
description: |
    This playbook is designed to help investigate alerts from the ET MALWARE category, which detects malicious software activity on the network.
type: detection
detection_id: ''
detection_category: 'ET MALWARE'
detection_type: nids
contributors:
  - SecurityOnionSolutions
date: 2025-04-30
modified: 2025-04-30
questions:
  - question: 'What is the specific type of malware activity being detected?'
    context: 'Different malware alerts may indicate different stages of infection (delivery, execution, C2, etc.). Understanding the specific activity helps prioritize response. A good starting point for this context is the detection name and description.'
    answer_sources:
        - alert
    query: |
        aggregation: false
        logsource:
          category: alert
          product: suricata
        detection:
            selection:
                document_id: '{soc_id}'
            condition: selection
        fields:
            - rule.name
            - src_ip
            - src_port
            - dst_ip
            - dst_port

  - question: 'Is this the first time this specific malware alert has been seen for the internal host/s?'
    context: 'Understanding if this is a new infection or ongoing activity helps determine the infection timeline and scope.'
    answer_sources:
        - alert
    range: -30d
    query: |
        aggregation: true
        logsource:
          category: alert
          product: suricata
        detection:
            selection:
                rule.name: '{rule.name}'
            filter:
                - src_ip: '{network.private_ip}'
                - dst_ip: '{network.private_ip}'
            condition: selection and filter
        fields:
            - rule.name
            - src_ip
            - dst_ip

  - question: 'What process is associated with the network connection?'
    context: 'Identifying the process responsible for triggering the alert can help determine the potential infection vector and extent. Pivoting off of the process GUID can help find other related events.'
    answer_sources:
        - network
    range: +/-15m
    query: |
        aggregation: false
        logsource:
          category: network
        detection:
            selection:
                community_id: '{network.community_id}'
            filter:
                Image|exists: true
            condition: selection and filter
        fields:
            - hostname
            - User
            - ProcessGuid
            - event.action
            - Image
            - CommandLine

  - question: 'Are there any DNS queries associated with the network connection?'
    context: 'Malware can use DNS for C2 communication or to locate its infrastructure. DNS patterns can reveal additional IOCs.'
    answer_sources:
        - network.dns
    range: -15m
    query: |
        aggregation: false
        logsource:
          category: network
          service: dns
        detection:
            selection:
               - src_ip: '{network.private_ip}'
               - dns.query.name|contains: '{dns.query_name}'
               - dns.resolved_ip: '{network.public_ip}'
            condition: selection
        fields:
            - dns.query.name
            - dns.query.type_name
            - dns.resolved_ip
            - dns.response.code_name

  - question: 'What is the volume and pattern of communication with the endpoint?'
    context: 'Understanding the communication patterns can help identify the type of malware and its behavior (e.g., periodic beaconing, large data transfers).'
    answer_sources:
        - network.conn
    range: -1h
    query: |
        aggregation: false
        logsource:
          category: network
          service: connection
        detection:
            selection:
                src_ip: '{related.ip}'
                dst_ip: '{related.ip}'
            condition: selection
        fields:
            - src_ip
            - dst_ip
            - dst_port
            - network.protocol
            - event.duration
            - client.ip_bytes
            - server.ip_bytes
            - connection.state_description

  - question: 'Are there any file transfers associated with this network connection?'
    context: 'Malware often downloads additional payloads or exfiltrates data. Understanding file transfers can reveal staging or exfiltration activity.'
    answer_sources:
        - network.file
    range: +/-60m
    query: |
        aggregation: false
        logsource:
          category: network
          service: file
        detection:
            selection:
                community_id: '{network.community_id}'
            condition: selection
        fields:
            - file.source
            - file.mime_type
            - file.bytes.total

  - question: 'Are there any file modifications or creations around the time of the alert?'
    context: 'Malware often creates new files or modifies existing ones during execution. This can include dropping additional payloads, creating persistence mechanisms, or modifying system files.'
    answer_sources:
        - endpoint.file
    range: -5m
    query: |
        aggregation: false
        logsource:
          category: file_event
        detection:
            selection:
                host.ip: '{related.ip}'
            condition: selection
        fields:
            - hostname
            - event.type
            - Image
            - file.name
            - file.path

  - question: 'Are there any other security events from the internal endpoint?'
    context: 'Malware often triggers multiple types of security events. Correlating these can reveal the full scope of the infection.'
    answer_sources:
        - alert
    range: -24h
    query: |
        aggregation: true
        logsource:
          category: alert
        detection:
            selection:
                - related_ip: '{network.private_ip}'
            condition: selection
        fields:
            - rule.type
            - rule.name
            - src_ip
            - src_port
            - dst_ip
            - dst_port

  - question: 'Has this specific activity been observed on other internal systems?'
    context: 'Malware can spread laterally. Identifying other infected systems is crucial for containment.'
    answer_sources:
        - alert
    range: -7d
    query: |
        aggregation: true
        logsource:
          category: alert
        detection:
            selection:
                rule.name: '{rule.name}'
            filter:
                - related_ip: '{network.private_ip}'
            condition: selection and not filter
        fields:
            - src_ip
            - dst_ip
