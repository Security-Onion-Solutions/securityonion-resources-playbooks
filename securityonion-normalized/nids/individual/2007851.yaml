name: ET ACTIVEX Citrix Presentation Server Client WFICA.OCX ActiveX Component Heap Buffer Overflow Exploit
id: 1247254
description: |
  Detects HTTP responses containing specific strings associated with Citrix WFICA.OCX ActiveX heap buffer overflow exploitation attempts.
  May trigger on legitimate Citrix client software updates or system administration activities involving ActiveX components.
type: detection
detection_id: 2007851
detection_category: ''
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete HTTP response containing the WFICA.OCX exploit pattern?
    context: Reveals the full payload and delivery mechanism for the ActiveX heap buffer overflow attempt.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id: '{network.community_id}'
        condition: selection
      fields:
        - http.method
        - http.useragent
        - http.virtual_host
        - http.uri
        - http.status_code
  - question: Does this host normally receive web content from this external server?
    context: Determines if HTTP traffic from this source represents normal browsing patterns.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip: '{destination.ip}'
        condition: selection
      fields:
        - dst_ip
  - question: What browser process was active when this exploit payload was received?
    context: Identifies the specific browser that processed the malicious ActiveX content.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
      detection:
        selection:
          community_id: '{network.community_id}'
        filter:
          Image|exists: true
        condition: selection and filter
      fields:
        - hostname
        - User
        - Image
        - CommandLine
        - ProcessGuid
  - question: What DNS queries occurred before receiving this exploit payload?
    context: Reveals the domain resolution that led to the malicious server connection.
    range: -5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip: '{source.ip}'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.resolved_ip
  - question: What other external web connections occurred from this host?
    context: Identifies additional web traffic that may indicate browsing session context or related exploitation.
    range: +/-10m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip: '{source.ip}'
        private:
          dst_ip|cidr:
            - '10.0.0.0/8'
            - '127.0.0.0/8'
            - '172.16.0.0/12'
            - '192.168.0.0/16'
            - '169.254.0.0/16'
        filter:
          dst_ip: '{network.public_ip}'
        condition: selection and not (private or filter)
      fields:
        - dst_ip
        - dst_port
        - network.transport
        - connection.state_description
  - question: Are other hosts receiving similar exploit payloads from the same infrastructure?
    context: Determines scope of potential drive-by download campaign targeting ActiveX vulnerabilities.
    range: +/-24h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip: '{network.public_ip}'
        filter:
          src_ip: '{source.ip}'
        condition: selection and not filter
      fields:
        - src_ip
        - dst_port
        - network.transport
        - connection.state_description
  - question: What executable files were created after receiving this ActiveX exploit?
    context: Identifies binaries that may have been dropped through successful heap buffer overflow exploitation.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip: '{network.private_ip}'
          file.name|endswith:
          - .exe
          - .dll
          - .bat
          - .cmd
          - .ps1
          - .vbs
          - .js
          - .scr
          - .com
          - .pif
        condition: selection
      fields:
        - file.path
        - file.name
        - Image
        - ProcessGuid
        - User
  - question: Were any ActiveX controls or browser plugins modified on this system?
    context: Assesses whether the exploit successfully modified browser security settings or installed components.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip: '{source.ip}'
          TargetObject|contains:
            - "ActiveX"
            - "CLSID"
            - "OCX"
            - "BrowserHelperObject"
        condition: selection
      fields:
        - TargetObject
        - Details
        - Image
        - EventType
  - question: Did any lateral movement occur from this host after the exploit delivery?
    context: Determines if successful exploitation led to network propagation or additional system compromise.
    range: +4h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip: '{network.private_ip}'
          dst_port:
          - 445    # SMB
          - 139    # NetBIOS
          - 3389   # RDP
          - 5985   # WinRM HTTP
          - 5986   # WinRM HTTPS
          - 22     # SSH
          - 23     # Telnet
          - 135    # RPC
          - 5900   # VNC
        condition: selection
      fields:
        - src_ip
        - src_port
        - dst_ip
        - dst_port
        - network.transport
  - question: Are there related alerts involving the same external IP addresses?
    context: Identifies other security events that may be part of the same exploitation campaign.
    range: +/-24h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          related_ip: '{related.ip}'
        filter:
          document_id: '{soc_id}'
        condition: selection and not filter
      fields:
        - rule.name
        - rule.category
        - src_ip
        - dst_ip
  - question: What is the pattern of browser activity leading up to this exploit attempt?
    context: Reconstructs the browsing session that led to the malicious ActiveX content delivery.
    range: -30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip: '{source.ip}'
          http.method: "GET"
        condition: selection
      fields:
        - http.virtual_host
        - http.uri
        - http.user_agent
        - dst_ip
  - question: Did this host attempt to access any other domains serving ActiveX content?
    context: Reveals broader exposure to ActiveX-based attacks or drive-by download campaigns.
    range: +/-6h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip: '{source.ip}'
          http.uri|contains:
            - ".ocx"
            - ".cab"
            - "activex"
            - "object"
            - "clsid"
        condition: selection
      fields:
        - http.virtual_host
        - http.uri
        - dst_ip
