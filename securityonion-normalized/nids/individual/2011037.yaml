name: ET WEB_SERVER Possible Attempt to Get SQL Server Version in URI using SELECT VERSION
id: 1200483
description: |
  Detects HTTP requests containing "SELECT VERSION" strings in the URI, which may indicate SQL injection attempts targeting SQL Server version enumeration.
  May trigger on legitimate database administration tools, application debugging, or security scanning activities.
type: detection
detection_id: 2011037
detection_category: ''
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete HTTP request containing the SELECT VERSION string?
    context: Reveals the exact URI structure and SQL injection payload used in the version enumeration attempt.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id: '{network.community_id}'
        condition: selection
      fields:
        - http.method
        - http.useragent
        - http.virtual_host
        - http.uri
        - http.status_code
  - question: Does this host normally receive HTTP requests with database query parameters?
    context: Determines if SQL-like strings in URIs represent normal application behavior.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip: '{destination.ip}'
        condition: selection
      fields:
        - dst_ip
  - question: What web application or service processed this request?
    context: Identifies the specific web server or application that received the potential SQL injection attempt.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
      detection:
        selection:
          community_id: '{network.community_id}'
        filter:
          Image|exists: true
        condition: selection and filter
      fields:
        - hostname
        - User
        - Image
        - CommandLine
        - ProcessGuid
  - question: What other HTTP requests occurred from the same source around this time?
    context: Reveals the broader pattern of requests that may indicate systematic SQL injection testing.
    range: +/-30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip: '{source.ip}'
          dst_ip: '{destination.ip}'
        condition: selection
      fields:
        - http.method
        - http.uri
        - http.user_agent
        - http.status_code
  - question: Were any database-related files or processes accessed after this request?
    context: Assesses whether the SQL injection attempt resulted in database interaction or file access.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip: '{network.private_ip}'
          file.name|endswith:
          - .exe
          - .dll
          - .bat
          - .cmd
          - .ps1
          - .vbs
          - .js
          - .scr
          - .com
          - .pif
        condition: selection
      fields:
        - file.path
        - file.name
        - Image
        - ProcessGuid
        - User
  - question: Are other web servers receiving similar SQL injection attempts?
    context: Determines if this is part of a broader SQL injection campaign targeting multiple systems.
    range: +/-24h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip: '{network.public_ip}'
        filter:
          src_ip: '{source.ip}'
        condition: selection and not filter
      fields:
        - src_ip
        - dst_port
        - network.transport
        - connection.state_description
  - question: What response codes were returned for requests containing SQL keywords?
    context: Identifies successful versus failed SQL injection attempts based on HTTP response patterns.
    range: +/-1h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip: '{destination.ip}'
          http.uri|contains:
            - "SELECT"
            - "UNION"
            - "INSERT"
            - "UPDATE"
            - "DELETE"
        condition: selection
      fields:
        - src_ip
        - http.method
        - http.uri
        - http.status_code
        - http.user_agent
  - question: Did any lateral movement occur from the targeted web server?
    context: Assesses whether successful SQL injection led to further network compromise.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip: '{network.private_ip}'
          dst_port:
          - 445    # SMB
          - 139    # NetBIOS
          - 3389   # RDP
          - 5985   # WinRM HTTP
          - 5986   # WinRM HTTPS
          - 22     # SSH
          - 23     # Telnet
          - 135    # RPC
          - 5900   # VNC
        condition: selection
      fields:
        - src_ip
        - src_port
        - dst_ip
        - dst_port
        - network.transport
  - question: What is the pattern of this source IP's web application testing activity?
    context: Analyzes the systematic nature and scope of SQL injection attempts from this source.
    range: +/-2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          src_ip: '{source.ip}'
          http.uri|contains:
            - "SELECT"
            - "UNION"
            - "OR 1=1"
            - "HAVING"
            - "ORDER BY"
            - "VERSION"
            - "@@"
        condition: selection
      fields:
        - dst_ip
        - http.method
        - http.uri
        - http.status_code
        - http.virtual_host
  - question: Are there related alerts indicating web application attacks from this source?
    context: Identifies coordinated web application attack patterns beyond SQL injection.
    range: +/-24h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          related_ip: '{related.ip}'
        filter:
          document_id: '{soc_id}'
        condition: selection and not filter
      fields:
        - rule.name
        - rule.category
        - src_ip
        - dst_ip