name: ET DNS DNS Lookup for localhost.DOMAIN.TLD
id: 1228551
description: |
  Detects DNS queries for localhost followed by a domain name, which may indicate DNS tunneling,
  C2 communication, or malware attempting to bypass security controls. Can also occur with
  legitimate applications that construct DNS queries with localhost prefixes for testing or
  development purposes.
type: detection
detection_id: 2011802
detection_category: ''
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete DNS query containing the localhost pattern?
    context: Reveals the full domain structure and potential tunneling payload.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          community_id: '{network.community_id}'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.resolved_ip
  - question: Does this host normally perform DNS queries with localhost patterns?
    context: Establishes baseline behavior for this type of DNS activity.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          dns.query.name: '{dns.query_name}'
        condition: selection
      fields:
        - dns.query.name
  - question: What process initiated the DNS query for localhost.domain.tld?
    context: Identifies the application responsible for the suspicious DNS pattern.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
      detection:
        selection:
          community_id: '{network.community_id}'
        filter:
          Image|exists: true
        condition: selection and filter
      fields:
        - hostname
        - User
        - Image
        - CommandLine
        - ProcessGuid
  - question: What other external connections occurred from this host?
    context: Identifies potential C2 channels or data exfiltration attempts.
    range: +/-10m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip: '{source.ip}'
        private:
          dst_ip|cidr:
            - '10.0.0.0/8'
            - '127.0.0.0/8'
            - '172.16.0.0/12'
            - '192.168.0.0/16'
            - '169.254.0.0/16'
        filter:
          dst_ip: '{network.public_ip}'
        condition: selection and not (private or filter)
      fields:
        - dst_ip
        - dst_port
        - network.transport
        - connection.state_description
  - question: Are other hosts performing similar localhost DNS queries?
    context: Determines if this is part of coordinated malware activity.
    range: +/-24h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip: '{network.public_ip}'
        filter:
          src_ip: '{source.ip}'
        condition: selection and not filter
      fields:
        - src_ip
        - dst_port
        - network.transport
        - connection.state_description
  - question: What is the pattern of DNS queries from this host?
    context: Analyzes timing and frequency that may indicate automated or tunneling behavior.
    range: +/-2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip: '{related.ip}'
          dst_ip: '{related.ip}'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - network.protocol
        - event.duration
        - client.ip_bytes
        - server.ip_bytes
        - connection.state_description
  - question: Did any lateral movement occur from this host?
    context: Assesses whether the host is being used to spread to other systems.
    range: +/-6h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip: '{network.private_ip}'
          dst_port:
          - 445    # SMB
          - 139    # NetBIOS
          - 3389   # RDP
          - 5985   # WinRM HTTP
          - 5986   # WinRM HTTPS
          - 22     # SSH
          - 23     # Telnet
          - 135    # RPC
          - 5900   # VNC
        condition: selection
      fields:
        - src_ip
        - src_port
        - dst_ip
        - dst_port
        - network.transport
  - question: Are there other alerts involving this host or related IPs?
    context: Identifies related security events that may be part of the same incident.
    range: +/-24h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          related_ip: '{related.ip}'
        filter:
          document_id: '{soc_id}'
        condition: selection and not filter
      fields:
        - rule.name
        - rule.category
        - src_ip
        - dst_ip
  - question: What domains did the suspicious queries resolve to?
    context: Reveals infrastructure potentially used for C2 or data exfiltration.
    range: +/-30m
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip: '{source.ip}'
          dns.query.name|contains: "localhost"
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
  - question: Did this host attempt other DNS tunneling or evasion techniques?
    context: Identifies broader patterns of DNS-based communication or evasion.
    range: +/-6h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip: '{source.ip}'
        suspicious_patterns:
          dns.query.name|contains:
            - "base64"
            - "hex"
            - "tunnel"
            - "bypass"
        long_subdomain:
          dns.query.name|re: ".*\\..*\\..*\\..*\\..*\\."
        condition: selection and (suspicious_patterns or long_subdomain)
      fields:
        - dns.query.name
        - dns.query.type_name