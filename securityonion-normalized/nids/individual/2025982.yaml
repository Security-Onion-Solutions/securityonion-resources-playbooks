name: ET MALWARE MSIL/Eredel Stealer CnC Checkin
id: 1239019
description: |
  Detects POST requests to PHP endpoints with parameters typical of Eredel stealer malware command and control communications.
  May trigger on legitimate applications using similar parameter patterns or security testing tools.
type: detection
detection_id: 2025982
detection_category: ''
detection_type: nids
contributors:
- SecurityOnionSolutions
created: 2024-01-15
questions:
- question: What was the complete HTTP POST request containing the stealer parameters?
  context: Reveals the full C2 communication pattern and extracted data structure.
  range: +/-15m
  query: |
    aggregation: false
    logsource:
      category: network
      service: http
    detection:
      selection:
        community_id: '{network.community_id}'
      condition: selection
    fields:
      - http.method
      - http.useragent
      - http.virtual_host
      - http.uri
      - http.status_code
- question: Does this host normally make POST requests to PHP endpoints?
  context: Determines if HTTP POST activity to web applications is typical for this system.
  range: -7d
  query: |
    aggregation: true
    logsource:
      category: network
      service: http
    detection:
      selection:
        dst_ip: '{destination.ip}'
      condition: selection
    fields:
      - dst_ip
- question: What process initiated the connection to the suspected C2 server?
  context: Identifies the application or malware component performing the C2 communication.
  range: +/-15m
  query: |
    aggregation: false
    logsource:
      category: network
    detection:
      selection:
        community_id: '{network.community_id}'
      filter:
        Image|exists: true
      condition: selection and filter
    fields:
      - hostname
      - User
      - Image
      - CommandLine
      - ProcessGuid
- question: What DNS queries preceded this C2 communication?
  context: Reveals domain resolution patterns that may indicate C2 infrastructure.
  range: -5m
  query: |
    aggregation: false
    logsource:
      category: network
      service: dns
    detection:
      selection:
        src_ip: '{source.ip}'
      condition: selection
    fields:
      - dns.query.name
      - dns.query.type_name
      - dns.resolved_ip
- question: What other external connections occurred from this host?
  context: Identifies additional C2 channels or data exfiltration attempts.
  range: +/-10m
  query: |
    aggregation: false
    logsource:
      category: network
      service: connection
    detection:
      selection:
        src_ip: '{source.ip}'
      private:
        dst_ip|cidr:
          - '10.0.0.0/8'
          - '127.0.0.0/8'
          - '172.16.0.0/12'
          - '192.168.0.0/16'
          - '169.254.0.0/16'
      filter:
        dst_ip: '{network.public_ip}'
      condition: selection and not (private or filter)
    fields:
      - dst_ip
      - dst_port
      - network.transport
      - connection.state_description
- question: Are other hosts connecting to the same C2 infrastructure?
  context: Determines the scope of potential Eredel stealer infections across the network.
  range: +/-24h
  query: |
    aggregation: false
    logsource:
      category: network
      service: connection
    detection:
      selection:
        dst_ip: '{network.public_ip}'
      filter:
        src_ip: '{source.ip}'
      condition: selection and not filter
    fields:
      - src_ip
      - dst_port
      - network.transport
      - connection.state_description
- question: What executable files were created by the process making C2 connections?
  context: Identifies malware components or dropped files associated with the stealer.
  range: +/-1h
  query: |
    aggregation: false
    logsource:
      category: file_event
    detection:
      selection:
        ProcessGuid: '{event_data.process.entity_id}'
      condition: selection
    fields:
      - file.path
      - file.name
      - Image
      - User
- question: What credential or browser-related files were accessed around this time?
  context: Assesses potential data theft targeting stored credentials or browser data.
  range: +/-30m
  query: |
    aggregation: false
    logsource:
      category: file_event
    detection:
      selection:
        host.ip: '{source.ip}'
        file.path|contains:
          - "Login Data"
          - "Cookies"
          - "Web Data"
          - "passwords"
          - "credentials"
          - "wallet"
          - "AppData\\Local\\Google"
          - "AppData\\Roaming\\Mozilla"
      condition: selection
    fields:
      - file.path
      - file.name
      - Image
      - User
- question: Did any lateral movement occur from this host?
  context: Determines if the stealer malware spread to other systems in the network.
  range: +/-6h
  query: |
    aggregation: false
    logsource:
      category: network
      service: connection
    detection:
      selection:
        src_ip: '{network.private_ip}'
        dst_port:
        - 445    # SMB
        - 139    # NetBIOS
        - 3389   # RDP
        - 5985   # WinRM HTTP
        - 5986   # WinRM HTTPS
        - 22     # SSH
        - 23     # Telnet
        - 135    # RPC
        - 5900   # VNC
      condition: selection
    fields:
      - src_ip
      - src_port
      - dst_ip
      - dst_port
      - network.transport
- question: Were any scheduled tasks or services created for persistence?
  context: Identifies persistence mechanisms used by the Eredel stealer malware.
  range: +/-1h
  query: |
    aggregation: false
    logsource:
      category: process_creation
    detection:
      selection:
        host.ip: '{network.private_ip}'
        Image|endswith:
        - schtasks.exe
        - taskeng.exe
        - taskhostw.exe
      condition: selection
    fields:
      - CommandLine
      - Image
      - ProcessGuid
      - User
      - ParentImage
- question: Are there related stealer alerts across the organization?
  context: Reveals the broader scope of the Eredel stealer campaign.
  range: +/-24h
  query: |
    aggregation: true
    logsource:
      category: alert
    detection:
      selection:
        dst_ip: '{network.public_ip}'
      condition: selection
    fields:
      - src_ip
      - rule.name
      - rule.category
- question: What is the timing pattern of connections to this C2 server?
  context: Analyzes C2 beacon intervals and communication frequency patterns.
  range: +/-6h
  query: |
    aggregation: false
    logsource:
      category: network
      service: connection
    detection:
      selection:
        src_ip: '{related.ip}'
        dst_ip: '{related.ip}'
      condition: selection
    fields:
      - src_ip
      - dst_ip
      - dst_port
      - network.protocol
      - event.duration
      - client.ip_bytes
      - server.ip_bytes
      - connection.state_description
- question: Did this host attempt connections to other known stealer C2 patterns?
  context: Identifies additional C2 infrastructure or related stealer family activity.
  range: +/-6h
  query: |
    aggregation: false
    logsource:
      category: network
      service: http
    detection:
      selection:
        src_ip: '{source.ip}'
        http.method: "POST"
        http.uri|contains:
          - "?hwid="
          - "?id="
          - "?bot="
          - "&os="
          - "&pswd="
          - "&cookie="
          - "gate.php"
          - "panel.php"
      condition: selection
    fields:
      - dst_ip
      - http.virtual_host
      - http.uri
      - http.user_agent