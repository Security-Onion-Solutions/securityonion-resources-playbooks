name: ET MALWARE LYCEUM CnC Domain in DNS Lookup
id: 1235312
description: |
  Detects DNS queries to domains ending in .wsuslink.com associated with LYCEUM APT group C2 infrastructure.
  May trigger on legitimate DNS queries if domains are reused or during security research activities.
type: detection
detection_id: 2034375
detection_category: ''
detection_type: nids
contributors:
- SecurityOnionSolutions
created: 2024-01-15
questions:
- question: What was the complete DNS query for the wsuslink.com domain?
  context: Reveals the specific subdomain used in the LYCEUM C2 communication pattern.
  range: +/-15m
  query: |
    aggregation: false
    logsource:
      category: network
      service: dns
    detection:
      selection:
        community_id: '{network.community_id}'
      condition: selection
    fields:
      - dns.query.name
      - dns.query.type_name
      - dns.resolved_ip
- question: Does this host normally query similar C2-associated domains?
  context: Determines if DNS queries to suspicious domains are typical for this host.
  range: -7d
  query: |
    aggregation: true
    logsource:
      category: network
      service: dns
    detection:
      selection:
        dns.query.name: '{dns.query_name}'
      condition: selection
    fields:
      - dns.query.name
- question: What IP addresses did the wsuslink.com domain resolve to?
  context: Identifies the actual C2 server infrastructure being contacted.
  range: +/-15m
  query: |-
    aggregation: false
    detection:
      condition: selection
      selection:
        dns.query.name|endswith: .wsuslink.com
        src_ip: '{source.ip}'
    fields:
    - dns.query.name
    - dns.resolved_ip
    - dns.query.type_name
    logsource:
      category: network
      service: dns
- question: What process initiated the DNS query to the wsuslink.com domain?
  context: Identifies the application or malware responsible for the C2 communication attempt.
  range: +/-15m
  query: |
    aggregation: false
    logsource:
      category: network
    detection:
      selection:
        community_id: '{network.community_id}'
      filter:
        Image|exists: true
      condition: selection and filter
    fields:
      - hostname
      - User
      - Image
      - CommandLine
      - ProcessGuid
- question: Did the host establish connections to the resolved IP addresses?
  context: Determines if DNS resolution was followed by actual C2 communication.
  range: +30m
  query: |-
    aggregation: false
    detection:
      condition: selection
      selection:
        dst_ip: '{dns.resolved_ip}'
        src_ip: '{source.ip}'
    fields:
    - dst_ip
    - dst_port
    - network.protocol
    - connection.state_description
    logsource:
      category: network
      service: connection
- question: What other external connections occurred from this host?
  context: Identifies additional C2 channels or data exfiltration attempts.
  range: +/-10m
  query: |
    aggregation: false
    logsource:
      category: network
      service: connection
    detection:
      selection:
        src_ip: '{source.ip}'
      private:
        dst_ip|cidr:
          - '10.0.0.0/8'
          - '127.0.0.0/8'
          - '172.16.0.0/12'
          - '192.168.0.0/16'
          - '169.254.0.0/16'
      filter:
        dst_ip: '{network.public_ip}'
      condition: selection and not (private or filter)
    fields:
      - dst_ip
      - dst_port
      - network.transport
      - connection.state_description
- question: Are other hosts querying wsuslink.com or related LYCEUM infrastructure?
  context: Determines scope of potential LYCEUM campaign within the organization.
  range: +/-24h
  query: |
    aggregation: false
    logsource:
      category: network
      service: connection
    detection:
      selection:
        dst_ip: '{network.public_ip}'
      filter:
        src_ip: '{source.ip}'
      condition: selection and not filter
    fields:
      - src_ip
      - dst_port
      - network.transport
      - connection.state_description
- question: What is the timing pattern of DNS queries to this domain?
  context: Reveals C2 beacon intervals or communication scheduling.
  range: +/-2h
  query: |
    aggregation: false
    logsource:
      category: network
      service: connection
    detection:
      selection:
        src_ip: '{related.ip}'
        dst_ip: '{related.ip}'
      condition: selection
    fields:
      - src_ip
      - dst_ip
      - dst_port
      - network.protocol
      - event.duration
      - client.ip_bytes
      - server.ip_bytes
      - connection.state_description
- question: What executable files were created around the time of this DNS query?
  context: Identifies potential LYCEUM malware samples or payloads.
  range: +/-1h
  query: |
    aggregation: false
    logsource:
      category: file_event
    detection:
      selection:
        host.ip: '{network.private_ip}'
        file.name|endswith:
        - .exe
        - .dll
        - .bat
        - .cmd
        - .ps1
        - .vbs
        - .js
        - .scr
        - .com
        - .pif
      condition: selection
    fields:
      - file.path
      - file.name
      - Image
      - ProcessGuid
      - User
- question: Did any lateral movement occur from this host?
  context: Assesses whether LYCEUM actors moved to other systems after initial compromise.
  range: +24h
  query: |
    aggregation: false
    logsource:
      category: network
      service: connection
    detection:
      selection:
        src_ip: '{network.private_ip}'
        dst_port:
        - 445    # SMB
        - 139    # NetBIOS
        - 3389   # RDP
        - 5985   # WinRM HTTP
        - 5986   # WinRM HTTPS
        - 22     # SSH
        - 23     # Telnet
        - 135    # RPC
        - 5900   # VNC
      condition: selection
    fields:
      - src_ip
      - src_port
      - dst_ip
      - dst_port
      - network.transport
- question: Are there other DNS queries to domains with similar patterns?
  context: Hunts for additional LYCEUM C2 domains using similar naming conventions.
  range: +/-6h
  query: |-
    aggregation: false
    detection:
      condition: selection
      selection:
        dns.query.name|contains:
        - wsus
        - update
        - microsoft
        - patch
        src_ip: '{source.ip}'
    fields:
    - dns.query.name
    - dns.resolved_ip
    logsource:
      category: network
      service: dns
- question: Are there related LYCEUM alerts across the organization?
  context: Identifies coordinated LYCEUM campaign activity affecting multiple systems.
  range: +/-24h
  query: |
    aggregation: true
    logsource:
      category: alert
    detection:
      selection:
        dst_ip: '{network.public_ip}'
      condition: selection
    fields:
      - src_ip
      - rule.name
      - rule.category