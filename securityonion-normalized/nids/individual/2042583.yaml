name: ET DYN_DNS DYNAMIC_DNS Query to a *.shacknet.biz Domain
id: 1207734
description: |
  Detects DNS queries to shacknet.biz dynamic DNS domains. These domains can be used for legitimate remote access
  but are also commonly used for command and control communications and remote access trojans.
type: detection
detection_id: 2042583
detection_category: ''
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete DNS query to the shacknet.biz domain?
    context: Reveals the specific subdomain being accessed and query details.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          community_id: '{network.community_id}'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.resolved_ip
  - question: Does this host normally query dynamic DNS domains?
    context: Determines if dynamic DNS usage is typical for this host.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: dns
      detection:
        selection:
          dns.query.name: '{dns.query_name}'
        condition: selection
      fields:
        - dns.query.name
  - question: What process initiated the DNS query to the shacknet.biz domain?
    context: Identifies the application responsible for the dynamic DNS lookup.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
      detection:
        selection:
          community_id: '{network.community_id}'
        filter:
          Image|exists: true
        condition: selection and filter
      fields:
        - hostname
        - User
        - Image
        - CommandLine
        - ProcessGuid
  - question: What IP address did the shacknet.biz domain resolve to?
    context: Identifies the actual destination server behind the dynamic DNS name.
    range: +/-30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip: '{source.ip}'
          dns.query.name|contains: "shacknet.biz"
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
  - question: Did the host establish connections to the resolved IP addresses?
    context: Determines if the DNS resolution was followed by actual communication.
    range: +/-10m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip: '{source.ip}'
        private:
          dst_ip|cidr:
            - '10.0.0.0/8'
            - '127.0.0.0/8'
            - '172.16.0.0/12'
            - '192.168.0.0/16'
            - '169.254.0.0/16'
        filter:
          dst_ip: '{network.public_ip}'
        condition: selection and not (private or filter)
      fields:
        - dst_ip
        - dst_port
        - network.transport
        - connection.state_description
  - question: What other dynamic DNS or suspicious domains were queried from this host?
    context: Reveals broader patterns of dynamic DNS usage or suspicious domain access.
    range: +/-6h
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip: '{source.ip}'
          dns.query.name|contains:
            - ".duckdns."
            - ".no-ip."
            - ".ddns."
            - ".hopto."
            - ".zapto."
            - ".jumpingcrab."
            - ".shacknet."
            - ".myftp."
        condition: selection
      fields:
        - dns.query.name
        - dns.resolved_ip
  - question: Are other hosts querying the same shacknet.biz subdomain?
    context: Determines scope of usage across the organization.
    range: +/-24h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip: '{network.public_ip}'
        filter:
          src_ip: '{source.ip}'
        condition: selection and not filter
      fields:
        - src_ip
        - dst_port
        - network.transport
        - connection.state_description
  - question: What is the timing pattern of DNS queries to this domain?
    context: Analyzes communication frequency for C2 pattern identification.
    range: +/-2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip: '{related.ip}'
          dst_ip: '{related.ip}'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - network.protocol
        - event.duration
        - client.ip_bytes
        - server.ip_bytes
        - connection.state_description
  - question: Did any lateral movement occur from this host?
    context: Assesses whether this host was used for internal network access.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip: '{network.private_ip}'
          dst_port:
          - 445    # SMB
          - 139    # NetBIOS
          - 3389   # RDP
          - 5985   # WinRM HTTP
          - 5986   # WinRM HTTPS
          - 22     # SSH
          - 23     # Telnet
          - 135    # RPC
          - 5900   # VNC
        condition: selection
      fields:
        - src_ip
        - src_port
        - dst_ip
        - dst_port
        - network.transport
  - question: Are there related alerts involving the same dynamic DNS infrastructure?
    context: Identifies coordinated activity or campaign patterns.
    range: +/-24h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          related_ip: '{related.ip}'
        filter:
          document_id: '{soc_id}'
        condition: selection and not filter
      fields:
        - rule.name
        - rule.category
        - src_ip
        - dst_ip