name: ET INFO Observed certreq User-Agent (NDES client)
id: 1205359
description: |
  Detects HTTP requests using the specific User-Agent string associated with Windows Certificate Request (certreq) tool connecting to Network Device Enrollment Service (NDES).
  This is typically legitimate certificate enrollment activity but may indicate unauthorized certificate requests or reconnaissance.
type: detection
detection_id: 2043274
detection_category: ''
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete HTTP request made by the NDES client?
    context: Shows the full certificate enrollment request details and destination.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: http
      detection:
        selection:
          community_id: '{network.community_id}'
        condition: selection
      fields:
        - http.method
        - http.useragent
        - http.virtual_host
        - http.uri
        - http.status_code
  - question: Does this host normally perform certificate enrollment activities?
    context: Determines if certificate requests from this host are part of standard operations.
    range: -30d
    query: |
      aggregation: true
      logsource:
        category: network
        service: http
      detection:
        selection:
          dst_ip: '{destination.ip}'
        condition: selection
      fields:
        - dst_ip
  - question: What process initiated the certificate request using the NDES client?
    context: Identifies whether certreq.exe or another application made the request.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
      detection:
        selection:
          community_id: '{network.community_id}'
        filter:
          Image|exists: true
        condition: selection and filter
      fields:
        - hostname
        - User
        - Image
        - CommandLine
        - ProcessGuid
  - question: What other external connections occurred from this host?
    context: Reveals additional network activity that may be related to certificate operations.
    range: +/-10m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip: '{source.ip}'
        private:
          dst_ip|cidr:
            - '10.0.0.0/8'
            - '127.0.0.0/8'
            - '172.16.0.0/12'
            - '192.168.0.0/16'
            - '169.254.0.0/16'
        filter:
          dst_ip: '{network.public_ip}'
        condition: selection and not (private or filter)
      fields:
        - dst_ip
        - dst_port
        - network.transport
        - connection.state_description
  - question: Are other hosts making certificate requests to the same NDES server?
    context: Identifies the scope of certificate enrollment activity across the network.
    range: +/-24h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip: '{network.public_ip}'
        filter:
          src_ip: '{source.ip}'
        condition: selection and not filter
      fields:
        - src_ip
        - dst_port
        - network.transport
        - connection.state_description
  - question: Were any certificate files created on this host?
    context: Shows whether certificate enrollment was successful and files were written.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip: '{source.ip}'
          file.name|endswith:
            - .cer
            - .crt
            - .p12
            - .pfx
            - .pem
        condition: selection
      fields:
        - file.path
        - file.name
        - Image
        - User
  - question: What is the timing pattern of certificate requests from this host?
    context: Analyzes whether requests follow expected patterns or appear automated.
    range: +/-6h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip: '{related.ip}'
          dst_ip: '{related.ip}'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - network.protocol
        - event.duration
        - client.ip_bytes
        - server.ip_bytes
        - connection.state_description
  - question: Were any certificate-related registry modifications made?
    context: Identifies certificate store updates that may result from enrollment.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip: '{source.ip}'
          TargetObject|contains:
            - \certificates\
            - \my\certificates
            - \root\certificates
            - \ca\certificates
        condition: selection
      fields:
        - TargetObject
        - Details
        - Image
        - User
  - question: Are there related certificate enrollment alerts across the organization?
    context: Determines if this is part of broader certificate management activity.
    range: +/-24h
    query: |
      aggregation: true
      logsource:
        category: alert
      detection:
        selection:
          dst_ip: '{network.public_ip}'
        condition: selection
      fields:
        - src_ip
        - rule.name
        - rule.category