name: ET TA_ABUSED_SERVICES Observed Abused File Sharing/CRM Platform (pipedrive-files-*-pipedrive .com .s3 .* .amazonaws .com) in TLS SNI
id: 1210387
description: |
  Detects TLS connections to Pipedrive file sharing infrastructure hosted on AWS S3.
  May indicate legitimate business use of Pipedrive CRM file sharing or potential data exfiltration through abused cloud services.
type: detection
detection_id: 2052706
detection_category: ''
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete TLS connection details to the Pipedrive S3 infrastructure?
    context: Reveals the specific Pipedrive file sharing domain and connection metadata.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          community_id: '{network.community_id}'
        condition: selection
      fields:
        - ssl.server_name
        - ssl.version
        - ssl.cipher
        - hash.ja3
  - question: Does this host normally access Pipedrive or cloud file sharing services?
    context: Determines if connections to Pipedrive file sharing platforms are typical for this host.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: ssl
      detection:
        selection:
          src_ip: '{source.ip}'
          ssl.server_name|contains: pipedrive
        condition: selection
      fields:
        - src_ip
        - ssl.server_name
  - question: What process initiated the connection to the Pipedrive file infrastructure?
    context: Identifies the application responsible for accessing the file sharing service.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
      detection:
        selection:
          community_id: '{network.community_id}'
        filter:
          Image|exists: true
        condition: selection and filter
      fields:
        - hostname
        - User
        - Image
        - CommandLine
        - ProcessGuid
  - question: What DNS queries preceded the connection to Pipedrive infrastructure?
    context: Shows the domain resolution pattern leading to this file sharing access.
    range: -5m
    query: |
      aggregation: false
      logsource:
        category: network
        service: dns
      detection:
        selection:
          src_ip: '{source.ip}'
        condition: selection
      fields:
        - dns.query.name
        - dns.query.type_name
        - dns.resolved_ip
  - question: What other external connections occurred from this host around the same time?
    context: Identifies additional external communications that may indicate broader data movement.
    range: +/-10m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip: '{source.ip}'
        private:
          dst_ip|cidr:
            - '10.0.0.0/8'
            - '127.0.0.0/8'
            - '172.16.0.0/12'
            - '192.168.0.0/16'
            - '169.254.0.0/16'
        filter:
          dst_ip: '{network.public_ip}'
        condition: selection and not (private or filter)
      fields:
        - dst_ip
        - dst_port
        - network.transport
        - connection.state_description
  - question: Are other hosts connecting to the same Pipedrive infrastructure?
    context: Determines scope of Pipedrive usage across the organization.
    range: +/-24h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip: '{network.public_ip}'
        filter:
          src_ip: '{source.ip}'
        condition: selection and not filter
      fields:
        - src_ip
        - dst_port
        - network.transport
        - connection.state_description
  - question: What files were accessed or created by the process making this connection?
    context: Identifies local files that may have been uploaded or downloaded through Pipedrive.
    range: +/-1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          ProcessGuid: '{event_data.process.entity_id}'
        condition: selection
      fields:
        - file.path
        - file.name
        - Image
        - User
  - question: Are there related alerts involving cloud file sharing services?
    context: Reveals patterns of cloud service usage that may indicate policy violations or data exfiltration.
    range: +/-24h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          related_ip: '{related.ip}'
        filter:
          document_id: '{soc_id}'
        condition: selection and not filter
      fields:
        - rule.name
        - rule.category
        - src_ip
        - dst_ip
  - question: Did this host access other cloud storage or file sharing platforms?
    context: Identifies broader patterns of cloud service usage for data movement.
    range: +/-6h
    query: "aggregation: false\nlogsource:\n  category: network\n  service: ssl\ndetection:\n  selection:\n    src_ip: '{source.ip}'\n    ssl.server_name|contains:\n      - dropbox\n      - box.com\n      - sharepoint\n      - googledrive\n      - onedrive\n      - wetransfer\n      - sendspace\n      - mediafire\n      - mega.nz\n      - s3.amazonaws.com\n  filter:\n    ssl.server_name: '{ssl.server_name}'\n  condition: selection and not filter\nfields:\n  - ssl.server_name\n  - dst_ip\n  - dst_port\n  \n"
  - question: What is the timing pattern of connections to Pipedrive infrastructure?
    context: Analyzes connection frequency to determine if usage is automated or manual.
    range: +/-4h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip: '{related.ip}'
          dst_ip: '{related.ip}'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
        - network.protocol
        - event.duration
        - client.ip_bytes
        - server.ip_bytes
        - connection.state_description