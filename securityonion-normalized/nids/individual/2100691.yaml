name: GPL SHELLCODE MSSQL shellcode attempt
id: 1224769
description: |
  Detects shellcode patterns in traffic to Microsoft SQL Server ports (1433).
  May indicate exploitation attempts targeting SQL Server vulnerabilities or could trigger on legitimate database applications with binary data transmission.
type: detection
detection_id: 2100691
detection_category: ''
detection_type: nids
contributors:
  - SecurityOnionSolutions
created: 2024-01-15
questions:
  - question: What was the complete payload containing the shellcode pattern?
    context: Reveals the full binary content that triggered the shellcode detection.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          community_id: '{network.community_id}'
        condition: selection
      fields:
        - src_ip
        - dst_ip
        - dst_port
  - question: Does this host normally receive connections on SQL Server port 1433?
    context: Determines if SQL Server traffic to this destination is typical for the environment.
    range: -7d
    query: |
      aggregation: true
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip: '{destination.ip}'
        condition: selection
      fields:
        - dst_ip
  - question: What external hosts are connecting to this SQL Server?
    context: Identifies the source of the potential shellcode injection attempt.
    range: +/-30m
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip: '{destination.ip}'
          dst_port: 1433
          src_ip|cidr:
            - "0.0.0.0/0"
        private_filter:
          src_ip|cidr:
            - "10.0.0.0/8"
            - "172.16.0.0/12"
            - "192.168.0.0/16"
        condition: selection and not private_filter
      fields:
        - src_ip
        - connection.state
        - connection.history
  - question: What SQL Server process was running when this shellcode pattern was detected?
    context: Identifies the specific SQL Server service that received the suspicious payload.
    range: +/-15m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip: '{network.private_ip}'
          Image|contains:
          - sqlservr.exe
          - sqlagent.exe
          - sqlwriter.exe
        condition: selection
      fields:
        - User
        - Image
        - CommandLine
        - ParentImage
        - ProcessGuid
  - question: Were any new processes spawned after the shellcode pattern was received?
    context: Indicates potential code execution resulting from shellcode injection.
    range: +30m
    query: |
      aggregation: false
      logsource:
        category: process_creation
      detection:
        selection:
          host.ip: '{destination.ip}'
        condition: selection
      fields:
        - Image
        - CommandLine
        - ParentImage
        - User
  - question: What files were created on the SQL Server after the shellcode detection?
    context: Reveals potential file drops or backdoors created through successful exploitation.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: file_event
      detection:
        selection:
          host.ip: '{network.private_ip}'
          file.name|endswith:
          - .exe
          - .dll
          - .bat
          - .cmd
          - .ps1
          - .vbs
          - .js
          - .scr
          - .com
          - .pif
        condition: selection
      fields:
        - file.path
        - file.name
        - Image
        - ProcessGuid
        - User
  - question: Are other SQL Servers receiving similar shellcode patterns?
    context: Determines if this is part of a coordinated attack against database infrastructure.
    range: +/-24h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          dst_ip: '{network.public_ip}'
        filter:
          src_ip: '{source.ip}'
        condition: selection and not filter
      fields:
        - src_ip
        - dst_port
        - network.transport
        - connection.state_description
  - question: What is the pattern of database connections from this external source?
    context: Analyzes the behavior and persistence of the potentially malicious client.
    range: +/-6h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip: '{source.ip}'
          dst_port: 1433
        condition: selection
      fields:
        - dst_ip
        - connection.state
        - connection.history
  - question: Did any lateral movement occur from this SQL Server to other database systems?
    context: Assesses whether successful exploitation led to movement across database infrastructure.
    range: +2h
    query: |
      aggregation: false
      logsource:
        category: network
        service: connection
      detection:
        selection:
          src_ip: '{network.private_ip}'
          dst_port:
          - 445    # SMB
          - 139    # NetBIOS
          - 3389   # RDP
          - 5985   # WinRM HTTP
          - 5986   # WinRM HTTPS
          - 22     # SSH
          - 23     # Telnet
          - 135    # RPC
          - 5900   # VNC
        condition: selection
      fields:
        - src_ip
        - src_port
        - dst_ip
        - dst_port
        - network.transport
  - question: Were any registry modifications made to SQL Server configuration after the shellcode detection?
    context: Identifies persistence mechanisms or configuration changes on the database server.
    range: +1h
    query: |
      aggregation: false
      logsource:
        category: registry_event
      detection:
        selection:
          host.ip: '{related.ip}'
          TargetObject|contains:
          - Run
          - RunOnce
          - Services
          - Startup
          - Winlogon
          - Explorer
          - Shell
          - AppInit_DLLs
          - Image File Execution Options
          - Class
          - ContextMenuHandlers
          - ShellExecuteHooks
        condition: selection
      fields:
        - User
        - Image
        - ProcessGuid
        - TargetObject
        - Details
  - question: Are there other alerts related to this SQL Server or attacking IP address?
    context: Provides broader context about the security posture of the database server and threat actor activity.
    range: +/-24h
    query: |
      aggregation: false
      logsource:
        category: alert
      detection:
        selection:
          related_ip: '{related.ip}'
        filter:
          document_id: '{soc_id}'
        condition: selection and not filter
      fields:
        - rule.name
        - rule.category
        - src_ip
        - dst_ip